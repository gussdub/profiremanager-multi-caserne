import React, { useState, useEffect } from 'react';
import { Button } from './ui/button';
import { Card, CardContent, CardHeader, CardTitle } from './ui/card';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { useToast } from '../hooks/use-toast';
import { apiGet, apiPost } from '../utils/api';
import { useTenant } from '../contexts/TenantContext';

const MesEPI = ({ user }) => {
  const [epis, setEpis] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedEPI, setSelectedEPI] = useState(null);
  const [showInspectionModal, setShowInspectionModal] = useState(false);
  const [showHistoriqueModal, setShowHistoriqueModal] = useState(false);
  const [showRemplacementModal, setShowRemplacementModal] = useState(false);
  const [historique, setHistorique] = useState([]);
  const { tenantSlug } = useTenant();
  const { toast } = useToast();

  const [inspectionForm, setInspectionForm] = useState({
    statut_inspection: 'ok',
    defauts_constates: '',
    notes: '',
    photo_url: ''
  });

  const [photoFile, setPhotoFile] = useState(null);
  const [photoPreview, setPhotoPreview] = useState(null);

  const [remplacementForm, setRemplacementForm] = useState({
    raison: 'Usure normale',
    details: ''
  });

  const raisonsRemplacement = [
    'Usure normale',
    'D√©faut',
    'Perte',
    'Taille inadapt√©e'
  ];

  useEffect(() => {
    loadEPIs();
  }, []);

  const loadEPIs = async () => {
    setLoading(true);
    try {
      const data = await apiGet(tenantSlug, '/mes-epi');
      setEpis(data || []);
    } catch (error) {
      console.error('Erreur chargement EPIs:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger vos EPIs",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  const loadHistorique = async (epiId) => {
    try {
      const data = await apiGet(tenantSlug, `/mes-epi/${epiId}/historique`);
      setHistorique(data || []);
    } catch (error) {
      console.error('Erreur chargement historique:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger l'historique",
        variant: "destructive"
      });
    }
  };

  const handleInspection = async () => {
    if (!selectedEPI) return;

    try {
      await apiPost(tenantSlug, `/mes-epi/${selectedEPI.id}/inspection`, inspectionForm);
      
      toast({
        title: "Succ√®s",
        description: inspectionForm.statut_inspection === 'ok' 
          ? "Inspection enregistr√©e avec succ√®s" 
          : "D√©faut signal√©. Un administrateur sera notifi√©.",
      });

      setShowInspectionModal(false);
      setInspectionForm({
        statut_inspection: 'ok',
        defauts_constates: '',
        notes: '',
        photo_url: ''
      });
      loadEPIs();
    } catch (error) {
      console.error('Erreur lors de l\'inspection:', error);
      toast({
        title: "Erreur",
        description: "Impossible d'enregistrer l'inspection",
        variant: "destructive"
      });
    }
  };

  const handleDemandeRemplacement = async () => {
    if (!selectedEPI) return;

    try {
      await apiPost(tenantSlug, `/mes-epi/${selectedEPI.id}/demander-remplacement`, remplacementForm);
      
      toast({
        title: "Succ√®s",
        description: "Demande de remplacement envoy√©e. Un administrateur traitera votre demande.",
      });

      setShowRemplacementModal(false);
      setRemplacementForm({
        raison: 'Usure normale',
        details: ''
      });
      loadEPIs();
    } catch (error) {
      console.error('Erreur lors de la demande:', error);
      toast({
        title: "Erreur",
        description: "Impossible d'envoyer la demande de remplacement",
        variant: "destructive"
      });
    }
  };

  const openInspectionModal = (epi) => {
    setSelectedEPI(epi);
    setShowInspectionModal(true);
  };

  const openHistoriqueModal = async (epi) => {
    setSelectedEPI(epi);
    await loadHistorique(epi.id);
    setShowHistoriqueModal(true);
  };

  const openRemplacementModal = (epi) => {
    setSelectedEPI(epi);
    setShowRemplacementModal(true);
  };

  const getStatutBadge = (statut) => {
    const badges = {
      'En service': { class: 'badge-success', icon: '‚úÖ' },
      'En inspection': { class: 'badge-warning', icon: 'üîç' },
      'En maintenance': { class: 'badge-info', icon: 'üîß' },
      'Retir√©': { class: 'badge-danger', icon: 'üö´' },
      '√Ä v√©rifier': { class: 'badge-warning', icon: '‚ö†Ô∏è' }
    };
    const badge = badges[statut] || { class: 'badge-default', icon: 'üì¶' };
    return (
      <span className={`badge ${badge.class}`}>
        {badge.icon} {statut}
      </span>
    );
  };

  if (loading) {
    return (
      <div className="mes-epi-container">
        <div className="loading">Chargement de vos EPIs...</div>
      </div>
    );
  }

  return (
    <div className="mes-epi-container">
      <div className="mes-epi-header">
        <h1>üõ°Ô∏è Mes EPI</h1>
        <p>Consultez vos √©quipements de protection individuelle, effectuez des inspections et signalez les d√©fauts</p>
      </div>

      {epis.length === 0 ? (
        <Card>
          <CardContent className="text-center py-8">
            <p className="text-gray-500">Aucun EPI ne vous est assign√© pour le moment.</p>
          </CardContent>
        </Card>
      ) : (
        <div className="epi-grid">
          {epis.map((epi) => (
            <Card key={epi.id} className="epi-card">
              <CardHeader>
                <CardTitle className="flex justify-between items-center">
                  <span>{epi.type_epi || 'EPI'}</span>
                  {getStatutBadge(epi.statut)}
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="epi-details">
                  {epi.marque && (
                    <div className="epi-detail-item">
                      <strong>Marque:</strong> {epi.marque}
                    </div>
                  )}
                  {epi.modele && (
                    <div className="epi-detail-item">
                      <strong>Mod√®le:</strong> {epi.modele}
                    </div>
                  )}
                  {epi.taille && (
                    <div className="epi-detail-item">
                      <strong>Taille:</strong> {epi.taille}
                    </div>
                  )}
                  {epi.numero_serie && (
                    <div className="epi-detail-item">
                      <strong>N¬∞ S√©rie:</strong> {epi.numero_serie}
                    </div>
                  )}
                  {epi.date_mise_en_service && (
                    <div className="epi-detail-item">
                      <strong>Mise en service:</strong> {new Date(epi.date_mise_en_service).toLocaleDateString('fr-FR')}
                    </div>
                  )}
                  {epi.prochaine_inspection && (
                    <div className="epi-detail-item">
                      <strong>Prochaine inspection:</strong> {new Date(epi.prochaine_inspection).toLocaleDateString('fr-FR')}
                    </div>
                  )}
                </div>

                <div className="epi-actions">
                  <Button 
                    onClick={() => openInspectionModal(epi)}
                    className="btn-primary"
                    disabled={epi.statut === 'Retir√©'}
                  >
                    üìã Inspection
                  </Button>
                  <Button 
                    onClick={() => openHistoriqueModal(epi)}
                    className="btn-secondary"
                  >
                    üìú Historique
                  </Button>
                  <Button 
                    onClick={() => openRemplacementModal(epi)}
                    className="btn-warning"
                    disabled={epi.statut === 'Retir√©'}
                  >
                    üîÑ Demander remplacement
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Modal Inspection */}
      {showInspectionModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowInspectionModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>üìã Inspection apr√®s usage</h3>
              <button className="modal-close" onClick={() => setShowInspectionModal(false)}>√ó</button>
            </div>
            <div className="modal-body">
              <p className="mb-4">
                <strong>EPI:</strong> {selectedEPI.type_epi} - {selectedEPI.numero_serie}
              </p>

              <div className="form-group">
                <Label>√âtat de l'EPI *</Label>
                <div className="radio-group">
                  <label className="radio-label">
                    <input
                      type="radio"
                      name="statut_inspection"
                      value="ok"
                      checked={inspectionForm.statut_inspection === 'ok'}
                      onChange={(e) => setInspectionForm({...inspectionForm, statut_inspection: e.target.value})}
                    />
                    <span>‚úÖ OK - Aucun probl√®me d√©tect√©</span>
                  </label>
                  <label className="radio-label">
                    <input
                      type="radio"
                      name="statut_inspection"
                      value="defaut"
                      checked={inspectionForm.statut_inspection === 'defaut'}
                      onChange={(e) => setInspectionForm({...inspectionForm, statut_inspection: e.target.value})}
                    />
                    <span>‚ö†Ô∏è D√©faut constat√©</span>
                  </label>
                </div>
              </div>

              {inspectionForm.statut_inspection === 'defaut' && (
                <div className="form-group">
                  <Label>D√©fauts constat√©s *</Label>
                  <textarea
                    value={inspectionForm.defauts_constates}
                    onChange={(e) => setInspectionForm({...inspectionForm, defauts_constates: e.target.value})}
                    placeholder="D√©crivez les d√©fauts observ√©s..."
                    rows="3"
                    className="form-control"
                  />
                </div>
              )}

              <div className="form-group">
                <Label>Notes compl√©mentaires (optionnel)</Label>
                <textarea
                  value={inspectionForm.notes}
                  onChange={(e) => setInspectionForm({...inspectionForm, notes: e.target.value})}
                  placeholder="Ajoutez des notes si n√©cessaire..."
                  rows="2"
                  className="form-control"
                />
              </div>

              <div className="form-group">
                <Label>URL Photo (optionnel)</Label>
                <Input
                  type="text"
                  value={inspectionForm.photo_url}
                  onChange={(e) => setInspectionForm({...inspectionForm, photo_url: e.target.value})}
                  placeholder="https://..."
                />
              </div>
            </div>
            <div className="modal-footer">
              <Button onClick={() => setShowInspectionModal(false)} className="btn-secondary">
                Annuler
              </Button>
              <Button 
                onClick={handleInspection}
                className="btn-primary"
                disabled={inspectionForm.statut_inspection === 'defaut' && !inspectionForm.defauts_constates}
              >
                Enregistrer l'inspection
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Historique */}
      {showHistoriqueModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowHistoriqueModal(false)}>
          <div className="modal-content large" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>üìú Historique des inspections</h3>
              <button className="modal-close" onClick={() => setShowHistoriqueModal(false)}>√ó</button>
            </div>
            <div className="modal-body">
              <p className="mb-4">
                <strong>EPI:</strong> {selectedEPI.type_epi} - {selectedEPI.numero_serie}
              </p>

              {historique.length === 0 ? (
                <p className="text-center text-gray-500">Aucune inspection enregistr√©e</p>
              ) : (
                <div className="historique-list">
                  {historique.map((inspection, index) => (
                    <div key={index} className="historique-item">
                      <div className="historique-header">
                        <span className="historique-date">
                          üìÖ {new Date(inspection.date_inspection).toLocaleDateString('fr-FR')} √† {new Date(inspection.date_inspection).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                        </span>
                        <span className={`badge ${inspection.statut_inspection === 'ok' ? 'badge-success' : 'badge-danger'}`}>
                          {inspection.statut_inspection === 'ok' ? '‚úÖ OK' : '‚ö†Ô∏è D√©faut'}
                        </span>
                      </div>
                      {inspection.defauts_constates && (
                        <div className="historique-defauts">
                          <strong>D√©fauts:</strong> {inspection.defauts_constates}
                        </div>
                      )}
                      {inspection.notes && (
                        <div className="historique-notes">
                          <strong>Notes:</strong> {inspection.notes}
                        </div>
                      )}
                      {inspection.photo_url && (
                        <div className="historique-photo">
                          <a href={inspection.photo_url} target="_blank" rel="noopener noreferrer">
                            üì∑ Voir la photo
                          </a>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
            <div className="modal-footer">
              <Button onClick={() => setShowHistoriqueModal(false)} className="btn-secondary">
                Fermer
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Demande de Remplacement */}
      {showRemplacementModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowRemplacementModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>üîÑ Demande de remplacement</h3>
              <button className="modal-close" onClick={() => setShowRemplacementModal(false)}>√ó</button>
            </div>
            <div className="modal-body">
              <p className="mb-4">
                <strong>EPI:</strong> {selectedEPI.type_epi} - {selectedEPI.numero_serie}
              </p>

              <div className="form-group">
                <Label>Raison du remplacement *</Label>
                <select
                  value={remplacementForm.raison}
                  onChange={(e) => setRemplacementForm({...remplacementForm, raison: e.target.value})}
                  className="form-control"
                >
                  {raisonsRemplacement.map((raison) => (
                    <option key={raison} value={raison}>{raison}</option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <Label>D√©tails compl√©mentaires</Label>
                <textarea
                  value={remplacementForm.details}
                  onChange={(e) => setRemplacementForm({...remplacementForm, details: e.target.value})}
                  placeholder="Ajoutez des d√©tails pour justifier votre demande..."
                  rows="4"
                  className="form-control"
                />
              </div>

              <div className="alert alert-info">
                ‚ÑπÔ∏è Votre demande sera examin√©e par un administrateur. Vous serez notifi√© de la d√©cision.
              </div>
            </div>
            <div className="modal-footer">
              <Button onClick={() => setShowRemplacementModal(false)} className="btn-secondary">
                Annuler
              </Button>
              <Button onClick={handleDemandeRemplacement} className="btn-primary">
                Envoyer la demande
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default MesEPI;
