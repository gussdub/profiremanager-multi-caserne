import React, { useState, useEffect, Suspense, lazy } from "react";
import { BrowserRouter, Routes, Route, Navigate, useParams } from "react-router-dom";
import axios from "axios";
import { Button } from "./components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "./components/ui/card";
import { Input } from "./components/ui/input";
import { Label } from "./components/ui/label";
import { Calendar } from "./components/ui/calendar";
import { useToast } from "./hooks/use-toast";
import { Toaster } from "./components/ui/toaster";
import VehiculeQRAction from './components/VehiculeQRAction';
import PWAInstallPrompt from './components/PWAInstallPrompt';
import { useTenant } from "./contexts/TenantContext";
import { getTenantToken, buildApiUrl } from "./utils/api";
const SecteursMap = lazy(() => import("./components/SecteursMap"));
import { apiGet, apiPost, apiPut, apiPatch, apiDelete, apiCall } from "./utils/api";
import PushNotificationService from "./services/pushNotifications";
import { fr } from "date-fns/locale";
// Chart dynamique pour r√©duire bundle initial
const Chart = lazy(() => import("react-apexcharts"));
const RapportHeuresModal = lazy(() => import("./components/RapportHeuresModal"));
const AuditModal = lazy(() => import("./components/AuditModal"));
import "./App.css";

// Composant d'installation PWA pour iOS
// Affiche une page d'installation SANS redirection automatique
// L'utilisateur doit d'abord ajouter le raccourci, puis cliquer pour continuer
const PWARedirect = () => {
  const { tenantSlug } = useParams();
  const [isInstalled, setIsInstalled] = useState(false);
  
  // V√©rifier si l'app est lanc√©e depuis un raccourci (mode standalone)
  useEffect(() => {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
      || window.navigator.standalone === true;
    
    if (isStandalone && tenantSlug) {
      // L'app est ouverte depuis un raccourci - rediriger vers le dashboard
      localStorage.setItem('profiremanager_last_tenant', tenantSlug);
      window.location.href = `/${tenantSlug}/dashboard`;
    }
  }, [tenantSlug]);
  
  const handleContinue = () => {
    if (tenantSlug) {
      localStorage.setItem('profiremanager_last_tenant', tenantSlug);
      window.location.href = `/${tenantSlug}/dashboard`;
    }
  };
  
  const tenantName = tenantSlug ? tenantSlug.charAt(0).toUpperCase() + tenantSlug.slice(1) : '';
  
  return (
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '100vh',
      background: 'linear-gradient(135deg, #DC2626 0%, #991b1b 100%)',
      color: 'white',
      textAlign: 'center',
      padding: '1rem'
    }}>
      <div style={{
        background: 'white',
        borderRadius: '20px',
        padding: '1.5rem',
        maxWidth: '380px',
        width: '100%',
        boxShadow: '0 10px 40px rgba(0,0,0,0.3)'
      }}>
        <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>üöí</div>
        <h1 style={{ color: '#DC2626', fontSize: '1.3rem', marginBottom: '0.25rem' }}>
          ProFireManager
        </h1>
        <h2 style={{ color: '#374151', fontSize: '1.1rem', marginBottom: '1rem', fontWeight: '600' }}>
          {tenantName}
        </h2>
        
        {/* Instructions d'installation */}
        <div style={{
          background: '#fef3c7',
          border: '1px solid #f59e0b',
          borderRadius: '12px',
          padding: '1rem',
          marginBottom: '1rem',
          textAlign: 'left'
        }}>
          <p style={{ color: '#92400e', fontSize: '0.85rem', fontWeight: '600', marginBottom: '0.5rem' }}>
            üì± Pour cr√©er un raccourci :
          </p>
          <ol style={{ color: '#78350f', fontSize: '0.8rem', margin: 0, paddingLeft: '1.2rem', lineHeight: '1.6' }}>
            <li>Cliquez sur <strong>Partager</strong> (‚¨ÜÔ∏è) en bas de Safari</li>
            <li>S√©lectionnez <strong>"Sur l'√©cran d'accueil"</strong></li>
            <li>Nommez-le <strong>"{tenantName}"</strong></li>
            <li>Cliquez <strong>Ajouter</strong></li>
          </ol>
        </div>
        
        {/* Bouton pour continuer */}
        <button
          onClick={handleContinue}
          style={{
            width: '100%',
            padding: '0.9rem',
            background: '#DC2626',
            color: 'white',
            border: 'none',
            borderRadius: '10px',
            fontSize: '1rem',
            fontWeight: '600',
            cursor: 'pointer',
            marginBottom: '0.75rem'
          }}
        >
          Continuer vers {tenantName} ‚Üí
        </button>
        
        <p style={{ color: '#9ca3af', fontSize: '0.75rem', margin: 0 }}>
          Cr√©ez d'abord le raccourci, puis cliquez sur "Continuer"
        </p>
      </div>
      
      {/* Note pour plusieurs casernes */}
      <p style={{ 
        color: 'rgba(255,255,255,0.8)', 
        fontSize: '0.75rem', 
        marginTop: '1rem',
        maxWidth: '320px'
      }}>
        üí° Pour ajouter une autre caserne, utilisez l'URL :<br/>
        <code style={{ background: 'rgba(0,0,0,0.2)', padding: '2px 6px', borderRadius: '4px' }}>
          /pwa/nom-caserne
        </code>
      </p>
    </div>
  );
};

// Lazy loading pour optimiser les performances
const Parametres = lazy(() => import("./components/Parametres"));
const SuperAdminDashboard = lazy(() => import("./components/SuperAdminDashboard"));
const MesEPI = lazy(() => import("./components/MesEPI"));
const PlansIntervention = lazy(() => import("./components/PlansIntervention"));
const BatimentDetailModal = lazy(() => import("./components/BatimentDetailModalNew"));
const ConflictResolutionModal = lazy(() => import("./components/ConflictResolutionModal"));
const GestionActifs = lazy(() => import("./components/GestionActifs"));
const PlanInterventionViewer = lazy(() => import("./components/PlanInterventionViewer"));
const ParametresPrevention = lazy(() => import("./components/ParametresPrevention"));
const PlanificationView = lazy(() => import("./components/PlanificationView"));
const CartePlanification = lazy(() => import("./components/CartePlanification"));
const NonConformites = lazy(() => import("./components/NonConformites"));
const InspectionTerrain = lazy(() => import("./components/InspectionTerrain"));
import OfflineManager from "./components/OfflineManager";
import { MapContainer, TileLayer, Marker, Popup, useMapEvents } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

// Fix pour les ic√¥nes Leaflet
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: require('leaflet/dist/images/marker-icon-2x.png'),
  iconUrl: require('leaflet/dist/images/marker-icon.png'),
  shadowUrl: require('leaflet/dist/images/marker-shadow.png'),
});

// Composant de chargement
const LoadingComponent = () => (
  <div className="loading-component">
    <div className="loading-spinner"></div>
    <p>Chargement du module...</p>
  </div>
);

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL || '';
const API = BACKEND_URL ? `${BACKEND_URL}/api` : '/api';

// Fonction utilitaire pour parser une date string "YYYY-MM-DD" en timezone local
const parseDateLocal = (dateStr) => {
  if (!dateStr) return null;
  const [year, month, day] = dateStr.split('-').map(Number);
  return new Date(year, month - 1, day);
};

// Fonction utilitaire pour formater une date en string "YYYY-MM-DD" en timezone local
const formatDateLocal = (date) => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// Configure axios defaults
axios.defaults.headers.common['Content-Type'] = 'application/json';

// Fonctions utilitaires pour localStorage avec pr√©fixe tenant (globales)
const getStorageKey = (key, tenantSlug) => {
  return tenantSlug ? `${tenantSlug}_${key}` : key;
};

window.getTenantItem = (key) => {
  const tenantSlug = window.location.pathname.split('/')[1];
  return localStorage.getItem(getStorageKey(key, tenantSlug));
};

window.setTenantItem = (key, value) => {
  const tenantSlug = window.location.pathname.split('/')[1];
  localStorage.setItem(getStorageKey(key, tenantSlug), value);
};

// Auth Context
const AuthContext = React.createContext();

const useAuth = () => {
  const context = React.useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tenant, setTenant] = useState(null);
  const { tenantSlug, isSuperAdmin } = useTenant();

  // Fonctions utilitaires pour le localStorage avec pr√©fixe tenant
  const getStorageKey = (key) => {
    return tenantSlug ? `${tenantSlug}_${key}` : key;
  };
  
  const getItem = (key) => {
    return localStorage.getItem(getStorageKey(key));
  };
  
  const setItem = (key, value) => {
    localStorage.setItem(getStorageKey(key), value);
  };
  
  const removeItem = (key) => {
    localStorage.removeItem(getStorageKey(key));
  };

  useEffect(() => {
    // Ne pas v√©rifier le token si pas de tenantSlug (en attente du slug)
    if (!tenantSlug) {
      setLoading(false);
      return;
    }
    
    const token = getItem('token');
    
    if (token) {
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      
      // Construire l'URL correcte selon le type d'utilisateur
      const meUrl = isSuperAdmin 
        ? `${API}/admin/auth/me` 
        : `${API}/${tenantSlug}/auth/me`;
      
      // Verify token and get user info
      axios.get(meUrl)
        .then(async response => {
          setUser(response.data);
          setLoading(false);
          
          // R√©cup√©rer les informations du tenant si ce n'est pas un super admin
          if (!isSuperAdmin && tenantSlug) {
            try {
              const tenantResponse = await axios.get(`${API}/admin/tenants/by-slug/${tenantSlug}`);
              setTenant(tenantResponse.data);
            } catch (error) {
              console.error('Erreur r√©cup√©ration tenant:', error);
            }
          }
        })
        .catch((error) => {
          console.log('Token invalide ou expir√©, nettoyage...');
          // Nettoyer uniquement ce tenant
          removeItem('token');
          removeItem('user');
          removeItem('tenant');
          delete axios.defaults.headers.common['Authorization'];
          setUser(null);
          setLoading(false);
        });
    } else {
      setLoading(false);
    }
  }, [tenantSlug, isSuperAdmin]);

  const login = async (email, mot_de_passe) => {
    try {
      // Nettoyer compl√®tement avant une nouvelle connexion (au cas o√π) - uniquement pour ce tenant
      removeItem('token');
      removeItem('tenant');
      removeItem('user');
      delete axios.defaults.headers.common['Authorization'];
      
      // Utiliser l'endpoint tenant-sp√©cifique
      const loginUrl = isSuperAdmin
        ? `${API}/admin/auth/login`
        : `${API}/${tenantSlug}/auth/login`;
      
      const response = await axios.post(loginUrl, {
        email,
        mot_de_passe
      });
      
      // Pour Super Admin, la r√©ponse contient 'admin' au lieu de 'user'
      const { access_token, user: userData, admin: adminData, tenant } = response.data;
      const finalUserData = isSuperAdmin ? adminData : userData;
      
      setItem('token', access_token);
      
      // Stocker les infos du tenant si pr√©sentes
      if (tenant) {
        setItem('tenant', JSON.stringify(tenant));
        setTenant(tenant); // Mettre √† jour le state React
      }
      
      axios.defaults.headers.common['Authorization'] = `Bearer ${access_token}`;
      setUser(finalUserData);
      
      // Initialiser les notifications push pour les utilisateurs non-super-admin
      if (!isSuperAdmin && tenantSlug && finalUserData?.id) {
        try {
          await PushNotificationService.initialize(tenantSlug, finalUserData.id);
          console.log('‚úÖ Push notifications initialized');
        } catch (error) {
          console.error('‚ö†Ô∏è Push notifications initialization failed:', error);
          // Ne pas bloquer la connexion si les notifications √©chouent
        }
      }
      
      return { success: true };
    } catch (error) {
      return { 
        success: false, 
        error: error.response?.data?.detail || 'Erreur de connexion' 
      };
    }
  };

  const logout = () => {
    // D√©senregistrer les notifications push
    PushNotificationService.unregister().catch(err => 
      console.error('Error unregistering push notifications:', err)
    );
    
    // Nettoyer uniquement les donn√©es du tenant actuel (pas tous les tenants)
    removeItem('token');
    removeItem('tenant');
    removeItem('user');
    removeItem('current_inspection_id');
    removeItem('detail_inspection_id');
    
    // Supprimer le header Authorization d'axios
    delete axios.defaults.headers.common['Authorization'];
    
    // R√©initialiser l'√©tat utilisateur
    setUser(null);
    setTenant(null);
    
    // Forcer le rafra√Æchissement de la page pour √©viter les probl√®mes de cache
    setTimeout(() => {
      window.location.href = window.location.origin + window.location.pathname;
    }, 100);
  };

  return (
    <AuthContext.Provider value={{ user, setUser, tenant, login, logout, loading }}>
      {children}
    </AuthContext.Provider>
  );
};

// ForgotPassword Component
const ForgotPassword = ({ onBack }) => {
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);
  const [emailSent, setEmailSent] = useState(false);
  const { tenantSlug } = useTenant();
  const { toast } = useToast();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await axios.post(`${API}/${tenantSlug}/auth/forgot-password`, {
        email
      });

      setEmailSent(true);
      toast({
        title: "Email envoy√©",
        description: "Si cet email existe, vous recevrez un lien de r√©initialisation.",
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Une erreur est survenue",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  if (emailSent) {
    return (
      <div className="login-container">
        <div className="login-box">
          <div className="login-header">
            <div className="logo">
              <div className="logo-flame">
                <div className="flame-container">
                  <i className="fas fa-fire flame-icon"></i>
                </div>
              </div>
              <h1>ProFireManager</h1>
              <p className="version">v2.0 Avanc√©</p>
            </div>
          </div>
          
          <Card className="login-card">
            <CardHeader>
              <CardTitle>Email envoy√© ‚úÖ</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <p className="text-center text-gray-600">
                Si cet email existe dans notre syst√®me, vous recevrez un lien de r√©initialisation dans quelques instants.
              </p>
              <p className="text-center text-sm text-gray-500">
                V√©rifiez votre bo√Æte de r√©ception et vos courriers ind√©sirables.
              </p>
              <Button 
                onClick={onBack}
                className="w-full"
                variant="outline"
              >
                Retour √† la connexion
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="login-container">
      <div className="login-box">
        <div className="login-header">
          <div className="logo">
            <div className="logo-flame">
              <div className="flame-container">
                <i className="fas fa-fire flame-icon"></i>
              </div>
            </div>
            <h1>ProFireManager</h1>
            <p className="version">v2.0 Avanc√©</p>
          </div>
        </div>
        
        <Card className="login-card">
          <CardHeader>
            <CardTitle>Mot de passe oubli√©</CardTitle>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <Label htmlFor="email">Email</Label>
                <Input
                  id="email"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="votre@email.com"
                  required
                />
                <p className="text-sm text-gray-500 mt-2">
                  Nous vous enverrons un lien pour r√©initialiser votre mot de passe.
                </p>
              </div>
              <Button 
                type="submit" 
                className="w-full" 
                disabled={loading}
              >
                {loading ? 'Envoi en cours...' : 'Envoyer le lien'}
              </Button>
              <Button 
                type="button"
                onClick={onBack}
                className="w-full"
                variant="outline"
              >
                Retour √† la connexion
              </Button>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

// ResetPassword Component
const ResetPassword = () => {
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [tokenValid, setTokenValid] = useState(null);
  const [email, setEmail] = useState('');
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  
  // Extraire le token de l'URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  useEffect(() => {
    // V√©rifier la validit√© du token au chargement
    const verifyToken = async () => {
      if (!token) {
        setTokenValid(false);
        return;
      }

      try {
        const response = await axios.get(`${API}/${tenantSlug}/auth/verify-reset-token/${token}`);
        setTokenValid(true);
        setEmail(response.data.email);
      } catch (error) {
        setTokenValid(false);
        toast({
          title: "Token invalide",
          description: error.response?.data?.detail || "Ce lien est invalide ou a expir√©",
          variant: "destructive"
        });
      }
    };

    verifyToken();
  }, [token, tenantSlug]);

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (password !== confirmPassword) {
      toast({
        title: "Erreur",
        description: "Les mots de passe ne correspondent pas",
        variant: "destructive"
      });
      return;
    }

    if (password.length < 8) {
      toast({
        title: "Erreur",
        description: "Le mot de passe doit contenir au moins 8 caract√®res",
        variant: "destructive"
      });
      return;
    }

    setLoading(true);

    try {
      await axios.post(`${API}/${tenantSlug}/auth/reset-password`, {
        token,
        nouveau_mot_de_passe: password
      });

      setSuccess(true);
      toast({
        title: "Succ√®s",
        description: "Votre mot de passe a √©t√© r√©initialis√© avec succ√®s",
      });

      // Rediriger vers la page de connexion apr√®s 3 secondes
      setTimeout(() => {
        window.location.href = `/${tenantSlug}`;
      }, 3000);
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Une erreur est survenue",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  if (tokenValid === null) {
    return (
      <div className="login-container">
        <div className="login-box">
          <div style={{ textAlign: 'center', padding: '40px' }}>
            <div className="loading-spinner"></div>
            <p>V√©rification du lien...</p>
          </div>
        </div>
      </div>
    );
  }

  if (tokenValid === false) {
    return (
      <div className="login-container">
        <div className="login-box">
          <div className="login-header">
            <div className="logo">
              <div className="logo-flame">
                <div className="flame-container">
                  <i className="fas fa-fire flame-icon"></i>
                </div>
              </div>
              <h1>ProFireManager</h1>
              <p className="version">v2.0 Avanc√©</p>
            </div>
          </div>
          
          <Card className="login-card">
            <CardHeader>
              <CardTitle>Lien invalide ‚ùå</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <p className="text-center text-gray-600">
                Ce lien de r√©initialisation est invalide ou a expir√©.
              </p>
              <Button 
                onClick={() => window.location.href = `/${tenantSlug}`}
                className="w-full"
              >
                Retour √† la connexion
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  if (success) {
    return (
      <div className="login-container">
        <div className="login-box">
          <div className="login-header">
            <div className="logo">
              <div className="logo-flame">
                <div className="flame-container">
                  <i className="fas fa-fire flame-icon"></i>
                </div>
              </div>
              <h1>ProFireManager</h1>
              <p className="version">v2.0 Avanc√©</p>
            </div>
          </div>
          
          <Card className="login-card">
            <CardHeader>
              <CardTitle>Mot de passe r√©initialis√© ‚úÖ</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <p className="text-center text-gray-600">
                Votre mot de passe a √©t√© r√©initialis√© avec succ√®s.
              </p>
              <p className="text-center text-sm text-gray-500">
                Vous allez √™tre redirig√© vers la page de connexion...
              </p>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="login-container">
      <div className="login-box">
        <div className="login-header">
          <div className="logo">
            <div className="logo-flame">
              <div className="flame-container">
                <i className="fas fa-fire flame-icon"></i>
              </div>
            </div>
            <h1>ProFireManager</h1>
            <p className="version">v2.0 Avanc√©</p>
          </div>
        </div>
        
        <Card className="login-card">
          <CardHeader>
            <CardTitle>Nouveau mot de passe</CardTitle>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <p className="text-sm text-gray-600 mb-4">
                  Email: <strong>{email}</strong>
                </p>
              </div>
              <div>
                <Label htmlFor="password">Nouveau mot de passe</Label>
                <div style={{position: 'relative'}}>
                  <Input
                    id="password"
                    type={showPassword ? "text" : "password"}
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    style={{paddingRight: '40px'}}
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    style={{
                      position: 'absolute',
                      right: '10px',
                      top: '50%',
                      transform: 'translateY(-50%)',
                      background: 'none',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '1.2rem'
                    }}
                  >
                    {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                  </button>
                </div>
                <p className="text-xs text-gray-500 mt-1">
                  Minimum 8 caract√®res, 1 majuscule, 1 chiffre, 1 caract√®re sp√©cial
                </p>
              </div>
              <div>
                <Label htmlFor="confirmPassword">Confirmer le mot de passe</Label>
                <Input
                  id="confirmPassword"
                  type={showPassword ? "text" : "password"}
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  required
                />
              </div>
              <Button 
                type="submit" 
                className="w-full" 
                disabled={loading}
              >
                {loading ? 'R√©initialisation...' : 'R√©initialiser le mot de passe'}
              </Button>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

// Login Component
const Login = () => {
  const [email, setEmail] = useState('');
  const [motDePasse, setMotDePasse] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [loading, setLoading] = useState(true);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const [personnalisation, setPersonnalisation] = useState(null);
  const [rememberMe, setRememberMe] = useState(true);
  const [autoLoginDone, setAutoLoginDone] = useState(false);
  const [showDebugPanel, setShowDebugPanel] = useState(false);
  const [debugInfo, setDebugInfo] = useState(null);
  const { login } = useAuth();
  const { toast } = useToast();
  const { tenantSlug } = useTenant();

  // Import des fonctions de stockage robuste (async)
  const storageModule = React.useRef(null);
  
  // Charger le module de stockage au montage
  useEffect(() => {
    import('./utils/storage').then(module => {
      storageModule.current = module;
      console.log('[Login] ‚úÖ Module de stockage charg√©');
    });
  }, []);

  // Auto-login au chargement (version async avec stockage robuste)
  useEffect(() => {
    if (!tenantSlug || autoLoginDone) {
      if (!tenantSlug) setLoading(false);
      return;
    }
    
    const attemptAutoLogin = async () => {
      setAutoLoginDone(true);
      
      // Attendre que le module de stockage soit charg√©
      let attempts = 0;
      while (!storageModule.current && attempts < 20) {
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }
      
      if (!storageModule.current) {
        console.log('[Login] ‚ö†Ô∏è Module de stockage non disponible, utilisation localStorage');
        // Fallback localStorage
        try {
          const savedCreds = localStorage.getItem('profiremanager_saved_credentials');
          if (savedCreds) {
            const allCreds = JSON.parse(savedCreds);
            const tenantCreds = allCreds[tenantSlug];
            if (tenantCreds?.email && tenantCreds?.password) {
              setEmail(tenantCreds.email);
              setMotDePasse(tenantCreds.password);
              const result = await login(tenantCreds.email, tenantCreds.password);
              if (result.success) {
                console.log('[Login] ‚úÖ Auto-connexion r√©ussie (localStorage)!');
                return;
              }
            }
          }
        } catch (e) {}
        setLoading(false);
        return;
      }
      
      // Utiliser le stockage robuste
      const tenantCreds = await storageModule.current.getCredentials(tenantSlug);
      console.log('[Login] V√©rification identifiants pour:', tenantSlug, '- Trouv√©:', !!tenantCreds);
      
      if (tenantCreds && tenantCreds.email && tenantCreds.password) {
        setEmail(tenantCreds.email);
        setMotDePasse(tenantCreds.password);
        
        console.log('[Login] Tentative auto-connexion...');
        
        try {
          const result = await login(tenantCreds.email, tenantCreds.password);
          
          if (result.success) {
            console.log('[Login] ‚úÖ Auto-connexion r√©ussie!');
            return;
          } else {
            console.log('[Login] ‚ùå Auto-connexion √©chou√©e:', result.error);
            await storageModule.current.clearCredentials(tenantSlug);
            setMotDePasse('');
          }
        } catch (error) {
          console.error('[Login] Erreur auto-login:', error);
        }
      }
      
      setLoading(false);
    };
    
    attemptAutoLogin();
  }, [tenantSlug, login]);
  
  // Fonction de debug pour afficher l'√©tat du stockage
  const showStorageDebug = async () => {
    if (storageModule.current) {
      const info = await storageModule.current.getStorageDebugInfo();
      setDebugInfo(info);
      setShowDebugPanel(true);
    }
  }

  // Charger la personnalisation du tenant
  useEffect(() => {
    const loadPersonnalisation = async () => {
      try {
        const response = await axios.get(`${API}/${tenantSlug}/public/branding`);
        setPersonnalisation(response.data);
      } catch (error) {
        setPersonnalisation({
          logo_url: '',
          nom_service: '',
          afficher_profiremanager: true
        });
      }
    };

    if (tenantSlug) {
      loadPersonnalisation();
    }
  }, [tenantSlug]);

  if (showForgotPassword) {
    return <ForgotPassword onBack={() => setShowForgotPassword(false)} />;
  }

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    const result = await login(email, motDePasse);
    
    if (result.success) {
      // Sauvegarder les identifiants si "Se souvenir" est coch√©
      if (rememberMe && storageModule.current) {
        await storageModule.current.saveCredentials(tenantSlug, email, motDePasse);
        toast({
          title: "‚úÖ Identifiants sauvegard√©s",
          description: "Vous serez connect√© automatiquement la prochaine fois"
        });
      }
    } else {
      toast({
        title: "Erreur de connexion",
        description: result.error,
        variant: "destructive"
      });
      setLoading(false);
    }
  };

  // Afficher un loader pendant la tentative d'auto-login
  if (loading && !email) {
    return (
      <div className="login-container" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üîÑ</div>
          <p>Connexion en cours...</p>
          {/* Bouton debug cach√© - triple tap pour activer */}
          <div 
            onClick={() => setShowDebugPanel(!showDebugPanel)}
            style={{ marginTop: '2rem', opacity: 0.3, fontSize: '0.75rem' }}
          >
            üîß Debug
          </div>
        </div>
      </div>
    );
  }

  // Panneau de debug pour iOS
  const DebugPanel = () => (
    <div style={{
      position: 'fixed',
      bottom: 0,
      left: 0,
      right: 0,
      background: '#1a1a2e',
      color: '#00ff00',
      padding: '1rem',
      maxHeight: '50vh',
      overflow: 'auto',
      fontSize: '0.75rem',
      fontFamily: 'monospace',
      zIndex: 9999
    }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
        <strong>üîß Debug Storage</strong>
        <button onClick={() => setShowDebugPanel(false)} style={{ background: 'red', color: 'white', border: 'none', padding: '2px 8px' }}>X</button>
      </div>
      <button onClick={showStorageDebug} style={{ background: '#333', color: 'white', padding: '4px 8px', marginBottom: '0.5rem' }}>
        Refresh Debug Info
      </button>
      {debugInfo && (
        <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>
          {JSON.stringify(debugInfo, null, 2)}
        </pre>
      )}
    </div>
  )

  return (
    <div className="login-container">
      <div className="login-box">
        <div className="login-header">
          <div className="logo">
            {personnalisation?.logo_url ? (
              <div style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
                <img 
                  src={personnalisation.logo_url} 
                  alt="Logo du service" 
                  style={{ 
                    maxHeight: '150px', 
                    maxWidth: '100%', 
                    objectFit: 'contain',
                    marginBottom: '1rem',
                    display: 'block',
                    marginLeft: 'auto',
                    marginRight: 'auto'
                  }}
                />
                {personnalisation.nom_service && (
                  <h2 style={{ fontSize: '1.75rem', fontWeight: '700', color: 'white', margin: '0', textAlign: 'center' }}>
                    {personnalisation.nom_service}
                  </h2>
                )}
              </div>
            ) : (
              <>
                <div className="logo-flame">
                  <div className="flame-container">
                    <i className="fas fa-fire flame-icon"></i>
                  </div>
                </div>
                <h1>ProFireManager</h1>
                <p className="version">v2.0 Avanc√©</p>
              </>
            )}
          </div>
        </div>
        
        <Card className="login-card">
          <CardHeader>
            <CardTitle>Connexion</CardTitle>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <Label htmlFor="email">Email</Label>
                <Input
                  id="email"
                  type="email"
                  name="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  autoComplete="username email"
                  data-testid="login-email-input"
                />
              </div>
              <div>
                <Label htmlFor="password">Mot de passe</Label>
                <div style={{position: 'relative'}}>
                  <Input
                    id="password"
                    name="password"
                    type={showPassword ? "text" : "password"}
                    value={motDePasse}
                    onChange={(e) => setMotDePasse(e.target.value)}
                    required
                    autoComplete="current-password"
                    data-testid="login-password-input"
                    style={{paddingRight: '40px'}}
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    style={{
                      position: 'absolute',
                      right: '10px',
                      top: '50%',
                      transform: 'translateY(-50%)',
                      background: 'none',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '1.2rem'
                    }}
                  >
                    {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                  </button>
                </div>
              </div>
              {/* Option "Se souvenir de moi" sur mobile */}
              {/* Option "Se souvenir de moi" - toujours visible */}
              <div className="flex items-center gap-2" style={{ marginBottom: '1rem' }}>
                <input
                  type="checkbox"
                  id="rememberMe"
                  checked={rememberMe}
                  onChange={(e) => setRememberMe(e.target.checked)}
                  style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                />
                <label htmlFor="rememberMe" style={{ fontSize: '0.9rem', cursor: 'pointer' }}>
                  Se souvenir de moi sur cet appareil
                </label>
              </div>
              <Button 
                type="submit" 
                className="w-full" 
                disabled={loading}
                data-testid="login-submit-btn"
              >
                {loading ? 'Connexion...' : 'Se connecter'}
              </Button>
              <div className="text-center mt-4">
                <button
                  type="button"
                  onClick={() => setShowForgotPassword(true)}
                  style={{
                    background: 'none',
                    border: 'none',
                    color: '#dc2626',
                    cursor: 'pointer',
                    fontSize: '0.875rem',
                    textDecoration: 'underline'
                  }}
                >
                  Mot de passe oubli√© ?
                </button>
              </div>
            </form>
          </CardContent>
        </Card>
        
        {/* Footer ProFireManager - Discret */}
        {personnalisation?.logo_url && (
          <div style={{ 
            marginTop: '2rem', 
            paddingTop: '1.5rem',
            borderTop: '1px solid rgba(255, 255, 255, 0.2)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '0.75rem',
            opacity: 0.85
          }}>
            <div style={{
              width: '32px',
              height: '32px',
              background: 'rgba(255, 255, 255, 0.15)',
              borderRadius: '8px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}>
              <div className="logo-flame" style={{ transform: 'scale(0.6)' }}>
                <div className="flame-container">
                  <i className="fas fa-fire flame-icon"></i>
                </div>
              </div>
            </div>
            <span style={{ 
              fontSize: '0.75rem', 
              color: 'white',
              fontWeight: '500'
            }}>
              Propuls√© par ProFireManager
            </span>
          </div>
        )}
        
        {/* Lien debug discret - visible seulement en tapant plusieurs fois */}
        <div 
          onClick={showStorageDebug}
          style={{ 
            marginTop: '1rem', 
            textAlign: 'center',
            opacity: 0.3,
            fontSize: '0.65rem',
            color: 'rgba(255,255,255,0.5)',
            cursor: 'pointer'
          }}
        >
          üîß
        </div>
      </div>
      
      {/* Panneau de debug */}
      {showDebugPanel && <DebugPanel />}
    </div>
  );
};

// Sidebar Navigation avec menu hamburger mobile
const Sidebar = ({ currentPage, setCurrentPage, tenant }) => {
  const { user, tenant: authTenant, logout } = useAuth();

  const { tenantSlug, switchTenant } = useTenant();
  
  // Afficher le bouton "Changer de caserne" sur mobile (√©cran < 768px) ou app native/standalone
  const [isMobileDevice, setIsMobileDevice] = useState(false);
  
  useEffect(() => {
    const checkMobile = () => {
      const isMobile = window.innerWidth < 768 || 
        window.navigator.standalone === true || 
        window.matchMedia('(display-mode: standalone)').matches ||
        /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      setIsMobileDevice(isMobile);
    };
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [showNotifications, setShowNotifications] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [showRemplacementModal, setShowRemplacementModal] = useState(false);
  const [selectedDemandeRemplacement, setSelectedDemandeRemplacement] = useState(null);
  const [remplacementCommentaire, setRemplacementCommentaire] = useState('');
  const [showNotificationSettings, setShowNotificationSettings] = useState(false);
  
  // Param√®tres de notifications (localStorage)
  const [notificationSettings, setNotificationSettings] = useState(() => {
    const saved = localStorage.getItem('notificationSettings');
    return saved ? JSON.parse(saved) : {
      soundEnabled: true,
      soundType: 'default',
      volume: 50,
      pushEnabled: true
    };
  });

  // Charger les notifications
  const loadNotifications = async () => {
    if (!tenantSlug || !user) return;
    
    // Ne charger les notifications que pour les utilisateurs non-employ√©s
    if (user.role === 'employe') return;
    
    try {
      const notificationsData = await apiGet(tenantSlug, '/notifications');
      setNotifications(notificationsData);
      
      const countData = await apiGet(tenantSlug, '/notifications/non-lues/count');
      setUnreadCount(countData.count);
    } catch (error) {
      console.error('Erreur chargement notifications:', error);
    }
  };

  // Charger au montage et toutes les 30 secondes
  useEffect(() => {
    if (user) {
      loadNotifications();
      const interval = setInterval(loadNotifications, 30000); // 30 secondes
      return () => clearInterval(interval);
    }
  }, [user]);

  // Ouvrir le modal de d√©tails de demande de remplacement
  const openRemplacementModal = async (demande_id) => {
    try {
      const demande = await apiGet(tenantSlug, `/remplacements/${demande_id}`);
      setSelectedDemandeRemplacement(demande);
      setRemplacementCommentaire('');
      setShowRemplacementModal(true);
    } catch (error) {
      console.error('Erreur chargement demande:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les d√©tails de la demande",
        variant: "destructive"
      });
    }
  };

  // Accepter une demande de remplacement
  const handleAccepterRemplacement = async () => {
    if (!selectedDemandeRemplacement) return;
    
    try {
      await apiPost(
        tenantSlug,
        `/remplacements/${selectedDemandeRemplacement.id}/accepter`,
        { commentaire: remplacementCommentaire }
      );
      
      toast({
        title: "‚úÖ Remplacement accept√©",
        description: "Vous avez √©t√© assign√© √† cette garde. Le demandeur a √©t√© notifi√©.",
      });
      
      setShowRemplacementModal(false);
      setSelectedDemandeRemplacement(null);
      loadNotifications();
      
    } catch (error) {
      console.error('Erreur acceptation remplacement:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible d'accepter la demande",
        variant: "destructive"
      });
    }
  };

  // Refuser une demande de remplacement
  const handleRefuserRemplacement = async () => {
    if (!selectedDemandeRemplacement) return;
    
    try {
      await apiPost(
        tenantSlug,
        `/remplacements/${selectedDemandeRemplacement.id}/refuser`,
        { raison: remplacementCommentaire || "Non disponible" }
      );
      
      toast({
        title: "Demande refus√©e",
        description: "Le demandeur a √©t√© notifi√© de votre refus.",
      });
      
      setShowRemplacementModal(false);
      setSelectedDemandeRemplacement(null);
      loadNotifications();
      
    } catch (error) {
      console.error('Erreur refus remplacement:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible de refuser la demande",
        variant: "destructive"
      });
    }
  };

  // Jouer un son quand il y a de nouvelles notifications
  useEffect(() => {
    if (unreadCount > 0) {
      playNotificationSound();
    }
  }, [unreadCount]);

  const marquerCommeLue = async (notifId) => {
    try {
      await apiPut(tenantSlug, `/notifications/${notifId}/marquer-lu`, {});
      loadNotifications();
    } catch (error) {
      console.error('Erreur marquage notification:', error);
    }
  };

  const marquerToutesLues = async () => {
    try {
      await apiPut(tenantSlug, '/notifications/marquer-toutes-lues', {});
      loadNotifications();
    } catch (error) {
      console.error('Erreur marquage toutes notifications:', error);
    }
  };
  
  // Jouer le son de notification
  const playNotificationSound = (customSettings = null) => {
    const settings = customSettings || notificationSettings;
    
    if (!settings.soundEnabled) return;
    
    try {
      // Sons simples g√©n√©r√©s
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Fr√©quences selon le type
      const frequencies = {
        default: [523.25, 659.25, 783.99], // Do-Mi-Sol
        chime: [659.25, 783.99, 1046.50], // Mi-Sol-Do aigu
        bell: [830.61, 987.77] // Sol#-Si
      };
      
      const freqs = frequencies[settings.soundType] || frequencies.default;
      
      // Volume
      gainNode.gain.setValueAtTime(settings.volume / 200, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      // Jouer les notes
      freqs.forEach((freq, index) => {
        setTimeout(() => {
          oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
          if (index === 0) {
            oscillator.start(audioContext.currentTime);
          }
        }, index * 100);
      });
      
      oscillator.stop(audioContext.currentTime + 0.5);
      
      console.log('üîä Son jou√©:', settings.soundType, 'volume:', settings.volume);
    } catch (error) {
      console.error('Erreur lecture son:', error);
    }
  };
  
  // Sauvegarder les param√®tres
  const saveNotificationSettings = (newSettings) => {
    setNotificationSettings(newSettings);
    localStorage.setItem('notificationSettings', JSON.stringify(newSettings));
    toast({
      title: "‚úÖ Param√®tres sauvegard√©s",
      description: "Vos pr√©f√©rences de notification ont √©t√© enregistr√©es"
    });
  };

  const menuItems = [
    { id: 'dashboard', label: 'Tableau de bord', icon: 'üìä', roles: ['admin', 'superviseur', 'employe'] },
    { id: 'personnel', label: 'Personnel', icon: 'üë•', roles: ['admin', 'superviseur'] },
    { id: 'actifs', label: 'Gestion des Actifs', icon: 'üöí', roles: ['admin', 'superviseur', 'employe'] },
    { id: 'planning', label: 'Planning', icon: 'üìÖ', roles: ['admin', 'superviseur', 'employe'] },
    { id: 'disponibilites', label: 'Mes disponibilit√©s', icon: 'üìã', roles: ['admin', 'superviseur', 'employe'] },
    { id: 'remplacements', label: 'Remplacements', icon: 'üîÑ', roles: ['admin', 'superviseur', 'employe'] },
    { id: 'formations', label: 'Formations', icon: 'üìö', roles: ['admin', 'superviseur', 'employe'] },
    { id: 'prevention', label: 'Pr√©vention', icon: 'üî•', roles: ['admin'] },  // Supprim√© requiresModule temporairement
    { id: 'rapports', label: 'Rapports', icon: 'üìà', roles: ['admin'] },
    { id: 'parametres', label: 'Param√®tres', icon: '‚öôÔ∏è', roles: ['admin'] },
    { id: 'maintenance', label: 'Maintenance', icon: 'üîß', roles: ['admin'], superAdminOnly: true },
    { id: 'mesepi', label: 'Mes EPI', icon: 'üõ°Ô∏è', roles: ['admin', 'superviseur', 'employe'] },
    { id: 'monprofil', label: 'Mon profil', icon: 'üë§', roles: ['admin', 'superviseur', 'employe'] }
  ];

  const filteredMenuItems = menuItems.filter(item => {
    // V√©rification du r√¥le seulement
    if (!item.roles.includes(user?.role)) return false;
    
    // V√©rifier si c'est r√©serv√© aux super-admin (uniquement si connect√©)
    if (item.superAdminOnly && (typeof isSuperAdmin === 'undefined' || !isSuperAdmin)) return false;
    
    // V√©rifier si c'est le module "Mes disponibilit√©s" qui ne doit √™tre visible que pour les utilisateurs temps partiel
    if (item.id === 'disponibilites' && user.type_emploi !== 'temps_partiel') {
      return false;
    }
    
    // V√©rifier si c'est le module "Pr√©vention" et s'il est activ√© pour ce tenant
    if (item.id === 'prevention' && !authTenant?.parametres?.module_prevention_active) {
      return false;
    }
    
    return true;
  });

  return (
    <>
      {/* Notification bell icon */}
      <div className="notification-bell-container">
        <button 
          className="notification-bell"
          onClick={() => setShowNotifications(!showNotifications)}
          data-testid="notification-bell"
        >
          <i className="fas fa-bell"></i>
          {unreadCount > 0 && (
            <span className="notification-badge">{unreadCount}</span>
          )}
        </button>

        {/* Overlay pour fermer les notifications en cliquant dehors */}
        {showNotifications && (
          <div 
            className="notifications-overlay"
            onClick={() => setShowNotifications(false)}
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              zIndex: 998
            }}
          />
        )}

        {/* Dropdown des notifications */}
        {showNotifications && (
          <div className="notifications-dropdown" style={{ zIndex: 999 }}>
            <div className="notifications-header">
              <h3>Notifications</h3>
              <div style={{display: 'flex', gap: '0.5rem'}}>
                <button 
                  onClick={() => setShowNotificationSettings(!showNotificationSettings)} 
                  className="notification-settings-btn"
                  title="Param√®tres des notifications"
                >
                  ‚öôÔ∏è
                </button>
                {unreadCount > 0 && (
                  <button onClick={marquerToutesLues} className="mark-all-read">
                    Tout marquer comme lu
                  </button>
                )}
              </div>
            </div>
            
            {/* Section Param√®tres */}
            {showNotificationSettings && (
              <div className="notification-settings" style={{
                padding: '1rem',
                background: '#f8fafc',
                borderBottom: '1px solid #e5e7eb',
                borderRadius: '8px',
                margin: '0.5rem'
              }}>
                <h4 style={{marginBottom: '1rem', fontSize: '0.9rem', fontWeight: '600'}}>‚öôÔ∏è Param√®tres des notifications</h4>
                
                <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                  {/* Activer/D√©sactiver le son */}
                  <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}>
                    <input
                      type="checkbox"
                      checked={notificationSettings.soundEnabled}
                      onChange={(e) => saveNotificationSettings({...notificationSettings, soundEnabled: e.target.checked})}
                      style={{width: '18px', height: '18px', cursor: 'pointer'}}
                    />
                    <span style={{fontSize: '0.85rem'}}>üîî Activer les sons</span>
                  </label>
                  
                  {/* Choix du son */}
                  {notificationSettings.soundEnabled && (
                    <>
                      <div>
                        <label style={{fontSize: '0.85rem', display: 'block', marginBottom: '0.25rem'}}>üéµ Type de son</label>
                        <select
                          value={notificationSettings.soundType}
                          onChange={(e) => {
                            const newSettings = {...notificationSettings, soundType: e.target.value};
                            saveNotificationSettings(newSettings);
                            // Jouer un aper√ßu
                            setTimeout(() => playNotificationSound(newSettings), 100);
                          }}
                          style={{
                            width: '100%',
                            padding: '0.5rem',
                            borderRadius: '6px',
                            border: '1px solid #d1d5db',
                            fontSize: '0.85rem'
                          }}
                        >
                          <option value="default">Son par d√©faut</option>
                          <option value="chime">Carillon</option>
                          <option value="bell">Cloche</option>
                        </select>
                      </div>
                      
                      {/* Volume */}
                      <div>
                        <label style={{fontSize: '0.85rem', display: 'block', marginBottom: '0.25rem'}}>
                          üîä Volume ({notificationSettings.volume}%)
                        </label>
                        <input
                          type="range"
                          min="0"
                          max="100"
                          value={notificationSettings.volume}
                          onChange={(e) => saveNotificationSettings({...notificationSettings, volume: parseInt(e.target.value)})}
                          style={{width: '100%'}}
                        />
                      </div>
                    </>
                  )}
                  
                  {/* Notifications push */}
                  <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}>
                    <input
                      type="checkbox"
                      checked={notificationSettings.pushEnabled}
                      onChange={(e) => saveNotificationSettings({...notificationSettings, pushEnabled: e.target.checked})}
                      style={{width: '18px', height: '18px', cursor: 'pointer'}}
                    />
                    <span style={{fontSize: '0.85rem'}}>üì± Notifications push du navigateur</span>
                  </label>
                </div>
              </div>
            )}

            <div className="notifications-list">
              {notifications.length === 0 ? (
                <div className="no-notifications">
                  <i className="fas fa-inbox"></i>
                  <p>Aucune notification</p>
                </div>
              ) : (
                notifications.map(notif => (
                  <div 
                    key={notif.id}
                    className={`notification-item ${notif.statut === 'non_lu' ? 'unread' : ''}`}
                  >
                    <div 
                      onClick={() => {
                        marquerCommeLue(notif.id);
                        setShowNotifications(false);
                        
                        // Navigation intelligente selon le type de notification
                        switch (notif.type) {
                          case 'remplacement_disponible':
                            if (notif.data?.demande_id) {
                              openRemplacementModal(notif.data.demande_id);
                            } else {
                              setCurrentPage('remplacements');
                            }
                            break;
                          case 'remplacement_accepte':
                          case 'remplacement_refuse':
                          case 'remplacement_demande':
                          case 'remplacement_pourvu':
                            // Aller au module Remplacements
                            setCurrentPage('remplacements');
                            break;
                          case 'planning_assigne':
                          case 'planning_modifie':
                            // Aller au Planning
                            setCurrentPage('planning');
                            break;
                          case 'conge_approuve':
                          case 'conge_refuse':
                          case 'conge_demande':
                            // Aller aux disponibilit√©s
                            setCurrentPage('disponibilites');
                            break;
                          case 'formation_assignee':
                          case 'formation_rappel':
                            // Aller aux formations
                            setCurrentPage('formations');
                            break;
                          default:
                            // Utiliser le lien par d√©faut si disponible
                            if (notif.lien) {
                              setCurrentPage(notif.lien.replace(/^\/[^\/]+\//, ''));
                            }
                        }
                      }}
                      style={{ cursor: 'pointer', flex: 1 }}
                    >
                      <div style={{ display: 'flex', alignItems: 'start', gap: '12px' }}>
                        <div className="notification-icon">
                          {notif.type === 'remplacement_demande' && 'üîÑ'}
                          {notif.type === 'remplacement_disponible' && 'üîî'}
                          {notif.type === 'remplacement_accepte' && '‚úÖ'}
                          {notif.type === 'remplacement_pourvu' && '‚ÑπÔ∏è'}
                          {notif.type === 'conge_approuve' && '‚úÖ'}
                          {notif.type === 'conge_refuse' && '‚ùå'}
                          {notif.type === 'conge_demande' && 'üìù'}
                          {notif.type === 'planning_assigne' && 'üìÖ'}
                        </div>
                        <div className="notification-content" style={{ flex: 1 }}>
                          <h4>{notif.titre}</h4>
                          <p>{notif.message}</p>
                          <span className="notification-time">
                            {new Date(notif.date_creation).toLocaleString('fr-FR')}
                          </span>
                          
                          {/* Boutons d'action pour remplacement disponible */}
                          {notif.type === 'remplacement_disponible' && notif.data?.demande_id && (
                            <div style={{ 
                              display: 'flex', 
                              gap: '8px', 
                              marginTop: '10px',
                              paddingTop: '10px',
                              borderTop: '1px solid #e5e7eb'
                            }}>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  openRemplacementModal(notif.data.demande_id);
                                  setShowNotifications(false);
                                }}
                                style={{
                                  flex: 1,
                                  padding: '6px 12px',
                                  background: '#10b981',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '6px',
                                  fontSize: '0.85rem',
                                  fontWeight: '600',
                                  cursor: 'pointer'
                                }}
                              >
                                ‚úÖ Accepter
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  openRemplacementModal(notif.data.demande_id);
                                  setShowNotifications(false);
                                }}
                                style={{
                                  flex: 1,
                                  padding: '6px 12px',
                                  background: '#6b7280',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '6px',
                                  fontSize: '0.85rem',
                                  fontWeight: '600',
                                  cursor: 'pointer'
                                }}
                              >
                                üìã Voir d√©tails
                              </button>
                            </div>
                          )}
                        </div>
                        {notif.statut === 'non_lu' && (
                          <div className="notification-dot"></div>
                        )}
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        )}
      </div>

      {/* Mobile hamburger button */}
      <button 
        className="mobile-menu-toggle"
        onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
        data-testid="mobile-menu-toggle"
      >
        <span className="hamburger-line"></span>
        <span className="hamburger-line"></span>
        <span className="hamburger-line"></span>
      </button>

      {/* Mobile overlay - fond sombre pour fermer le menu */}
      {isMobileMenuOpen && (
        <div 
          className="mobile-overlay"
          onClick={() => setIsMobileMenuOpen(false)}
        ></div>
      )}

      <div 
        className={`sidebar ${isMobileMenuOpen ? 'mobile-open' : ''}`}
        onClick={(e) => e.stopPropagation()}
      >
        <div className="sidebar-header">
          <div className="sidebar-logo">
            <div className="logo-flame">
              <div className="flame-container">
                <i className="fas fa-fire flame-icon"></i>
              </div>
            </div>
            <div>
              <h2>ProFireManager</h2>
              <p className="version">v2.0 Avanc√©</p>
            </div>
          </div>
        </div>

        <nav className="sidebar-nav">
          {filteredMenuItems.map(item => (
            <button
              key={item.id}
              type="button"
              className={`nav-item ${currentPage === item.id ? 'active' : ''}`}
              onClick={() => {
                setCurrentPage(item.id);
                setIsMobileMenuOpen(false);
              }}
              data-testid={`nav-${item.id}-btn`}
            >
              <span className="nav-icon">{item.icon}</span>
              {item.label}
            </button>
          ))}
        </nav>

        <div className="sidebar-user">
          <div className="user-info">
            <div className="user-avatar">
              {user?.photo_profil ? (
                <img 
                  src={user.photo_profil} 
                  alt="Photo de profil"
                  style={{ 
                    width: '100%', 
                    height: '100%', 
                    objectFit: 'cover',
                    borderRadius: '50%'
                  }}
                />
              ) : (
                <span className="user-icon">üë§</span>
              )}
            </div>
            <div className="user-details">
              <p className="user-name">{user?.prenom} {user?.nom}</p>
              <p className="user-role">{user?.role === 'admin' ? 'Administrateur' : 
                                      user?.role === 'superviseur' ? 'Superviseur' : 'Employ√©'}</p>
              <p className="user-grade">{user?.grade}</p>
            </div>
          </div>
          <div className="sidebar-user-actions" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', width: '100%' }}>
            {/* Bouton Changer de caserne - visible sur mobile */}
            {isMobileDevice && (
              <Button 
                variant="outline" 
                onClick={() => {
                  if (switchTenant) {
                    switchTenant();
                  } else {
                    localStorage.removeItem('profiremanager_last_tenant');
                    window.location.href = '/';
                  }
                  setIsMobileMenuOpen(false);
                }}
                className="switch-tenant-btn"
                style={{ 
                  fontSize: '0.85rem', 
                  padding: '0.5rem 0.75rem',
                  background: 'rgba(255,255,255,0.1)',
                  border: '1px solid rgba(255,255,255,0.2)',
                  color: 'white'
                }}
              >
                üè¢ Changer de caserne
              </Button>
            )}
            <Button 
              variant="ghost" 
              onClick={() => {
                logout();
                setIsMobileMenuOpen(false);
              }}
              className="logout-btn"
              data-testid="logout-btn"
            >
              üö™ D√©connexion
            </Button>
          </div>
        </div>
      </div>
    </>
  );
};

// Module EPI Component - Vue diff√©rente selon le r√¥le


// ==================== MODULE EPI NFPA 1851 - PHASE 1 ====================
const ModuleEPI = ({ user }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('inventaire');
  
  // √âtats inventaire
  const [epis, setEpis] = useState([]);
  const [selectedEPI, setSelectedEPI] = useState(null);
  const [showEPIModal, setShowEPIModal] = useState(false);
  const [selectedDemandeRemplacement, setSelectedDemandeRemplacement] = useState(null);
  const [showRemplacementModal, setShowRemplacementModal] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [users, setUsers] = useState([]);
  
  const [epiForm, setEpiForm] = useState({
    numero_serie: '',
    type_epi: 'casque',
    marque: '',
    modele: '',
    numero_serie_fabricant: '',
    date_fabrication: '',
    date_mise_en_service: new Date().toISOString().split('T')[0],
    norme_certification: 'NFPA 1971',
    cout_achat: 0,
    couleur: '',
    taille: '',
    user_id: '',
    statut: 'En service',
    notes: ''
  });
  
  // √âtats inspections
  const [showInspectionModal, setShowInspectionModal] = useState(false);
  const [typeInspection, setTypeInspection] = useState('apres_utilisation');
  const [inspections, setInspections] = useState([]);
  const [inspectionForm, setInspectionForm] = useState({
    date_inspection: new Date().toISOString().split('T')[0],
    inspecteur_nom: '',
    inspecteur_id: '',
    isp_id: '',
    isp_nom: '',
    isp_accreditations: '',
    statut_global: 'conforme',
    checklist: {},
    commentaires: ''
  });
  
  // √âtats ISP
  const [isps, setIsps] = useState([]);
  const [showISPModal, setShowISPModal] = useState(false);
  const [selectedISP, setSelectedISP] = useState(null);
  const [ispForm, setIspForm] = useState({
    nom: '',
    contact: '',
    telephone: '',
    email: '',
    accreditations: '',
    notes: ''
  });
  
  // √âtats demandes de remplacement EPI
  const [demandesRemplacementEPI, setDemandesRemplacementEPI] = useState([]);
  
  // √âtats rapports
  const [rapportConformite, setRapportConformite] = useState(null);
  const [rapportEcheances, setRapportEcheances] = useState(null);
  
  // √âtats Phase 2 - Nettoyages
  const [nettoyages, setNettoyages] = useState([]);
  const [showNettoyageModal, setShowNettoyageModal] = useState(false);
  const [nettoyageForm, setNettoyageForm] = useState({
    type_nettoyage: 'routine',
    date_nettoyage: new Date().toISOString().split('T')[0],
    methode: 'laveuse_extractrice',
    effectue_par: '',
    effectue_par_id: user?.id || '',
    isp_id: '',
    nombre_cycles: 1,
    temperature: '',
    produits_utilises: '',
    notes: ''
  });
  
  // √âtats Phase 2 - R√©parations
  const [reparations, setReparations] = useState([]);
  const [showReparationModal, setShowReparationModal] = useState(false);
  const [selectedReparation, setSelectedReparation] = useState(null);
  const [reparationForm, setReparationForm] = useState({
    statut: 'demandee',
    date_demande: new Date().toISOString().split('T')[0],
    demandeur: user ? `${user.prenom} ${user.nom}` : '',
    demandeur_id: user?.id || '',
    reparateur_type: 'interne',
    reparateur_nom: '',
    isp_id: '',
    probleme_description: '',
    notes: ''
  });
  
  // √âtats Phase 2 - Retrait
  const [showRetraitModal, setShowRetraitModal] = useState(false);
  const [retraitForm, setRetraitForm] = useState({
    date_retrait: new Date().toISOString().split('T')[0],
    raison: 'age_limite',
    description_raison: '',
    methode_disposition: 'coupe_detruit',
    preuve_disposition: [],
    certificat_disposition_url: '',
    cout_disposition: 0,
    retire_par: user ? `${user.prenom} ${user.nom}` : '',
    retire_par_id: user?.id || '',
    notes: ''
  });
  
  // √âtats Phase 2 - Rapports avanc√©s
  const [rapportRetraits, setRapportRetraits] = useState(null);
  const [rapportTCO, setRapportTCO] = useState(null);
  
  // Types EPI - charg√©s dynamiquement depuis l'API
  const [typesEPI, setTypesEPI] = useState([
    { id: 'casque', nom: 'Casque', icone: '‚õëÔ∏è' },
    { id: 'bottes', nom: 'Bottes', icone: 'ü•æ' },
    { id: 'veste_bunker', nom: 'Manteau Habit de Combat', icone: 'üß•' },
    { id: 'pantalon_bunker', nom: 'Pantalon Habit de Combat', icone: 'üëñ' },
    { id: 'gants', nom: 'Gants', icone: 'üß§' },
    { id: 'cagoule', nom: 'Cagoule Anti-Particules', icone: 'üé≠' }
  ]);
  
  // Charger les types EPI depuis l'API
  useEffect(() => {
    const fetchTypesEPI = async () => {
      try {
        const data = await apiGet(tenantSlug, '/types-epi');
        if (data && data.length > 0) {
          // Mapper les donn√©es pour utiliser le nom comme ID (pour compatibilit√©)
          setTypesEPI(data.map(t => ({
            id: t.nom,  // Utiliser le nom comme ID pour compatibilit√©
            nom: t.nom,
            icone: t.icone
          })));
        }
      } catch (error) {
        console.log('Types EPI par d√©faut utilis√©s');
      }
    };
    if (tenantSlug) {
      fetchTypesEPI();
    }
  }, [tenantSlug]);
  
  // Checklists NFPA 1851
  const getChecklistTemplate = (type) => {
    if (type === 'apres_utilisation') {
      return {
        propre: 'oui',
        degradation_visible: 'non',
        fermetures_fonctionnelles: 'oui',
        bandes_reflechissantes_intactes: 'oui'
      };
    } else if (type === 'routine_mensuelle') {
      return {
        etat_coutures: 'bon',
        fermetures_eclair: 'bon',
        bandes_reflechissantes: 'bon',
        usure_generale: 'bon',
        dommages_thermiques: 'non',
        dommages_chimiques: 'non',
        dommages_mecaniques: 'non',
        integrite_coque: 'bon',
        etat_doublure: 'bon',
        barriere_humidite: 'bon',
        quincaillerie: 'bon',
        ajustement_mobilite: 'bon'
      };
    } else {
      return {
        etat_coutures: 'bon',
        fermetures_eclair: 'bon',
        bandes_reflechissantes: 'bon',
        usure_generale: 'bon',
        dommages_thermiques: 'non',
        dommages_chimiques: 'non',
        dommages_mecaniques: 'non',
        integrite_coque: 'bon',
        etat_doublure: 'bon',
        barriere_humidite: 'bon',
        quincaillerie: 'bon',
        ajustement_mobilite: 'bon',
        inspection_detaillee_doublure: 'bon',
        separation_doublure: 'non',
        bulles_delamination: 'non',
        coutures_cachees: 'bon',
        test_ajustement_complet: 'bon',
        condition_etiquettes: 'bon'
      };
    }
  };
  
  useEffect(() => {
    if (tenantSlug && user) {
      loadData();
      setInspectionForm(prev => ({
        ...prev,
        inspecteur_nom: `${user?.prenom || ''} ${user?.nom || ''}`,
        inspecteur_id: user?.id || ''
      }));
    }
  }, [tenantSlug, user]);
  
  useEffect(() => {
    if (activeTab === 'rapports' && tenantSlug) {
      loadRapports();
    }
  }, [activeTab, tenantSlug]);
  
  useEffect(() => {
    if (activeTab === 'demandes') {
      loadDemandesRemplacementEPI();
    }
  }, [activeTab]);
  
  const loadData = async () => {
    setLoading(true);
    try {
      const [episData, ispsData, usersData] = await Promise.all([
        apiGet(tenantSlug, '/epi'),
        apiGet(tenantSlug, '/isp'),
        apiGet(tenantSlug, '/users')
      ]);
      setEpis(episData || []);
      setIsps(ispsData || []);
      setUsers(usersData || []);
    } catch (error) {
      console.error('Erreur:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les donn√©es",
        variant: "destructive"
      });
    }
    setLoading(false);
  };
  
  const loadRapports = async () => {
    try {
      const [conformite, echeances, retraits, tco] = await Promise.all([
        apiGet(tenantSlug, '/epi/rapports/conformite'),
        apiGet(tenantSlug, '/epi/rapports/echeances?jours=30'),
        apiGet(tenantSlug, '/epi/rapports/retraits-prevus?mois=12'),
        apiGet(tenantSlug, '/epi/rapports/cout-total')
      ]);
      setRapportConformite(conformite);
      setRapportEcheances(echeances);
      setRapportRetraits(retraits);
      setRapportTCO(tco);
    } catch (error) {
      console.error('Erreur rapports:', error);
    }
  };
  
  const loadDemandesRemplacementEPI = async () => {
    try {
      const data = await apiGet(tenantSlug, '/epi/demandes-remplacement');
      setDemandesRemplacementEPI(data || []);
    } catch (error) {
      console.error('Erreur chargement demandes:', error);
    }
  };
  
  const loadInspections = async (epiId) => {
    try {
      const data = await apiGet(tenantSlug, `/epi/${epiId}/inspections`);
      setInspections(data || []);
    } catch (error) {
      console.error('Erreur inspections:', error);
    }
  };
  
  // Phase 2 - Charger nettoyages
  const loadNettoyages = async (epiId) => {
    try {
      const data = await apiGet(tenantSlug, `/epi/${epiId}/nettoyages`);
      setNettoyages(data || []);
    } catch (error) {
      console.error('Erreur nettoyages:', error);
    }
  };
  
  // Phase 2 - Charger r√©parations
  const loadReparations = async (epiId) => {
    try {
      const data = await apiGet(tenantSlug, `/epi/${epiId}/reparations`);
      setReparations(data || []);
    } catch (error) {
      console.error('Erreur r√©parations:', error);
    }
  };
  
  // CRUD EPI
  const handleSaveEPI = async () => {
    try {
      if (selectedEPI) {
        await apiPut(tenantSlug, `/epi/${selectedEPI.id}`, epiForm);
        toast({ title: "Succ√®s", description: "EPI modifi√©" });
      } else {
        await apiPost(tenantSlug, '/epi', epiForm);
        toast({ title: "Succ√®s", description: "EPI cr√©√©" });
      }
      setShowEPIModal(false);
      loadData();
      resetEPIForm();
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  const handleDeleteEPI = async (epiId) => {
    if (!window.confirm('Supprimer cet EPI ?')) return;
    try {
      await apiDelete(tenantSlug, `/epi/${epiId}`);
      toast({ title: "Succ√®s", description: "EPI supprim√©" });
      loadData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  const resetEPIForm = () => {
    setEpiForm({
      numero_serie: '',
      type_epi: 'casque',
      marque: '',
      modele: '',
      numero_serie_fabricant: '',
      date_fabrication: '',
      date_mise_en_service: new Date().toISOString().split('T')[0],
      norme_certification: 'NFPA 1971',
      cout_achat: 0,
      couleur: '',
      taille: '',
      user_id: '',
      statut: 'En service',
      notes: ''
    });
    setSelectedEPI(null);
  };
  
  const openEditEPI = (epi) => {
    setSelectedEPI(epi);
    setEpiForm({
      numero_serie: epi.numero_serie,
      type_epi: epi.type_epi,
      marque: epi.marque,
      modele: epi.modele,
      numero_serie_fabricant: epi.numero_serie_fabricant || '',
      date_fabrication: epi.date_fabrication || '',
      date_mise_en_service: epi.date_mise_en_service,
      norme_certification: epi.norme_certification || 'NFPA 1971',
      cout_achat: epi.cout_achat || 0,
      couleur: epi.couleur || '',
      taille: epi.taille || '',
      user_id: epi.user_id || '',
      statut: epi.statut,
      notes: epi.notes || ''
    });
    setShowEPIModal(true);
  };
  
  const openDetailEPI = async (epi) => {
    setSelectedEPI(epi);
    await Promise.all([
      loadInspections(epi.id),
      loadNettoyages(epi.id),
      loadReparations(epi.id)
    ]);
    setShowDetailModal(true);
  };
  
  // Inspections
  const handleSaveInspection = async () => {
    try {
      const data = {
        ...inspectionForm,
        type_inspection: typeInspection,
        checklist: getChecklistTemplate(typeInspection)
      };
      await apiPost(tenantSlug, `/epi/${selectedEPI.id}/inspection`, data);
      toast({ title: "Succ√®s", description: "Inspection enregistr√©e" });
      setShowInspectionModal(false);
      loadInspections(selectedEPI.id);
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  // ISP
  const handleSaveISP = async () => {
    try {
      if (selectedISP) {
        await apiPut(tenantSlug, `/isp/${selectedISP.id}`, ispForm);
        toast({ title: "Succ√®s", description: "Fournisseur modifi√©" });
      } else {
        await apiPost(tenantSlug, '/isp', ispForm);
        toast({ title: "Succ√®s", description: "Fournisseur ajout√©" });
      }
      setShowISPModal(false);
      loadData();
      resetISPForm();
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  const handleDeleteISP = async (ispId) => {
    if (!window.confirm('Supprimer ce fournisseur ?')) return;
    try {
      await apiDelete(tenantSlug, `/isp/${ispId}`);
      toast({ title: "Succ√®s", description: "Fournisseur supprim√©" });
      loadData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  const resetISPForm = () => {
    setIspForm({
      nom: '',
      contact: '',
      telephone: '',
      email: '',
      accreditations: '',
      notes: ''
    });
    setSelectedISP(null);
  };
  
  const openEditISP = (isp) => {
    setSelectedISP(isp);
    setIspForm({
      nom: isp.nom,
      contact: isp.contact || '',
      telephone: isp.telephone || '',
      email: isp.email || '',
      accreditations: isp.accreditations || '',
      notes: isp.notes || ''
    });
    setShowISPModal(true);
  };

  // Phase 2 - Handlers Nettoyage
  const handleSaveNettoyage = async () => {
    try {
      const data = {
        ...nettoyageForm,
        effectue_par: nettoyageForm.effectue_par || `${user?.prenom || ''} ${user?.nom || ''}`
      };
      await apiPost(tenantSlug, `/epi/${selectedEPI.id}/nettoyage`, data);
      toast({ title: "Succ√®s", description: "Nettoyage enregistr√©" });
      setShowNettoyageModal(false);
      loadNettoyages(selectedEPI.id);
      setNettoyageForm({
        type_nettoyage: 'routine',
        date_nettoyage: new Date().toISOString().split('T')[0],
        methode: 'laveuse_extractrice',
        effectue_par: '',
        effectue_par_id: user?.id || '',
        isp_id: '',
        nombre_cycles: 1,
        temperature: '',
        produits_utilises: '',
        notes: ''
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  // Phase 2 - Handlers R√©paration
  const handleSaveReparation = async () => {
    try {
      if (selectedReparation) {
        await apiPut(tenantSlug, `/epi/${selectedEPI.id}/reparation/${selectedReparation.id}`, reparationForm);
        toast({ title: "Succ√®s", description: "R√©paration mise √† jour" });
      } else {
        const data = {
          ...reparationForm,
          demandeur: reparationForm.demandeur || `${user?.prenom || ''} ${user?.nom || ''}`
        };
        await apiPost(tenantSlug, `/epi/${selectedEPI.id}/reparation`, data);
        toast({ title: "Succ√®s", description: "R√©paration cr√©√©e" });
      }
      setShowReparationModal(false);
      loadReparations(selectedEPI.id);
      setSelectedReparation(null);
      setReparationForm({
        statut: 'demandee',
        date_demande: new Date().toISOString().split('T')[0],
        demandeur: `${user?.prenom} ${user?.nom}` || '',
        demandeur_id: user?.id || '',
        reparateur_type: 'interne',
        reparateur_nom: '',
        isp_id: '',
        probleme_description: '',
        notes: ''
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  const openEditReparation = (reparation) => {
    setSelectedReparation(reparation);
    setReparationForm({
      statut: reparation.statut,
      date_demande: reparation.date_demande,
      demandeur: reparation.demandeur,
      demandeur_id: reparation.demandeur_id || '',
      reparateur_type: reparation.reparateur_type,
      reparateur_nom: reparation.reparateur_nom || '',
      isp_id: reparation.isp_id || '',
      probleme_description: reparation.probleme_description,
      notes: reparation.notes || ''
    });
    setShowReparationModal(true);
  };
  
  // Phase 2 - Handlers Retrait
  const handleSaveRetrait = async () => {
    try {
      await apiPost(tenantSlug, `/epi/${selectedEPI.id}/retrait`, retraitForm);
      toast({ title: "Succ√®s", description: "EPI retir√© avec succ√®s" });
      setShowRetraitModal(false);
      setShowDetailModal(false);
      loadData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur",
        variant: "destructive"
      });
    }
  };
  
  const getTypeIcon = (type) => typesEPI.find(t => t.id === type)?.icone || 'üõ°Ô∏è';
  const getTypeName = (type) => typesEPI.find(t => t.id === type)?.nom || type;
  const getStatutColor = (statut) => {
    const colors = {
      'En service': '#10B981',
      'En inspection': '#F59E0B',
      'En r√©paration': '#EF4444',
      'Hors service': '#DC2626',
      'Retir√©': '#6B7280'
    };
    return colors[statut] || '#6B7280';
  };
  
  const getUserName = (userId) => {
    const user = users.find(u => u.id === userId);
    return user ? `${user.prenom} ${user.nom}` : 'Non assign√©';
  };
  
  if (loading) {
    return (
      <div className="module-container">
        <div className="loading-spinner"></div>
        <p>Chargement...</p>
      </div>
    );
  }
  
  return (
    <div className="module-epi-nfpa">
      <div className="module-header">
        <div>
          <h1>üõ°Ô∏è Gestion EPI - NFPA 1851</h1>
          <p>Syst√®me complet de gestion des √©quipements de protection</p>
        </div>
      </div>
      
      {/* Onglets */}
      <div className="epi-tabs">
        <button 
          className={activeTab === 'inventaire' ? 'active' : ''}
          onClick={() => setActiveTab('inventaire')}
        >
          üì¶ Inventaire ({epis.length})
        </button>
        <button 
          className={activeTab === 'demandes' ? 'active' : ''}
          onClick={() => setActiveTab('demandes')}
        >
          üîÑ Demandes de remplacement
        </button>
        <button 
          className={activeTab === 'nettoyage' ? 'active' : ''}
          onClick={() => setActiveTab('nettoyage')}
        >
          üßº Nettoyage & Entretien
        </button>
        <button 
          className={activeTab === 'reparations' ? 'active' : ''}
          onClick={() => setActiveTab('reparations')}
        >
          üîß R√©parations
        </button>
        <button 
          className={activeTab === 'isp' ? 'active' : ''}
          onClick={() => setActiveTab('isp')}
        >
          üè¢ Fournisseurs ISP ({isps.length})
        </button>
        <button 
          className={activeTab === 'rapports' ? 'active' : ''}
          onClick={() => setActiveTab('rapports')}
        >
          üìä Rapports
        </button>
      </div>
      
      {/* ONGLET INVENTAIRE */}
      {activeTab === 'inventaire' && (
        <div className="epi-inventaire">
          <div className="inventaire-actions">
            <Button onClick={() => { resetEPIForm(); setShowEPIModal(true); }}>
              ‚ûï Nouvel EPI
            </Button>
          </div>
          
          <div className="epi-grid">
            {epis.map(epi => (
              <div key={epi.id} className="epi-card">
                <div className="epi-card-header">
                  <span className="epi-icon">{getTypeIcon(epi.type_epi)}</span>
                  <div>
                    <h3>{getTypeName(epi.type_epi)}</h3>
                    <p className="epi-numero">#{epi.numero_serie}</p>
                  </div>
                  <span 
                    className="epi-statut-badge" 
                    style={{ backgroundColor: getStatutColor(epi.statut) }}
                  >
                    {epi.statut}
                  </span>
                </div>
                <div className="epi-card-body">
                  <p><strong>Marque:</strong> {epi.marque}</p>
                  <p><strong>Mod√®le:</strong> {epi.modele}</p>
                  <p><strong>Assign√© √†:</strong> {getUserName(epi.user_id)}</p>
                  <p><strong>Mise en service:</strong> {new Date(epi.date_mise_en_service).toLocaleDateString('fr-FR')}</p>
                </div>
                <div className="epi-card-actions">
                  <Button size="sm" variant="outline" onClick={() => openDetailEPI(epi)}>
                    üìã D√©tails
                  </Button>
                  <Button size="sm" onClick={() => openEditEPI(epi)}>
                    ‚úèÔ∏è Modifier
                  </Button>
                  <Button size="sm" variant="destructive" onClick={() => handleDeleteEPI(epi.id)}>
                    üóëÔ∏è
                  </Button>
                </div>
              </div>
            ))}
          </div>
          
          {epis.length === 0 && (
            <div className="empty-state">
              <p>Aucun EPI enregistr√©</p>
              <Button onClick={() => { resetEPIForm(); setShowEPIModal(true); }}>
                Cr√©er le premier EPI
              </Button>
            </div>
          )}
        </div>
      )}
      
      {/* ONGLET DEMANDES DE REMPLACEMENT */}
      {activeTab === 'demandes' && (
        <div className="epi-demandes">
          <div className="demandes-header">
            <h2>üîÑ Demandes de remplacement EPI</h2>
            <p>G√©rer les demandes de remplacement des employ√©s</p>
          </div>
          
          {/* Statistiques */}
          <div className="demandes-stats">
            <div className="stat-card">
              <h3>{demandesRemplacementEPI.filter(d => d.statut === 'En attente').length}</h3>
              <p>En attente</p>
            </div>
            <div className="stat-card">
              <h3>{demandesRemplacementEPI.filter(d => d.statut === 'Approuv√©e').length}</h3>
              <p>Approuv√©es</p>
            </div>
            <div className="stat-card">
              <h3>{demandesRemplacementEPI.filter(d => d.statut === 'Refus√©e').length}</h3>
              <p>Refus√©es</p>
            </div>
          </div>

          {/* Liste des demandes */}
          <div className="demandes-list">
            {demandesRemplacementEPI.length === 0 ? (
              <div className="empty-state">
                <p>Aucune demande de remplacement</p>
              </div>
            ) : (
              demandesRemplacementEPI.map(demande => {
                const epi = epis.find(e => e.id === demande.epi_id);
                const employe = users.find(u => u.id === demande.user_id);
                
                return (
                  <div key={demande.id} className="demande-card">
                    <div className="demande-header">
                      <div className="demande-info">
                        <h4>{epi ? `${getTypeIcon(epi.type_epi)} ${getTypeName(epi.type_epi)} - #${epi.numero_serie}` : 'EPI inconnu'}</h4>
                        <p>Demand√© par: <strong>{employe ? `${employe.prenom} ${employe.nom}` : 'Inconnu'}</strong></p>
                        <p>Date: {new Date(demande.date_demande).toLocaleDateString('fr-FR')} √† {new Date(demande.date_demande).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</p>
                      </div>
                      <span 
                        className="demande-statut-badge" 
                        style={{
                          backgroundColor: 
                            demande.statut === 'En attente' ? '#F59E0B' :
                            demande.statut === 'Approuv√©e' ? '#10B981' :
                            '#EF4444'
                        }}
                      >
                        {demande.statut}
                      </span>
                    </div>
                    
                    <div className="demande-body">
                      <p><strong>Raison:</strong> {demande.raison}</p>
                      {demande.notes_employe && (
                        <p><strong>D√©tails:</strong> {demande.notes_employe}</p>
                      )}
                      {demande.notes_admin && (
                        <p><strong>Notes admin:</strong> {demande.notes_admin}</p>
                      )}
                    </div>

                    {demande.statut === 'En attente' && (
                      <div className="demande-actions">
                        <Button 
                          size="sm" 
                          onClick={() => {
                            setSelectedDemandeRemplacement(demande);
                            setShowRemplacementModal(true);
                          }}
                        >
                          ‚úÖ Approuver & Remplacer
                        </Button>
                        <Button 
                          size="sm" 
                          variant="destructive"
                          onClick={async () => {
                            try {
                              await apiPost(tenantSlug, `/epi/demandes-remplacement/${demande.id}/refuser`, {
                                notes_admin: 'Demande refus√©e'
                              });
                              toast({ title: "Succ√®s", description: "Demande refus√©e" });
                              loadDemandesRemplacementEPI();
                            } catch (error) {
                              toast({ title: "Erreur", description: "Impossible de refuser la demande", variant: "destructive" });
                            }
                          }}
                        >
                          ‚ùå Refuser
                        </Button>
                      </div>
                    )}
                  </div>
                );
              })
            )}
          </div>
        </div>
      )}

      {/* ONGLET ISP */}
      {activeTab === 'isp' && (
        <div className="epi-isp">
          <div className="isp-actions">
            <Button onClick={() => { resetISPForm(); setShowISPModal(true); }}>
              ‚ûï Nouveau Fournisseur
            </Button>
          </div>
          
          <div className="isp-list">
            {isps.map(isp => (
              <div key={isp.id} className="isp-card">
                <div className="isp-header">
                  <h3>üè¢ {isp.nom}</h3>
                </div>
                <div className="isp-body">
                  <p><strong>Contact:</strong> {isp.contact}</p>
                  <p><strong>T√©l√©phone:</strong> {isp.telephone}</p>
                  <p><strong>Email:</strong> {isp.email}</p>
                  <p><strong>Accr√©ditations:</strong> {isp.accreditations || 'Aucune'}</p>
                </div>
                <div className="isp-actions">
                  <Button size="sm" onClick={() => openEditISP(isp)}>
                    ‚úèÔ∏è Modifier
                  </Button>
                  <Button size="sm" variant="destructive" onClick={() => handleDeleteISP(isp.id)}>
                    üóëÔ∏è
                  </Button>
                </div>
              </div>
            ))}
          </div>
          
          {isps.length === 0 && (
            <div className="empty-state">
              <p>Aucun fournisseur enregistr√©</p>
              <Button onClick={() => { resetISPForm(); setShowISPModal(true); }}>
                Ajouter un fournisseur
              </Button>
            </div>
          )}
        </div>
      )}
      

      {/* ONGLET NETTOYAGE & ENTRETIEN */}
      {activeTab === 'nettoyage' && (
        <div className="epi-nettoyage">
          <div className="nettoyage-header">
            <h2>üßº Nettoyage & Entretien</h2>
            <p>Suivi des nettoyages routines et avanc√©s selon NFPA 1851</p>
          </div>
          
          <div className="nettoyage-info-card">
            <h3>üìã Exigences NFPA 1851</h3>
            <ul>
              <li><strong>Nettoyage Routine:</strong> Apr√®s chaque utilisation ou contamination visible</li>
              <li><strong>Nettoyage Avanc√©:</strong> Au moins 2 fois par an minimum</li>
              <li><strong>M√©thode recommand√©e:</strong> Laveuse extractrice avec cycle programmable</li>
              <li><strong>Temp√©rature:</strong> Eau ti√®de maximum 40¬∞C</li>
              <li><strong>S√©chage:</strong> √Ä l'abri des UV</li>
            </ul>
          </div>
          
          <div className="nettoyage-list">
            <h3>EPIs en nettoyage ({epis.filter(e => e.statut === 'En nettoyage' || e.statut === 'En maintenance').length})</h3>
            {epis.filter(e => e.statut === 'En nettoyage' || e.statut === 'En maintenance').length === 0 ? (
              <div className="empty-state">
                <p>Aucun EPI en nettoyage actuellement</p>
              </div>
            ) : (
              epis.filter(e => e.statut === 'En nettoyage' || e.statut === 'En maintenance').map(epi => (
                <div key={epi.id} className="nettoyage-epi-card">
                  <div className="nettoyage-epi-header">
                    <span>{getTypeIcon(epi.type_epi)} {getTypeName(epi.type_epi)}</span>
                    <span>#{epi.numero_serie}</span>
                    <Button 
                      size="sm"
                      onClick={async () => {
                        setSelectedEPI(epi);
                        await loadNettoyages(epi.id);
                        setShowNettoyageModal(true);
                      }}
                    >
                      ‚ûï Ajouter nettoyage
                    </Button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      )}
      
      {/* ONGLET R√âPARATIONS */}
      {activeTab === 'reparations' && (
        <div className="epi-reparations">
          <div className="reparations-header">
            <h2>üîß Gestion des R√©parations</h2>
            <p>Suivi des tickets de r√©paration et interventions</p>
          </div>
          
          <div className="reparations-stats">
            <div className="stat-card">
              <h3>{epis.filter(e => e.statut === 'En r√©paration').length}</h3>
              <p>En cours</p>
            </div>
          </div>
          
          <div className="reparations-list">
            <h3>EPIs en r√©paration ({epis.filter(e => e.statut === 'En r√©paration').length})</h3>
            {epis.filter(e => e.statut === 'En r√©paration').length === 0 ? (
              <div className="empty-state">
                <p>Aucun EPI en r√©paration actuellement</p>
              </div>
            ) : (
              epis.filter(e => e.statut === 'En r√©paration').map(epi => (
                <div key={epi.id} className="reparation-epi-card">
                  <div className="reparation-epi-header">
                    <span>{getTypeIcon(epi.type_epi)} {getTypeName(epi.type_epi)} - #{epi.numero_serie}</span>
                    <span className="epi-statut-badge" style={{backgroundColor: getStatutColor(epi.statut)}}>
                      {epi.statut}
                    </span>
                    <Button 
                      size="sm"
                      onClick={async () => {
                        setSelectedEPI(epi);
                        await loadReparations(epi.id);
                        setSelectedReparation(null);
                        setShowReparationModal(true);
                      }}
                    >
                      ‚ûï Nouvelle r√©paration
                    </Button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      )}

      {/* ONGLET RAPPORTS */}
      {activeTab === 'rapports' && !rapportConformite && (
        <div className="epi-rapports">
          <div className="loading-state" style={{textAlign: 'center', padding: '3rem'}}>
            <p>Chargement des rapports...</p>
          </div>
        </div>
      )}
      
      {activeTab === 'rapports' && rapportConformite && (
        <div className="epi-rapports">
          {/* Filtres et Exports */}
          <div className="rapports-controls">
            <div className="filtres-section">
                  <h3>üîç Filtres</h3>
                  <div className="filtres-grid">
                    <div>
                      <Label>Employ√©</Label>
                      <select className="form-select">
                        <option value="">Tous les employ√©s</option>
                        {users.map(u => (
                          <option key={u.id} value={u.id}>{u.prenom} {u.nom}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <Label>Type d'EPI</Label>
                      <select className="form-select">
                        <option value="">Tous les types</option>
                        {typesEPI.map(t => (
                          <option key={t.id} value={t.id}>{t.icone} {t.nom}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <Label>Date d√©but</Label>
                      <Input type="date" />
                    </div>
                    
                    <div>
                      <Label>Date fin</Label>
                      <Input type="date" />
                    </div>
                  </div>
                </div>
                
                <div className="exports-section">
                  <h3>üì• Exporter</h3>
                  <div className="exports-buttons">
                    <Button variant="outline">
                      üìÑ Export PDF
                    </Button>
                    <Button variant="outline">
                      üìä Export Excel
                    </Button>
                  </div>
                </div>
              </div>
              
              <h2>üìä Rapport de Conformit√© G√©n√©rale</h2>
              <div className="rapport-stats">
            <div className="stat-card">
              <h3>{rapportConformite.total}</h3>
              <p>Total EPI</p>
            </div>
            <div className="stat-card" style={{background: '#D1FAE5'}}>
              <h3>{rapportConformite.en_service}</h3>
              <p>En service</p>
            </div>
            <div className="stat-card" style={{background: '#FEF3C7'}}>
              <h3>{rapportConformite.en_inspection}</h3>
              <p>En inspection</p>
            </div>
            <div className="stat-card" style={{background: '#FEE2E2'}}>
              <h3>{rapportConformite.en_reparation}</h3>
              <p>En r√©paration</p>
            </div>
          </div>
          
          <h2 style={{marginTop: '2rem'}}>üìÖ √âch√©ances d'Inspection (30 jours)</h2>
          {rapportEcheances && rapportEcheances.echeances.length > 0 ? (
            <div className="echeances-list">
              {rapportEcheances.echeances.map(epi => (
                <div key={epi.id} className="echeance-card">
                  <div>
                    <strong>{getTypeIcon(epi.type_epi)} {getTypeName(epi.type_epi)}</strong>
                    <p>#{epi.numero_serie}</p>
                  </div>
                  <div>
                    <span className={`jours-badge ${epi.jours_restants <= 7 ? 'urgent' : ''}`}>
                      {epi.jours_restants} jours restants
                    </span>
                    <p>Type: {epi.type_inspection_requise.replace('_', ' ')}</p>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p>Aucune √©ch√©ance dans les 30 prochains jours</p>
          )}
          
          {/* Rapport Retraits Pr√©vus - Phase 2 */}
          <h2 style={{marginTop: '3rem'}}>‚è∞ EPI √† Retirer Prochainement (12 mois)</h2>
          {rapportRetraits && rapportRetraits.epis && rapportRetraits.epis.length > 0 ? (
            <div className="retraits-list">
              {rapportRetraits.epis.map(epi => (
                <div key={epi.id} className="retrait-card">
                  <div>
                    <strong>{getTypeIcon(epi.type_epi)} {getTypeName(epi.type_epi)}</strong>
                    <p>#{epi.numero_serie} - {epi.marque} {epi.modele}</p>
                  </div>
                  <div>
                    <span className="age-badge">
                      √Çge: {epi.age_annees} ans
                    </span>
                    <span className={`jours-badge ${epi.jours_avant_limite <= 90 ? 'urgent' : ''}`}>
                      {epi.jours_avant_limite} jours avant limite
                    </span>
                    <p style={{fontSize: '0.85rem', color: '#666', marginTop: '0.5rem'}}>
                      Limite: {new Date(epi.date_limite_prevue).toLocaleDateString('fr-FR')}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p>Aucun EPI √† retirer dans les 12 prochains mois</p>
          )}
          
          {/* Rapport TCO - Phase 2 */}
          <h2 style={{marginTop: '3rem'}}>üí∞ Co√ªt Total de Possession (TCO)</h2>
          {rapportTCO && rapportTCO.epis && (
            <>
              <div className="tco-summary" style={{marginBottom: '1.5rem'}}>
                <div className="stat-card">
                  <h3>{rapportTCO.total_epis}</h3>
                  <p>Total EPI</p>
                </div>
                <div className="stat-card">
                  <h3>{rapportTCO.cout_total_flotte.toFixed(2)} $</h3>
                  <p>Co√ªt Total Flotte</p>
                </div>
                <div className="stat-card">
                  <h3>{rapportTCO.cout_moyen_par_epi.toFixed(2)} $</h3>
                  <p>Co√ªt Moyen/EPI</p>
                </div>
              </div>
              
              <div className="tco-list">
                {rapportTCO.epis.slice(0, 10).map(epi => (
                  <div key={epi.id} className="tco-card">
                    <div>
                      <strong>{getTypeIcon(epi.type_epi)} {getTypeName(epi.type_epi)}</strong>
                      <p>#{epi.numero_serie}</p>
                    </div>
                    <div className="tco-details">
                      <p><strong>Achat:</strong> {epi.cout_achat} $</p>
                      <p><strong>Nettoyages:</strong> {epi.cout_nettoyages} $ ({epi.nombre_nettoyages}x)</p>
                      <p><strong>R√©parations:</strong> {epi.cout_reparations} $ ({epi.nombre_reparations}x)</p>
                      <p style={{fontWeight: 'bold', color: '#1F2937', marginTop: '0.5rem'}}>
                        Total: {epi.cout_total.toFixed(2)} $
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      )}
      
      {/* MODAL EPI */}
      {showEPIModal && (
        <div className="modal-overlay" onClick={() => setShowEPIModal(false)}>
          <div className="modal-content large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>{selectedEPI ? 'Modifier EPI' : 'Nouvel EPI'}</h2>
              <Button variant="ghost" onClick={() => setShowEPIModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <div className="form-grid">
                <div>
                  <Label>Num√©ro de s√©rie interne (optionnel)</Label>
                  <Input 
                    value={epiForm.numero_serie}
                    onChange={e => setEpiForm({...epiForm, numero_serie: e.target.value})}
                    placeholder="G√©n√©r√© automatiquement si vide (Ex: EPI-2025-0001)"
                  />
                  <small style={{display: 'block', marginTop: '4px', color: '#666'}}>
                    Laissez vide pour g√©n√©ration automatique
                  </small>
                </div>
                
                <div>
                  <Label>Type d'EPI *</Label>
                  <select 
                    className="form-select"
                    value={epiForm.type_epi}
                    onChange={e => setEpiForm({...epiForm, type_epi: e.target.value})}
                  >
                    {typesEPI.map(t => (
                      <option key={t.id} value={t.id}>{t.icone} {t.nom}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <Label>Marque *</Label>
                  <Input 
                    value={epiForm.marque}
                    onChange={e => setEpiForm({...epiForm, marque: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Mod√®le *</Label>
                  <Input 
                    value={epiForm.modele}
                    onChange={e => setEpiForm({...epiForm, modele: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>N¬∞ s√©rie fabricant</Label>
                  <Input 
                    value={epiForm.numero_serie_fabricant}
                    onChange={e => setEpiForm({...epiForm, numero_serie_fabricant: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Date fabrication</Label>
                  <Input 
                    type="date"
                    value={epiForm.date_fabrication}
                    onChange={e => setEpiForm({...epiForm, date_fabrication: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Date mise en service *</Label>
                  <Input 
                    type="date"
                    value={epiForm.date_mise_en_service}
                    onChange={e => setEpiForm({...epiForm, date_mise_en_service: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Norme certification</Label>
                  <Input 
                    value={epiForm.norme_certification}
                    onChange={e => setEpiForm({...epiForm, norme_certification: e.target.value})}
                    placeholder="Ex: NFPA 1971, √©dition 2018"
                  />
                </div>
                
                <div>
                  <Label>Co√ªt d'achat</Label>
                  <Input 
                    type="number"
                    value={epiForm.cout_achat}
                    onChange={e => setEpiForm({...epiForm, cout_achat: parseFloat(e.target.value) || 0})}
                  />
                </div>
                
                <div>
                  <Label>Couleur</Label>
                  <Input 
                    value={epiForm.couleur}
                    onChange={e => setEpiForm({...epiForm, couleur: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Taille</Label>
                  <Input 
                    value={epiForm.taille}
                    onChange={e => setEpiForm({...epiForm, taille: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Assign√© √†</Label>
                  <select 
                    className="form-select"
                    value={epiForm.user_id}
                    onChange={e => setEpiForm({...epiForm, user_id: e.target.value})}
                  >
                    <option value="">Non assign√©</option>
                    {users.map(u => (
                      <option key={u.id} value={u.id}>{u.prenom} {u.nom}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <Label>Statut *</Label>
                  <select 
                    className="form-select"
                    value={epiForm.statut}
                    onChange={e => setEpiForm({...epiForm, statut: e.target.value})}
                  >
                    <option>En service</option>
                    <option>En inspection</option>
                    <option>En r√©paration</option>
                    <option>Hors service</option>
                    <option>Retir√©</option>
                  </select>
                </div>
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Notes</Label>
                <textarea 
                  className="form-textarea"
                  rows="3"
                  value={epiForm.notes}
                  onChange={e => setEpiForm({...epiForm, notes: e.target.value})}
                />
              </div>
            </div>
            
            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowEPIModal(false)}>Annuler</Button>
              <Button onClick={handleSaveEPI}>
                {selectedEPI ? 'Modifier' : 'Cr√©er'}
              </Button>
            </div>
          </div>
        </div>
      )}
      
      {/* MODAL APPROBATION REMPLACEMENT EPI */}
      {showRemplacementModal && selectedDemandeRemplacement && (
        <div className="modal-overlay" onClick={() => setShowRemplacementModal(false)}>
          <div className="modal-content" style={{ maxWidth: '600px' }} onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>‚úÖ Approuver & Remplacer l'EPI</h3>
              <Button variant="ghost" onClick={() => setShowRemplacementModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              {(() => {
                const epi = epis.find(e => e.id === selectedDemandeRemplacement.epi_id);
                const employe = users.find(u => u.id === selectedDemandeRemplacement.user_id);
                
                return (
                  <>
                    <div style={{ backgroundColor: '#fef3c7', padding: '1rem', borderRadius: '0.5rem', marginBottom: '1.5rem' }}>
                      <strong>üìã Demande de remplacement :</strong>
                      <p style={{ marginTop: '0.5rem' }}>
                        <strong>EPI actuel :</strong> {epi ? `${getTypeName(epi.type_epi)} - #${epi.numero_serie}` : 'Inconnu'}<br/>
                        <strong>Employ√© :</strong> {employe ? `${employe.prenom} ${employe.nom}` : 'Inconnu'}<br/>
                        <strong>Raison :</strong> {selectedDemandeRemplacement.raison}
                      </p>
                    </div>

                    <h4 style={{ marginBottom: '1rem' }}>üÜï Informations du nouvel EPI</h4>
                    
                    <div className="form-group">
                      <Label>Num√©ro de s√©rie *</Label>
                      <Input 
                        id="nouveau-numero-serie"
                        placeholder="Ex: NS-2025-001"
                      />
                    </div>

                    <div className="form-group">
                      <Label>Marque</Label>
                      <Input 
                        id="nouvelle-marque"
                        placeholder="Ex: MSA, Honeywell..."
                      />
                    </div>

                    <div className="form-group">
                      <Label>Mod√®le</Label>
                      <Input 
                        id="nouveau-modele"
                        placeholder="Ex: G1 SCBA, Cairns 1010..."
                      />
                    </div>

                    <div className="form-group">
                      <Label>Taille</Label>
                      <Input 
                        id="nouvelle-taille"
                        defaultValue={epi?.taille || ''}
                        placeholder="Ex: M, L, XL..."
                      />
                    </div>

                    <div className="form-group">
                      <Label>Date de mise en service *</Label>
                      <Input 
                        type="date"
                        id="nouvelle-date-service"
                        defaultValue={new Date().toISOString().split('T')[0]}
                      />
                    </div>

                    <div className="form-group">
                      <Label>Notes admin</Label>
                      <textarea 
                        id="notes-admin-remplacement"
                        className="form-control"
                        rows="3"
                        placeholder="Notes sur le remplacement..."
                        defaultValue="Remplacement approuv√© et nouvel EPI attribu√©"
                      />
                    </div>

                    <div className="form-group">
                      <Label>Que faire avec l'ancien EPI ? *</Label>
                      <div style={{ marginTop: '0.5rem' }}>
                        <label style={{ display: 'block', marginBottom: '0.5rem', cursor: 'pointer' }}>
                          <input 
                            type="radio" 
                            name="action-ancien-epi" 
                            value="garder"
                            defaultChecked
                            style={{ marginRight: '0.5rem' }}
                          />
                          Garder en historique (statut "Retir√©")
                        </label>
                        <label style={{ display: 'block', cursor: 'pointer' }}>
                          <input 
                            type="radio" 
                            name="action-ancien-epi" 
                            value="supprimer"
                            style={{ marginRight: '0.5rem' }}
                          />
                          Supprimer compl√®tement de la base de donn√©es
                        </label>
                      </div>
                    </div>
                  </>
                );
              })()}
            </div>

            <div className="modal-footer">
              <Button variant="outline" onClick={() => setShowRemplacementModal(false)}>Annuler</Button>
              <Button onClick={async () => {
                try {
                  const nouveauNumeroSerie = document.getElementById('nouveau-numero-serie').value;
                  const nouvelleMarque = document.getElementById('nouvelle-marque').value;
                  const nouveauModele = document.getElementById('nouveau-modele').value;
                  const nouvelleTaille = document.getElementById('nouvelle-taille').value;
                  const nouvelleDateService = document.getElementById('nouvelle-date-service').value;
                  const notesAdmin = document.getElementById('notes-admin-remplacement').value;
                  const actionAncienEPI = document.querySelector('input[name="action-ancien-epi"]:checked').value;

                  if (!nouveauNumeroSerie || !nouvelleDateService) {
                    toast({ title: "Erreur", description: "Le num√©ro de s√©rie et la date de mise en service sont obligatoires", variant: "destructive" });
                    return;
                  }

                  const epi = epis.find(e => e.id === selectedDemandeRemplacement.epi_id);

                  // 1. Traiter l'ancien EPI selon le choix
                  if (actionAncienEPI === 'garder') {
                    // Marquer l'ancien EPI comme retir√©
                    await apiPut(tenantSlug, `/epi/${selectedDemandeRemplacement.epi_id}`, {
                      ...epi,
                      statut: 'Retir√©',
                      notes: (epi.notes || '') + ` [Retir√© le ${new Date().toLocaleDateString('fr-FR')} - Remplac√© par ${nouveauNumeroSerie}]`
                    });
                  } else if (actionAncienEPI === 'supprimer') {
                    // Supprimer compl√®tement l'ancien EPI
                    await apiDelete(tenantSlug, `/epi/${selectedDemandeRemplacement.epi_id}`);
                  }

                  // 2. Cr√©er le nouvel EPI
                  const nouvelEPI = {
                    type_epi: epi.type_epi,
                    numero_serie: nouveauNumeroSerie,
                    marque: nouvelleMarque,
                    modele: nouveauModele,
                    taille: nouvelleTaille,
                    date_mise_en_service: nouvelleDateService,
                    date_attribution: new Date().toISOString().split('T')[0],
                    statut: 'En service',
                    user_id: selectedDemandeRemplacement.user_id,
                    notes: `Attribu√© suite √† remplacement de ${epi.numero_serie}`
                  };

                  await apiPost(tenantSlug, '/epi', nouvelEPI);

                  // 3. Approuver la demande
                  await apiPost(tenantSlug, `/epi/demandes-remplacement/${selectedDemandeRemplacement.id}/approuver`, {
                    notes_admin: notesAdmin
                  });

                  toast({ title: "Succ√®s", description: `Remplacement effectu√© avec succ√®s. Ancien EPI: ${actionAncienEPI === 'garder' ? 'conserv√© en historique' : 'supprim√©'}` });
                  setShowRemplacementModal(false);
                  loadDemandesRemplacementEPI();
                  loadEPIs();
                } catch (error) {
                  console.error('Erreur remplacement:', error);
                  toast({ title: "Erreur", description: "Impossible d'effectuer le remplacement", variant: "destructive" });
                }
              }}>
                ‚úÖ Approuver & Remplacer
              </Button>
            </div>
          </div>
        </div>
      )}
      
      {/* MODAL D√âTAIL EPI */}
      {showDetailModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowDetailModal(false)}>
          <div className="modal-content extra-large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>{getTypeIcon(selectedEPI.type_epi)} D√©tails EPI - #{selectedEPI.numero_serie}</h2>
              <Button variant="ghost" onClick={() => setShowDetailModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <div className="epi-detail-grid">
                <div className="detail-section">
                  <h3>Informations g√©n√©rales</h3>
                  <p><strong>Type:</strong> {getTypeName(selectedEPI.type_epi)}</p>
                  <p><strong>Marque:</strong> {selectedEPI.marque}</p>
                  <p><strong>Mod√®le:</strong> {selectedEPI.modele}</p>
                  <p><strong>N¬∞ s√©rie fabricant:</strong> {selectedEPI.numero_serie_fabricant || 'N/A'}</p>
                  <p><strong>Norme:</strong> {selectedEPI.norme_certification}</p>
                  <p><strong>Statut:</strong> <span style={{color: getStatutColor(selectedEPI.statut)}}>{selectedEPI.statut}</span></p>
                </div>
                
                <div className="detail-section">
                  <h3>Dates & Co√ªts</h3>
                  <p><strong>Fabrication:</strong> {selectedEPI.date_fabrication ? new Date(selectedEPI.date_fabrication).toLocaleDateString('fr-FR') : 'N/A'}</p>
                  <p><strong>Mise en service:</strong> {new Date(selectedEPI.date_mise_en_service).toLocaleDateString('fr-FR')}</p>
                  <p><strong>Co√ªt d'achat:</strong> {selectedEPI.cout_achat} $</p>
                </div>
                
                <div className="detail-section">
                  <h3>Affectation</h3>
                  <p><strong>Assign√© √†:</strong> {getUserName(selectedEPI.user_id)}</p>
                  <p><strong>Taille:</strong> {selectedEPI.taille || 'N/A'}</p>
                  <p><strong>Couleur:</strong> {selectedEPI.couleur || 'N/A'}</p>
                </div>
              </div>
              
              <div className="inspections-section" style={{marginTop: '2rem'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                  <h3>üìã Historique des inspections ({inspections.length})</h3>
                  <Button onClick={() => setShowInspectionModal(true)}>
                    ‚ûï Nouvelle inspection
                  </Button>
                </div>
                
                {inspections.length > 0 ? (
                  <div className="inspections-list">
                    {inspections.map(insp => (
                      <div key={insp.id} className="inspection-card">
                        <div className="inspection-header">
                          <span className="inspection-type-badge">
                            {insp.type_inspection === 'apres_utilisation' ? 'üîç Apr√®s utilisation' :
                             insp.type_inspection === 'routine_mensuelle' ? 'üìÖ Routine mensuelle' :
                             'üî¨ Avanc√©e annuelle'}
                          </span>
                          <span className={`statut-badge ${insp.statut_global}`}>
                            {insp.statut_global}
                          </span>
                        </div>
                        <p><strong>Date:</strong> {new Date(insp.date_inspection).toLocaleDateString('fr-FR')}</p>
                        <p><strong>Inspecteur:</strong> {insp.inspecteur_nom}</p>
                        {insp.isp_nom && <p><strong>ISP:</strong> {insp.isp_nom}</p>}
                        {insp.commentaires && <p><strong>Commentaires:</strong> {insp.commentaires}</p>}
                      </div>
                    ))}
                  </div>
                ) : (
                  <p>Aucune inspection enregistr√©e</p>
                )}
              </div>
              
              {/* Section Nettoyages - Phase 2 */}
              <div className="nettoyages-section" style={{marginTop: '2rem'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                  <h3>üßº Historique des nettoyages ({nettoyages.length})</h3>
                  <Button onClick={() => setShowNettoyageModal(true)}>
                    ‚ûï Nouveau nettoyage
                  </Button>
                </div>
                
                {nettoyages.length > 0 ? (
                  <div className="nettoyages-list">
                    {nettoyages.map(nett => (
                      <div key={nett.id} className="nettoyage-card">
                        <div className="nettoyage-header">
                          <span className={`type-badge ${nett.type_nettoyage}`}>
                            {nett.type_nettoyage === 'routine' ? 'üßΩ Routine' : 'üßº Avanc√©'}
                          </span>
                          <span>{nett.methode}</span>
                        </div>
                        <p><strong>Date:</strong> {new Date(nett.date_nettoyage).toLocaleDateString('fr-FR')}</p>
                        <p><strong>Effectu√© par:</strong> {nett.effectue_par}</p>
                        <p><strong>Cycles:</strong> {nett.nombre_cycles}</p>
                        {nett.notes && <p><strong>Notes:</strong> {nett.notes}</p>}
                      </div>
                    ))}
                  </div>
                ) : (
                  <p>Aucun nettoyage enregistr√©</p>
                )}
              </div>
              
              {/* Section R√©parations - Phase 2 */}
              <div className="reparations-section" style={{marginTop: '2rem'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                  <h3>üîß Historique des r√©parations ({reparations.length})</h3>
                  <Button onClick={() => {
                    setSelectedReparation(null);
                    setShowReparationModal(true);
                  }}>
                    ‚ûï Nouvelle r√©paration
                  </Button>
                </div>
                
                {reparations.length > 0 ? (
                  <div className="reparations-list">
                    {reparations.map(rep => (
                      <div key={rep.id} className="reparation-card">
                        <div className="reparation-header">
                          <span className={`statut-badge ${rep.statut}`}>
                            {rep.statut === 'demandee' ? 'üìù Demand√©e' :
                             rep.statut === 'en_cours' ? '‚öôÔ∏è En cours' :
                             rep.statut === 'terminee' ? '‚úÖ Termin√©e' :
                             '‚ùå Impossible'}
                          </span>
                          <span>{rep.reparateur_type === 'interne' ? 'üè† Interne' : 'üè¢ Externe'}</span>
                        </div>
                        <p><strong>Demande:</strong> {new Date(rep.date_demande).toLocaleDateString('fr-FR')}</p>
                        <p><strong>Probl√®me:</strong> {rep.probleme_description}</p>
                        <p><strong>Co√ªt:</strong> {rep.cout_reparation} $</p>
                        <Button 
                          size="sm" 
                          onClick={() => openEditReparation(rep)}
                          style={{marginTop: '0.5rem'}}
                        >
                          ‚úèÔ∏è Mettre √† jour
                        </Button>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p>Aucune r√©paration enregistr√©e</p>
                )}
              </div>
              
              {/* Section Retrait - Phase 2 */}
              {selectedEPI.statut !== 'Retir√©' && (
                <div className="retrait-section" style={{marginTop: '2rem', padding: '1.5rem', background: '#FEF3C7', borderRadius: '12px'}}>
                  <h3 style={{color: '#92400E'}}>‚ö†Ô∏è Retrait de l'EPI</h3>
                  <p style={{fontSize: '0.9rem', color: '#78350F'}}>
                    Cet EPI doit √™tre retir√© du service de mani√®re d√©finitive ? (√¢ge limite, dommage irr√©parable, etc.)
                  </p>
                  <Button 
                    variant="destructive"
                    onClick={() => setShowRetraitModal(true)}
                    style={{marginTop: '1rem'}}
                  >
                    üö´ Retirer cet EPI
                  </Button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
      
      {/* MODAL INSPECTION */}
      {showInspectionModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowInspectionModal(false)}>
          <div className="modal-content large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>üìã Nouvelle Inspection - {getTypeName(selectedEPI.type_epi)} #{selectedEPI.numero_serie}</h2>
              <Button variant="ghost" onClick={() => setShowInspectionModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <div className="form-grid">
                <div>
                  <Label>Type d'inspection *</Label>
                  <select 
                    className="form-select"
                    value={typeInspection}
                    onChange={e => setTypeInspection(e.target.value)}
                  >
                    <option value="apres_utilisation">üîç Apr√®s utilisation</option>
                    <option value="routine_mensuelle">üìÖ Routine mensuelle</option>
                    <option value="avancee_annuelle">üî¨ Avanc√©e annuelle</option>
                  </select>
                </div>
                
                <div>
                  <Label>Date inspection *</Label>
                  <Input 
                    type="date"
                    value={inspectionForm.date_inspection}
                    onChange={e => setInspectionForm({...inspectionForm, date_inspection: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Inspecteur *</Label>
                  <Input 
                    value={inspectionForm.inspecteur_nom}
                    onChange={e => setInspectionForm({...inspectionForm, inspecteur_nom: e.target.value})}
                  />
                </div>
                
                {typeInspection === 'avancee_annuelle' && (
                  <>
                    <div>
                      <Label>ISP (Fournisseur)</Label>
                      <select 
                        className="form-select"
                        value={inspectionForm.isp_id}
                        onChange={e => {
                          const isp = isps.find(i => i.id === e.target.value);
                          setInspectionForm({
                            ...inspectionForm,
                            isp_id: e.target.value,
                            isp_nom: isp?.nom || '',
                            isp_accreditations: isp?.accreditations || ''
                          });
                        }}
                      >
                        <option value="">Interne</option>
                        {isps.map(isp => (
                          <option key={isp.id} value={isp.id}>{isp.nom}</option>
                        ))}
                      </select>
                    </div>
                  </>
                )}
                
                <div>
                  <Label>Statut global *</Label>
                  <select 
                    className="form-select"
                    value={inspectionForm.statut_global}
                    onChange={e => setInspectionForm({...inspectionForm, statut_global: e.target.value})}
                  >
                    <option value="conforme">‚úÖ Conforme</option>
                    <option value="non_conforme">‚ùå Non conforme</option>
                    <option value="necessite_reparation">üîß N√©cessite r√©paration</option>
                    <option value="hors_service">üö´ Hors service</option>
                  </select>
                </div>
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Commentaires</Label>
                <textarea 
                  className="form-textarea"
                  rows="4"
                  value={inspectionForm.commentaires}
                  onChange={e => setInspectionForm({...inspectionForm, commentaires: e.target.value})}
                  placeholder="Observations, d√©tails des points v√©rifi√©s..."
                />
              </div>
              
              <div style={{marginTop: '1rem', padding: '1rem', background: '#f0f9ff', borderRadius: '8px'}}>
                <p style={{fontSize: '0.875rem', color: '#1e40af'}}>
                  üí° <strong>Checklist NFPA 1851</strong> sera automatiquement g√©n√©r√©e selon le type d'inspection s√©lectionn√©.
                </p>
              </div>
            </div>
            
            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowInspectionModal(false)}>Annuler</Button>
              <Button onClick={handleSaveInspection}>Enregistrer l'inspection</Button>
            </div>
          </div>
        </div>
      )}
      
      {/* MODAL ISP */}
      {showISPModal && (
        <div className="modal-overlay" onClick={() => setShowISPModal(false)}>
          <div className="modal-content medium-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>{selectedISP ? 'Modifier Fournisseur' : 'Nouveau Fournisseur'}</h2>
              <Button variant="ghost" onClick={() => setShowISPModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <div className="form-grid">
                <div>
                  <Label>Nom *</Label>
                  <Input 
                    value={ispForm.nom}
                    onChange={e => setIspForm({...ispForm, nom: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Contact</Label>
                  <Input 
                    value={ispForm.contact}
                    onChange={e => setIspForm({...ispForm, contact: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>T√©l√©phone</Label>
                  <Input 
                    value={ispForm.telephone}
                    onChange={e => setIspForm({...ispForm, telephone: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Email</Label>
                  <Input 
                    type="email"
                    value={ispForm.email}
                    onChange={e => setIspForm({...ispForm, email: e.target.value})}
                  />
                </div>
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Accr√©ditations</Label>
                <Input 
                  value={ispForm.accreditations}
                  onChange={e => setIspForm({...ispForm, accreditations: e.target.value})}
                  placeholder="Ex: NFPA 1851, ISO 9001..."
                />
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Notes</Label>
                <textarea 
                  className="form-textarea"
                  rows="3"
                  value={ispForm.notes}
                  onChange={e => setIspForm({...ispForm, notes: e.target.value})}
                />
              </div>
            </div>
            
            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowISPModal(false)}>Annuler</Button>
              <Button onClick={handleSaveISP}>
                {selectedISP ? 'Modifier' : 'Cr√©er'}
              </Button>
            </div>
          </div>
        </div>
      )}

      
      {/* MODAL NETTOYAGE - Phase 2 */}
      {showNettoyageModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowNettoyageModal(false)}>
          <div className="modal-content large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>üßº Nouveau Nettoyage - {getTypeName(selectedEPI.type_epi)} #{selectedEPI.numero_serie}</h2>
              <Button variant="ghost" onClick={() => setShowNettoyageModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <div className="form-grid">
                <div>
                  <Label>Type de nettoyage *</Label>
                  <select 
                    className="form-select"
                    value={nettoyageForm.type_nettoyage}
                    onChange={e => setNettoyageForm({...nettoyageForm, type_nettoyage: e.target.value})}
                  >
                    <option value="routine">üßΩ Routine (apr√®s utilisation)</option>
                    <option value="avance">üßº Avanc√© (2x par an minimum)</option>
                  </select>
                </div>
                
                <div>
                  <Label>Date nettoyage *</Label>
                  <Input 
                    type="date"
                    value={nettoyageForm.date_nettoyage}
                    onChange={e => setNettoyageForm({...nettoyageForm, date_nettoyage: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>M√©thode *</Label>
                  <select 
                    className="form-select"
                    value={nettoyageForm.methode}
                    onChange={e => setNettoyageForm({...nettoyageForm, methode: e.target.value})}
                  >
                    <option value="laveuse_extractrice">üåÄ Laveuse extractrice</option>
                    <option value="manuel">‚úã Manuel</option>
                    <option value="externe">üè¢ Externe (ISP)</option>
                  </select>
                </div>
                
                <div>
                  <Label>Effectu√© par</Label>
                  <Input 
                    value={nettoyageForm.effectue_par || `${user?.prenom || ''} ${user?.nom || ''}`}
                    onChange={e => setNettoyageForm({...nettoyageForm, effectue_par: e.target.value})}
                  />
                </div>
                
                {nettoyageForm.methode === 'externe' && (
                  <div>
                    <Label>Fournisseur ISP</Label>
                    <select 
                      className="form-select"
                      value={nettoyageForm.isp_id}
                      onChange={e => setNettoyageForm({...nettoyageForm, isp_id: e.target.value})}
                    >
                      <option value="">S√©lectionner...</option>
                      {isps.map(isp => (
                        <option key={isp.id} value={isp.id}>{isp.nom}</option>
                      ))}
                    </select>
                  </div>
                )}
                
                <div>
                  <Label>Nombre de cycles</Label>
                  <Input 
                    type="number"
                    value={nettoyageForm.nombre_cycles}
                    onChange={e => setNettoyageForm({...nettoyageForm, nombre_cycles: parseInt(e.target.value) || 1})}
                  />
                </div>
                
                <div>
                  <Label>Temp√©rature</Label>
                  <Input 
                    value={nettoyageForm.temperature}
                    onChange={e => setNettoyageForm({...nettoyageForm, temperature: e.target.value})}
                    placeholder="Ex: Eau ti√®de max 40¬∞C"
                  />
                </div>
                
                <div>
                  <Label>Produits utilis√©s</Label>
                  <Input 
                    value={nettoyageForm.produits_utilises}
                    onChange={e => setNettoyageForm({...nettoyageForm, produits_utilises: e.target.value})}
                  />
                </div>
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Notes</Label>
                <textarea 
                  className="form-textarea"
                  rows="3"
                  value={nettoyageForm.notes}
                  onChange={e => setNettoyageForm({...nettoyageForm, notes: e.target.value})}
                />
              </div>
            </div>
            
            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowNettoyageModal(false)}>Annuler</Button>
              <Button onClick={handleSaveNettoyage}>Enregistrer</Button>
            </div>
          </div>
        </div>
      )}
      
      {/* MODAL R√âPARATION - Phase 2 */}
      {showReparationModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowReparationModal(false)}>
          <div className="modal-content large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>üîß {selectedReparation ? 'Mise √† jour R√©paration' : 'Nouvelle R√©paration'} - {getTypeName(selectedEPI.type_epi)} #{selectedEPI.numero_serie}</h2>
              <Button variant="ghost" onClick={() => setShowReparationModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <div className="form-grid">
                <div>
                  <Label>Statut *</Label>
                  <select 
                    className="form-select"
                    value={reparationForm.statut}
                    onChange={e => setReparationForm({...reparationForm, statut: e.target.value})}
                  >
                    <option value="demandee">üìù Demand√©e</option>
                    <option value="en_cours">‚öôÔ∏è En cours</option>
                    <option value="terminee">‚úÖ Termin√©e</option>
                    <option value="impossible">‚ùå Impossible</option>
                  </select>
                </div>
                
                <div>
                  <Label>Date demande *</Label>
                  <Input 
                    type="date"
                    value={reparationForm.date_demande}
                    onChange={e => setReparationForm({...reparationForm, date_demande: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Type de r√©parateur *</Label>
                  <select 
                    className="form-select"
                    value={reparationForm.reparateur_type}
                    onChange={e => setReparationForm({...reparationForm, reparateur_type: e.target.value})}
                  >
                    <option value="interne">üè† Interne</option>
                    <option value="externe">üè¢ Externe (ISP)</option>
                  </select>
                </div>
                
                {reparationForm.reparateur_type === 'externe' && (
                  <div>
                    <Label>Fournisseur ISP</Label>
                    <select 
                      className="form-select"
                      value={reparationForm.isp_id}
                      onChange={e => {
                        const isp = isps.find(i => i.id === e.target.value);
                        setReparationForm({
                          ...reparationForm,
                          isp_id: e.target.value,
                          reparateur_nom: isp?.nom || ''
                        });
                      }}
                    >
                      <option value="">S√©lectionner...</option>
                      {isps.map(isp => (
                        <option key={isp.id} value={isp.id}>{isp.nom}</option>
                      ))}
                    </select>
                  </div>
                )}
                
                {reparationForm.reparateur_type === 'interne' && (
                  <div>
                    <Label>Nom du r√©parateur</Label>
                    <Input 
                      value={reparationForm.reparateur_nom}
                      onChange={e => setReparationForm({...reparationForm, reparateur_nom: e.target.value})}
                    />
                  </div>
                )}
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Description du probl√®me *</Label>
                <textarea 
                  className="form-textarea"
                  rows="3"
                  value={reparationForm.probleme_description}
                  onChange={e => setReparationForm({...reparationForm, probleme_description: e.target.value})}
                  placeholder="D√©crivez le probl√®me n√©cessitant r√©paration..."
                />
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Notes</Label>
                <textarea 
                  className="form-textarea"
                  rows="2"
                  value={reparationForm.notes}
                  onChange={e => setReparationForm({...reparationForm, notes: e.target.value})}
                />
              </div>
            </div>
            
            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowReparationModal(false)}>Annuler</Button>
              <Button onClick={handleSaveReparation}>
                {selectedReparation ? 'Mettre √† jour' : 'Cr√©er'}
              </Button>
            </div>
          </div>
        </div>
      )}
      
      {/* MODAL RETRAIT - Phase 2 */}
      {showRetraitModal && selectedEPI && (
        <div className="modal-overlay" onClick={() => setShowRetraitModal(false)}>
          <div className="modal-content large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header" style={{background: '#DC2626', color: 'white'}}>
              <h2>üö´ Retrait D√©finitif EPI - {getTypeName(selectedEPI.type_epi)} #{selectedEPI.numero_serie}</h2>
              <Button variant="ghost" onClick={() => setShowRetraitModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <div className="alert-warning" style={{marginBottom: '1.5rem', padding: '1rem', background: '#FEF3C7', borderRadius: '8px'}}>
                <p style={{margin: 0, color: '#92400E'}}>
                  ‚ö†Ô∏è <strong>ATTENTION:</strong> Cette action est d√©finitive. L'EPI sera marqu√© comme retir√© et ne pourra plus √™tre utilis√©.
                </p>
              </div>
              
              <div className="form-grid">
                <div>
                  <Label>Date de retrait *</Label>
                  <Input 
                    type="date"
                    value={retraitForm.date_retrait}
                    onChange={e => setRetraitForm({...retraitForm, date_retrait: e.target.value})}
                  />
                </div>
                
                <div>
                  <Label>Raison du retrait *</Label>
                  <select 
                    className="form-select"
                    value={retraitForm.raison}
                    onChange={e => setRetraitForm({...retraitForm, raison: e.target.value})}
                  >
                    <option value="age_limite">‚è∞ √Çge limite atteinte (10 ans)</option>
                    <option value="dommage_irreparable">üíî Dommage irr√©parable</option>
                    <option value="echec_inspection">‚ùå √âchec inspection avanc√©e</option>
                    <option value="autre">üìù Autre raison</option>
                  </select>
                </div>
                
                <div>
                  <Label>M√©thode de disposition *</Label>
                  <select 
                    className="form-select"
                    value={retraitForm.methode_disposition}
                    onChange={e => setRetraitForm({...retraitForm, methode_disposition: e.target.value})}
                  >
                    <option value="coupe_detruit">‚úÇÔ∏è Coup√©/D√©truit</option>
                    <option value="recyclage">‚ôªÔ∏è Recyclage</option>
                    <option value="don">üéÅ Don</option>
                    <option value="autre">üìù Autre</option>
                  </select>
                </div>
                
                <div>
                  <Label>Co√ªt de disposition</Label>
                  <Input 
                    type="number"
                    value={retraitForm.cout_disposition}
                    onChange={e => setRetraitForm({...retraitForm, cout_disposition: parseFloat(e.target.value) || 0})}
                  />
                </div>
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Description d√©taill√©e *</Label>
                <textarea 
                  className="form-textarea"
                  rows="4"
                  value={retraitForm.description_raison}
                  onChange={e => setRetraitForm({...retraitForm, description_raison: e.target.value})}
                  placeholder="Expliquez en d√©tail pourquoi cet EPI doit √™tre retir√©..."
                />
              </div>
              
              <div style={{marginTop: '1rem'}}>
                <Label>Notes compl√©mentaires</Label>
                <textarea 
                  className="form-textarea"
                  rows="2"
                  value={retraitForm.notes}
                  onChange={e => setRetraitForm({...retraitForm, notes: e.target.value})}
                />
              </div>
              
              <div style={{marginTop: '1rem', padding: '1rem', background: '#FEE2E2', borderRadius: '8px'}}>
                <p style={{margin: 0, fontSize: '0.875rem', color: '#991B1B'}}>
                  üì∏ <strong>Preuve de disposition:</strong> Apr√®s validation, prenez des photos de l'EPI coup√©/d√©truit comme preuve de mise au rebut selon NFPA 1851.
                </p>
              </div>
            </div>
            
            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowRetraitModal(false)}>Annuler</Button>
              <Button variant="destructive" onClick={handleSaveRetrait}>
                üö´ Confirmer le retrait
              </Button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

const Dashboard = () => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  
  const [loading, setLoading] = useState(true);
  const [dashboardData, setDashboardData] = useState(null);
  const [messages, setMessages] = useState([]);
  const [showMessageModal, setShowMessageModal] = useState(false);
  const [showActivitesEtendues, setShowActivitesEtendues] = useState(false);
  const [messageForm, setMessageForm] = useState({
    titre: '',
    contenu: '',
    priorite: 'info',
    date_expiration: ''
  });

  useEffect(() => {
    if (tenantSlug) {
      loadDashboardData();
      loadMessages();
    }
  }, [tenantSlug]);

  const loadDashboardData = async () => {
    setLoading(true);
    try {
      const data = await apiGet(tenantSlug, '/dashboard/donnees-completes');
      setDashboardData(data);
    } catch (error) {
      console.error('Erreur chargement dashboard:', error);
      toast({ title: "Erreur", description: "Impossible de charger les donn√©es", variant: "destructive" });
    }
    setLoading(false);
  };

  const loadMessages = async () => {
    try {
      const messagesData = await apiGet(tenantSlug, '/dashboard/messages');
      setMessages(messagesData);
    } catch (error) {
      console.error('Erreur chargement messages:', error);
    }
  };

  const handleCreateMessage = async () => {
    try {
      await apiPost(tenantSlug, '/dashboard/messages', messageForm);
      toast({ title: "Succ√®s", description: "Message publi√©" });
      setShowMessageModal(false);
      setMessageForm({ titre: '', contenu: '', priorite: 'info', date_expiration: '' });
      loadMessages();
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible de publier le message", variant: "destructive" });
    }
  };

  const handleDeleteMessage = async (messageId) => {
    try {
      await apiDelete(tenantSlug, `/dashboard/messages/${messageId}`);
      toast({ title: "Succ√®s", description: "Message supprim√©" });
      loadMessages();
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible de supprimer le message", variant: "destructive" });
    }
  };

  if (loading) return <div className="loading">Chargement du dashboard...</div>;
  if (!dashboardData) return <div className="error">Erreur de chargement des donn√©es</div>;

  const { section_personnelle, section_generale, activites_recentes } = dashboardData;

  return (
    <div className="dashboard-refonte">
      <div className="module-header">
        <div>
          <h1>üìä Tableau de Bord</h1>
          <p>Vue d'ensemble de votre activit√© et du service</p>
        </div>
      </div>

      {/* MESSAGES IMPORTANTS */}
      {messages.length > 0 && (
        <div className="messages-importants-section">
          {messages.map(msg => (
            <div key={msg.id} className={`message-banner priorite-${msg.priorite}`}>
              <div className="message-icon">
                {msg.priorite === 'urgent' && 'üö®'}
                {msg.priorite === 'important' && '‚ö†Ô∏è'}
                {msg.priorite === 'info' && '‚ÑπÔ∏è'}
              </div>
              <div className="message-content">
                <h4>{msg.titre}</h4>
                <p>{msg.contenu}</p>
                <small>Par {msg.auteur_nom} ‚Ä¢ {new Date(msg.created_at).toLocaleDateString('fr-FR')}</small>
              </div>
              {user?.role !== 'employe' && (
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={() => handleDeleteMessage(msg.id)}
                  style={{marginLeft: 'auto'}}
                >
                  ‚úï
                </Button>
              )}
            </div>
          ))}
        </div>
      )}

      {/* BOUTON CR√âER MESSAGE (Admin/Superviseur) */}
      {user?.role !== 'employe' && (
        <div style={{marginBottom: '2rem'}}>
          <Button onClick={() => setShowMessageModal(true)}>
            ‚ûï Publier un message important
          </Button>
        </div>
      )}

      {/* SECTION PERSONNELLE */}
      <div className="dashboard-section">
        <h2>üë§ Ma Section Personnelle</h2>
        <div className="kpi-grid">
          {!section_personnelle.has_garde_externe ? (
            // Affichage simple si pas de garde externe
            <div className="kpi-card" style={{background: '#FEF3C7'}}>
              <h3>{section_personnelle.heures_travaillees_mois}h</h3>
              <p>Heures travaill√©es ce mois</p>
            </div>
          ) : (
            // Affichage s√©par√© si garde externe existe
            <>
              <div className="kpi-card" style={{background: '#FEF3C7'}}>
                <h3>{section_personnelle.heures_internes_mois}h</h3>
                <p>üè¢ Heures Internes</p>
              </div>
              <div className="kpi-card" style={{background: '#E0E7FF'}}>
                <h3>{section_personnelle.heures_externes_mois}h</h3>
                <p>üè† Heures Externes</p>
              </div>
            </>
          )}
          <div className="kpi-card" style={{background: '#FCA5A5'}}>
            <h3>{section_personnelle.nombre_gardes_mois}</h3>
            <p>Nombre de gardes</p>
          </div>
          <div className="kpi-card" style={{background: '#D1FAE5'}}>
            <h3>{section_personnelle.pourcentage_presence_formations}%</h3>
            <p>Pr√©sence formations</p>
          </div>
          <div className="kpi-card" style={{background: '#DBEAFE'}}>
            <h3>{section_personnelle.formations_a_venir.length}</h3>
            <p>Formations √† venir</p>
          </div>
        </div>

        {/* Formations √† venir */}
        {section_personnelle.formations_a_venir.length > 0 && (
          <div className="formations-a-venir">
            <h3>üéì Formations √† Venir</h3>
            <div className="formations-list-compact">
              {section_personnelle.formations_a_venir.map(formation => (
                <div key={formation.id} className="formation-item-compact">
                  <div className="formation-info">
                    <h4>{formation.nom}</h4>
                    <p>{(() => {
                      // Parser les dates comme locales sans conversion timezone
                      const [y1, m1, d1] = formation.date_debut.split('-');
                      const date1 = new Date(y1, m1 - 1, d1);
                      const [y2, m2, d2] = formation.date_fin.split('-');
                      const date2 = new Date(y2, m2 - 1, d2);
                      return `${date1.toLocaleDateString('fr-FR')} - ${date2.toLocaleDateString('fr-FR')}`;
                    })()}</p>
                  </div>
                  {formation.est_inscrit ? (
                    <span className="badge-inscrit">‚úì Inscrit</span>
                  ) : (
                    <span className="badge-non-inscrit">Non inscrit</span>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* SECTION G√âN√âRALE (Admin/Superviseur uniquement) */}
      {section_generale && (
        <>
          <div className="dashboard-section">
            <h2>üè¢ Vue G√©n√©rale du Service</h2>
            <div className="kpi-grid">
              <div className="kpi-card" style={{background: '#E0E7FF'}}>
                <h3>{section_generale.couverture_planning}%</h3>
                <p>Couverture planning</p>
              </div>
              <div className="kpi-card" style={{background: (section_generale.postes_a_pourvoir || section_generale.gardes_manquantes || 0) > 0 ? '#FEE2E2' : '#D1FAE5'}}>
                <h3>{section_generale.postes_a_pourvoir || section_generale.gardes_manquantes || 0}</h3>
                <p>Postes √† pourvoir ce mois</p>
              </div>
              <div className="kpi-card" style={{background: '#FED7AA'}}>
                <h3>{section_generale.demandes_conges_en_attente}</h3>
                <p>Demandes √† approuver</p>
              </div>
              <div className="kpi-card" style={{background: '#E9D5FF'}}>
                <h3>{section_generale.statistiques_mois.total_assignations}</h3>
                <p>Assignations ce mois</p>
              </div>
            </div>

            {/* Statistiques mois */}
            <div className="stats-mois-grid">
              <div className="stat-item">
                <span className="stat-label">Personnel actif</span>
                <span className="stat-value">{section_generale.statistiques_mois.total_personnel_actif}</span>
              </div>
              <div className="stat-item">
                <span className="stat-label">Formations ce mois</span>
                <span className="stat-value">{section_generale.statistiques_mois.formations_ce_mois}</span>
              </div>
            </div>
          </div>

          {/* ACTIVIT√âS R√âCENTES */}
          <div className="dashboard-section">
            <h2>üìã Actualit√© R√©cente du Service</h2>
            <div className="activites-liste">
              {activites_recentes.slice(0, showActivitesEtendues ? activites_recentes.length : 10).map((activite, idx) => (
                <div key={idx} className="activite-item">
                  <div className="activite-icon">
                    {activite.type_activite === 'creation_personnel' && 'üë§'}
                    {activite.type_activite === 'assignation' && 'üìÖ'}
                    {activite.type_activite === 'formation' && 'üéì'}
                    {activite.type_activite === 'remplacement' && 'üîÑ'}
                    {!['creation_personnel', 'assignation', 'formation', 'remplacement'].includes(activite.type_activite) && 'üìå'}
                  </div>
                  <div className="activite-content">
                    <p>{activite.description}</p>
                    <small>{new Date(activite.created_at).toLocaleString('fr-FR')}</small>
                  </div>
                </div>
              ))}
            </div>
            
            {activites_recentes.length > 10 && (
              <div style={{textAlign: 'center', marginTop: '1rem'}}>
                <Button 
                  variant="outline" 
                  onClick={() => setShowActivitesEtendues(!showActivitesEtendues)}
                >
                  {showActivitesEtendues ? '‚ñ≤ Voir moins' : '‚ñº Voir plus'}
                </Button>
              </div>
            )}
            
            {activites_recentes.length === 0 && (
              <div className="empty-state">
                <p>Aucune activit√© r√©cente</p>
              </div>
            )}
          </div>
        </>
      )}

      {/* Modal Cr√©er Message */}
      {showMessageModal && (
        <div className="modal-overlay" onClick={() => setShowMessageModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>üì¢ Publier un Message Important</h2>
              <Button variant="ghost" onClick={() => setShowMessageModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="form-grid">
                <div style={{gridColumn: 'span 2'}}>
                  <Label>Titre</Label>
                  <Input 
                    value={messageForm.titre} 
                    onChange={e => setMessageForm({...messageForm, titre: e.target.value})}
                    placeholder="Ex: Maintenance syst√®me pr√©vue"
                  />
                </div>
                <div style={{gridColumn: 'span 2'}}>
                  <Label>Contenu</Label>
                  <textarea
                    className="form-textarea"
                    value={messageForm.contenu}
                    onChange={e => setMessageForm({...messageForm, contenu: e.target.value})}
                    placeholder="D√©tails du message..."
                    rows={4}
                  />
                </div>
                <div>
                  <Label>Priorit√©</Label>
                  <select 
                    className="form-select" 
                    value={messageForm.priorite} 
                    onChange={e => setMessageForm({...messageForm, priorite: e.target.value})}
                  >
                    <option value="info">Information</option>
                    <option value="important">Important</option>
                    <option value="urgent">Urgent</option>
                  </select>
                </div>
                <div>
                  <Label>Date d'expiration (optionnel)</Label>
                  <Input 
                    type="date"
                    value={messageForm.date_expiration} 
                    onChange={e => setMessageForm({...messageForm, date_expiration: e.target.value})}
                  />
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <Button variant="outline" onClick={() => setShowMessageModal(false)}>Annuler</Button>
              <Button onClick={handleCreateMessage}>Publier</Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Personnel Component complet
const Personnel = ({ setCurrentPage, setManagingUserDisponibilites }) => {
  const { user } = useAuth();
  const [users, setUsers] = useState([]);
  const [formations, setFormations] = useState([]);
  const [grades, setGrades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showViewModal, setShowViewModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showManageDisponibilitesModal, setShowManageDisponibilitesModal] = useState(false);
  const [showEPIModal, setShowEPIModal] = useState(false);
  const [showAddEPIModal, setShowAddEPIModal] = useState(false);
  const [showEPIAccordion, setShowEPIAccordion] = useState(false);
  const [selectedUser, setSelectedUser] = useState(null);
  const [userDisponibilites, setUserDisponibilites] = useState([]);
  const [userEPIs, setUserEPIs] = useState([]);
  const [userValidations, setUserValidations] = useState([]);
  const [showValidateCompetenceModal, setShowValidateCompetenceModal] = useState(false);
  const [competences, setCompetences] = useState([]);
  const [newValidation, setNewValidation] = useState({
    competence_id: '',
    justification: '',
    date_validation: new Date().toISOString().split('T')[0]
  });
  
  // Nouveaux √©tats pour la refonte
  const [searchTerm, setSearchTerm] = useState('');
  const [viewMode, setViewMode] = useState('list'); // 'list' ou 'cards'
  const [showExportModal, setShowExportModal] = useState(false);
  const [exportType, setExportType] = useState(''); // 'pdf' ou 'excel'
  const [exportScope, setExportScope] = useState('all'); // 'all' ou 'individual'
  const [selectedPersonForExport, setSelectedPersonForExport] = useState('');
  
  // √âtat pour la photo de profil
  const [photoUploading, setPhotoUploading] = useState(false);
  const photoInputRef = React.useRef(null);
  
  const [newDisponibilite, setNewDisponibilite] = useState({
    date: new Date().toISOString().split('T')[0],
    heure_debut: '08:00',
    heure_fin: '17:00',
    statut: 'disponible',
    recurrence: false,
    type_recurrence: 'hebdomadaire',
    jours_semaine: [],
    bi_hebdomadaire: false,
    date_fin: ''
  });
  const [editingEPIId, setEditingEPIId] = useState(null);
  const [newEPI, setNewEPI] = useState({
    type_epi: '',
    taille: '',
    date_attribution: new Date().toISOString().split('T')[0],
    etat: 'Neuf',
    date_expiration: '',
    date_prochaine_inspection: '',
    notes: ''
  });
  const [newUser, setNewUser] = useState({
    nom: '',
    prenom: '',
    email: '',
    telephone: '',
    adresse: '',
    contact_urgence: '',
    grade: '',
    fonction_superieur: false,
    type_emploi: '',
    numero_employe: '',
    date_embauche: '',
    taux_horaire: 0,
    formations: [],
    accepte_gardes_externes: true, // True par d√©faut
    mot_de_passe: '',
    // Tailles EPI (optionnelles)
    taille_casque: '',
    taille_bottes: '',
    taille_veste_bunker: '',
    taille_pantalon_bunker: '',
    taille_gants: '',
    taille_masque_apria: '',
    taille_cagoule: ''
  });
  const { toast } = useToast();
  const { tenantSlug } = useTenant();

  useEffect(() => {
    const fetchData = async () => {
      if (!tenantSlug) return;
      
      try {
        const [usersData, competencesData, gradesData] = await Promise.all([
          apiGet(tenantSlug, '/users'),
          apiGet(tenantSlug, '/competences'),
          apiGet(tenantSlug, '/grades')
        ]);
        setUsers(usersData);
        setFormations(competencesData);
        setCompetences(competencesData);
        setGrades(gradesData);
      } catch (error) {
        console.error('Erreur lors du chargement des donn√©es:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [tenantSlug]);

  const handleCreateUser = async () => {
    if (!newUser.nom || !newUser.prenom || !newUser.email) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir Nom, Pr√©nom et Email",
        variant: "destructive"
      });
      return;
    }

    try {
      const userToCreate = {
        ...newUser,
        grade: newUser.grade || 'Pompier',
        type_emploi: newUser.type_emploi || 'temps_plein',
        role: 'employe',
        numero_employe: newUser.numero_employe || `POM${String(Date.now()).slice(-3)}`,
        date_embauche: newUser.date_embauche || new Date().toISOString().split('T')[0],
        mot_de_passe: 'TempPassword123!'
      };

      await apiPost(tenantSlug, '/users', userToCreate);
      toast({
        title: "Pompier cr√©√©",
        description: "Le nouveau pompier a √©t√© ajout√© avec succ√®s",
        variant: "success"
      });
      
      setShowCreateModal(false);
      resetNewUser();
      
      const usersData = await apiGet(tenantSlug, '/users');
      setUsers(usersData);
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.detail || error.message || "Impossible de cr√©er le pompier",
        variant: "destructive"
      });
    }
  };

  const resetNewUser = () => {
    setNewUser({
      nom: '',
      prenom: '',
      email: '',
      telephone: '',
      adresse: '',
      contact_urgence: '',
      grade: '',
      fonction_superieur: false,
      type_emploi: '',
      numero_employe: '',
      date_embauche: new Date().toISOString().split('T')[0],
      taux_horaire: 0,
      formations: [],
      mot_de_passe: ''
    });
  };

  const handleViewUser = async (user) => {
    setSelectedUser(user);
    // Charger les EPI et validations de l'utilisateur
    try {
      const [episData, validationsData] = await Promise.all([
        apiGet(tenantSlug, `/epi/employe/${user.id}`),
        apiGet(tenantSlug, `/validations-competences/${user.id}`)
      ]);
      setUserEPIs(episData || []);
      setUserValidations(validationsData || []);
      // Ouvrir le modal APR√àS avoir mis √† jour les states
      setShowViewModal(true);
    } catch (error) {
      console.error('‚ùå Erreur lors du chargement des EPIs:', error);
      setUserEPIs([]);
      setUserValidations([]);
      setShowViewModal(true);
    }
  };

  const handleValidateCompetence = async () => {
    if (!newValidation.competence_id || !newValidation.justification) {
      toast({
        title: "Champs requis",
        description: "Veuillez s√©lectionner une comp√©tence et fournir une justification",
        variant: "destructive"
      });
      return;
    }

    try {
      const validation = {
        user_id: selectedUser.id,
        competence_id: newValidation.competence_id,
        justification: newValidation.justification,
        date_validation: newValidation.date_validation
      };

      await apiPost(tenantSlug, '/validations-competences', validation);

      toast({
        title: "Succ√®s",
        description: "Comp√©tence valid√©e avec succ√®s",
        variant: "success"
      });

      // Recharger les validations
      const validationsData = await apiGet(tenantSlug, `/validations-competences/${selectedUser.id}`);
      setUserValidations(validationsData || []);

      // R√©initialiser le formulaire
      setNewValidation({
        competence_id: '',
        justification: '',
        date_validation: new Date().toISOString().split('T')[0]
      });
      setShowValidateCompetenceModal(false);
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.detail || error.message || "Impossible de valider la comp√©tence",
        variant: "destructive"
      });
    }
  };

  const handleDeleteValidation = async (validationId) => {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette validation ?')) {
      return;
    }

    try {
      await apiDelete(tenantSlug, `/validations-competences/${validationId}`);

      toast({
        title: "Succ√®s",
        description: "Validation supprim√©e",
        variant: "success"
      });

      // Recharger les validations
      const validationsData = await apiGet(tenantSlug, `/validations-competences/${selectedUser.id}`);
      setUserValidations(validationsData || []);
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer la validation",
        variant: "destructive"
      });
    }
  };

  // Gestion de la photo de profil (Admin)
  const handlePhotoSelectAdmin = async (event) => {
    const file = event.target.files?.[0];
    if (!file || !selectedUser) return;

    // V√©rifier le type de fichier
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      toast({
        title: "Format non support√©",
        description: "Veuillez choisir une image JPG, PNG ou WEBP",
        variant: "destructive"
      });
      return;
    }

    setPhotoUploading(true);

    try {
      // Fonction pour compresser l'image c√¥t√© client
      const compressImage = (file, maxWidth = 400, quality = 0.8) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              canvas.width = width;
              canvas.height = height;
              
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
              resolve(compressedBase64);
            };
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      // Compresser si > 500KB
      let base64;
      if (file.size > 500 * 1024) {
        toast({
          title: "Compression en cours...",
          description: "L'image est optimis√©e automatiquement",
        });
        base64 = await compressImage(file, 400, 0.85);
      } else {
        base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
      
      const response = await apiPost(tenantSlug, `/users/${selectedUser.id}/photo-profil`, {
        photo_base64: base64
      });
      
      // Mettre √† jour l'utilisateur s√©lectionn√© et la liste
      setSelectedUser(prev => ({...prev, photo_profil: response.photo_profil}));
      setUsers(prev => prev.map(u => 
        u.id === selectedUser.id ? {...u, photo_profil: response.photo_profil} : u
      ));
      
      toast({
        title: "Photo mise √† jour",
        description: `Photo de ${selectedUser.prenom} enregistr√©e`,
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.message || "Impossible de sauvegarder la photo",
        variant: "destructive"
      });
    } finally {
      setPhotoUploading(false);
    }
    
    event.target.value = '';
  };

  const handleDeletePhotoAdmin = async () => {
    if (!selectedUser) return;
    
    if (!window.confirm(`√ätes-vous s√ªr de vouloir supprimer la photo de ${selectedUser.prenom} ?`)) {
      return;
    }

    try {
      await apiDelete(tenantSlug, `/users/${selectedUser.id}/photo-profil`);
      setSelectedUser(prev => ({...prev, photo_profil: null}));
      setUsers(prev => prev.map(u => 
        u.id === selectedUser.id ? {...u, photo_profil: null} : u
      ));
      toast({
        title: "Photo supprim√©e",
        description: `Photo de ${selectedUser.prenom} supprim√©e`,
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer la photo",
        variant: "destructive"
      });
    }
  };

  const handleEditUser = async (user) => {
    // Charger les EPIs de l'utilisateur AVANT d'ouvrir le modal
    try {
      console.log('üîç [Edit Modal] Chargement EPIs pour utilisateur:', user.id);
      const episData = await apiGet(tenantSlug, `/epi/employe/${user.id}`);
      console.log('‚úÖ [Edit Modal] EPIs charg√©s:', episData);
      
      // Cr√©er un objet user avec les EPIs attach√©s
      const userWithEPIs = {
        ...user,
        _epis: episData || []
      };
      
      setSelectedUser(userWithEPIs);
      setUserEPIs(episData || []); // Garder aussi dans userEPIs pour le formulaire
      
    } catch (error) {
      console.error('‚ùå [Edit Modal] Erreur lors du chargement des EPIs:', error);
      setSelectedUser({...user, _epis: []});
      setUserEPIs([]);
    }
    
    setNewUser({
      nom: user.nom,
      prenom: user.prenom,
      email: user.email,
      telephone: user.telephone,
      adresse: user.adresse || '',
      contact_urgence: user.contact_urgence || '',
      grade: user.grade,
      fonction_superieur: user.fonction_superieur || false,
      type_emploi: user.type_emploi,
      numero_employe: user.numero_employe,
      date_embauche: user.date_embauche,
      taux_horaire: user.taux_horaire || 0,
      heures_max_semaine: user.heures_max_semaine || 40,
      formations: user.formations || [],
      accepte_gardes_externes: user.accepte_gardes_externes !== false,
      mot_de_passe: ''
    });
    
    setShowEditModal(true);
  };

  const handleUpdateUser = async () => {
    if (!newUser.nom || !newUser.prenom || !newUser.email || !newUser.grade || !newUser.type_emploi) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir tous les champs obligatoires",
        variant: "destructive"
      });
      return;
    }

    try {
      const userToUpdate = {
        ...newUser,
        heures_max_semaine: newUser.heures_max_semaine !== null && newUser.heures_max_semaine !== undefined 
          ? parseInt(newUser.heures_max_semaine) 
          : 40,
        role: selectedUser.role, // Pr√©server le r√¥le existant
        statut: selectedUser.statut, // Pr√©server le statut existant
        mot_de_passe: newUser.mot_de_passe || 'unchanged' // Mot de passe optionnel
      };

      await apiPut(tenantSlug, `/users/${selectedUser.id}`, userToUpdate);
      toast({
        title: "Pompier mis √† jour",
        description: "Les informations ont √©t√© mises √† jour avec succ√®s",
        variant: "success"
      });
      setShowEditModal(false);
      
      // Reload users list
      const usersData = await apiGet(tenantSlug, '/users');
      setUsers(usersData);
    } catch (error) {
      console.error('Error updating user:', error);
      toast({
        title: "Erreur de modification",
        description: error.detail || error.message || "Impossible de mettre √† jour le pompier",
        variant: "destructive"
      });
    }
  };

  const handleDeleteUser = async (userId) => {
    if (!window.confirm("√ätes-vous s√ªr de vouloir supprimer ce pompier ?")) return;

    try {
      await apiDelete(tenantSlug, `/users/${userId}`);
      toast({
        title: "Pompier supprim√©",
        description: "Le pompier a √©t√© supprim√© avec succ√®s",
        variant: "success"
      });
      const usersData = await apiGet(tenantSlug, '/users');
      setUsers(usersData);
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer le pompier",
        variant: "destructive"
      });
    }
  };

  // Ouvrir le modal d'export
  const handleOpenExportModal = (type) => {
    setExportType(type);
    setExportScope('all'); // Par d√©faut, tout le personnel
    setSelectedPersonForExport('');
    setShowExportModal(true);
  };

  // Confirmer l'export apr√®s s√©lection dans le modal
  const handleConfirmExport = async () => {
    const userId = exportScope === 'individual' ? selectedPersonForExport : null;
    
    if (exportScope === 'individual' && !selectedPersonForExport) {
      toast({
        title: "S√©lection requise",
        description: "Veuillez s√©lectionner une personne √† exporter",
        variant: "destructive"
      });
      return;
    }
    
    try {
      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
      const token = localStorage.getItem(`${tenantSlug}_token`);
      
      const endpoint = exportType === 'pdf' ? 'export-pdf' : 'export-excel';
      const url = userId 
        ? `${backendUrl}/api/${tenantSlug}/personnel/${endpoint}?user_id=${userId}`
        : `${backendUrl}/api/${tenantSlug}/personnel/${endpoint}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur lors de l\'export');
      
      const blob = await response.blob();
      
      if (exportType === 'pdf') {
        // Pour les PDF, ouvrir directement le dialogue d'impression
        const pdfUrl = window.URL.createObjectURL(blob);
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = pdfUrl;
        document.body.appendChild(iframe);
        
        iframe.onload = function() {
          iframe.contentWindow.print();
          setTimeout(() => {
            document.body.removeChild(iframe);
            window.URL.revokeObjectURL(pdfUrl);
          }, 100);
        };
      } else {
        // Pour les Excel, t√©l√©charger directement
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        
        if (userId) {
          const selectedUser = users.find(u => u.id === userId);
          link.download = `fiche_${selectedUser?.prenom}_${selectedUser?.nom}.xlsx`;
        } else {
          link.download = `liste_personnel.xlsx`;
        }
        
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(downloadUrl);
      }
      
      toast({ 
        title: "Succ√®s", 
        description: `Export ${exportType.toUpperCase()} t√©l√©charg√©`,
        variant: "success"
      });
      
      setShowExportModal(false);
    } catch (error) {
      toast({ 
        title: "Erreur", 
        description: `Impossible d'exporter le ${exportType.toUpperCase()}`, 
        variant: "destructive" 
      });
    }
  };

  // Confirmer l'export apr√®s s√©lection dans le modal
  const getFilteredUsers = () => {
    if (!searchTerm) return users;
    return users.filter(user => 
      `${user.prenom} ${user.nom}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
      user.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      user.grade?.toLowerCase().includes(searchTerm.toLowerCase())
    );
  };

  const handleManageDisponibilites = async (user) => {
    if (user.type_emploi !== 'temps_partiel') {
      toast({
        title: "Information",
        description: "Les disponibilit√©s ne concernent que les employ√©s √† temps partiel",
        variant: "default"
      });
      return;
    }

    // Stocker l'utilisateur et naviguer vers le module disponibilit√©s
    setManagingUserDisponibilites(user);
    setCurrentPage('disponibilites');
  };

  const handleAddDisponibilite = async () => {
    if (!newDisponibilite.date || !newDisponibilite.heure_debut || !newDisponibilite.heure_fin) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir tous les champs",
        variant: "destructive"
      });
      return;
    }

    // Validation pour r√©currence
    if (newDisponibilite.recurrence) {
      if (!newDisponibilite.date_fin) {
        toast({
          title: "Date de fin requise",
          description: "Veuillez sp√©cifier une date de fin pour la r√©currence",
          variant: "destructive"
        });
        return;
      }
      if (newDisponibilite.type_recurrence === 'hebdomadaire' && newDisponibilite.jours_semaine.length === 0) {
        toast({
          title: "Jours requis",
          description: "Veuillez s√©lectionner au moins un jour de la semaine",
          variant: "destructive"
        });
        return;
      }
    }

    try {
      let disponibilitesToCreate = [];

      if (newDisponibilite.recurrence) {
        // G√©n√©rer toutes les occurrences avec origine "recurrence"
        disponibilitesToCreate = generateRecurringDisponibilites(newDisponibilite, selectedUser.id);
        // Marquer toutes comme r√©currence
        disponibilitesToCreate = disponibilitesToCreate.map(d => ({...d, origine: 'recurrence'}));
      } else {
        // Disponibilit√© unique avec origine "manuelle"
        disponibilitesToCreate = [{
          date: newDisponibilite.date,
          heure_debut: newDisponibilite.heure_debut,
          heure_fin: newDisponibilite.heure_fin,
          statut: newDisponibilite.statut,
          user_id: selectedUser.id,
          origine: 'manuelle'
        }];
      }

      // Cr√©er toutes les disponibilit√©s
      let successCount = 0;
      let conflictCount = 0;
      let errorCount = 0;
      
      for (const dispo of disponibilitesToCreate) {
        try {
          await apiPost(tenantSlug, '/disponibilites', dispo);
          successCount++;
        } catch (error) {
          // V√©rifier si c'est une erreur de conflit (409)
          if (error.response && error.response.status === 409) {
            conflictCount++;
            const conflictDetail = error.response.data;
            console.log(`Conflit d√©tect√© pour ${dispo.date}:`, conflictDetail);
            
            // Si c'est le premier conflit, afficher les d√©tails dans un modal
            if (conflictCount === 1 && conflictDetail.conflicts && conflictDetail.conflicts.length > 0) {
              // Afficher le modal avec les d√©tails du conflit
              setConflictData({
                conflicts: conflictDetail.conflicts,
                newItem: conflictDetail.new_item,
                date: dispo.date,
                action_required: conflictDetail.action_required
              });
              setShowConflictModal(true);
              // Arr√™ter la cr√©ation si conflit incompatible
              if (conflictDetail.action_required === 'choose') {
                break;
              }
            }
          } else {
            // Autre erreur
            errorCount++;
            console.error(`Erreur lors de la cr√©ation de la disponibilit√© pour ${dispo.date}:`, error);
            // Continuer aussi pour les autres erreurs
          }
        }
      }

      // Message r√©capitulatif
      let message = '';
      if (successCount > 0) {
        message += `${successCount} disponibilit√©(s) cr√©√©e(s)`;
      }
      if (conflictCount > 0) {
        message += (message ? ', ' : '') + `${conflictCount} ignor√©e(s) (conflit)`;
      }
      if (errorCount > 0) {
        message += (message ? ', ' : '') + `${errorCount} erreur(s)`;
      }

      toast({
        title: successCount > 0 ? "Disponibilit√©(s) ajout√©e(s)" : "Attention",
        description: message || "Aucune disponibilit√© cr√©√©e",
        variant: successCount > 0 ? "default" : "destructive"
      });

      // Recharger les disponibilit√©s
      const disponibilitesData = await apiGet(tenantSlug, `/disponibilites/${selectedUser.id}`);
      setUserDisponibilites(disponibilitesData);

      // R√©initialiser le formulaire
      setNewDisponibilite({
        date: new Date().toISOString().split('T')[0],
        heure_debut: '08:00',
        heure_fin: '17:00',
        statut: 'disponible',
        recurrence: false,
        type_recurrence: 'hebdomadaire',
        jours_semaine: [],
        bi_hebdomadaire: false,
        date_fin: ''
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible d'ajouter la disponibilit√©",
        variant: "destructive"
      });
    }
  };

  // Fonction pour r√©soudre les conflits de disponibilit√©s
  const handleResolveConflict = async (action) => {
    try {
      if (action === 'annuler') {
        setShowConflictModal(false);
        setConflictData({ conflicts: [], newItem: null, itemType: null });
        return;
      }

      const conflict_ids = conflictData.conflicts.map(c => c.conflict_id);
      
      const response = await apiPost(tenantSlug, '/disponibilites/resolve-conflict', {
        action: action,
        new_item: conflictData.newItem,
        conflict_ids: conflict_ids
      });

      toast({
        title: "R√©solution r√©ussie",
        description: response.message,
        variant: "default"
      });

      // Recharger les disponibilit√©s
      if (selectedUser) {
        const disponibilitesData = await apiGet(tenantSlug, `/disponibilites/${selectedUser.id}`);
        setUserDisponibilites(disponibilitesData);
      }

      // Fermer le modal
      setShowConflictModal(false);
      setConflictData({ conflicts: [], newItem: null, itemType: null });

      // R√©initialiser le formulaire
      setNewDisponibilite({
        date: new Date().toISOString().split('T')[0],
        heure_debut: '08:00',
        heure_fin: '17:00',
        statut: 'disponible',
        recurrence: false,
        type_recurrence: 'hebdomadaire',
        jours_semaine: [],
        bi_hebdomadaire: false,
        date_fin: ''
      });

    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de r√©soudre le conflit",
        variant: "destructive"
      });
    }
  };

  // Fonction pour g√©n√©rer les disponibilit√©s r√©currentes
  const generateRecurringDisponibilites = (config, userId) => {
    const disponibilites = [];
    // Parser les dates en timezone local (pas UTC) pour √©viter d√©calage d'un jour
    const [startYear, startMonth, startDay] = config.date.split('-').map(Number);
    const startDate = new Date(startYear, startMonth - 1, startDay);
    const [endYear, endMonth, endDay] = config.date_fin.split('-').map(Number);
    const endDate = new Date(endYear, endMonth - 1, endDay);

    if (config.type_recurrence === 'hebdomadaire') {
      // Pour chaque jour s√©lectionn√©
      config.jours_semaine.forEach(jourIndex => {
        let currentDate = new Date(startDate);
        
        // Trouver le premier jour correspondant
        while (currentDate.getDay() !== jourIndex) {
          currentDate.setDate(currentDate.getDate() + 1);
        }

        let weekCounter = 0;
        // G√©n√©rer les occurrences
        while (currentDate <= endDate) {
          // Si bi-hebdomadaire, ne cr√©er qu'une semaine sur deux
          if (!config.bi_hebdomadaire || weekCounter % 2 === 0) {
            disponibilites.push({
              date: formatDateLocal(currentDate),
              heure_debut: config.heure_debut,
              heure_fin: config.heure_fin,
              statut: config.statut,
              user_id: userId
            });
          }
          // Avancer d'une semaine (7 jours)
          currentDate.setDate(currentDate.getDate() + 7);
          weekCounter++;
        }
      });
    } else if (config.type_recurrence === 'mensuelle') {
      // R√©currence mensuelle (m√™me jour du mois)
      let currentDate = new Date(startDate);
      const dayOfMonth = startDate.getDate();

      while (currentDate <= endDate) {
        disponibilites.push({
          date: formatDateLocal(currentDate),
          heure_debut: config.heure_debut,
          heure_fin: config.heure_fin,
          statut: config.statut,
          user_id: userId
        });

        // Passer au mois suivant
        currentDate.setMonth(currentDate.getMonth() + 1);
        // Garder le m√™me jour du mois
        currentDate.setDate(dayOfMonth);
      }
    }

    return disponibilites;
  };

  const handleDeleteDisponibilite = async (disponibiliteId) => {
    try {
      await apiDelete(tenantSlug, `/disponibilites/${disponibiliteId}`);

      toast({
        title: "Disponibilit√© supprim√©e",
        description: "La disponibilit√© a √©t√© supprim√©e avec succ√®s"
      });

      // Recharger les disponibilit√©s
      const disponibilitesData = await apiGet(tenantSlug, `/disponibilites/${selectedUser.id}`);
      setUserDisponibilites(disponibilitesData);
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer la disponibilit√©",
        variant: "destructive"
      });
    }
  };

  // Fonctions de gestion des EPI
  const handleViewEPI = async (user) => {
    try {
      const episData = await apiGet(tenantSlug, `/epi/employe/${user.id}`);
      setUserEPIs(episData);
      setSelectedUser(user);
      setShowEPIModal(true);
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de charger les EPI",
        variant: "destructive"
      });
    }
  };

  const handleAddEPI = () => {
    setShowAddEPIModal(true);
  };

  const handleCreateEPI = async () => {
    if (!newEPI.type_epi || !newEPI.taille || !newEPI.date_attribution || !newEPI.date_expiration) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir tous les champs obligatoires",
        variant: "destructive"
      });
      return;
    }

    try {
      await apiPost(tenantSlug, '/epi', {
        ...newEPI,
        employe_id: selectedUser.id
      });
      
      toast({
        title: "EPI ajout√©",
        description: "L'√©quipement a √©t√© ajout√© avec succ√®s",
        variant: "success"
      });
      
      setShowAddEPIModal(false);
      resetNewEPI();
      
      // Recharger les EPI
      const episData = await apiGet(tenantSlug, `/epi/employe/${selectedUser.id}`);
      setUserEPIs(episData);
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.detail || error.message || "Impossible d'ajouter l'EPI",
        variant: "destructive"
      });
    }
  };

  const handleUpdateEPITaille = async (epiId, newTaille) => {
    try {
      await apiPut(tenantSlug, `/epi/${epiId}`, {
        taille: newTaille
      });
      
      toast({
        title: "Taille mise √† jour",
        description: "La taille de l'EPI a √©t√© modifi√©e",
        variant: "success"
      });
      
      // Recharger les EPI
      const episData = await apiGet(tenantSlug, `/epi/employe/${selectedUser.id}`);
      setUserEPIs(episData);
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de modifier la taille",
        variant: "destructive"
      });
    }
  };

  const handleDeleteEPI = async (epiId) => {
    if (!window.confirm("√ätes-vous s√ªr de vouloir supprimer cet EPI ?")) {
      return;
    }

    try {
      await apiDelete(tenantSlug, `/epi/${epiId}`);
      
      toast({
        title: "EPI supprim√©",
        description: "L'√©quipement a √©t√© supprim√©",
        variant: "success"
      });
      
      // Recharger les EPI
      const episData = await apiGet(tenantSlug, `/epi/employe/${selectedUser.id}`);
      setUserEPIs(episData);
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer l'EPI",
        variant: "destructive"
      });
    }
  };

  const resetNewEPI = () => {
    setNewEPI({
      type_epi: '',
      taille: '',
      date_attribution: new Date().toISOString().split('T')[0],
      etat: 'Neuf',
      date_expiration: '',
      date_prochaine_inspection: '',
      notes: ''
    });
  };

  const getAllEPITypes = () => {
    return [
      { id: 'casque', nom: 'Casque', icone: 'ü™ñ' },
      { id: 'bottes', nom: 'Bottes', icone: 'üë¢' },
      { id: 'veste_bunker', nom: 'Veste Bunker', icone: 'üß•' },
      { id: 'pantalon_bunker', nom: 'Pantalon Bunker', icone: 'üëñ' },
      { id: 'gants', nom: 'Gants', icone: 'üß§' },
      { id: 'masque_apria', nom: 'Facial APRIA', icone: 'üò∑' },
      { id: 'cagoule', nom: 'Cagoule Anti-Particules', icone: 'üé≠' }
    ];
  };

  const getEPINom = (typeEpi) => {
    const noms = {
      'casque': 'Casque',
      'bottes': 'Bottes',
      'veste_bunker': 'Veste Bunker',
      'pantalon_bunker': 'Pantalon Bunker',
      'gants': 'Gants',
      'masque_apria': 'Facial APRIA',
      'cagoule': 'Cagoule Anti-Particules'
    };
    return noms[typeEpi] || typeEpi;
  };

  const getEPIIcone = (typeEpi) => {
    const icones = {
      'casque': 'ü™ñ',
      'bottes': 'üë¢',
      'veste_bunker': 'üß•',
      'pantalon_bunker': 'üëñ',
      'gants': 'üß§',
      'masque_apria': 'üò∑',
      'cagoule': 'üé≠'
    };
    return icones[typeEpi] || 'üõ°Ô∏è';
  };

  const getEtatColor = (etat) => {
    const colors = {
      'Neuf': '#10B981',
      'Bon': '#3B82F6',
      '√Ä remplacer': '#F59E0B',
      'D√©fectueux': '#EF4444'
    };
    return colors[etat] || '#6B7280';
  };

  const getEPITailleForType = (typeEpi) => {
    const epi = userEPIs.find(e => e.type_epi === typeEpi);
    return epi ? epi.taille : '';
  };

  const getFormationName = (formationId) => {
    const formation = formations.find(f => f.id === formationId);
    return formation ? formation.nom : formationId;
  };

  const getCompetenceName = (competenceId) => {
    const competence = competences.find(c => c.id === competenceId);
    if (competence) return competence.nom;
    // Fallback pour comp√©tences obsol√®tes/supprim√©es
    return "‚ö†Ô∏è Comp√©tence obsol√®te";
  };

  const handleFormationToggle = (formationId) => {
    const updatedFormations = newUser.formations.includes(formationId)
      ? newUser.formations.filter(id => id !== formationId)
      : [...newUser.formations, formationId];
    
    setNewUser({...newUser, formations: updatedFormations});
  };

  const translateDay = (day) => {
    const translations = {
      'monday': 'Lundi', 'tuesday': 'Mardi', 'wednesday': 'Mercredi',
      'thursday': 'Jeudi', 'friday': 'Vendredi', 'saturday': 'Samedi', 'sunday': 'Dimanche'
    };
    return translations[day] || day;
  };

  const getStatusColor = (statut) => statut === 'Actif' ? '#10B981' : '#EF4444';
  const getGradeColor = (grade) => {
    const colors = {
      'Directeur': '#8B5CF6', 'Capitaine': '#3B82F6', 'Lieutenant': '#F59E0B', 'Pompier': '#10B981'
    };
    return colors[grade] || '#6B7280';
  };

  if (loading) return <div className="loading" data-testid="personnel-loading">Chargement...</div>;

  const filteredUsers = getFilteredUsers();
  const totalUsers = users.length;
  const activeUsers = users.filter(u => u.statut === 'Actif').length;
  const tempsPlein = users.filter(u => u.type_emploi === 'temps_plein').length;
  const tempsPartiel = users.filter(u => u.type_emploi === 'temps_partiel').length;

  return (
    <div className="personnel-refonte">
      {/* Header */}
      <div className="module-header">
        <div>
          <h1>üë• Gestion du Personnel</h1>
          <p>Liste compl√®te des pompiers du service</p>
        </div>
        <Button 
          onClick={() => setShowCreateModal(true)}
          data-testid="add-personnel-btn"
        >
          ‚ûï Nouveau pompier
        </Button>
      </div>

      {/* KPIs */}
      <div className="kpi-grid" style={{marginBottom: '2rem'}}>
        <div className="kpi-card" style={{background: '#FCA5A5'}}>
          <h3>{totalUsers}</h3>
          <p>Total Personnel</p>
        </div>
        <div className="kpi-card" style={{background: '#D1FAE5'}}>
          <h3>{activeUsers}</h3>
          <p>Personnel Actif</p>
        </div>
        <div className="kpi-card" style={{background: '#DBEAFE'}}>
          <h3>{tempsPlein}</h3>
          <p>Temps Plein</p>
        </div>
        <div className="kpi-card" style={{background: '#FEF3C7'}}>
          <h3>{tempsPartiel}</h3>
          <p>Temps Partiel</p>
        </div>
      </div>

      {/* Barre de contr√¥les */}
      <div className="personnel-controls">
        <div style={{display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap'}}>
          <div style={{flex: 1, minWidth: '300px'}}>
            <Input 
              placeholder="üîç Rechercher par nom, email, grade..."
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
            />
          </div>
          
          {/* Toggle Vue */}
          <div className="view-toggle">
            <button 
              className={viewMode === 'list' ? 'active' : ''}
              onClick={() => setViewMode('list')}
              title="Vue Liste"
            >
              ‚ò∞
            </button>
            <button 
              className={viewMode === 'cards' ? 'active' : ''}
              onClick={() => setViewMode('cards')}
              title="Vue Cartes"
            >
              ‚äû
            </button>
          </div>

          {/* Exports */}
          <Button variant="outline" onClick={() => handleOpenExportModal('pdf')}>
            üìÑ Export PDF
          </Button>
          <Button variant="outline" onClick={() => handleOpenExportModal('excel')}>
            üìä Export Excel
          </Button>
        </div>
      </div>

      {/* Vue Liste */}
      {viewMode === 'list' && (
        <div className="personnel-table-modern">
          <div className="table-header-modern">
            <div>Pompier</div>
            <div>Grade / N¬∞ Employ√©</div>
            <div>Contact</div>
            <div>Statut</div>
            <div>Type Emploi</div>
            <div>Actions</div>
          </div>

          {filteredUsers.map(user => (
            <div key={user.id} className="table-row-modern" data-testid={`user-row-${user.id}`}>
              <div className="user-cell-modern">
                <div className="user-avatar-modern" style={{
                  overflow: 'hidden',
                  background: user.photo_profil ? 'transparent' : '#e5e7eb'
                }}>
                  {user.photo_profil ? (
                    <img 
                      src={user.photo_profil} 
                      alt={`${user.prenom} ${user.nom}`}
                      style={{ width: '100%', height: '100%', objectFit: 'cover', borderRadius: '50%' }}
                    />
                  ) : (
                    'üë§'
                  )}
                </div>
                <div>
                  <p className="user-name-modern">
                    {user.prenom} {user.nom}
                    {user.est_preventionniste && (
                      <span 
                        title="Pr√©ventionniste" 
                        style={{
                          marginLeft: '0.5rem',
                          fontSize: '0.875rem',
                          opacity: 0.7
                        }}
                      >
                        üéØ
                      </span>
                    )}
                  </p>
                  <p className="user-detail-modern">Embauch√© le {user.date_embauche}</p>
                </div>
              </div>

              <div className="cell-modern">
                <p style={{fontWeight: '600'}}>{user.grade}</p>
                <p className="user-detail-modern">N¬∞ {user.numero_employe}</p>
              </div>

              <div className="cell-modern">
                <p className="email-truncated" title={user.email}>{user.email}</p>
                <p className="user-detail-modern">{user.telephone}</p>
              </div>

              <div className="cell-modern">
                <span className={`badge-status ${user.statut === 'Actif' ? 'actif' : 'inactif'}`}>
                  {user.statut}
                </span>
              </div>

              <div className="cell-modern">
                <span className={`badge-emploi ${user.type_emploi === 'temps_plein' ? 'tp' : 'tpa'}`}>
                  {user.type_emploi === 'temps_plein' ? 'Temps plein' : 'Temps partiel'}
                </span>
              </div>

              <div className="actions-cell-modern">
                <button onClick={() => handleViewUser(user)} title="Voir">üëÅÔ∏è</button>
                <button onClick={() => handleEditUser(user)} title="Modifier">‚úèÔ∏è</button>
                <button onClick={() => handleDeleteUser(user.id)} title="Supprimer">üóëÔ∏è</button>
                {user.type_emploi === 'temps_partiel' && (
                  <button onClick={() => handleManageDisponibilites(user)} title="G√©rer dispo">üìÖ</button>
                )}
              </div>
            </div>
          ))}

          {filteredUsers.length === 0 && (
            <div className="empty-state">
              <p>Aucun pompier trouv√©</p>
            </div>
          )}
        </div>
      )}

      {/* Vue Cartes */}
      {viewMode === 'cards' && (
        <div className="personnel-cards-grid">
          {filteredUsers.map(user => (
            <div key={user.id} className="personnel-card" data-testid={`user-card-${user.id}`}>
              <div className="card-header">
                <div className="user-avatar-card" style={{
                  overflow: 'hidden',
                  background: user.photo_profil ? 'transparent' : '#e5e7eb'
                }}>
                  {user.photo_profil ? (
                    <img 
                      src={user.photo_profil} 
                      alt={`${user.prenom} ${user.nom}`}
                      style={{ width: '100%', height: '100%', objectFit: 'cover', borderRadius: '50%' }}
                    />
                  ) : (
                    'üë§'
                  )}
                </div>
                <div>
                  <h3>
                    {user.prenom} {user.nom}
                    {user.est_preventionniste && (
                      <span 
                        title="Pr√©ventionniste" 
                        style={{
                          marginLeft: '0.5rem',
                          fontSize: '0.875rem',
                          opacity: 0.7
                        }}
                      >
                        üéØ
                      </span>
                    )}
                  </h3>
                  <p className="card-grade">{user.grade}</p>
                </div>
                <span className={`badge-status ${user.statut === 'Actif' ? 'actif' : 'inactif'}`}>
                  {user.statut}
                </span>
              </div>

              <div className="card-body">
                <div className="card-info-item">
                  <span className="info-label">Email:</span>
                  <span className="info-value">{user.email}</span>
                </div>
                <div className="card-info-item">
                  <span className="info-label">T√©l√©phone:</span>
                  <span className="info-value">{user.telephone}</span>
                </div>
                <div className="card-info-item">
                  <span className="info-label">Type emploi:</span>
                  <span className={`badge-emploi ${user.type_emploi === 'temps_plein' ? 'tp' : 'tpa'}`}>
                    {user.type_emploi === 'temps_plein' ? 'Temps plein' : 'Temps partiel'}
                  </span>
                </div>
                <div className="card-info-item">
                  <span className="info-label">N¬∞ Employ√©:</span>
                  <span className="info-value">{user.numero_employe}</span>
                </div>
              </div>

              <div className="card-footer">
                <Button size="sm" variant="outline" onClick={() => handleViewUser(user)}>
                  üëÅÔ∏è Voir
                </Button>
                <Button size="sm" variant="outline" onClick={() => handleEditUser(user)}>
                  ‚úèÔ∏è Modifier
                </Button>
                {user.type_emploi === 'temps_partiel' && (
                  <Button size="sm" variant="outline" onClick={() => handleManageDisponibilites(user)}>
                    üìÖ Dispo
                  </Button>
                )}
              </div>
            </div>
          ))}

          {filteredUsers.length === 0 && (
            <div className="empty-state" style={{gridColumn: '1 / -1'}}>
              <p>Aucun pompier trouv√©</p>
            </div>
          )}
        </div>
      )}

      {/* Create User Modal - Version optimis√©e */}
      {showCreateModal && (
        <div className="modal-overlay" onClick={() => setShowCreateModal(false)}>
          <div className="modal-content extra-large-modal" onClick={(e) => e.stopPropagation()} data-testid="create-user-modal">
            <div className="modal-header">
              <h3>üöí Nouveau pompier</h3>
              <Button variant="ghost" onClick={() => setShowCreateModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="personnel-form-grid">
                {/* Section 1: Informations personnelles */}
                <div className="form-section">
                  <h4 className="section-title">üë§ Informations personnelles</h4>
                  <div className="form-row">
                    <div className="form-field">
                      <Label>Pr√©nom *</Label>
                      <Input
                        value={newUser.prenom}
                        onChange={(e) => setNewUser({...newUser, prenom: e.target.value})}
                        placeholder="Ex: Pierre"
                        data-testid="user-prenom-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Nom *</Label>
                      <Input
                        value={newUser.nom}
                        onChange={(e) => setNewUser({...newUser, nom: e.target.value})}
                        placeholder="Ex: Dupont"
                        data-testid="user-nom-input"
                      />
                    </div>
                  </div>

                  <div className="form-field">
                    <Label>Email *</Label>
                    <Input
                      type="email"
                      value={newUser.email}
                      onChange={(e) => setNewUser({...newUser, email: e.target.value})}
                      placeholder="ex: pierre.dupont@firemanager.ca"
                      data-testid="user-email-input"
                    />
                  </div>

                  <div className="form-row">
                    <div className="form-field">
                      <Label>T√©l√©phone</Label>
                      <Input
                        value={newUser.telephone}
                        onChange={(e) => setNewUser({...newUser, telephone: e.target.value})}
                        placeholder="Ex: 514-555-1234"
                        data-testid="user-phone-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Adresse</Label>
                      <Input
                        value={newUser.adresse}
                        onChange={(e) => setNewUser({...newUser, adresse: e.target.value})}
                        placeholder="123 Rue Principale, Ville, Province"
                        data-testid="user-address-input"
                      />
                    </div>
                  </div>

                  <div className="form-field">
                    <Label>Contact d'urgence</Label>
                    <Input
                      value={newUser.contact_urgence}
                      onChange={(e) => setNewUser({...newUser, contact_urgence: e.target.value})}
                      placeholder="Nom et t√©l√©phone du contact d'urgence"
                      data-testid="user-emergency-input"
                    />
                  </div>
                </div>

                {/* Section 2: Informations professionnelles */}
                <div className="form-section">
                  <h4 className="section-title">üéñÔ∏è Informations professionnelles</h4>
                  <div className="form-row">
                    <div className="form-field">
                      <Label>Grade *</Label>
                      <select
                        value={newUser.grade}
                        onChange={(e) => setNewUser({...newUser, grade: e.target.value})}
                        className="form-select"
                        data-testid="user-grade-select"
                      >
                        <option value="">S√©lectionner un grade</option>
                        {grades.map(grade => (
                          <option key={grade.id} value={grade.nom}>{grade.nom}</option>
                        ))}
                      </select>
                    </div>
                    <div className="form-field">
                      <Label>Type d'emploi *</Label>
                      <select
                        value={newUser.type_emploi}
                        onChange={(e) => setNewUser({...newUser, type_emploi: e.target.value})}
                        className="form-select"
                        data-testid="user-employment-select"
                      >
                        <option value="">S√©lectionner le type</option>
                        <option value="temps_plein">Temps plein</option>
                        <option value="temps_partiel">Temps partiel</option>
                      </select>
                    </div>
                  </div>

                  {/* Option fonction sup√©rieur pour les pompiers */}
                  {['Pompier', 'Lieutenant', 'Capitaine', 'Chef de division'].includes(newUser.grade) && (
                    <div className="form-field">
                      <div className="fonction-superieur-option">
                        <label className="fonction-checkbox">
                          <input
                            type="checkbox"
                            checked={newUser.fonction_superieur}
                            onChange={(e) => setNewUser({...newUser, fonction_superieur: e.target.checked})}
                            data-testid="user-fonction-superieur"
                          />
                          <div className="fonction-content">
                            <span className="fonction-title">üéñÔ∏è Fonction sup√©rieur</span>
                            <span className="fonction-description">
                              {newUser.grade === 'Pompier' && "Ce pompier peut agir comme Lieutenant en dernier recours dans les affectations"}
                              {newUser.grade === 'Lieutenant' && "Ce lieutenant peut couvrir un poste de Capitaine en cas de besoin"}
                              {newUser.grade === 'Capitaine' && "Ce capitaine peut couvrir un poste de Chef de division en cas de besoin"}
                              {newUser.grade === 'Chef de division' && "Ce chef peut couvrir un poste de directeur en cas de besoin"}
                            </span>
                          </div>
                        </label>
                      </div>
                    </div>
                  )}

                  {/* Option pr√©ventionniste (admin seulement) */}
                  {user.role === 'admin' && (
                    <div className="form-field">
                      <div className="fonction-superieur-option">
                        <label className="fonction-checkbox">
                          <input
                            type="checkbox"
                            checked={newUser.est_preventionniste || false}
                            onChange={(e) => setNewUser({...newUser, est_preventionniste: e.target.checked})}
                            data-testid="user-est-preventionniste"
                          />
                          <div className="fonction-content">
                            <span className="fonction-title">üéØ Pr√©ventionniste</span>
                            <span className="fonction-description">
                              D√©signer cet employ√© comme pr√©ventionniste (module Pr√©vention)
                            </span>
                          </div>
                        </label>
                      </div>
                    </div>
                  )}

                  <div className="form-row">
                    <div className="form-field">
                      <Label>Num√©ro d'employ√©</Label>
                      <Input
                        value={newUser.numero_employe}
                        onChange={(e) => setNewUser({...newUser, numero_employe: e.target.value})}
                        placeholder="Ex: POM001 (automatique si vide)"
                        data-testid="user-number-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Date d'embauche *</Label>
                      <Input
                        type="date"
                        value={newUser.date_embauche}
                        onChange={(e) => setNewUser({...newUser, date_embauche: e.target.value})}
                        data-testid="user-hire-date-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Taux horaire ($/h)</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={newUser.taux_horaire || ''}
                        onChange={(e) => setNewUser({...newUser, taux_horaire: parseFloat(e.target.value) || 0})}
                        placeholder="Ex: 25.50"
                        data-testid="user-taux-horaire-input"
                      />
                    </div>
                  </div>
                </div>

                {/* Section 2.5: Pr√©f√©rences gardes externes */}
                <div className="form-section">
                  <h4 className="section-title">‚ö° Pr√©f√©rences d'assignation</h4>
                  <div className="form-field">
                    <div className="garde-externe-option">
                      <label className="garde-externe-checkbox">
                        <input
                          type="checkbox"
                          checked={newUser.accepte_gardes_externes !== false} // True par d√©faut
                          onChange={(e) => setNewUser({...newUser, accepte_gardes_externes: e.target.checked})}
                          data-testid="user-accepte-gardes-externes"
                        />
                        <div className="garde-externe-content">
                          <span className="garde-externe-title">üè† Accepter les gardes externes</span>
                          <span className="garde-externe-description">
                            {newUser.type_emploi === 'temps_partiel' 
                              ? "Temps partiel: Requis pour √™tre assign√© aux gardes externes (en plus des disponibilit√©s)"
                              : newUser.type_emploi === 'temps_plein'
                                ? "Temps plein: Permet d'√™tre assign√© automatiquement aux gardes externes"
                                : "Permet d'√™tre assign√© aux gardes externes (astreinte √† domicile)"
                            }
                          </span>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>

                {/* Section 3: Comp√©tences et formations - Version compacte */}
                <div className="form-section">
                  <h4 className="section-title">üìú Comp√©tences et certifications</h4>
                  <div className="formations-compact-grid">
                    {formations.map(formation => (
                      <label key={formation.id} className="formation-compact-item">
                        <input
                          type="checkbox"
                          checked={newUser.formations.includes(formation.id)}
                          onChange={() => handleFormationToggle(formation.id)}
                          data-testid={`formation-${formation.id}`}
                        />
                        <div className="formation-compact-content">
                          <div className="formation-compact-header">
                            <span className="formation-compact-name">{formation.nom}</span>
                            {formation.obligatoire && (
                              <span className="compact-obligatoire">OBL</span>
                            )}
                          </div>
                          <div className="formation-compact-meta">
                            <span>{formation.heures_requises_annuelles || 0}h/an</span>
                          </div>
                        </div>
                      </label>
                    ))}
                  </div>
                  <div className="formations-summary">
                    <span className="summary-text">
                      {newUser.formations.length} comp√©tence(s) s√©lectionn√©e(s)
                    </span>
                  </div>
                </div>

                {/* Section 4: EPI (√âquipements de Protection Individuels) - Optionnel */}
                <div className="form-section">
                  <h4 className="section-title">üõ°Ô∏è Tailles des EPI (Optionnel)</h4>
                  <p className="section-description">Les tailles peuvent √™tre saisies maintenant ou ajout√©es plus tard</p>
                  
                  <div className="epi-tailles-grid-modal">
                    {getAllEPITypes().map(epiType => (
                      <div key={epiType.id} className="epi-taille-row">
                        <span className="epi-taille-icon-modal">{epiType.icone}</span>
                        <Label className="epi-taille-label-modal">{epiType.nom}</Label>
                        <Input
                          placeholder="Taille (optionnel)"
                          value={newUser[`taille_${epiType.id}`] || ''}
                          onChange={(e) => setNewUser({...newUser, [`taille_${epiType.id}`]: e.target.value})}
                          className="epi-taille-input-modal"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowCreateModal(false)}>
                  Annuler
                </Button>
                <Button variant="default" onClick={handleCreateUser} data-testid="submit-user-btn">
                  üöí Cr√©er le pompier
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* View User Modal - Version modernis√©e */}
      {showViewModal && selectedUser && (
        <div className="modal-overlay" onClick={() => setShowViewModal(false)}>
          <div className="modal-content large-modal" onClick={(e) => e.stopPropagation()} data-testid="view-user-modal">
            <div className="modal-header">
              <h3>üë§ Profil de {selectedUser.prenom} {selectedUser.nom}</h3>
              <Button variant="ghost" onClick={() => setShowViewModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body modal-body-optimized">
              <div className="user-profile-view">
                {/* Header styl√© */}
                <div className="profile-summary-compact">
                  <div className="profile-avatar-medium">
                    <span className="avatar-icon-medium">üë§</span>
                  </div>
                  <div className="profile-info-summary">
                    <h4>{selectedUser.prenom} {selectedUser.nom}</h4>
                    <div className="profile-badges">
                      <span className="grade-badge" style={{ backgroundColor: getGradeColor(selectedUser.grade) }}>
                        {selectedUser.grade}
                      </span>
                      <span className="employment-badge">
                        {selectedUser.type_emploi === 'temps_plein' ? 'Temps plein' : 'Temps partiel'}
                      </span>
                      <span className={`status-badge ${selectedUser.statut.toLowerCase()}`}>
                        {selectedUser.statut}
                      </span>
                    </div>
                    <p className="employee-id">#{selectedUser.numero_employe}</p>
                  </div>
                </div>

                {/* Grille 2 colonnes pour TOUTES les sections */}
                <div className="profile-details-grid-optimized">
                  {/* Colonne gauche */}
                  <div className="detail-column" style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                    <div className="detail-section detail-section-optimized" style={{ marginBottom: '1.5rem' }}>
                      <h5>üìû Contact</h5>
                      <div className="detail-list" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>Email</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>{selectedUser.email}</span>
                        </div>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>T√©l√©phone</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>{selectedUser.telephone || 'Non renseign√©'}</span>
                        </div>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>Adresse</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>{selectedUser.adresse || 'Non renseign√©e'}</span>
                        </div>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>Contact d'urgence</span>
                          <span className="detail-value emergency" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>{selectedUser.contact_urgence || 'Non renseign√©'}</span>
                        </div>
                      </div>
                    </div>

                    <div className="detail-section detail-section-optimized" style={{ marginBottom: '1.5rem' }}>
                      <h5>üìú Comp√©tences</h5>
                      {selectedUser.competences?.length > 0 ? (
                        <div className="competences-view-optimized">
                          {selectedUser.competences.map((competenceId, index) => (
                            <div key={index} className="competence-badge-optimized">
                              <span className="competence-name">{getCompetenceName(competenceId)}</span>
                              <span className="competence-status">‚úÖ</span>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="no-data-text">Aucune comp√©tence enregistr√©e</p>
                      )}
                    </div>
                  </div>

                  {/* Colonne droite */}
                  <div className="detail-column" style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                    <div className="detail-section detail-section-optimized" style={{ marginBottom: '1.5rem' }}>
                      <h5>üéñÔ∏è Professionnel</h5>
                      <div className="detail-list" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>Date d'embauche</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>{selectedUser.date_embauche}</span>
                        </div>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>Anciennet√©</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>
                            {(() => {
                              const embauche = new Date(selectedUser.date_embauche.split('/').reverse().join('-'));
                              const annees = Math.floor((new Date() - embauche) / (365.25 * 24 * 60 * 60 * 1000));
                              return `${annees} an(s)`;
                            })()}
                          </span>
                        </div>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>R√¥le syst√®me</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>
                            {selectedUser.role === 'admin' ? 'üëë Administrateur' : 
                             selectedUser.role === 'superviseur' ? 'üéñÔ∏è Superviseur' : 'üë§ Employ√©'}
                          </span>
                        </div>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>Taux horaire</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1 }}>
                            {selectedUser.taux_horaire ? `${selectedUser.taux_horaire.toFixed(2)} $/h` : 'Non d√©fini'}
                          </span>
                        </div>
                        <div className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2.5rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                          <span className="detail-label" style={{ minWidth: '140px', color: '#64748b' }}>Heures max/semaine</span>
                          <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'flex-end', gap: '0.5rem' }}>
                            <span>{selectedUser.heures_max_semaine || 40}h</span>
                          </span>
                        </div>
                      </div>
                    </div>

                    <div className="detail-section detail-section-optimized" style={{ marginBottom: '1.5rem' }}>
                      <h5>üìè Tailles EPI</h5>
                      <p style={{ fontSize: '0.813rem', color: '#64748b', marginBottom: '0.75rem' }}>
                        Tailles d√©clar√©es par l'employ√© dans "Mon profil" (lecture seule)
                      </p>
                      {userEPIs && userEPIs.length > 0 ? (
                        <div className="detail-list" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          {userEPIs.map(epi => (
                            <div key={epi.id} className="detail-item-optimized" style={{ display: 'flex', justifyContent: 'space-between', gap: '2rem', padding: '0.65rem 0.85rem', background: '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem' }}>
                              <span className="detail-label" style={{ minWidth: '140px', color: '#64748b', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <span>{getEPIIcone(epi.type_epi)}</span>
                                {getEPINom(epi.type_epi)}
                              </span>
                              <span className="detail-value" style={{ marginLeft: '1.5rem', textAlign: 'right', flex: 1, fontWeight: '600', color: '#1F2937' }}>
                                {epi.taille || 'Non renseign√©e'}
                              </span>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="no-data-text">Aucune taille renseign√©e</p>
                      )}
                    </div>
                  </div>
                </div>

                {/* Actions rapides */}
                <div className="profile-actions">
                  <Button 
                    variant="default" 
                    onClick={() => {
                      setShowViewModal(false);
                      handleEditUser(selectedUser);
                    }}
                    data-testid="quick-edit-user-btn"
                  >
                    ‚úèÔ∏è Modifier ce profil
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de gestion des disponibilit√©s - Admin/Superviseur */}
      {/* Modal supprim√© - On utilise maintenant le module complet Mes Disponibilit√©s */}
      
      {false && showManageDisponibilitesModal && selectedUser && (
        <div className="modal-overlay" onClick={() => setShowManageDisponibilitesModal(false)}>
          <div className="modal-content large-modal" onClick={(e) => e.stopPropagation()} data-testid="manage-disponibilites-modal">
            <div className="modal-header">
              <h3>‚úèÔ∏è G√©rer les disponibilit√©s - {selectedUser.prenom} {selectedUser.nom}</h3>
              <Button variant="ghost" onClick={() => setShowManageDisponibilitesModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              {/* Formulaire d'ajout */}
              <div className="add-disponibilite-form" style={{ marginBottom: '2rem', padding: '1rem', background: '#f8fafc', borderRadius: '8px' }}>
                <h4 style={{ marginBottom: '1rem' }}>‚ûï Ajouter une disponibilit√©</h4>
                
                {/* Premi√®re ligne : Date, heures, statut */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>
                      {newDisponibilite.recurrence ? 'Date de d√©but' : 'Date'}
                    </label>
                    <input
                      type="date"
                      value={newDisponibilite.date}
                      onChange={(e) => setNewDisponibilite({...newDisponibilite, date: e.target.value})}
                      style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>Heure d√©but</label>
                    <input
                      type="time"
                      value={newDisponibilite.heure_debut}
                      onChange={(e) => setNewDisponibilite({...newDisponibilite, heure_debut: e.target.value})}
                      style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>Heure fin</label>
                    <input
                      type="time"
                      value={newDisponibilite.heure_fin}
                      onChange={(e) => setNewDisponibilite({...newDisponibilite, heure_fin: e.target.value})}
                      style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>Statut</label>
                    <select
                      value={newDisponibilite.statut}
                      onChange={(e) => setNewDisponibilite({...newDisponibilite, statut: e.target.value})}
                      style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                    >
                      <option value="disponible">‚úÖ Disponible</option>
                      <option value="indisponible">‚ùå Indisponible</option>
                    </select>
                  </div>
                </div>

                {/* Checkbox r√©currence */}
                <div style={{ marginBottom: '1rem' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={newDisponibilite.recurrence}
                      onChange={(e) => setNewDisponibilite({...newDisponibilite, recurrence: e.target.checked})}
                      style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                    />
                    <span style={{ fontWeight: '500', fontSize: '0.95rem' }}>üìÖ R√©currence (r√©p√©ter cette disponibilit√©)</span>
                  </label>
                </div>

                {/* Options de r√©currence */}
                {newDisponibilite.recurrence && (
                  <div style={{ padding: '1rem', background: 'white', borderRadius: '8px', border: '2px solid #3b82f6', marginBottom: '1rem' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                      <div>
                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>Type de r√©currence</label>
                        <select
                          value={newDisponibilite.type_recurrence}
                          onChange={(e) => setNewDisponibilite({...newDisponibilite, type_recurrence: e.target.value})}
                          style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                        >
                          <option value="hebdomadaire">üìÖ Hebdomadaire</option>
                          <option value="mensuelle">üìÜ Mensuelle</option>
                        </select>
                      </div>
                      <div>
                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>Date de fin *</label>
                        <input
                          type="date"
                          value={newDisponibilite.date_fin}
                          onChange={(e) => setNewDisponibilite({...newDisponibilite, date_fin: e.target.value})}
                          style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                        />
                      </div>
                    </div>

                    {/* S√©lection des jours pour hebdomadaire */}
                    {newDisponibilite.type_recurrence === 'hebdomadaire' && (
                      <>
                        <div style={{ marginBottom: '1rem' }}>
                          <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>
                            Jours de la semaine *
                          </label>
                          <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                            {[
                              { label: 'Lun', value: 1 },
                              { label: 'Mar', value: 2 },
                              { label: 'Mer', value: 3 },
                              { label: 'Jeu', value: 4 },
                              { label: 'Ven', value: 5 },
                              { label: 'Sam', value: 6 },
                              { label: 'Dim', value: 0 }
                            ].map(jour => (
                              <label 
                                key={jour.value}
                                style={{ 
                                  padding: '0.5rem 1rem', 
                                  borderRadius: '6px', 
                                  border: '2px solid',
                                  borderColor: newDisponibilite.jours_semaine.includes(jour.value) ? '#3b82f6' : '#cbd5e1',
                                  background: newDisponibilite.jours_semaine.includes(jour.value) ? '#dbeafe' : 'white',
                                  cursor: 'pointer',
                                  fontWeight: '500',
                                  fontSize: '0.875rem'
                                }}
                              >
                                <input
                                  type="checkbox"
                                  checked={newDisponibilite.jours_semaine.includes(jour.value)}
                                  onChange={(e) => {
                                    const jours = e.target.checked 
                                      ? [...newDisponibilite.jours_semaine, jour.value]
                                      : newDisponibilite.jours_semaine.filter(j => j !== jour.value);
                                    setNewDisponibilite({...newDisponibilite, jours_semaine: jours});
                                  }}
                                  style={{ display: 'none' }}
                                />
                                {jour.label}
                              </label>
                            ))}
                          </div>
                        </div>

                        {/* Option bi-hebdomadaire */}
                        <div>
                          <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                            <input
                              type="checkbox"
                              checked={newDisponibilite.bi_hebdomadaire}
                              onChange={(e) => setNewDisponibilite({...newDisponibilite, bi_hebdomadaire: e.target.checked})}
                              style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                            />
                            <span style={{ fontSize: '0.875rem' }}>Une semaine sur deux (bi-hebdomadaire)</span>
                          </label>
                        </div>
                      </>
                    )}

                    {newDisponibilite.type_recurrence === 'mensuelle' && (
                      <p style={{ fontSize: '0.875rem', color: '#64748b', fontStyle: 'italic' }}>
                        üí° La disponibilit√© sera r√©p√©t√©e le m√™me jour chaque mois
                      </p>
                    )}
                  </div>
                )}

                {/* Bouton Ajouter */}
                <Button onClick={handleAddDisponibilite} style={{ width: '100%' }}>
                  {newDisponibilite.recurrence ? '‚ûï Cr√©er les disponibilit√©s r√©currentes' : '‚ûï Ajouter'}
                </Button>
              </div>

              {/* Liste des disponibilit√©s existantes */}
              <div className="disponibilites-list">
                <h4 style={{ marginBottom: '1rem' }}>üìã Disponibilit√©s existantes</h4>
                {userDisponibilites.length > 0 ? (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                    {userDisponibilites.sort((a, b) => parseDateLocal(a.date) - parseDateLocal(b.date)).map(dispo => (
                      <div key={dispo.id} style={{ 
                        display: 'grid', 
                        gridTemplateColumns: '150px 120px 120px 150px auto', 
                        gap: '1rem', 
                        padding: '0.75rem', 
                        background: 'white', 
                        border: '1px solid #e2e8f0', 
                        borderRadius: '6px',
                        alignItems: 'center'
                      }}>
                        <div>
                          <strong>{parseDateLocal(dispo.date).toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' })}</strong>
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#64748b' }}>
                          {dispo.heure_debut}
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#64748b' }}>
                          {dispo.heure_fin}
                        </div>
                        <div>
                          <span style={{ 
                            padding: '0.25rem 0.75rem', 
                            borderRadius: '12px', 
                            fontSize: '0.875rem',
                            background: dispo.statut === 'disponible' ? '#dcfce7' : '#fee2e2',
                            color: dispo.statut === 'disponible' ? '#166534' : '#991b1b'
                          }}>
                            {dispo.statut === 'disponible' ? '‚úÖ Disponible' : '‚ùå Indisponible'}
                          </span>
                        </div>
                        <Button 
                          variant="destructive" 
                          size="sm"
                          onClick={() => handleDeleteDisponibilite(dispo.id)}
                        >
                          üóëÔ∏è Supprimer
                        </Button>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{ padding: '2rem', textAlign: 'center', color: '#64748b', background: '#f8fafc', borderRadius: '8px' }}>
                    <p>Aucune disponibilit√© renseign√©e</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* EPI Modal - Gestion des √©quipements */}
      {showEPIModal && selectedUser && (
        <div className="modal-overlay" onClick={() => setShowEPIModal(false)}>
          <div className="modal-content large-modal" onClick={(e) => e.stopPropagation()} data-testid="epi-modal">
            <div className="modal-header">
              <h3>üõ°Ô∏è EPI - {selectedUser.prenom} {selectedUser.nom}</h3>
              <Button variant="ghost" onClick={() => setShowEPIModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="epi-management">
                {/* Bouton d'ajout (Admin/Superviseur uniquement) */}
                <div className="epi-header-actions">
                  <Button 
                    onClick={handleAddEPI}
                    data-testid="add-epi-btn"
                  >
                    + Ajouter un EPI
                  </Button>
                </div>

                {/* Liste des EPI */}
                {userEPIs.length > 0 ? (
                  <div className="epi-list">
                    {userEPIs.map(epi => (
                      <div key={epi.id} className="epi-item-card" data-testid={`epi-item-${epi.id}`}>
                        <div className="epi-item-header">
                          <div className="epi-item-icon">{getEPIIcone(epi.type_epi)}</div>
                          <div className="epi-item-title">
                            <h4>{getEPINom(epi.type_epi)}</h4>
                            <span 
                              className="epi-etat-badge" 
                              style={{ backgroundColor: getEtatColor(epi.etat) }}
                            >
                              {epi.etat}
                            </span>
                          </div>
                        </div>

                        <div className="epi-item-details">
                          <div className="epi-detail-row">
                            <span className="epi-label">Taille:</span>
                            <span className="epi-value">{epi.taille}</span>
                          </div>
                          <div className="epi-detail-row">
                            <span className="epi-label">Attribution:</span>
                            <span className="epi-value">{epi.date_attribution}</span>
                          </div>
                          <div className="epi-detail-row">
                            <span className="epi-label">Expiration:</span>
                            <span className="epi-value">{epi.date_expiration}</span>
                          </div>
                          {epi.date_prochaine_inspection && (
                            <div className="epi-detail-row">
                              <span className="epi-label">Prochaine inspection:</span>
                              <span className="epi-value">{epi.date_prochaine_inspection}</span>
                            </div>
                          )}
                          {epi.notes && (
                            <div className="epi-detail-row">
                              <span className="epi-label">Notes:</span>
                              <span className="epi-value">{epi.notes}</span>
                            </div>
                          )}
                        </div>

                        <div className="epi-item-actions">
                          <Button 
                            variant="outline" 
                            size="sm"
                            onClick={() => {
                              const newTaille = prompt("Nouvelle taille:", epi.taille);
                              if (newTaille) handleUpdateEPITaille(epi.id, newTaille);
                            }}
                            data-testid={`update-taille-${epi.id}`}
                          >
                            ‚úèÔ∏è Modifier taille
                          </Button>
                          <Button 
                            variant="destructive" 
                            size="sm"
                            onClick={() => handleDeleteEPI(epi.id)}
                            data-testid={`delete-epi-${epi.id}`}
                          >
                            üóëÔ∏è Supprimer
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="no-epi">
                    <p>Aucun EPI enregistr√© pour cet employ√©</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Add EPI Modal */}
      {showAddEPIModal && selectedUser && (
        <div className="modal-overlay" onClick={() => setShowAddEPIModal(false)}>
          <div className="modal-content medium-modal" onClick={(e) => e.stopPropagation()} data-testid="add-epi-modal">
            <div className="modal-header">
              <h3>+ Ajouter un EPI</h3>
              <Button variant="ghost" onClick={() => setShowAddEPIModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="form-grid">
                <div className="form-field">
                  <Label>Type d'EPI *</Label>
                  <select
                    value={newEPI.type_epi}
                    onChange={(e) => setNewEPI({...newEPI, type_epi: e.target.value})}
                    className="form-select"
                    data-testid="new-epi-type-select"
                  >
                    <option value="">S√©lectionnez un type</option>
                    <option value="casque">ü™ñ Casque</option>
                    <option value="bottes">üë¢ Bottes</option>
                    <option value="veste_bunker">üß• Veste Bunker</option>
                    <option value="pantalon_bunker">üëñ Pantalon Bunker</option>
                    <option value="gants">üß§ Gants</option>
                    <option value="masque_apria">üò∑ Facial APRIA</option>
                    <option value="cagoule">üé≠ Cagoule Anti-Particules</option>
                  </select>
                </div>

                <div className="form-field">
                  <Label>Taille *</Label>
                  <Input
                    value={newEPI.taille}
                    onChange={(e) => setNewEPI({...newEPI, taille: e.target.value})}
                    placeholder="Ex: M, L, 42, etc."
                    data-testid="new-epi-taille-input"
                  />
                </div>

                <div className="form-row">
                  <div className="form-field">
                    <Label>Date d'attribution *</Label>
                    <Input
                      type="date"
                      value={newEPI.date_attribution}
                      onChange={(e) => setNewEPI({...newEPI, date_attribution: e.target.value})}
                      data-testid="new-epi-attribution-input"
                    />
                  </div>

                  <div className="form-field">
                    <Label>√âtat</Label>
                    <select
                      value={newEPI.etat}
                      onChange={(e) => setNewEPI({...newEPI, etat: e.target.value})}
                      className="form-select"
                      data-testid="new-epi-etat-select"
                    >
                      <option value="Neuf">Neuf</option>
                      <option value="Bon">Bon</option>
                      <option value="√Ä remplacer">√Ä remplacer</option>
                      <option value="D√©fectueux">D√©fectueux</option>
                    </select>
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-field">
                    <Label>Date d'expiration *</Label>
                    <Input
                      type="date"
                      value={newEPI.date_expiration}
                      onChange={(e) => setNewEPI({...newEPI, date_expiration: e.target.value})}
                      data-testid="new-epi-expiration-input"
                    />
                  </div>

                  <div className="form-field">
                    <Label>Prochaine inspection</Label>
                    <Input
                      type="date"
                      value={newEPI.date_prochaine_inspection}
                      onChange={(e) => setNewEPI({...newEPI, date_prochaine_inspection: e.target.value})}
                      data-testid="new-epi-inspection-input"
                    />
                  </div>
                </div>

                <div className="form-field">
                  <Label>Notes</Label>
                  <textarea
                    value={newEPI.notes}
                    onChange={(e) => setNewEPI({...newEPI, notes: e.target.value})}
                    className="form-textarea"
                    rows="3"
                    placeholder="Remarques ou observations..."
                    data-testid="new-epi-notes-input"
                  />
                </div>
              </div>

              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowAddEPIModal(false)}>
                  Annuler
                </Button>
                <Button onClick={handleCreateEPI} data-testid="create-epi-btn">
                  Ajouter l'EPI
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Edit User Modal - Complet et fonctionnel */}
      {showEditModal && selectedUser && (
        <div className="modal-overlay" onClick={async () => {
          await handleUpdateUser();
        }}>
          <div className="modal-content extra-large-modal" onClick={(e) => e.stopPropagation()} data-testid="edit-user-modal">
            <div className="modal-header">
              <h3>‚úèÔ∏è Modifier {selectedUser.prenom} {selectedUser.nom}</h3>
              <Button variant="ghost" onClick={async () => {
                await handleUpdateUser();
              }}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="personnel-form-grid">
                {/* Section Photo de Profil */}
                <div className="form-section" style={{ gridColumn: '1 / -1' }}>
                  <h4 className="section-title">üì∑ Photo de profil</h4>
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '1.5rem',
                    padding: '0.75rem',
                    background: '#f9fafb',
                    borderRadius: '8px',
                    flexWrap: 'wrap'
                  }}>
                    {/* Photo preview */}
                    <div style={{
                      width: '80px',
                      height: '80px',
                      borderRadius: '50%',
                      overflow: 'hidden',
                      background: '#e5e7eb',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      border: '2px solid #d1d5db',
                      flexShrink: 0
                    }}>
                      {selectedUser?.photo_profil ? (
                        <img 
                          src={selectedUser.photo_profil} 
                          alt="Photo de profil"
                          style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                        />
                      ) : (
                        <span style={{ fontSize: '2rem', color: '#9ca3af' }}>üë§</span>
                      )}
                    </div>
                    
                    {/* Boutons */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                      <input
                        type="file"
                        ref={photoInputRef}
                        onChange={handlePhotoSelectAdmin}
                        accept="image/jpeg,image/png,image/webp"
                        style={{ display: 'none' }}
                      />
                      <Button
                        size="sm"
                        onClick={() => photoInputRef.current?.click()}
                        disabled={photoUploading}
                      >
                        {photoUploading ? '‚è≥ Upload...' : 'üì§ Changer la photo'}
                      </Button>
                      {selectedUser?.photo_profil && (
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={handleDeletePhotoAdmin}
                          style={{ color: '#ef4444' }}
                        >
                          üóëÔ∏è Supprimer
                        </Button>
                      )}
                    </div>
                    <p style={{ 
                      fontSize: '0.7rem', 
                      color: '#6b7280',
                      margin: 0
                    }}>
                      JPG, PNG ou WEBP ‚Ä¢ Max 2 MB
                    </p>
                  </div>
                </div>

                {/* Section 1: Informations personnelles */}
                <div className="form-section">
                  <h4 className="section-title">üë§ Informations personnelles</h4>
                  <div className="form-row">
                    <div className="form-field">
                      <Label>Pr√©nom *</Label>
                      <Input
                        value={newUser.prenom}
                        onChange={(e) => setNewUser({...newUser, prenom: e.target.value})}
                        data-testid="edit-user-prenom-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Nom *</Label>
                      <Input
                        value={newUser.nom}
                        onChange={(e) => setNewUser({...newUser, nom: e.target.value})}
                        data-testid="edit-user-nom-input"
                      />
                    </div>
                  </div>

                  <div className="form-field">
                    <Label>Email *</Label>
                    <Input
                      type="email"
                      value={newUser.email}
                      onChange={(e) => setNewUser({...newUser, email: e.target.value})}
                      data-testid="edit-user-email-input"
                    />
                  </div>

                  <div className="form-row">
                    <div className="form-field">
                      <Label>T√©l√©phone</Label>
                      <Input
                        value={newUser.telephone}
                        onChange={(e) => setNewUser({...newUser, telephone: e.target.value})}
                        data-testid="edit-user-phone-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Adresse</Label>
                      <Input
                        value={newUser.adresse}
                        onChange={(e) => setNewUser({...newUser, adresse: e.target.value})}
                        placeholder="123 Rue Principale, Ville, Province"
                        data-testid="edit-user-address-input"
                      />
                    </div>
                  </div>

                  <div className="form-field">
                    <Label>Contact d'urgence</Label>
                    <Input
                      value={newUser.contact_urgence}
                      onChange={(e) => setNewUser({...newUser, contact_urgence: e.target.value})}
                      placeholder="Nom et t√©l√©phone du contact d'urgence"
                      data-testid="edit-user-emergency-input"
                    />
                  </div>
                </div>

                {/* Section 2: Informations professionnelles */}
                <div className="form-section">
                  <h4 className="section-title">üéñÔ∏è Informations professionnelles</h4>
                  <div className="form-row">
                    <div className="form-field">
                      <Label>Grade *</Label>
                      <select
                        value={newUser.grade}
                        onChange={(e) => setNewUser({...newUser, grade: e.target.value})}
                        className="form-select"
                        data-testid="edit-user-grade-select"
                      >
                        {grades.map(grade => (
                          <option key={grade.id} value={grade.nom}>{grade.nom}</option>
                        ))}
                      </select>
                    </div>
                    <div className="form-field">
                      <Label>Type d'emploi *</Label>
                      <select
                        value={newUser.type_emploi}
                        onChange={(e) => setNewUser({...newUser, type_emploi: e.target.value})}
                        className="form-select"
                        data-testid="edit-user-employment-select"
                      >
                        <option value="temps_plein">Temps plein</option>
                        <option value="temps_partiel">Temps partiel</option>
                      </select>
                    </div>
                  </div>

                  {/* Option fonction sup√©rieur pour pompiers et officiers */}
                  {['Pompier', 'Lieutenant', 'Capitaine', 'Chef de division'].includes(newUser.grade) && (
                    <div className="form-field">
                      <div className="fonction-superieur-option">
                        <label className="fonction-checkbox">
                          <input
                            type="checkbox"
                            checked={newUser.fonction_superieur}
                            onChange={(e) => setNewUser({...newUser, fonction_superieur: e.target.checked})}
                            data-testid="edit-user-fonction-superieur"
                          />
                          <div className="fonction-content">
                            <span className="fonction-title">üéñÔ∏è Fonction sup√©rieur</span>
                            <span className="fonction-description">
                              {newUser.grade === 'Pompier' && "Ce pompier peut agir comme Lieutenant en dernier recours dans les affectations"}
                              {newUser.grade === 'Lieutenant' && "Ce lieutenant peut couvrir un poste de Capitaine en cas de besoin"}
                              {newUser.grade === 'Capitaine' && "Ce capitaine peut couvrir un poste de Chef de division en cas de besoin"}
                              {newUser.grade === 'Chef de division' && "Ce chef peut couvrir un poste de directeur en cas de besoin"}
                            </span>
                          </div>
                        </label>
                      </div>
                    </div>
                  )}

                  {/* Option pr√©ventionniste (admin seulement) */}
                  {user.role === 'admin' && (
                    <div className="form-field">
                      <div className="fonction-superieur-option">
                        <label className="fonction-checkbox">
                          <input
                            type="checkbox"
                            checked={newUser.est_preventionniste || false}
                            onChange={(e) => setNewUser({...newUser, est_preventionniste: e.target.checked})}
                            data-testid="edit-user-est-preventionniste"
                          />
                          <div className="fonction-content">
                            <span className="fonction-title">üéØ Pr√©ventionniste</span>
                            <span className="fonction-description">
                              D√©signer cet employ√© comme pr√©ventionniste (module Pr√©vention)
                            </span>
                          </div>
                        </label>
                      </div>
                    </div>
                  )}

                  <div className="form-row">
                    <div className="form-field">
                      <Label>Num√©ro d'employ√©</Label>
                      <Input
                        value={newUser.numero_employe}
                        onChange={(e) => setNewUser({...newUser, numero_employe: e.target.value})}
                        data-testid="edit-user-number-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Date d'embauche *</Label>
                      <Input
                        type="date"
                        value={newUser.date_embauche}
                        onChange={(e) => setNewUser({...newUser, date_embauche: e.target.value})}
                        data-testid="edit-user-hire-date-input"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Taux horaire ($/h)</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={newUser.taux_horaire || ''}
                        onChange={(e) => setNewUser({...newUser, taux_horaire: parseFloat(e.target.value) || 0})}
                        placeholder="Ex: 25.50"
                        data-testid="edit-user-taux-horaire-input"
                      />
                    </div>
                  </div>

                  <div className="form-row">
                    <div className="form-field">
                      <Label>Heures maximum par semaine *</Label>
                      <input
                        type="number"
                        style={{
                          width: '100%',
                          padding: '8px 12px',
                          border: '1px solid #e2e8f0',
                          borderRadius: '6px',
                          fontSize: '14px'
                        }}
                        value={newUser.heures_max_semaine !== null && newUser.heures_max_semaine !== undefined 
                          ? newUser.heures_max_semaine 
                          : ''}
                        onChange={(e) => {
                          const value = e.target.value;
                          if (value === '') {
                            setNewUser({...newUser, heures_max_semaine: ''});
                          } else {
                            const numValue = parseInt(value);
                            if (!isNaN(numValue)) {
                              setNewUser({...newUser, heures_max_semaine: numValue});
                            }
                          }
                        }}
                        onBlur={(e) => {
                          // Valider √† la sortie du champ
                          const value = e.target.value;
                          if (value === '' || parseInt(value) < 5) {
                            setNewUser({...newUser, heures_max_semaine: 5});
                          } else if (parseInt(value) > 168) {
                            setNewUser({...newUser, heures_max_semaine: 168});
                          }
                        }}
                        placeholder="Ex: 40"
                        data-testid="edit-user-heures-max-input"
                        disabled={
                          newUser.type_emploi === 'temps_partiel' || 
                          (newUser.type_emploi === 'temps_plein' && user?.role !== 'admin')
                        }
                      />
                      <small style={{ display: 'block', marginTop: '0.25rem', color: '#64748b', fontSize: '0.875rem' }}>
                        {newUser.type_emploi === 'temps_plein' 
                          ? "Modifiable uniquement par les administrateurs (5-168h)"
                          : "Les employ√©s temps partiel modifient ce champ dans leur profil"}
                      </small>
                    </div>
                  </div>
                </div>

                {/* Section 2.5: Pr√©f√©rences gardes externes */}
                <div className="form-section">
                  <h4 className="section-title">‚ö° Pr√©f√©rences d'assignation</h4>
                  <div className="form-field">
                    <div className="garde-externe-option">
                      <label className="garde-externe-checkbox">
                        <input
                          type="checkbox"
                          checked={newUser.accepte_gardes_externes !== false} // True par d√©faut
                          onChange={(e) => setNewUser({...newUser, accepte_gardes_externes: e.target.checked})}
                          data-testid="edit-user-accepte-gardes-externes"
                        />
                        <div className="garde-externe-content">
                          <span className="garde-externe-title">üè† Accepter les gardes externes</span>
                          <span className="garde-externe-description">
                            {newUser.type_emploi === 'temps_partiel' 
                              ? "Temps partiel: Requis pour √™tre assign√© aux gardes externes (en plus des disponibilit√©s)"
                              : newUser.type_emploi === 'temps_plein'
                                ? "Temps plein: Permet d'√™tre assign√© automatiquement aux gardes externes"
                                : "Permet d'√™tre assign√© aux gardes externes (astreinte √† domicile)"
                            }
                          </span>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>

                {/* Section 3: Comp√©tences */}
                <div className="form-section">
                  <h4 className="section-title">üìú Comp√©tences et certifications</h4>
                  <div className="formations-compact-grid">
                    {formations.map(formation => (
                      <label key={formation.id} className="formation-compact-item">
                        <input
                          type="checkbox"
                          checked={newUser.formations.includes(formation.id)}
                          onChange={() => handleFormationToggle(formation.id)}
                          data-testid={`edit-formation-${formation.id}`}
                        />
                        <div className="formation-compact-content">
                          <div className="formation-compact-header">
                            <span className="formation-compact-name">{formation.nom}</span>
                            {formation.obligatoire && (
                              <span className="compact-obligatoire">OBL</span>
                            )}
                          </div>
                          <div className="formation-compact-meta">
                            <span>{formation.heures_requises_annuelles || 0}h/an</span>
                          </div>
                        </div>
                      </label>
                    ))}
                  </div>
                  <div className="formations-summary">
                    <span className="summary-text">
                      {newUser.formations.length} comp√©tence(s) s√©lectionn√©e(s)
                    </span>
                  </div>
                </div>

                {/* Section 4: EPI (√âquipements de Protection Individuels) */}
                <div className="form-section">
                  <h4 className="section-title">üõ°Ô∏è Tailles des EPI</h4>
                  <p className="section-description">S√©lectionnez les tailles pour chaque √©quipement. Les autres d√©tails seront g√©r√©s dans le module EPI.</p>
                  
                  <div className="epi-tailles-grid-modal">
                    {getAllEPITypes().map(epiType => {
                      const existingEPI = userEPIs.find(e => e.type_epi === epiType.id);
                      const currentValue = existingEPI ? existingEPI.taille : '';
                      
                      return (
                        <div key={epiType.id} className="epi-taille-row">
                          <span className="epi-taille-icon-modal">{epiType.icone}</span>
                          <Label className="epi-taille-label-modal">{epiType.nom}</Label>
                          <Input
                            value={currentValue}
                            onChange={(e) => {
                              const newValue = e.target.value;
                              if (existingEPI) {
                                // Mettre √† jour l'EPI existant
                                const updatedEPIs = userEPIs.map(item => 
                                  item.id === existingEPI.id ? {...item, taille: newValue} : item
                                );
                                setUserEPIs(updatedEPIs);
                              } else if (newValue) {
                                // Cr√©er un nouvel EPI si une valeur est saisie
                                const newEPI = {
                                  id: `temp-${epiType.id}-${Date.now()}`,
                                  type_epi: epiType.id,
                                  taille: newValue,
                                  user_id: selectedUser.id
                                };
                                setUserEPIs([...userEPIs, newEPI]);
                              }
                            }}
                            placeholder="Saisir la taille"
                            className="epi-taille-input-modal"
                          />
                        </div>
                      );
                    })}
                  </div>
                  <p className="epi-note-modal">
                    üí° Pour attribuer ou g√©rer compl√®tement les EPI, utilisez le <strong>Module EPI</strong> dans la sidebar
                  </p>
                </div>
              </div>

              <div className="modal-actions" style={{ display: 'flex', justifyContent: 'center', padding: '1rem' }}>
                <p style={{ fontSize: '0.875rem', color: '#64748b', textAlign: 'center' }}>
                  üí° Les modifications sont sauvegard√©es automatiquement lors de la fermeture
                </p>
              </div>
            </div>
          </div>
        </div>
      )}
      {/* Modal Export - Choix entre tout ou individuel */}
      {showExportModal && (
        <div className="modal-overlay" onClick={() => setShowExportModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
            <div className="modal-header">
              <h3>üìä Options d'Export {exportType === 'pdf' ? 'PDF' : 'Excel'}</h3>
              <Button variant="ghost" onClick={() => setShowExportModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body" style={{padding: '2rem'}}>
              <p style={{marginBottom: '1.5rem', color: '#64748b'}}>
                Que souhaitez-vous exporter ?
              </p>
              
              {/* Choix : Tout le personnel */}
              <label 
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '1rem',
                  padding: '1.5rem',
                  border: exportScope === 'all' ? '2px solid #FCA5A5' : '2px solid #E5E7EB',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  marginBottom: '1rem',
                  background: exportScope === 'all' ? '#FEF2F2' : 'white',
                  transition: 'all 0.2s ease'
                }}
              >
                <input
                  type="radio"
                  name="exportScope"
                  value="all"
                  checked={exportScope === 'all'}
                  onChange={(e) => setExportScope(e.target.value)}
                  style={{width: '20px', height: '20px', cursor: 'pointer'}}
                />
                <span style={{fontSize: '1.5rem'}}>üìã</span>
                <div style={{flex: 1}}>
                  <div style={{fontWeight: '600', fontSize: '1rem'}}>Tout le personnel</div>
                  <div style={{fontSize: '0.875rem', color: '#64748b'}}>
                    Exporter la liste compl√®te ({users.length} pompier{users.length > 1 ? 's' : ''})
                  </div>
                </div>
              </label>

              {/* Choix : Une personne sp√©cifique */}
              <label 
                style={{
                  display: 'flex',
                  alignItems: 'flex-start',
                  gap: '1rem',
                  padding: '1.5rem',
                  border: exportScope === 'individual' ? '2px solid #FCA5A5' : '2px solid #E5E7EB',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  background: exportScope === 'individual' ? '#FEF2F2' : 'white',
                  transition: 'all 0.2s ease'
                }}
              >
                <input
                  type="radio"
                  name="exportScope"
                  value="individual"
                  checked={exportScope === 'individual'}
                  onChange={(e) => setExportScope(e.target.value)}
                  style={{width: '20px', height: '20px', cursor: 'pointer', marginTop: '0.25rem'}}
                />
                <span style={{fontSize: '1.5rem'}}>üë§</span>
                <div style={{flex: 1}}>
                  <div style={{fontWeight: '600', fontSize: '1rem', marginBottom: '0.5rem'}}>
                    Une personne sp√©cifique
                  </div>
                  {exportScope === 'individual' && (
                    <select
                      value={selectedPersonForExport}
                      onChange={(e) => setSelectedPersonForExport(e.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.5rem',
                        borderRadius: '6px',
                        border: '1px solid #E5E7EB',
                        fontSize: '0.9rem',
                        cursor: 'pointer'
                      }}
                    >
                      <option value="">-- S√©lectionner une personne --</option>
                      {users.map(user => (
                        <option key={user.id} value={user.id}>
                          {user.prenom} {user.nom} - {user.grade}
                        </option>
                      ))}
                    </select>
                  )}
                </div>
              </label>

              <div style={{marginTop: '1.5rem', display: 'flex', gap: '0.5rem', justifyContent: 'flex-end'}}>
                <Button variant="outline" onClick={() => setShowExportModal(false)}>
                  Annuler
                </Button>
                <Button onClick={handleConfirmExport}>
                  {exportType === 'pdf' ? 'üìÑ' : 'üìä'} Exporter
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}
      {/* Modal de validation de comp√©tence */}
      {showValidateCompetenceModal && selectedUser && (
        <div className="modal-overlay" onClick={() => setShowValidateCompetenceModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '550px' }}>
            <div className="modal-header">
              <h3>‚úÖ Valider une Comp√©tence</h3>
              <Button variant="ghost" onClick={() => setShowValidateCompetenceModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <p style={{ marginBottom: '1rem', padding: '0.75rem', background: '#f8fafc', borderRadius: '6px', fontSize: '0.875rem' }}>
                <strong>Employ√©:</strong> {selectedUser.prenom} {selectedUser.nom}
              </p>
              
              <div style={{ marginBottom: '1rem', padding: '1rem', background: '#fef3c7', borderRadius: '8px', border: '1px solid #fbbf24' }}>
                <p style={{ fontSize: '0.875rem', color: '#92400e', margin: 0 }}>
                  ‚ö†Ô∏è <strong>Important:</strong> Cette validation manuelle permet de marquer qu'un employ√© a acquis une comp√©tence 
                  par un moyen externe (formation externe, √©quivalence, exp√©rience, etc.). 
                  Une justification est obligatoire pour la tra√ßabilit√©.
                </p>
              </div>

              <div className="form-field" style={{ marginBottom: '1rem' }}>
                <Label>Comp√©tence *</Label>
                <select
                  value={newValidation.competence_id}
                  onChange={(e) => setNewValidation({...newValidation, competence_id: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '6px',
                    border: '1px solid #cbd5e1',
                    fontSize: '0.875rem'
                  }}
                >
                  <option value="">-- S√©lectionner une comp√©tence --</option>
                  {competences.map(comp => (
                    <option key={comp.id} value={comp.id}>{comp.nom}</option>
                  ))}
                </select>
              </div>

              <div className="form-field" style={{ marginBottom: '1rem' }}>
                <Label>Justification * (Formation externe, √©quivalence, etc.)</Label>
                <textarea
                  value={newValidation.justification}
                  onChange={(e) => setNewValidation({...newValidation, justification: e.target.value})}
                  placeholder="Ex: Formation externe suivie chez XYZ le 15/10/2024 - Certificat disponible"
                  rows="4"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '6px',
                    border: '1px solid #cbd5e1',
                    fontSize: '0.875rem',
                    fontFamily: 'inherit',
                    resize: 'vertical'
                  }}
                />
                <small style={{ color: '#64748b', fontSize: '0.75rem', marginTop: '0.25rem', display: 'block' }}>
                  D√©crivez pr√©cis√©ment comment la comp√©tence a √©t√© acquise (o√π, quand, document justificatif)
                </small>
              </div>

              <div className="form-field" style={{ marginBottom: '1rem' }}>
                <Label>Date de validation *</Label>
                <Input
                  type="date"
                  value={newValidation.date_validation}
                  onChange={(e) => setNewValidation({...newValidation, date_validation: e.target.value})}
                />
              </div>
            </div>
            <div className="modal-footer">
              <Button variant="outline" onClick={() => setShowValidateCompetenceModal(false)}>
                Annuler
              </Button>
              <Button onClick={handleValidateCompetence}>
                ‚úÖ Valider la Comp√©tence
              </Button>
            </div>
          </div>
        </div>
      )}
      
      {/* Modal de validation de comp√©tence / rattrapage */}
      {showValidateCompetenceModal && selectedUser && (
        <div className="modal-overlay" onClick={() => setShowValidateCompetenceModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '550px' }}>
            <div className="modal-header">
              <h3>üéñÔ∏è Enregistrer un Rattrapage</h3>
              <Button variant="ghost" onClick={() => setShowValidateCompetenceModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <p style={{ marginBottom: '1rem', color: '#64748b' }}>
                Employ√©: <strong>{selectedUser.prenom} {selectedUser.nom}</strong>
              </p>
              
              <div className="form-field">
                <Label>Comp√©tence</Label>
                <select
                  value={newValidation.competence_id}
                  onChange={(e) => setNewValidation({...newValidation, competence_id: e.target.value})}
                  className="form-select"
                >
                  <option value="">S√©lectionner une comp√©tence</option>
                  {competences.map(comp => (
                    <option key={comp.id} value={comp.id}>{comp.nom}</option>
                  ))}
                </select>
              </div>
              
              <div className="form-field">
                <Label>Justification</Label>
                <textarea
                  value={newValidation.justification}
                  onChange={(e) => setNewValidation({...newValidation, justification: e.target.value})}
                  placeholder="Expliquez pourquoi cette comp√©tence doit √™tre valid√©e manuellement..."
                  rows="4"
                  className="form-input"
                />
              </div>
              
              <div className="form-field">
                <Label>Date de validation</Label>
                <Input
                  type="date"
                  value={newValidation.date_validation}
                  onChange={(e) => setNewValidation({...newValidation, date_validation: e.target.value})}
                />
              </div>
            </div>
            
            <div className="modal-footer">
              <Button variant="outline" onClick={() => setShowValidateCompetenceModal(false)}>
                Annuler
              </Button>
              <Button onClick={handleValidateCompetence}>
                ‚úÖ Enregistrer
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Planning Component optimis√© - Vue moderne avec code couleur
const Planning = () => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const backendUrl = process.env.REACT_APP_BACKEND_URL || '';
  const token = localStorage.getItem('token');
  
  const [currentWeek, setCurrentWeek] = useState(() => {
    const today = new Date();
    // Utiliser UTC pour √©viter les probl√®mes de fuseau horaire
    const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
    const dayOfWeek = todayUTC.getUTCDay(); // 0 = dimanche, 1 = lundi, etc.
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const monday = new Date(todayUTC);
    monday.setUTCDate(todayUTC.getUTCDate() + daysToMonday);
    return monday.toISOString().split('T')[0];
  });
  const [currentMonth, setCurrentMonth] = useState(() => {
    const today = new Date();
    return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
  });
  const [viewMode, setViewMode] = useState('mois'); // 'semaine' ou 'mois' - D√©faut: mois
  const [displayMode] = useState('calendrier'); // Vue calendrier uniquement (liste supprim√©e car moins lisible)
  const [searchFilter, setSearchFilter] = useState('');
  const [showSearchSuggestions, setShowSearchSuggestions] = useState(false);
  const [selectedUserId, setSelectedUserId] = useState(null);
  
  // Fermer les suggestions quand on clique ailleurs
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (showSearchSuggestions && !e.target.closest('.search-container')) {
        setShowSearchSuggestions(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showSearchSuggestions]);
  const [typeGardeFilter, setTypeGardeFilter] = useState('');
  const [typesGarde, setTypesGarde] = useState([]);
  const [assignations, setAssignations] = useState([]);
  const [users, setUsers] = useState([]);
  const [grades, setGrades] = useState([]);  // Pour v√©rifier si un utilisateur est officier
  const [loading, setLoading] = useState(true);
  const [showAssignModal, setShowAssignModal] = useState(false);
  const [showGardeDetailsModal, setShowGardeDetailsModal] = useState(false);
  const [showAdvancedAssignModal, setShowAdvancedAssignModal] = useState(false);
  const [showAutoAttributionModal, setShowAutoAttributionModal] = useState(false);
  const [showRapportHeuresModal, setShowRapportHeuresModal] = useState(false);
  const [autoAttributionConfig, setAutoAttributionConfig] = useState({
    periode: 'semaine', // semaine ou mois
    periodeLabel: '', // 'Semaine actuelle', 'Semaine suivante', 'Mois actuel', 'Mois suivant'
    date: currentWeek,
    mode: 'completer', // 'completer' ou 'reinitialiser'
    mode: 'completer' // 'completer' ou 'reinitialiser'
  });
  const [advancedAssignConfig, setAdvancedAssignConfig] = useState({
    user_id: '',
    type_garde_ids: [], // Chang√© en array pour multi-s√©lection
    recurrence_type: 'unique', // unique, hebdomadaire, bihebdomadaire, mensuelle, annuelle, personnalisee
    jours_semaine: [], // pour r√©currence hebdomadaire/bihebdomadaire (s√©lection multiple)
    bi_hebdomadaire: false, // une semaine sur deux (obsol√®te, utilis√© par bihebdomadaire maintenant)
    recurrence_intervalle: 1, // pour personnalis√©e
    recurrence_frequence: 'jours', // pour personnalis√©e: jours, semaines, mois, ans
    date_debut: '',
    date_fin: '',
    exceptions: [] // dates d'exception
  });

  // √âtats pour formatage planning (demo uniquement)
  const [showFormatageSection, setShowFormatageSection] = useState(false);
  const [moisFormatage, setMoisFormatage] = useState(() => {
    const today = new Date();
    return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
  });

  const [userSearchQuery, setUserSearchQuery] = useState('');
  const [showUserDropdown, setShowUserDropdown] = useState(false);
  const [quickAssignSearchQuery, setQuickAssignSearchQuery] = useState('');
  const [showQuickAssignDropdown, setShowQuickAssignDropdown] = useState(false);
  const [selectedSlot, setSelectedSlot] = useState(null);
  const [selectedGardeDetails, setSelectedGardeDetails] = useState(null);
  const [attributionLoading, setAttributionLoading] = useState(false);
  const [attributionStep, setAttributionStep] = useState('');
  const [showAuditModal, setShowAuditModal] = useState(false);
  const [selectedAuditAssignation, setSelectedAuditAssignation] = useState(null);
  const [auditNotesEdit, setAuditNotesEdit] = useState('');
  const { toast } = useToast();

  // Fonction pour calculer l'aper√ßu des dates de r√©currence
  const calculateRecurrenceDates = () => {
    if (!advancedAssignConfig.date_debut || !advancedAssignConfig.recurrence_type) {
      return [];
    }

    const dates = [];
    const startDate = new Date(advancedAssignConfig.date_debut);
    const endDate = advancedAssignConfig.date_fin 
      ? new Date(advancedAssignConfig.date_fin)
      : new Date(startDate.getTime() + 365 * 24 * 60 * 60 * 1000); // 1 an max pour aper√ßu
    
    let currentDate = new Date(startDate);
    const maxDates = 10; // Afficher max 10 dates

    // Mapper les jours
    const dayMap = {
      'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4,
      'friday': 5, 'saturday': 6, 'sunday': 0
    };

    if (advancedAssignConfig.recurrence_type === 'unique') {
      dates.push(new Date(startDate));
    } 
    else if (advancedAssignConfig.jour_specifique) {
      // Avec jour sp√©cifique
      const targetDay = dayMap[advancedAssignConfig.jour_specifique];
      
      if (advancedAssignConfig.recurrence_type === 'hebdomadaire') {
        while (currentDate <= endDate && dates.length < maxDates) {
          if (currentDate.getDay() === targetDay) {
            dates.push(new Date(currentDate));
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }
      } else if (advancedAssignConfig.recurrence_type === 'bihebdomadaire') {
        let weekCount = 0;
        let lastWeekStart = null;
        
        while (currentDate <= endDate && dates.length < maxDates) {
          const weekStart = new Date(currentDate);
          weekStart.setDate(currentDate.getDate() - currentDate.getDay());
          
          if (lastWeekStart === null || weekStart.getTime() !== lastWeekStart.getTime()) {
            if (lastWeekStart !== null) weekCount++;
            lastWeekStart = new Date(weekStart);
          }
          
          if (currentDate.getDay() === targetDay && weekCount % 2 === 0) {
            dates.push(new Date(currentDate));
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }
      } else if (advancedAssignConfig.recurrence_type === 'personnalisee') {
        const interval = advancedAssignConfig.recurrence_intervalle || 1;
        const freq = advancedAssignConfig.recurrence_frequence || 'semaines';
        
        // Trouver le premier jour correspondant
        while (currentDate.getDay() !== targetDay && currentDate <= endDate) {
          currentDate.setDate(currentDate.getDate() + 1);
        }
        
        while (currentDate <= endDate && dates.length < maxDates) {
          dates.push(new Date(currentDate));
          
          if (freq === 'jours') {
            currentDate.setDate(currentDate.getDate() + interval);
          } else if (freq === 'semaines') {
            currentDate.setDate(currentDate.getDate() + (interval * 7));
          } else if (freq === 'mois') {
            currentDate.setMonth(currentDate.getMonth() + interval);
          } else if (freq === 'ans') {
            currentDate.setFullYear(currentDate.getFullYear() + interval);
          }
        }
      }
    }

    return dates;
  };

  // Fonction pour sugg√©rer le prochain jour sp√©cifique
  const getSuggestedNextDay = () => {
    if (!advancedAssignConfig.jour_specifique || !advancedAssignConfig.date_debut) {
      return null;
    }

    const dayMap = {
      'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4,
      'friday': 5, 'saturday': 6, 'sunday': 0
    };
    const dayNameMap = {
      'monday': 'lundi', 'tuesday': 'mardi', 'wednesday': 'mercredi',
      'thursday': 'jeudi', 'friday': 'vendredi', 'saturday': 'samedi', 'sunday': 'dimanche'
    };

    const startDate = new Date(advancedAssignConfig.date_debut);
    const targetDay = dayMap[advancedAssignConfig.jour_specifique];
    const startDay = startDate.getDay();

    if (startDay === targetDay) {
      return null; // D√©j√† le bon jour
    }

    // Calculer le prochain jour correspondant
    let daysToAdd = targetDay - startDay;
    if (daysToAdd < 0) daysToAdd += 7;

    const suggestedDate = new Date(startDate);
    suggestedDate.setDate(startDate.getDate() + daysToAdd);

    return {
      date: suggestedDate,
      formatted: suggestedDate.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
      dayName: dayNameMap[advancedAssignConfig.jour_specifique]
    };
  };

  const weekDays = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
  const weekDaysEn = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  
  const weekDates = Array.from({ length: 7 }, (_, i) => {
    const [year, month, day] = currentWeek.split('-').map(Number);
    // Utiliser Date.UTC pour √©viter les probl√®mes de fuseau horaire
    const date = new Date(Date.UTC(year, month - 1, day + i));
    return date;
  });

  // G√©n√©rer les dates du mois pour la vue mois (calendrier commen√ßant le lundi)
  const monthDates = (() => {
    if (viewMode !== 'mois') return [];
    
    const [year, month] = currentMonth.split('-').map(Number);
    
    // Utiliser UTC pour √©viter les probl√®mes de fuseau horaire
    const firstDay = new Date(Date.UTC(year, month - 1, 1));
    const lastDay = new Date(Date.UTC(year, month, 0));
    const dates = [];
    
    // Calculer le jour de la semaine du premier jour (0 = dimanche, 1 = lundi, etc.)
    let firstDayOfWeek = firstDay.getUTCDay();
    // Convertir pour que lundi = 0, dimanche = 6
    firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
    
    // Ajouter les jours vides au d√©but pour commencer √† lundi
    for (let i = 0; i < firstDayOfWeek; i++) {
      dates.push(null); // Jours vides
    }
    
    // Ajouter tous les jours du mois en UTC
    for (let day = 1; day <= lastDay.getUTCDate(); day++) {
      dates.push(new Date(Date.UTC(year, month - 1, day, 12, 0, 0))); // Midi UTC pour √©viter les d√©calages
    }
    
    return dates;
  })();

  useEffect(() => {
    fetchPlanningData();
  }, [currentWeek, currentMonth, viewMode, tenantSlug]);

  const fetchPlanningData = async () => {
    if (!tenantSlug) return;
    
    setLoading(true);
    try {
      const dateRange = viewMode === 'mois' ? 
        `${currentMonth}-01` : // Premier jour du mois
        currentWeek;
        
      const [typesData, assignationsData, usersData, gradesData] = await Promise.all([
        apiGet(tenantSlug, '/types-garde'),
        apiGet(tenantSlug, `/planning/assignations/${dateRange}`),
        apiGet(tenantSlug, '/users'), // Tous les r√¥les peuvent voir les users (lecture seule)
        apiGet(tenantSlug, '/grades') // Pour v√©rifier si un utilisateur est officier
      ]);
      
      setTypesGarde(typesData);
      setAssignations(assignationsData);
      setUsers(usersData);
      setGrades(gradesData || []);
    } catch (error) {
      console.error('Erreur lors du chargement du planning:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger le planning",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  const getGardeCoverage = (date, typeGarde) => {
    const dateStr = date.toISOString().split('T')[0];
    const gardeAssignations = assignations.filter(a => 
      a.date === dateStr && a.type_garde_id === typeGarde.id
    );
    
    const assigned = gardeAssignations.length;
    const required = typeGarde.personnel_requis;
    
    if (assigned === 0) return 'vacante';
    if (assigned >= required) return 'complete';
    return 'partielle';
  };

  const getCoverageColor = (coverage) => {
    switch (coverage) {
      case 'complete': return '#10B981'; // Vert
      case 'partielle': return '#F59E0B'; // Jaune
      case 'vacante': return '#EF4444'; // Rouge
      default: return '#6B7280';
    }
  };

  const handleNettoyerAssignationsInvalides = async () => {
    if (user.role !== 'admin') {
      toast({
        title: "Acc√®s refus√©",
        description: "Cette action est r√©serv√©e aux administrateurs",
        variant: "destructive"
      });
      return;
    }

    try {
      // D'abord, obtenir le rapport
      toast({
        title: "Analyse en cours...",
        description: "Recherche d'assignations invalides"
      });

      const rapportResponse = await fetch(buildApiUrl(tenantSlug, '/planning/rapport-assignations-invalides'), {
        headers: {
          'Authorization': `Bearer ${getTenantToken()}`
        }
      });

      if (!rapportResponse.ok) {
        throw new Error('Erreur lors de l\'analyse');
      }

      const rapport = await rapportResponse.json();
      const count = rapport.statistiques.assignations_invalides;

      if (count === 0) {
        toast({
          title: "Aucune assignation invalide",
          description: "Toutes les assignations respectent les jours d'application",
          variant: "success"
        });
        return;
      }

      // Confirmer avec le nombre trouv√©
      if (!window.confirm(`‚ö†Ô∏è ${count} assignation(s) invalide(s) d√©tect√©e(s)!\n\nElles ne respectent pas les jours d'application de leur type de garde.\n\nVoulez-vous les supprimer?\n\nCette action est irr√©versible.`)) {
        return;
      }

      toast({
        title: "Suppression en cours...",
        description: `Suppression de ${count} assignation(s)`
      });

      const response = await fetch(buildApiUrl(tenantSlug, '/planning/supprimer-assignations-invalides'), {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${getTenantToken()}`,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error('Erreur lors de la suppression');
      }

      const data = await response.json();

      toast({
        title: "‚úÖ Nettoyage termin√©",
        description: `${data.deleted_count} assignation(s) supprim√©e(s). Rechargement de la page...`,
        variant: "success"
      });

      // Recharger la page pour mettre √† jour toutes les donn√©es
      setTimeout(() => {
        window.location.reload();
      }, 1500);
      
    } catch (error) {
      console.error('Erreur nettoyage:', error);
      toast({
        title: "Erreur",
        description: error.message || "Impossible de nettoyer les assignations",
        variant: "destructive"
      });
    }
  };


  // Fonction pour formater le planning (demo uniquement)
  const handleFormaterPlanning = async () => {
    if (tenantSlug !== 'demo') {
      alert('Cette fonctionnalit√© est r√©serv√©e au tenant demo');
      return;
    }

    if (user.role !== 'admin') {
      alert('Acc√®s r√©serv√© aux administrateurs');
      return;
    }

    const confirmation = window.confirm(
      `‚ö†Ô∏è ATTENTION\n\nVous √™tes sur le point de SUPPRIMER toutes les assignations et demandes de remplacement du mois ${moisFormatage}.\n\nCette action est IRR√âVERSIBLE.\n\nConfirmer?`
    );

    if (!confirmation) return;

    try {
      const response = await apiDelete(tenantSlug, `/planning/formater-mois?mois=${moisFormatage}`);

      alert(`‚úÖ ${response.message}\n\n` +
            `üìä R√©sum√©:\n` +
            `- ${response.assignations_supprimees} assignation(s) supprim√©e(s)\n` +
            `- ${response.demandes_supprimees} demande(s) de remplacement supprim√©e(s)`);
      
      // Recharger la page
      window.location.reload();
    } catch (error) {
      console.error('Erreur formatage planning:', error);
      alert('‚ùå Erreur lors du formatage: ' + error.message);
    }
  };

  const handleAttributionAuto = async () => {
    if (user.role === 'employe') return;

    try {
      // Activer l'overlay de chargement
      setAttributionLoading(true);
      setShowAutoAttributionModal(false);
      setAttributionStep('üìã Initialisation...');
      
      // Calculer la plage de dates selon la p√©riode
      let semaine_debut, semaine_fin;
      
      if (autoAttributionConfig.periode === 'semaine') {
        // Pour une semaine: date de d√©but = lundi, date de fin = dimanche
        const monday = new Date(autoAttributionConfig.date);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        semaine_debut = monday.toISOString().split('T')[0];
        semaine_fin = sunday.toISOString().split('T')[0];
      } else {
        // Pour un mois: calculer toutes les semaines du mois
        const [year, month] = autoAttributionConfig.date.split('-');
        const firstDay = new Date(parseInt(year), parseInt(month) - 1, 1);
        const lastDay = new Date(parseInt(year), parseInt(month), 0);
        
        // Trouver le lundi de la premi√®re semaine du mois
        const firstMonday = new Date(firstDay);
        firstMonday.setDate(firstDay.getDate() - firstDay.getDay() + (firstDay.getDay() === 0 ? -6 : 1));
        
        // Trouver le dimanche de la derni√®re semaine du mois
        const lastSunday = new Date(lastDay);
        lastSunday.setDate(lastDay.getDate() + (7 - lastDay.getDay()) % 7);
        
        semaine_debut = firstMonday.toISOString().split('T')[0];
        semaine_fin = lastSunday.toISOString().split('T')[0];
      }
      
      // Lancer l'attribution automatique avec le param√®tre reset
      const resetParam = autoAttributionConfig.mode === 'reinitialiser' ? '&reset=True' : '';
      const initResponse = await apiPost(
        tenantSlug, 
        `/planning/attribution-auto?semaine_debut=${semaine_debut}&semaine_fin=${semaine_fin}${resetParam}`, 
        {}
      );
      
      // R√©cup√©rer le task_id et l'URL du stream
      const { task_id, stream_url } = initResponse;
      
      if (!task_id) {
        throw new Error("Aucun task_id re√ßu du serveur");
      }
      
      setAttributionStep('üöÄ Attribution lanc√©e - connexion au flux temps r√©el...');
      
      // Se connecter au flux SSE pour recevoir les mises √† jour
      const backendUrl = process.env.REACT_APP_BACKEND_URL || '';
      const eventSource = new EventSource(`${backendUrl}${stream_url}`);
      
      eventSource.onmessage = (event) => {
        try {
          const progress = JSON.parse(event.data);
          
          // Mettre √† jour l'affichage avec la progression en temps r√©el
          setAttributionStep(
            `${progress.current_step} (${progress.progress_percentage}% - ${progress.elapsed_time})`
          );
          
          // Si termin√©, fermer la connexion
          if (progress.status === 'termine') {
            eventSource.close();
            
            // D√©sactiver l'overlay
            setAttributionLoading(false);
            setAttributionStep('');
            
            // Message personnalis√© selon le mode
            const successMessage = autoAttributionConfig.mode === 'reinitialiser' 
              ? `Planning r√©initialis√© ! ${progress.assignations_creees} assignation(s) cr√©√©e(s)`
              : `${progress.assignations_creees} assignation(s) cr√©√©e(s) pour ${autoAttributionConfig.periodeLabel}`;
            
            toast({
              title: autoAttributionConfig.mode === 'reinitialiser' ? "Planning r√©initialis√©" : "Attribution automatique r√©ussie",
              description: successMessage,
              variant: "success"
            });

            // R√©initialiser la config
            setAutoAttributionConfig({
              periode: 'semaine',
              periodeLabel: '',
              date: currentWeek,
              mode: 'completer'
            });
            fetchPlanningData();
          }
          
          // Si erreur, fermer la connexion
          if (progress.status === 'erreur') {
            eventSource.close();
            
            setAttributionLoading(false);
            setAttributionStep('');
            
            toast({
              title: "Erreur d'attribution",
              description: progress.error_message || "Une erreur s'est produite",
              variant: "destructive"
            });
          }
        } catch (parseError) {
          console.error('Erreur parsing SSE:', parseError);
        }
      };
      
      eventSource.onerror = (error) => {
        console.error('Erreur SSE:', error);
        eventSource.close();
        
        setAttributionLoading(false);
        setAttributionStep('');
        
        toast({
          title: "Erreur de connexion",
          description: "La connexion au serveur a √©t√© interrompue",
          variant: "destructive"
        });
      };
      
    } catch (error) {
      // D√©sactiver l'overlay en cas d'erreur
      setAttributionLoading(false);
      setAttributionStep('');
      
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Erreur lors de l'attribution automatique",
        variant: "destructive"
      });
    }
  };

  const handleRemoveAllPersonnelFromGarde = async () => {
    console.log('selectedGardeDetails:', selectedGardeDetails);
    console.log('assignations:', selectedGardeDetails.assignations);
    
    if (!selectedGardeDetails.assignations || selectedGardeDetails.assignations.length === 0) {
      toast({
        title: "Aucun personnel",
        description: "Il n'y a aucun personnel assign√© √† cette garde",
        variant: "default"
      });
      return;
    }

    if (!window.confirm(`√ätes-vous s√ªr de vouloir supprimer TOUT le personnel de cette garde ?\n\nCela supprimera ${selectedGardeDetails.assignations.length} assignation(s) pour la ${selectedGardeDetails.typeGarde.nom} du ${selectedGardeDetails.date.toLocaleDateString('fr-FR')}.`)) {
      return;
    }

    try {
      // V√©rifier que chaque assignation a un ID
      const assignationsWithIds = selectedGardeDetails.assignations.filter(a => a.id);
      
      if (assignationsWithIds.length === 0) {
        toast({
          title: "Erreur technique",
          description: "Les assignations n'ont pas d'ID - impossible de les supprimer",
          variant: "destructive"
        });
        return;
      }

      console.log('Deleting assignations with IDs:', assignationsWithIds.map(a => a.id));

      // Supprimer toutes les assignations de cette garde
      const deletePromises = assignationsWithIds.map(assignation => 
        apiDelete(tenantSlug, `/planning/assignation/${assignation.id}`)
      );

      await Promise.all(deletePromises);
      
      toast({
        title: "Personnel supprim√©",
        description: `Tout le personnel (${assignationsWithIds.length} personne(s)) a √©t√© retir√© de cette garde`,
        variant: "success"
      });

      // Fermer le modal et recharger les donn√©es
      setShowGardeDetailsModal(false);
      fetchPlanningData();
      
    } catch (error) {
      console.error('Error removing all personnel:', error);
      toast({
        title: "Erreur",
        description: error.detail || error.message || "Impossible de supprimer le personnel de cette garde",
        variant: "destructive"
      });
    }
  };

  const handleRemovePersonFromGarde = async (personId, gardeName) => {
    if (!window.confirm(`√ätes-vous s√ªr de vouloir retirer cette personne de la garde ${gardeName} ?`)) {
      return;
    }

    try {
      // Trouver l'assignation √† supprimer
      const assignationToRemove = selectedGardeDetails.assignations.find(a => a.user_id === personId);
      
      if (!assignationToRemove) {
        toast({
          title: "Erreur",
          description: "Assignation non trouv√©e",
          variant: "destructive"
        });
        return;
      }

      await apiDelete(tenantSlug, `/planning/assignation/${assignationToRemove.id}`);
      
      toast({
        title: "Personne retir√©e",
        description: "La personne a √©t√© retir√©e de cette garde avec succ√®s",
        variant: "success"
      });

      // Fermer le modal et recharger les donn√©es
      setShowGardeDetailsModal(false);
      fetchPlanningData();
      
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.detail || error.message || "Impossible de retirer la personne",
        variant: "destructive"
      });
    }
  };

  const handleAssignUser = async (userId, typeGardeId, date) => {
    if (user.role === 'employe') return;

    try {
      await apiPost(tenantSlug, '/planning/assignation', {
        user_id: userId,
        type_garde_id: typeGardeId,
        date: date,
        assignation_type: "manuel"
      });

      toast({
        title: "Attribution r√©ussie",
        description: "L'assignation a √©t√© cr√©√©e avec succ√®s",
        variant: "success"
      });

      fetchPlanningData();
      setShowAssignModal(false);
    } catch (error) {
      toast({
        title: "Erreur d'attribution",
        description: "Impossible de cr√©er l'assignation",
        variant: "destructive"
      });
    }
  };

  const handleAdvancedAssignment = async () => {
    if (user.role === 'employe') return;

    // Validation des champs requis
    if (!advancedAssignConfig.user_id || advancedAssignConfig.type_garde_ids.length === 0 || !advancedAssignConfig.date_debut) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir tous les champs obligatoires (utilisateur, au moins un type de garde, date de d√©but)",
        variant: "destructive"
      });
      return;
    }

    // Validation sp√©cifique pour r√©currence hebdomadaire
    if (advancedAssignConfig.recurrence_type === 'hebdomadaire' && advancedAssignConfig.jours_semaine.length === 0) {
      toast({
        title: "Jours requis",
        description: "Veuillez s√©lectionner au moins un jour de la semaine",
        variant: "destructive"
      });
      return;
    }

    // V√©rification des chevauchements d'horaires entre les types de garde s√©lectionn√©s
    const selectedTypesGarde = typesGarde.filter(tg => advancedAssignConfig.type_garde_ids.includes(tg.id));
    let hasOverlap = false;
    
    for (let i = 0; i < selectedTypesGarde.length; i++) {
      for (let j = i + 1; j < selectedTypesGarde.length; j++) {
        const tg1 = selectedTypesGarde[i];
        const tg2 = selectedTypesGarde[j];
        
        // V√©rifier si les horaires se chevauchent (si les champs existent)
        if (tg1.heure_debut && tg1.heure_fin && tg2.heure_debut && tg2.heure_fin) {
          const start1 = tg1.heure_debut;
          const end1 = tg1.heure_fin;
          const start2 = tg2.heure_debut;
          const end2 = tg2.heure_fin;
          
          // Chevauchement si: start1 < end2 AND start2 < end1
          if (start1 < end2 && start2 < end1) {
            hasOverlap = true;
            break;
          }
        }
      }
      if (hasOverlap) break;
    }
    
    // Avertir si chevauchement mais permettre quand m√™me
    if (hasOverlap) {
      toast({
        title: "‚ö†Ô∏è Attention - Horaires qui se chevauchent",
        description: "Certains types de garde s√©lectionn√©s ont des horaires qui se chevauchent. L'assignation sera quand m√™me cr√©√©e.",
        variant: "warning",
        duration: 5000
      });
    }

    try {
      // Cr√©er une assignation pour chaque type de garde s√©lectionn√©
      const promises = advancedAssignConfig.type_garde_ids.map(type_garde_id => {
        const assignmentData = {
          user_id: advancedAssignConfig.user_id,
          type_garde_id: type_garde_id,
          recurrence_type: advancedAssignConfig.recurrence_type,
          date_debut: advancedAssignConfig.date_debut,
          date_fin: advancedAssignConfig.date_fin || advancedAssignConfig.date_debut,
          jours_semaine: advancedAssignConfig.jours_semaine,
          bi_hebdomadaire: advancedAssignConfig.bi_hebdomadaire,
          recurrence_intervalle: advancedAssignConfig.recurrence_intervalle,
          recurrence_frequence: advancedAssignConfig.recurrence_frequence,
          assignation_type: "manuel_avance"
        };
        
        return apiPost(tenantSlug, '/planning/assignation-avancee', assignmentData);
      });
      
      await Promise.all(promises);

      const selectedUser = users.find(u => u.id === advancedAssignConfig.user_id);
      const selectedTypesNames = selectedTypesGarde.map(tg => tg.nom).join(', ');
      
      toast({
        title: "Assignations avanc√©es cr√©√©es",
        description: `${selectedUser?.prenom} ${selectedUser?.nom} assign√©(e) pour ${advancedAssignConfig.type_garde_ids.length} type(s) de garde: ${selectedTypesNames} (${advancedAssignConfig.recurrence_type})`,
        variant: "success"
      });

      // Reset du formulaire
      setAdvancedAssignConfig({
        user_id: '',
        type_garde_ids: [],
        jour_specifique: '',
        recurrence_type: 'unique',
        jours_semaine: [],
        bi_hebdomadaire: false,
        recurrence_intervalle: 1,
        recurrence_frequence: 'jours',
        date_debut: '',
        date_fin: '',
        exceptions: []
      });

      setShowAdvancedAssignModal(false);
      fetchPlanningData();
    } catch (error) {
      toast({
        title: "Erreur d'assignation",
        description: error.response?.data?.detail || "Impossible de cr√©er l'assignation avanc√©e",
        variant: "destructive"
      });
    }
  };

  const getAssignationForSlot = (date, typeGardeId) => {
    const dateStr = date.toISOString().split('T')[0];
    return assignations.find(a => a.date === dateStr && a.type_garde_id === typeGardeId);
  };

  const getUserById = (userId) => {
    return users.find(u => u.id === userId);
  };

  const shouldShowTypeGardeForDay = (typeGarde, dayIndex) => {
    // Si pas de jours d'application sp√©cifi√©s, afficher tous les jours
    if (!typeGarde.jours_application || typeGarde.jours_application.length === 0) {
      return true;
    }
    
    // V√©rifier si le jour de la semaine est dans les jours d'application
    const dayNameEn = weekDaysEn[dayIndex];
    return typeGarde.jours_application.includes(dayNameEn);
  };

  const openGardeDetails = (date, typeGarde) => {
    const dateStr = date.toISOString().split('T')[0];
    const gardeAssignations = assignations.filter(a => 
      a.date === dateStr && a.type_garde_id === typeGarde.id
    );
    
    const personnelAssigne = gardeAssignations
      .map(a => {
        const person = getUserById(a.user_id);
        return person ? { ...person, assignation_id: a.id } : null;
      })
      .filter(p => p !== null);
    
    setSelectedGardeDetails({
      date,
      typeGarde,
      personnelAssigne,
      assignations: gardeAssignations
    });
    setShowGardeDetailsModal(true);
  };

  // Ouvrir le modal d'audit pour une assignation
  const openAuditModal = (assignation, person) => {
    console.log('openAuditModal appel√©', { assignation, person });
    
    if (!assignation) {
      console.error('Assignation manquante');
      toast({
        title: "Erreur",
        description: "Assignation introuvable",
        variant: "destructive"
      });
      return;
    }
    
    if (!assignation.justification) {
      console.error('Justification manquante', assignation);
      toast({
        title: "Justification indisponible",
        description: "Cette assignation ne contient pas de donn√©es d'audit. Elle a peut-√™tre √©t√© cr√©√©e avant l'activation de la fonctionnalit√© d'audit.",
        variant: "destructive"
      });
      return;
    }
    
    setSelectedAuditAssignation({
      ...assignation,
      person: person
    });
    setAuditNotesEdit(assignation.notes_admin || '');
    setShowAuditModal(true);
    console.log('Modal audit ouvert');
  };

  // Sauvegarder les notes admin
  const handleSaveAuditNotes = async () => {
    if (!selectedAuditAssignation) return;
    
    try {
      await apiPut(
        tenantSlug,
        `/assignations/${selectedAuditAssignation.id}/notes`,
        { notes: auditNotesEdit }
      );
      
      toast({
        title: "Notes enregistr√©es",
        description: "Les notes admin ont √©t√© mises √† jour avec succ√®s",
      });
      
      // Mettre √† jour localement
      setAssignations(prev => prev.map(a => 
        a.id === selectedAuditAssignation.id 
          ? { ...a, notes_admin: auditNotesEdit }
          : a
      ));
      
      // Mettre √† jour l'assignation s√©lectionn√©e
      setSelectedAuditAssignation(prev => ({
        ...prev,
        notes_admin: auditNotesEdit
      }));
      
    } catch (error) {
      console.error('Erreur sauvegarde notes:', error);
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder les notes",
        variant: "destructive"
      });
    }
  };

  // T√©l√©charger le rapport d'audit
  const handleDownloadAuditReport = async (format = 'pdf') => {
    try {
      const currentDate = new Date(currentWeek);
      const mois = currentDate.toISOString().slice(0, 7); // YYYY-MM
      
      const response = await fetch(
        `${BACKEND_URL}/api/${tenantSlug}/planning/rapport-audit?mois=${mois}&format=${format}`,
        {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem(`${tenantSlug}_token`)}`
          }
        }
      );
      
      if (!response.ok) {
        throw new Error('Erreur t√©l√©chargement rapport');
      }
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `audit_affectations_${mois}.${format === 'pdf' ? 'pdf' : 'xlsx'}`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      toast({
        title: "T√©l√©chargement r√©ussi",
        description: `Le rapport d'audit ${format.toUpperCase()} a √©t√© t√©l√©charg√©`,
      });
    } catch (error) {
      console.error('Erreur t√©l√©chargement rapport:', error);
      toast({
        title: "Erreur",
        description: "Impossible de t√©l√©charger le rapport d'audit",
        variant: "destructive"
      });
    }
  };

  const openAssignModal = (date, typeGarde) => {
    if (user.role === 'employe') return;
    setSelectedSlot({ date, typeGarde });
    setShowAssignModal(true);
  };

  const navigateWeek = (direction) => {
    const [year, month, day] = currentWeek.split('-').map(Number);
    const newDate = new Date(Date.UTC(year, month - 1, day));
    newDate.setUTCDate(newDate.getUTCDate() + (direction * 7));
    setCurrentWeek(newDate.toISOString().split('T')[0]);
  };

  const navigateMonth = (direction) => {
    const [year, month] = currentMonth.split('-').map(Number);
    const newDate = new Date(year, month - 1 + direction, 1);
    setCurrentMonth(`${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}`);
  };

  // Calcul des KPIs pour le mois affich√© dans le planning (currentMonth)
  const calculateKPIs = (monthString = currentMonth) => {
    const [year, month] = monthString.split('-').map(Number);
    
    // Calculer le d√©but et la fin du mois affich√©
    const targetMonthStart = new Date(year, month - 1, 1);
    const targetMonthEnd = new Date(year, month, 0);
    const monthLabel = targetMonthStart.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
    
    // Filtrer les assignations du mois cible
    const monthAssignations = assignations.filter(a => {
      const assignDate = new Date(a.date);
      return assignDate >= targetMonthStart && assignDate <= targetMonthEnd;
    });
    
    // Calculer les heures de personnel requises VS assign√©es
    const daysInMonth = targetMonthEnd.getDate();
    let heuresPersonnelRequises = 0;
    let heuresPersonnelAssignees = 0;
    let totalGardesTheoriques = 0;
    let gardesAvecPersonnel = 0;
    
    // Pour chaque jour du mois
    for (let day = 1; day <= daysInMonth; day++) {
      const currentDate = new Date(targetMonthStart.getFullYear(), targetMonthStart.getMonth(), day);
      const dateStr = currentDate.toISOString().split('T')[0];
      const dayIndex = currentDate.getUTCDay() === 0 ? 6 : currentDate.getUTCDay() - 1; // Lundi = 0
      
      // Pour chaque type de garde
      typesGarde.forEach(typeGarde => {
        // V√©rifier si cette garde est applicable ce jour-l√†
        const isApplicable = shouldShowTypeGardeForDay(typeGarde, dayIndex);
        
        if (isApplicable) {
          totalGardesTheoriques++;
          
          // Calculer la dur√©e de cette garde en heures
          let dureeGarde = 12; // d√©faut
          if (typeGarde.heure_debut && typeGarde.heure_fin) {
            const [heureDebut] = typeGarde.heure_debut.split(':').map(Number);
            const [heureFin] = typeGarde.heure_fin.split(':').map(Number);
            dureeGarde = heureFin > heureDebut ? heureFin - heureDebut : (24 - heureDebut) + heureFin;
          }
          
          const personnelRequis = typeGarde.personnel_requis || 1;
          
          // Heures de personnel requises pour cette garde
          heuresPersonnelRequises += dureeGarde * personnelRequis;
          
          // V√©rifier combien de personnes sont assign√©es
          const gardeAssignations = monthAssignations.filter(a => 
            a.date === dateStr && a.type_garde_id === typeGarde.id
          );
          
          // Heures de personnel assign√©es (nombre de personnes √ó dur√©e)
          heuresPersonnelAssignees += gardeAssignations.length * dureeGarde;
          
          // Compter les gardes avec au moins 1 personne
          if (gardeAssignations.length > 0) {
            gardesAvecPersonnel++;
          }
        }
      });
    }
    
    const gardesSansPersonnel = totalGardesTheoriques - gardesAvecPersonnel;
    
    // Calculer le taux de couverture bas√© sur les HEURES DE PERSONNEL
    const tauxCouverture = heuresPersonnelRequises > 0 
      ? Math.round((heuresPersonnelAssignees / heuresPersonnelRequises) * 100) 
      : 0;
    
    return {
      totalGardes: totalGardesTheoriques,
      quartsCouverts: gardesAvecPersonnel,
      quartsNonCouverts: gardesSansPersonnel,
      heuresTotales: Math.round(heuresPersonnelAssignees), // Heures assign√©es
      heuresRequises: Math.round(heuresPersonnelRequises), // Heures requises
      tauxCouverture, // Bas√© sur heures, pas gardes!
      membresActifs: new Set(monthAssignations.map(a => a.user_id)).size,
      monthLabel
    };
  };

  // KPIs calcul√©es automatiquement pour le mois affich√© (currentMonth)
  const kpis = calculateKPIs(currentMonth);

  // Fonctions d'export Planning
  const handleExportPDFPlanning = async () => {
    try {
      const periode = viewMode === 'semaine' ? currentWeek : currentMonth;
      
      const response = await fetch(
        buildApiUrl(tenantSlug, `/planning/export-pdf?periode=${periode}&type=${viewMode}`),
        {
          headers: {
            'Authorization': `Bearer ${getTenantToken()}`
          }
        }
      );
      
      if (!response.ok) throw new Error('Erreur g√©n√©ration rapport');
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      
      // Cr√©er un iframe cach√© pour d√©clencher l'impression
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      document.body.appendChild(iframe);
      
      // Attendre que le PDF soit charg√©, puis d√©clencher l'impression
      iframe.onload = () => {
        try {
          iframe.contentWindow.print();
          // Nettoyer apr√®s un d√©lai
          setTimeout(() => {
            document.body.removeChild(iframe);
            window.URL.revokeObjectURL(url);
          }, 1000);
        } catch (e) {
          console.error('Erreur impression:', e);
          document.body.removeChild(iframe);
          window.URL.revokeObjectURL(url);
        }
      };
      
    } catch (error) {
      console.error('Erreur export PDF planning:', error);
      toast({ 
        title: "Erreur", 
        description: `Impossible d'exporter le planning: ${error.message}`,
        variant: "destructive"
      });
    }
  };

  const handleExportExcelPlanning = async () => {
    try {
      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
      const token = getTenantToken();
      
      const periode = viewMode === 'semaine' ? currentWeek : currentMonth;
      const url = `${backendUrl}/api/${tenantSlug}/planning/export-excel?periode=${periode}&type=${viewMode}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur lors de l\'export');
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `planning_${viewMode}_${periode}.xlsx`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(downloadUrl);
      
      toast({ 
        title: "Succ√®s", 
        description: "Export Excel t√©l√©charg√©",
        variant: "success"
      });
    } catch (error) {
      toast({ 
        title: "Erreur", 
        description: "Impossible d'exporter l'Excel", 
        variant: "destructive" 
      });
    }
  };

  if (loading) return <div className="loading" data-testid="planning-loading">Chargement du planning...</div>;

  return (
    <div className="planning-refonte">
      {/* Header Moderne */}
      <div className="module-header">
        <div>
          <h1>üìÖ Planning des Gardes</h1>
          <p>Gestion des quarts de travail et assignations du personnel</p>
        </div>
      </div>

      {/* Section KPIs pour le mois affich√© */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        marginBottom: '1rem',
        padding: '0.75rem 1rem',
        background: 'white',
        borderRadius: '8px',
        border: '1px solid #E5E7EB'
      }}>
        <h3 style={{
          fontSize: '1.125rem',
          fontWeight: '600',
          color: '#1F2937',
          margin: 0
        }}>üìä Statistiques - {kpis.monthLabel}</h3>
      </div>

      {/* KPIs du Mois */}
      <div className="kpi-grid" style={{marginBottom: '2rem'}}>
        <div className="kpi-card" style={{background: '#D1FAE5'}}>
          <h3>{kpis.quartsCouverts} / {kpis.quartsNonCouverts}</h3>
          <p>Couverts / Non Couverts</p>
        </div>
        <div className="kpi-card" style={{background: '#DBEAFE'}}>
          <h3>{kpis.heuresTotales}h</h3>
          <p>Heures Totales Planifi√©es</p>
        </div>
        <div className="kpi-card" style={{background: '#FEF3C7'}}>
          <h3>{kpis.tauxCouverture}%</h3>
          <p>Taux de Couverture</p>
        </div>
      </div>

      {/* Barre de Contr√¥les Harmonis√©e */}
      <div className="personnel-controls" style={{marginBottom: '2rem'}}>
        <div style={{display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap'}}>
          {/* Recherche avec suggestions */}
          <div className="search-container" style={{flex: 1, minWidth: '300px', position: 'relative'}}>
            <Input 
              placeholder="üîç Rechercher un pompier..."
              value={searchFilter}
              onChange={e => setSearchFilter(e.target.value)}
              onFocus={() => setShowSearchSuggestions(true)}
            />
            {/* Dropdown de suggestions */}
            {showSearchSuggestions && searchFilter.trim() && (
              <div 
                style={{
                  position: 'absolute',
                  top: '100%',
                  left: 0,
                  right: 0,
                  background: 'white',
                  border: '1px solid #E5E7EB',
                  borderRadius: '8px',
                  boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                  maxHeight: '300px',
                  overflowY: 'auto',
                  zIndex: 1000,
                  marginTop: '4px'
                }}
              >
                {(() => {
                  const searchLower = searchFilter.toLowerCase();
                  const filteredUsers = users.filter(u => 
                    u.statut === 'Actif' && (
                      u.nom.toLowerCase().includes(searchLower) ||
                      u.prenom.toLowerCase().includes(searchLower) ||
                      (u.email && u.email.toLowerCase().includes(searchLower))
                    )
                  ).slice(0, 10); // Limiter √† 10 r√©sultats
                  
                  if (filteredUsers.length === 0) {
                    return (
                      <div style={{padding: '1rem', textAlign: 'center', color: '#6B7280'}}>
                        Aucun pompier trouv√©
                      </div>
                    );
                  }
                  
                  return filteredUsers.map(u => (
                    <div
                      key={u.id}
                      onClick={() => {
                        setSearchFilter(`${u.prenom} ${u.nom}`);
                        setSelectedUserId(u.id);
                        setShowSearchSuggestions(false);
                      }}
                      style={{
                        padding: '0.75rem 1rem',
                        cursor: 'pointer',
                        borderBottom: '1px solid #F3F4F6',
                        transition: 'background 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#F9FAFB'}
                      onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                    >
                      <div style={{fontWeight: '600', color: '#1F2937'}}>
                        {u.prenom} {u.nom}
                      </div>
                      <div style={{fontSize: '0.875rem', color: '#6B7280'}}>
                        {u.grade} ‚Ä¢ {u.type_emploi === 'temps_partiel' ? 'TP' : 'TF'}
                      </div>
                    </div>
                  ));
                })()}
              </div>
            )}
          </div>
          
          {/* Toggle Vue Semaine/Mois */}
          <div className="view-toggle">
            <button 
              className={viewMode === 'semaine' ? 'active' : ''}
              onClick={() => setViewMode('semaine')}
              title="Vue Semaine"
            >
              üìÖ Semaine
            </button>
            <button 
              className={viewMode === 'mois' ? 'active' : ''}
              onClick={() => setViewMode('mois')}
              title="Vue Mois"
            >
              üìä Mois
            </button>
          </div>

          {/* Imprimer Planning */}
          <Button 
            variant="outline" 
            onClick={handleExportPDFPlanning}
            style={{ 
              borderColor: '#3B82F6', 
              color: '#3B82F6',
              display: 'flex',
              alignItems: 'center',
              gap: '0.5rem'
            }}
          >
            üñ®Ô∏è Imprimer Planning
          </Button>
        </div>
        
        {/* Indicateur de r√©sultats de recherche */}
        {searchFilter.trim() && (
          <div style={{
            marginTop: '1rem',
            padding: '0.75rem 1rem',
            background: '#EFF6FF',
            border: '1px solid #BFDBFE',
            borderRadius: '8px',
            display: 'flex',
            alignItems: 'center',
            gap: '0.5rem',
            fontSize: '0.95rem',
            color: '#1E40AF'
          }}>
            <span>üîç</span>
            <span>
              {(() => {
                // Si un utilisateur sp√©cifique a √©t√© s√©lectionn√©
                if (selectedUserId) {
                  const selectedUser = getUserById(selectedUserId);
                  const userAssignations = assignations.filter(a => a.user_id === selectedUserId);
                  return selectedUser 
                    ? `${selectedUser.prenom} ${selectedUser.nom} - ${userAssignations.length} assignation(s) pour cette p√©riode`
                    : `Utilisateur s√©lectionn√© - ${userAssignations.length} assignation(s)`;
                }
                
                // Sinon recherche g√©n√©rale
                const matchingAssignations = assignations.filter(a => {
                  const u = getUserById(a.user_id);
                  if (!u) return false;
                  const searchLower = searchFilter.toLowerCase();
                  return u.nom.toLowerCase().includes(searchLower) ||
                         u.prenom.toLowerCase().includes(searchLower) ||
                         (u.email && u.email.toLowerCase().includes(searchLower));
                });
                const uniqueUserIds = [...new Set(matchingAssignations.map(a => a.user_id))];
                return uniqueUserIds.length > 0 
                  ? `${uniqueUserIds.length} employ√©(s) trouv√©(s) correspondant √† "${searchFilter}"`
                  : `Recherche: "${searchFilter}" - Aucune assignation trouv√©e pour cette p√©riode`;
              })()}
            </span>
            <button
              onClick={() => {
                setSearchFilter('');
                setSelectedUserId(null);
              }}
              style={{
                marginLeft: 'auto',
                background: 'transparent',
                border: 'none',
                color: '#1E40AF',
                cursor: 'pointer',
                fontSize: '1.2rem',
                padding: '0 0.5rem'
              }}
              title="Effacer la recherche"
            >
              ‚úï
            </button>
          </div>
        )}
      </div>

      {/* Boutons d'Assignation - Responsive Mobile/Desktop */}
      {user.role !== 'employe' && (
        <div className="planning-action-buttons" style={{
          display: 'flex', 
          flexWrap: 'wrap',
          gap: '0.5rem', 
          marginBottom: '1.5rem', 
          justifyContent: 'center',
          padding: '0 0.5rem'
        }}>
          <Button 
            className="planning-btn planning-btn-auto"
            onClick={() => {
              setAutoAttributionConfig({
                periode: viewMode,
                date: viewMode === 'semaine' ? currentWeek : currentMonth
              });
              setShowAutoAttributionModal(true);
            }}
            data-testid="auto-assign-btn"
          >
            <span className="btn-icon">‚ú®</span>
            <span className="btn-text-short">Auto</span>
            <span className="btn-text-full">Attribution Automatique</span>
          </Button>
          <Button 
            className="planning-btn planning-btn-manual"
            onClick={() => setShowAdvancedAssignModal(true)}
            data-testid="manual-assign-btn"
          >
            <span className="btn-icon">üë§</span>
            <span className="btn-text-short">Manuelle</span>
            <span className="btn-text-full">Assignation Manuelle</span>
          </Button>
          <Button 
            className="planning-btn planning-btn-rapport"
            onClick={() => setShowRapportHeuresModal(true)}
            data-testid="rapport-heures-btn"
          >
            <span className="btn-icon">üìä</span>
            <span className="btn-text-short">Rapport</span>
            <span className="btn-text-full">Rapport d'Heures</span>
          </Button>
        </div>
      )}

      {/* Navigation Temporelle */}
      <div className="time-navigation" style={{
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center',
        marginBottom: '2rem',
        padding: '1rem',
        background: 'white',
        borderRadius: '12px',
        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
      }}>
        <Button 
          variant="ghost" 
          onClick={() => viewMode === 'mois' ? navigateMonth(-1) : navigateWeek(-1)}
          data-testid="prev-period-btn"
        >
          ‚Üê {viewMode === 'mois' ? 'Mois pr√©c√©dent' : 'Semaine pr√©c√©dente'}
        </Button>
        <h2 style={{margin: 0, fontSize: '1.3rem', fontWeight: '600', color: '#1F2937'}}>
          {viewMode === 'mois' ? (
            new Date(currentMonth + '-01T12:00:00Z').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric', timeZone: 'UTC' })
          ) : (
            `Semaine du ${weekDates[0].toLocaleDateString('fr-FR', { timeZone: 'UTC' })} au ${weekDates[6].toLocaleDateString('fr-FR', { timeZone: 'UTC' })}`
          )}
        </h2>
        <Button 
          variant="ghost" 
          onClick={() => viewMode === 'mois' ? navigateMonth(1) : navigateWeek(1)}
          data-testid="next-period-btn"
        >
          {viewMode === 'mois' ? 'Mois suivant' : 'Semaine suivante'} ‚Üí
        </Button>
      </div>

      {/* Vue Calendrier */}
      {viewMode === 'semaine' ? (
        // Vue Semaine - Style Tableau Blanc Vertical
        <div className="planning-whiteboard" style={{
          display: 'flex',
          gap: '1rem',
          overflowX: 'auto',
          padding: '1rem',
          background: 'white',
          borderRadius: '12px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          {weekDates.map((date, dayIndex) => {
            // R√©cup√©rer les types de garde applicables pour ce jour, tri√©s chronologiquement
            const gardesOfDay = typesGarde
              .filter(typeGarde => shouldShowTypeGardeForDay(typeGarde, dayIndex))
              .sort((a, b) => a.heure_debut.localeCompare(b.heure_debut));

            return (
              <div 
                key={dayIndex} 
                className="day-column" 
                style={{
                  flex: '1 1 0',
                  minWidth: '200px',
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '0.75rem'
                }}
              >
                {/* En-t√™te de la colonne jour */}
                <div style={{
                  textAlign: 'center',
                  padding: '1rem',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  borderRadius: '8px',
                  fontWeight: 'bold',
                  boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                  position: 'sticky',
                  top: 0,
                  zIndex: 10
                }}>
                  <div style={{ fontSize: '0.9rem', marginBottom: '0.25rem' }}>{weekDays[dayIndex]}</div>
                  <div style={{ fontSize: '1.5rem' }}>{date.getUTCDate()}</div>
                  <div style={{ fontSize: '0.75rem', opacity: 0.9 }}>
                    {date.toLocaleDateString('fr-FR', { month: 'short', timeZone: 'UTC' })}
                  </div>
                </div>

                {/* Cartes de garde pour ce jour */}
                {gardesOfDay.map(typeGarde => {
                  const dateStr = date.toISOString().split('T')[0];
                  const gardeAssignations = assignations.filter(a => 
                    a.date === dateStr && a.type_garde_id === typeGarde.id
                  );
                  const assignedUsers = gardeAssignations.map(a => getUserById(a.user_id)).filter(Boolean);
                  
                  // Filtrer les utilisateurs selon la recherche ou l'utilisateur s√©lectionn√©
                  const filteredUsers = selectedUserId 
                    ? assignedUsers.filter(u => u.id === selectedUserId)
                    : searchFilter.trim() 
                      ? assignedUsers.filter(u => 
                          u.nom.toLowerCase().includes(searchFilter.toLowerCase()) ||
                          u.prenom.toLowerCase().includes(searchFilter.toLowerCase()) ||
                          (u.email && u.email.toLowerCase().includes(searchFilter.toLowerCase()))
                        )
                      : assignedUsers;
                  
                  const assignedCount = assignedUsers.length;
                  const requiredCount = typeGarde.personnel_requis;
                  const coverage = getGardeCoverage(date, typeGarde);
                  
                  // V√©rifier si un officier est assign√© √† cette garde
                  const hasOfficerAssigned = assignedUsers.some(u => {
                    const gradeInfo = grades && grades.find(g => g.nom === u.grade);
                    return (gradeInfo && gradeInfo.est_officier) || u.fonction_superieur;
                  });
                  
                  // V√©rifier si c'est un quart de l'utilisateur actuel
                  const isMyShift = user.role === 'employe' && assignedUsers.some(u => u.id === user.id);
                  
                  // V√©rifier si l'utilisateur recherch√© est assign√© √† cette garde
                  const isSearchedUserAssigned = (selectedUserId || searchFilter.trim()) && filteredUsers.length > 0;

                  // Utiliser la couleur d√©finie dans les param√®tres du type de garde
                  const gardeColor = typeGarde.couleur || '#6B7280';

                  return (
                    <div
                      key={typeGarde.id}
                      className="garde-card-vertical"
                      style={{
                        background: isSearchedUserAssigned 
                          ? '#FFFBEB' 
                          : isMyShift ? '#3B82F610' : 'white',
                        border: isSearchedUserAssigned
                          ? '3px solid #F59E0B'
                          : `3px solid ${isMyShift ? '#3B82F6' : gardeColor}`,
                        borderRadius: '8px',
                        padding: '1rem',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        boxShadow: isSearchedUserAssigned
                          ? '0 4px 12px rgba(245, 158, 11, 0.4)'
                          : '0 2px 4px rgba(0,0,0,0.1)',
                        position: 'relative'
                      }}
                      onClick={() => {
                        if (assignedUsers.length > 0) {
                          openGardeDetails(date, typeGarde);
                        } else if (user.role !== 'employe') {
                          openAssignModal(date, typeGarde);
                        }
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                      }}
                      data-testid={`garde-card-${dayIndex}-${typeGarde.id}`}
                    >
                      {/* Indicateur de couverture en haut √† droite */}
                      <div style={{
                        position: 'absolute',
                        top: '0.5rem',
                        right: '0.5rem',
                        fontSize: '1.2rem'
                      }}>
                        {coverage === 'complete' ? '‚úÖ' : coverage === 'partielle' ? '‚ö†Ô∏è' : '‚ùå'}
                      </div>

                      {/* En-t√™te de la carte avec barre color√©e */}
                      <div style={{
                        background: gardeColor,
                        color: 'white',
                        padding: '0.5rem',
                        borderRadius: '4px',
                        marginBottom: '0.75rem',
                        fontWeight: 'bold',
                        fontSize: '0.95rem'
                      }}>
                        {typeGarde.nom}
                      </div>

                      {/* Horaires */}
                      <div style={{
                        fontSize: '0.85rem',
                        color: '#6B7280',
                        marginBottom: '0.5rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.25rem'
                      }}>
                        <span>‚è∞</span>
                        <span>{typeGarde.heure_debut} - {typeGarde.heure_fin}</span>
                      </div>

                      {/* Ratio personnel */}
                      <div style={{
                        fontSize: '0.9rem',
                        fontWeight: 'bold',
                        marginBottom: '0.75rem',
                        color: coverage === 'complete' ? '#10b981' : coverage === 'partielle' ? '#f59e0b' : '#ef4444'
                      }}>
                        Personnel: {assignedCount}/{requiredCount}
                      </div>

                      {/* Liste du personnel assign√© */}
                      <div style={{
                        borderTop: '1px solid #E5E7EB',
                        paddingTop: '0.75rem'
                      }}>
                        {assignedUsers.length > 0 ? (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            {(searchFilter.trim() ? filteredUsers : assignedUsers).map((u, idx) => (
                              <div 
                                key={idx} 
                                style={{
                                  padding: '0.5rem',
                                  background: searchFilter.trim() && (filteredUsers.includes(u) || u.id === selectedUserId) 
                                    ? 'linear-gradient(135deg, #FCD34D 0%, #FDE68A 100%)' 
                                    : '#F9FAFB',
                                  borderRadius: '4px',
                                  fontSize: '0.85rem',
                                  fontWeight: (searchFilter.trim() && (filteredUsers.includes(u) || u.id === selectedUserId)) || u.id === user.id ? 'bold' : 'normal',
                                  border: (searchFilter.trim() && (filteredUsers.includes(u) || u.id === selectedUserId)) 
                                    ? '2px solid #F59E0B' 
                                    : u.id === user.id ? '2px solid #3B82F6' : '1px solid #E5E7EB',
                                  boxShadow: searchFilter.trim() && (filteredUsers.includes(u) || u.id === selectedUserId) ? '0 2px 8px rgba(245, 158, 11, 0.3)' : 'none'
                                }}
                              >
                                {searchFilter.trim() && (filteredUsers.includes(u) || u.id === selectedUserId) && 'üîç '}
                                {u.prenom.charAt(0)}. {u.nom} - {u.grade}
                              </div>
                            ))}
                            {searchFilter.trim() && filteredUsers.length === 0 && (
                              <div style={{
                                fontSize: '0.8rem',
                                color: '#6B7280',
                                fontStyle: 'italic',
                                textAlign: 'center'
                              }}>
                                Aucune correspondance
                              </div>
                            )}
                          </div>
                        ) : (
                          <div style={{
                            textAlign: 'center',
                            color: '#EF4444',
                            fontWeight: 'bold',
                            fontSize: '0.9rem',
                            padding: '0.5rem'
                          }}>
                            üö´ Vacant
                          </div>
                        )}
                      </div>

                      {/* Badge Officier si requis */}
                      {typeGarde.officier_obligatoire && (
                        <div style={{
                          marginTop: '0.5rem',
                          padding: '0.25rem 0.5rem',
                          background: hasOfficerAssigned ? '#D1FAE5' : '#FEE2E2',
                          color: hasOfficerAssigned ? '#065F46' : '#991B1B',
                          borderRadius: '4px',
                          fontSize: '0.75rem',
                          fontWeight: 'bold',
                          textAlign: 'center',
                          border: hasOfficerAssigned ? '1px solid #10B981' : '1px solid #EF4444'
                        }}>
                          {hasOfficerAssigned ? '‚úÖ Officier pr√©sent' : '‚ö†Ô∏è Officier manquant'}
                        </div>
                      )}
                    </div>
                  );
                })}

                {/* Message si aucune garde ce jour */}
                {gardesOfDay.length === 0 && (
                  <div style={{
                    padding: '2rem 1rem',
                    textAlign: 'center',
                    color: '#9CA3AF',
                    fontSize: '0.9rem',
                    fontStyle: 'italic',
                    border: '2px dashed #E5E7EB',
                    borderRadius: '8px',
                    background: '#F9FAFB'
                  }}>
                    Aucune garde ce jour
                  </div>
                )}
              </div>
            );
          })}
        </div>
        ) : (
          // Vue Mois Calendrier
        <div className="planning-mois">
          <div className="mois-header">
            <h3>üìÖ Planning mensuel - {new Date(currentMonth + '-01T12:00:00Z').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric', timeZone: 'UTC' })}</h3>
          </div>
          
          <div className="calendrier-mois">
            {monthDates.map((date, index) => {
              // Si date est null, c'est un jour vide (avant le 1er du mois)
              if (date === null) {
                return <div key={`empty-${index}`} className="jour-mois jour-vide"></div>;
              }

              const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short', timeZone: 'UTC' });
              const dayIndex = date.getUTCDay() === 0 ? 6 : date.getUTCDay() - 1; // Lundi = 0
              
              const gardesJour = typesGarde.filter(typeGarde => 
                shouldShowTypeGardeForDay(typeGarde, dayIndex)
              );

              return (
                <div key={date.toISOString().split('T')[0]} className="jour-mois">
                  <div className="jour-mois-header">
                    <span className="jour-mois-name">{dayName}</span>
                    <span className="jour-mois-date">{date.getUTCDate()}</span>
                  </div>
                  
                  <div className="gardes-jour-list">
                    {gardesJour.map(typeGarde => {
                      const coverage = getGardeCoverage(date, typeGarde);
                      const dateStr = date.toISOString().split('T')[0];
                      const gardeAssignations = assignations.filter(a => 
                        a.date === dateStr && a.type_garde_id === typeGarde.id
                      );
                      const assignedUsers = gardeAssignations.map(a => getUserById(a.user_id)).filter(Boolean);
                      
                      // Filtrer les utilisateurs selon la recherche (m√™me logique que vue semaine)
                      const filteredUsers = selectedUserId 
                        ? assignedUsers.filter(u => u.id === selectedUserId)
                        : searchFilter.trim() 
                          ? assignedUsers.filter(u => 
                              u.nom.toLowerCase().includes(searchFilter.toLowerCase()) ||
                              u.prenom.toLowerCase().includes(searchFilter.toLowerCase()) ||
                              (u.email && u.email.toLowerCase().includes(searchFilter.toLowerCase()))
                            )
                          : assignedUsers;
                      
                      const isMyShift = user.role === 'employe' && assignedUsers.some(u => u.id === user.id);
                      const isSearchedUserAssigned = (selectedUserId || searchFilter.trim()) && filteredUsers.length > 0;
                      
                      return (
                        <div
                          key={typeGarde.id}
                          className={`garde-mois-item ${coverage} ${isMyShift ? 'my-shift' : ''} ${isSearchedUserAssigned ? 'searched-user' : ''}`}
                          style={{
                            backgroundColor: isSearchedUserAssigned ? '#F59E0B' : (isMyShift ? '#3B82F6' : getCoverageColor(coverage)),
                            opacity: coverage === 'vacante' ? 0.7 : 1,
                            border: isSearchedUserAssigned ? '2px solid #D97706' : 'none',
                            boxShadow: isSearchedUserAssigned ? '0 0 0 3px rgba(245, 158, 11, 0.2)' : 'none'
                          }}
                          onClick={() => openGardeDetails(date, typeGarde)}
                          data-testid={`garde-mois-${date.getDate()}-${typeGarde.id}`}
                          title={`${typeGarde.nom} - ${assignedUsers.length}/${typeGarde.personnel_requis}`}
                        >
                          <span className="garde-nom-complet">{typeGarde.nom}</span>
                          <span className="coverage-icon">
                            {coverage === 'complete' ? '‚úÖ' : coverage === 'partielle' ? '‚ö†Ô∏è' : '‚ùå'}
                          </span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* L√©gende des Couleurs - En bas du planning */}
      <div style={{
        display: 'flex',
        gap: '2rem',
        justifyContent: 'center',
        marginTop: '2rem',
        padding: '1.25rem',
        background: 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)',
        borderRadius: '12px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
        border: '1px solid #e2e8f0'
      }}>
        <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
          <span style={{
            width: '24px', 
            height: '24px', 
            background: '#10B981', 
            borderRadius: '6px', 
            display: 'inline-block',
            boxShadow: '0 2px 4px rgba(16, 185, 129, 0.3)'
          }}></span>
          <span style={{fontSize: '0.95rem', fontWeight: '500', color: '#1e293b'}}>‚úÖ Complet</span>
        </div>
        <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
          <span style={{
            width: '24px', 
            height: '24px', 
            background: '#F59E0B', 
            borderRadius: '6px', 
            display: 'inline-block',
            boxShadow: '0 2px 4px rgba(245, 158, 11, 0.3)'
          }}></span>
          <span style={{fontSize: '0.95rem', fontWeight: '500', color: '#1e293b'}}>‚ö†Ô∏è Partiel</span>
        </div>
        <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
          <span style={{
            width: '24px', 
            height: '24px', 
            background: '#EF4444', 
            borderRadius: '6px', 
            display: 'inline-block',
            boxShadow: '0 2px 4px rgba(239, 68, 68, 0.3)'
          }}></span>
          <span style={{fontSize: '0.95rem', fontWeight: '500', color: '#1e293b'}}>‚ùå Vacant</span>
        </div>
        {user.role === 'employe' && (
          <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
            <span style={{
              width: '24px', 
              height: '24px', 
              background: '#3B82F6', 
              borderRadius: '6px', 
              display: 'inline-block',
              boxShadow: '0 2px 4px rgba(59, 130, 246, 0.3)'
            }}></span>
            <span style={{fontSize: '0.95rem', fontWeight: '500', color: '#1e293b'}}>üë§ Mes Quarts</span>
          </div>
        )}
      </div>

      {/* Assignment Modal */}
      {showAssignModal && selectedSlot && user.role !== 'employe' && (
        <div className="modal-overlay" onClick={() => { setShowAssignModal(false); setQuickAssignSearchQuery(''); setShowQuickAssignDropdown(false); }}>
          <div 
            className="modal-content" 
            onClick={(e) => e.stopPropagation()} 
            data-testid="assign-modal"
            style={{
              maxHeight: '85vh',
              maxWidth: '600px',
              width: '95%',
              overflow: 'visible',
              display: 'flex',
              flexDirection: 'column'
            }}
          >
            <div className="modal-header" style={{ flexShrink: 0 }}>
              <h3>Assigner une garde</h3>
              <Button variant="ghost" onClick={() => { setShowAssignModal(false); setQuickAssignSearchQuery(''); setShowQuickAssignDropdown(false); }}>‚úï</Button>
            </div>
            <div className="modal-body" style={{ 
              overflow: 'visible', 
              flex: 1, 
              minHeight: 0,
              padding: '1.5rem'
            }}>
              <div className="assignment-details" style={{ 
                padding: '1rem', 
                background: '#f8fafc', 
                borderRadius: '8px',
                marginBottom: '1.25rem'
              }}>
                <p style={{ margin: '0.5rem 0', fontSize: '1rem' }}>
                  <strong>Garde:</strong> {selectedSlot.typeGarde.nom}
                </p>
                <p style={{ margin: '0.5rem 0', fontSize: '1rem' }}>
                  <strong>Date:</strong> {selectedSlot.date.toLocaleDateString('fr-FR')}
                </p>
                <p style={{ margin: '0.5rem 0', fontSize: '1rem' }}>
                  <strong>Horaires:</strong> {selectedSlot.typeGarde.heure_debut} - {selectedSlot.typeGarde.heure_fin}
                </p>
              </div>
              
              <div className="user-selection" style={{ overflow: 'visible', marginBottom: '0.5rem' }}>
                <h4 style={{ fontSize: '0.95rem', marginBottom: '0.5rem' }}>Rechercher un pompier:</h4>
                <div style={{ position: 'relative', overflow: 'visible' }}>
                  <Input
                    type="text"
                    placeholder="Tapez le nom ou pr√©nom du pompier..."
                    value={quickAssignSearchQuery}
                    onChange={(e) => {
                      setQuickAssignSearchQuery(e.target.value);
                      setShowQuickAssignDropdown(true);
                    }}
                    onFocus={() => setShowQuickAssignDropdown(true)}
                    style={{ width: '100%', padding: '0.75rem', fontSize: '1rem' }}
                    data-testid="quick-assign-search"
                  />
                  
                  {showQuickAssignDropdown && quickAssignSearchQuery && (
                    <div style={{
                      position: 'absolute',
                      top: '100%',
                      left: 0,
                      right: 0,
                      maxHeight: '300px',
                      overflowY: 'auto',
                      background: 'white',
                      border: '1px solid #cbd5e1',
                      borderRadius: '6px',
                      marginTop: '4px',
                      zIndex: 1050,
                      boxShadow: '0 10px 15px rgba(0,0,0,0.15)',
                      fontSize: '0.875rem',
                      color: '#1e293b'
                    }}>
                      {users
                        .filter(userOption => {
                          // Filtrer les utilisateurs d√©j√† assign√©s
                          const dateStr = selectedSlot.date.toISOString().split('T')[0];
                          const alreadyAssigned = assignations.some(a => 
                            a.date === dateStr && 
                            a.type_garde_id === selectedSlot.typeGarde.id && 
                            a.user_id === userOption.id
                          );
                          
                          // Filtrer par recherche
                          const searchLower = quickAssignSearchQuery.toLowerCase();
                          const matchesSearch = 
                            `${userOption.prenom} ${userOption.nom}`.toLowerCase().includes(searchLower) ||
                            userOption.grade.toLowerCase().includes(searchLower);
                          
                          return !alreadyAssigned && matchesSearch;
                        })
                        .map(userOption => (
                          <div
                            key={userOption.id}
                            onClick={() => {
                              handleAssignUser(userOption.id, selectedSlot.typeGarde.id, selectedSlot.date.toISOString().split('T')[0]);
                              setQuickAssignSearchQuery('');
                              setShowQuickAssignDropdown(false);
                            }}
                            style={{
                              padding: '0.75rem',
                              cursor: 'pointer',
                              borderBottom: '1px solid #f1f5f9',
                              transition: 'background 0.2s',
                              color: '#1e293b'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#f8fafc';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = 'white';
                            }}
                            data-testid={`quick-assign-user-${userOption.id}`}
                          >
                            <div style={{ 
                              fontWeight: '500', 
                              fontSize: '0.95rem',
                              color: '#1e293b',
                              marginBottom: '0.25rem'
                            }}>
                              {userOption.prenom} {userOption.nom}
                            </div>
                            <div style={{ 
                              fontSize: '0.85rem', 
                              color: '#64748b',
                              fontWeight: '400'
                            }}>
                              {userOption.grade} - {userOption.type_emploi === 'temps_plein' ? 'TP' : 'TPA'}
                            </div>
                          </div>
                        ))}
                      
                      {users.filter(userOption => {
                        const dateStr = selectedSlot.date.toISOString().split('T')[0];
                        const alreadyAssigned = assignations.some(a => 
                          a.date === dateStr && 
                          a.type_garde_id === selectedSlot.typeGarde.id && 
                          a.user_id === userOption.id
                        );
                        const searchLower = quickAssignSearchQuery.toLowerCase();
                        const matchesSearch = 
                          `${userOption.prenom} ${userOption.nom}`.toLowerCase().includes(searchLower) ||
                          userOption.grade.toLowerCase().includes(searchLower);
                        return !alreadyAssigned && matchesSearch;
                      }).length === 0 && (
                        <div style={{ padding: '1rem', textAlign: 'center', color: '#64748b' }}>
                          Aucun pompier trouv√©
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal d√©tails d'une garde - Voir tout le personnel */}
      {showGardeDetailsModal && selectedGardeDetails && (
        <div className="modal-overlay" onClick={() => setShowGardeDetailsModal(false)}>
          <div className="modal-content large-modal" onClick={(e) => e.stopPropagation()} data-testid="garde-details-modal">
            <div className="modal-header">
              <h3>üöí D√©tails de la garde - {selectedGardeDetails.date.toLocaleDateString('fr-FR')}</h3>
              <Button variant="ghost" onClick={() => setShowGardeDetailsModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="garde-info-header">
                <div className="garde-type-info">
                  <h4>{selectedGardeDetails.typeGarde.nom}</h4>
                  <div className="garde-details-meta">
                    <span>‚è∞ {selectedGardeDetails.typeGarde.heure_debut} - {selectedGardeDetails.typeGarde.heure_fin}</span>
                    <span>üë• {selectedGardeDetails.typeGarde.personnel_requis} personnel requis</span>
                    {selectedGardeDetails.typeGarde.officier_obligatoire && (() => {
                      const hasOfficer = selectedGardeDetails.personnelAssigne.some(u => {
                        const gradeInfo = grades && grades.find(g => g.nom === u.grade);
                        return (gradeInfo && gradeInfo.est_officier) || u.fonction_superieur;
                      });
                      return (
                        <span style={{
                          padding: '0.25rem 0.5rem',
                          borderRadius: '4px',
                          background: hasOfficer ? '#D1FAE5' : '#FEE2E2',
                          color: hasOfficer ? '#065F46' : '#991B1B',
                          fontWeight: 'bold'
                        }}>
                          {hasOfficer ? '‚úÖ Officier pr√©sent' : '‚ö†Ô∏è Officier manquant'}
                        </span>
                      );
                    })()}
                    {selectedGardeDetails.typeGarde.est_garde_externe && (
                      <span className="badge-externe">üè† Garde Externe</span>
                    )}
                  </div>
                </div>
                <div className="coverage-indicator">
                  <span className="coverage-ratio">
                    {selectedGardeDetails.personnelAssigne.length}/{selectedGardeDetails.typeGarde.personnel_requis}
                  </span>
                  <span className="coverage-label">Personnel assign√©</span>
                </div>
              </div>

              <div className="personnel-assigned">
                <h4>üë• Personnel assign√©</h4>
                {selectedGardeDetails.personnelAssigne.length > 0 ? (
                  <div className="personnel-list">
                    {selectedGardeDetails.personnelAssigne.map((person, index) => (
                      <div key={person.id} className="personnel-item">
                        <div className="personnel-info">
                          <div className="personnel-avatar">
                            <span className="avatar-icon">üë§</span>
                          </div>
                          <div className="personnel-details">
                            <span className="personnel-name">{person.prenom} {person.nom}</span>
                            <span className="personnel-grade">{person.grade}</span>
                            <span className="personnel-type">{person.type_emploi === 'temps_plein' ? 'Temps plein' : 'Temps partiel'}</span>
                          </div>
                        </div>
                        <div className="personnel-actions">
                          <span className="assignment-method">
                            {selectedGardeDetails.assignations[index]?.assignation_type === 'auto' ? 'ü§ñ Auto' : 'üë§ Manuel'}
                          </span>
                          {user.role === 'admin' && selectedGardeDetails.assignations[index]?.assignation_type === 'auto' && (
                            <Button 
                              variant="outline" 
                              size="sm" 
                              onClick={() => {
                                console.log('Bouton Audit cliqu√©', selectedGardeDetails.assignations[index]);
                                openAuditModal(selectedGardeDetails.assignations[index], person);
                              }}
                              style={{ marginLeft: '8px' }}
                            >
                              üîç Audit
                            </Button>
                          )}
                          {user.role !== 'employe' && (
                            <Button 
                              variant="ghost" 
                              size="sm" 
                              onClick={() => handleRemovePersonFromGarde(person.id, selectedGardeDetails.typeGarde.nom)}
                              data-testid={`remove-person-${person.id}`}
                            >
                              ‚ùå Retirer
                            </Button>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="no-personnel">
                    <p>Aucun personnel assign√© √† cette garde</p>
                    {user.role !== 'employe' && (
                      <Button 
                        variant="outline" 
                        onClick={() => {
                          setShowGardeDetailsModal(false);
                          openAssignModal(selectedGardeDetails.date, selectedGardeDetails.typeGarde);
                        }}
                        data-testid="assign-personnel-btn"
                      >
                        Assigner du personnel
                      </Button>
                    )}
                  </div>
                )}
              </div>

              <div className="garde-actions">
                {user.role !== 'employe' && (
                  <>
                    <Button 
                      variant="outline" 
                      onClick={() => {
                        setShowGardeDetailsModal(false);
                        openAssignModal(selectedGardeDetails.date, selectedGardeDetails.typeGarde);
                      }}
                      data-testid="add-more-personnel-btn"
                    >
                      ‚ûï Ajouter personnel
                    </Button>
                    <Button 
                      variant="destructive" 
                      onClick={handleRemoveAllPersonnelFromGarde}
                      data-testid="remove-all-personnel-btn"
                    >
                      üóëÔ∏è Supprimer tout le personnel
                    </Button>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal d'assignation manuelle avanc√©e avec r√©currence */}
      {showAdvancedAssignModal && user.role !== 'employe' && (
        <div className="modal-overlay" onClick={() => setShowAdvancedAssignModal(false)}>
          <div className="modal-content extra-large-modal" onClick={(e) => e.stopPropagation()} data-testid="advanced-assign-modal">
            <div className="modal-header">
              <h3>üë§ Assignation manuelle avanc√©e</h3>
              <Button variant="ghost" onClick={() => setShowAdvancedAssignModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="advanced-assign-form">
                {/* Section 1: S√©lection personnel */}
                <div className="assign-section">
                  <h4>üë• S√©lection du personnel</h4>
                  <div className="form-field" style={{ position: 'relative' }}>
                    <Label>Pompier √† assigner *</Label>
                    <Input
                      type="text"
                      placeholder="Tapez le nom du pompier..."
                      value={userSearchQuery}
                      onChange={(e) => {
                        setUserSearchQuery(e.target.value);
                        setShowUserDropdown(true);
                      }}
                      onFocus={() => setShowUserDropdown(true)}
                      data-testid="advanced-user-search"
                    />
                    {showUserDropdown && userSearchQuery && (
                      <div style={{
                        position: 'absolute',
                        top: '100%',
                        left: 0,
                        right: 0,
                        maxHeight: '200px',
                        overflowY: 'auto',
                        background: 'white',
                        border: '1px solid #cbd5e1',
                        borderRadius: '6px',
                        marginTop: '4px',
                        zIndex: 1000,
                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                      }}>
                        {users
                          .filter(user => 
                            `${user.prenom} ${user.nom}`.toLowerCase().includes(userSearchQuery.toLowerCase()) ||
                            user.grade.toLowerCase().includes(userSearchQuery.toLowerCase())
                          )
                          .map(user => (
                            <div
                              key={user.id}
                              onClick={() => {
                                setAdvancedAssignConfig({...advancedAssignConfig, user_id: user.id});
                                setUserSearchQuery(`${user.prenom} ${user.nom}`);
                                setShowUserDropdown(false);
                              }}
                              style={{
                                padding: '0.75rem',
                                cursor: 'pointer',
                                borderBottom: '1px solid #f1f5f9',
                                transition: 'background 0.2s'
                              }}
                              onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                              onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                            >
                              <div style={{ fontWeight: '500' }}>{user.prenom} {user.nom}</div>
                              <div style={{ fontSize: '0.875rem', color: '#64748b' }}>
                                {user.grade} - {user.type_emploi === 'temps_plein' ? 'Temps plein' : 'Temps partiel'}
                              </div>
                            </div>
                          ))}
                        {users.filter(user => 
                          `${user.prenom} ${user.nom}`.toLowerCase().includes(userSearchQuery.toLowerCase()) ||
                          user.grade.toLowerCase().includes(userSearchQuery.toLowerCase())
                        ).length === 0 && (
                          <div style={{ padding: '1rem', textAlign: 'center', color: '#64748b' }}>
                            Aucun pompier trouv√©
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Section 2: Type de garde */}
                <div className="assign-section">
                  <h4>üöí Type(s) de garde</h4>
                  <div className="form-field">
                    <Label>Type(s) de garde * (s√©lection multiple)</Label>
                    <p style={{ fontSize: '0.875rem', color: '#64748b', marginBottom: '1rem' }}>
                      üí° Vous pouvez s√©lectionner plusieurs types de garde pour la m√™me assignation
                    </p>
                    
                    {/* Multi-select avec checkboxes */}
                    <div style={{
                      maxHeight: '300px',
                      overflowY: 'auto',
                      border: '1px solid #cbd5e1',
                      borderRadius: '8px',
                      padding: '0.5rem',
                      background: '#f8fafc'
                    }}>
                      {typesGarde.length === 0 && (
                        <div style={{ padding: '1rem', textAlign: 'center', color: '#64748b' }}>
                          Aucun type de garde disponible
                        </div>
                      )}
                      
                      {typesGarde.map(type => {
                        const isSelected = advancedAssignConfig.type_garde_ids.includes(type.id);
                        
                        return (
                          <label
                            key={type.id}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.75rem',
                              padding: '0.75rem',
                              margin: '0.25rem 0',
                              border: '2px solid',
                              borderColor: isSelected ? '#dc2626' : '#e2e8f0',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              background: isSelected ? '#fee2e2' : 'white',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => {
                              if (!isSelected) e.currentTarget.style.background = '#fafafa';
                            }}
                            onMouseLeave={(e) => {
                              if (!isSelected) e.currentTarget.style.background = 'white';
                            }}
                          >
                            <input
                              type="checkbox"
                              checked={isSelected}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  // Ajouter le type de garde
                                  setAdvancedAssignConfig({
                                    ...advancedAssignConfig,
                                    type_garde_ids: [...advancedAssignConfig.type_garde_ids, type.id]
                                  });
                                } else {
                                  // Retirer le type de garde
                                  setAdvancedAssignConfig({
                                    ...advancedAssignConfig,
                                    type_garde_ids: advancedAssignConfig.type_garde_ids.filter(id => id !== type.id)
                                  });
                                }
                              }}
                              style={{
                                width: '20px',
                                height: '20px',
                                cursor: 'pointer',
                                accentColor: '#dc2626'
                              }}
                              data-testid={`type-garde-checkbox-${type.id}`}
                            />
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: isSelected ? '600' : '500', color: '#1e293b' }}>
                                {type.nom}
                              </div>
                              <div style={{ fontSize: '0.875rem', color: '#64748b' }}>
                                {type.heure_debut && type.heure_fin ? (
                                  <>‚è∞ {type.heure_debut} - {type.heure_fin} ({type.duree_heures || 8}h)</>
                                ) : (
                                  <>‚è∞ Dur√©e: {type.duree_heures || 8}h</>
                                )}
                              </div>
                            </div>
                            {isSelected && (
                              <div style={{ color: '#dc2626', fontSize: '1.2rem' }}>‚úì</div>
                            )}
                          </label>
                        );
                      })}
                    </div>
                    
                    {/* R√©sum√© de la s√©lection */}
                    {advancedAssignConfig.type_garde_ids.length > 0 && (
                      <div style={{
                        marginTop: '1rem',
                        padding: '0.75rem',
                        background: '#eff6ff',
                        border: '1px solid #3b82f6',
                        borderRadius: '8px'
                      }}>
                        <div style={{ fontWeight: '600', color: '#1e40af', marginBottom: '0.5rem' }}>
                          üìã S√©lection actuelle: {advancedAssignConfig.type_garde_ids.length} type(s) de garde
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#1e40af' }}>
                          {typesGarde
                            .filter(tg => advancedAssignConfig.type_garde_ids.includes(tg.id))
                            .map(tg => tg.nom)
                            .join(' + ')}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Section 2.5: S√©lection des jours (conditionnel selon type r√©currence) */}
                {advancedAssignConfig.recurrence_type !== 'unique' && advancedAssignConfig.recurrence_type !== 'mensuelle' && advancedAssignConfig.recurrence_type !== 'annuelle' && advancedAssignConfig.recurrence_type !== 'personnalisee' && (
                  <div className="assign-section" style={{ background: '#eff6ff', padding: '1rem', borderRadius: '8px', border: '2px solid #3b82f6' }}>
                    <h4>üìã Jours de la semaine pour la r√©currence</h4>
                    <p style={{ fontSize: '0.875rem', color: '#1e40af', marginBottom: '1rem' }}>
                      ‚úÖ S√©lectionnez un ou plusieurs jours pour cr√©er des assignations r√©currentes.
                      <br />
                      <strong>Exemple :</strong> Cochez Lundi + Mercredi + Vendredi pour cr√©er des gardes ces 3 jours chaque semaine.
                    </p>
                    <div className="jours-selection">
                      {[
                        { value: 'monday', label: 'Lundi' },
                        { value: 'tuesday', label: 'Mardi' },
                        { value: 'wednesday', label: 'Mercredi' },
                        { value: 'thursday', label: 'Jeudi' },
                        { value: 'friday', label: 'Vendredi' },
                        { value: 'saturday', label: 'Samedi' },
                        { value: 'sunday', label: 'Dimanche' }
                      ].map(jour => (
                        <label key={jour.value} className="jour-checkbox" style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '0.5rem',
                          padding: '0.75rem 1rem',
                          margin: '0.25rem',
                          border: '2px solid',
                          borderColor: advancedAssignConfig.jours_semaine.includes(jour.value) ? '#3b82f6' : '#cbd5e1',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          background: advancedAssignConfig.jours_semaine.includes(jour.value) ? '#dbeafe' : 'white',
                          fontWeight: advancedAssignConfig.jours_semaine.includes(jour.value) ? '600' : '400',
                          transition: 'all 0.2s ease'
                        }}>
                          <input
                            type="checkbox"
                            checked={advancedAssignConfig.jours_semaine.includes(jour.value)}
                            onChange={(e) => {
                              const newJours = e.target.checked
                                ? [...advancedAssignConfig.jours_semaine, jour.value]
                                : advancedAssignConfig.jours_semaine.filter(j => j !== jour.value);
                              setAdvancedAssignConfig({...advancedAssignConfig, jours_semaine: newJours});
                            }}
                            style={{ cursor: 'pointer' }}
                          />
                          <span>{jour.label}</span>
                        </label>
                      ))}
                    </div>
                    {advancedAssignConfig.jours_semaine.length > 0 && (
                      <p style={{ marginTop: '0.75rem', fontSize: '0.875rem', color: '#059669', fontWeight: '600' }}>
                        ‚úÖ {advancedAssignConfig.jours_semaine.length} jour(s) s√©lectionn√©(s)
                      </p>
                    )}
                  </div>
                )}

                {/* Section 3: Configuration r√©currence */}
                <div className="assign-section">
                  <h4>üîÑ Type de r√©currence</h4>
                  <div style={{ marginBottom: '1rem' }}>
                    <select
                      value={advancedAssignConfig.recurrence_type}
                      onChange={(e) => setAdvancedAssignConfig({...advancedAssignConfig, recurrence_type: e.target.value})}
                      style={{ width: '100%', padding: '0.75rem', borderRadius: '6px', border: '1px solid #cbd5e1', fontSize: '0.95rem' }}
                    >
                      <option value="unique">üìÖ Assignation unique</option>
                      <option value="hebdomadaire">üîÅ Toutes les semaines (hebdomadaire)</option>
                      <option value="bihebdomadaire">üîÑ Toutes les deux semaines (bi-hebdomadaire)</option>
                      <option value="mensuelle">üìÜ Tous les mois (mensuelle)</option>
                      <option value="annuelle">üóìÔ∏è Tous les ans (annuelle)</option>
                      <option value="personnalisee">‚öôÔ∏è Personnalis√©e</option>
                    </select>
                  </div>

                  {/* Options pour personnalis√©e */}
                  {advancedAssignConfig.recurrence_type === 'personnalisee' && (
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginTop: '1rem', padding: '1rem', background: '#f8fafc', borderRadius: '6px' }}>
                      <div>
                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>
                          Tous les
                        </label>
                        <input
                          type="number"
                          min="1"
                          value={advancedAssignConfig.recurrence_intervalle || 1}
                          onChange={(e) => setAdvancedAssignConfig({...advancedAssignConfig, recurrence_intervalle: parseInt(e.target.value) || 1})}
                          style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                        />
                      </div>
                      <div>
                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500' }}>
                          Type
                        </label>
                        <select
                          value={advancedAssignConfig.recurrence_frequence || 'jours'}
                          onChange={(e) => setAdvancedAssignConfig({...advancedAssignConfig, recurrence_frequence: e.target.value})}
                          style={{ width: '100%', padding: '0.5rem', borderRadius: '6px', border: '1px solid #cbd5e1' }}
                        >
                          <option value="jours">Jours</option>
                          <option value="semaines">Semaines</option>
                          <option value="mois">Mois</option>
                          <option value="ans">Ans</option>
                        </select>
                      </div>
                    </div>
                  )}
                </div>

                {/* Section 4: Configuration dates */}
                <div className="assign-section">
                  <h4>üìÖ P√©riode d'assignation</h4>
                  <div className="form-row">
                    <div className="form-field">
                      <Label>Date de d√©but *</Label>
                      <Input
                        type="date"
                        value={advancedAssignConfig.date_debut}
                        onChange={(e) => setAdvancedAssignConfig({...advancedAssignConfig, date_debut: e.target.value})}
                        min={new Date().toISOString().split('T')[0]}
                        data-testid="advanced-date-debut"
                      />
                    </div>
                    <div className="form-field">
                      <Label>Date de fin *</Label>
                      <Input
                        type="date"
                        value={advancedAssignConfig.date_fin}
                        onChange={(e) => setAdvancedAssignConfig({...advancedAssignConfig, date_fin: e.target.value})}
                        min={advancedAssignConfig.date_debut || new Date().toISOString().split('T')[0]}
                        data-testid="advanced-date-fin"
                      />
                    </div>
                  </div>
                </div>

                {/* Suggestion de prochain jour si n√©cessaire */}
                {advancedAssignConfig.jour_specifique && advancedAssignConfig.date_debut && getSuggestedNextDay() && (
                  <div className="assign-section" style={{ background: '#fef3c7', padding: '1rem', borderRadius: '8px', border: '2px solid #f59e0b' }}>
                    <h4>üí° Suggestion</h4>
                    <p style={{ fontSize: '0.9rem', color: '#92400e', marginBottom: '0.75rem' }}>
                      La date de d√©but s√©lectionn√©e n'est pas un {getSuggestedNextDay()?.dayName}.
                    </p>
                    <Button
                      variant="outline"
                      style={{ background: 'white', border: '2px solid #f59e0b', color: '#92400e', fontWeight: '500' }}
                      onClick={() => {
                        const suggested = getSuggestedNextDay();
                        if (suggested) {
                          const dateStr = suggested.date.toISOString().split('T')[0];
                          setAdvancedAssignConfig({...advancedAssignConfig, date_debut: dateStr});
                          toast({
                            title: "Date ajust√©e",
                            description: `Date de d√©but chang√©e au prochain ${suggested.dayName}`,
                            variant: "success"
                          });
                        }
                      }}
                    >
                      üìÖ Utiliser le prochain {getSuggestedNextDay()?.dayName} : {getSuggestedNextDay()?.formatted}
                    </Button>
                  </div>
                )}

                {/* Aper√ßu des dates de r√©currence */}
                {advancedAssignConfig.date_debut && advancedAssignConfig.recurrence_type !== 'unique' && advancedAssignConfig.jour_specifique && (
                  <div className="assign-section" style={{ background: '#f0fdf4', padding: '1rem', borderRadius: '8px', border: '2px solid #22c55e' }}>
                    <h4>üëÅÔ∏è Aper√ßu des dates (10 premi√®res)</h4>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '0.5rem', marginTop: '0.75rem' }}>
                      {calculateRecurrenceDates().map((date, index) => (
                        <div
                          key={index}
                          style={{
                            padding: '0.5rem',
                            background: 'white',
                            borderRadius: '6px',
                            border: '1px solid #86efac',
                            fontSize: '0.875rem',
                            textAlign: 'center'
                          }}
                        >
                          <div style={{ fontWeight: '600', color: '#166534' }}>
                            {date.toLocaleDateString('fr-FR', { weekday: 'short' })}
                          </div>
                          <div style={{ color: '#15803d' }}>
                            {date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' })}
                          </div>
                        </div>
                      ))}
                    </div>
                    {calculateRecurrenceDates().length === 0 && (
                      <p style={{ textAlign: 'center', color: '#166534', marginTop: '0.5rem' }}>
                        Aucune date √† afficher. V√©rifiez votre configuration.
                      </p>
                    )}
                  </div>
                )}

                {/* Section 6: R√©sum√© de l'assignation */}
                <div className="assign-section">
                  <h4>üìä R√©sum√© de l'assignation</h4>
                  <div className="assignment-summary">
                    <div className="summary-row">
                      <span className="summary-label">Personnel :</span>
                      <span className="summary-value">
                        {advancedAssignConfig.user_id ? 
                          users.find(u => u.id === advancedAssignConfig.user_id)?.prenom + ' ' + 
                          users.find(u => u.id === advancedAssignConfig.user_id)?.nom 
                          : 'Non s√©lectionn√©'}
                      </span>
                    </div>
                    <div className="summary-row">
                      <span className="summary-label">Type(s) de garde :</span>
                      <span className="summary-value">
                        {advancedAssignConfig.type_garde_ids.length > 0 ?
                          typesGarde
                            .filter(t => advancedAssignConfig.type_garde_ids.includes(t.id))
                            .map(t => t.nom)
                            .join(' + ')
                          : 'Non s√©lectionn√©'}
                      </span>
                    </div>
                    <div className="summary-row">
                      <span className="summary-label">R√©currence :</span>
                      <span className="summary-value">
                        {advancedAssignConfig.recurrence_type === 'unique' ? 'üìÖ Assignation unique' :
                         advancedAssignConfig.recurrence_type === 'hebdomadaire' ? 
                           `üîÅ Chaque semaine (${advancedAssignConfig.jours_semaine.length} jour(s) s√©lectionn√©(s))` :
                         advancedAssignConfig.recurrence_type === 'bihebdomadaire' ?
                           `üîÑ Toutes les 2 semaines (${advancedAssignConfig.jours_semaine.length} jour(s) s√©lectionn√©(s))` :
                         advancedAssignConfig.recurrence_type === 'mensuelle' ? 'üìÜ Tous les mois' :
                         advancedAssignConfig.recurrence_type === 'annuelle' ? 'üóìÔ∏è Tous les ans' :
                         `‚öôÔ∏è Tous les ${advancedAssignConfig.recurrence_intervalle} ${advancedAssignConfig.recurrence_frequence}`}
                      </span>
                    </div>
                    <div className="summary-row">
                      <span className="summary-label">P√©riode :</span>
                      <span className="summary-value">
                        {advancedAssignConfig.date_debut && advancedAssignConfig.date_fin ?
                          `Du ${new Date(advancedAssignConfig.date_debut).toLocaleDateString('fr-FR')} au ${new Date(advancedAssignConfig.date_fin).toLocaleDateString('fr-FR')}`
                          : 'P√©riode non d√©finie'}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowAdvancedAssignModal(false)}>
                  Annuler
                </Button>
                <Button 
                  variant="default" 
                  onClick={handleAdvancedAssignment}
                  data-testid="create-advanced-assignment-btn"
                  disabled={!advancedAssignConfig.user_id || advancedAssignConfig.type_garde_ids.length === 0 || !advancedAssignConfig.date_debut}
                >
                  üöí Cr√©er l'assignation{advancedAssignConfig.type_garde_ids.length > 1 ? 's' : ''}
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      
      {/* Modal Attribution Automatique - Version am√©lior√©e */}
      {showAutoAttributionModal && (
        <div className="modal-overlay" onClick={() => setShowAutoAttributionModal(false)}>
          <div className="modal-content medium-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>‚ú® Attribution Automatique du Planning</h2>
              <Button variant="ghost" onClick={() => setShowAutoAttributionModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <h3 style={{marginBottom: '1rem', fontSize: '1.1rem'}}>Pour quelle p√©riode?</h3>
              
              <div style={{display: 'grid', gap: '1rem', gridTemplateColumns: 'repeat(2, 1fr)'}}>
                {/* Semaine actuelle */}
                <button
                  onClick={() => {
                    const today = new Date();
                    const monday = new Date(today);
                    monday.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                    const dateStr = monday.toISOString().split('T')[0];
                    setAutoAttributionConfig({
                      ...autoAttributionConfig,
                      periode: 'semaine',
                      periodeLabel: 'Semaine actuelle',
                      date: dateStr
                    });
                  }}
                  style={{
                    padding: '1.5rem',
                    border: autoAttributionConfig.periodeLabel === 'Semaine actuelle' ? '3px solid #3B82F6' : '2px solid #E5E7EB',
                    borderRadius: '12px',
                    background: autoAttributionConfig.periodeLabel === 'Semaine actuelle' ? '#EFF6FF' : 'white',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s'
                  }}
                >
                  <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>üìÖ</div>
                  <div style={{fontWeight: '600', marginBottom: '0.25rem'}}>Semaine actuelle</div>
                  <div style={{fontSize: '0.875rem', color: '#6B7280'}}>
                    {(() => {
                      const today = new Date();
                      const monday = new Date(today);
                      monday.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                      const sunday = new Date(monday);
                      sunday.setDate(monday.getDate() + 6);
                      return `${monday.toLocaleDateString('fr-CA')} au ${sunday.toLocaleDateString('fr-CA')}`;
                    })()}
                  </div>
                </button>

                {/* Semaine suivante */}
                <button
                  onClick={() => {
                    const today = new Date();
                    const nextMonday = new Date(today);
                    nextMonday.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? 1 : 8));
                    const dateStr = nextMonday.toISOString().split('T')[0];
                    setAutoAttributionConfig({
                      ...autoAttributionConfig,
                      periode: 'semaine',
                      periodeLabel: 'Semaine suivante',
                      date: dateStr
                    });
                  }}
                  style={{
                    padding: '1.5rem',
                    border: autoAttributionConfig.periodeLabel === 'Semaine suivante' ? '3px solid #3B82F6' : '2px solid #E5E7EB',
                    borderRadius: '12px',
                    background: autoAttributionConfig.periodeLabel === 'Semaine suivante' ? '#EFF6FF' : 'white',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s'
                  }}
                >
                  <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>üìÖ</div>
                  <div style={{fontWeight: '600', marginBottom: '0.25rem'}}>Semaine suivante</div>
                  <div style={{fontSize: '0.875rem', color: '#6B7280'}}>
                    {(() => {
                      const today = new Date();
                      const nextMonday = new Date(today);
                      nextMonday.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? 1 : 8));
                      const nextSunday = new Date(nextMonday);
                      nextSunday.setDate(nextMonday.getDate() + 6);
                      return `${nextMonday.toLocaleDateString('fr-CA')} au ${nextSunday.toLocaleDateString('fr-CA')}`;
                    })()}
                  </div>
                </button>

                {/* Mois actuel */}
                <button
                  onClick={() => {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    const dateStr = firstDay.toISOString().split('T')[0];
                    setAutoAttributionConfig({
                      ...autoAttributionConfig,
                      periode: 'mois',
                      periodeLabel: 'Mois actuel',
                      date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`
                    });
                  }}
                  style={{
                    padding: '1.5rem',
                    border: autoAttributionConfig.periodeLabel === 'Mois actuel' ? '3px solid #3B82F6' : '2px solid #E5E7EB',
                    borderRadius: '12px',
                    background: autoAttributionConfig.periodeLabel === 'Mois actuel' ? '#EFF6FF' : 'white',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s'
                  }}
                >
                  <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>üìÜ</div>
                  <div style={{fontWeight: '600', marginBottom: '0.25rem'}}>Mois actuel</div>
                  <div style={{fontSize: '0.875rem', color: '#6B7280'}}>
                    {new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                  </div>
                </button>

                {/* Mois suivant */}
                <button
                  onClick={() => {
                    const today = new Date();
                    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    const dateStr = nextMonth.toISOString().split('T')[0];
                    setAutoAttributionConfig({
                      ...autoAttributionConfig,
                      periode: 'mois',
                      periodeLabel: 'Mois suivant',
                      date: `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`
                    });
                  }}
                  style={{
                    padding: '1.5rem',
                    border: autoAttributionConfig.periodeLabel === 'Mois suivant' ? '3px solid #3B82F6' : '2px solid #E5E7EB',
                    borderRadius: '12px',
                    background: autoAttributionConfig.periodeLabel === 'Mois suivant' ? '#EFF6FF' : 'white',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s'
                  }}
                >
                  <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>üìÜ</div>
                  <div style={{fontWeight: '600', marginBottom: '0.25rem'}}>Mois suivant</div>
                  <div style={{fontSize: '0.875rem', color: '#6B7280'}}>
                    {new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                  </div>
                </button>
              </div>
              
              <div style={{marginTop: '1.5rem', padding: '1rem', background: '#EFF6FF', borderRadius: '8px'}}>
                <p style={{margin: 0, fontSize: '0.875rem', color: '#1E40AF'}}>
                  üí° L'attribution automatique cr√©era les assignations selon les r√®gles configur√©es dans Param√®tres.
                  {autoAttributionConfig.periode === 'mois' && ' Toutes les semaines du mois seront planifi√©es.'}
                </p>
              </div>

              {/* Choix du mode : Compl√©ter ou R√©initialiser */}
              <div style={{marginTop: '1.5rem'}}>
                <h3 style={{marginBottom: '1rem', fontSize: '1rem', fontWeight: '600'}}>‚öôÔ∏è Mode d'attribution</h3>
                
                <div style={{display: 'grid', gap: '1rem', gridTemplateColumns: 'repeat(2, 1fr)'}}>
                  {/* Option A : Compl√©ter */}
                  <button
                    onClick={() => setAutoAttributionConfig({...autoAttributionConfig, mode: 'completer'})}
                    style={{
                      padding: '1rem',
                      border: autoAttributionConfig.mode === 'completer' ? '3px solid #10B981' : '2px solid #E5E7EB',
                      borderRadius: '8px',
                      background: autoAttributionConfig.mode === 'completer' ? '#ECFDF5' : 'white',
                      cursor: 'pointer',
                      textAlign: 'left',
                      transition: 'all 0.2s'
                    }}
                  >
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>‚úÖ</div>
                    <div style={{fontWeight: '600', marginBottom: '0.25rem', color: '#10B981'}}>Compl√©ter le planning</div>
                    <div style={{fontSize: '0.8rem', color: '#6B7280'}}>
                      Conserve les assignations existantes et compl√®te les slots vides
                    </div>
                  </button>

                  {/* Option B : R√©initialiser */}
                  <button
                    onClick={() => setAutoAttributionConfig({...autoAttributionConfig, mode: 'reinitialiser'})}
                    style={{
                      padding: '1rem',
                      border: autoAttributionConfig.mode === 'reinitialiser' ? '3px solid #EF4444' : '2px solid #E5E7EB',
                      borderRadius: '8px',
                      background: autoAttributionConfig.mode === 'reinitialiser' ? '#FEF2F2' : 'white',
                      cursor: 'pointer',
                      textAlign: 'left',
                      transition: 'all 0.2s'
                    }}
                  >
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>üîÑ</div>
                    <div style={{fontWeight: '600', marginBottom: '0.25rem', color: '#EF4444'}}>R√©initialiser compl√®tement</div>
                    <div style={{fontSize: '0.8rem', color: '#6B7280'}}>
                      ‚ö†Ô∏è Supprime toutes les assignations AUTO et recommence
                    </div>
                  </button>
                </div>
              </div>
            </div>
            


            {/* Section Formatage Planning (DEMO uniquement) */}
            {tenantSlug === 'demo' && user?.role === 'admin' && (
              <div style={{
                marginTop: '30px',
                padding: '20px',
                backgroundColor: '#fef2f2',
                border: '2px solid #fecaca',
                borderRadius: '8px'
              }}>
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: showFormatageSection ? '15px' : '0'
                }}>
                  <h4 style={{ margin: 0, color: '#991b1b', fontSize: '14px' }}>
                    üóëÔ∏è Formatage Planning (DEMO)
                  </h4>
                  <button
                    onClick={() => setShowFormatageSection(!showFormatageSection)}
                    style={{
                      padding: '6px 12px',
                      backgroundColor: 'transparent',
                      border: '1px solid #dc2626',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '12px',
                      color: '#dc2626'
                    }}
                  >
                    {showFormatageSection ? '‚ñ≤ Masquer' : '‚ñº Afficher'}
                  </button>
                </div>

                {showFormatageSection && (
                  <div>
                    <p style={{ 
                      fontSize: '13px', 
                      color: '#7f1d1d',
                      marginBottom: '15px',
                      lineHeight: '1.5'
                    }}>
                      ‚ö†Ô∏è Cette fonctionnalit√© supprime <strong>toutes les assignations et demandes de remplacement</strong> du mois s√©lectionn√©. Utilisez-la pour vider le planning avant une d√©monstration.
                    </p>

                    <div style={{ marginBottom: '15px' }}>
                      <label style={{ 
                        display: 'block', 
                        marginBottom: '8px',
                        fontSize: '13px',
                        fontWeight: 'bold',
                        color: '#7f1d1d'
                      }}>
                        üìÖ S√©lectionner le mois √† formater:
                      </label>
                      <input
                        type="month"
                        value={moisFormatage}
                        onChange={(e) => setMoisFormatage(e.target.value)}
                        style={{
                          width: '100%',
                          padding: '10px',
                          border: '2px solid #dc2626',
                          borderRadius: '6px',
                          fontSize: '14px'
                        }}
                      />
                    </div>

                    <button
                      onClick={handleFormaterPlanning}
                      style={{
                        width: '100%',
                        padding: '12px',
                        backgroundColor: '#dc2626',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: 'bold',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseEnter={(e) => e.target.style.backgroundColor = '#b91c1c'}
                      onMouseLeave={(e) => e.target.style.backgroundColor = '#dc2626'}
                    >
                      üóëÔ∏è Formater le planning de {(() => {
                        const [year, month] = moisFormatage.split('-');
                        const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 
                                          'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
                        return `${monthNames[parseInt(month) - 1]} ${year}`;
                      })()}
                    </button>
                  </div>
                )}
              </div>
            )}

            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowAutoAttributionModal(false)}>Annuler</Button>
              <Button 
                onClick={handleAttributionAuto}
                disabled={!autoAttributionConfig.periodeLabel}
                style={{
                  opacity: !autoAttributionConfig.periodeLabel ? 0.5 : 1,
                  background: autoAttributionConfig.mode === 'reinitialiser' ? '#EF4444' : '#3B82F6'
                }}
              >
                {autoAttributionConfig.mode === 'reinitialiser' ? 'üîÑ R√©initialiser et Attribuer' : '‚ú® Lancer l\'attribution'}
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Rapport d'Heures */}
      {showRapportHeuresModal && (
        <RapportHeuresModal 
          isOpen={showRapportHeuresModal}
          onClose={() => setShowRapportHeuresModal(false)}
          tenantSlug={tenantSlug}
        />
      )}

      {/* Overlay de chargement Attribution Automatique */}
      {attributionLoading && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.75)',
          zIndex: 9999,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          backdropFilter: 'blur(4px)'
        }}>
          <div style={{
            background: 'white',
            borderRadius: '16px',
            padding: '40px',
            maxWidth: '500px',
            width: '90%',
            textAlign: 'center',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
          }}>
            {/* Spinner anim√© */}
            <div style={{
              width: '80px',
              height: '80px',
              margin: '0 auto 24px',
              border: '6px solid #f3f4f6',
              borderTop: '6px solid #dc2626',
              borderRadius: '50%',
              animation: 'spin 1s linear infinite'
            }}></div>
            
            {/* Message d'√©tape */}
            <h2 style={{
              fontSize: '1.5rem',
              fontWeight: '600',
              color: '#1e293b',
              marginBottom: '12px'
            }}>
              Attribution en cours...
            </h2>
            
            <p style={{
              fontSize: '1rem',
              color: '#64748b',
              marginBottom: '24px',
              minHeight: '24px'
            }}>
              {attributionStep}
            </p>
            
            {/* Barre de progression visuelle */}
            <div style={{
              width: '100%',
              height: '4px',
              backgroundColor: '#f3f4f6',
              borderRadius: '2px',
              overflow: 'hidden'
            }}>
              <div style={{
                height: '100%',
                backgroundColor: '#dc2626',
                animation: 'progress 2s ease-in-out infinite'
              }}></div>
            </div>
            
            <p style={{
              fontSize: '0.875rem',
              color: '#94a3b8',
              marginTop: '20px',
              fontStyle: 'italic'
            }}>
              Veuillez patienter, cela peut prendre quelques instants...
            </p>
          </div>
        </div>
      )}

      {/* Modal d'Audit de l'Affectation - Nouveau Design */}
      <AuditModal
        isOpen={showAuditModal}
        onClose={() => setShowAuditModal(false)}
        assignation={selectedAuditAssignation}
        auditNotes={auditNotesEdit}
        onSaveNotes={handleSaveAuditNotes}
      />

    </div>
  );
};

// Remplacements Component optimis√© - Gestion compl√®te remplacements et cong√©s
const Remplacements = () => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const [demandes, setDemandes] = useState([]);
  const [demandesConge, setDemandesConge] = useState([]);
  const [users, setUsers] = useState([]);
  const [typesGarde, setTypesGarde] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('remplacements');
  const [viewMode, setViewMode] = useState('liste'); // 'liste' ou 'cartes'
  const [filterStatut, setFilterStatut] = useState('tous'); // 'tous', 'en_attente', 'accepte', 'refuse'
  const [showCreateRemplacementModal, setShowCreateRemplacementModal] = useState(false);
  const [showCreateCongeModal, setShowCreateCongeModal] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const [exportType, setExportType] = useState(''); // 'pdf' ou 'excel'
  const [newDemande, setNewDemande] = useState({
    type_garde_id: '',
    date: '',
    raison: '',
    priorite: 'normale'
  });
  const [newConge, setNewConge] = useState({
    type_conge: '',
    date_debut: '',
    date_fin: '',
    raison: '',
    priorite: 'normale'
  });
  const { toast } = useToast();

  const typesConge = [
    { value: 'maladie', label: 'üè• Maladie', description: 'Arr√™t maladie avec justificatif' },
    { value: 'vacances', label: 'üèñÔ∏è Vacances', description: 'Cong√©s pay√©s annuels' },
    { value: 'parental', label: 'üë∂ Parental', description: 'Cong√© maternit√©/paternit√©' },
    { value: 'personnel', label: 'üë§ Personnel', description: 'Cong√© exceptionnel sans solde' }
  ];

  const niveauxPriorite = [
    { value: 'urgente', label: 'üö® Urgente', color: '#EF4444', description: 'Traitement imm√©diat requis' },
    { value: 'haute', label: 'üî• Haute', color: '#F59E0B', description: 'Traitement prioritaire dans 24h' },
    { value: 'normale', label: 'üìã Normale', color: '#3B82F6', description: 'Traitement dans d√©lai standard' },
    { value: 'faible', label: 'üìù Faible', color: '#6B7280', description: 'Traitement diff√©r√© possible' }
  ];

  useEffect(() => {
    fetchData();
  }, [tenantSlug]);

  const fetchData = async () => {
    if (!tenantSlug) return;
    
    setLoading(true);
    try {
      const promises = [
        apiGet(tenantSlug, '/remplacements'),
        apiGet(tenantSlug, '/demandes-conge'),
        apiGet(tenantSlug, '/types-garde')
      ];
      
      if (user.role !== 'employe') {
        promises.push(apiGet(tenantSlug, '/users'));
      }

      const responses = await Promise.all(promises);
      setDemandes(responses[0]);
      setDemandesConge(responses[1]);
      setTypesGarde(responses[2]);
      
      if (responses[3]) {
        setUsers(responses[3]);
      }
    } catch (error) {
      console.error('Erreur lors du chargement:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les donn√©es",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  const handleCreateRemplacement = async () => {
    if (!newDemande.type_garde_id || !newDemande.date || !newDemande.raison.trim()) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir tous les champs obligatoires",
        variant: "destructive"
      });
      return;
    }

    try {
      await apiPost(tenantSlug, '/remplacements', newDemande);
      toast({
        title: "Demande cr√©√©e",
        description: "Votre demande de remplacement a √©t√© soumise et la recherche automatique va commencer",
        variant: "success"
      });
      setShowCreateRemplacementModal(false);
      setNewDemande({ type_garde_id: '', date: '', raison: '', priorite: 'normale' });
      fetchData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de cr√©er la demande",
        variant: "destructive"
      });
    }
  };

  const handleCreateConge = async () => {
    if (!newConge.type_conge || !newConge.date_debut || !newConge.date_fin || !newConge.raison.trim()) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir tous les champs obligatoires",
        variant: "destructive"
      });
      return;
    }

    try {
      await apiPost(tenantSlug, '/demandes-conge', newConge);
      toast({
        title: "Demande de cong√© cr√©√©e",
        description: "Votre demande a √©t√© soumise et sera examin√©e par votre superviseur",
        variant: "success"
      });
      setShowCreateCongeModal(false);
      setNewConge({ type_conge: '', date_debut: '', date_fin: '', raison: '', priorite: 'normale' });
      fetchData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de cr√©er la demande de cong√©",
        variant: "destructive"
      });
    }
  };

  const handleApprouverConge = async (demandeId, action, commentaire = "") => {
    if (user.role === 'employe') return;

    try {
      await apiPut(tenantSlug, `/demandes-conge/${demandeId}/approuver?action=${action}&commentaire=${commentaire}`, {});
      toast({
        title: action === 'approuver' ? "Cong√© approuv√©" : "Cong√© refus√©",
        description: `La demande de cong√© a √©t√© ${action === 'approuver' ? 'approuv√©e' : 'refus√©e'}`,
        variant: "success"
      });
      fetchData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de traiter la demande",
        variant: "destructive"
      });
    }
  };

  const getStatutColor = (statut) => {
    switch (statut) {
      case 'en_cours': case 'en_attente': return '#F59E0B';
      case 'approuve': return '#10B981';
      case 'refuse': return '#EF4444';
      default: return '#6B7280';
    }
  };

  const getStatutLabel = (statut) => {
    switch (statut) {
      case 'en_cours': return 'En cours';
      case 'en_attente': return 'En attente';
      case 'approuve': return 'Approuv√©';
      case 'refuse': return 'Refus√©';
      default: return statut;
    }
  };

  const getTypeGardeName = (typeGardeId) => {
    const typeGarde = typesGarde.find(t => t.id === typeGardeId);
    return typeGarde ? typeGarde.nom : 'Type non sp√©cifi√©';
  };

  const handleFilterUrgentConges = () => {
    const congesUrgents = demandesConge.filter(d => d.priorite === 'urgente' && d.statut === 'en_attente');
    if (congesUrgents.length > 0) {
      toast({
        title: "Cong√©s urgents",
        description: `${congesUrgents.length} demande(s) urgente(s) n√©cessite(nt) un traitement imm√©diat`,
        variant: "destructive"
      });
    } else {
      toast({
        title: "Aucun cong√© urgent",
        description: "Aucune demande urgente en attente",
        variant: "default"
      });
    }
  };

  const handleExportConges = () => {
    try {
      // Simuler l'export (en production, √ßa g√©n√©rerait un fichier Excel/CSV)
      const exportData = demandesConge.map(conge => ({
        Demandeur: getUserName(conge.demandeur_id),
        Type: conge.type_conge,
        'Date d√©but': conge.date_debut,
        'Date fin': conge.date_fin,
        'Nombre jours': conge.nombre_jours,
        Priorit√©: conge.priorite,
        Statut: conge.statut,
        Raison: conge.raison
      }));
      
      console.log('Export data:', exportData);
      
      toast({
        title: "Export r√©ussi",
        description: `${demandesConge.length} demande(s) de cong√© export√©e(s)`,
        variant: "success"
      });
    } catch (error) {
      toast({
        title: "Erreur d'export",
        description: "Impossible d'exporter les donn√©es",
        variant: "destructive"
      });
    }
  };

  const handlePlanningImpact = () => {
    const congesApprouves = demandesConge.filter(d => d.statut === 'approuve');
    const joursImpactes = congesApprouves.reduce((total, conge) => total + conge.nombre_jours, 0);
    
    toast({
      title: "Impact sur le planning",
      description: `${congesApprouves.length} cong√©(s) approuv√©(s) = ${joursImpactes} jour(s) √† remplacer dans le planning`,
      variant: "default"
    });
  };

  const getUserName = (userId) => {
    const foundUser = users.find(u => u.id === userId);
    return foundUser ? `${foundUser.prenom} ${foundUser.nom}` : `Employ√© #${userId?.slice(-4)}`;
  };

  const getPrioriteColor = (priorite) => {
    const prioriteObj = niveauxPriorite.find(p => p.value === priorite);
    return prioriteObj ? prioriteObj.color : '#6B7280';
  };

  if (loading) return <div className="loading" data-testid="replacements-loading">Chargement...</div>;

  // Calculer les KPIs
  const totalDemandes = demandes.length;
  const enAttente = demandes.filter(d => d.statut === 'en_cours').length;
  const acceptees = demandes.filter(d => d.statut === 'approuve').length;
  const refusees = demandes.filter(d => d.statut === 'refuse').length;
  const remplacementsTrouves = demandes.filter(d => d.statut === 'approuve' && d.remplacant_id).length;
  const tauxSucces = totalDemandes > 0 ? Math.round((remplacementsTrouves / totalDemandes) * 100) : 0;
  const congesDuMois = demandesConge.length;

  // Filtrer les demandes selon le r√¥le et le filtre
  const getFilteredDemandes = () => {
    let filtered = user.role === 'employe' 
      ? demandes.filter(d => d.demandeur_id === user.id)
      : demandes;
    
    if (filterStatut !== 'tous') {
      const statutMap = {
        'en_attente': 'en_cours',
        'accepte': 'approuve',
        'refuse': 'refuse'
      };
      filtered = filtered.filter(d => d.statut === statutMap[filterStatut]);
    }
    
    return filtered;
  };

  const filteredDemandes = getFilteredDemandes();

  return (
    <div className="remplacements-refonte">
      {/* Header Moderne */}
      <div className="module-header">
        <div>
          <h1 data-testid="replacements-title">üîÑ Remplacements & Cong√©s</h1>
          <p>Gestion des demandes de remplacement avec recherche automatique et suivi des cong√©s</p>
        </div>
      </div>

      {/* KPIs */}
      <div className="kpi-grid" style={{marginBottom: '2rem'}}>
        <div className="kpi-card" style={{background: '#FCA5A5'}}>
          <h3>{totalDemandes}</h3>
          <p>Total Demandes</p>
        </div>
        <div className="kpi-card kpi-card-triple" style={{background: '#FEF3C7'}}>
          <div className="kpi-triple-container">
            <div className="kpi-triple-item">
              <h3>{enAttente}</h3>
              <p>En Attente</p>
            </div>
            <div className="kpi-triple-item">
              <h3>{acceptees}</h3>
              <p>Accept√©es</p>
            </div>
            <div className="kpi-triple-item">
              <h3>{refusees}</h3>
              <p>Refus√©es</p>
            </div>
          </div>
        </div>
        <div className="kpi-card" style={{background: '#D1FAE5'}}>
          <h3>{remplacementsTrouves}</h3>
          <p>Remplacements Trouv√©s</p>
        </div>
        <div className="kpi-card" style={{background: '#DBEAFE'}}>
          <h3>{tauxSucces}%</h3>
          <p>Taux de Succ√®s</p>
        </div>
        <div className="kpi-card" style={{background: '#E9D5FF'}}>
          <h3>{congesDuMois}</h3>
          <p>Cong√©s du Mois</p>
        </div>
      </div>

      {/* Barre de Contr√¥les */}
      <div className="personnel-controls" style={{marginBottom: '2rem'}}>
        <div style={{display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap', justifyContent: 'space-between'}}>
          {/* Boutons d'action */}
          <div style={{display: 'flex', gap: '1rem', flexWrap: 'wrap', alignItems: 'center'}}>
            <Button 
              variant="default" 
              onClick={() => setShowCreateRemplacementModal(true)}
              data-testid="create-replacement-btn"
            >
              üîÑ Demande de Remplacement
            </Button>
            <Button 
              variant="outline" 
              onClick={() => setShowCreateCongeModal(true)}
              data-testid="create-conge-btn"
            >
              üèñÔ∏è Demande de Cong√©
            </Button>
            
            {/* Filtre par statut */}
            <select 
              value={filterStatut}
              onChange={(e) => setFilterStatut(e.target.value)}
              style={{
                padding: '0.5rem 1rem',
                borderRadius: '8px',
                border: '1px solid #E5E7EB',
                cursor: 'pointer'
              }}
            >
              <option value="tous">üìã Tous les statuts</option>
              <option value="en_attente">‚è≥ En attente</option>
              <option value="accepte">‚úÖ Accept√©es</option>
              <option value="refuse">‚ùå Refus√©es</option>
            </select>

            {/* Toggle Vue Liste/Cartes */}
            <div className="view-toggle">
              <button 
                className={viewMode === 'liste' ? 'active' : ''}
                onClick={() => setViewMode('liste')}
                title="Vue Liste"
              >
                ‚ò∞
              </button>
              <button 
                className={viewMode === 'cartes' ? 'active' : ''}
                onClick={() => setViewMode('cartes')}
                title="Vue Cartes"
              >
                ‚äû
              </button>
            </div>
          </div>

          {/* Exports */}
          <div style={{display: 'flex', gap: '1rem'}}>
            <Button variant="outline" onClick={() => { setExportType('pdf'); setShowExportModal(true); }}>
              üìÑ Export PDF
            </Button>
            <Button variant="outline" onClick={() => { setExportType('excel'); setShowExportModal(true); }}>
              üìä Export Excel
            </Button>
          </div>
        </div>
      </div>

      {/* Onglets Remplacements / Cong√©s - Harmonis√©s */}
      <div style={{
        display: 'flex',
        gap: '1rem',
        marginBottom: '2rem',
        borderBottom: '2px solid #E5E7EB',
        paddingBottom: '0.5rem'
      }}>
        <button
          style={{
            padding: '0.75rem 1.5rem',
            border: 'none',
            background: activeTab === 'remplacements' ? '#FCA5A5' : 'transparent',
            color: activeTab === 'remplacements' ? 'white' : '#6B7280',
            borderRadius: '8px 8px 0 0',
            cursor: 'pointer',
            fontWeight: activeTab === 'remplacements' ? 'bold' : 'normal',
            fontSize: '1rem',
            transition: 'all 0.2s ease'
          }}
          onClick={() => setActiveTab('remplacements')}
          data-testid="tab-remplacements"
        >
          üîÑ Remplacements ({demandes.length})
        </button>
        <button
          style={{
            padding: '0.75rem 1.5rem',
            border: 'none',
            background: activeTab === 'conges' ? '#FCA5A5' : 'transparent',
            color: activeTab === 'conges' ? 'white' : '#6B7280',
            borderRadius: '8px 8px 0 0',
            cursor: 'pointer',
            fontWeight: activeTab === 'conges' ? 'bold' : 'normal',
            fontSize: '1rem',
            transition: 'all 0.2s ease'
          }}
          onClick={() => setActiveTab('conges')}
          data-testid="tab-conges"
        >
          üèñÔ∏è Cong√©s ({demandesConge.length})
        </button>
      </div>

      {/* Contenu des onglets */}
      <div className="tab-content">
        {activeTab === 'remplacements' && (
          <div className="remplacements-content">
              <div style={{ 
                background: '#eff6ff', 
                border: '1px solid #3b82f6', 
                borderRadius: '8px', 
                padding: '1rem', 
                marginBottom: '1.5rem',
                display: 'flex',
                alignItems: 'start',
                gap: '0.75rem'
              }}>
                <span style={{ fontSize: '1.5rem' }}>üí°</span>
                <div style={{ flex: 1 }}>
                  <strong style={{ color: '#1e40af', display: 'block', marginBottom: '0.5rem' }}>
                    Actions manuelles disponibles
                  </strong>
                  <p style={{ fontSize: '0.875rem', color: '#1e40af', margin: 0, lineHeight: '1.5' }}>
                    Les demandes de remplacement sont <strong>automatiquement trait√©es</strong> selon vos param√®tres. 
                    Les boutons ci-dessous permettent d'<strong>intervenir manuellement</strong> si n√©cessaire :
                  </p>
                  <ul style={{ fontSize: '0.875rem', color: '#1e40af', margin: '0.5rem 0 0 1.5rem', lineHeight: '1.6' }}>
                    <li><strong>üîç Recherche auto</strong> : Relancer la recherche si l'automatisation a √©chou√©</li>
                    <li><strong>‚úÖ Approuver</strong> : Valider manuellement (rempla√ßant trouv√© hors syst√®me)</li>
                    <li><strong>‚ùå Rejeter</strong> : Annuler si la demande n'est plus n√©cessaire</li>
                  </ul>
                </div>
              </div>
            )}

            {/* Liste des demandes de remplacement */}
            <div className="demandes-list">
              {demandes.length > 0 ? (
                demandes.map(demande => (
                  <div key={demande.id} className="demande-card" data-testid={`replacement-${demande.id}`}>
                    <div className="demande-header">
                      <div className="demande-info">
                        <h3>{getTypeGardeName(demande.type_garde_id)}</h3>
                        <span className="demande-date">{new Date(demande.date).toLocaleDateString('fr-FR')}</span>
                      </div>
                      <div className="demande-status">
                        <span 
                          className="status-badge" 
                          style={{ backgroundColor: getStatutColor(demande.statut) }}
                        >
                          {getStatutLabel(demande.statut)}
                        </span>
                      </div>
                    </div>
                    <div className="demande-details">
                      <p className="demande-raison">{demande.raison}</p>
                      <div className="demande-meta">
                        <span>Demand√© par: {getUserName(demande.demandeur_id)}</span>
                        <span>Le: {new Date(demande.created_at).toLocaleDateString('fr-FR')}</span>
                      </div>
                    </div>
                    {user.role !== 'employe' && demande.statut === 'en_cours' && (
                      <div className="demande-actions">
                        <Button 
                          variant="outline" 
                          size="sm" 
                          data-testid={`search-replacement-${demande.id}`}
                          title="Relancer une recherche automatique de rempla√ßant si l'automatisation a √©chou√© ou pour forcer une nouvelle recherche"
                          style={{ position: 'relative' }}
                        >
                          üîç Recherche auto
                          <span style={{ 
                            position: 'absolute', 
                            top: '-8px', 
                            right: '-8px', 
                            background: '#3b82f6', 
                            color: 'white', 
                            borderRadius: '50%', 
                            width: '18px', 
                            height: '18px', 
                            fontSize: '12px', 
                            display: 'flex', 
                            alignItems: 'center', 
                            justifyContent: 'center',
                            cursor: 'help'
                          }} title="Relancer une recherche automatique">?</span>
                        </Button>
                        <Button 
                          variant="ghost" 
                          size="sm" 
                          data-testid={`approve-replacement-${demande.id}`}
                          title="Approuver manuellement cette demande (si rempla√ßant trouv√© hors syst√®me ou validation manuelle requise)"
                        >
                          ‚úÖ
                        </Button>
                        <Button 
                          variant="ghost" 
                          size="sm" 
                          className="danger" 
                          data-testid={`reject-replacement-${demande.id}`}
                          title="Rejeter/Annuler cette demande (si plus n√©cessaire ou aucun rempla√ßant disponible)"
                        >
                          ‚ùå
                        </Button>
                      </div>
                    )}
                  </div>
                ))
              ) : (
                <div className="empty-state">
                  <h3>Aucune demande de remplacement</h3>
                  <p>Les demandes appara√Ætront ici.</p>
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === 'conges' && (
          <div className="conges-content">
            {/* En-t√™te de gestion toujours visible pour admin/superviseur */}
            {user.role !== 'employe' && (
              <div className="management-header">
                <div className="management-info">
                  <h3>üëë Gestion des demandes de cong√©</h3>
                  <p>
                    {user.role === 'admin' ? 
                      'Vous pouvez approuver toutes les demandes de cong√© (employ√©s et superviseurs)' : 
                      'Vous pouvez approuver les demandes des employ√©s uniquement'}
                  </p>
                </div>
                <div className="pending-indicator">
                  <span className="pending-count">{demandesConge.filter(d => d.statut === 'en_attente').length}</span>
                  <span className="pending-label">en attente d'approbation</span>
                </div>
              </div>
            )}

            {/* Boutons d'actions rapides pour admin/superviseur */}
            {user.role !== 'employe' && (
              <div className="management-actions">
                <Button 
                  variant="outline" 
                  size="sm" 
                  onClick={handleFilterUrgentConges}
                  data-testid="filter-urgent-conges"
                >
                  üö® Cong√©s urgents
                </Button>
                <Button 
                  variant="outline" 
                  size="sm" 
                  onClick={handleExportConges}
                  data-testid="export-conges"
                >
                  üìä Exporter cong√©s
                </Button>
                <Button 
                  variant="outline" 
                  size="sm" 
                  onClick={handlePlanningImpact}
                  data-testid="planning-impact"
                >
                  üìÖ Impact planning
                </Button>
              </div>
            )}

            {/* Statistics Cards pour cong√©s */}
            <div className="conge-stats">
              <div className="stat-card-conge pending">
                <div className="stat-icon">‚è≥</div>
                <div className="stat-content">
                  <h3>En attente</h3>
                  <p className="stat-number">{demandesConge.filter(d => d.statut === 'en_attente').length}</p>
                  <p className="stat-label">√Ä approuver</p>
                </div>
              </div>

              <div className="stat-card-conge approved">
                <div className="stat-icon">‚úÖ</div>
                <div className="stat-content">
                  <h3>Approuv√©s</h3>
                  <p className="stat-number">{demandesConge.filter(d => d.statut === 'approuve').length}</p>
                  <p className="stat-label">Ce mois</p>
                </div>
              </div>

              <div className="stat-card-conge total">
                <div className="stat-icon">üìä</div>
                <div className="stat-content">
                  <h3>Total jours</h3>
                  <p className="stat-number">{demandesConge.reduce((total, d) => total + (d.nombre_jours || 0), 0)}</p>
                  <p className="stat-label">Jours de cong√©</p>
                </div>
              </div>
            </div>

            {/* Liste des demandes de cong√© */}
            <div className="conges-list">
              {demandesConge.length > 0 ? (
                demandesConge.map(conge => (
                  <div key={conge.id} className="conge-card" data-testid={`conge-${conge.id}`}>
                    <div className="conge-header">
                      <div className="conge-type">
                        <span className="type-badge">
                          {typesConge.find(t => t.value === conge.type_conge)?.label || conge.type_conge}
                        </span>
                        <span 
                          className="priorite-badge" 
                          style={{ backgroundColor: getPrioriteColor(conge.priorite) }}
                        >
                          {niveauxPriorite.find(p => p.value === conge.priorite)?.label || conge.priorite}
                        </span>
                      </div>
                      <div className="conge-status">
                        <span 
                          className="status-badge" 
                          style={{ backgroundColor: getStatutColor(conge.statut) }}
                        >
                          {getStatutLabel(conge.statut)}
                        </span>
                      </div>
                    </div>
                    
                    <div className="conge-details">
                      <div className="conge-dates">
                        <span className="date-range">
                          {new Date(conge.date_debut).toLocaleDateString('fr-FR')} - {new Date(conge.date_fin).toLocaleDateString('fr-FR')}
                        </span>
                        <span className="jours-count">({conge.nombre_jours} jour{conge.nombre_jours > 1 ? 's' : ''})</span>
                      </div>
                      <p className="conge-raison">{conge.raison}</p>
                      <div className="conge-meta">
                        <span>Demand√© par: {getUserName(conge.demandeur_id)}</span>
                        <span>Le: {new Date(conge.created_at).toLocaleDateString('fr-FR')}</span>
                      </div>
                    </div>

                    {user.role !== 'employe' && conge.statut === 'en_attente' && (
                      <div className="conge-actions">
                        <Button 
                          variant="default" 
                          size="sm" 
                          onClick={() => handleApprouverConge(conge.id, 'approuver')}
                          data-testid={`approve-conge-${conge.id}`}
                        >
                          ‚úÖ Approuver
                        </Button>
                        <Button 
                          variant="destructive" 
                          size="sm" 
                          onClick={() => handleApprouverConge(conge.id, 'refuser')}
                          data-testid={`reject-conge-${conge.id}`}
                        >
                          ‚ùå Refuser
                        </Button>
                        <Button 
                          variant="outline" 
                          size="sm" 
                          data-testid={`comment-conge-${conge.id}`}
                        >
                          üí¨ Commenter
                        </Button>
                      </div>
                    )}

                    {/* Affichage des infos d'approbation si d√©j√† trait√©e */}
                    {conge.statut !== 'en_attente' && conge.approuve_par && (
                      <div className="approval-info">
                        <div className="approval-details">
                          <span className="approval-by">
                            {conge.statut === 'approuve' ? '‚úÖ' : '‚ùå'} 
                            {conge.statut === 'approuve' ? 'Approuv√©' : 'Refus√©'} par {getUserName(conge.approuve_par)}
                          </span>
                          <span className="approval-date">le {conge.date_approbation}</span>
                        </div>
                        {conge.commentaire_approbation && (
                          <div className="approval-comment">
                            <strong>Commentaire :</strong> {conge.commentaire_approbation}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                ))
              ) : (
                <div className="empty-state">
                  <h3>Aucune demande de cong√©</h3>
                  <p>
                    {user.role !== 'employe' 
                      ? 'Les demandes de cong√© des employ√©s appara√Ætront ici pour approbation.' 
                      : 'Vos demandes de cong√© appara√Ætront ici.'}
                  </p>
                  {user.role !== 'employe' && (
                    <div className="management-tips">
                      <h4>üí° Conseils de gestion :</h4>
                      <ul>
                        <li>Les demandes urgentes n√©cessitent un traitement imm√©diat</li>
                        <li>V√©rifiez l'impact sur le planning avant d'approuver</li>
                        <li>Ajoutez des commentaires pour justifier vos d√©cisions</li>
                      </ul>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Create Replacement Modal */}
      {showCreateRemplacementModal && (
        <div className="modal-overlay" onClick={() => setShowCreateRemplacementModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} data-testid="create-replacement-modal">
            <div className="modal-header">
              <h3>Nouvelle demande de remplacement</h3>
              <Button variant="ghost" onClick={() => setShowCreateRemplacementModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="form-field">
                <Label htmlFor="type-garde">Type de garde *</Label>
                <select
                  id="type-garde"
                  value={newDemande.type_garde_id}
                  onChange={(e) => setNewDemande({...newDemande, type_garde_id: e.target.value})}
                  className="form-select"
                  data-testid="select-garde-type"
                >
                  <option value="">S√©lectionner un type de garde</option>
                  {typesGarde.map(type => (
                    <option key={type.id} value={type.id}>
                      {type.nom} ({type.heure_debut} - {type.heure_fin})
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-field">
                <Label htmlFor="date">Date de la garde *</Label>
                <Input
                  id="date"
                  type="date"
                  value={newDemande.date}
                  onChange={(e) => setNewDemande({...newDemande, date: e.target.value})}
                  min={new Date().toISOString().split('T')[0]}
                  data-testid="select-date"
                />
              </div>

              <div className="form-field">
                <Label htmlFor="priorite">Priorit√©</Label>
                <select
                  id="priorite"
                  value={newDemande.priorite}
                  onChange={(e) => setNewDemande({...newDemande, priorite: e.target.value})}
                  className="form-select"
                  data-testid="select-priority"
                >
                  {niveauxPriorite.map(niveau => (
                    <option key={niveau.value} value={niveau.value}>
                      {niveau.label} - {niveau.description}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-field">
                <Label htmlFor="raison">Raison du remplacement *</Label>
                <textarea
                  id="raison"
                  value={newDemande.raison}
                  onChange={(e) => setNewDemande({...newDemande, raison: e.target.value})}
                  placeholder="Expliquez la raison de votre demande de remplacement (ex: maladie, cong√© personnel, urgence familiale...)"
                  rows="4"
                  className="form-textarea"
                  data-testid="replacement-reason"
                />
              </div>

              <div className="modal-actions">
                <Button 
                  variant="outline" 
                  onClick={() => setShowCreateRemplacementModal(false)}
                >
                  Annuler
                </Button>
                <Button 
                  variant="default" 
                  onClick={handleCreateRemplacement}
                  data-testid="submit-replacement-btn"
                >
                  Cr√©er la demande
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Create Conge Modal */}
      {showCreateCongeModal && (
        <div className="modal-overlay" onClick={() => setShowCreateCongeModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} data-testid="create-conge-modal">
            <div className="modal-header">
              <h3>Nouvelle demande de cong√©</h3>
              <Button variant="ghost" onClick={() => setShowCreateCongeModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="form-field">
                <Label htmlFor="type-conge">Type de cong√© *</Label>
                <select
                  id="type-conge"
                  value={newConge.type_conge}
                  onChange={(e) => setNewConge({...newConge, type_conge: e.target.value})}
                  className="form-select"
                  data-testid="select-conge-type"
                >
                  <option value="">S√©lectionner un type de cong√©</option>
                  {typesConge.map(type => (
                    <option key={type.value} value={type.value}>
                      {type.label} - {type.description}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-row">
                <div className="form-field">
                  <Label htmlFor="date-debut">Date de d√©but *</Label>
                  <Input
                    id="date-debut"
                    type="date"
                    value={newConge.date_debut}
                    onChange={(e) => setNewConge({...newConge, date_debut: e.target.value})}
                    min={new Date().toISOString().split('T')[0]}
                    data-testid="select-date-debut"
                  />
                </div>
                <div className="form-field">
                  <Label htmlFor="date-fin">Date de fin *</Label>
                  <Input
                    id="date-fin"
                    type="date"
                    value={newConge.date_fin}
                    onChange={(e) => setNewConge({...newConge, date_fin: e.target.value})}
                    min={newConge.date_debut || new Date().toISOString().split('T')[0]}
                    data-testid="select-date-fin"
                  />
                </div>
              </div>

              <div className="form-field">
                <Label htmlFor="priorite-conge">Priorit√©</Label>
                <select
                  id="priorite-conge"
                  value={newConge.priorite}
                  onChange={(e) => setNewConge({...newConge, priorite: e.target.value})}
                  className="form-select"
                  data-testid="select-conge-priority"
                >
                  {niveauxPriorite.map(niveau => (
                    <option key={niveau.value} value={niveau.value}>
                      {niveau.label} - {niveau.description}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-field">
                <Label htmlFor="raison-conge">Raison du cong√© *</Label>
                <textarea
                  id="raison-conge"
                  value={newConge.raison}
                  onChange={(e) => setNewConge({...newConge, raison: e.target.value})}
                  placeholder="Expliquez la raison de votre demande de cong√©..."
                  rows="4"
                  className="form-textarea"
                  data-testid="conge-reason"
                />
              </div>

              <div className="modal-actions">
                <Button 
                  variant="outline" 
                  onClick={() => setShowCreateCongeModal(false)}
                >
                  Annuler
                </Button>
                <Button 
                  variant="default" 
                  onClick={handleCreateConge}
                  data-testid="submit-conge-btn"
                >
                  Cr√©er la demande
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de demande de remplacement avec priorit√© */}
      {showCreateRemplacementModal && (
        <div className="modal-overlay" onClick={() => setShowCreateRemplacementModal(false)}>
          <div className="modal-content large-modal" onClick={(e) => e.stopPropagation()} data-testid="create-replacement-modal">
            <div className="modal-header">
              <h3>üîÑ Nouvelle demande de remplacement</h3>
              <Button variant="ghost" onClick={() => setShowCreateRemplacementModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="priority-section">
                <h4>üéØ Niveau de priorit√©</h4>
                <div className="priority-options">
                  {niveauxPriorite.map(priorite => (
                    <label key={priorite.value} className="priority-option">
                      <input
                        type="radio"
                        name="priorite"
                        value={priorite.value}
                        checked={newDemande.priorite === priorite.value}
                        onChange={(e) => setNewDemande({...newDemande, priorite: e.target.value})}
                      />
                      <div className="priority-content" style={{ borderColor: priorite.color }}>
                        <span className="priority-label" style={{ color: priorite.color }}>{priorite.label}</span>
                        <span className="priority-description">{priorite.description}</span>
                      </div>
                    </label>
                  ))}
                </div>
              </div>

              <div className="form-field">
                <Label>Type de garde *</Label>
                <select
                  value={newDemande.type_garde_id}
                  onChange={(e) => setNewDemande({...newDemande, type_garde_id: e.target.value})}
                  className="form-select"
                  data-testid="replacement-type-garde-select"
                >
                  <option value="">S√©lectionner un type de garde</option>
                  {typesGarde.map(type => (
                    <option key={type.id} value={type.id}>
                      {type.nom} ({type.heure_debut} - {type.heure_fin})
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-field">
                <Label>Date de la garde *</Label>
                <Input
                  type="date"
                  value={newDemande.date}
                  onChange={(e) => setNewDemande({...newDemande, date: e.target.value})}
                  min={new Date().toISOString().split('T')[0]}
                  data-testid="replacement-date-input"
                />
              </div>

              <div className="form-field">
                <Label>Raison du remplacement *</Label>
                <textarea
                  value={newDemande.raison}
                  onChange={(e) => setNewDemande({...newDemande, raison: e.target.value})}
                  placeholder="Expliquez la raison (maladie, urgence familiale, conflit horaire...)"
                  rows="3"
                  className="form-textarea"
                  data-testid="replacement-reason-input"
                />
              </div>

              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowCreateRemplacementModal(false)}>Annuler</Button>
                <Button variant="default" onClick={handleCreateRemplacement} data-testid="submit-replacement-btn">
                  Cr√©er la demande
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de demande de cong√© avec priorit√© */}
      {showCreateCongeModal && (
        <div className="modal-overlay" onClick={() => setShowCreateCongeModal(false)}>
          <div className="modal-content large-modal" onClick={(e) => e.stopPropagation()} data-testid="create-conge-modal">
            <div className="modal-header">
              <h3>üèñÔ∏è Nouvelle demande de cong√©</h3>
              <Button variant="ghost" onClick={() => setShowCreateCongeModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="priority-section">
                <h4>üéØ Niveau de priorit√©</h4>
                <div className="priority-options">
                  {niveauxPriorite.map(priorite => (
                    <label key={priorite.value} className="priority-option">
                      <input
                        type="radio"
                        name="priorite-conge"
                        value={priorite.value}
                        checked={newConge.priorite === priorite.value}
                        onChange={(e) => setNewConge({...newConge, priorite: e.target.value})}
                      />
                      <div className="priority-content" style={{ borderColor: priorite.color }}>
                        <span className="priority-label" style={{ color: priorite.color }}>{priorite.label}</span>
                        <span className="priority-description">{priorite.description}</span>
                      </div>
                    </label>
                  ))}
                </div>
              </div>

              <div className="form-field">
                <Label>Type de cong√© *</Label>
                <div className="conge-type-options">
                  {typesConge.map(type => (
                    <label key={type.value} className="conge-type-option">
                      <input
                        type="radio"
                        name="type-conge"
                        value={type.value}
                        checked={newConge.type_conge === type.value}
                        onChange={(e) => setNewConge({...newConge, type_conge: e.target.value})}
                      />
                      <div className="conge-type-content">
                        <span className="conge-type-label">{type.label}</span>
                        <span className="conge-type-description">{type.description}</span>
                      </div>
                    </label>
                  ))}
                </div>
              </div>

              <div className="form-row">
                <div className="form-field">
                  <Label>Date de d√©but *</Label>
                  <Input
                    type="date"
                    value={newConge.date_debut}
                    onChange={(e) => setNewConge({...newConge, date_debut: e.target.value})}
                    min={new Date().toISOString().split('T')[0]}
                    data-testid="conge-date-debut-input"
                  />
                </div>
                <div className="form-field">
                  <Label>Date de fin *</Label>
                  <Input
                    type="date"
                    value={newConge.date_fin}
                    onChange={(e) => setNewConge({...newConge, date_fin: e.target.value})}
                    min={newConge.date_debut || new Date().toISOString().split('T')[0]}
                    data-testid="conge-date-fin-input"
                  />
                </div>
              </div>

              <div className="form-field">
                <Label>Raison du cong√© *</Label>
                <textarea
                  value={newConge.raison}
                  onChange={(e) => setNewConge({...newConge, raison: e.target.value})}
                  placeholder="D√©crivez la raison de votre demande de cong√©..."
                  rows="3"
                  className="form-textarea"
                  data-testid="conge-reason-input"
                />
              </div>

              <div className="workflow-info">
                <h4>üìã Processus d'approbation</h4>
                <div className="workflow-steps">
                  <div className="workflow-step">
                    <span className="step-number">1</span>
                    <span>Soumission de la demande</span>
                  </div>
                  <div className="workflow-step">
                    <span className="step-number">2</span>
                    <span>
                      {user.role === 'employe' ? 'Approbation superviseur' : 'Approbation administrateur'}
                    </span>
                  </div>
                  <div className="workflow-step">
                    <span className="step-number">3</span>
                    <span>Notification et mise √† jour planning</span>
                  </div>
                </div>
              </div>

              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowCreateCongeModal(false)}>Annuler</Button>
                <Button variant="default" onClick={handleCreateConge} data-testid="submit-conge-btn">
                  Soumettre la demande
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}
      {/* Modal Export - Remplacements */}
      {showExportModal && (
        <div className="modal-overlay" onClick={() => setShowExportModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
            <div className="modal-header">
              <h3>üìä Export Remplacements {exportType === 'pdf' ? 'PDF' : 'Excel'}</h3>
              <Button variant="ghost" onClick={() => setShowExportModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body" style={{padding: '2rem'}}>
              <p style={{marginBottom: '1.5rem', color: '#64748b'}}>
                Que souhaitez-vous exporter ?
              </p>
              
              <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                <Button 
                  onClick={async () => {
                    try {
                      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
                      const token = localStorage.getItem(`${tenantSlug}_token`);
                      
                      const endpoint = exportType === 'pdf' ? 'export-pdf' : 'export-excel';
                      const url = `${backendUrl}/api/${tenantSlug}/remplacements/${endpoint}`;
                      
                      const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                      });
                      
                      if (!response.ok) throw new Error('Erreur export');
                      
                      const blob = await response.blob();
                      
                      if (exportType === 'pdf') {
                        // Pour les PDF, ouvrir directement le dialogue d'impression
                        const pdfUrl = window.URL.createObjectURL(blob);
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = pdfUrl;
                        document.body.appendChild(iframe);
                        
                        iframe.onload = function() {
                          iframe.contentWindow.print();
                          setTimeout(() => {
                            document.body.removeChild(iframe);
                            window.URL.revokeObjectURL(pdfUrl);
                          }, 100);
                        };
                      } else {
                        // Pour les Excel, t√©l√©charger directement
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = `remplacements_tous.xlsx`;
                        document.body.appendChild(link);
                        link.click();
                        link.remove();
                        window.URL.revokeObjectURL(downloadUrl);
                      }
                      
                      toast({ title: "Succ√®s", description: `Export ${exportType.toUpperCase()} t√©l√©charg√©` });
                      setShowExportModal(false);
                    } catch (error) {
                      toast({ title: "Erreur", description: "Impossible d'exporter", variant: "destructive" });
                    }
                  }}
                  style={{
                    padding: '1.5rem',
                    justifyContent: 'flex-start',
                    gap: '1rem',
                    fontSize: '1rem'
                  }}
                >
                  <span style={{fontSize: '1.5rem'}}>üìã</span>
                  <div style={{textAlign: 'left'}}>
                    <div style={{fontWeight: '600'}}>Toutes les demandes</div>
                    <div style={{fontSize: '0.875rem', opacity: 0.8}}>
                      Exporter toutes les demandes de remplacement ({demandes.length} demandes)
                    </div>
                  </div>
                </Button>

                <Button 
                  variant="outline"
                  onClick={() => {
                    toast({ title: "Info", description: "S√©lectionnez un pompier depuis le module Personnel pour exporter ses demandes" });
                  }}
                  style={{
                    padding: '1.5rem',
                    justifyContent: 'flex-start',
                    gap: '1rem',
                    fontSize: '1rem'
                  }}
                >
                  <span style={{fontSize: '1.5rem'}}>üë§</span>
                  <div style={{textAlign: 'left'}}>
                    <div style={{fontWeight: '600'}}>Une personne sp√©cifique</div>
                    <div style={{fontSize: '0.875rem', opacity: 0.8}}>
                      Disponible depuis le module Personnel
                    </div>
                  </div>
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Formations Component complet - Planning de formations


const Formations = () => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('formations');
  const [anneeSelectionnee, setAnneeSelectionnee] = useState(new Date().getFullYear());
  
  const [formations, setFormations] = useState([]);
  const [competences, setCompetences] = useState([]);
  const [inscriptions, setInscriptions] = useState([]);
  const [selectedFormation, setSelectedFormation] = useState(null);
  const [dashboardData, setDashboardData] = useState(null);
  const [rapportConformite, setRapportConformite] = useState(null);
  const [monTauxPresence, setMonTauxPresence] = useState(null);
  const [filtreNom, setFiltreNom] = useState('');
  const [triPresence, setTriPresence] = useState('desc');
  
  // √âtats pour les rapports avanc√©s
  const [rapportTab, setRapportTab] = useState('presence');  // 'presence' ou 'competences'
  const [typeFormation, setTypeFormation] = useState('toutes');  // 'obligatoires' ou 'toutes'
  const [rapportCompetences, setRapportCompetences] = useState(null);
  const [filtrePersonne, setFiltrePersonne] = useState('');  // ID de la personne ou vide pour tous
  const [personnel, setPersonnel] = useState([]);
  
  const [showFormationModal, setShowFormationModal] = useState(false);
  const [showInscriptionsModal, setShowInscriptionsModal] = useState(false);
  const [showValidationModal, setShowValidationModal] = useState(false);
  const [showValidateCompetenceModal, setShowValidateCompetenceModal] = useState(false);
  const [selectedUser, setSelectedUser] = useState(null);
  const [newValidation, setNewValidation] = useState({
    competence_id: '',
    justification: '',
    date_validation: new Date().toISOString().split('T')[0]
  });
  
  const [formationForm, setFormationForm] = useState({
    nom: '',
    competence_id: '',
    description: '',
    date_debut: '',
    date_fin: '',
    heure_debut: '09:00',
    heure_fin: '17:00',
    duree_heures: 8,
    lieu: '',
    instructeur: '',
    places_max: 20,
    obligatoire: false,
    annee: new Date().getFullYear()
  });
  
  useEffect(() => {
    if (tenantSlug) loadData();
  }, [tenantSlug, anneeSelectionnee]);
  
  useEffect(() => {
    if (tenantSlug && activeTab === 'rapports' && rapportTab === 'competences') {
      loadRapportCompetences();
    }
  }, [tenantSlug, activeTab, rapportTab, anneeSelectionnee, filtrePersonne]);
  
  const loadData = async () => {
    setLoading(true);
    try {
      if (user?.role === 'employe') {
        const [formationsData, competencesData, tauxData] = await Promise.all([
          apiGet(tenantSlug, `/formations?annee=${anneeSelectionnee}`),
          apiGet(tenantSlug, '/competences'),
          apiGet(tenantSlug, `/formations/mon-taux-presence?annee=${anneeSelectionnee}`)
        ]);
        setFormations(formationsData || []);
        setCompetences(competencesData || []);
        setMonTauxPresence(tauxData);
      } else {
        const [formationsData, competencesData, dashData, rapportData, personnelData] = await Promise.all([
          apiGet(tenantSlug, `/formations?annee=${anneeSelectionnee}`),
          apiGet(tenantSlug, '/competences'),
          apiGet(tenantSlug, `/formations/rapports/dashboard?annee=${anneeSelectionnee}`),
          apiGet(tenantSlug, `/formations/rapports/conformite?annee=${anneeSelectionnee}`),
          apiGet(tenantSlug, '/users')
        ]);
        setFormations(formationsData || []);
        setCompetences(competencesData || []);
        setDashboardData(dashData);
        setRapportConformite(rapportData);
        setPersonnel(personnelData || []);
      }
    } catch (error) {
      console.error('Erreur:', error);
    }
    setLoading(false);
  };
  
  const loadRapportCompetences = async () => {
    try {
      const params = filtrePersonne ? `?annee=${anneeSelectionnee}&user_id=${filtrePersonne}` : `?annee=${anneeSelectionnee}`;
      const data = await apiGet(tenantSlug, `/formations/rapports/competences${params}`);
      setRapportCompetences(data);
    } catch (error) {
      console.error('Erreur chargement rapport comp√©tences:', error);
    }
  };
  
  const handleExportPresence = async (format) => {
    try {
      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
      const token = localStorage.getItem(`${tenantSlug}_token`);
      
      const url = `${backendUrl}/api/${tenantSlug}/formations/rapports/export-presence?format=${format}&type_formation=${typeFormation}&annee=${anneeSelectionnee}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur lors de l\'export');
      
      const blob = await response.blob();
      
      if (format === 'pdf') {
        // Pour les PDF, ouvrir directement le dialogue d'impression
        const pdfUrl = window.URL.createObjectURL(blob);
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = pdfUrl;
        document.body.appendChild(iframe);
        
        iframe.onload = function() {
          iframe.contentWindow.print();
          setTimeout(() => {
            document.body.removeChild(iframe);
            window.URL.revokeObjectURL(pdfUrl);
          }, 100);
        };
      } else {
        // Pour les Excel, t√©l√©charger directement
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `rapport_presence_${typeFormation}_${anneeSelectionnee}.xlsx`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(downloadUrl);
      }
      
      toast({ title: "Succ√®s", description: `Rapport ${format.toUpperCase()} ${format === 'pdf' ? 'pr√™t √† imprimer' : 't√©l√©charg√©'}` });
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible de t√©l√©charger le rapport", variant: "destructive" });
    }
  };
  
  const handleValidateCompetence = async () => {
    if (!newValidation.competence_id || !newValidation.justification) {
      toast({
        title: "Champs requis",
        description: "Veuillez s√©lectionner une comp√©tence et fournir une justification",
        variant: "destructive"
      });
      return;
    }

    try {
      const validation = {
        user_id: selectedUser.id,
        competence_id: newValidation.competence_id,
        justification: newValidation.justification,
        date_validation: newValidation.date_validation
      };

      await apiPost(tenantSlug, '/validations-competences', validation);

      toast({
        title: "Succ√®s",
        description: "Rattrapage enregistr√© avec succ√®s",
        variant: "success"
      });

      // R√©initialiser le formulaire
      setNewValidation({
        competence_id: '',
        justification: '',
        date_validation: new Date().toISOString().split('T')[0]
      });
      setShowValidateCompetenceModal(false);
      
      // Recharger les donn√©es du rapport
      loadData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.detail || error.message || "Impossible d'enregistrer le rattrapage",
        variant: "destructive"
      });
    }
  };
  
  const handleExportCompetences = async (format) => {
    try {
      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
      const token = localStorage.getItem(`${tenantSlug}_token`);
      
      const userParam = filtrePersonne ? `&user_id=${filtrePersonne}` : '';
      const url = `${backendUrl}/api/${tenantSlug}/formations/rapports/export-competences?format=${format}&annee=${anneeSelectionnee}${userParam}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur lors de l\'export');
      
      const blob = await response.blob();
      
      if (format === 'pdf') {
        // Pour les PDF, ouvrir directement le dialogue d'impression
        const pdfUrl = window.URL.createObjectURL(blob);
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = pdfUrl;
        document.body.appendChild(iframe);
        
        iframe.onload = function() {
          iframe.contentWindow.print();
          setTimeout(() => {
            document.body.removeChild(iframe);
            window.URL.revokeObjectURL(pdfUrl);
          }, 100);
        };
      } else {
        // Pour les Excel, t√©l√©charger directement
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `rapport_competences_${anneeSelectionnee}.xlsx`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(downloadUrl);
      }
      
      toast({ title: "Succ√®s", description: `Rapport ${format.toUpperCase()} t√©l√©charg√©` });
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible de t√©l√©charger le rapport", variant: "destructive" });
    }
  };
  
  const handleSaveFormation = async () => {
    // Validation frontend
    if (!formationForm.nom || !formationForm.nom.trim()) {
      toast({ 
        title: "Erreur", 
        description: "Le nom de la formation est obligatoire", 
        variant: "destructive" 
      });
      return;
    }
    
    if (!formationForm.competence_id) {
      toast({ 
        title: "Erreur", 
        description: "Veuillez s√©lectionner une comp√©tence associ√©e", 
        variant: "destructive" 
      });
      return;
    }
    
    if (!formationForm.date_debut) {
      toast({ 
        title: "Erreur", 
        description: "La date de d√©but est obligatoire", 
        variant: "destructive" 
      });
      return;
    }
    
    // CALCUL AUTOMATIQUE de la dur√©e depuis heure_debut et heure_fin
    let formDataToSend = {...formationForm};
    if (formationForm.heure_debut && formationForm.heure_fin) {
      try {
        const [debutH, debutM] = formationForm.heure_debut.split(':').map(Number);
        const [finH, finM] = formationForm.heure_fin.split(':').map(Number);
        const dureeCalculee = (finH + finM/60) - (debutH + debutM/60);
        formDataToSend.duree_heures = Math.round(dureeCalculee * 100) / 100; // Arrondi √† 2 d√©cimales
      } catch (error) {
        console.error('Erreur calcul dur√©e:', error);
      }
    }
    
    try {
      if (selectedFormation) {
        await apiPut(tenantSlug, `/formations/${selectedFormation.id}`, formDataToSend);
        toast({ title: "Succ√®s", description: "Formation modifi√©e" });
      } else {
        await apiPost(tenantSlug, '/formations', formDataToSend);
        toast({ title: "Succ√®s", description: "Formation cr√©√©e" });
      }
      setShowFormationModal(false);
      loadData();
    } catch (error) {
      toast({ title: "Erreur", description: error.response?.data?.detail || "Erreur lors de la sauvegarde", variant: "destructive" });
    }
  };

  // Charger les comp√©tences √† l'ouverture du modal
  useEffect(() => {
    if (showFormationModal && tenantSlug) {
      const refreshCompetences = async () => {
        try {
          const competencesData = await apiGet(tenantSlug, '/competences');
          setCompetences(competencesData || []);
        } catch (error) {
          console.error('Erreur chargement comp√©tences:', error);
        }
      };
      refreshCompetences();
    }
  }, [showFormationModal, tenantSlug]);
  
  const handleInscrire = async (formationId) => {
    try {
      const result = await apiPost(tenantSlug, `/formations/${formationId}/inscription`, {});
      toast({
        title: "Succ√®s",
        description: result.statut === 'inscrit' ? 'Inscription confirm√©e' : 'Ajout√© √† la liste d\'attente'
      });
      loadData();
    } catch (error) {
      toast({ title: "Erreur", description: error.response?.data?.detail || "Erreur", variant: "destructive" });
    }
  };
  
  const handleDesinscrire = async (formationId) => {
    if (!window.confirm("√ätes-vous s√ªr de vouloir vous d√©sinscrire de cette formation?")) {
      return;
    }
    
    try {
      await apiDelete(tenantSlug, `/formations/${formationId}/inscription`);
      toast({
        title: "Succ√®s",
        description: "D√©sinscription r√©ussie"
      });
      loadData();
    } catch (error) {
      toast({ title: "Erreur", description: error.response?.data?.detail || "Erreur", variant: "destructive" });
    }
  };
  
  const handleValiderPresence = async (userId, statut) => {
    try {
      await apiPut(tenantSlug, `/formations/${selectedFormation.id}/presence/${userId}`, { statut, notes: '' });
      toast({ title: "Succ√®s", description: "Pr√©sence valid√©e" });
      loadInscriptions(selectedFormation.id);
    } catch (error) {
      toast({ title: "Erreur", description: error.response?.data?.detail || "Erreur", variant: "destructive" });
    }
  };
  
  const handleDeleteFormation = async (formationId) => {
    if (!window.confirm("√ätes-vous s√ªr de vouloir supprimer cette formation ? Cette action est irr√©versible.")) {
      return;
    }
    
    try {
      await apiDelete(tenantSlug, `/formations/${formationId}`);
      toast({ 
        title: "Succ√®s", 
        description: "Formation supprim√©e avec succ√®s",
        variant: "success"
      });
      loadData();
    } catch (error) {
      toast({ 
        title: "Erreur", 
        description: error.response?.data?.detail || "Impossible de supprimer la formation", 
        variant: "destructive" 
      });
    }
  };
  
  const loadInscriptions = async (formationId) => {
    try {
      const data = await apiGet(tenantSlug, `/formations/${formationId}/inscriptions`);
      setInscriptions(data || []);
    } catch (error) {
      console.error('Erreur:', error);
    }
  };
  
  const getCompetenceName = (id) => competences.find(c => c.id === id)?.nom || 'N/A';
  
  const getPompiersFiltreTri = () => {
    if (!rapportConformite) return [];
    let pompiers = [...rapportConformite.pompiers];
    if (filtreNom) {
      pompiers = pompiers.filter(p => `${p.prenom} ${p.nom}`.toLowerCase().includes(filtreNom.toLowerCase()));
    }
    pompiers.sort((a, b) => {
      const tauxA = a.taux_presence || 0;
      const tauxB = b.taux_presence || 0;
      return triPresence === 'desc' ? tauxB - tauxA : tauxA - tauxB;
    });
    return pompiers;
  };
  
  if (loading) {
    return <div className="module-container"><div className="loading-spinner"></div><p>Chargement...</p></div>;
  }
  
  return (
    <div className="module-formations-nfpa">
      <div className="module-header">
        <div>
          <h1>üìö Formations - NFPA 1500</h1>
          <p>Gestion des formations et conformit√© r√©glementaire</p>
        </div>
        <div className="header-controls">
          <select className="form-select" value={anneeSelectionnee} onChange={e => setAnneeSelectionnee(parseInt(e.target.value))}>
            {[2024, 2025, 2026, 2027].map(y => <option key={y} value={y}>{y}</option>)}
          </select>
        </div>
      </div>
      
      {user?.role === 'employe' && monTauxPresence && (
        <div className="mon-kpi-presence">
          <h2>üìä Mon Taux de Pr√©sence {anneeSelectionnee}</h2>
          <div className="kpi-personnel-grid">
            <div className="kpi-card-large">
              <div className="kpi-circle" style={{background: `conic-gradient(${monTauxPresence.conforme ? '#10B981' : '#EF4444'} ${monTauxPresence.taux_presence * 3.6}deg, #E5E7EB 0deg)`}}>
                <div className="kpi-circle-inner">
                  <h2>{monTauxPresence.taux_presence}%</h2>
                  <p>Pr√©sence</p>
                </div>
              </div>
              <div className="kpi-details">
                <p><strong>Pr√©sences:</strong> {monTauxPresence.presences_validees}</p>
                <p><strong>Absences:</strong> {monTauxPresence.absences}</p>
                <p><strong>Total:</strong> {monTauxPresence.formations_passees}</p>
              </div>
            </div>
            <div className={`statut-conformite ${monTauxPresence.conforme ? 'conforme' : 'non-conforme'}`}>
              {monTauxPresence.conforme ? <><h3>‚úÖ Conforme</h3><p>Taux de pr√©sence conforme</p></> : <><h3>‚ùå Non Conforme</h3><p>Am√©liorez votre pr√©sence</p></>}
            </div>
          </div>
        </div>
      )}
      
      {user?.role !== 'employe' && dashboardData && (
        <div className="formations-dashboard">
          <div className="kpi-grid">
            <div className="kpi-card"><h3>{dashboardData.heures_planifiees}h</h3><p>Heures planifi√©es</p></div>
            <div className="kpi-card" style={{background: '#D1FAE5'}}><h3>{dashboardData.heures_effectuees}h</h3><p>Heures effectu√©es</p></div>
            <div className="kpi-card" style={{background: '#DBEAFE'}}><h3>{dashboardData.pourcentage_realisation}%</h3><p>Taux r√©alisation</p></div>
            <div className="kpi-card" style={{background: '#FEF3C7'}}><h3>{dashboardData.pompiers_formes}/{dashboardData.total_pompiers}</h3><p>Pompiers form√©s</p></div>
            <div className="kpi-card" style={{background: '#E0E7FF'}}><h3>{dashboardData.pourcentage_pompiers}%</h3><p>% Pompiers</p></div>
          </div>
        </div>
      )}
      
      <div className="formations-tabs">
        <button className={activeTab === 'formations' ? 'active' : ''} onClick={() => setActiveTab('formations')}>üìã Formations ({formations.length})</button>
        {user?.role !== 'employe' && <button className={activeTab === 'rapports' ? 'active' : ''} onClick={() => setActiveTab('rapports')}>üìä Rapports</button>}
      </div>
      
      {activeTab === 'formations' && (
        <div className="formations-content">
          {user?.role !== 'employe' && (
            <div className="formations-actions"><Button onClick={() => { setSelectedFormation(null); setFormationForm({...formationForm, annee: anneeSelectionnee}); setShowFormationModal(true); }}>‚ûï Nouvelle Formation</Button></div>
          )}
          <div className="formations-grid">
            {formations.map(f => (
              <div key={f.id} className="formation-card">
                <div className="formation-header">
                  <h3>{f.nom}</h3>
                  <span className={`statut-badge ${f.statut}`}>{f.statut}</span>
                </div>
                <div className="formation-body">
                  <p><strong>üìÖ Date:</strong> {(() => {
                    // Parser la date comme locale sans conversion timezone
                    const [year, month, day] = f.date_debut.split('-');
                    const date = new Date(year, month - 1, day);
                    return date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                  })()}</p>
                  <p><strong>üïê Horaire:</strong> {f.heure_debut && f.heure_fin ? `${f.heure_debut} - ${f.heure_fin}` : 'Non pr√©cis√©'}</p>
                  <p><strong>üìç Lieu:</strong> {f.lieu || 'Non pr√©cis√©'}</p>
                  <p><strong>üë®‚Äçüè´ Instructeur:</strong> {f.instructeur || 'Non pr√©cis√©'}</p>
                  <p style={{fontSize: '0.9rem', color: '#6B7280'}}><strong>Comp√©tence:</strong> {getCompetenceName(f.competence_id)}</p>
                  
                  {/* Barre visuelle des places */}
                  <div style={{marginTop: '0.75rem'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '0.25rem', fontSize: '0.85rem'}}>
                      <span><strong>Places:</strong></span>
                      <span style={{color: f.places_restantes === 0 ? '#DC2626' : '#059669'}}>
                        {f.places_max - f.places_restantes}/{f.places_max}
                      </span>
                    </div>
                    <div style={{
                      width: '100%', 
                      height: '8px', 
                      background: '#F3F4F6', 
                      borderRadius: '4px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${((f.places_max - f.places_restantes) / f.places_max) * 100}%`,
                        height: '100%',
                        background: f.places_restantes === 0 ? '#DC2626' : '#10B981',
                        transition: 'width 0.3s ease'
                      }} />
                    </div>
                  </div>
                </div>
                <div className="formation-actions" style={{display: 'flex', flexDirection: 'column', gap: '0.75rem', padding: '1rem 1.5rem'}}>
                  {/* Bouton principal pour TOUS */}
                  {f.user_inscrit ? (
                    <Button 
                      variant="outline" 
                      onClick={() => handleDesinscrire(f.id)}
                      style={{width: '100%', fontSize: '0.95rem', padding: '0.75rem'}}
                    >
                      ‚ùå Je me d√©sinscris
                    </Button>
                  ) : (
                    <Button 
                      onClick={() => handleInscrire(f.id)} 
                      disabled={f.places_restantes === 0}
                      style={{width: '100%', fontSize: '0.95rem', padding: '0.75rem'}}
                    >
                      {f.places_restantes === 0 ? 'üîí Formation compl√®te' : '‚úÖ Je m\'inscris'}
                    </Button>
                  )}
                  
                  {/* Boutons de gestion pour admin/superviseur */}
                  {user?.role !== 'employe' && (
                    <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                      <Button 
                        size="sm" 
                        variant="outline" 
                        onClick={async () => { 
                          setSelectedFormation(f); 
                          await loadInscriptions(f.id); 
                          setShowInscriptionsModal(true); 
                        }}
                        style={{flex: '1 1 calc(50% - 0.25rem)'}}
                      >
                        üë• Inscrits ({f.places_max - f.places_restantes})
                      </Button>
                      <Button 
                        size="sm" 
                        onClick={async () => { 
                          setSelectedFormation(f); 
                          await loadInscriptions(f.id); 
                          setShowValidationModal(true); 
                        }}
                        style={{flex: '1 1 calc(50% - 0.25rem)'}}
                      >
                        ‚úÖ Pr√©sences
                      </Button>
                      <Button 
                        size="sm" 
                        variant="outline" 
                        onClick={() => { 
                          setSelectedFormation(f); 
                          setFormationForm({
                            nom: f.nom,
                            competence_id: f.competence_id,
                            description: f.description,
                            date_debut: f.date_debut,
                            heure_debut: f.heure_debut,
                            heure_fin: f.heure_fin,
                            duree_heures: f.duree_heures,
                            lieu: f.lieu,
                            instructeur: f.instructeur,
                            places_max: f.places_max,
                            obligatoire: f.obligatoire,
                            annee: f.annee
                          }); 
                          setShowFormationModal(true); 
                        }}
                        style={{flex: '1 1 calc(50% - 0.25rem)'}}
                      >
                        ‚úèÔ∏è Modifier
                      </Button>
                      <Button 
                        size="sm" 
                        variant="destructive" 
                        onClick={() => handleDeleteFormation(f.id)}
                        style={{flex: '1 1 calc(50% - 0.25rem)'}}
                      >
                        üóëÔ∏è Supprimer
                      </Button>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
          {formations.length === 0 && <div className="empty-state"><p>Aucune formation pour {anneeSelectionnee}</p></div>}
        </div>
      )}
      
      {activeTab === 'rapports' && rapportConformite && (
        <div className="formations-rapports">
          {/* Sous-onglets Rapports */}
          <div className="rapports-sub-tabs" style={{display: 'flex', gap: '1rem', marginBottom: '1.5rem', borderBottom: '2px solid #E5E7EB'}}>
            <button 
              className={rapportTab === 'presence' ? 'active-sub-tab' : 'sub-tab'} 
              onClick={() => setRapportTab('presence')}
              style={{
                padding: '0.75rem 1.5rem',
                background: rapportTab === 'presence' ? '#FCA5A5' : 'transparent',
                color: rapportTab === 'presence' ? 'white' : '#6B7280',
                border: 'none',
                borderRadius: '8px 8px 0 0',
                cursor: 'pointer',
                fontWeight: rapportTab === 'presence' ? 'bold' : 'normal',
                fontSize: '1rem'
              }}
            >
              üìä Taux de Pr√©sence
            </button>
            <button 
              className={rapportTab === 'competences' ? 'active-sub-tab' : 'sub-tab'} 
              onClick={() => setRapportTab('competences')}
              style={{
                padding: '0.75rem 1.5rem',
                background: rapportTab === 'competences' ? '#FCA5A5' : 'transparent',
                color: rapportTab === 'competences' ? 'white' : '#6B7280',
                border: 'none',
                borderRadius: '8px 8px 0 0',
                cursor: 'pointer',
                fontWeight: rapportTab === 'competences' ? 'bold' : 'normal',
                fontSize: '1rem'
              }}
            >
              üìà Par Comp√©tences
            </button>
          </div>
          
          {/* TAB TAUX DE PR√âSENCE */}
          {rapportTab === 'presence' && (
            <div>
              <h2>üìä Conformit√© NFPA 1500 - {anneeSelectionnee}</h2>
              
              {/* Boutons d'export */}
              <div style={{display: 'flex', gap: '1rem', marginBottom: '1.5rem', alignItems: 'center', flexWrap: 'wrap'}}>
                <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                  <Label style={{minWidth: '120px'}}>Type formations:</Label>
                  <select 
                    className="form-select" 
                    value={typeFormation} 
                    onChange={e => setTypeFormation(e.target.value)}
                    style={{padding: '0.5rem', borderRadius: '6px', border: '1px solid #D1D5DB'}}
                  >
                    <option value="toutes">Toutes</option>
                    <option value="obligatoires">Obligatoires uniquement</option>
                  </select>
                </div>
                <div style={{display: 'flex', gap: '0.5rem', marginLeft: 'auto'}}>
                  <Button onClick={() => handleExportPresence('pdf')} variant="outline" style={{background: '#EF4444', color: 'white'}}>
                    üìÑ Export PDF
                  </Button>
                  <Button onClick={() => handleExportPresence('excel')} variant="outline" style={{background: '#10B981', color: 'white'}}>
                    üìä Export Excel
                  </Button>
                </div>
              </div>
              
              <div className="conformite-stats">
                <div className="stat-card"><h3>{rapportConformite.total_pompiers}</h3><p>Total Pompiers</p></div>
                <div className="stat-card" style={{background: '#D1FAE5', border: '2px solid #10B981'}}><h3>{rapportConformite.conformes}</h3><p>‚úÖ Conformes</p></div>
                <div className="stat-card" style={{background: '#FEE2E2', border: '2px solid #EF4444'}}><h3>{rapportConformite.non_conformes}</h3><p>‚ùå Non Conformes</p></div>
                <div className="stat-card" style={{background: '#DBEAFE'}}><h3>{rapportConformite.pourcentage_conformite}%</h3><p>% Conformit√©</p></div>
              </div>
              
              <div className="rapports-controls" style={{marginTop: '2rem'}}>
                <div className="filtres-grid">
                  <div><Label>Rechercher</Label><Input placeholder="Nom..." value={filtreNom} onChange={e => setFiltreNom(e.target.value)} /></div>
                  <div><Label>Tri</Label><select className="form-select" value={triPresence} onChange={e => setTriPresence(e.target.value)}><option value="desc">Meilleur en premier</option><option value="asc">Faible en premier</option></select></div>
                  <div style={{display: 'flex', alignItems: 'flex-end'}}>
                    <Button 
                      onClick={() => window.location.reload()} 
                      variant="outline"
                      style={{height: 'fit-content'}}
                    >
                      üîÑ Rafra√Æchir
                    </Button>
                  </div>
                </div>
              </div>
              
              <div className="pompiers-list">
                {getPompiersFiltreTri().map(p => (
                  <div key={p.id} className={`pompier-card ${p.conforme ? 'conforme' : 'non-conforme'}`}>
                    <div className="pompier-info"><h4>{p.prenom} {p.nom}</h4><p>{p.grade}</p></div>
                    <div className="pompier-heures">
                      <div className="heures-bar">
                        <div 
                          className="heures-progress" 
                          style={{
                            width: `${Math.min(p.pourcentage, 100)}%`, 
                            background: p.conforme ? '#10B981' : '#EF4444'
                          }} 
                        />
                      </div>
                      <p><strong>{p.total_heures}h</strong> / {p.heures_requises}h ({p.pourcentage}%)</p>
                      <p style={{fontSize: '0.85rem', color: '#666'}}>Pr√©sence: {p.taux_presence}%</p>
                      {p.formations_obligatoires_ratees && p.formations_obligatoires_ratees.length > 0 && (
                        <p style={{fontSize: '0.75rem', color: '#dc2626', marginTop: '0.25rem'}}>
                          ‚ö†Ô∏è Formation(s) obligatoire(s) rat√©e(s): {p.formations_obligatoires_ratees.join(', ')}
                        </p>
                      )}
                    </div>
                    <div className="pompier-statut" style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                      {p.conforme ? (
                        <span className="badge-conforme">‚úÖ Conforme</span>
                      ) : (
                        <span className="badge-non-conforme">‚ùå Non conforme</span>
                      )}
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => {
                          console.log('üéñÔ∏è Clic Rattrapage - User ID:', p.id);
                          const userToSelect = personnel.find(u => u.id === p.id);
                          console.log('üë§ User trouv√©:', userToSelect);
                          console.log('üìö Competences disponibles:', competences.length);
                          setSelectedUser(userToSelect);
                          console.log('‚úÖ setSelectedUser appel√©');
                          setShowValidateCompetenceModal(true);
                          console.log('üö™ Modal ouvert:', true);
                        }}
                        title="Enregistrer un rattrapage de formation"
                      >
                        üéñÔ∏è Rattrapage
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {/* TAB RAPPORTS PAR COMP√âTENCES */}
          {rapportTab === 'competences' && (
            <div>
              <h2>üìà Rapports par Comp√©tences - {anneeSelectionnee}</h2>
              
              {/* Filtres et exports */}
              <div style={{display: 'flex', gap: '1rem', marginBottom: '1.5rem', alignItems: 'center', flexWrap: 'wrap'}}>
                <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                  <Label style={{minWidth: '120px'}}>Filtrer par personne:</Label>
                  <select 
                    className="form-select" 
                    value={filtrePersonne} 
                    onChange={e => setFiltrePersonne(e.target.value)}
                    style={{padding: '0.5rem', borderRadius: '6px', border: '1px solid #D1D5DB', minWidth: '200px'}}
                  >
                    <option value="">Tous les pompiers</option>
                    {personnel.map(p => (
                      <option key={p.id} value={p.id}>{p.prenom} {p.nom}</option>
                    ))}
                  </select>
                </div>
                <div style={{display: 'flex', gap: '0.5rem', marginLeft: 'auto'}}>
                  <Button onClick={() => handleExportCompetences('pdf')} variant="outline" style={{background: '#EF4444', color: 'white'}}>
                    üìÑ Export PDF
                  </Button>
                  <Button onClick={() => handleExportCompetences('excel')} variant="outline" style={{background: '#10B981', color: 'white'}}>
                    üìä Export Excel
                  </Button>
                </div>
              </div>
              
              {/* Statistiques globales */}
              {rapportCompetences && (
                <>
                  <div className="conformite-stats" style={{marginBottom: '2rem'}}>
                    <div className="stat-card">
                      <h3>{rapportCompetences.competences.length}</h3>
                      <p>Comp√©tences</p>
                    </div>
                    <div className="stat-card" style={{background: '#D1FAE5'}}>
                      <h3>{rapportCompetences.competences.reduce((sum, c) => sum + c.total_formations, 0)}</h3>
                      <p>Formations</p>
                    </div>
                    <div className="stat-card" style={{background: '#DBEAFE'}}>
                      <h3>{rapportCompetences.competences.reduce((sum, c) => sum + c.total_heures_planifiees, 0)}h</h3>
                      <p>Heures totales</p>
                    </div>
                    <div className="stat-card" style={{background: '#FEF3C7'}}>
                      <h3>
                        {rapportCompetences.competences.reduce((sum, c) => sum + c.total_inscriptions, 0) > 0
                          ? Math.round(
                              (rapportCompetences.competences.reduce((sum, c) => sum + c.presences, 0) /
                                rapportCompetences.competences.reduce((sum, c) => sum + c.total_inscriptions, 0)) *
                                100
                            )
                          : 0}
                        %
                      </h3>
                      <p>Taux pr√©sence moyen</p>
                    </div>
                  </div>
                  
                  {/* Liste des comp√©tences */}
                  <div className="competences-rapport-list">
                    {rapportCompetences.competences.map(comp => (
                      <div key={comp.competence_id} className="competence-rapport-card" style={{
                        background: 'white',
                        border: '1px solid #E5E7EB',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        marginBottom: '1rem',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                      }}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem'}}>
                          <div>
                            <h3 style={{fontSize: '1.25rem', fontWeight: 'bold', color: '#1F2937', marginBottom: '0.5rem'}}>
                              {comp.competence_nom}
                            </h3>
                            <p style={{color: '#6B7280', fontSize: '0.9rem'}}>
                              {comp.total_formations} formation{comp.total_formations > 1 ? 's' : ''} ‚Ä¢ {comp.total_heures_planifiees}h planifi√©es
                            </p>
                          </div>
                          <div style={{textAlign: 'right'}}>
                            <div style={{
                              fontSize: '1.5rem',
                              fontWeight: 'bold',
                              color: comp.taux_presence >= 80 ? '#10B981' : '#EF4444'
                            }}>
                              {comp.taux_presence}%
                            </div>
                            <p style={{fontSize: '0.8rem', color: '#6B7280'}}>Taux pr√©sence</p>
                          </div>
                        </div>
                        
                        <div style={{
                          display: 'grid',
                          gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))',
                          gap: '1rem',
                          marginTop: '1rem'
                        }}>
                          <div style={{padding: '0.75rem', background: '#F9FAFB', borderRadius: '8px'}}>
                            <p style={{fontSize: '0.85rem', color: '#6B7280', marginBottom: '0.25rem'}}>Inscrits</p>
                            <p style={{fontSize: '1.25rem', fontWeight: 'bold', color: '#1F2937'}}>{comp.total_inscrits}</p>
                          </div>
                          <div style={{padding: '0.75rem', background: '#F9FAFB', borderRadius: '8px'}}>
                            <p style={{fontSize: '0.85rem', color: '#6B7280', marginBottom: '0.25rem'}}>Pr√©sences</p>
                            <p style={{fontSize: '1.25rem', fontWeight: 'bold', color: '#10B981'}}>{comp.presences}</p>
                          </div>
                          <div style={{padding: '0.75rem', background: '#F9FAFB', borderRadius: '8px'}}>
                            <p style={{fontSize: '0.85rem', color: '#6B7280', marginBottom: '0.25rem'}}>Absences</p>
                            <p style={{fontSize: '1.25rem', fontWeight: 'bold', color: '#EF4444'}}>{comp.absences}</p>
                          </div>
                          <div style={{padding: '0.75rem', background: '#F9FAFB', borderRadius: '8px'}}>
                            <p style={{fontSize: '0.85rem', color: '#6B7280', marginBottom: '0.25rem'}}>Heures effectu√©es</p>
                            <p style={{fontSize: '1.25rem', fontWeight: 'bold', color: '#3B82F6'}}>{comp.heures_effectuees}h</p>
                          </div>
                        </div>
                        
                        {/* Barre de progression */}
                        <div style={{marginTop: '1rem'}}>
                          <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '0.85rem', color: '#6B7280', marginBottom: '0.25rem'}}>
                            <span>R√©alisation</span>
                            <span>{comp.taux_realisation}%</span>
                          </div>
                          <div style={{
                            width: '100%',
                            height: '8px',
                            background: '#E5E7EB',
                            borderRadius: '4px',
                            overflow: 'hidden'
                          }}>
                            <div style={{
                              width: `${Math.min(comp.taux_realisation, 100)}%`,
                              height: '100%',
                              background: comp.taux_realisation >= 80 ? '#10B981' : comp.taux_realisation >= 50 ? '#F59E0B' : '#EF4444',
                              transition: 'width 0.3s ease'
                            }} />
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  {rapportCompetences.competences.length === 0 && (
                    <div className="empty-state">
                      <p>Aucune donn√©e de comp√©tence pour {anneeSelectionnee}</p>
                    </div>
                  )}
                </>
              )}
            </div>
          )}
        </div>
      )}
      
      {showFormationModal && (
        <div className="modal-overlay" onClick={() => setShowFormationModal(false)}>
          <div className="modal-content large-modal formation-modal-modern" onClick={e => e.stopPropagation()}>
            <div className="modal-header modal-header-modern">
              <h2 style={{margin: 0, display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                {selectedFormation ? '‚úèÔ∏è Modifier la Formation' : '‚ûï Nouvelle Formation'}
              </h2>
              <Button variant="ghost" onClick={() => setShowFormationModal(false)} style={{fontSize: '1.5rem'}}>‚úï</Button>
            </div>
            <div className="modal-body modal-body-modern">
              <div className="form-grid form-grid-modern">
                <div className="form-field-modern">
                  <Label>Nom de la formation *</Label>
                  <Input 
                    value={formationForm.nom} 
                    onChange={e => setFormationForm({...formationForm, nom: e.target.value})} 
                    placeholder="Ex: Formation incendie niveau 1"
                  />
                </div>
                <div className="form-field-modern">
                  <Label>Comp√©tence associ√©e *</Label>
                  <select 
                    className="form-select form-select-modern" 
                    value={formationForm.competence_id} 
                    onChange={e => setFormationForm({...formationForm, competence_id: e.target.value})}
                  >
                    <option value="">S√©lectionner une comp√©tence...</option>
                    {competences.map(c => <option key={c.id} value={c.id}>{c.nom}</option>)}
                  </select>
                </div>
                
                <div className="form-row-full">
                  <div className="form-field-modern">
                    <Label>Date de la formation *</Label>
                    <Input 
                      type="date" 
                      value={formationForm.date_debut} 
                      onChange={e => setFormationForm({...formationForm, date_debut: e.target.value})} 
                    />
                  </div>
                  <div className="form-field-modern">
                    <Label>Heure de d√©but</Label>
                    <Input 
                      type="time" 
                      value={formationForm.heure_debut} 
                      onChange={e => setFormationForm({...formationForm, heure_debut: e.target.value})} 
                    />
                  </div>
                  <div className="form-field-modern">
                    <Label>Heure de fin</Label>
                    <Input 
                      type="time" 
                      value={formationForm.heure_fin} 
                      onChange={e => setFormationForm({...formationForm, heure_fin: e.target.value})} 
                    />
                  </div>
                </div>
                
                <div className="form-field-modern">
                  <Label>Nombre de places *</Label>
                  <Input 
                    type="number" 
                    value={formationForm.places_max} 
                    onChange={e => setFormationForm({...formationForm, places_max: parseInt(e.target.value) || 20})} 
                    min="1"
                  />
                </div>
                <div className="form-field-modern">
                  <Label>Lieu</Label>
                  <Input 
                    value={formationForm.lieu} 
                    onChange={e => setFormationForm({...formationForm, lieu: e.target.value})} 
                    placeholder="Ex: Caserne principale"
                  />
                </div>
                <div className="form-field-modern">
                  <Label>Instructeur</Label>
                  <Input 
                    value={formationForm.instructeur} 
                    onChange={e => setFormationForm({...formationForm, instructeur: e.target.value})} 
                    placeholder="Nom de l'instructeur"
                  />
                </div>
                
                <div style={{gridColumn: '1 / -1'}}>
                  <label style={{display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: '#FEF2F2', borderRadius: '8px', cursor: 'pointer'}}>
                    <input 
                      type="checkbox" 
                      checked={formationForm.obligatoire} 
                      onChange={e => setFormationForm({...formationForm, obligatoire: e.target.checked})} 
                      style={{width: '20px', height: '20px', cursor: 'pointer'}} 
                    />
                    <strong style={{color: '#991B1B'}}>Formation obligatoire (NFPA 1500)</strong>
                  </label>
                </div>
              </div>
              
              <div style={{marginTop: '1.5rem'}}>
                <Label>Description</Label>
                <textarea 
                  className="form-textarea form-textarea-modern" 
                  rows="4" 
                  value={formationForm.description} 
                  onChange={e => setFormationForm({...formationForm, description: e.target.value})} 
                  placeholder="D√©crivez le contenu et les objectifs de la formation..."
                />
              </div>
            </div>
            <div className="modal-actions modal-actions-modern">
              <Button variant="outline" onClick={() => setShowFormationModal(false)}>
                Annuler
              </Button>
              <Button onClick={handleSaveFormation} style={{background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)', color: 'white'}}>
                {selectedFormation ? 'üíæ Sauvegarder' : '‚úÖ Cr√©er la formation'}
              </Button>
            </div>
          </div>
        </div>
      )}
      
      {showInscriptionsModal && selectedFormation && (
        <div className="modal-overlay" onClick={() => setShowInscriptionsModal(false)}>
          <div className="modal-content large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>üë• Inscrits - {selectedFormation.nom}</h2>
              <Button variant="ghost" onClick={() => setShowInscriptionsModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div style={{marginBottom: '1.5rem', padding: '1rem', background: '#F9FAFB', borderRadius: '8px'}}>
                <div style={{display: 'flex', gap: '2rem', justifyContent: 'center'}}>
                  <div style={{textAlign: 'center'}}>
                    <div style={{fontSize: '2rem', fontWeight: '700', color: '#10B981'}}>
                      {inscriptions.filter(i => i.statut === 'inscrit').length}
                    </div>
                    <div style={{fontSize: '0.875rem', color: '#6B7280'}}>Inscrits confirm√©s</div>
                  </div>
                  <div style={{textAlign: 'center'}}>
                    <div style={{fontSize: '2rem', fontWeight: '700', color: '#F59E0B'}}>
                      {inscriptions.filter(i => i.statut === 'en_attente').length}
                    </div>
                    <div style={{fontSize: '0.875rem', color: '#6B7280'}}>En attente</div>
                  </div>
                  <div style={{textAlign: 'center'}}>
                    <div style={{fontSize: '2rem', fontWeight: '700', color: '#6B7280'}}>
                      {selectedFormation.places_restantes}
                    </div>
                    <div style={{fontSize: '0.875rem', color: '#6B7280'}}>Places restantes</div>
                  </div>
                </div>
              </div>

              {inscriptions.length > 0 ? (
                <div className="inscriptions-list" style={{maxHeight: '400px', overflowY: 'auto'}}>
                  {inscriptions.map(insc => (
                    <div key={insc.id} className="inscription-item" style={{
                      display: 'flex', 
                      justifyContent: 'space-between', 
                      alignItems: 'center',
                      padding: '1rem',
                      borderBottom: '1px solid #E5E7EB',
                      transition: 'background 0.2s'
                    }}
                    onMouseEnter={e => e.currentTarget.style.background = '#F9FAFB'}
                    onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                    >
                      <div>
                        <div style={{fontWeight: '600', fontSize: '0.95rem'}}>{insc.user_nom}</div>
                        <div style={{fontSize: '0.813rem', color: '#6B7280', marginTop: '0.25rem'}}>
                          Inscrit le {new Date(insc.created_at).toLocaleDateString('fr-FR')}
                        </div>
                      </div>
                      <span className={`badge-${insc.statut}`} style={{
                        padding: '0.4rem 0.8rem',
                        borderRadius: '6px',
                        fontSize: '0.813rem',
                        fontWeight: '600'
                      }}>
                        {insc.statut === 'inscrit' ? '‚úÖ Inscrit' : 
                         insc.statut === 'en_attente' ? '‚è≥ En attente' : 
                         insc.statut === 'present' ? '‚úÖ Pr√©sent' : '‚ùå Absent'}
                      </span>
                    </div>
                  ))}
                </div>
              ) : (
                <div style={{textAlign: 'center', padding: '3rem', color: '#9CA3AF'}}>
                  <div style={{fontSize: '3rem', marginBottom: '1rem'}}>üë•</div>
                  <p style={{fontSize: '1rem'}}>Aucun inscrit pour cette formation</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
      
      {showValidationModal && selectedFormation && (
        <div className="modal-overlay" onClick={() => setShowValidationModal(false)}>
          <div className="modal-content large-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><h2>‚úÖ Validation Pr√©sences - {selectedFormation.nom}</h2><Button variant="ghost" onClick={() => setShowValidationModal(false)}>‚úï</Button></div>
            <div className="modal-body">
              <p style={{marginBottom: '1.5rem'}}>Validez la pr√©sence. Seuls les pr√©sents seront cr√©dit√©s de {selectedFormation.duree_heures}h.</p>
              <div className="validation-list">
                {inscriptions.filter(i => i.statut === 'inscrit' || i.statut === 'present' || i.statut === 'absent').map(insc => (
                  <div key={insc.id} className="validation-item">
                    <div><strong>{insc.user_nom}</strong><p>{insc.user_grade}</p></div>
                    <div className="validation-buttons">
                      <Button size="sm" variant={insc.statut === 'present' ? 'default' : 'outline'} onClick={() => handleValiderPresence(insc.user_id, 'present')}>‚úÖ Pr√©sent</Button>
                      <Button size="sm" variant={insc.statut === 'absent' ? 'destructive' : 'outline'} onClick={() => handleValiderPresence(insc.user_id, 'absent')}>‚ùå Absent</Button>
                    </div>
                    {insc.heures_creditees > 0 && <span className="heures-creditees">{insc.heures_creditees}h</span>}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Modal de validation de comp√©tence / rattrapage */}
      {showValidateCompetenceModal && selectedUser && (
        <div className="modal-overlay" onClick={() => setShowValidateCompetenceModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '550px' }}>
            <div className="modal-header">
              <h3>üéñÔ∏è Enregistrer un Rattrapage</h3>
              <Button variant="ghost" onClick={() => setShowValidateCompetenceModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              <p style={{ marginBottom: '1rem', color: '#64748b' }}>
                Employ√©: <strong>{selectedUser.prenom} {selectedUser.nom}</strong>
              </p>
              
              <div className="form-field">
                <Label>Comp√©tence</Label>
                <select
                  value={newValidation.competence_id}
                  onChange={(e) => setNewValidation({...newValidation, competence_id: e.target.value})}
                  className="form-select"
                >
                  <option value="">S√©lectionner une comp√©tence</option>
                  {competences.map(comp => (
                    <option key={comp.id} value={comp.id}>{comp.nom}</option>
                  ))}
                </select>
              </div>
              
              <div className="form-field">
                <Label>Justification</Label>
                <textarea
                  value={newValidation.justification}
                  onChange={(e) => setNewValidation({...newValidation, justification: e.target.value})}
                  placeholder="Expliquez pourquoi cette comp√©tence doit √™tre valid√©e manuellement..."
                  rows="4"
                  className="form-input"
                />
              </div>
              
              <div className="form-field">
                <Label>Date de validation</Label>
                <Input
                  type="date"
                  value={newValidation.date_validation}
                  onChange={(e) => setNewValidation({...newValidation, date_validation: e.target.value})}
                />
              </div>
            </div>
            
            <div className="modal-footer">
              <Button variant="outline" onClick={() => setShowValidateCompetenceModal(false)}>
                Annuler
              </Button>
              <Button onClick={handleValidateCompetence}>
                ‚úÖ Enregistrer
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const MesDisponibilites = ({ managingUser, setCurrentPage, setManagingUserDisponibilites }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  
  // D√©terminer quel utilisateur on g√®re (soi-m√™me ou un autre)
  const targetUser = managingUser || user;
  const [userDisponibilites, setUserDisponibilites] = useState([]);
  const [users, setUsers] = useState([]); // Liste de tous les utilisateurs pour les KPIs
  const [typesGarde, setTypesGarde] = useState([]);
  const [loading, setLoading] = useState(true);
  const [savingDisponibilites, setSavingDisponibilites] = useState(false);
  const [savingMessage, setSavingMessage] = useState('');
  const [showExportModal, setShowExportModal] = useState(false);
  const [exportType, setExportType] = useState(''); // 'pdf' ou 'excel'
  const [showCalendarModal, setShowCalendarModal] = useState(false);
  const [showGenerationModal, setShowGenerationModal] = useState(false);
  const [selectedDates, setSelectedDates] = useState([]);
  
  // √âtats pour le calendrier visuel mensuel
  const [calendarCurrentMonth, setCalendarCurrentMonth] = useState(new Date().getMonth());
  const [calendarCurrentYear, setCalendarCurrentYear] = useState(new Date().getFullYear());
  const [selectedDayForDetail, setSelectedDayForDetail] = useState(null);
  const [showDayDetailModal, setShowDayDetailModal] = useState(false);
  const [dayDetailData, setDayDetailData] = useState({ disponibilites: [], indisponibilites: [] });
  const [selectedDateDetails, setSelectedDateDetails] = useState(null);
  const [pendingConfigurations, setPendingConfigurations] = useState([]);
  const [availabilityConfig, setAvailabilityConfig] = useState({
    type_garde_id: '',
    heure_debut: '08:00',
    heure_fin: '16:00',
    statut: 'disponible',
    // Pour mode r√©currence
    mode: 'calendrier', // 'calendrier' ou 'recurrence'
    date_debut: new Date().toISOString().split('T')[0],
    date_fin: new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0],
    recurrence_type: 'hebdomadaire',
    recurrence_frequence: 'jours',
    recurrence_intervalle: 1,
    jours_semaine: [] // Pour s√©lection des jours en mode hebdomadaire/bihebdomadaire
  });

  // √âtats pour la gestion des conflits
  const [showConflictModal, setShowConflictModal] = useState(false);
  const [conflictData, setConflictData] = useState({
    conflicts: [],
    newItem: null,
    itemType: null
  });
  const [generationConfig, setGenerationConfig] = useState({
    horaire_type: 'montreal',
    equipe: 'Rouge',
    date_debut: new Date().toISOString().split('T')[0],  // Date du jour
    date_fin: new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0],  // 31 d√©cembre de l'ann√©e en cours
    conserver_manuelles: true
  });
  const [isGenerating, setIsGenerating] = useState(false);
  const [indispoTab, setIndispoTab] = useState('generation'); // 'generation', 'manuelle_calendrier', 'manuelle_recurrence'
  const [manualIndispoMode, setManualIndispoMode] = useState('calendrier'); // 'calendrier' ou 'recurrence'
  const [manualIndispoConfig, setManualIndispoConfig] = useState({
    // Pour mode calendrier (clics multiples)
    dates: [],
    
    // Pour mode r√©currence
    date_debut: new Date().toISOString().split('T')[0],
    date_fin: new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0],
    heure_debut: '00:00',
    heure_fin: '23:59',
    
    // Options de r√©currence
    recurrence_type: 'hebdomadaire', // 'hebdomadaire', 'bihebdomadaire', 'mensuelle', 'annuelle', 'personnalisee'
    recurrence_frequence: 'jours', // Pour personnalis√©e: 'jours', 'semaines', 'mois', 'ans'
    recurrence_intervalle: 1, // Tous les X (jours/semaines/mois/ans)
    jours_semaine: [] // Pour s√©lection des jours en mode hebdomadaire/bihebdomadaire
  });
  const [showReinitModal, setShowReinitModal] = useState(false);
  const [reinitConfig, setReinitConfig] = useState({
    periode: 'mois',
    mode: 'generees_seulement',
    type_entree: 'les_deux',
    date_debut: new Date().toISOString().split('T')[0],
    date_fin: new Date().toISOString().split('T')[0]
  });

  // √âtats pour formatage planning (demo uniquement)
  const [showFormatageSection, setShowFormatageSection] = useState(false);
  const [moisFormatage, setMoisFormatage] = useState(() => {
    const today = new Date();
    return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
  });
  const [isReinitializing, setIsReinitializing] = useState(false);
  const [reinitWarning, setReinitWarning] = useState(null);
  
  // Nouveau modal d'ajout rapide
  const [showQuickAddModal, setShowQuickAddModal] = useState(false);
  const [quickAddType, setQuickAddType] = useState('disponibilite'); // 'disponibilite' ou 'indisponibilite'
  const [quickAddConfig, setQuickAddConfig] = useState({
    date: new Date().toISOString().split('T')[0],
    type_garde_id: '',
    heure_debut: '08:00',
    heure_fin: '16:00'
  });
  
  // √âtat pour le nouveau modal de r√©solution de conflits multiples
  const [showBatchConflictModal, setShowBatchConflictModal] = useState(false);
  const [batchConflicts, setBatchConflicts] = useState([]);
  const [batchConflictSelections, setBatchConflictSelections] = useState({});
  
  const { toast } = useToast();

  useEffect(() => {
    const fetchDisponibilites = async () => {
      if (!tenantSlug) return;
      
      try {
        const [dispoData, typesData, usersData] = await Promise.all([
          apiGet(tenantSlug, `/disponibilites/${targetUser.id}`),
          apiGet(tenantSlug, '/types-garde'),
          apiGet(tenantSlug, '/users') // Tous les r√¥les peuvent voir les users (lecture seule)
        ]);
        setUserDisponibilites(dispoData);
        setTypesGarde(typesData);
        setUsers(usersData);
      } catch (error) {
        console.error('Erreur lors du chargement des disponibilit√©s:', error);
        toast({
          title: "Erreur",
          description: "Impossible de charger les disponibilit√©s",
          variant: "destructive"
        });
      } finally {
        setLoading(false);
      }
    };

    if (targetUser?.id && targetUser?.type_emploi === 'temps_partiel') {
      fetchDisponibilites();
    } else {
      setLoading(false);
    }
  }, [targetUser?.id, targetUser?.type_emploi, tenantSlug, user.role, toast]);

  const handleTypeGardeChange = (typeGardeId) => {
    const selectedType = typesGarde.find(t => t.id === typeGardeId);
    
    if (selectedType) {
      // Auto-remplir les horaires du type de garde
      setAvailabilityConfig({
        ...availabilityConfig,
        type_garde_id: typeGardeId,
        heure_debut: selectedType.heure_debut,
        heure_fin: selectedType.heure_fin
      });
    } else {
      // "Tous les types" - garder les horaires personnalis√©s
      setAvailabilityConfig({
        ...availabilityConfig,
        type_garde_id: typeGardeId
      });
    }
  };



  const handleAddConfiguration = () => {
    if (selectedDates.length === 0) {
      toast({
        title: "Aucune date s√©lectionn√©e",
        description: "Veuillez s√©lectionner au moins une date",
        variant: "destructive"
      });
      return;
    }

    const selectedType = typesGarde.find(t => t.id === availabilityConfig.type_garde_id);
    const newConfig = {
      id: Date.now(),
      type_garde_id: availabilityConfig.type_garde_id,
      type_garde_name: selectedType ? selectedType.nom : 'Tous les types',
      couleur: selectedType ? selectedType.couleur : '#10B981',
      heure_debut: selectedType ? selectedType.heure_debut : availabilityConfig.heure_debut,
      heure_fin: selectedType ? selectedType.heure_fin : availabilityConfig.heure_fin,
      statut: availabilityConfig.statut,
      dates: [...selectedDates]
    };

    setPendingConfigurations([...pendingConfigurations, newConfig]);
    setSelectedDates([]);
    
    toast({
      title: "Configuration ajout√©e",
      description: `${newConfig.dates.length} jour(s) pour ${newConfig.type_garde_name}`,
      variant: "success"
    });
  };

  const handleRemoveConfiguration = (configId) => {
    setPendingConfigurations(prev => prev.filter(c => c.id !== configId));
  };

  const handleSaveAllConfigurations = async () => {
    if (pendingConfigurations.length === 0) {
      toast({
        title: "Aucune configuration",
        description: "Veuillez ajouter au moins une configuration",
        variant: "destructive"
      });
      return;
    }

    try {
      // Combiner avec les disponibilit√©s existantes + nouvelles configurations
      const existingDispos = userDisponibilites.map(d => ({
        user_id: targetUser.id,
        date: d.date,
        type_garde_id: d.type_garde_id || null,
        heure_debut: d.heure_debut,
        heure_fin: d.heure_fin,
        statut: d.statut
      }));

      const newDispos = pendingConfigurations.flatMap(config => 
        config.dates.map(date => ({
          user_id: targetUser.id,
          date: date.toISOString().split('T')[0],
          type_garde_id: config.type_garde_id || null,
          heure_debut: config.heure_debut,
          heure_fin: config.heure_fin,
          statut: config.statut
        }))
      );

      const allDisponibilites = [...existingDispos, ...newDispos];

      await apiPut(tenantSlug, `/disponibilites/${targetUser.id}`, allDisponibilites);
      
      toast({
        title: "Toutes les disponibilit√©s sauvegard√©es",
        description: `${newDispos.length} nouvelles disponibilit√©s ajout√©es`,
        variant: "success"
      });
      
      setShowCalendarModal(false);
      setPendingConfigurations([]);
      
      // Reload disponibilit√©s
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder",
        variant: "destructive"
      });
    }
  };

  const handleSaveAvailability = async () => {
    try {
      setSavingDisponibilites(true);
      setSavingMessage('Pr√©paration des disponibilit√©s...');
      
      let disponibilitesACreer = [];
      
      if (availabilityConfig.mode === 'calendrier') {
        // MODE CALENDRIER: Clics multiples sur dates
        if (selectedDates.length === 0) {
          setSavingDisponibilites(false);
          toast({
            title: "Aucune date s√©lectionn√©e",
            description: "Veuillez cliquer sur les dates dans le calendrier",
            variant: "destructive"
          });
          return;
        }
        
        setSavingMessage(`Cr√©ation de ${selectedDates.length} disponibilit√©(s)...`);
        
        // Cr√©er une disponibilit√© pour chaque date s√©lectionn√©e
        for (const date of selectedDates) {
          disponibilitesACreer.push({
            user_id: targetUser.id,
            date: date.toISOString().split('T')[0],
            type_garde_id: availabilityConfig.type_garde_id || null,
            heure_debut: availabilityConfig.heure_debut,
            heure_fin: availabilityConfig.heure_fin,
            statut: availabilityConfig.statut,
            origine: 'manuelle' // Origine manuelle car s√©lection date par date via calendrier
          });
        }
        
      } else {
        // MODE R√âCURRENCE: Date d√©but/fin avec r√©currence
        setSavingMessage('Calcul des dates de r√©currence...');
        
        const dateDebut = parseDateLocal(availabilityConfig.date_debut);
        const dateFin = parseDateLocal(availabilityConfig.date_fin);
        
        if (dateDebut > dateFin) {
          setSavingDisponibilites(false);
          toast({
            title: "Dates invalides",
            description: "La date de d√©but doit √™tre avant la date de fin",
            variant: "destructive"
          });
          return;
        }
        
        // Calculer l'intervalle selon le type de r√©currence
        let intervalJours = 1;
        
        switch (availabilityConfig.recurrence_type) {
          case 'hebdomadaire':
            intervalJours = 7;
            break;
          case 'bihebdomadaire':
            intervalJours = 14;
            break;
          case 'mensuelle':
            intervalJours = 30;
            break;
          case 'annuelle':
            intervalJours = 365;
            break;
          case 'personnalisee':
            if (availabilityConfig.recurrence_frequence === 'jours') {
              intervalJours = availabilityConfig.recurrence_intervalle;
            } else if (availabilityConfig.recurrence_frequence === 'semaines') {
              intervalJours = availabilityConfig.recurrence_intervalle * 7;
            } else if (availabilityConfig.recurrence_frequence === 'mois') {
              intervalJours = availabilityConfig.recurrence_intervalle * 30;
            } else if (availabilityConfig.recurrence_frequence === 'ans') {
              intervalJours = availabilityConfig.recurrence_intervalle * 365;
            }
            break;
        }
        
        // G√©n√©rer les dates avec r√©currence
        let currentDate = new Date(dateDebut);
        let compteur = 0;
        const maxIterations = 1000;
        
        // Mapping des jours pour la v√©rification
        const dayMap = {
          'sunday': 0, 'monday': 1, 'tuesday': 2, 'wednesday': 3,
          'thursday': 4, 'friday': 5, 'saturday': 6
        };
        
        // DEBUG: Afficher les jours s√©lectionn√©s
        console.log('===== DEBUG R√âCURRENCE =====');
        console.log('Date d√©but:', dateDebut.toISOString().split('T')[0]);
        console.log('Date fin:', dateFin.toISOString().split('T')[0]);
        console.log('Jours s√©lectionn√©s:', availabilityConfig.jours_semaine);
        console.log('DayMap:', dayMap);
        console.log('============================');
        
        // Pour bi-hebdomadaire : Compteur de semaines depuis le d√©but
        let weeksFromStart = 0;
        let lastWeekProcessed = -1;
        
        // Pour bi-hebdomadaire : calculer le num√©ro de semaine ISO de la date de d√©but comme r√©f√©rence
        const getWeekNumber = (date) => {
          const tempDate = new Date(date);
          tempDate.setHours(0, 0, 0, 0);
          // Set to nearest Thursday: current date + 4 - current day number, make Sunday's day number 7
          tempDate.setDate(tempDate.getDate() + 4 - (tempDate.getDay() || 7));
          // Get first day of year
          const yearStart = new Date(tempDate.getFullYear(), 0, 1);
          // Calculate full weeks to nearest Thursday
          const weekNo = Math.ceil((((tempDate - yearStart) / 86400000) + 1) / 7);
          return weekNo;
        };
        
        const referenceWeekNumber = getWeekNumber(dateDebut);
        
        while (currentDate <= dateFin && compteur < maxIterations) {
          // Calculer le num√©ro de semaine ISO pour la date actuelle
          const currentWeekNumber = getWeekNumber(currentDate);
          // Calculer la diff√©rence de semaines depuis la r√©f√©rence
          const weeksDifference = currentWeekNumber - referenceWeekNumber;
          
          // Si hebdomadaire/bihebdomadaire ET des jours sont s√©lectionn√©s
          let includeDate = false; // FIX: Par d√©faut false, includeDate devient true seulement si le jour correspond
          if ((availabilityConfig.recurrence_type === 'hebdomadaire' || availabilityConfig.recurrence_type === 'bihebdomadaire') 
              && availabilityConfig.jours_semaine && availabilityConfig.jours_semaine.length > 0) {
            
            const dayOfWeek = currentDate.getDay();
            
            // DEBUG: Log pour comprendre le probl√®me
            if (compteur < 10) {
              console.log(`DEBUG R√©currence - Date: ${currentDate.toISOString().split('T')[0]}, getDay(): ${dayOfWeek}, Jours s√©lectionn√©s:`, availabilityConfig.jours_semaine);
              availabilityConfig.jours_semaine.forEach(jour => {
                console.log(`  ${jour} -> dayMap[${jour}] = ${dayMap[jour]}, match: ${dayMap[jour] === dayOfWeek}`);
              });
            }
            
            // V√©rifier si ce jour est dans les jours s√©lectionn√©s
            includeDate = availabilityConfig.jours_semaine.some(jour => dayMap[jour] === dayOfWeek);
            
            // Pour bi-hebdomadaire : ne garder que les semaines paires (0, 2, 4, 6...)
            if (includeDate && availabilityConfig.recurrence_type === 'bihebdomadaire') {
              includeDate = weeksDifference % 2 === 0;
            }
          }
          
          if (includeDate) {
            disponibilitesACreer.push({
              user_id: targetUser.id,
              date: formatDateLocal(currentDate),
              type_garde_id: availabilityConfig.type_garde_id || null,
              heure_debut: availabilityConfig.heure_debut,
              heure_fin: availabilityConfig.heure_fin,
              statut: availabilityConfig.statut,
              origine: 'recurrence' // Origine r√©currence car g√©n√©r√© automatiquement
            });
          }
          
          // Avancer d'un jour (on v√©rifie tous les jours mais on filtre selon r√©currence)
          currentDate = new Date(currentDate);
          currentDate.setDate(currentDate.getDate() + 1);
          compteur++;
        }
      }
      
      setSavingMessage(`Enregistrement de ${disponibilitesACreer.length} disponibilit√©(s)...`);
      
      // Envoyer les disponibilit√©s au backend - COLLECTER LES CONFLITS
      let successCount = 0;
      let collectedConflicts = [];
      let errorCount = 0;
      
      for (let i = 0; i < disponibilitesACreer.length; i++) {
        const dispo = disponibilitesACreer[i];
        try {
          await apiPost(tenantSlug, '/disponibilites', dispo);
          successCount++;
        } catch (error) {
          // V√©rifier si c'est une erreur de conflit (409)
          if (error.response && error.response.status === 409) {
            const conflictDetails = error.response.data.detail;
            const typeGarde = typesGarde.find(t => t.id === dispo.type_garde_id);
            
            // Ajouter √† la liste des conflits (sans console.error car c'est un comportement attendu)
            collectedConflicts.push({
              newItem: dispo,
              conflicts: conflictDetails.conflicts,
              newType: typeGarde?.nom || 'Disponibilit√©',
              existingType: conflictDetails.conflicts[0]?.statut === 'disponible' ? 'Disponibilit√©' : 'Indisponibilit√©',
              existingHours: `${conflictDetails.conflicts[0]?.heure_debut}-${conflictDetails.conflicts[0]?.heure_fin}`,
              existingOrigine: conflictDetails.conflicts[0]?.origine
            });
          } else {
            errorCount++;
            console.error(`Erreur cr√©ation disponibilit√© (${dispo.date}):`, error.response?.data?.detail || error.message || 'Erreur inconnue');
          }
        }
        
        // Mettre √† jour le message tous les 10 enregistrements
        if ((i + 1) % 10 === 0 || i === disponibilitesACreer.length - 1) {
          setSavingMessage(`Enregistrement... ${i + 1}/${disponibilitesACreer.length}`);
        }
      }
      
      setSavingMessage('Finalisation...');
      setSavingDisponibilites(false);
      
      // Si des conflits ont √©t√© d√©tect√©s, afficher le modal
      if (collectedConflicts.length > 0) {
        setBatchConflicts(collectedConflicts);
        setBatchConflictSelections({});
        setShowBatchConflictModal(true);
        setShowCalendarModal(false);
        
        toast({
          title: "Conflits d√©tect√©s",
          description: `${successCount} cr√©√©e(s), ${collectedConflicts.length} conflit(s) √† r√©soudre`,
          variant: "default"
        });
        
        return; // Ne pas fermer le modal ou recharger
      }
      
      // Si pas de conflits, message de succ√®s normal
      let message = '';
      if (successCount > 0) {
        message += `${successCount} disponibilit√©(s) cr√©√©e(s)`;
      }
      if (errorCount > 0) {
        message += (message ? ', ' : '') + `${errorCount} erreur(s)`;
      }
      
      toast({
        title: successCount > 0 ? "Disponibilit√©s enregistr√©es" : "Attention",
        description: message || "Aucune disponibilit√© cr√©√©e",
        variant: successCount > 0 ? "success" : "destructive"
      });
      
      setShowCalendarModal(false);
      setSelectedDates([]);
      
      // R√©initialiser la config
      setAvailabilityConfig({
        type_garde_id: '',
        heure_debut: '08:00',
        heure_fin: '16:00',
        statut: 'disponible',
        mode: 'calendrier',
        date_debut: new Date().toISOString().split('T')[0],
        date_fin: new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0],
        recurrence_type: 'hebdomadaire',
        recurrence_frequence: 'jours',
        recurrence_intervalle: 1,
        jours_semaine: []
      });
      
      // Recharger les disponibilit√©s
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
      
      setSavingDisponibilites(false);
      
    } catch (error) {
      setSavingDisponibilites(false);
      const errorMessage = error.response?.data?.detail || error.message || "Impossible d'enregistrer les disponibilit√©s";
      console.error('Erreur sauvegarde disponibilit√©s:', errorMessage);
      toast({
        title: "Erreur",
        description: errorMessage,
        variant: "destructive"
      });
    }
  };


  // Fonctions pour le calendrier visuel
  const getDaysInMonth = (month, year) => {
    return new Date(year, month + 1, 0).getDate();
  };

  const getFirstDayOfMonth = (month, year) => {
    const day = new Date(year, month, 1).getDay();
    return day === 0 ? 6 : day - 1; // Convertir dimanche (0) en 6, lundi reste 0
  };

  const navigateMonth = (direction) => {
    if (direction === 'prev') {
      if (calendarCurrentMonth === 0) {
        setCalendarCurrentMonth(11);
        setCalendarCurrentYear(calendarCurrentYear - 1);
      } else {
        setCalendarCurrentMonth(calendarCurrentMonth - 1);
      }
    } else {
      if (calendarCurrentMonth === 11) {
        setCalendarCurrentMonth(0);
        setCalendarCurrentYear(calendarCurrentYear + 1);
      } else {
        setCalendarCurrentMonth(calendarCurrentMonth + 1);
      }
    }
  };

  const getDisponibilitesForDate = (date) => {
    const dateStr = date.toISOString().split('T')[0];
    return userDisponibilites.filter(d => d.date === dateStr);
  };

  const handleDayClick = (dayNumber) => {
    const clickedDate = new Date(calendarCurrentYear, calendarCurrentMonth, dayNumber);
    // Format YYYY-MM-DD sans conversion UTC
    const dateStr = `${calendarCurrentYear}-${String(calendarCurrentMonth + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
    
    const disponibilites = userDisponibilites.filter(d => (d.date === dateStr || d.date.startsWith(dateStr)) && d.statut === 'disponible');
    const indisponibilites = userDisponibilites.filter(d => (d.date === dateStr || d.date.startsWith(dateStr)) && d.statut === 'indisponible');
    
    setSelectedDayForDetail(clickedDate);
    setDayDetailData({ disponibilites, indisponibilites });
    setShowDayDetailModal(true);
  };

  // Fonction pour r√©soudre les conflits en batch
  const handleResolveBatchConflicts = async () => {
    try {
      let successCount = 0;
      let errorCount = 0;
      
      // Traiter uniquement les conflits s√©lectionn√©s
      for (let i = 0; i < batchConflicts.length; i++) {
        const conflict = batchConflicts[i];
        const isSelected = batchConflictSelections[i];
        
        if (isSelected) {
          // Remplacer: supprimer l'ancien et cr√©er le nouveau
          try {
            // Supprimer les conflits existants
            for (const existingConflict of conflict.conflicts) {
              await apiDelete(tenantSlug, `/disponibilites/${existingConflict.id}`);
            }
            
            // Cr√©er la nouvelle disponibilit√©
            await apiPost(tenantSlug, '/disponibilites', conflict.newItem);
            successCount++;
          } catch (error) {
            console.error(`Erreur lors du remplacement pour ${conflict.newItem.date}:`, error);
            errorCount++;
          }
        }
        // Si non s√©lectionn√©, on ignore simplement (ne cr√©e pas)
      }
      
      // Message r√©capitulatif
      let message = '';
      if (successCount > 0) {
        message += `${successCount} conflit(s) r√©solu(s)`;
      }
      if (errorCount > 0) {
        message += (message ? ', ' : '') + `${errorCount} erreur(s)`;
      }
      const ignoredCount = batchConflicts.length - Object.values(batchConflictSelections).filter(Boolean).length;
      if (ignoredCount > 0) {
        message += (message ? ', ' : '') + `${ignoredCount} ignor√©(s)`;
      }
      
      toast({
        title: successCount > 0 ? "Conflits r√©solus" : "Attention",
        description: message || "Aucun conflit r√©solu",
        variant: successCount > 0 ? "success" : "default"
      });
      
      // Recharger les disponibilit√©s
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
      
      // Fermer le modal et r√©initialiser
      setShowBatchConflictModal(false);
      setBatchConflicts([]);
      setBatchConflictSelections({});
      
    } catch (error) {
      console.error('Erreur lors de la r√©solution des conflits:', error);
      toast({
        title: "Erreur",
        description: "Impossible de r√©soudre les conflits",
        variant: "destructive"
      });
    }
  };

  const handleDeleteDisponibilite = async (dispoId) => {
    try {
      await apiDelete(tenantSlug, `/disponibilites/${dispoId}`);
      toast({
        title: "Supprim√©",
        description: "Entr√©e supprim√©e avec succ√®s",
        variant: "success"
      });
      
      // Recharger
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
      
      // Mettre √† jour le modal
      const dateStr = selectedDayForDetail.toISOString().split('T')[0];
      const disponibilites = dispoData.filter(d => d.date === dateStr && d.statut === 'disponible');
      const indisponibilites = dispoData.filter(d => d.date === dateStr && d.statut === 'indisponible');
      setDayDetailData({ disponibilites, indisponibilites });
      
    } catch (error) {
      console.error('Erreur suppression:', error);
      toast({
        title: "Erreur",
        description: "Impossible de supprimer",
        variant: "destructive"
      });
    }
  };

  const getMonthName = (month) => {
    const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    return months[month];
  };



  // Fonction pour formater le planning (demo uniquement)
  const handleFormaterPlanning = async () => {
    if (tenantSlug !== 'demo') {
      alert('Cette fonctionnalit√© est r√©serv√©e au tenant demo');
      return;
    }

    if (user.role !== 'admin') {
      alert('Acc√®s r√©serv√© aux administrateurs');
      return;
    }

    const confirmation = window.confirm(
      `‚ö†Ô∏è ATTENTION\n\nVous √™tes sur le point de SUPPRIMER toutes les assignations et demandes de remplacement du mois ${moisFormatage}.\n\nCette action est IRR√âVERSIBLE.\n\nConfirmer?`
    );

    if (!confirmation) return;

    try {
      const response = await apiDelete(tenantSlug, `/planning/formater-mois?mois=${moisFormatage}`);

      alert(`‚úÖ ${response.message}\n\n` +
            `üìä R√©sum√©:\n` +
            `- ${response.assignations_supprimees} assignation(s) supprim√©e(s)\n` +
            `- ${response.demandes_supprimees} demande(s) de remplacement supprim√©e(s)`);
      
      // Recharger la page
      window.location.reload();
    } catch (error) {
      console.error('Erreur formatage planning:', error);
      alert('‚ùå Erreur lors du formatage: ' + error.message);
    }
  };

  const handleGenerateIndisponibilites = async () => {
    setIsGenerating(true);
    
    try {
      const response = await apiPost(tenantSlug, '/disponibilites/generer', {
        user_id: targetUser.id,
        horaire_type: generationConfig.horaire_type,
        equipe: generationConfig.equipe,
        date_debut: generationConfig.date_debut,
        date_fin: generationConfig.date_fin,
        conserver_manuelles: generationConfig.conserver_manuelles
      });
      
      toast({
        title: "G√©n√©ration r√©ussie",
        description: `${response.nombre_indisponibilites} indisponibilit√©s g√©n√©r√©es pour ${generationConfig.horaire_type === 'montreal' ? 'Montreal 7/24' : 'Quebec 10/14'} - √âquipe ${generationConfig.equipe} (${generationConfig.date_debut} au ${generationConfig.date_fin})`,
        variant: "success"
      });
      
      setShowGenerationModal(false);
      
      // Recharger les disponibilit√©s
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
      
    } catch (error) {
      console.error('Erreur g√©n√©ration:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible de g√©n√©rer les indisponibilit√©s",
        variant: "destructive"
      });
    } finally {
      setIsGenerating(false);
    }
  };

  const handleReinitialiser = async () => {
    // Validation des dates pour p√©riode personnalis√©e
    if (reinitConfig.periode === 'personnalisee') {
      const dateDebut = new Date(reinitConfig.date_debut);
      const dateFin = new Date(reinitConfig.date_fin);
      
      if (dateDebut > dateFin) {
        toast({
          title: "Erreur",
          description: "La date de d√©but doit √™tre avant la date de fin",
          variant: "destructive"
        });
        return;
      }
      
      // Limiter √† 1 an maximum
      const diffTime = Math.abs(dateFin - dateDebut);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays > 365) {
        toast({
          title: "Erreur",
          description: "La plage de dates ne peut pas d√©passer 1 an",
          variant: "destructive"
        });
        return;
      }
      
      // V√©rifier les dates bloqu√©es si l'avertissement n'a pas d√©j√† √©t√© confirm√©
      if (!reinitWarning) {
        try {
          const params = await apiGet(tenantSlug, '/parametres/disponibilites');
          const joursBlocage = params.jour_blocage_dispos || 0;
          
          if (joursBlocage > 0) {
            const today = new Date();
            const dateBloquee = new Date(today);
            dateBloquee.setDate(dateBloquee.getDate() + joursBlocage);
            
            // V√©rifier si des dates sont dans la p√©riode bloqu√©e
            if (dateDebut < dateBloquee) {
              setReinitWarning(`‚ö†Ô∏è Certaines dates sont dans la p√©riode bloqu√©e (moins de ${joursBlocage} jours). √ätes-vous s√ªr de vouloir continuer?`);
              return; // Afficher l'avertissement et attendre confirmation
            }
          }
        } catch (error) {
          console.error('Erreur v√©rification blocage:', error);
        }
      }
    }
    
    setIsReinitializing(true);
    setReinitWarning(null); // R√©initialiser l'avertissement
    
    try {
      const requestBody = {
        user_id: targetUser.id,
        periode: reinitConfig.periode,
        mode: reinitConfig.mode,
        type_entree: reinitConfig.type_entree
      };
      
      // Ajouter les dates si p√©riode personnalis√©e
      if (reinitConfig.periode === 'personnalisee') {
        requestBody.date_debut = reinitConfig.date_debut;
        requestBody.date_fin = reinitConfig.date_fin;
      }
      
      const response = await apiCall(tenantSlug, '/disponibilites/reinitialiser', {
        method: 'DELETE',
        body: JSON.stringify(requestBody)
      });
      
      const periodeLabel = reinitConfig.periode === 'personnalisee'
        ? `du ${reinitConfig.date_debut} au ${reinitConfig.date_fin}`
        : {
            'semaine': 'la semaine courante',
            'mois': 'le mois courant',
            'annee': "l'ann√©e courante"
          }[reinitConfig.periode];
      
      const typeLabel = {
        'disponibilites': 'disponibilit√©s',
        'indisponibilites': 'indisponibilit√©s',
        'les_deux': 'disponibilit√©s et indisponibilit√©s'
      }[reinitConfig.type_entree];
      
      const modeLabel = reinitConfig.mode === 'tout' 
        ? 'Toutes les' 
        : 'Les entr√©es g√©n√©r√©es automatiquement de';
      
      toast({
        title: "R√©initialisation r√©ussie",
        description: `${modeLabel} ${typeLabel} de ${periodeLabel} ont √©t√© supprim√©es (${response.nombre_supprimees} entr√©e(s))`,
        variant: "success"
      });
      
      setShowReinitModal(false);
      
      // Recharger les disponibilit√©s
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
      
    } catch (error) {
      console.error('Erreur r√©initialisation:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible de r√©initialiser",
        variant: "destructive"
      });
    } finally {
      setIsReinitializing(false);
    }
  };

  const handleSaveManualIndisponibilites = async () => {
    try {
      setSavingDisponibilites(true);
      setSavingMessage('Pr√©paration des indisponibilit√©s...');
      
      let indisponibilitesACreer = [];
      
      if (manualIndispoMode === 'calendrier') {
        // MODE CALENDRIER: Clics multiples sur dates
        if (manualIndispoConfig.dates.length === 0) {
          setSavingDisponibilites(false);
          toast({
            title: "Aucune date s√©lectionn√©e",
            description: "Veuillez cliquer sur les dates dans le calendrier",
            variant: "destructive"
          });
          return;
        }
        
        setSavingMessage(`Cr√©ation de ${manualIndispoConfig.dates.length} indisponibilit√©(s)...`);
        
        // Cr√©er une indisponibilit√© pour chaque date s√©lectionn√©e
        for (const date of manualIndispoConfig.dates) {
          indisponibilitesACreer.push({
            user_id: targetUser.id,
            date: new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())).toISOString().split('T')[0],
            type_garde_id: null,
            heure_debut: manualIndispoConfig.heure_debut,
            heure_fin: manualIndispoConfig.heure_fin,
            statut: 'indisponible',
            origine: 'manuelle' // Origine manuelle car s√©lection date par date via calendrier
          });
        }
        
      } else {
        // MODE R√âCURRENCE: Date d√©but/fin avec r√©currence
        setSavingMessage('Calcul des dates de r√©currence...');
        
        const dateDebut = parseDateLocal(manualIndispoConfig.date_debut);
        const dateFin = parseDateLocal(manualIndispoConfig.date_fin);
        
        if (dateDebut > dateFin) {
          setSavingDisponibilites(false);
          toast({
            title: "Dates invalides",
            description: "La date de d√©but doit √™tre avant la date de fin",
            variant: "destructive"
          });
          return;
        }
        
        // Calculer l'intervalle selon le type de r√©currence
        let intervalJours = 1;
        
        switch (manualIndispoConfig.recurrence_type) {
          case 'hebdomadaire':
            intervalJours = 7;
            break;
          case 'bihebdomadaire':
            intervalJours = 14;
            break;
          case 'mensuelle':
            intervalJours = 30; // Approximation
            break;
          case 'annuelle':
            intervalJours = 365;
            break;
          case 'personnalisee':
            // Calculer selon la fr√©quence et l'intervalle
            if (manualIndispoConfig.recurrence_frequence === 'jours') {
              intervalJours = manualIndispoConfig.recurrence_intervalle;
            } else if (manualIndispoConfig.recurrence_frequence === 'semaines') {
              intervalJours = manualIndispoConfig.recurrence_intervalle * 7;
            } else if (manualIndispoConfig.recurrence_frequence === 'mois') {
              intervalJours = manualIndispoConfig.recurrence_intervalle * 30;
            } else if (manualIndispoConfig.recurrence_frequence === 'ans') {
              intervalJours = manualIndispoConfig.recurrence_intervalle * 365;
            }
            break;
        }
        
        // G√©n√©rer les dates avec r√©currence
        let currentDate = new Date(dateDebut);
        let compteur = 0;
        const maxIterations = 1000; // S√©curit√© pour √©viter boucle infinie
        
        // Mapping des jours pour la v√©rification
        const dayMap = {
          'sunday': 0, 'monday': 1, 'tuesday': 2, 'wednesday': 3,
          'thursday': 4, 'friday': 5, 'saturday': 6
        };
        
        // Pour bi-hebdomadaire : calculer le num√©ro de semaine ISO de la date de d√©but comme r√©f√©rence
        const getWeekNumber = (date) => {
          const tempDate = new Date(date);
          tempDate.setHours(0, 0, 0, 0);
          // Set to nearest Thursday: current date + 4 - current day number, make Sunday's day number 7
          tempDate.setDate(tempDate.getDate() + 4 - (tempDate.getDay() || 7));
          // Get first day of year
          const yearStart = new Date(tempDate.getFullYear(), 0, 1);
          // Calculate full weeks to nearest Thursday
          const weekNo = Math.ceil((((tempDate - yearStart) / 86400000) + 1) / 7);
          return weekNo;
        };
        
        const referenceWeekNumber = getWeekNumber(dateDebut);
        
        while (currentDate <= dateFin && compteur < maxIterations) {
          // Calculer le num√©ro de semaine ISO pour la date actuelle
          const currentWeekNumber = getWeekNumber(currentDate);
          // Calculer la diff√©rence de semaines depuis la r√©f√©rence
          const weeksDifference = currentWeekNumber - referenceWeekNumber;
          
          // Si hebdomadaire/bihebdomadaire ET des jours sont s√©lectionn√©s, filtrer par jour
          let includeDate = true;
          if ((manualIndispoConfig.recurrence_type === 'hebdomadaire' || manualIndispoConfig.recurrence_type === 'bihebdomadaire') 
              && manualIndispoConfig.jours_semaine && manualIndispoConfig.jours_semaine.length > 0) {
            const dayOfWeek = currentDate.getDay();
            includeDate = manualIndispoConfig.jours_semaine.some(jour => dayMap[jour] === dayOfWeek);
            
            // Pour bi-hebdomadaire : ne garder que les semaines paires (0, 2, 4, 6...)
            if (includeDate && manualIndispoConfig.recurrence_type === 'bihebdomadaire') {
              includeDate = weeksDifference % 2 === 0;
            }
          }
          
          if (includeDate) {
            indisponibilitesACreer.push({
              user_id: targetUser.id,
              date: formatDateLocal(currentDate),
              type_garde_id: null,
              heure_debut: manualIndispoConfig.heure_debut,
              heure_fin: manualIndispoConfig.heure_fin,
              statut: 'indisponible',
              origine: 'recurrence' // Origine r√©currence car g√©n√©r√© automatiquement
            });
          }
          
          // Avancer √† la prochaine date
          currentDate = new Date(currentDate);
          currentDate.setDate(currentDate.getDate() + 1); // Toujours avancer de 1 jour pour v√©rifier tous les jours
          compteur++;
        }
      }
      
      setSavingMessage(`Enregistrement de ${indisponibilitesACreer.length} indisponibilit√©(s)...`);
      
      // Envoyer les indisponibilit√©s au backend - COLLECTER LES CONFLITS
      let successCount = 0;
      let collectedConflicts = [];
      let errorCount = 0;
      
      for (let i = 0; i < indisponibilitesACreer.length; i++) {
        const indispo = indisponibilitesACreer[i];
        
        try {
          await apiPost(tenantSlug, '/disponibilites', indispo);
          successCount++;
        } catch (error) {
          // V√©rifier si c'est une erreur de conflit (409)
          if (error.response && error.response.status === 409) {
            const conflictDetails = error.response.data.detail;
            
            // Ajouter √† la liste des conflits (sans console.error car c'est un comportement attendu)
            collectedConflicts.push({
              newItem: indispo,
              conflicts: conflictDetails.conflicts,
              newType: 'Indisponibilit√©',
              existingType: conflictDetails.conflicts[0]?.statut === 'disponible' ? 'Disponibilit√©' : 'Indisponibilit√©',
              existingHours: `${conflictDetails.conflicts[0]?.heure_debut}-${conflictDetails.conflicts[0]?.heure_fin}`,
              existingOrigine: conflictDetails.conflicts[0]?.origine
            });
          } else {
            // Autre erreur
            errorCount++;
            console.error(`Erreur cr√©ation indisponibilit√© (${indispo.date}):`, error.response?.data?.detail || error.message || 'Erreur inconnue');
          }
        }
        
        // Mettre √† jour le message tous les 10 enregistrements
        if ((i + 1) % 10 === 0 || i === indisponibilitesACreer.length - 1) {
          setSavingMessage(`Enregistrement... ${i + 1}/${indisponibilitesACreer.length}`);
        }
      }
      
      setSavingMessage('Finalisation...');
      setSavingDisponibilites(false);
      
      // Si des conflits ont √©t√© d√©tect√©s, afficher le modal
      if (collectedConflicts.length > 0) {
        setBatchConflicts(collectedConflicts);
        setBatchConflictSelections({});
        setShowBatchConflictModal(true);
        setShowGenerationModal(false);
        
        toast({
          title: "Conflits d√©tect√©s",
          description: `${successCount} cr√©√©e(s), ${collectedConflicts.length} conflit(s) √† r√©soudre`,
          variant: "default"
        });
        
        return; // Ne pas fermer le modal ou recharger
      }
      
      // Si pas de conflits, message de succ√®s normal
      let message = '';
      if (successCount > 0) {
        message += `${successCount} indisponibilit√©(s) cr√©√©e(s)`;
      }
      if (errorCount > 0) {
        message += (message ? ', ' : '') + `${errorCount} erreur(s)`;
      }
      
      toast({
        title: successCount > 0 ? "Indisponibilit√©s enregistr√©es" : "Attention",
        description: message || "Aucune indisponibilit√© cr√©√©e",
        variant: successCount > 0 ? "success" : "destructive"
      });
      
      setShowGenerationModal(false);
      
      // R√©initialiser la config
      setManualIndispoConfig({
        dates: [],
        date_debut: new Date().toISOString().split('T')[0],
        date_fin: new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0],
        heure_debut: '00:00',
        heure_fin: '23:59',
        recurrence_type: 'hebdomadaire',
        recurrence_frequence: 'jours',
        recurrence_intervalle: 1,
        jours_semaine: []
      });
      
      // Recharger les disponibilit√©s
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
      
      setSavingDisponibilites(false);
      
    } catch (error) {
      setSavingDisponibilites(false);
      const errorMessage = error.response?.data?.detail || error.message || "Impossible d'enregistrer les indisponibilit√©s";
      console.error('Erreur sauvegarde indisponibilit√©s:', errorMessage);
      toast({
        title: "Erreur",
        description: errorMessage,
        variant: "destructive"
      });
    }
  };

  const getTypeGardeName = (typeGardeId) => {
    if (!typeGardeId) return 'Tous types';
    const typeGarde = typesGarde.find(t => t.id === typeGardeId);
    return typeGarde ? typeGarde.nom : 'Type non sp√©cifi√©';
  };

  const getAvailableDates = () => {
    return userDisponibilites
      .filter(d => d.statut === 'disponible')
      .map(d => parseDateLocal(d.date));
  };

  const getColorByTypeGarde = (typeGardeId) => {
    if (!typeGardeId) return '#10B981'; // Vert par d√©faut pour "Tous types"
    const typeGarde = typesGarde.find(t => t.id === typeGardeId);
    return typeGarde ? typeGarde.couleur : '#10B981';
  };

  // Fonction pour sauvegarde rapide (ajout simple d'une dispo ou indispo)
  const handleQuickAddSave = async () => {
    try {
      // Validation
      if (!quickAddConfig.date) {
        toast({
          title: "Erreur",
          description: "Veuillez s√©lectionner une date",
          variant: "destructive"
        });
        return;
      }

      // Cr√©er l'entr√©e
      const newEntry = {
        user_id: targetUser.id,
        date: quickAddConfig.date,
        type_garde_id: quickAddConfig.type_garde_id || null,
        heure_debut: quickAddConfig.heure_debut,
        heure_fin: quickAddConfig.heure_fin,
        statut: quickAddType === 'disponibilite' ? 'disponible' : 'indisponible',
        origine: 'manuelle'
      };

      // R√©cup√©rer les disponibilit√©s existantes
      const existingDispos = userDisponibilites.map(d => ({
        user_id: d.user_id,
        date: d.date,
        type_garde_id: d.type_garde_id || null,
        heure_debut: d.heure_debut,
        heure_fin: d.heure_fin,
        statut: d.statut,
        origine: d.origine
      }));

      // Ajouter la nouvelle entr√©e
      const allDisponibilites = [...existingDispos, newEntry];

      // Sauvegarder
      await apiPut(tenantSlug, `/disponibilites/${targetUser.id}`, allDisponibilites);
      
      toast({
        title: "‚úÖ Enregistr√© !",
        description: quickAddType === 'disponibilite' 
          ? `Disponibilit√© ajout√©e pour le ${quickAddConfig.date}`
          : `Indisponibilit√© ajout√©e pour le ${quickAddConfig.date}`,
        variant: "success"
      });
      
      setShowQuickAddModal(false);
      
      // Recharger les disponibilit√©s
      const dispoData = await apiGet(tenantSlug, `/disponibilites/${targetUser.id}`);
      setUserDisponibilites(dispoData);
      
      // R√©initialiser le formulaire
      setQuickAddConfig({
        date: new Date().toISOString().split('T')[0],
        type_garde_id: '',
        heure_debut: '08:00',
        heure_fin: '16:00'
      });
      
    } catch (error) {
      console.error('Erreur sauvegarde rapide:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible d'enregistrer",
        variant: "destructive"
      });
    }
  };

  const getDisponibiliteForDate = (date) => {
    // Format YYYY-MM-DD sans conversion UTC
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    return userDisponibilites.find(d => d.date === dateStr || d.date.startsWith(dateStr));
  };

  const handleDateClick = (date) => {
    // Format YYYY-MM-DD sans conversion UTC
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    const dispos = userDisponibilites.filter(d => d.date === dateStr || d.date.startsWith(dateStr));
    
    console.log('Date cliqu√©e:', dateStr, 'Disponibilit√©s trouv√©es:', dispos.length);
    
    if (dispos.length > 0) {
      // Afficher TOUTES les disponibilit√©s pour cette date
      setSelectedDateDetails({
        date: normalizedDate,
        disponibilites: dispos, // Tableau au lieu d'un seul objet
        count: dispos.length
      });
    } else {
      setSelectedDateDetails(null);
    }
  };

  // V√©rifier le type d'emploi de la personne dont on g√®re les disponibilit√©s
  if (targetUser?.type_emploi !== 'temps_partiel') {
    return (
      <div className="access-denied">
        <h1>Module r√©serv√© aux employ√©s temps partiel</h1>
        <p>Ce module permet aux employ√©s √† temps partiel de g√©rer leurs disponibilit√©s.</p>
        {managingUser && (
          <p style={{ marginTop: '10px', color: '#dc2626' }}>
            ‚ö†Ô∏è <strong>{targetUser?.prenom} {targetUser?.nom}</strong> est un employ√© <strong>temps plein</strong> et ne peut pas g√©rer de disponibilit√©s.
          </p>
        )}
      </div>
    );
  }

  // Fonctions d'export Disponibilit√©s
  const handleExportDisponibilites = async (userId = null) => {
    try {
      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
      const token = localStorage.getItem(`${tenantSlug}_token`);
      
      const endpoint = exportType === 'pdf' ? 'export-pdf' : 'export-excel';
      const url = userId 
        ? `${backendUrl}/api/${tenantSlug}/disponibilites/${endpoint}?user_id=${userId}`
        : `${backendUrl}/api/${tenantSlug}/disponibilites/${endpoint}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur lors de l\'export');
      
      const blob = await response.blob();
      
      if (exportType === 'pdf') {
        // Pour les PDF, ouvrir directement le dialogue d'impression
        const pdfUrl = window.URL.createObjectURL(blob);
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = pdfUrl;
        document.body.appendChild(iframe);
        
        iframe.onload = function() {
          iframe.contentWindow.print();
          setTimeout(() => {
            document.body.removeChild(iframe);
            window.URL.revokeObjectURL(pdfUrl);
          }, 100);
        };
      } else {
        // Pour les Excel, t√©l√©charger directement
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = userId 
          ? `disponibilites_${userId}.xlsx` 
          : `disponibilites_tous.xlsx`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(downloadUrl);
      }
      
      toast({ 
        title: "Succ√®s", 
        description: `Export ${exportType.toUpperCase()} ${exportType === 'pdf' ? 'pr√™t √† imprimer' : 't√©l√©charg√©'}`,
        variant: "success"
      });
      
      setShowExportModal(false);
    } catch (error) {
      console.error('Erreur export:', error);
      toast({ 
        title: "Erreur", 
        description: `Impossible d'exporter le ${exportType.toUpperCase()}`, 
        variant: "destructive" 
      });
    }
  };

  if (loading) return <div className="loading" data-testid="disponibilites-loading">Chargement...</div>;

  // Ne pas afficher le module pour les utilisateurs temps plein (sauf si admin g√®re un autre utilisateur)
  if (!managingUser && targetUser?.type_emploi !== 'temps_partiel') {
    return null;
  }

  return (
    <div className="disponibilites-refonte">
      {/* Bouton retour si on g√®re un autre utilisateur */}
      {managingUser && (
        <div style={{ marginBottom: '20px' }}>
          <Button 
            variant="outline" 
            onClick={() => {
              setManagingUserDisponibilites(null);
              setCurrentPage('personnel');
            }}
          >
            ‚Üê Retour √† Personnel
          </Button>
        </div>
      )}

      {/* Header Moderne */}
      <div className="module-header">
        <div>
          <h1 data-testid="disponibilites-title">
            {managingUser 
              ? `üìÖ Disponibilit√©s de ${targetUser.prenom} ${targetUser.nom}`
              : 'üìÖ Mes Disponibilit√©s'}
          </h1>
          <p>
            {managingUser 
              ? `G√©rez les disponibilit√©s de ${targetUser.prenom} ${targetUser.nom} pour les quarts de travail`
              : 'G√©rez vos disponibilit√©s pour les quarts de travail temps partiel'}
          </p>
        </div>
      </div>

      {/* KPIs - Toujours affich√©s pour la personne en question */}
      {!managingUser && (() => {
        // Filtrer les disponibilit√©s de l'utilisateur cible uniquement
        const myDisponibilites = userDisponibilites.filter(d => d.user_id === targetUser.id && d.statut === 'disponible');
        const myIndisponibilites = userDisponibilites.filter(d => d.user_id === targetUser.id && d.statut === 'indisponible');
        
        // Calculer les jours uniques avec disponibilit√©s (ignorer les doublons)
        const joursAvecDispo = [...new Set(myDisponibilites.map(d => d.date))].length;
        
        // Calculer le nombre de types de garde diff√©rents couverts
        const typesGardeCouvert = [...new Set(myDisponibilites.map(d => d.type_garde_id))].length;
        
        return (
          <div className="kpi-grid" style={{marginBottom: '2rem'}}>
            <div className="kpi-card" style={{background: '#D1FAE5'}}>
              <h3>{myDisponibilites.length}</h3>
              <p>Mes Disponibilit√©s</p>
              <small style={{fontSize: '0.75rem', opacity: 0.8}}>Total saisies</small>
            </div>
            <div className="kpi-card" style={{background: '#FCA5A5'}}>
              <h3>{myIndisponibilites.length}</h3>
              <p>Mes Indisponibilit√©s</p>
              <small style={{fontSize: '0.75rem', opacity: 0.8}}>Total saisies</small>
            </div>
            <div className="kpi-card" style={{background: '#DBEAFE'}}>
              <h3>{joursAvecDispo}</h3>
              <p>Jours Disponibles</p>
              <small style={{fontSize: '0.75rem', opacity: 0.8}}>Jours uniques</small>
            </div>
            <div className="kpi-card" style={{background: '#FEF3C7'}}>
              <h3>{typesGardeCouvert}</h3>
              <p>Types de Garde</p>
              <small style={{fontSize: '0.75rem', opacity: 0.8}}>Couverts</small>
            </div>
          </div>
        );
      })()}

      {/* Barre de Contr√¥les */}
      <div className="personnel-controls" style={{marginBottom: '2rem'}}>
        <div style={{display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap', justifyContent: 'space-between'}}>
          {/* Boutons d'action */}
          <div style={{display: 'flex', gap: '1rem', flexWrap: 'wrap'}}>
            <Button 
              variant="default" 
              onClick={() => setShowCalendarModal(true)}
              data-testid="configure-availability-btn"
            >
              ‚úÖ Mes Disponibilit√©s
            </Button>
            <Button 
              variant="outline" 
              onClick={() => setShowGenerationModal(true)}
              data-testid="generate-indisponibilites-btn"
            >
              ‚ùå Indisponibilit√©s
            </Button>
            <Button 
              variant="destructive" 
              onClick={() => setShowReinitModal(true)}
              data-testid="reinit-disponibilites-btn"
            >
              üóëÔ∏è Supprimer Tout
            </Button>
          </div>

          {/* Exports - Uniquement pour Admin/Superviseur */}
          {(user.role === 'admin' || user.role === 'superviseur') && (
            <div style={{display: 'flex', gap: '1rem'}}>
              <Button variant="outline" onClick={() => { setExportType('pdf'); setShowExportModal(true); }}>
                üìÑ Export PDF
              </Button>
              <Button variant="outline" onClick={() => { setExportType('excel'); setShowExportModal(true); }}>
                üìä Export Excel
              </Button>
            </div>
          )}
        </div>
      </div>

      {/* Module Disponibilit√©s - Calendrier Visuel */}
      <div className="disponibilites-visual-container">

        {/* Barre de navigation du mois - Harmonis√©e */}
        <div style={{
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          marginBottom: '2rem',
          padding: '1rem',
          background: 'white',
          borderRadius: '12px',
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
        }}>
          <Button 
            variant="ghost" 
            onClick={() => navigateMonth('prev')}
          >
            ‚Üê Mois pr√©c√©dent
          </Button>
          <h2 style={{margin: 0, fontSize: '1.3rem', fontWeight: '600', color: '#1F2937'}}>
            {getMonthName(calendarCurrentMonth)} {calendarCurrentYear}
          </h2>
          <Button 
            variant="ghost" 
            onClick={() => navigateMonth('next')}
          >
            Mois suivant ‚Üí
          </Button>
        </div>

        {/* Grand Calendrier Visuel */}
        <div className="visual-calendar">
          {/* Jours de la semaine */}
          <div className="calendar-weekdays">
            <div className="calendar-weekday">Lun</div>
            <div className="calendar-weekday">Mar</div>
            <div className="calendar-weekday">Mer</div>
            <div className="calendar-weekday">Jeu</div>
            <div className="calendar-weekday">Ven</div>
            <div className="calendar-weekday">Sam</div>
            <div className="calendar-weekday">Dim</div>
          </div>

          {/* Grille des jours */}
          <div className="calendar-days-grid">
            {/* Cases vides pour aligner le premier jour */}
            {Array.from({ length: getFirstDayOfMonth(calendarCurrentMonth, calendarCurrentYear) }).map((_, index) => (
              <div key={`empty-${index}`} className="calendar-day-cell empty"></div>
            ))}

            {/* Jours du mois */}
            {Array.from({ length: getDaysInMonth(calendarCurrentMonth, calendarCurrentYear) }).map((_, dayIndex) => {
              const dayNumber = dayIndex + 1;
              const currentDate = new Date(calendarCurrentYear, calendarCurrentMonth, dayNumber);
              // Format YYYY-MM-DD sans conversion UTC
              const dateStr = `${calendarCurrentYear}-${String(calendarCurrentMonth + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
              const today = new Date();
              const isToday = currentDate.toDateString() === today.toDateString();
              
              const dayDispos = userDisponibilites.filter(d => d.date === dateStr || d.date.startsWith(dateStr));
              const disponibilites = dayDispos.filter(d => d.statut === 'disponible');
              const hasIndisponibilite = dayDispos.some(d => d.statut === 'indisponible');

              return (
                <div 
                  key={dayNumber} 
                  className={`calendar-day-cell ${isToday ? 'today' : ''}`}
                  onClick={() => handleDayClick(dayNumber)}
                >
                  <div className="calendar-day-number">{dayNumber}</div>
                  <div className="calendar-day-content">
                    {/* Indisponibilit√©: croix rouge */}
                    {hasIndisponibilite && (
                      <div className="calendar-indispo-marker">‚ùå</div>
                    )}

                    {/* Disponibilit√©s: pastilles color√©es */}
                    {!hasIndisponibilite && disponibilites.length > 0 && (
                      <div className="calendar-dispo-pills">
                        {disponibilites.slice(0, 2).map((dispo, idx) => {
                          const typeGarde = typesGarde.find(t => t.id === dispo.type_garde_id);
                          const color = typeGarde?.couleur || '#3b82f6';
                          const typeName = typeGarde?.nom || 'Dispo';
                          
                          return (
                            <div 
                              key={idx}
                              className="calendar-dispo-pill"
                              style={{ backgroundColor: color }}
                              title={`${typeName} ${dispo.heure_debut}-${dispo.heure_fin}`}
                            >
                              {typeName}
                            </div>
                          );
                        })}
                        {disponibilites.length > 2 && (
                          <div className="calendar-dispo-more">+{disponibilites.length - 2}</div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* L√©gende du calendrier */}
        <div className="calendar-legend">
          <div className="calendar-legend-item">
            <span className="calendar-legend-icon">‚ùå</span>
            <span className="calendar-legend-label">Indisponible</span>
          </div>
          {typesGarde.map(type => (
            <div key={type.id} className="calendar-legend-item">
              <div 
                className="calendar-legend-pill" 
                style={{ backgroundColor: type.couleur }}
              ></div>
              <span className="calendar-legend-label">{type.nom}</span>
            </div>
          ))}
        </div>
      </div>

      {/* Modal d√©tail du jour */}
      {showDayDetailModal && selectedDayForDetail && (
        <div className="day-detail-modal" onClick={() => setShowDayDetailModal(false)}>
          <div className="day-detail-content" onClick={(e) => e.stopPropagation()}>
            <div className="day-detail-header">
              <h3>üìÖ {selectedDayForDetail.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</h3>
              <Button variant="ghost" onClick={() => setShowDayDetailModal(false)}>‚úï</Button>
            </div>
            
            <div className="day-detail-body">
              {/* Disponibilit√©s */}
              <div className="day-detail-section">
                <h4>‚úÖ Disponibilit√©s ({dayDetailData.disponibilites.length})</h4>
                {dayDetailData.disponibilites.length === 0 ? (
                  <div className="day-detail-empty">Aucune disponibilit√© ce jour</div>
                ) : (
                  dayDetailData.disponibilites.map(dispo => {
                    const typeGarde = typesGarde.find(t => t.id === dispo.type_garde_id);
                    return (
                      <div key={dispo.id} className="day-detail-item">
                        <div className="day-detail-item-header">
                          <span className="day-detail-item-type" style={{ color: typeGarde?.couleur || '#3b82f6' }}>
                            {typeGarde?.nom || 'Disponibilit√©'}
                          </span>
                          <div className="day-detail-item-actions">
                            <Button 
                              size="sm" 
                              variant="outline" 
                              onClick={() => handleDeleteDisponibilite(dispo.id)}
                            >
                              üóëÔ∏è Supprimer
                            </Button>
                          </div>
                        </div>
                        <div className="day-detail-item-info">
                          ‚è∞ {dispo.heure_debut} - {dispo.heure_fin}
                          {dispo.origine && <span> ‚Ä¢ Origine: {dispo.origine}</span>}
                        </div>
                      </div>
                    );
                  })
                )}
              </div>

              {/* Indisponibilit√©s */}
              <div className="day-detail-section">
                <h4>‚ùå Indisponibilit√©s ({dayDetailData.indisponibilites.length})</h4>
                {dayDetailData.indisponibilites.length === 0 ? (
                  <div className="day-detail-empty">Aucune indisponibilit√© ce jour</div>
                ) : (
                  dayDetailData.indisponibilites.map(indispo => (
                    <div key={indispo.id} className="day-detail-item">
                      <div className="day-detail-item-header">
                        <span className="day-detail-item-type" style={{ color: '#dc2626' }}>
                          Indisponible
                        </span>
                        <div className="day-detail-item-actions">
                          <Button 
                            size="sm" 
                            variant="outline" 
                            onClick={() => handleDeleteDisponibilite(indispo.id)}
                          >
                            üóëÔ∏è Supprimer
                          </Button>
                        </div>
                      </div>
                      <div className="day-detail-item-info">
                        ‚è∞ {indispo.heure_debut} - {indispo.heure_fin}
                        {indispo.origine && <span> ‚Ä¢ Origine: {indispo.origine}</span>}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>

            <div className="day-detail-footer">
              <Button variant="outline" onClick={() => setShowDayDetailModal(false)}>
                Fermer
              </Button>
              <Button 
                variant="default" 
                onClick={() => {
                  if (selectedDayForDetail) {
                    setQuickAddConfig({
                      date: selectedDayForDetail.toISOString().split('T')[0],
                      type_garde_id: '',
                      heure_debut: '08:00',
                      heure_fin: '16:00'
                    });
                    setQuickAddType('disponibilite');
                    setShowDayDetailModal(false);
                    setShowQuickAddModal(true);
                  }
                }}
                style={{ background: '#16a34a', borderColor: '#16a34a' }}
              >
                ‚úÖ Ajouter disponibilit√©
              </Button>
              <Button 
                variant="destructive" 
                onClick={() => {
                  if (selectedDayForDetail) {
                    setQuickAddConfig({
                      date: selectedDayForDetail.toISOString().split('T')[0],
                      type_garde_id: '',
                      heure_debut: '00:00',
                      heure_fin: '23:59'
                    });
                    setQuickAddType('indisponibilite');
                    setShowDayDetailModal(false);
                    setShowQuickAddModal(true);
                  }
                }}
              >
                ‚ùå Ajouter indisponibilit√©
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* NOUVEAU : Modal d'ajout rapide */}
      {showQuickAddModal && (
        <div className="modal-overlay" onClick={() => setShowQuickAddModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px' }}>
            <div className="modal-header">
              <h3>
                {quickAddType === 'disponibilite' ? '‚úÖ Ajouter disponibilit√©' : '‚ùå Ajouter indisponibilit√©'}
              </h3>
              <Button variant="ghost" onClick={() => setShowQuickAddModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body">
              {/* Date fixe - non modifiable */}
              <div className="config-section" style={{ background: '#f8fafc', padding: '1rem', borderRadius: '8px', marginBottom: '1.5rem' }}>
                <Label style={{ fontWeight: 'bold', fontSize: '0.9rem', color: '#64748b' }}>üìÖ Date</Label>
                <div style={{ fontSize: '1.3rem', fontWeight: '700', color: '#0f172a', marginTop: '0.5rem' }}>
                  {new Date(quickAddConfig.date + 'T00:00:00').toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                  })}
                </div>
              </div>

              {/* S√©lection du type de garde */}
              <div className="config-section">
                <Label>üöí Type de garde</Label>
                <select
                  value={quickAddConfig.type_garde_id}
                  onChange={(e) => {
                    const selectedType = typesGarde.find(t => t.id === e.target.value);
                    setQuickAddConfig({
                      ...quickAddConfig,
                      type_garde_id: e.target.value,
                      heure_debut: selectedType ? selectedType.heure_debut : quickAddConfig.heure_debut,
                      heure_fin: selectedType ? selectedType.heure_fin : quickAddConfig.heure_fin
                    });
                  }}
                  className="form-select"
                  style={{ marginTop: '0.5rem' }}
                >
                  <option value="">
                    {quickAddType === 'disponibilite' ? 'Tous les types de garde' : 'Toute la journ√©e'}
                  </option>
                  {typesGarde.map(type => (
                    <option key={type.id} value={type.id}>
                      {type.nom} ({type.heure_debut} - {type.heure_fin})
                    </option>
                  ))}
                </select>
                <small style={{ display: 'block', marginTop: '8px', color: '#64748b' }}>
                  {quickAddConfig.type_garde_id 
                    ? 'Les horaires du type de garde sont appliqu√©s automatiquement'
                    : quickAddType === 'disponibilite'
                      ? 'Vous √™tes disponible pour tous les types de garde avec les horaires ci-dessous'
                      : 'Vous √™tes indisponible toute la journ√©e'
                  }
                </small>
              </div>

              {/* Horaires personnalis√©s si pas de type sp√©cifique */}
              <div className="config-section">
                <Label>‚è∞ Horaires</Label>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginTop: '0.5rem' }}>
                  <div>
                    <Label style={{ fontSize: '0.85rem', color: '#64748b' }}>Heure de d√©but</Label>
                    <Input 
                      type="time" 
                      value={quickAddConfig.heure_debut}
                      onChange={(e) => setQuickAddConfig({...quickAddConfig, heure_debut: e.target.value})}
                      disabled={!!quickAddConfig.type_garde_id}
                    />
                  </div>
                  <div>
                    <Label style={{ fontSize: '0.85rem', color: '#64748b' }}>Heure de fin</Label>
                    <Input 
                      type="time" 
                      value={quickAddConfig.heure_fin}
                      onChange={(e) => setQuickAddConfig({...quickAddConfig, heure_fin: e.target.value})}
                      disabled={!!quickAddConfig.type_garde_id}
                    />
                  </div>
                </div>
              </div>

              {/* R√©sum√© */}
              <div style={{ 
                background: quickAddType === 'disponibilite' ? '#f0fdf4' : '#fef2f2', 
                padding: '1rem', 
                borderRadius: '8px', 
                border: quickAddType === 'disponibilite' ? '2px solid #16a34a' : '2px solid #dc2626',
                marginTop: '1.5rem'
              }}>
                <div style={{ fontWeight: 'bold', marginBottom: '0.5rem', color: quickAddType === 'disponibilite' ? '#16a34a' : '#dc2626' }}>
                  üìã R√©sum√©
                </div>
                <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#0f172a' }}>
                  {quickAddType === 'disponibilite' ? '‚úÖ Vous serez disponible' : '‚ùå Vous serez indisponible'}<br/>
                  üìÖ Le {new Date(quickAddConfig.date + 'T00:00:00').toLocaleDateString('fr-FR')}<br/>
                  ‚è∞ De {quickAddConfig.heure_debut} √† {quickAddConfig.heure_fin}<br/>
                  üöí {quickAddConfig.type_garde_id 
                    ? `Pour ${typesGarde.find(t => t.id === quickAddConfig.type_garde_id)?.nom}`
                    : quickAddType === 'disponibilite' ? 'Pour tous les types de garde' : 'Toute la journ√©e'
                  }
                </div>
              </div>
            </div>

            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowQuickAddModal(false)}>
                Annuler
              </Button>
              <Button 
                variant="default" 
                onClick={handleQuickAddSave}
                style={{ 
                  background: quickAddType === 'disponibilite' ? '#16a34a' : '#dc2626',
                  borderColor: quickAddType === 'disponibilite' ? '#16a34a' : '#dc2626'
                }}
              >
                {quickAddType === 'disponibilite' ? '‚úÖ Ajouter disponibilit√©' : '‚ùå Ajouter indisponibilit√©'}
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Modal de configuration avanc√©e */}
      {showCalendarModal && (
        <div className="modal-overlay" onClick={() => setShowCalendarModal(false)}>
          <div className="modal-content extra-large-modal" onClick={(e) => e.stopPropagation()} data-testid="availability-config-modal">
            <div className="modal-header">
              <h3>‚úÖ G√©rer disponibilit√©s</h3>
              <Button variant="ghost" onClick={() => setShowCalendarModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="availability-config-advanced">
                {/* S√©lecteur de mode */}
                <div className="config-section" style={{ marginBottom: '20px' }}>
                  <div style={{ display: 'flex', gap: '10px', justifyContent: 'center' }}>
                    <button
                      onClick={() => setAvailabilityConfig({...availabilityConfig, mode: 'calendrier'})}
                      style={{
                        padding: '10px 20px',
                        border: availabilityConfig.mode === 'calendrier' ? '2px solid #16a34a' : '2px solid #e2e8f0',
                        borderRadius: '8px',
                        background: availabilityConfig.mode === 'calendrier' ? '#f0fdf4' : 'white',
                        cursor: 'pointer',
                        fontWeight: availabilityConfig.mode === 'calendrier' ? 'bold' : 'normal',
                        color: availabilityConfig.mode === 'calendrier' ? '#16a34a' : '#64748b'
                      }}
                    >
                      üìÖ Calendrier (Clics multiples)
                    </button>
                    <button
                      onClick={() => setAvailabilityConfig({...availabilityConfig, mode: 'recurrence'})}
                      style={{
                        padding: '10px 20px',
                        border: availabilityConfig.mode === 'recurrence' ? '2px solid #16a34a' : '2px solid #e2e8f0',
                        borderRadius: '8px',
                        background: availabilityConfig.mode === 'recurrence' ? '#f0fdf4' : 'white',
                        cursor: 'pointer',
                        fontWeight: availabilityConfig.mode === 'recurrence' ? 'bold' : 'normal',
                        color: availabilityConfig.mode === 'recurrence' ? '#16a34a' : '#64748b'
                      }}
                    >
                      üîÑ Avec r√©currence
                    </button>
                  </div>
                </div>

                {/* Configuration du type de garde */}
                <div className="config-section">
                  <h4>üöí Type de garde sp√©cifique</h4>
                  <div className="type-garde-selection">
                    <Label>Pour quel type de garde √™tes-vous disponible ?</Label>
                    <select
                      value={availabilityConfig.type_garde_id}
                      onChange={(e) => handleTypeGardeChange(e.target.value)}
                      className="form-select"
                      data-testid="availability-type-garde-select"
                    >
                      <option value="">Tous les types de garde</option>
                      {typesGarde.map(type => (
                        <option key={type.id} value={type.id}>
                          {type.nom} ({type.heure_debut} - {type.heure_fin})
                        </option>
                      ))}
                    </select>
                    <small>
                      S√©lectionnez un type sp√©cifique ou laissez "Tous les types" pour une disponibilit√© g√©n√©rale
                    </small>
                  </div>
                </div>

                {/* Configuration des horaires - Seulement si "Tous les types" */}
                {!availabilityConfig.type_garde_id && (
                  <div className="config-section">
                    <h4>‚è∞ Cr√©neaux horaires personnalis√©s</h4>
                    <p className="section-note">D√©finissez vos horaires de disponibilit√© g√©n√©rale</p>
                    <div className="time-config-row">
                      <div className="time-field">
                        <Label>Heure de d√©but</Label>
                        <Input 
                          type="time" 
                          value={availabilityConfig.heure_debut}
                          onChange={(e) => setAvailabilityConfig({...availabilityConfig, heure_debut: e.target.value})}
                          data-testid="availability-start-time"
                        />
                      </div>
                      <div className="time-field">
                        <Label>Heure de fin</Label>
                        <Input 
                          type="time" 
                          value={availabilityConfig.heure_fin}
                          onChange={(e) => setAvailabilityConfig({...availabilityConfig, heure_fin: e.target.value})}
                          data-testid="availability-end-time"
                        />
                      </div>
                    </div>
                    <small style={{ marginTop: '8px', display: 'block', color: '#64748b' }}>
                      ‚ÑπÔ∏è Les entr√©es cr√©√©es ici seront automatiquement marqu√©es comme "Disponible"
                    </small>
                  </div>
                )}

                {/* Horaires automatiques si type sp√©cifique s√©lectionn√© */}
                {availabilityConfig.type_garde_id && (
                  <div className="config-section">
                    <h4>‚è∞ Horaires du type de garde</h4>
                    <div className="automatic-hours">
                      <div className="hours-display">
                        <span className="hours-label">Horaires automatiques :</span>
                        <span className="hours-value">
                          {(() => {
                            const selectedType = typesGarde.find(t => t.id === availabilityConfig.type_garde_id);
                            return selectedType ? `${selectedType.heure_debut} - ${selectedType.heure_fin}` : 'Non d√©fini';
                          })()}
                        </span>
                      </div>
                      <small style={{ marginTop: '8px', display: 'block', color: '#64748b' }}>
                        ‚ÑπÔ∏è Les disponibilit√©s seront automatiquement enregistr√©es avec ces horaires
                      </small>
                    </div>
                  </div>
                )}

                {/* MODE CALENDRIER - S√©lection des dates */}
                {availabilityConfig.mode === 'calendrier' && (
                  <div className="config-section">
                    <h4>üìÜ S√©lection des dates</h4>
                    <div className="calendar-instructions">
                      <p>Cliquez sur les dates o√π vous √™tes disponible :</p>
                      <small style={{color: '#ef4444', marginTop: '0.5rem', display: 'block'}}>
                        ‚ùå Les dates barr√©es en rouge indiquent des indisponibilit√©s existantes
                      </small>
                    </div>
                    
                    <Calendar
                      mode="multiple"
                      selected={selectedDates}
                      onSelect={setSelectedDates}
                      className="interactive-calendar"
                      disabled={(date) => date < new Date().setHours(0,0,0,0)}
                      indisponibilites={userDisponibilites.filter(d => d.statut === 'indisponible')}
                    />
                    
                    <div className="selection-summary-advanced">
                      <div className="summary-item">
                        <strong>Type de garde :</strong> {getTypeGardeName(availabilityConfig.type_garde_id)}
                      </div>
                      <div className="summary-item">
                        <strong>Dates s√©lectionn√©es :</strong> {selectedDates?.length || 0} jour(s)
                      </div>
                      <div className="summary-item">
                        <strong>Horaires :</strong> {availabilityConfig.heure_debut} - {availabilityConfig.heure_fin}
                      </div>
                    </div>
                  </div>
                )}

                {/* MODE R√âCURRENCE - P√©riode avec r√©currence */}
                {availabilityConfig.mode === 'recurrence' && (
                  <>
                    <div className="config-section">
                      <h4>üìÖ P√©riode</h4>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                        <div>
                          <Label>Date de d√©but</Label>
                          <Input
                            type="date"
                            value={availabilityConfig.date_debut}
                            onChange={(e) => setAvailabilityConfig({...availabilityConfig, date_debut: e.target.value})}
                          />
                        </div>
                        <div>
                          <Label>Date de fin</Label>
                          <Input
                            type="date"
                            value={availabilityConfig.date_fin}
                            onChange={(e) => setAvailabilityConfig({...availabilityConfig, date_fin: e.target.value})}
                          />
                        </div>
                      </div>
                    </div>

                    <div className="config-section">
                      <h4>üîÑ R√©currence</h4>
                      <Label>Type de r√©currence</Label>
                      <select
                        value={availabilityConfig.recurrence_type}
                        onChange={(e) => setAvailabilityConfig({...availabilityConfig, recurrence_type: e.target.value})}
                        className="form-select"
                      >
                        <option value="hebdomadaire">Toutes les semaines (hebdomadaire)</option>
                        <option value="bihebdomadaire">Toutes les deux semaines (bihebdomadaire)</option>
                        <option value="mensuelle">Tous les mois (mensuelle)</option>
                        <option value="annuelle">Tous les ans (annuelle)</option>
                        <option value="personnalisee">Personnalis√©e</option>
                      </select>

                      {availabilityConfig.recurrence_type === 'personnalisee' && (
                        <div style={{ marginTop: '15px', padding: '15px', background: '#f0fdf4', borderRadius: '8px' }}>
                          <h5 style={{ marginTop: 0, marginBottom: '10px' }}>‚öôÔ∏è Configuration personnalis√©e</h5>
                          <Label>Fr√©quence</Label>
                          <select
                            value={availabilityConfig.recurrence_frequence}
                            onChange={(e) => setAvailabilityConfig({...availabilityConfig, recurrence_frequence: e.target.value})}
                            className="form-select"
                            style={{ marginBottom: '10px' }}
                          >
                            <option value="jours">Jours</option>
                            <option value="semaines">Semaines</option>
                            <option value="mois">Mois</option>
                            <option value="ans">Ans</option>
                          </select>

                          <Label>Intervalle : Tous les</Label>
                          <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                            <Input
                              type="number"
                              min="1"
                              max="365"
                              value={availabilityConfig.recurrence_intervalle}
                              onChange={(e) => setAvailabilityConfig({...availabilityConfig, recurrence_intervalle: parseInt(e.target.value) || 1})}
                              style={{ width: '100px' }}
                            />
                            <span>{availabilityConfig.recurrence_frequence}</span>
                          </div>
                        </div>
                      )}
                      
                      {/* S√©lection des jours de la semaine pour hebdomadaire/bihebdomadaire */}
                      {(availabilityConfig.recurrence_type === 'hebdomadaire' || availabilityConfig.recurrence_type === 'bihebdomadaire') && (
                        <div style={{ marginTop: '15px', padding: '15px', background: '#f0fdf4', borderRadius: '8px' }}>
                          <h5 style={{ marginTop: 0, marginBottom: '10px' }}>üìÖ S√©lectionnez les jours de la semaine</h5>
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))', gap: '8px' }}>
                            {[
                              { label: 'Lun', value: 'monday' },
                              { label: 'Mar', value: 'tuesday' },
                              { label: 'Mer', value: 'wednesday' },
                              { label: 'Jeu', value: 'thursday' },
                              { label: 'Ven', value: 'friday' },
                              { label: 'Sam', value: 'saturday' },
                              { label: 'Dim', value: 'sunday' }
                            ].map(jour => (
                              <label
                                key={jour.value}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  padding: '8px',
                                  borderRadius: '8px',
                                  border: `2px solid ${availabilityConfig.jours_semaine?.includes(jour.value) ? '#16a34a' : '#cbd5e1'}`,
                                  background: availabilityConfig.jours_semaine?.includes(jour.value) ? '#dcfce7' : 'white',
                                  cursor: 'pointer',
                                  fontWeight: availabilityConfig.jours_semaine?.includes(jour.value) ? '600' : '400'
                                }}
                              >
                                <input
                                  type="checkbox"
                                  checked={availabilityConfig.jours_semaine?.includes(jour.value) || false}
                                  onChange={(e) => {
                                    const currentJours = availabilityConfig.jours_semaine || [];
                                    const newJours = e.target.checked
                                      ? [...currentJours, jour.value]
                                      : currentJours.filter(j => j !== jour.value);
                                    setAvailabilityConfig({...availabilityConfig, jours_semaine: newJours});
                                  }}
                                  style={{ marginRight: '6px' }}
                                />
                                {jour.label}
                              </label>
                            ))}
                          </div>
                          {availabilityConfig.jours_semaine && availabilityConfig.jours_semaine.length > 0 && (
                            <p style={{ marginTop: '10px', color: '#16a34a', fontSize: '0.9rem' }}>
                              ‚úì {availabilityConfig.jours_semaine.length} jour(s) s√©lectionn√©(s)
                            </p>
                          )}
                        </div>
                      )}
                    </div>

                    {/* R√©sum√© pour le mode r√©currence */}
                    <div className="config-section" style={{ background: '#f0fdf4', padding: '15px', borderRadius: '8px', border: '1px solid #bbf7d0' }}>
                      <h4 style={{ color: '#15803d', marginTop: 0 }}>üìä R√©sum√©</h4>
                      <ul style={{ margin: '10px 0', paddingLeft: '20px', color: '#15803d' }}>
                        <li><strong>Mode :</strong> R√©currence</li>
                        <li><strong>Type de garde :</strong> {getTypeGardeName(availabilityConfig.type_garde_id)}</li>
                        <li><strong>P√©riode :</strong> Du {new Date(availabilityConfig.date_debut).toLocaleDateString('fr-FR')} au {new Date(availabilityConfig.date_fin).toLocaleDateString('fr-FR')}</li>
                        <li><strong>R√©currence :</strong> {
                          availabilityConfig.recurrence_type === 'hebdomadaire' ? 'Toutes les semaines' :
                          availabilityConfig.recurrence_type === 'bihebdomadaire' ? 'Toutes les 2 semaines' :
                          availabilityConfig.recurrence_type === 'mensuelle' ? 'Tous les mois' :
                          availabilityConfig.recurrence_type === 'annuelle' ? 'Tous les ans' :
                          `Tous les ${availabilityConfig.recurrence_intervalle} ${availabilityConfig.recurrence_frequence}`
                        }</li>
                        <li><strong>Horaires :</strong> {availabilityConfig.heure_debut} - {availabilityConfig.heure_fin}</li>
                      </ul>
                    </div>
                  </>
                )}
              </div>

              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowCalendarModal(false)}>
                  Annuler
                </Button>
                <Button 
                  variant="default" 
                  onClick={handleSaveAvailability}
                  data-testid="save-availability-btn"
                  disabled={availabilityConfig.mode === 'calendrier' && (!selectedDates || selectedDates.length === 0)}
                >
                  {availabilityConfig.mode === 'calendrier' 
                    ? `‚úÖ Sauvegarder (${selectedDates?.length || 0} jour${selectedDates?.length > 1 ? 's' : ''})`
                    : '‚úÖ G√©n√©rer les disponibilit√©s'}
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de g√©n√©ration automatique d'indisponibilit√©s */}
      {showGenerationModal && (
        <div className="modal-overlay" onClick={() => setShowGenerationModal(false)}>
          <div className="modal-content extra-large-modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>‚ùå G√©rer indisponibilit√©s</h3>
              <Button variant="ghost" onClick={() => setShowGenerationModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              {/* Onglets */}
              <div style={{ display: 'flex', gap: '10px', marginBottom: '20px', borderBottom: '2px solid #e2e8f0' }}>
                <button
                  onClick={() => setIndispoTab('generation')}
                  style={{
                    padding: '12px 24px',
                    border: 'none',
                    background: indispoTab === 'generation' ? 'white' : 'transparent',
                    borderBottom: indispoTab === 'generation' ? '3px solid #dc2626' : 'none',
                    fontWeight: indispoTab === 'generation' ? 'bold' : 'normal',
                    cursor: 'pointer',
                    color: indispoTab === 'generation' ? '#dc2626' : '#64748b'
                  }}
                >
                  üöí G√©n√©ration automatique
                </button>
                <button
                  onClick={() => setIndispoTab('manuelle')}
                  style={{
                    padding: '12px 24px',
                    border: 'none',
                    background: indispoTab === 'manuelle' ? 'white' : 'transparent',
                    borderBottom: indispoTab === 'manuelle' ? '3px solid #dc2626' : 'none',
                    fontWeight: indispoTab === 'manuelle' ? 'bold' : 'normal',
                    cursor: 'pointer',
                    color: indispoTab === 'manuelle' ? '#dc2626' : '#64748b'
                  }}
                >
                  ‚úçÔ∏è Saisie manuelle
                </button>
              </div>

              {/* Contenu de l'onglet G√©n√©ration */}
              {indispoTab === 'generation' && (
              <div>
              <div className="generation-config">
                {/* S√©lection du type d'horaire */}
                <div className="config-section">
                  <h4>üìã Type d'horaire</h4>
                  <select
                    value={generationConfig.horaire_type}
                    onChange={(e) => setGenerationConfig({...generationConfig, horaire_type: e.target.value})}
                    className="form-select"
                  >
                    <option value="montreal">Montreal 7/24 (Cycle 28 jours)</option>
                    <option value="quebec">Quebec 10/14 (Cycle 28 jours)</option>
                  </select>
                  <small style={{ display: 'block', marginTop: '8px', color: '#666' }}>
                    {generationConfig.horaire_type === 'montreal' 
                      ? 'Horaire Montreal 7/24 : Cycle de 28 jours commen√ßant par lundi rouge. Vous serez INDISPONIBLE les 7 jours o√π votre √©quipe travaille.'
                      : 'Horaire Quebec 10/14 : 2J + 1√ó24h + 3N + REPOS + 4J + 3N + REPOS (cycle 28 jours). Vous serez INDISPONIBLE les 13 jours travaill√©s par cycle (~169 jours/an).'}
                  </small>
                </div>

                {/* S√©lection de l'√©quipe */}
                <div className="config-section">
                  <h4>üë• √âquipe</h4>
                  <div className="equipe-selection" style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px' }}>
                    {[
                      {nom: 'Vert', numero: 1},
                      {nom: 'Bleu', numero: 2},
                      {nom: 'Jaune', numero: 3},
                      {nom: 'Rouge', numero: 4}
                    ].map(equipe => (
                      <button
                        key={equipe.nom}
                        onClick={() => setGenerationConfig({...generationConfig, equipe: equipe.nom})}
                        className={`equipe-button ${generationConfig.equipe === equipe.nom ? 'selected' : ''}`}
                        style={{
                          padding: '12px',
                          border: generationConfig.equipe === equipe.nom ? '2px solid #dc2626' : '2px solid #e2e8f0',
                          borderRadius: '8px',
                          background: generationConfig.equipe === equipe.nom ? '#fef2f2' : 'white',
                          cursor: 'pointer',
                          fontWeight: generationConfig.equipe === equipe.nom ? 'bold' : 'normal'
                        }}
                      >
                        {equipe.nom} (#{equipe.numero})
                      </button>
                    ))}
                  </div>
                </div>

                {/* S√©lection des dates */}
                <div className="config-section">
                  <h4>üìÖ P√©riode de g√©n√©ration</h4>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>Date de d√©but</label>
                      <Input
                        type="date"
                        value={generationConfig.date_debut}
                        onChange={(e) => setGenerationConfig({...generationConfig, date_debut: e.target.value})}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>Date de fin</label>
                      <Input
                        type="date"
                        value={generationConfig.date_fin}
                        onChange={(e) => setGenerationConfig({...generationConfig, date_fin: e.target.value})}
                      />
                    </div>
                  </div>
                  <small style={{ display: 'block', marginTop: '8px', color: '#666' }}>
                    Les indisponibilit√©s seront g√©n√©r√©es entre ces deux dates
                  </small>
                </div>

                {/* Option de conservation des modifications manuelles */}
                <div className="config-section">
                  <h4>‚ö†Ô∏è Gestion des donn√©es existantes</h4>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '12px', background: '#fef3c7', borderRadius: '8px', border: '1px solid #fcd34d' }}>
                    <input
                      type="checkbox"
                      id="conserver-manuelles"
                      checked={generationConfig.conserver_manuelles}
                      onChange={(e) => setGenerationConfig({...generationConfig, conserver_manuelles: e.target.checked})}
                      style={{ width: '20px', height: '20px' }}
                    />
                    <label htmlFor="conserver-manuelles" style={{ cursor: 'pointer', color: '#78350f' }}>
                      <strong>Conserver les modifications manuelles</strong>
                      <div style={{ fontSize: '0.875rem', marginTop: '4px' }}>
                        {generationConfig.conserver_manuelles 
                          ? 'Les disponibilit√©s ajout√©es manuellement seront pr√©serv√©es'
                          : '‚ö†Ô∏è ATTENTION : Toutes les disponibilit√©s existantes seront supprim√©es'}
                      </div>
                    </label>
                  </div>
                </div>

                {/* R√©sum√© de la g√©n√©ration */}
                <div className="config-section" style={{ background: '#eff6ff', padding: '15px', borderRadius: '8px', border: '1px solid #3b82f6' }}>
                  <h4 style={{ color: '#1e40af', marginTop: 0 }}>üìä R√©sum√© de la g√©n√©ration</h4>
                  <ul style={{ margin: '10px 0', paddingLeft: '20px', color: '#1e40af' }}>
                    <li><strong>Horaire :</strong> {generationConfig.horaire_type === 'montreal' ? 'Montreal 7/24' : 'Quebec 10/14'}</li>
                    <li><strong>√âquipe :</strong> {generationConfig.equipe}</li>
                    <li><strong>P√©riode :</strong> Du {new Date(generationConfig.date_debut).toLocaleDateString('fr-FR')} au {new Date(generationConfig.date_fin).toLocaleDateString('fr-FR')}</li>
                    <li><strong>Mode :</strong> {generationConfig.conserver_manuelles ? 'Conservation des modifications manuelles' : 'Remplacement total'}</li>


                {/* Section Formatage Planning supprim√©e - d√©plac√©e vers modal Planning */}
                {false && (
                  <div style={{
                    marginTop: '30px',
                    padding: '20px',
                    backgroundColor: '#fef2f2',
                    border: '2px solid #fecaca',
                    borderRadius: '8px'
                  }}>
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      marginBottom: showFormatageSection ? '15px' : '0'
                    }}>
                      <h4 style={{ margin: 0, color: '#991b1b', fontSize: '14px' }}>
                        üóëÔ∏è Formatage Planning (DEMO)
                      </h4>
                      <button
                        onClick={() => setShowFormatageSection(!showFormatageSection)}
                        style={{
                          padding: '6px 12px',
                          backgroundColor: 'transparent',
                          border: '1px solid #dc2626',
                          borderRadius: '4px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          color: '#dc2626'
                        }}
                      >
                        {showFormatageSection ? '‚ñ≤ Masquer' : '‚ñº Afficher'}
                      </button>
                    </div>

                    {showFormatageSection && (
                      <div>
                        <p style={{ 
                          fontSize: '13px', 
                          color: '#7f1d1d',
                          marginBottom: '15px',
                          lineHeight: '1.5'
                        }}>
                          ‚ö†Ô∏è Cette fonctionnalit√© supprime <strong>toutes les assignations et demandes de remplacement</strong> du mois s√©lectionn√©. Utilisez-la pour vider le planning avant une d√©monstration.
                        </p>

                        <div style={{ marginBottom: '15px' }}>
                          <label style={{ 
                            display: 'block', 
                            marginBottom: '8px',
                            fontSize: '13px',
                            fontWeight: 'bold',
                            color: '#7f1d1d'
                          }}>
                            üìÖ S√©lectionner le mois √† formater:
                          </label>
                          <input
                            type="month"
                            value={moisFormatage}
                            onChange={(e) => setMoisFormatage(e.target.value)}
                            style={{
                              width: '100%',
                              padding: '10px',
                              border: '2px solid #dc2626',
                              borderRadius: '6px',
                              fontSize: '14px'
                            }}
                          />
                        </div>

                        <button
                          onClick={handleFormaterPlanning}
                          style={{
                            width: '100%',
                            padding: '12px',
                            backgroundColor: '#dc2626',
                            color: 'white',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: 'bold',
                            transition: 'background-color 0.2s'
                          }}
                          onMouseEnter={(e) => e.target.style.backgroundColor = '#b91c1c'}
                          onMouseLeave={(e) => e.target.style.backgroundColor = '#dc2626'}
                        >
                          üóëÔ∏è Formater le planning de {new Date(moisFormatage + '-01').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                        </button>
                      </div>
                    )}
                  </div>
                )}

                  </ul>
                  <p style={{ margin: '10px 0 0 0', fontSize: '0.875rem', color: '#1e40af' }}>
                    üí° Les <strong>INDISPONIBILIT√âS</strong> seront g√©n√©r√©es pour tous les jours o√π votre √©quipe <strong>TRAVAILLE</strong> √† son emploi principal selon le cycle s√©lectionn√© (vous ne serez donc pas disponible pour les gardes de pompiers ces jours-l√†).
                  </p>
                </div>
              </div>

                <div className="modal-actions">
                  <Button variant="outline" onClick={() => setShowGenerationModal(false)}>
                    Annuler
                  </Button>
                  <Button 
                    variant="default" 
                    onClick={handleGenerateIndisponibilites}
                    disabled={isGenerating}
                  >
                    {isGenerating ? 'G√©n√©ration en cours...' : 'üöÄ G√©n√©rer les indisponibilit√©s'}
                  </Button>
                </div>
              </div>
              )}

              {/* Contenu de l'onglet Saisie manuelle */}
              {indispoTab === 'manuelle' && (
                <div>
                  <div className="manual-indispo-config">
                    {/* S√©lecteur de mode */}
                    <div className="config-section" style={{ marginBottom: '20px' }}>
                      <div style={{ display: 'flex', gap: '10px', justifyContent: 'center' }}>
                        <button
                          onClick={() => setManualIndispoMode('calendrier')}
                          style={{
                            padding: '10px 20px',
                            border: manualIndispoMode === 'calendrier' ? '2px solid #dc2626' : '2px solid #e2e8f0',
                            borderRadius: '8px',
                            background: manualIndispoMode === 'calendrier' ? '#fef2f2' : 'white',
                            cursor: 'pointer',
                            fontWeight: manualIndispoMode === 'calendrier' ? 'bold' : 'normal',
                            color: manualIndispoMode === 'calendrier' ? '#dc2626' : '#64748b'
                          }}
                        >
                          üìÖ Calendrier (Clics multiples)
                        </button>
                        <button
                          onClick={() => setManualIndispoMode('recurrence')}
                          style={{
                            padding: '10px 20px',
                            border: manualIndispoMode === 'recurrence' ? '2px solid #dc2626' : '2px solid #e2e8f0',
                            borderRadius: '8px',
                            background: manualIndispoMode === 'recurrence' ? '#fef2f2' : 'white',
                            cursor: 'pointer',
                            fontWeight: manualIndispoMode === 'recurrence' ? 'bold' : 'normal',
                            color: manualIndispoMode === 'recurrence' ? '#dc2626' : '#64748b'
                          }}
                        >
                          üîÑ Avec r√©currence
                        </button>
                      </div>
                    </div>

                    {/* MODE CALENDRIER */}
                    {manualIndispoMode === 'calendrier' && (
                      <>
                        <div className="config-section">
                          <h4>üìÜ S√©lection des dates d'indisponibilit√©</h4>
                          <Calendar
                            mode="multiple"
                            selected={manualIndispoConfig.dates}
                            onSelect={(dates) => setManualIndispoConfig({...manualIndispoConfig, dates: dates || []})}
                            className="availability-calendar-large"
                            locale={fr}
                            indisponibilites={userDisponibilites.filter(d => d.statut === 'indisponible')}
                          />
                          <small style={{ display: 'block', marginTop: '8px', color: '#64748b' }}>
                            üìå Cliquez sur plusieurs dates pour s√©lectionner vos jours d'indisponibilit√©
                          </small>
                          <small style={{color: '#ef4444', marginTop: '0.5rem', display: 'block'}}>
                            ‚ùå Les dates barr√©es en rouge indiquent des indisponibilit√©s existantes
                          </small>
                          {manualIndispoConfig.dates.length > 0 && (
                            <p style={{ marginTop: '10px', color: '#dc2626', fontWeight: 'bold' }}>
                              ‚úì {manualIndispoConfig.dates.length} date(s) s√©lectionn√©e(s)
                            </p>
                          )}
                        </div>
                      </>
                    )}

                    {/* MODE R√âCURRENCE */}
                    {manualIndispoMode === 'recurrence' && (
                      <>
                        <div className="config-section">
                          <h4>üìÖ P√©riode</h4>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                            <div>
                              <Label>Date de d√©but</Label>
                              <Input
                                type="date"
                                value={manualIndispoConfig.date_debut}
                                onChange={(e) => setManualIndispoConfig({...manualIndispoConfig, date_debut: e.target.value})}
                              />
                            </div>
                            <div>
                              <Label>Date de fin</Label>
                              <Input
                                type="date"
                                value={manualIndispoConfig.date_fin}
                                onChange={(e) => setManualIndispoConfig({...manualIndispoConfig, date_fin: e.target.value})}
                              />
                            </div>
                          </div>
                        </div>

                        <div className="config-section">
                          <h4>üîÑ R√©currence</h4>
                          <Label>Type de r√©currence</Label>
                          <select
                            value={manualIndispoConfig.recurrence_type}
                            onChange={(e) => setManualIndispoConfig({...manualIndispoConfig, recurrence_type: e.target.value})}
                            className="form-select"
                          >
                            <option value="hebdomadaire">Toutes les semaines (hebdomadaire)</option>
                            <option value="bihebdomadaire">Toutes les deux semaines (bihebdomadaire)</option>
                            <option value="mensuelle">Tous les mois (mensuelle)</option>
                            <option value="annuelle">Tous les ans (annuelle)</option>
                            <option value="personnalisee">Personnalis√©e</option>
                          </select>

                          {manualIndispoConfig.recurrence_type === 'personnalisee' && (
                            <div style={{ marginTop: '15px', padding: '15px', background: '#f8fafc', borderRadius: '8px' }}>
                              <h5 style={{ marginTop: 0, marginBottom: '10px' }}>‚öôÔ∏è Configuration personnalis√©e</h5>
                              <Label>Fr√©quence</Label>
                              <select
                                value={manualIndispoConfig.recurrence_frequence}
                                onChange={(e) => setManualIndispoConfig({...manualIndispoConfig, recurrence_frequence: e.target.value})}
                                className="form-select"
                                style={{ marginBottom: '10px' }}
                              >
                                <option value="jours">Jours</option>
                                <option value="semaines">Semaines</option>
                                <option value="mois">Mois</option>
                                <option value="ans">Ans</option>
                              </select>

                              <Label>Intervalle : Tous les</Label>
                              <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                                <Input
                                  type="number"
                                  min="1"
                                  max="365"
                                  value={manualIndispoConfig.recurrence_intervalle}
                                  onChange={(e) => setManualIndispoConfig({...manualIndispoConfig, recurrence_intervalle: parseInt(e.target.value) || 1})}
                                  style={{ width: '100px' }}
                                />
                                <span>{manualIndispoConfig.recurrence_frequence}</span>
                              </div>
                            </div>
                          )}
                          
                          {/* S√©lection des jours de la semaine pour hebdomadaire/bihebdomadaire */}
                          {(manualIndispoConfig.recurrence_type === 'hebdomadaire' || manualIndispoConfig.recurrence_type === 'bihebdomadaire') && (
                            <div style={{ marginTop: '15px', padding: '15px', background: '#fef2f2', borderRadius: '8px' }}>
                              <h5 style={{ marginTop: 0, marginBottom: '10px' }}>üìÖ S√©lectionnez les jours de la semaine</h5>
                              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))', gap: '8px' }}>
                                {[
                                  { label: 'Lun', value: 'monday' },
                                  { label: 'Mar', value: 'tuesday' },
                                  { label: 'Mer', value: 'wednesday' },
                                  { label: 'Jeu', value: 'thursday' },
                                  { label: 'Ven', value: 'friday' },
                                  { label: 'Sam', value: 'saturday' },
                                  { label: 'Dim', value: 'sunday' }
                                ].map(jour => (
                                  <label
                                    key={jour.value}
                                    style={{
                                      display: 'flex',
                                      alignItems: 'center',
                                      padding: '8px',
                                      borderRadius: '8px',
                                      border: `2px solid ${manualIndispoConfig.jours_semaine?.includes(jour.value) ? '#dc2626' : '#cbd5e1'}`,
                                      background: manualIndispoConfig.jours_semaine?.includes(jour.value) ? '#fee2e2' : 'white',
                                      cursor: 'pointer',
                                      fontWeight: manualIndispoConfig.jours_semaine?.includes(jour.value) ? '600' : '400'
                                    }}
                                  >
                                    <input
                                      type="checkbox"
                                      checked={manualIndispoConfig.jours_semaine?.includes(jour.value) || false}
                                      onChange={(e) => {
                                        const currentJours = manualIndispoConfig.jours_semaine || [];
                                        const newJours = e.target.checked
                                          ? [...currentJours, jour.value]
                                          : currentJours.filter(j => j !== jour.value);
                                        setManualIndispoConfig({...manualIndispoConfig, jours_semaine: newJours});
                                      }}
                                      style={{ marginRight: '6px' }}
                                    />
                                    {jour.label}
                                  </label>
                                ))}
                              </div>
                              {manualIndispoConfig.jours_semaine && manualIndispoConfig.jours_semaine.length > 0 && (
                                <p style={{ marginTop: '10px', color: '#dc2626', fontSize: '0.9rem' }}>
                                  ‚úì {manualIndispoConfig.jours_semaine.length} jour(s) s√©lectionn√©(s)
                                </p>
                              )}
                            </div>
                          )}
                        </div>
                      </>
                    )}

                    {/* Configuration des horaires (commun aux deux modes) */}
                    <div className="config-section">
                      <h4>‚è∞ Horaires d'indisponibilit√©</h4>
                      <div className="time-config-row" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                        <div>
                          <Label>Heure de d√©but</Label>
                          <Input 
                            type="time" 
                            value={manualIndispoConfig.heure_debut}
                            onChange={(e) => setManualIndispoConfig({...manualIndispoConfig, heure_debut: e.target.value})}
                          />
                        </div>
                        <div>
                          <Label>Heure de fin</Label>
                          <Input 
                            type="time" 
                            value={manualIndispoConfig.heure_fin}
                            onChange={(e) => setManualIndispoConfig({...manualIndispoConfig, heure_fin: e.target.value})}
                          />
                        </div>
                      </div>
                      <small style={{ display: 'block', marginTop: '8px', color: '#64748b' }}>
                        üí° Par d√©faut : 00:00-23:59 (toute la journ√©e)
                      </small>
                    </div>

                    {/* R√©sum√© */}
                    <div className="config-section" style={{ background: '#fef2f2', padding: '15px', borderRadius: '8px', border: '1px solid #fecaca' }}>
                      <h4 style={{ color: '#991b1b', marginTop: 0 }}>üìä R√©sum√©</h4>
                      {manualIndispoMode === 'calendrier' ? (
                        <ul style={{ margin: '10px 0', paddingLeft: '20px', color: '#991b1b' }}>
                          <li><strong>Mode :</strong> Calendrier (clics multiples)</li>
                          <li><strong>Dates s√©lectionn√©es :</strong> {manualIndispoConfig.dates.length} jour(s)</li>
                          <li><strong>Horaires :</strong> {manualIndispoConfig.heure_debut} - {manualIndispoConfig.heure_fin}</li>
                        </ul>
                      ) : (
                        <ul style={{ margin: '10px 0', paddingLeft: '20px', color: '#991b1b' }}>
                          <li><strong>Mode :</strong> R√©currence</li>
                          <li><strong>P√©riode :</strong> Du {new Date(manualIndispoConfig.date_debut).toLocaleDateString('fr-FR')} au {new Date(manualIndispoConfig.date_fin).toLocaleDateString('fr-FR')}</li>
                          <li><strong>R√©currence :</strong> {
                            manualIndispoConfig.recurrence_type === 'hebdomadaire' ? 'Toutes les semaines' :
                            manualIndispoConfig.recurrence_type === 'bihebdomadaire' ? 'Toutes les 2 semaines' :
                            manualIndispoConfig.recurrence_type === 'mensuelle' ? 'Tous les mois' :
                            manualIndispoConfig.recurrence_type === 'annuelle' ? 'Tous les ans' :
                            `Tous les ${manualIndispoConfig.recurrence_intervalle} ${manualIndispoConfig.recurrence_frequence}`
                          }</li>
                          <li><strong>Horaires :</strong> {manualIndispoConfig.heure_debut} - {manualIndispoConfig.heure_fin}</li>
                        </ul>
                      )}
                    </div>
                  </div>

                  <div className="modal-actions">
                    <Button variant="outline" onClick={() => setShowGenerationModal(false)}>
                      Annuler
                    </Button>
                    <Button 
                      variant="default" 
                      onClick={handleSaveManualIndisponibilites}
                      disabled={manualIndispoMode === 'calendrier' && manualIndispoConfig.dates.length === 0}
                    >
                      {manualIndispoMode === 'calendrier' 
                        ? `‚úÖ Enregistrer ${manualIndispoConfig.dates.length > 0 ? `(${manualIndispoConfig.dates.length} jour${manualIndispoConfig.dates.length > 1 ? 's' : ''})` : ''}`
                        : '‚úÖ G√©n√©rer les indisponibilit√©s'}
                    </Button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Modal de r√©initialisation */}
      {showReinitModal && (
        <div className="modal-overlay" onClick={() => setShowReinitModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>üóëÔ∏è R√©initialiser les disponibilit√©s</h3>
              <Button variant="ghost" onClick={() => setShowReinitModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="reinit-config">
                {/* S√©lection de la p√©riode */}
                <div className="config-section">
                  <h4>üìÖ P√©riode √† r√©initialiser</h4>
                  <select
                    value={reinitConfig.periode}
                    onChange={(e) => {
                      setReinitConfig({...reinitConfig, periode: e.target.value});
                      setReinitWarning(null); // R√©initialiser l'avertissement lors du changement
                    }}
                    className="form-select"
                  >
                    <option value="semaine">Semaine courante</option>
                    <option value="mois">Mois courant</option>
                    <option value="mois_prochain">Mois prochain</option>
                    <option value="annee">Ann√©e courante</option>
                    <option value="personnalisee">P√©riode personnalis√©e</option>
                  </select>
                  <small style={{ display: 'block', marginTop: '8px', color: '#666' }}>
                    {reinitConfig.periode === 'semaine' && 'Du lundi au dimanche de la semaine en cours'}
                    {reinitConfig.periode === 'mois' && 'Du 1er au dernier jour du mois en cours'}
                    {reinitConfig.periode === 'mois_prochain' && 'Du 1er au dernier jour du mois prochain'}
                    {reinitConfig.periode === 'annee' && 'Du 1er janvier au 31 d√©cembre de l\'ann√©e en cours'}
                    {reinitConfig.periode === 'personnalisee' && 'S√©lectionnez une plage de dates personnalis√©e (max 1 an)'}
                  </small>
                  
                  {/* Champs de dates pour p√©riode personnalis√©e */}
                  {reinitConfig.periode === 'personnalisee' && (
                    <div style={{ marginTop: '15px', padding: '15px', background: '#f8fafc', borderRadius: '8px' }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>
                        <div>
                          <Label>Date de d√©but</Label>
                          <Input
                            type="date"
                            value={reinitConfig.date_debut}
                            onChange={(e) => {
                              setReinitConfig({...reinitConfig, date_debut: e.target.value});
                              setReinitWarning(null);
                            }}
                          />
                        </div>
                        <div>
                          <Label>Date de fin</Label>
                          <Input
                            type="date"
                            value={reinitConfig.date_fin}
                            onChange={(e) => {
                              setReinitConfig({...reinitConfig, date_fin: e.target.value});
                              setReinitWarning(null);
                            }}
                          />
                        </div>
                      </div>
                      
                      {/* Avertissement pour dates bloqu√©es */}
                      {reinitWarning && (
                        <div style={{
                          marginTop: '15px',
                          padding: '12px',
                          background: '#fef3c7',
                          border: '2px solid #f59e0b',
                          borderRadius: '8px',
                          display: 'flex',
                          alignItems: 'flex-start',
                          gap: '10px'
                        }}>
                          <span style={{ fontSize: '1.5rem' }}>‚ö†Ô∏è</span>
                          <div style={{ flex: 1 }}>
                            <strong style={{ display: 'block', marginBottom: '5px', color: '#92400e' }}>
                              Attention - Dates bloqu√©es
                            </strong>
                            <p style={{ margin: 0, fontSize: '0.875rem', color: '#78350f' }}>
                              {reinitWarning}
                            </p>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* S√©lection du type d'entr√©es */}
                <div className="config-section">
                  <h4>üìä Type d'entr√©es √† supprimer</h4>
                  <select
                    value={reinitConfig.type_entree}
                    onChange={(e) => setReinitConfig({...reinitConfig, type_entree: e.target.value})}
                    className="form-select"
                  >
                    <option value="les_deux">Disponibilit√©s ET Indisponibilit√©s</option>
                    <option value="disponibilites">Disponibilit√©s uniquement</option>
                    <option value="indisponibilites">Indisponibilit√©s uniquement</option>
                  </select>
                  <small style={{ display: 'block', marginTop: '8px', color: '#666' }}>
                    {reinitConfig.type_entree === 'disponibilites' && '‚úÖ Supprime uniquement les jours disponibles'}
                    {reinitConfig.type_entree === 'indisponibilites' && '‚ùå Supprime uniquement les jours indisponibles'}
                    {reinitConfig.type_entree === 'les_deux' && 'üîÑ Supprime tous les types d\'entr√©es'}
                  </small>
                </div>

                {/* S√©lection du mode */}
                <div className="config-section">
                  <h4>üéØ Mode de suppression</h4>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    <label style={{ 
                      padding: '15px', 
                      border: reinitConfig.mode === 'generees_seulement' ? '2px solid #3b82f6' : '2px solid #e2e8f0',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      background: reinitConfig.mode === 'generees_seulement' ? '#eff6ff' : 'white'
                    }}>
                      <input
                        type="radio"
                        name="mode"
                        value="generees_seulement"
                        checked={reinitConfig.mode === 'generees_seulement'}
                        onChange={(e) => setReinitConfig({...reinitConfig, mode: e.target.value})}
                        style={{ marginRight: '10px' }}
                      />
                      <strong>Supprimer uniquement les entr√©es g√©n√©r√©es automatiquement</strong>
                      <div style={{ fontSize: '0.875rem', marginTop: '5px', marginLeft: '25px', color: '#64748b' }}>
                        ‚úÖ Pr√©serve vos modifications manuelles (origine: manuelle)
                      </div>
                    </label>

                    <label style={{ 
                      padding: '15px', 
                      border: reinitConfig.mode === 'tout' ? '2px solid #dc2626' : '2px solid #e2e8f0',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      background: reinitConfig.mode === 'tout' ? '#fef2f2' : 'white'
                    }}>
                      <input
                        type="radio"
                        name="mode"
                        value="tout"
                        checked={reinitConfig.mode === 'tout'}
                        onChange={(e) => setReinitConfig({...reinitConfig, mode: e.target.value})}
                        style={{ marginRight: '10px' }}
                      />
                      <strong>Supprimer TOUTES les entr√©es</strong>
                      <div style={{ fontSize: '0.875rem', marginTop: '5px', marginLeft: '25px', color: '#991b1b' }}>
                        ‚ö†Ô∏è Supprime tout (manuelles + g√©n√©r√©es automatiquement)
                      </div>
                    </label>
                  </div>
                </div>

                {/* R√©sum√© et confirmation */}
                <div className="config-section" style={{ 
                  background: reinitConfig.mode === 'tout' ? '#fef2f2' : '#eff6ff', 
                  padding: '15px', 
                  borderRadius: '8px', 
                  border: `1px solid ${reinitConfig.mode === 'tout' ? '#dc2626' : '#3b82f6'}` 
                }}>
                  <h4 style={{ color: reinitConfig.mode === 'tout' ? '#991b1b' : '#1e40af', marginTop: 0 }}>
                    ‚ö†Ô∏è Confirmation requise
                  </h4>
                  <p style={{ margin: '10px 0', color: reinitConfig.mode === 'tout' ? '#991b1b' : '#1e40af' }}>
                    Vous √™tes sur le point de <strong>
                      {reinitConfig.mode === 'tout' 
                        ? 'SUPPRIMER TOUTES LES' 
                        : 'supprimer les entr√©es g√©n√©r√©es de'}
                    </strong> {' '}
                    <strong>
                      {reinitConfig.type_entree === 'disponibilites' && 'DISPONIBILIT√âS'}
                      {reinitConfig.type_entree === 'indisponibilites' && 'INDISPONIBILIT√âS'}
                      {reinitConfig.type_entree === 'les_deux' && 'DISPONIBILIT√âS ET INDISPONIBILIT√âS'}
                    </strong> {' de '}
                    {reinitConfig.periode === 'semaine' && 'la semaine courante'}
                    {reinitConfig.periode === 'mois' && 'du mois courant'}
                    {reinitConfig.periode === 'annee' && 'de l\'ann√©e courante'}
                  </p>
                  <p style={{ margin: '10px 0', fontSize: '0.875rem', color: reinitConfig.mode === 'tout' ? '#991b1b' : '#1e40af' }}>
                    {reinitConfig.mode === 'tout' 
                      ? `üö® Cette action supprimera toutes les ${reinitConfig.type_entree === 'disponibilites' ? 'disponibilit√©s' : reinitConfig.type_entree === 'indisponibilites' ? 'indisponibilit√©s' : 'entr√©es'} (manuelles et automatiques).`
                      : '‚úÖ Vos modifications manuelles seront pr√©serv√©es.'}
                  </p>
                </div>
              </div>

              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowReinitModal(false)}>
                  Annuler
                </Button>
                <Button 
                  variant={reinitConfig.mode === 'tout' ? 'destructive' : 'default'}
                  onClick={handleReinitialiser}
                  disabled={isReinitializing}
                >
                  {isReinitializing ? 'Suppression...' : 'üóëÔ∏è Confirmer la suppression'}
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal Export Disponibilit√©s */}
      {showExportModal && (
        <div className="modal-overlay" onClick={() => setShowExportModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
            <div className="modal-header">
              <h3>üìä Export Disponibilit√©s {exportType === 'pdf' ? 'PDF' : 'Excel'}</h3>
              <Button variant="ghost" onClick={() => setShowExportModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body" style={{padding: '2rem'}}>
              <p style={{marginBottom: '1.5rem', color: '#64748b'}}>
                Que souhaitez-vous exporter ?
              </p>
              
              <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                <Button 
                  onClick={() => handleExportDisponibilites()}
                  style={{
                    padding: '1.5rem',
                    justifyContent: 'flex-start',
                    gap: '1rem',
                    fontSize: '1rem'
                  }}
                >
                  <span style={{fontSize: '1.5rem'}}>üìã</span>
                  <div style={{textAlign: 'left'}}>
                    <div style={{fontWeight: '600'}}>Toutes les disponibilit√©s</div>
                    <div style={{fontSize: '0.875rem', opacity: 0.8}}>
                      Exporter les disponibilit√©s de tous les pompiers temps partiel
                    </div>
                  </div>
                </Button>

                <Button 
                  variant="outline"
                  onClick={() => {
                    // Pour l'instant, exporter une personne sp√©cifique n√©cessiterait un select
                    // On peut am√©liorer cela plus tard
                    toast({ title: "Info", description: "S√©lectionnez un pompier depuis le module Personnel pour exporter ses disponibilit√©s" });
                  }}
                  style={{
                    padding: '1.5rem',
                    justifyContent: 'flex-start',
                    gap: '1rem',
                    fontSize: '1rem'
                  }}
                >
                  <span style={{fontSize: '1.5rem'}}>üë§</span>
                  <div style={{textAlign: 'left'}}>
                    <div style={{fontWeight: '600'}}>Une personne sp√©cifique</div>
                    <div style={{fontSize: '0.875rem', opacity: 0.8}}>
                      Disponible depuis le module Personnel
                    </div>
                  </div>
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Overlay de chargement lors de l'enregistrement */}
      {savingDisponibilites && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 9999,
          color: 'white'
        }}>
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '1.5rem',
            padding: '2rem',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            borderRadius: '16px',
            boxShadow: '0 10px 40px rgba(0, 0, 0, 0.3)',
            minWidth: '400px',
            maxWidth: '500px'
          }}>
            {/* Spinner anim√© */}
            <div style={{
              width: '60px',
              height: '60px',
              border: '4px solid rgba(255, 255, 255, 0.3)',
              borderTop: '4px solid white',
              borderRadius: '50%',
              animation: 'spin 1s linear infinite'
            }} />
            
            {/* Message */}
            <div style={{
              fontSize: '1.2rem',
              fontWeight: '600',
              textAlign: 'center'
            }}>
              {savingMessage}
            </div>
            
            <div style={{
              fontSize: '0.9rem',
              opacity: 0.9,
              textAlign: 'center'
            }}>
              Veuillez patienter...
            </div>
          </div>
          
          <style>
            {`
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            `}
          </style>
        </div>
      )}

      {/* Nouveau Modal de r√©solution de conflits multiples (batch) */}
      {showBatchConflictModal && (
        <div className="modal-overlay" onClick={() => setShowBatchConflictModal(false)}>
          <div className="modal-content large-modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px', maxHeight: '80vh', overflow: 'auto'}}>
            <div className="modal-header">
              <h3>‚ö†Ô∏è Conflits D√©tect√©s ({batchConflicts.length})</h3>
              <Button variant="ghost" onClick={() => setShowBatchConflictModal(false)}>‚úï</Button>
            </div>
            
            <div className="modal-body" style={{padding: '1.5rem'}}>
              <p style={{marginBottom: '1rem', color: '#64748b'}}>
                Les disponibilit√©s suivantes sont en conflit avec des entr√©es existantes. 
                S√©lectionnez les conflits que vous souhaitez remplacer :
              </p>
              
              <div style={{marginBottom: '1rem', display: 'flex', gap: '0.5rem'}}>
                <Button 
                  size="sm" 
                  variant="outline"
                  onClick={() => {
                    const allSelected = {};
                    batchConflicts.forEach((_, idx) => allSelected[idx] = true);
                    setBatchConflictSelections(allSelected);
                  }}
                >
                  ‚úÖ Tout s√©lectionner
                </Button>
                <Button 
                  size="sm" 
                  variant="outline"
                  onClick={() => setBatchConflictSelections({})}
                >
                  ‚ùå Tout d√©s√©lectionner
                </Button>
              </div>
              
              <div style={{
                border: '1px solid #e5e7eb',
                borderRadius: '8px',
                overflow: 'hidden'
              }}>
                {batchConflicts.map((conflict, index) => {
                  const isSelected = batchConflictSelections[index] || false;
                  return (
                    <div 
                      key={index}
                      style={{
                        padding: '1rem',
                        borderBottom: index < batchConflicts.length - 1 ? '1px solid #e5e7eb' : 'none',
                        background: isSelected ? '#fef3c7' : 'white',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                      onClick={() => {
                        setBatchConflictSelections(prev => ({
                          ...prev,
                          [index]: !prev[index]
                        }));
                      }}
                    >
                      <div style={{display: 'flex', alignItems: 'flex-start', gap: '1rem'}}>
                        <input 
                          type="checkbox" 
                          checked={isSelected}
                          onChange={(e) => {
                            e.stopPropagation();
                            setBatchConflictSelections(prev => ({
                              ...prev,
                              [index]: e.target.checked
                            }));
                          }}
                          style={{marginTop: '0.25rem', cursor: 'pointer'}}
                        />
                        <div style={{flex: 1}}>
                          <div style={{fontWeight: '600', marginBottom: '0.5rem'}}>
                            üìÖ {conflict.newItem.date}
                          </div>
                          <div style={{fontSize: '0.875rem', color: '#64748b'}}>
                            <div style={{marginBottom: '0.25rem'}}>
                              <strong>Existant:</strong> {conflict.existingType} {conflict.existingHours}
                              {conflict.existingOrigine && <span style={{marginLeft: '0.5rem', fontSize: '0.75rem', padding: '0.125rem 0.5rem', background: '#e5e7eb', borderRadius: '4px'}}>{conflict.existingOrigine}</span>}
                            </div>
                            <div>
                              <strong>Nouveau:</strong> {conflict.newType} {conflict.newItem.heure_debut}-{conflict.newItem.heure_fin}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              
              <div style={{marginTop: '1rem', padding: '1rem', background: '#f3f4f6', borderRadius: '8px', fontSize: '0.875rem'}}>
                <div style={{marginBottom: '0.5rem'}}>
                  <strong>R√©sum√©:</strong>
                </div>
                <div>
                  ‚Ä¢ {Object.values(batchConflictSelections).filter(Boolean).length} conflit(s) s√©lectionn√©(s) pour remplacement
                </div>
                <div>
                  ‚Ä¢ {batchConflicts.length - Object.values(batchConflictSelections).filter(Boolean).length} conflit(s) seront ignor√©s (existant conserv√©)
                </div>
              </div>
            </div>
            
            <div className="modal-actions">
              <Button variant="outline" onClick={() => setShowBatchConflictModal(false)}>
                Annuler
              </Button>
              <Button 
                variant="default"
                onClick={async () => {
                  await handleResolveBatchConflicts();
                }}
              >
                ‚úÖ Confirmer ({Object.values(batchConflictSelections).filter(Boolean).length} remplacements)
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Modal de r√©solution des conflits */}
      {showConflictModal && (
        <Suspense fallback={<LoadingComponent />}>
          <ConflictResolutionModal
            isOpen={showConflictModal}
            onClose={() => {
              setShowConflictModal(false);
              setConflictData({ conflicts: [], newItem: null, itemType: null });
            }}
            conflicts={conflictData.conflicts}
            newItem={conflictData.newItem}
            itemType="disponibilite"
            onResolve={handleResolveConflict}
          />
        </Suspense>
      )}
    </div>
  );
};

// Mon Profil Component √©pur√© - sans disponibilit√©s et remplacements
// Mon Profil Component √©pur√© - sans disponibilit√©s et remplacements
const MonProfil = () => {
  const { user, setUser, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const [userProfile, setUserProfile] = useState(null);
  const [formations, setFormations] = useState([]);
  const [competences, setCompetences] = useState([]);
  const [monthlyStats, setMonthlyStats] = useState({
    gardes_ce_mois: 0,
    heures_travaillees: 0,
    certifications: 0
  });
  const [loading, setLoading] = useState(true);
  const [isEditing, setIsEditing] = useState(false);
  const [isEditingEPI, setIsEditingEPI] = useState(false);
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [passwordData, setPasswordData] = useState({
    current_password: '',
    new_password: '',
    confirm_password: ''
  });
  const [profileData, setProfileData] = useState({});
  const [myEPIs, setMyEPIs] = useState([]);
  const [epiTailles, setEpiTailles] = useState({});
  const [photoUploading, setPhotoUploading] = useState(false);
  const photoInputRef = React.useRef(null);
  
  // √âtats pour le crop d'image
  const [showCropModal, setShowCropModal] = useState(false);
  const [imageToCrop, setImageToCrop] = useState(null);
  const [imageSize, setImageSize] = useState({ width: 0, height: 0 });
  const [cropPosition, setCropPosition] = useState({ x: 0, y: 0 });
  const [zoom, setZoom] = useState(1);
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const cropContainerRef = React.useRef(null);
  const cropImageRef = React.useRef(null);
  
  const { toast } = useToast();

  useEffect(() => {
    const fetchUserProfile = async () => {
      if (!tenantSlug || !user?.id) {
        return;
      }
      
      console.log('üîç Mon Profil - D√©but chargement:', {
        tenantSlug,
        userId: user.id,
        token: localStorage.getItem('token') ? 'Pr√©sent' : 'Absent'
      });
      
      try {
        const [userData, competencesData, statsData, episData] = await Promise.all([
          apiGet(tenantSlug, `/users/${user.id}`),
          apiGet(tenantSlug, '/competences'),
          apiGet(tenantSlug, `/users/${user.id}/stats-mensuelles`),
          apiGet(tenantSlug, `/epi/employe/${user.id}`)
        ]);
        
        console.log('üìä Mon Profil - userData charg√©:', userData);
        console.log('üîç Champs critiques:', {
          numero_employe: userData?.numero_employe,
          taux_horaire: userData?.taux_horaire,
          grade: userData?.grade,
          date_embauche: userData?.date_embauche,
          adresse: userData?.adresse
        });
        
        setUserProfile(userData);
        setCompetences(competencesData || []);
        setMonthlyStats(statsData);
        setMyEPIs(episData);
        
        // Cr√©er un objet de tailles pour l'√©dition
        const tailles = {};
        episData.forEach(epi => {
          tailles[epi.type_epi] = epi.taille;
        });
        setEpiTailles(tailles);
        
        setProfileData({
          nom: userData.nom,
          prenom: userData.prenom,
          email: userData.email,
          telephone: userData.telephone,
          adresse: userData.adresse || '',
          contact_urgence: userData.contact_urgence || '',
          numero_employe: userData.numero_employe || '',
          taux_horaire: userData.taux_horaire || 0,
          heures_max_semaine: userData.heures_max_semaine || 25
        });

      } catch (error) {
        console.error('‚ùå Mon Profil - Erreur chargement:', {
          error: error.message,
          stack: error.stack,
          tenantSlug,
          userId: user?.id
        });
      } finally {
        setLoading(false);
      }
    };

    if (user?.id) {
      fetchUserProfile();
    }
  }, [user?.id, tenantSlug]);

  // Gestion de l'upload de photo de profil - Ouvre le modal de crop
  const handlePhotoSelect = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // V√©rifier le type de fichier
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      toast({
        title: "Format non support√©",
        description: "Veuillez choisir une image JPG, PNG ou WEBP",
        variant: "destructive"
      });
      event.target.value = '';
      return;
    }

    // Lire l'image et ouvrir le modal de crop
    const reader = new FileReader();
    reader.onload = (e) => {
      // Charger l'image pour obtenir ses dimensions
      const img = new Image();
      img.onload = () => {
        setImageSize({ width: img.width, height: img.height });
        setImageToCrop(e.target.result);
        setShowCropModal(true);
        setCropPosition({ x: 0, y: 0 });
        setZoom(1);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    event.target.value = '';
  };

  // Gestion du drag pour d√©placer l'image
  const handleCropMouseDown = (e) => {
    e.preventDefault();
    setIsDragging(true);
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    setDragStart({ x: clientX - cropPosition.x, y: clientY - cropPosition.y });
  };

  const handleCropMouseMove = (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    const container = cropContainerRef.current;
    if (!container) return;
    
    const containerSize = container.offsetWidth;
    const scaledWidth = imageSize.width * zoom;
    const scaledHeight = imageSize.height * zoom;
    
    // Calculer les limites de d√©placement
    const minX = containerSize - scaledWidth;
    const minY = containerSize - scaledHeight;
    
    let newX = clientX - dragStart.x;
    let newY = clientY - dragStart.y;
    
    // Contraindre le d√©placement pour que l'image couvre toujours le cercle
    newX = Math.min(0, Math.max(minX, newX));
    newY = Math.min(0, Math.max(minY, newY));
    
    setCropPosition({ x: newX, y: newY });
  };

  const handleCropMouseUp = () => {
    setIsDragging(false);
  };

  // Fonction pour recadrer et uploader l'image
  const handleCropComplete = async () => {
    if (!imageToCrop) return;
    
    setPhotoUploading(true);
    
    try {
      const img = new Image();
      img.src = imageToCrop;
      
      await new Promise((resolve) => {
        if (img.complete) resolve();
        else img.onload = resolve;
      });
      
      const canvas = document.createElement('canvas');
      const outputSize = 400; // Taille de sortie
      canvas.width = outputSize;
      canvas.height = outputSize;
      const ctx = canvas.getContext('2d');
      
      // Calculer la zone de crop bas√©e sur la position et le zoom
      const container = cropContainerRef.current;
      const containerSize = container ? container.offsetWidth : 300;
      
      // Ratio entre la taille affich√©e et la taille r√©elle
      const displayRatio = containerSize / (Math.min(imageSize.width, imageSize.height) * zoom);
      
      // Position du crop dans l'image originale
      const sourceX = -cropPosition.x / displayRatio / zoom;
      const sourceY = -cropPosition.y / displayRatio / zoom;
      const sourceSize = containerSize / displayRatio / zoom;
      
      // Dessiner l'image cropp√©e
      ctx.drawImage(
        img,
        sourceX, sourceY, sourceSize, sourceSize,
        0, 0, outputSize, outputSize
      );
      
      // Convertir en base64 JPEG
      const base64 = canvas.toDataURL('image/jpeg', 0.9);
      
      const response = await apiPost(tenantSlug, '/users/photo-profil', {
        photo_base64: base64
      });
      
      // Mettre √† jour le profil local
      setUserProfile(prev => ({...prev, photo_profil: response.photo_profil}));
      
      // Mettre √† jour le user global (pour la sidebar)
      setUser(prev => ({...prev, photo_profil: response.photo_profil}));
      
      setShowCropModal(false);
      setImageToCrop(null);
      
      toast({
        title: "Photo mise √† jour",
        description: "Votre photo de profil a √©t√© enregistr√©e",
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.message || "Impossible de sauvegarder la photo",
        variant: "destructive"
      });
    } finally {
      setPhotoUploading(false);
    }
  };

  // Ancienne fonction de compression (gard√©e pour compatibilit√© mais pas utilis√©e)
  const handlePhotoSelectOld = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // V√©rifier le type de fichier
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      toast({
        title: "Format non support√©",
        description: "Veuillez choisir une image JPG, PNG ou WEBP",
        variant: "destructive"
      });
      return;
    }

    setPhotoUploading(true);

    try {
      // Fonction pour compresser l'image c√¥t√© client
      const compressImage = (file, maxWidth = 400, quality = 0.8) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              // Redimensionner si n√©cessaire
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              canvas.width = width;
              canvas.height = height;
              
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              // Convertir en JPEG compress√©
              const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
              resolve(compressedBase64);
            };
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      // Compresser si > 500KB, sinon utiliser directement
      let base64;
      if (file.size > 500 * 1024) {
        toast({
          title: "Compression en cours...",
          description: "L'image est optimis√©e automatiquement",
        });
        base64 = await compressImage(file, 400, 0.85);
      } else {
        base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
      
      const response = await apiPost(tenantSlug, '/users/photo-profil', {
        photo_base64: base64
      });
      
      // Mettre √† jour le profil local
      setUserProfile(prev => ({...prev, photo_profil: response.photo_profil}));
      
      // Mettre √† jour le user global (pour la sidebar)
      setUser(prev => ({...prev, photo_profil: response.photo_profil}));
      
      toast({
        title: "Photo mise √† jour",
        description: "Votre photo de profil a √©t√© enregistr√©e",
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: error.message || "Impossible de sauvegarder la photo",
        variant: "destructive"
      });
    } finally {
      setPhotoUploading(false);
    }
    
    // Reset l'input pour permettre de re-s√©lectionner le m√™me fichier
    event.target.value = '';
  };

  const handleDeletePhoto = async () => {
    if (!window.confirm('√ätes-vous s√ªr de vouloir supprimer votre photo de profil ?')) {
      return;
    }

    try {
      await apiDelete(tenantSlug, '/users/photo-profil');
      setUserProfile(prev => ({...prev, photo_profil: null}));
      // Mettre √† jour le user global (pour la sidebar)
      setUser(prev => ({...prev, photo_profil: null}));
      toast({
        title: "Photo supprim√©e",
        description: "Votre photo de profil a √©t√© supprim√©e",
      });
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer la photo",
        variant: "destructive"
      });
    }
  };

  const handleSaveProfile = async () => {
    try {
      // Valider heures_max_semaine avant sauvegarde
      let heuresMax = profileData.heures_max_semaine;
      if (heuresMax === '' || heuresMax === null || heuresMax === undefined) {
        heuresMax = 25;
      } else {
        heuresMax = parseInt(heuresMax);
        if (heuresMax < 5) heuresMax = 5;
        if (heuresMax > 168) heuresMax = 168;
      }

      // Utiliser l'endpoint sp√©cial pour modification de son propre profil
      const updateData = {
        prenom: profileData.prenom,
        nom: profileData.nom,
        email: profileData.email,
        telephone: profileData.telephone,
        adresse: profileData.adresse,
        contact_urgence: profileData.contact_urgence,
        heures_max_semaine: heuresMax
      };

      const updatedData = await apiPut(tenantSlug, '/users/mon-profil', updateData);
      
      // Mettre √† jour le profil local avec la r√©ponse
      setUserProfile(updatedData);
      
      // Mettre √† jour aussi profileData pour que les champs affichent les bonnes valeurs
      setProfileData({
        nom: updatedData.nom,
        prenom: updatedData.prenom,
        email: updatedData.email,
        telephone: updatedData.telephone,
        adresse: updatedData.adresse || '',
        contact_urgence: updatedData.contact_urgence || '',
        heures_max_semaine: updatedData.heures_max_semaine || 25
      });
      
      toast({
        title: "Profil mis √† jour",
        description: "Vos informations ont √©t√© sauvegard√©es et sont maintenant visibles dans Personnel.",
        variant: "success"
      });
      setIsEditing(false);
    } catch (error) {
      console.error('Erreur sauvegarde profil:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible de sauvegarder les modifications.",
        variant: "destructive"
      });
    }
  };

  const handleSaveEPITailles = async () => {
    try {
      console.log('üíæ [Mon Profil] D√©but sauvegarde tailles EPI');
      console.log('üìã [Mon Profil] Tailles actuelles:', epiTailles);
      console.log('üì¶ [Mon Profil] EPIs existants:', myEPIs);
      
      const allEPITypes = getAllEPITypes();
      const updatePromises = [];
      const createPromises = [];
      
      // Pour chaque type d'EPI
      for (const epiType of allEPITypes) {
        const taille = epiTailles[epiType.id];
        const existingEPI = myEPIs.find(e => e.type_epi === epiType.id);
        
        console.log(`üîç [${epiType.nom}] Taille: ${taille}, EPI existant:`, existingEPI ? `Oui (${existingEPI.taille})` : 'Non');
        
        // Si une taille est saisie
        if (taille && taille.trim() !== '') {
          if (existingEPI) {
            // Mettre √† jour l'EPI existant si la taille a chang√©
            if (taille !== existingEPI.taille) {
              console.log(`‚úèÔ∏è [${epiType.nom}] Mise √† jour: ${existingEPI.taille} ‚Üí ${taille}`);
              updatePromises.push(
                apiPut(tenantSlug, `/epi/${existingEPI.id}`, {
                  taille: taille
                }).catch(err => {
                  console.error(`‚ùå Erreur PUT /epi/${existingEPI.id}:`, err);
                  throw err;
                })
              );
            } else {
              console.log(`‚è≠Ô∏è [${epiType.nom}] Aucun changement, skip`);
            }
          } else {
            // Cr√©er un nouvel EPI
            console.log(`‚ûï [${epiType.nom}] Cr√©ation nouvel EPI avec taille: ${taille}`);
            createPromises.push(
              apiPost(tenantSlug, '/epi', {
                user_id: user.id,
                type_epi: epiType.id,
                taille: taille,
                numero_serie: `${epiType.id.toUpperCase()}-${user.id.substring(0, 8)}`,
                marque: 'N/A',
                modele: 'N/A',
                date_mise_en_service: new Date().toISOString().split('T')[0],
                statut: 'En service',
                notes: 'Taille d√©clar√©e par l\'employ√©'
              }).catch(err => {
                console.error(`‚ùå Erreur POST /epi:`, err);
                throw err;
              })
            );
          }
        }
      }

      console.log(`üìä [Mon Profil] ${updatePromises.length} mise(s) √† jour, ${createPromises.length} cr√©ation(s)`);
      
      // Ex√©cuter toutes les mises √† jour et cr√©ations
      await Promise.all([...updatePromises, ...createPromises]);

      // Recharger les EPI
      const episData = await apiGet(tenantSlug, `/epi/employe/${user.id}`);
      setMyEPIs(episData);
      
      // Mettre √† jour l'objet de tailles
      const tailles = {};
      episData.forEach(epi => {
        tailles[epi.type_epi] = epi.taille;
      });
      setEpiTailles(tailles);

      toast({
        title: "Tailles mises √† jour",
        description: "Vos tailles d'EPI ont √©t√© sauvegard√©es et sont maintenant visibles dans le module Personnel",
        variant: "success"
      });

      setIsEditingEPI(false);
    } catch (error) {
      console.error('Erreur sauvegarde EPI:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Impossible de sauvegarder les tailles",
        variant: "destructive"
      });
    }
  };

  const getEPINom = (typeEpi) => {
    const noms = {
      'casque': 'Casque',
      'bottes': 'Bottes',
      'veste_bunker': 'Veste Bunker',
      'pantalon_bunker': 'Pantalon Bunker',
      'gants': 'Gants',
      'masque_apria': 'Facial APRIA',
      'cagoule': 'Cagoule Anti-Particules'
    };
    return noms[typeEpi] || typeEpi;
  };

  const getAllEPITypes = () => {
    return [
      { id: 'casque', nom: 'Casque', icone: 'ü™ñ' },
      { id: 'bottes', nom: 'Bottes', icone: 'üë¢' },
      { id: 'veste_bunker', nom: 'Veste Bunker', icone: 'üß•' },
      { id: 'pantalon_bunker', nom: 'Pantalon Bunker', icone: 'üëñ' },
      { id: 'gants', nom: 'Gants', icone: 'üß§' },
      { id: 'masque_apria', nom: 'Facial APRIA', icone: 'üò∑' },
      { id: 'cagoule', nom: 'Cagoule Anti-Particules', icone: 'üé≠' }
    ];
  };
  const getEPIIcone = (typeEpi) => {
    const icones = {
      'casque': 'ü™ñ',
      'bottes': 'üë¢',
      'veste_bunker': 'üß•',
      'pantalon_bunker': 'üëñ',
      'gants': 'üß§',
      'masque_apria': 'üò∑',
      'cagoule': 'üé≠'
    };
    return icones[typeEpi] || 'üõ°Ô∏è';
  };

  const handleChangePassword = async () => {
    if (!passwordData.current_password || !passwordData.new_password || !passwordData.confirm_password) {
      toast({
        title: "Champs requis",
        description: "Veuillez remplir tous les champs",
        variant: "destructive"
      });
      return;
    }

    if (passwordData.new_password !== passwordData.confirm_password) {
      toast({
        title: "Mots de passe diff√©rents",
        description: "Le nouveau mot de passe et la confirmation ne correspondent pas",
        variant: "destructive"
      });
      return;
    }

    try {
      // Appeler l'API backend pour changer le mot de passe
      await axios.put(`${API}/${tenantSlug}/users/${user.id}/password`, {
        current_password: passwordData.current_password,
        new_password: passwordData.new_password
      });
      
      toast({
        title: "Mot de passe modifi√©",
        description: "Votre mot de passe a √©t√© mis √† jour avec succ√®s",
        variant: "success"
      });
      setShowPasswordModal(false);
      setPasswordData({ current_password: '', new_password: '', confirm_password: '' });
    } catch (error) {
      const errorMessage = error.response?.data?.detail || "Impossible de modifier le mot de passe";
      toast({
        title: "Erreur",
        description: errorMessage,
        variant: "destructive"
      });
    }
  };

  const getFormationName = (formationId) => {
    const formation = formations.find(f => f.id === formationId);
    return formation ? formation.nom : formationId;
  };

  const getCompetenceName = (competenceId) => {
    const competence = competences.find(c => c.id === competenceId);
    if (competence) return competence.nom;
    // Fallback pour comp√©tences obsol√®tes/supprim√©es
    return "‚ö†Ô∏è Comp√©tence obsol√®te";
  };

  if (loading) return <div className="loading" data-testid="profile-loading">Chargement du profil...</div>;
  
  // Debug : V√©rifier si user est charg√©
  if (!user || !user.id) {
    return (
      <div className="mon-profil">
        <div className="profile-header">
          <h1>Erreur</h1>
          <p style={{color: 'red'}}>
            ‚ùå Impossible de charger le profil utilisateur. user.id manquant.
            <br/>
            Debug: user = {JSON.stringify(user)}
            <br/>
            tenantSlug = {tenantSlug}
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="module-epi-nfpa">
      <div className="module-header">
        <div>
          <h1>üë§ Mon Profil</h1>
          <p>G√©rez vos informations personnelles et param√®tres de compte</p>
        </div>
      </div>

      {/* Layout en 2 colonnes */}
      <div className="profil-grid-layout">
        {/* Colonne gauche - Informations principales */}
        <div className="profil-main-column">
          
          {/* Section Photo de Profil */}
          <div className="formation-card" style={{ marginBottom: '1.5rem' }}>
            <div className="formation-header">
              <h3>üì∑ Photo de profil</h3>
            </div>
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: '1.5rem',
              padding: '1rem',
              flexWrap: 'wrap'
            }}>
              {/* Photo preview */}
              <div style={{
                width: '120px',
                height: '120px',
                borderRadius: '50%',
                overflow: 'hidden',
                background: '#f3f4f6',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                border: '3px solid #e5e7eb',
                flexShrink: 0
              }}>
                {userProfile?.photo_profil ? (
                  <img 
                    src={userProfile.photo_profil} 
                    alt="Photo de profil"
                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                  />
                ) : (
                  <div style={{ 
                    fontSize: '3rem', 
                    color: '#9ca3af',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    üë§
                  </div>
                )}
              </div>
              
              {/* Boutons */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                <input
                  type="file"
                  ref={photoInputRef}
                  onChange={handlePhotoSelect}
                  accept="image/jpeg,image/png,image/webp"
                  style={{ display: 'none' }}
                />
                <Button
                  onClick={() => photoInputRef.current?.click()}
                  disabled={photoUploading}
                  style={{ minWidth: '160px' }}
                >
                  {photoUploading ? '‚è≥ Upload...' : 'üì§ Changer la photo'}
                </Button>
                {userProfile?.photo_profil && (
                  <Button
                    variant="outline"
                    onClick={handleDeletePhoto}
                    style={{ minWidth: '160px', color: '#ef4444' }}
                  >
                    üóëÔ∏è Supprimer
                  </Button>
                )}
                <p style={{ 
                  fontSize: '0.75rem', 
                  color: '#6b7280',
                  margin: '0.5rem 0 0 0'
                }}>
                  JPG, PNG ou WEBP ‚Ä¢ Recadrage disponible
                </p>
              </div>
            </div>
          </div>

          {/* Modal de recadrage d'image avec drag-and-drop */}
          {showCropModal && imageToCrop && (
            <div 
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.85)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 9999,
                padding: '20px'
              }}
              onMouseUp={handleCropMouseUp}
              onMouseLeave={handleCropMouseUp}
              onTouchEnd={handleCropMouseUp}
            >
              <div 
                style={{
                  background: 'white',
                  borderRadius: '16px',
                  padding: '24px',
                  width: '100%',
                  maxWidth: '450px',
                  maxHeight: '90vh',
                  overflow: 'auto'
                }}
              >
                <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: '#1f2937' }}>
                  ‚úÇÔ∏è Recadrer votre photo
                </h3>
                <p style={{ fontSize: '13px', color: '#6b7280', marginBottom: '16px' }}>
                  Glissez l&apos;image pour la positionner dans le cercle
                </p>
                
                {/* Zone de crop avec drag */}
                <div 
                  ref={cropContainerRef}
                  style={{ 
                    position: 'relative',
                    width: '100%',
                    aspectRatio: '1',
                    background: '#1f2937',
                    borderRadius: '12px',
                    overflow: 'hidden',
                    marginBottom: '16px',
                    cursor: isDragging ? 'grabbing' : 'grab',
                    touchAction: 'none'
                  }}
                  onMouseDown={handleCropMouseDown}
                  onMouseMove={handleCropMouseMove}
                  onTouchStart={handleCropMouseDown}
                  onTouchMove={handleCropMouseMove}
                >
                  <img
                    ref={cropImageRef}
                    src={imageToCrop}
                    alt="√Ä recadrer"
                    draggable={false}
                    style={{
                      position: 'absolute',
                      width: imageSize.width > imageSize.height 
                        ? `${(imageSize.width / imageSize.height) * 100 * zoom}%` 
                        : `${100 * zoom}%`,
                      height: imageSize.height > imageSize.width 
                        ? `${(imageSize.height / imageSize.width) * 100 * zoom}%` 
                        : `${100 * zoom}%`,
                      minWidth: `${100 * zoom}%`,
                      minHeight: `${100 * zoom}%`,
                      objectFit: 'cover',
                      left: cropPosition.x,
                      top: cropPosition.y,
                      pointerEvents: 'none',
                      userSelect: 'none'
                    }}
                  />
                  {/* Overlay avec cercle transparent au centre */}
                  <svg 
                    style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none' }}
                    viewBox="0 0 100 100"
                    preserveAspectRatio="none"
                  >
                    <defs>
                      <mask id="cropMask">
                        <rect x="0" y="0" width="100" height="100" fill="white"/>
                        <circle cx="50" cy="50" r="48" fill="black"/>
                      </mask>
                    </defs>
                    <rect x="0" y="0" width="100" height="100" fill="rgba(0,0,0,0.6)" mask="url(#cropMask)"/>
                    <circle cx="50" cy="50" r="48" fill="none" stroke="white" strokeWidth="0.5" strokeDasharray="2,2"/>
                  </svg>
                </div>
                
                {/* Contr√¥le de zoom */}
                <div style={{ marginBottom: '20px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '20px' }}>üîç</span>
                    <input
                      type="range"
                      min="1"
                      max="3"
                      step="0.05"
                      value={zoom}
                      onChange={(e) => {
                        const newZoom = parseFloat(e.target.value);
                        setZoom(newZoom);
                        // Recentrer apr√®s zoom
                        setCropPosition({ x: 0, y: 0 });
                      }}
                      style={{ flex: 1, height: '8px' }}
                    />
                    <span style={{ fontSize: '14px', color: '#6b7280', minWidth: '50px' }}>
                      {Math.round(zoom * 100)}%
                    </span>
                  </div>
                </div>
                
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                  <Button
                    variant="outline"
                    onClick={() => {
                      setShowCropModal(false);
                      setImageToCrop(null);
                    }}
                  >
                    Annuler
                  </Button>
                  <Button
                    onClick={handleCropComplete}
                    disabled={photoUploading}
                    style={{ background: '#10B981', color: 'white' }}
                  >
                    {photoUploading ? '‚è≥ Enregistrement...' : '‚úÖ Valider'}
                  </Button>
                </div>
              </div>
            </div>
          )}

          {/* Informations personnelles */}
          <div className="formation-card">
            <div className="formation-header">
              <h3>üìã Informations personnelles</h3>
              <Button
                onClick={() => setIsEditing(!isEditing)}
                variant={isEditing ? "outline" : "default"}
                data-testid="edit-profile-btn"
              >
                {isEditing ? 'Annuler' : '‚úèÔ∏è Modifier'}
              </Button>
            </div>

            <div className="profile-form">
              <div className="form-row">
                <div className="form-field">
                  <Label>Pr√©nom</Label>
                  <Input
                    value={profileData.prenom || ''}
                    onChange={(e) => setProfileData({...profileData, prenom: e.target.value})}
                    disabled={!isEditing}
                    data-testid="profile-prenom-input"
                  />
                </div>
                <div className="form-field">
                  <Label>Nom</Label>
                  <Input
                    value={profileData.nom || ''}
                    onChange={(e) => setProfileData({...profileData, nom: e.target.value})}
                    disabled={!isEditing}
                    data-testid="profile-nom-input"
                  />
                </div>
              </div>

              <div className="form-row">
                <div className="form-field">
                  <Label>Email</Label>
                  <Input
                    value={profileData.email || ''}
                    onChange={(e) => setProfileData({...profileData, email: e.target.value})}
                    disabled={!isEditing}
                    data-testid="profile-email-input"
                  />
                </div>
                <div className="form-field">
                  <Label>T√©l√©phone</Label>
                  <Input
                    value={profileData.telephone || ''}
                    onChange={(e) => setProfileData({...profileData, telephone: e.target.value})}
                    disabled={!isEditing}
                    data-testid="profile-phone-input"
                  />
                </div>
              </div>

              <div className="form-field">
                <Label>Adresse</Label>
                <Input
                  value={profileData.adresse || ''}
                  onChange={(e) => setProfileData({...profileData, adresse: e.target.value})}
                  disabled={!isEditing}
                  placeholder="123 Rue Principale, Ville, Province"
                  data-testid="profile-address-input"
                />
              </div>

              <div className="form-field">
                <Label>Contact d'urgence</Label>
                <Input
                  value={profileData.contact_urgence || ''}
                  onChange={(e) => setProfileData({...profileData, contact_urgence: e.target.value})}
                  disabled={!isEditing}
                  placeholder="Nom et t√©l√©phone du contact d'urgence"
                  data-testid="profile-emergency-input"
                />
              </div>

              {/* Heures maximum par semaine - Visible pour tous, modifiable pour temps partiel uniquement */}
              <div className="form-field">
                <Label>Heures maximum par semaine</Label>
                <div className="heures-max-input">
                  <Input
                    type="number"
                    min="5"
                    max="168"
                    value={profileData.heures_max_semaine !== null && profileData.heures_max_semaine !== undefined 
                      ? profileData.heures_max_semaine 
                      : (userProfile?.heures_max_semaine || 40)}
                    onChange={(e) => {
                      const value = e.target.value;
                      // Permettre champ vide ou nombre valide
                      if (value === '') {
                        setProfileData({...profileData, heures_max_semaine: ''});
                      } else {
                        const numValue = parseInt(value);
                        // Accepter toute valeur pendant la saisie pour permettre l'effacement
                        setProfileData({...profileData, heures_max_semaine: numValue});
                      }
                    }}
                    onBlur={(e) => {
                      // Valider √† la sortie du champ
                      const value = e.target.value;
                      if (value === '' || value < 5) {
                        setProfileData({...profileData, heures_max_semaine: 5});
                      } else if (value > 168) {
                        setProfileData({...profileData, heures_max_semaine: 168});
                      }
                    }}
                    disabled={!isEditing || userProfile?.type_emploi === 'temps_plein'}
                    data-testid="profile-heures-max-input"
                  />
                  <span className="heures-max-unit">heures/semaine</span>
                </div>
                <small className="heures-max-help">
                  {userProfile?.type_emploi === 'temps_partiel' 
                    ? "Indiquez le nombre maximum d'heures que vous souhaitez travailler par semaine (5-168h)."
                    : "Limite d'heures hebdomadaires configur√©e par l'administrateur."}
                </small>
              </div>

              {isEditing && (
                <div className="form-actions">
                  <Button onClick={handleSaveProfile} data-testid="save-profile-btn">
                    üíæ Sauvegarder les modifications
                  </Button>
                </div>
              )}
            </div>
          </div>

          {/* Mes Tailles EPI */}
          <div className="formation-card">
            <div className="formation-header">
              <h3>üõ°Ô∏è Mes Tailles EPI</h3>
              <Button
                onClick={() => {
                  console.log('üîò [Mon Profil EPI] Bouton Modifier cliqu√©, isEditingEPI avant:', isEditingEPI);
                  setIsEditingEPI(!isEditingEPI);
                  console.log('üîò [Mon Profil EPI] isEditingEPI apr√®s:', !isEditingEPI);
                }}
                variant={isEditingEPI ? "outline" : "default"}
                data-testid="edit-epi-tailles-btn"
              >
                {isEditingEPI ? 'Annuler' : '‚úèÔ∏è Modifier'}
              </Button>
            </div>

            <div className="epi-content-wrapper">
              <p style={{ marginBottom: '15px', fontSize: '14px', color: '#6B7280' }}>
                {isEditingEPI 
                  ? '‚úèÔ∏è Mode √©dition activ√© - Vous pouvez maintenant modifier les tailles' 
                  : 'üëâ Cliquez sur "Modifier" pour √©diter vos tailles d\'EPI'}
              </p>

              <div className="epi-tailles-grid-profile">
                {getAllEPITypes().map(epiType => {
                  const existingEPI = myEPIs.find(e => e.type_epi === epiType.id);
                  const isDisabled = !isEditingEPI;
                  // Utiliser ?? au lieu de || pour permettre les cha√Ænes vides
                  const currentValue = epiTailles[epiType.id] ?? (existingEPI ? existingEPI.taille : '');
                  
                  console.log(`[${epiType.nom}] disabled=${isDisabled}, value="${currentValue}", epiTailles[${epiType.id}]="${epiTailles[epiType.id]}"`);
                  
                  return (
                    <div key={epiType.id} className="epi-taille-item-profile">
                      <span className="epi-taille-icon-profile">{epiType.icone}</span>
                      <div className="epi-taille-info-profile">
                        <Label style={{fontSize: '13px'}}>{epiType.nom}</Label>
                        <Input
                          value={currentValue}
                          onChange={(e) => {
                            const newValue = e.target.value;
                            console.log(`‚úèÔ∏è [${epiType.nom}] onChange: "${currentValue}" ‚Üí "${newValue}"`);
                            setEpiTailles({...epiTailles, [epiType.id]: newValue});
                          }}
                          disabled={isDisabled}
                          placeholder="Taille"
                          className="epi-taille-input-compact"
                          data-testid={`epi-taille-${epiType.id}`}
                          style={isDisabled ? {cursor: 'not-allowed', opacity: 0.6} : {}}
                        />
                      </div>
                    </div>
                  );
                })}
              </div>

              {isEditingEPI && (
                <div className="form-actions" style={{marginTop: '15px'}}>
                  <Button onClick={handleSaveEPITailles} data-testid="save-epi-tailles-btn">
                    üíæ Sauvegarder les tailles
                  </Button>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Colonne droite - Infos compl√©mentaires */}
        <div className="profil-side-column">
          {/* Informations d'emploi */}
          <div className="formation-card">
            <div className="formation-header">
              <h3>üíº Emploi</h3>
              <span className="statut-badge planifiee" style={{fontSize: '12px', background: '#FEE2E2', color: '#991B1B'}}>
                üîí Verrouill√©
              </span>
            </div>
            <div style={{padding: '1rem 1.5rem'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '0.75rem 0', borderBottom: '1px solid #F3F4F6', gap: '1rem'}}>
                <span style={{fontSize: '0.813rem', fontWeight: '500', color: '#6B7280'}}>N¬∞ Employ√©</span>
                <span style={{fontSize: '0.875rem', fontWeight: '600', color: '#1F2937', textAlign: 'right'}} data-testid="profile-employee-id">{userProfile?.numero_employe}</span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '0.75rem 0', borderBottom: '1px solid #F3F4F6', gap: '1rem'}}>
                <span style={{fontSize: '0.813rem', fontWeight: '500', color: '#6B7280'}}>Grade</span>
                <span style={{fontSize: '0.875rem', fontWeight: '600', color: '#1F2937', textAlign: 'right'}} data-testid="profile-grade">
                  {userProfile?.grade}
                  {userProfile?.fonction_superieur && <span style={{fontSize: '0.75rem', color: '#EF4444', marginLeft: '0.5rem'}}> + Fonction sup.</span>}
                </span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '0.75rem 0', borderBottom: '1px solid #F3F4F6', gap: '1rem'}}>
                <span style={{fontSize: '0.813rem', fontWeight: '500', color: '#6B7280'}}>Type</span>
                <span style={{fontSize: '0.875rem', fontWeight: '600', color: '#1F2937', textAlign: 'right'}} data-testid="profile-employment-type">
                  {userProfile?.type_emploi === 'temps_plein' ? 'Temps plein' : 'Temps partiel'}
                </span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '0.75rem 0', borderBottom: '1px solid #F3F4F6', gap: '1rem'}}>
                <span style={{fontSize: '0.813rem', fontWeight: '500', color: '#6B7280'}}>Embauche</span>
                <span style={{fontSize: '0.875rem', fontWeight: '600', color: '#1F2937', textAlign: 'right'}} data-testid="profile-hire-date">{userProfile?.date_embauche}</span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '0.75rem 0', gap: '1rem'}}>
                <span style={{fontSize: '0.813rem', fontWeight: '500', color: '#6B7280'}}>Taux horaire</span>
                <span style={{fontSize: '0.875rem', fontWeight: '600', color: '#1F2937', textAlign: 'right'}} data-testid="profile-taux-horaire">
                  {userProfile?.taux_horaire ? `${userProfile.taux_horaire.toFixed(2)} $/h` : 'Non d√©fini'}
                </span>
              </div>
            </div>
          </div>

          {/* Formations et comp√©tences */}
          <div className="formation-card">
            <div className="formation-header">
              <h3>üìö Comp√©tences</h3>
              <span className="statut-badge planifiee" style={{fontSize: '11px', background: '#FEE2E2', color: '#991B1B'}}>
                {userProfile?.competences?.length || 0}
              </span>
            </div>
            <div style={{padding: '0.75rem 1.5rem'}}>
              {userProfile?.competences?.length > 0 ? (
                <div style={{display: 'flex', flexWrap: 'wrap', gap: '0.5rem'}}>
                  {userProfile.competences.map((competenceId, index) => (
                    <span key={index} className="formation-badge-compact">
                      {getCompetenceName(competenceId)} ‚úÖ
                    </span>
                  ))}
                </div>
              ) : (
                <p style={{textAlign: 'center', color: '#9CA3AF', fontSize: '14px', margin: 0}}>
                  Aucune comp√©tence
                </p>
              )}
            </div>
          </div>

          {/* S√©curit√© du compte */}
          <div className="formation-card">
            <div className="formation-header">
              <h3>üîí S√©curit√©</h3>
            </div>
            <div style={{padding: '1rem'}}>
              <Button 
                variant="outline" 
                onClick={() => setShowPasswordModal(true)}
                data-testid="change-password-btn"
                style={{width: '100%'}}
              >
                üîë Changer le mot de passe
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Modal de changement de mot de passe */}
      {showPasswordModal && (
        <div className="modal-overlay" onClick={() => setShowPasswordModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} data-testid="change-password-modal">
            <div className="modal-header">
              <h3>üîí Changer le mot de passe</h3>
              <Button variant="ghost" onClick={() => setShowPasswordModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="password-form">
                <div className="form-field">
                  <Label>Mot de passe actuel *</Label>
                  <Input
                    type="password"
                    value={passwordData.current_password}
                    onChange={(e) => setPasswordData({...passwordData, current_password: e.target.value})}
                    data-testid="current-password-input"
                  />
                </div>

                <div className="form-field">
                  <Label>Nouveau mot de passe *</Label>
                  <Input
                    type="password"
                    value={passwordData.new_password}
                    onChange={(e) => setPasswordData({...passwordData, new_password: e.target.value})}
                    data-testid="new-password-input"
                  />
                </div>

                <div className="form-field">
                  <Label>Confirmer le nouveau mot de passe *</Label>
                  <Input
                    type="password"
                    value={passwordData.confirm_password}
                    onChange={(e) => setPasswordData({...passwordData, confirm_password: e.target.value})}
                    data-testid="confirm-password-input"
                  />
                </div>
              </div>
            </div>
            <div className="modal-actions">
              <div className="modal-actions">
                <Button variant="outline" onClick={() => setShowPasswordModal(false)}>
                  Annuler
                </Button>
                <Button variant="default" onClick={handleChangePassword} data-testid="save-password-btn">
                  Modifier le mot de passe
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ====================================================================
// MODULE RAPPORTS AVANC√âS - INTERNES ET EXTERNES
// ====================================================================

const Rapports = () => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('internes'); // 'internes' ou 'externes'
  const [activeRapport, setActiveRapport] = useState('dashboard'); // Type de rapport actif
  
  // √âtats pour les donn√©es
  const [dashboardData, setDashboardData] = useState(null);
  const [rapportSalaires, setRapportSalaires] = useState(null);
  const [rapportDisponibilite, setRapportDisponibilite] = useState(null);
  const [rapportCoutsFormations, setRapportCoutsFormations] = useState(null);
  const [rapportBudgetaire, setRapportBudgetaire] = useState(null);
  const [rapportImmobilisations, setRapportImmobilisations] = useState(null);
  const [budgets, setBudgets] = useState([]);
  const [immobilisations, setImmobilisations] = useState([]);
  
  // √âtats pour les filtres
  const [dateDebut, setDateDebut] = useState(new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0]);
  const [dateFin, setDateFin] = useState(new Date().toISOString().split('T')[0]);
  const [anneeSelectionnee, setAnneeSelectionnee] = useState(new Date().getFullYear());
  
  // √âtats pour les modals de saisie
  const [showBudgetModal, setShowBudgetModal] = useState(false);
  const [showImmobilisationModal, setShowImmobilisationModal] = useState(false);
  const [budgetForm, setBudgetForm] = useState({ annee: new Date().getFullYear(), categorie: 'salaires', budget_alloue: 0, notes: '' });
  const [immobilisationForm, setImmobilisationForm] = useState({ 
    type_immobilisation: 'vehicule', 
    nom: '', 
    date_acquisition: new Date().toISOString().split('T')[0], 
    cout_acquisition: 0, 
    cout_entretien_annuel: 0, 
    etat: 'bon', 
    notes: '' 
  });

  useEffect(() => {
    if (user?.role === 'admin' && tenantSlug) {
      loadData();
    }
  }, [user, tenantSlug, activeTab, activeRapport, anneeSelectionnee]);

  const loadData = async () => {
    setLoading(true);
    try {
      if (activeTab === 'internes') {
        if (activeRapport === 'dashboard') {
          const dashData = await apiGet(tenantSlug, '/rapports/dashboard-interne');
          setDashboardData(dashData);
        } else if (activeRapport === 'salaires') {
          // Ne pas charger automatiquement, attendre que l'utilisateur clique sur "G√©n√©rer"
        } else if (activeRapport === 'disponibilite') {
          // Ne pas charger automatiquement
        } else if (activeRapport === 'formations') {
          // Ne pas charger automatiquement
        }
      } else if (activeTab === 'externes') {
        if (activeRapport === 'budgetaire') {
          const [budgetsData] = await Promise.all([
            apiGet(tenantSlug, `/rapports/budgets?annee=${anneeSelectionnee}`)
          ]);
          setBudgets(budgetsData || []);
          
          // Charger aussi le rapport budg√©taire agr√©g√©
          try {
            const rapportBudg = await apiGet(tenantSlug, `/rapports/tableau-bord-budgetaire?annee=${anneeSelectionnee}`);
            setRapportBudgetaire(rapportBudg);
          } catch (e) {
            console.log('Pas de donn√©es budg√©taires agr√©g√©es');
          }
        } else if (activeRapport === 'immobilisations') {
          const [immobData, rapportImmob] = await Promise.all([
            apiGet(tenantSlug, '/rapports/immobilisations'),
            apiGet(tenantSlug, '/rapports/rapport-immobilisations')
          ]);
          setImmobilisations(immobData || []);
          setRapportImmobilisations(rapportImmob);
        }
      }
    } catch (error) {
      console.error('Erreur chargement donn√©es:', error);
      toast({ title: "Erreur", description: "Impossible de charger les donn√©es", variant: "destructive" });
    }
    setLoading(false);
  };

  const handleGenererRapportSalaires = async () => {
    setLoading(true);
    try {
      const params = `date_debut=${dateDebut}&date_fin=${dateFin}`;
      const rapport = await apiGet(tenantSlug, `/rapports/couts-salariaux?${params}`);
      setRapportSalaires(rapport);
      toast({ title: "Succ√®s", description: "Rapport g√©n√©r√©" });
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible de g√©n√©rer le rapport", variant: "destructive" });
    }
    setLoading(false);
  };

  const handleGenererRapportDisponibilite = async () => {
    setLoading(true);
    try {
      const params = `date_debut=${dateDebut}&date_fin=${dateFin}`;
      const rapport = await apiGet(tenantSlug, `/rapports/disponibilite?${params}`);
      setRapportDisponibilite(rapport);
      toast({ title: "Succ√®s", description: "Rapport g√©n√©r√©" });
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible de g√©n√©rer le rapport", variant: "destructive" });
    }
    setLoading(false);
  };

  const handleGenererRapportFormations = async () => {
    setLoading(true);
    try {
      const rapport = await apiGet(tenantSlug, `/rapports/couts-formations?annee=${anneeSelectionnee}`);
      setRapportCoutsFormations(rapport);
      toast({ title: "Succ√®s", description: "Rapport g√©n√©r√©" });
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible de g√©n√©rer le rapport", variant: "destructive" });
    }
    setLoading(false);
  };

  const handleSaveBudget = async () => {
    try {
      await apiPost(tenantSlug, '/rapports/budgets', budgetForm);
      toast({ title: "Succ√®s", description: "Budget ajout√©" });
      setShowBudgetModal(false);
      setBudgetForm({ annee: new Date().getFullYear(), categorie: 'salaires', budget_alloue: 0, notes: '' });
      loadData();
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible d'ajouter le budget", variant: "destructive" });
    }
  };

  const handleSaveImmobilisation = async () => {
    try {
      await apiPost(tenantSlug, '/rapports/immobilisations', immobilisationForm);
      toast({ title: "Succ√®s", description: "Immobilisation ajout√©e" });
      setShowImmobilisationModal(false);
      setImmobilisationForm({ 
        type_immobilisation: 'vehicule', 
        nom: '', 
        date_acquisition: new Date().toISOString().split('T')[0], 
        cout_acquisition: 0, 
        cout_entretien_annuel: 0, 
        etat: 'bon', 
        notes: '' 
      });
      loadData();
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible d'ajouter l'immobilisation", variant: "destructive" });
    }
  };

  const handleExportPDF = async (typeRapport) => {
    try {
      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
      const token = localStorage.getItem(`${tenantSlug}_token`);
      
      let url = '';
      if (typeRapport === 'dashboard') {
        url = `${backendUrl}/api/${tenantSlug}/rapports/export-dashboard-pdf`;
      } else if (typeRapport === 'salaires') {
        url = `${backendUrl}/api/${tenantSlug}/rapports/export-salaires-pdf?date_debut=${dateDebut}&date_fin=${dateFin}`;
      } else if (typeRapport === 'budgetaire') {
        toast({ title: "Info", description: "Export PDF Budg√©taire en d√©veloppement" });
        return;
      }
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur lors de l\'export');
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `rapport_${typeRapport}_${new Date().toISOString().split('T')[0]}.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(downloadUrl);
      
      toast({ title: "Succ√®s", description: `Rapport PDF t√©l√©charg√©` });
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible d'exporter le PDF", variant: "destructive" });
    }
  };

  const handleExportExcel = async (typeRapport) => {
    try {
      const backendUrl = process.env.REACT_APP_BACKEND_URL || import.meta.env.REACT_APP_BACKEND_URL;
      const token = localStorage.getItem(`${tenantSlug}_token`);
      
      let url = '';
      if (typeRapport === 'salaires') {
        url = `${backendUrl}/api/${tenantSlug}/rapports/export-salaires-excel?date_debut=${dateDebut}&date_fin=${dateFin}`;
      } else {
        toast({ title: "Info", description: "Export Excel en d√©veloppement pour ce rapport" });
        return;
      }
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur lors de l\'export');
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `rapport_${typeRapport}_${new Date().toISOString().split('T')[0]}.xlsx`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(downloadUrl);
      
      toast({ title: "Succ√®s", description: `Rapport Excel t√©l√©charg√©` });
    } catch (error) {
      toast({ title: "Erreur", description: "Impossible d'exporter l'Excel", variant: "destructive" });
    }
  };

  if (user?.role !== 'admin') {
    return (
      <div className="access-denied">
        <h1>Acc√®s refus√©</h1>
        <p>Cette section est r√©serv√©e aux administrateurs.</p>
      </div>
    );
  }

  if (loading) return <div className="loading">Chargement des rapports...</div>;

  return (
    <div className="module-rapports-nfpa">
      <div className="module-header">
        <div>
          <h1>üìà Rapports et Analyses</h1>
          <p>Rapports internes et externes pour la gestion et la communication</p>
        </div>
      </div>

      {/* Onglets principaux */}
      <div className="rapports-tabs">
        <button 
          className={activeTab === 'internes' ? 'active' : ''} 
          onClick={() => { setActiveTab('internes'); setActiveRapport('dashboard'); }}
        >
          üìä Rapports Internes
        </button>
        <button 
          className={activeTab === 'externes' ? 'active' : ''} 
          onClick={() => { setActiveTab('externes'); setActiveRapport('budgetaire'); }}
        >
          üìà Rapports Externes
        </button>
      </div>

      {/* SECTION RAPPORTS INTERNES */}
      {activeTab === 'internes' && (
        <div className="rapports-internes">
          {/* Sous-navigation */}
          <div className="rapports-sub-nav">
            <button className={activeRapport === 'dashboard' ? 'active' : ''} onClick={() => setActiveRapport('dashboard')}>
              üìä Dashboard
            </button>
            <button className={activeRapport === 'salaires' ? 'active' : ''} onClick={() => setActiveRapport('salaires')}>
              üí∞ Co√ªts Salariaux
            </button>
            <button className={activeRapport === 'disponibilite' ? 'active' : ''} onClick={() => setActiveRapport('disponibilite')}>
              üìÖ Disponibilit√©
            </button>
            <button className={activeRapport === 'formations' ? 'active' : ''} onClick={() => setActiveRapport('formations')}>
              üéì Formations
            </button>
          </div>

          {/* Dashboard Interne */}
          {activeRapport === 'dashboard' && dashboardData && (
            <div className="dashboard-interne">
              <h2>üìä Dashboard Interne - {dashboardData.periode}</h2>
              
              <div className="kpi-grid">
                <div className="kpi-card" style={{background: '#FEF3C7'}}>
                  <h3>{dashboardData.heures_travaillees_mois}h</h3>
                  <p>Heures travaill√©es ce mois</p>
                </div>
                <div className="kpi-card" style={{background: '#FCA5A5'}}>
                  <h3>${dashboardData.cout_salarial_mois.toLocaleString()}</h3>
                  <p>Co√ªt salarial du mois</p>
                </div>
                <div className="kpi-card" style={{background: '#D1FAE5'}}>
                  <h3>{dashboardData.pompiers_disponibles}</h3>
                  <p>Pompiers disponibles</p>
                </div>
                <div className="kpi-card" style={{background: '#DBEAFE'}}>
                  <h3>{dashboardData.total_pompiers}</h3>
                  <p>Total pompiers</p>
                </div>
              </div>
              
              {/* Graphiques */}
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '2rem', marginTop: '2rem'}}>
                {/* Graphique Donut - Disponibilit√© */}
                <div style={{background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #E5E7EB'}}>
                  <h3 style={{marginBottom: '1rem'}}>Disponibilit√© du Personnel</h3>
                  <Chart
                    options={{
                      chart: { type: 'donut' },
                      labels: ['Disponibles', 'Non disponibles'],
                      colors: ['#10B981', '#EF4444'],
                      legend: { position: 'bottom' },
                      dataLabels: { enabled: true },
                      plotOptions: {
                        pie: {
                          donut: {
                            labels: {
                              show: true,
                              total: {
                                show: true,
                                label: 'Total',
                                formatter: () => dashboardData.total_pompiers
                              }
                            }
                          }
                        }
                      }
                    }}
                    series={[dashboardData.pompiers_disponibles, dashboardData.total_pompiers - dashboardData.pompiers_disponibles]}
                    type="donut"
                    height={300}
                  />
                </div>

                {/* Graphique Barres - Co√ªts */}
                <div style={{background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #E5E7EB'}}>
                  <h3 style={{marginBottom: '1rem'}}>√âvolution Co√ªts Mensuels</h3>
                  <Chart
                    options={{
                      chart: { type: 'bar' },
                      xaxis: { categories: ['Janv', 'F√©vr', 'Mars', 'Avril', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sept'] },
                      colors: ['#FCA5A5'],
                      plotOptions: {
                        bar: {
                          borderRadius: 8,
                          dataLabels: { position: 'top' }
                        }
                      },
                      dataLabels: {
                        enabled: true,
                        formatter: (val) => `$${Math.round(val/1000)}k`,
                        offsetY: -20,
                        style: { fontSize: '12px', colors: ['#6B7280'] }
                      }
                    }}
                    series={[{
                      name: 'Co√ªts',
                      data: [25000, 28000, 30000, 27000, 29000, 31000, 32000, 30000, dashboardData.cout_salarial_mois]
                    }]}
                    type="bar"
                    height={300}
                  />
                </div>
              </div>
              
              <div style={{marginTop: '2rem', display: 'flex', gap: '1rem'}}>
                <Button onClick={() => handleExportPDF('dashboard')}>üìÑ Export PDF</Button>
                <Button variant="outline" onClick={() => handleExportExcel('dashboard')}>üìä Export Excel</Button>
              </div>
            </div>
          )}

          {/* Rapport Co√ªts Salariaux */}
          {activeRapport === 'salaires' && (
            <div className="rapport-salaires">
              <h2>üí∞ Rapport de Co√ªts Salariaux D√©taill√©s</h2>
              
              <div className="filtres-grid" style={{marginBottom: '2rem'}}>
                <div>
                  <Label>Date d√©but</Label>
                  <Input type="date" value={dateDebut} onChange={e => setDateDebut(e.target.value)} />
                </div>
                <div>
                  <Label>Date fin</Label>
                  <Input type="date" value={dateFin} onChange={e => setDateFin(e.target.value)} />
                </div>
                <div style={{display: 'flex', alignItems: 'end'}}>
                  <Button onClick={handleGenererRapportSalaires}>G√©n√©rer le rapport</Button>
                </div>
              </div>

              {rapportSalaires ? (
                <div>
                  {/* R√©sum√© */}
                  <div className="kpi-grid" style={{marginBottom: '2rem'}}>
                    <div className="kpi-card" style={{background: '#FCA5A5'}}>
                      <h3>${rapportSalaires.cout_total.toLocaleString()}</h3>
                      <p>Co√ªt Total</p>
                    </div>
                    <div className="kpi-card" style={{background: '#D1FAE5'}}>
                      <h3>{rapportSalaires.nombre_employes}</h3>
                      <p>Employ√©s</p>
                    </div>
                    <div className="kpi-card" style={{background: '#DBEAFE'}}>
                      <h3>
                        {rapportSalaires.employes.reduce((sum, e) => sum + e.heures_travaillees, 0)}h
                      </h3>
                      <p>Total Heures</p>
                    </div>
                  </div>

                  {/* Tableau d√©taill√© */}
                  <div className="salaires-table">
                    <div className="table-header">
                      <div className="header-cell">Nom</div>
                      <div className="header-cell">Matricule</div>
                      <div className="header-cell">Type</div>
                      <div className="header-cell">Heures</div>
                      <div className="header-cell">Taux/h</div>
                      <div className="header-cell">Co√ªt Total</div>
                    </div>
                    {rapportSalaires.employes.map((emp, idx) => (
                      <div key={idx} className="table-row">
                        <div className="table-cell">{emp.nom}</div>
                        <div className="table-cell">{emp.matricule}</div>
                        <div className="table-cell">
                          <span className={`badge ${emp.type_emploi}`}>
                            {emp.type_emploi === 'temps_plein' ? 'Temps plein' : 'Temps partiel'}
                          </span>
                        </div>
                        <div className="table-cell">{emp.heures_travaillees}h</div>
                        <div className="table-cell">${emp.taux_horaire}/h</div>
                        <div className="table-cell" style={{fontWeight: 'bold', color: '#DC2626'}}>
                          ${emp.cout_total.toLocaleString()}
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* Exports */}
                  <div style={{marginTop: '2rem', display: 'flex', gap: '1rem'}}>
                    <Button onClick={() => handleExportPDF('salaires')}>üìÑ Export PDF</Button>
                    <Button variant="outline" onClick={() => handleExportExcel('salaires')}>üìä Export Excel</Button>
                  </div>
                </div>
              ) : (
                <div className="empty-state">
                  <p>S√©lectionnez une p√©riode et cliquez sur "G√©n√©rer le rapport"</p>
                </div>
              )}
            </div>
          )}
          {/* Rapport Disponibilit√© */}
          {activeRapport === 'disponibilite' && (
            <div className="rapport-disponibilite">
              <h2>üìÖ Rapport de Disponibilit√©/Indisponibilit√©</h2>
              
              <div className="filtres-grid" style={{marginBottom: '2rem'}}>
                <div>
                  <Label>Date d√©but</Label>
                  <Input type="date" value={dateDebut} onChange={e => setDateDebut(e.target.value)} />
                </div>
                <div>
                  <Label>Date fin</Label>
                  <Input type="date" value={dateFin} onChange={e => setDateFin(e.target.value)} />
                </div>
                <div style={{display: 'flex', alignItems: 'end'}}>
                  <Button onClick={handleGenererRapportDisponibilite}>G√©n√©rer le rapport</Button>
                </div>
              </div>

              {rapportDisponibilite ? (
                <div>
                  {/* R√©sum√© avec graphique */}
                  <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', marginBottom: '2rem'}}>
                    <div>
                      <div className="kpi-grid" style={{gridTemplateColumns: '1fr 1fr'}}>
                        <div className="kpi-card" style={{background: '#D1FAE5'}}>
                          <h3>{rapportDisponibilite.total_jours_disponibles}</h3>
                          <p>Jours Disponibles</p>
                        </div>
                        <div className="kpi-card" style={{background: '#FCA5A5'}}>
                          <h3>{rapportDisponibilite.total_jours_indisponibles}</h3>
                          <p>Jours Indisponibles</p>
                        </div>
                        <div className="kpi-card" style={{background: '#DBEAFE', gridColumn: 'span 2'}}>
                          <h3>{rapportDisponibilite.taux_disponibilite_global}%</h3>
                          <p>Taux de Disponibilit√© Global</p>
                        </div>
                      </div>
                    </div>
                    <div style={{background: 'white', padding: '1rem', borderRadius: '12px', border: '1px solid #E5E7EB'}}>
                      <Chart
                        options={{
                          chart: { type: 'pie' },
                          labels: ['Disponibles', 'Indisponibles'],
                          colors: ['#10B981', '#EF4444'],
                          legend: { position: 'bottom' }
                        }}
                        series={[rapportDisponibilite.total_jours_disponibles, rapportDisponibilite.total_jours_indisponibles]}
                        type="pie"
                        height={250}
                      />
                    </div>
                  </div>

                  {/* Tableau par employ√© */}
                  <div className="salaires-table">
                    <div className="table-header">
                      <div className="header-cell">Nom</div>
                      <div className="header-cell">Grade</div>
                      <div className="header-cell">Jours Dispo.</div>
                      <div className="header-cell">Jours Indispo.</div>
                      <div className="header-cell">Taux %</div>
                      <div className="header-cell">Motifs</div>
                    </div>
                    {rapportDisponibilite.employes.map((emp, idx) => (
                      <div key={idx} className="table-row">
                        <div className="table-cell">{emp.nom}</div>
                        <div className="table-cell">{emp.grade}</div>
                        <div className="table-cell" style={{color: '#10B981', fontWeight: 'bold'}}>{emp.jours_disponibles}</div>
                        <div className="table-cell" style={{color: '#EF4444', fontWeight: 'bold'}}>{emp.jours_indisponibles}</div>
                        <div className="table-cell">{emp.taux_disponibilite}%</div>
                        <div className="table-cell" style={{fontSize: '0.85rem'}}>
                          {Object.entries(emp.motifs_indisponibilite).map(([motif, count]) => (
                            <span key={motif} style={{display: 'block'}}>{motif}: {count}</span>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>

                  <div style={{marginTop: '2rem', display: 'flex', gap: '1rem'}}>
                    <Button onClick={() => handleExportPDF('disponibilite')}>üìÑ Export PDF</Button>
                    <Button variant="outline" onClick={() => handleExportExcel('disponibilite')}>üìä Export Excel</Button>
                  </div>
                </div>
              ) : (
                <div className="empty-state">
                  <p>S√©lectionnez une p√©riode et cliquez sur "G√©n√©rer le rapport"</p>
                </div>
              )}
            </div>
          )}

          {/* Rapport Co√ªts Formations */}
          {activeRapport === 'formations' && (
            <div className="rapport-formations">
              <h2>üéì Rapport de Co√ªts de Formation</h2>
              
              <div className="filtres-grid" style={{marginBottom: '2rem'}}>
                <div>
                  <Label>Ann√©e</Label>
                  <select 
                    className="form-select" 
                    value={anneeSelectionnee} 
                    onChange={e => setAnneeSelectionnee(parseInt(e.target.value))}
                  >
                    {[2024, 2025, 2026, 2027].map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                </div>
                <div style={{display: 'flex', alignItems: 'end'}}>
                  <Button onClick={handleGenererRapportFormations}>G√©n√©rer le rapport</Button>
                </div>
              </div>

              {rapportCoutsFormations ? (
                <div>
                  {/* KPIs */}
                  <div className="kpi-grid" style={{marginBottom: '2rem'}}>
                    <div className="kpi-card" style={{background: '#FCA5A5'}}>
                      <h3>${rapportCoutsFormations.cout_total.toLocaleString()}</h3>
                      <p>Co√ªt Total</p>
                    </div>
                    <div className="kpi-card" style={{background: '#D1FAE5'}}>
                      <h3>{rapportCoutsFormations.nombre_formations}</h3>
                      <p>Formations</p>
                    </div>
                    <div className="kpi-card" style={{background: '#DBEAFE'}}>
                      <h3>{rapportCoutsFormations.nombre_total_participants}</h3>
                      <p>Participants</p>
                    </div>
                    <div className="kpi-card" style={{background: '#FEF3C7'}}>
                      <h3>{rapportCoutsFormations.heures_totales}h</h3>
                      <p>Heures Totales</p>
                    </div>
                  </div>

                  {/* Tableau formations */}
                  <div className="salaires-table">
                    <div className="table-header">
                      <div className="header-cell">Formation</div>
                      <div className="header-cell">Date</div>
                      <div className="header-cell">Dur√©e</div>
                      <div className="header-cell">Participants</div>
                      <div className="header-cell">Co√ªt Formation</div>
                      <div className="header-cell">Co√ªt Salarial</div>
                    </div>
                    {rapportCoutsFormations.formations.map((formation, idx) => (
                      <div key={idx} className="table-row">
                        <div className="table-cell">{formation.nom_formation}</div>
                        <div className="table-cell">{new Date(formation.date).toLocaleDateString('fr-FR')}</div>
                        <div className="table-cell">{formation.duree_heures}h</div>
                        <div className="table-cell">{formation.nombre_participants}</div>
                        <div className="table-cell">${formation.cout_formation.toLocaleString()}</div>
                        <div className="table-cell" style={{fontWeight: 'bold', color: '#DC2626'}}>
                          ${formation.cout_total.toLocaleString()}
                        </div>
                      </div>
                    ))}
                  </div>

                  <div style={{marginTop: '2rem', display: 'flex', gap: '1rem'}}>
                    <Button onClick={() => handleExportPDF('formations')}>üìÑ Export PDF</Button>
                    <Button variant="outline" onClick={() => handleExportExcel('formations')}>üìä Export Excel</Button>
                  </div>
                </div>
              ) : (
                <div className="empty-state">
                  <p>S√©lectionnez une ann√©e et cliquez sur "G√©n√©rer le rapport"</p>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* SECTION RAPPORTS EXTERNES */}
      {activeTab === 'externes' && (
        <div className="rapports-externes">
          {/* Sous-navigation */}
          <div className="rapports-sub-nav">
            <button className={activeRapport === 'budgetaire' ? 'active' : ''} onClick={() => setActiveRapport('budgetaire')}>
              üí∞ Tableau Budg√©taire
            </button>
            <button className={activeRapport === 'immobilisations' ? 'active' : ''} onClick={() => setActiveRapport('immobilisations')}>
              üöí Immobilisations
            </button>
          </div>

          {/* Tableau de Bord Budg√©taire */}
          {activeRapport === 'budgetaire' && (
            <div className="rapport-budgetaire">
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                <h2>üí∞ Tableau de Bord Budg√©taire - {anneeSelectionnee}</h2>
                <div style={{display: 'flex', gap: '1rem', alignItems: 'center'}}>
                  <select 
                    className="form-select" 
                    value={anneeSelectionnee} 
                    onChange={e => setAnneeSelectionnee(parseInt(e.target.value))}
                  >
                    {[2024, 2025, 2026, 2027].map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                  <Button onClick={() => setShowBudgetModal(true)}>‚ûï Ajouter Budget</Button>
                </div>
              </div>

              {budgets.length > 0 ? (
                <div>
                  <div className="budgets-grid">
                    {budgets.map(budget => {
                      const pourcentage = budget.budget_alloue > 0 ? (budget.budget_consomme / budget.budget_alloue * 100) : 0;
                      return (
                        <div key={budget.id} className="budget-card">
                          <h3>{budget.categorie}</h3>
                          <div className="budget-montants">
                            <div>
                              <p className="budget-label">Allou√©</p>
                              <p className="budget-value">${budget.budget_alloue.toLocaleString()}</p>
                            </div>
                            <div>
                              <p className="budget-label">Consomm√©</p>
                              <p className="budget-value">${budget.budget_consomme.toLocaleString()}</p>
                            </div>
                          </div>
                          <div className="budget-bar">
                            <div 
                              className="budget-progress" 
                              style={{
                                width: `${Math.min(pourcentage, 100)}%`,
                                background: pourcentage > 90 ? '#EF4444' : pourcentage > 75 ? '#F59E0B' : '#10B981'
                              }}
                            />
                          </div>
                          <p style={{fontSize: '0.9rem', color: '#6B7280', marginTop: '0.5rem'}}>
                            {pourcentage.toFixed(1)}% utilis√©
                          </p>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Graphique Budget Global */}
                  {rapportBudgetaire && (
                    <div style={{marginTop: '2rem', background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #E5E7EB'}}>
                      <h3 style={{marginBottom: '1rem'}}>Vue d'ensemble Budg√©taire - {anneeSelectionnee}</h3>
                      <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem'}}>
                        <div>
                          <Chart
                            options={{
                              chart: { type: 'donut' },
                              labels: rapportBudgetaire.par_categorie.map(b => b.categorie),
                              colors: ['#FCA5A5', '#10B981', '#3B82F6', '#F59E0B', '#8B5CF6', '#EC4899'],
                              legend: { position: 'bottom' },
                              plotOptions: {
                                pie: {
                                  donut: {
                                    labels: {
                                      show: true,
                                      total: {
                                        show: true,
                                        label: 'Total Allou√©',
                                        formatter: () => `$${(rapportBudgetaire.budget_total_alloue/1000).toFixed(0)}k`
                                      }
                                    }
                                  }
                                }
                              }
                            }}
                            series={rapportBudgetaire.par_categorie.map(b => b.budget_alloue)}
                            type="donut"
                            height={300}
                          />
                        </div>
                        <div>
                          <div className="kpi-grid" style={{gridTemplateColumns: '1fr 1fr'}}>
                            <div className="kpi-card" style={{background: '#FEF3C7'}}>
                              <h3>${rapportBudgetaire.budget_total_alloue.toLocaleString()}</h3>
                              <p>Budget Allou√©</p>
                            </div>
                            <div className="kpi-card" style={{background: '#FCA5A5'}}>
                              <h3>${rapportBudgetaire.budget_total_consomme.toLocaleString()}</h3>
                              <p>Budget Consomm√©</p>
                            </div>
                            <div className="kpi-card" style={{background: '#D1FAE5', gridColumn: 'span 2'}}>
                              <h3>{rapportBudgetaire.pourcentage_global}%</h3>
                              <p>Taux d'utilisation global</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  <div style={{marginTop: '2rem', display: 'flex', gap: '1rem'}}>
                    <Button onClick={() => handleExportPDF('budgetaire')}>üìÑ Export PDF</Button>
                    <Button variant="outline" onClick={() => handleExportExcel('budgetaire')}>üìä Export Excel</Button>
                  </div>
                </div>
              ) : (
                <div className="empty-state">
                  <p>Aucun budget pour {anneeSelectionnee}. Cliquez sur "Ajouter Budget" pour commencer.</p>
                </div>
              )}
            </div>
          )}

          {/* Immobilisations */}
          {activeRapport === 'immobilisations' && (
            <div className="rapport-immobilisations">
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                <h2>üöí Rapport sur les Immobilisations</h2>
                <Button onClick={() => setShowImmobilisationModal(true)}>‚ûï Ajouter Immobilisation</Button>
              </div>

              {rapportImmobilisations ? (
                <div>
                  {/* Statistiques globales */}
                  <div className="kpi-grid" style={{marginBottom: '2rem'}}>
                    <div className="kpi-card" style={{background: '#FEF3C7'}}>
                      <h3>{rapportImmobilisations.statistiques.nombre_vehicules}</h3>
                      <p>V√©hicules</p>
                    </div>
                    <div className="kpi-card" style={{background: '#D1FAE5'}}>
                      <h3>{rapportImmobilisations.statistiques.nombre_equipements}</h3>
                      <p>√âquipements</p>
                    </div>
                    <div className="kpi-card" style={{background: '#FCA5A5'}}>
                      <h3>${rapportImmobilisations.statistiques.cout_acquisition_total.toLocaleString()}</h3>
                      <p>Co√ªt Acquisition</p>
                    </div>
                    <div className="kpi-card" style={{background: '#DBEAFE'}}>
                      <h3>${rapportImmobilisations.statistiques.cout_entretien_annuel_total.toLocaleString()}</h3>
                      <p>Entretien Annuel</p>
                    </div>
                  </div>

                  {/* V√©hicules */}
                  {rapportImmobilisations.vehicules.length > 0 && (
                    <div style={{marginBottom: '2rem'}}>
                      <h3 style={{marginBottom: '1rem'}}>üöí V√©hicules (√Çge moyen: {rapportImmobilisations.statistiques.age_moyen_vehicules} ans)</h3>
                      <div className="immobilisations-grid">
                        {rapportImmobilisations.vehicules.map(vehicule => (
                          <div key={vehicule.id} className="immobilisation-card">
                            <h4>{vehicule.nom}</h4>
                            <div className="immobilisation-details">
                              <p><strong>Acquisition:</strong> {new Date(vehicule.date_acquisition).toLocaleDateString('fr-FR')}</p>
                              <p><strong>√Çge:</strong> {vehicule.age_annees} ans</p>
                              <p><strong>√âtat:</strong> <span className={`badge ${vehicule.etat}`}>{vehicule.etat}</span></p>
                              <p><strong>Co√ªt:</strong> ${vehicule.cout_acquisition.toLocaleString()}</p>
                              <p><strong>Entretien:</strong> ${vehicule.cout_entretien_annuel.toLocaleString()}/an</p>
                              {vehicule.date_remplacement_prevue && (
                                <p><strong>Remplacement pr√©vu:</strong> {new Date(vehicule.date_remplacement_prevue).toLocaleDateString('fr-FR')}</p>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* √âquipements */}
                  {rapportImmobilisations.equipements.length > 0 && (
                    <div>
                      <h3 style={{marginBottom: '1rem'}}>üîß √âquipements (√Çge moyen: {rapportImmobilisations.statistiques.age_moyen_equipements} ans)</h3>
                      <div className="immobilisations-grid">
                        {rapportImmobilisations.equipements.map(equip => (
                          <div key={equip.id} className="immobilisation-card">
                            <h4>{equip.nom}</h4>
                            <div className="immobilisation-details">
                              <p><strong>Acquisition:</strong> {new Date(equip.date_acquisition).toLocaleDateString('fr-FR')}</p>
                              <p><strong>√Çge:</strong> {equip.age_annees} ans</p>
                              <p><strong>√âtat:</strong> <span className={`badge ${equip.etat}`}>{equip.etat}</span></p>
                              <p><strong>Co√ªt:</strong> ${equip.cout_acquisition.toLocaleString()}</p>
                              <p><strong>Entretien:</strong> ${equip.cout_entretien_annuel.toLocaleString()}/an</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  <div style={{marginTop: '2rem', display: 'flex', gap: '1rem'}}>
                    <Button onClick={() => handleExportPDF('immobilisations')}>üìÑ Export PDF</Button>
                    <Button variant="outline" onClick={() => handleExportExcel('immobilisations')}>üìä Export Excel</Button>
                  </div>
                </div>
              ) : (
                <div className="empty-state">
                  <p>Aucune immobilisation. Cliquez sur "Ajouter Immobilisation" pour commencer.</p>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* Modal Budget */}
      {showBudgetModal && (
        <div className="modal-overlay" onClick={() => setShowBudgetModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>‚ûï Ajouter un Budget</h2>
              <Button variant="ghost" onClick={() => setShowBudgetModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="form-grid">
                <div>
                  <Label>Ann√©e</Label>
                  <Input type="number" value={budgetForm.annee} onChange={e => setBudgetForm({...budgetForm, annee: parseInt(e.target.value)})} />
                </div>
                <div>
                  <Label>Cat√©gorie</Label>
                  <select 
                    className="form-select" 
                    value={budgetForm.categorie} 
                    onChange={e => setBudgetForm({...budgetForm, categorie: e.target.value})}
                  >
                    <option value="salaires">Salaires</option>
                    <option value="formations">Formations</option>
                    <option value="equipements">√âquipements</option>
                    <option value="carburant">Carburant</option>
                    <option value="entretien">Entretien</option>
                    <option value="autres">Autres</option>
                  </select>
                </div>
                <div>
                  <Label>Budget Allou√© ($)</Label>
                  <Input type="number" value={budgetForm.budget_alloue} onChange={e => setBudgetForm({...budgetForm, budget_alloue: parseFloat(e.target.value)})} />
                </div>
                <div>
                  <Label>Notes</Label>
                  <Input value={budgetForm.notes} onChange={e => setBudgetForm({...budgetForm, notes: e.target.value})} />
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <Button variant="outline" onClick={() => setShowBudgetModal(false)}>Annuler</Button>
              <Button onClick={handleSaveBudget}>Enregistrer</Button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Immobilisation */}
      {showImmobilisationModal && (
        <div className="modal-overlay" onClick={() => setShowImmobilisationModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>‚ûï Ajouter une Immobilisation</h2>
              <Button variant="ghost" onClick={() => setShowImmobilisationModal(false)}>‚úï</Button>
            </div>
            <div className="modal-body">
              <div className="form-grid">
                <div>
                  <Label>Type</Label>
                  <select 
                    className="form-select" 
                    value={immobilisationForm.type_immobilisation} 
                    onChange={e => setImmobilisationForm({...immobilisationForm, type_immobilisation: e.target.value})}
                  >
                    <option value="vehicule">V√©hicule</option>
                    <option value="equipement_majeur">√âquipement Majeur</option>
                  </select>
                </div>
                <div>
                  <Label>Nom</Label>
                  <Input 
                    value={immobilisationForm.nom} 
                    onChange={e => setImmobilisationForm({...immobilisationForm, nom: e.target.value})} 
                    placeholder="Ex: Camion-citerne 2024"
                  />
                </div>
                <div>
                  <Label>Date d'acquisition</Label>
                  <Input 
                    type="date" 
                    value={immobilisationForm.date_acquisition} 
                    onChange={e => setImmobilisationForm({...immobilisationForm, date_acquisition: e.target.value})} 
                  />
                </div>
                <div>
                  <Label>Co√ªt d'acquisition ($)</Label>
                  <Input 
                    type="number" 
                    value={immobilisationForm.cout_acquisition} 
                    onChange={e => setImmobilisationForm({...immobilisationForm, cout_acquisition: parseFloat(e.target.value)})} 
                  />
                </div>
                <div>
                  <Label>Co√ªt entretien annuel ($)</Label>
                  <Input 
                    type="number" 
                    value={immobilisationForm.cout_entretien_annuel} 
                    onChange={e => setImmobilisationForm({...immobilisationForm, cout_entretien_annuel: parseFloat(e.target.value)})} 
                  />
                </div>
                <div>
                  <Label>√âtat</Label>
                  <select 
                    className="form-select" 
                    value={immobilisationForm.etat} 
                    onChange={e => setImmobilisationForm({...immobilisationForm, etat: e.target.value})}
                  >
                    <option value="bon">Bon</option>
                    <option value="moyen">Moyen</option>
                    <option value="mauvais">Mauvais</option>
                  </select>
                </div>
                <div style={{gridColumn: 'span 2'}}>
                  <Label>Notes</Label>
                  <Input 
                    value={immobilisationForm.notes} 
                    onChange={e => setImmobilisationForm({...immobilisationForm, notes: e.target.value})} 
                    placeholder="Notes additionnelles..."
                  />
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <Button variant="outline" onClick={() => setShowImmobilisationModal(false)}>Annuler</Button>
              <Button onClick={handleSaveImmobilisation}>Enregistrer</Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Import B√¢timents Component - Support CSV, Excel et HTML
const ImportBatiments = ({ onImportComplete }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [step, setStep] = useState(1); // 1: Upload, 2: Mapping, 3: Preview, 4: Conflicts, 5: Import
  const [uploadedFile, setUploadedFile] = useState(null);
  const [fileType, setFileType] = useState(null); // 'csv', 'excel', 'html'
  const [csvData, setCsvData] = useState([]);
  const [csvHeaders, setCsvHeaders] = useState([]);
  const [columnMapping, setColumnMapping] = useState({});
  const [defaultValues, setDefaultValues] = useState({}); // Valeurs par d√©faut pour saisie de masse
  const [previewData, setPreviewData] = useState([]);
  const [conflicts, setConflicts] = useState([]); // Doublons d√©tect√©s
  const [conflictResolutions, setConflictResolutions] = useState({}); // Actions choisies par l'utilisateur
  const [importing, setImporting] = useState(false);
  const [importResults, setImportResults] = useState(null);
  const [showFieldEditor, setShowFieldEditor] = useState(false);
  const [existingBatiments, setExistingBatiments] = useState([]); // Pour la d√©tection de doublons

  // Champs par d√©faut
  const defaultFields = [
    { key: 'nom_etablissement', label: 'Nom √©tablissement', required: true },
    { key: 'adresse_civique', label: 'Adresse civique', required: true },
    { key: 'ville', label: 'Ville', required: false },
    { key: 'code_postal', label: 'Code postal', required: false },
    { key: 'cadastre_matricule', label: 'Cadastre/Matricule', required: false },
    { key: 'proprietaire_nom', label: 'Propri√©taire - Nom', required: false },
    { key: 'proprietaire_telephone', label: 'Propri√©taire - T√©l√©phone', required: false },
    { key: 'proprietaire_courriel', label: 'Propri√©taire - Courriel', required: false },
    { key: 'gerant_nom', label: 'G√©rant - Nom', required: false },
    { key: 'gerant_telephone', label: 'G√©rant - T√©l√©phone', required: false },
    { key: 'gerant_courriel', label: 'G√©rant - Courriel', required: false },
    { key: 'groupe_occupation', label: 'Groupe occupation (C,E,F,I...)', required: false },
    { key: 'description_activite', label: 'Description activit√©', required: false },
    { key: 'notes_generales', label: 'Notes g√©n√©rales', required: false }
  ];

  // Charger les champs personnalis√©s depuis le localStorage ou utiliser les champs par d√©faut
  const [availableFields, setAvailableFields] = useState(() => {
    const savedFields = localStorage.getItem(`${tenantSlug}_import_fields`);
    if (savedFields) {
      const fields = JSON.parse(savedFields);
      // Migration automatique: remplacer numero_lot_cadastre par cadastre_matricule
      const migratedFields = fields.map(field => {
        if (field.key === 'numero_lot_cadastre') {
          return { ...field, key: 'cadastre_matricule', label: 'Cadastre/Matricule' };
        }
        return field;
      });
      // Sauvegarder la version migr√©e
      localStorage.setItem(`${tenantSlug}_import_fields`, JSON.stringify(migratedFields));
      return migratedFields;
    }
    return defaultFields;
  });

  // Sauvegarder les champs personnalis√©s
  const saveCustomFields = (fields) => {
    localStorage.setItem(`${tenantSlug}_import_fields`, JSON.stringify(fields));
    setAvailableFields(fields);
    toast({
      title: "Champs sauvegard√©s",
      description: "Vos champs personnalis√©s ont √©t√© enregistr√©s"
    });
  };

  // R√©initialiser aux champs par d√©faut
  const resetToDefaultFields = () => {
    localStorage.removeItem(`${tenantSlug}_import_fields`);
    setAvailableFields(defaultFields);
    toast({
      title: "R√©initialisation",
      description: "Les champs ont √©t√© r√©initialis√©s aux valeurs par d√©faut"
    });
  };

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const fileExtension = file.name.split('.').pop().toLowerCase();
    if (!['csv', 'xlsx', 'xls', 'html', 'htm', 'xml'].includes(fileExtension)) {
      toast({
        title: "Format non support√©",
        description: "Formats accept√©s : CSV, Excel (.xlsx, .xls), HTML (.html, .htm) et XML (.xml)",
        variant: "destructive"
      });
      return;
    }

    setUploadedFile(file);
    
    let type;
    if (fileExtension === 'html' || fileExtension === 'htm') {
      type = 'html';
    } else if (fileExtension === 'xml') {
      type = 'xml';
    } else if (fileExtension === 'csv') {
      type = 'csv';
    } else {
      type = 'excel';
    }
    setFileType(type);
    
    if (fileExtension === 'html' || fileExtension === 'htm') {
      parseHTML(file);
    } else if (fileExtension === 'xml') {
      parseXML(file);
    } else {
      parseCSV(file);
    }
  };

  const parseHTML = async (file) => {
    try {
      const text = await file.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      
      // Chercher le premier tableau
      const table = doc.querySelector('table');
      if (!table) {
        throw new Error("Aucun tableau HTML trouv√© dans le fichier");
      }
      
      // Extraire les en-t√™tes
      const headerRow = table.querySelector('thead tr, tr:first-child');
      if (!headerRow) {
        throw new Error("Aucune ligne d'en-t√™te trouv√©e");
      }
      
      const headers = Array.from(headerRow.querySelectorAll('th, td')).map(cell => cell.textContent.trim());
      setCsvHeaders(headers);
      
      // Extraire les donn√©es
      const rows = Array.from(table.querySelectorAll('tbody tr, tr')).slice(headers.length > 0 ? 1 : 0);
      const data = rows.map((row, index) => {
        const cells = Array.from(row.querySelectorAll('td, th'));
        const rowData = { _index: index };
        headers.forEach((header, i) => {
          rowData[header] = cells[i] ? cells[i].textContent.trim() : '';
        });
        return rowData;
      });
      
      setCsvData(data);
      setStep(2);
      
      toast({
        title: "Fichier HTML analys√©",
        description: `${data.length} ligne(s) d√©tect√©e(s) avec ${headers.length} colonne(s)`
      });
      
    } catch (error) {
      console.error('Erreur parsing HTML:', error);
      toast({
        title: "Erreur d'analyse HTML",
        description: error.message || "Impossible d'analyser le fichier HTML",
        variant: "destructive"
      });
    }
  };


  const parseXML = async (file) => {
    try {
      const text = await file.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(text, 'text/xml');
      
      // V√©rifier les erreurs de parsing
      const parserError = xmlDoc.querySelector('parsererror');
      if (parserError) {
        throw new Error("Le fichier XML n'est pas valide");
      }
      
      // Extraire tous les √©l√©ments r√©cursifs du XML
      // Pour un XML municipal qu√©b√©cois, on cherche les √©l√©ments r√©p√©titifs
      const extractAllElements = (node, prefix = '') => {
        const result = {};
        
        if (node.nodeType === Node.ELEMENT_NODE) {
          const path = prefix ? `${prefix}/${node.nodeName}` : node.nodeName;
          
          // Si l'√©l√©ment a du texte et pas d'enfants √©l√©ments
          if (node.childNodes.length === 1 && node.childNodes[0].nodeType === Node.TEXT_NODE) {
            const value = node.textContent.trim();
            if (value) {
              result[path] = value;
            }
          }
          
          // Parcourir les enfants
          Array.from(node.children).forEach(child => {
            const childData = extractAllElements(child, path);
            Object.assign(result, childData);
          });
        }
        
        return result;
      };
      
      // Trouver les √©l√©ments qui se r√©p√®tent (probablement les b√¢timents/adresses)
      // Pour le format municipal qu√©b√©cois, c'est g√©n√©ralement CE02 qui se r√©p√®te
      const findRepeatingElements = (xmlDoc) => {
        // Essayer de d√©tecter automatiquement l'√©l√©ment parent qui se r√©p√®te
        const commonParents = ['CE02', 'CEx', 'batiment', 'adresse', 'record', 'row'];
        
        for (const parentName of commonParents) {
          const elements = xmlDoc.getElementsByTagName(parentName);
          if (elements.length > 0) {
            return Array.from(elements);
          }
        }
        
        // Si aucun √©l√©ment commun trouv√©, prendre tous les enfants directs de la racine
        return Array.from(xmlDoc.documentElement.children);
      };
      
      const repeatingElements = findRepeatingElements(xmlDoc);
      
      if (repeatingElements.length === 0) {
        throw new Error("Aucun √©l√©ment r√©p√©titif trouv√© dans le XML");
      }
      
      // Extraire les donn√©es de chaque √©l√©ment
      const data = repeatingElements.map((element, index) => {
        const rowData = { _index: index };
        const extracted = extractAllElements(element);
        Object.assign(rowData, extracted);
        return rowData;
      });
      
      // Extraire tous les chemins uniques comme en-t√™tes
      const allPaths = new Set();
      data.forEach(row => {
        Object.keys(row).forEach(key => {
          if (key !== '_index') {
            allPaths.add(key);
          }
        });
      });
      
      const headers = Array.from(allPaths).sort();
      
      setCsvHeaders(headers);
      setCsvData(data);
      setStep(2);
      
      toast({
        title: "Fichier XML analys√©",
        description: `${data.length} √©l√©ment(s) d√©tect√©(s) avec ${headers.length} champ(s) disponible(s)`
      });
      
    } catch (error) {
      console.error('Erreur parsing XML:', error);
      toast({
        title: "Erreur d'analyse XML",
        description: error.message || "Impossible d'analyser le fichier XML",
        variant: "destructive"
      });
    }
  };


  const parseCSV = async (file) => {
    try {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim() !== '');
      
      if (lines.length < 2) {
        throw new Error("Le fichier doit contenir au moins un en-t√™te et une ligne de donn√©es");
      }

      // Parse headers (premi√®re ligne)
      const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
      setCsvHeaders(headers);

      // Parse data (lignes suivantes)
      const data = lines.slice(1).map((line, index) => {
        const values = line.split(',').map(v => v.trim().replace(/['"]/g, ''));
        const row = { _index: index };
        headers.forEach((header, i) => {
          row[header] = values[i] || '';
        });
        return row;
      });

      setCsvData(data);
      setStep(2); // Passer au mapping
      
      toast({
        title: "Fichier analys√©",
        description: `${data.length} ligne(s) d√©tect√©e(s) avec ${headers.length} colonne(s)`
      });

    } catch (error) {
      console.error('Erreur parsing CSV:', error);
      toast({
        title: "Erreur d'analyse",
        description: error.message || "Impossible d'analyser le fichier",
        variant: "destructive"
      });
    }
  };

  const handleColumnMapping = (csvColumn, fieldKey) => {
    setColumnMapping(prev => ({
      ...prev,
      [fieldKey]: csvColumn
    }));
  };

  const handleDefaultValue = (fieldKey, value) => {
    setDefaultValues(prev => ({
      ...prev,
      [fieldKey]: value
    }));
  };

  const generatePreview = () => {
    const preview = csvData.slice(0, 5).map(row => {
      const mapped = {};
      availableFields.forEach(field => {
        // Priorit√© 1: Valeur par d√©faut (√©crase tout)
        if (defaultValues[field.key]) {
          mapped[field.key] = defaultValues[field.key];
        } 
        // Priorit√© 2: Valeur du CSV
        else {
          const csvColumn = columnMapping[field.key];
          mapped[field.key] = csvColumn ? row[csvColumn] : '';
        }
      });
      return mapped;
    });
    setPreviewData(preview);
    setStep(3);
  };

  // D√©tecter les doublons avant import
  const detectConflicts = async () => {
    try {
      // R√©cup√©rer tous les b√¢timents existants
      const existingData = await apiGet(tenantSlug, '/prevention/batiments');
      setExistingBatiments(existingData);
      
      // Mapper toutes les donn√©es CSV
      const allMappedData = csvData.map(row => {
        const mapped = {};
        availableFields.forEach(field => {
          if (defaultValues[field.key]) {
            mapped[field.key] = defaultValues[field.key];
          } else {
            const csvColumn = columnMapping[field.key];
            mapped[field.key] = csvColumn ? row[csvColumn] : '';
          }
        });
        return mapped;
      });
      
      // D√©tecter les conflits (adresse, matricule, cadastre)
      const detectedConflicts = [];
      allMappedData.forEach((newBat, index) => {
        const duplicates = existingData.filter(existing => {
          // V√©rifier adresse
          const sameAddress = existing.adresse_civique && newBat.adresse_civique && 
            existing.adresse_civique.toLowerCase().trim() === newBat.adresse_civique.toLowerCase().trim();
          
          // V√©rifier cadastre/matricule
          const sameCadastre = existing.cadastre_matricule && newBat.cadastre_matricule &&
            existing.cadastre_matricule.toLowerCase().trim() === newBat.cadastre_matricule.toLowerCase().trim();
          
          return sameAddress || sameCadastre;
        });
        
        if (duplicates.length > 0) {
          detectedConflicts.push({
            index,
            newData: newBat,
            existing: duplicates[0], // Prendre le premier doublon
            reasons: [
              duplicates[0].adresse_civique === newBat.adresse_civique && 'M√™me adresse',
              duplicates[0].cadastre_matricule === newBat.cadastre_matricule && 'M√™me cadastre'
            ].filter(Boolean)
          });
        }
      });
      
      if (detectedConflicts.length > 0) {
        setConflicts(detectedConflicts);
        // Initialiser les r√©solutions √† "ignorer" par d√©faut
        const initialResolutions = {};
        detectedConflicts.forEach(c => {
          initialResolutions[c.index] = 'ignorer';
        });
        setConflictResolutions(initialResolutions);
        setStep(4); // √âtape de r√©solution des conflits
        
        toast({
          title: "‚ö†Ô∏è Doublons d√©tect√©s",
          description: `${detectedConflicts.length} conflit(s) trouv√©(s). Veuillez choisir une action.`,
          variant: "warning"
        });
      } else {
        // Pas de conflits, passer directement √† l'import
        proceedWithImport();
      }
      
    } catch (error) {
      console.error('Erreur d√©tection conflits:', error);
      toast({
        title: "Erreur",
        description: "Impossible de v√©rifier les doublons",
        variant: "destructive"
      });
    }
  };

  const validateMapping = () => {
    const requiredFields = availableFields.filter(f => f.required);
    const missingFields = requiredFields.filter(f => 
      !columnMapping[f.key] && !defaultValues[f.key] // Valide si colonne CSV OU valeur par d√©faut
    );
    
    if (missingFields.length > 0) {
      toast({
        title: "Champs requis manquants",
        description: `Veuillez mapper ou d√©finir une valeur par d√©faut pour: ${missingFields.map(f => f.label).join(', ')}`,
        variant: "destructive"
      });
      return false;
    }
    return true;
  };

  const handleImport = async () => {
    if (!validateMapping()) return;

    setImporting(true);
    try {
      const mappedData = csvData.map(row => {
        const batiment = {};
        availableFields.forEach(field => {
          // Priorit√© 1: Valeur par d√©faut (saisie de masse √©crase tout)
          if (defaultValues[field.key]) {
            batiment[field.key] = defaultValues[field.key];
          }
          // Priorit√© 2: Valeur du CSV
          else {
            const csvColumn = columnMapping[field.key];
            batiment[field.key] = csvColumn ? (row[csvColumn] || '') : '';
          }
        });
        return batiment;
      });

      // Extraire les champs requis personnalis√©s
      const requiredFields = availableFields
        .filter(f => f.required)
        .map(f => ({ key: f.key, label: f.label }));

      const response = await apiPost(tenantSlug, '/prevention/batiments/import-csv', {
        batiments: mappedData,
        required_fields: requiredFields  // Envoyer les champs requis
      });

      setImportResults(response);
      setStep(4);

      toast({
        title: "Import termin√©",
        description: `${response.success_count} b√¢timent(s) import√©(s) avec succ√®s`
      });

    } catch (error) {
      console.error('Erreur import:', error);
      toast({
        title: "Erreur d'import",
        description: error.message || "Une erreur s'est produite lors de l'import",
        variant: "destructive"
      });
    } finally {
      setImporting(false);
    }
  };

  // Composant √©diteur de champs
  const FieldEditor = () => {
    const [editingFields, setEditingFields] = useState([...availableFields]);
    const [newField, setNewField] = useState({ key: '', label: '', required: false });

    const addField = () => {
      if (!newField.key || !newField.label) {
        toast({
          title: "Validation",
          description: "Veuillez remplir la cl√© et le label du champ",
          variant: "destructive"
        });
        return;
      }

      // V√©rifier que la cl√© n'existe pas d√©j√†
      if (editingFields.some(f => f.key === newField.key)) {
        toast({
          title: "Erreur",
          description: "Un champ avec cette cl√© existe d√©j√†",
          variant: "destructive"
        });
        return;
      }

      setEditingFields([...editingFields, { ...newField }]);
      setNewField({ key: '', label: '', required: false });
    };

    const removeField = (key) => {
      setEditingFields(editingFields.filter(f => f.key !== key));
    };

    const updateField = (key, updates) => {
      setEditingFields(editingFields.map(f => 
        f.key === key ? { ...f, ...updates } : f
      ));
    };

    const handleSave = () => {
      if (editingFields.length === 0) {
        toast({
          title: "Erreur",
          description: "Vous devez avoir au moins un champ",
          variant: "destructive"
        });
        return;
      }

      saveCustomFields(editingFields);
      setShowFieldEditor(false);
    };

    return (
      <div className="field-editor-overlay">
        <div className="field-editor-modal">
          <div className="modal-header">
            <h3>‚öôÔ∏è Personnaliser les champs d'import</h3>
            <button 
              className="close-btn" 
              onClick={() => setShowFieldEditor(false)}
            >
              ‚úï
            </button>
          </div>

          <div className="modal-content">
            {/* Liste des champs existants */}
            <div className="existing-fields">
              <h4>Champs actuels ({editingFields.length})</h4>
              <p className="helper-text">üí° Cochez "Obligatoire" pour les champs qui doivent absolument √™tre remplis lors de l'import.</p>
              <div className="fields-list">
                {editingFields.map((field, index) => (
                  <div key={field.key} className={`field-item ${field.required ? 'required-field-item' : ''}`}>
                    <div className="field-number">{index + 1}</div>
                    <div className="field-details">
                      <input
                        type="text"
                        value={field.label}
                        onChange={(e) => updateField(field.key, { label: e.target.value })}
                        placeholder="Label du champ"
                        className="field-label-input"
                      />
                      <code className="field-key">{field.key}</code>
                    </div>
                    <label className={`field-required-toggle ${field.required ? 'required-active' : ''}`}>
                      <input
                        type="checkbox"
                        checked={field.required}
                        onChange={(e) => updateField(field.key, { required: e.target.checked })}
                      />
                      <span className="toggle-text">
                        {field.required ? '‚úÖ Obligatoire' : '‚ö™ Optionnel'}
                      </span>
                    </label>
                    <button
                      onClick={() => removeField(field.key)}
                      className="remove-field-btn"
                      title="Supprimer ce champ"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                ))}
              </div>
            </div>

            {/* Ajouter un nouveau champ */}
            <div className="add-field-section">
              <h4>‚ûï Ajouter un nouveau champ</h4>
              <div className="add-field-form">
                <div className="add-field-inputs">
                  <input
                    type="text"
                    value={newField.key}
                    onChange={(e) => setNewField({ ...newField, key: e.target.value.toLowerCase().replace(/\s+/g, '_') })}
                    placeholder="Cl√© (ex: contact_urgence)"
                    className="field-key-input"
                  />
                  <input
                    type="text"
                    value={newField.label}
                    onChange={(e) => setNewField({ ...newField, label: e.target.value })}
                    placeholder="Label (ex: Contact d'urgence)"
                    className="field-label-input"
                  />
                </div>
                <label className={`field-required-toggle ${newField.required ? 'required-active' : ''}`}>
                  <input
                    type="checkbox"
                    checked={newField.required}
                    onChange={(e) => setNewField({ ...newField, required: e.target.checked })}
                  />
                  <span className="toggle-text">
                    {newField.required ? '‚úÖ Obligatoire' : '‚ö™ Optionnel'}
                  </span>
                </label>
                <Button size="sm" onClick={addField}>
                  ‚ûï Ajouter
                </Button>
              </div>
            </div>
          </div>

          <div className="modal-footer">
            <Button 
              variant="outline" 
              onClick={resetToDefaultFields}
            >
              üîÑ R√©initialiser par d√©faut
            </Button>
            <div className="footer-actions">
              <Button 
                variant="outline" 
                onClick={() => setShowFieldEditor(false)}
              >
                Annuler
              </Button>
              <Button onClick={handleSave}>
                üíæ Enregistrer
              </Button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderStep = () => {
    switch (step) {
      case 1:
        return (
          <div className="import-step">
            <div className="step-header">
              <h3>üìÅ √âtape 1: S√©lectionner le fichier</h3>
              <p>Choisissez votre fichier CSV, Excel, XML ou HTML contenant les donn√©es des b√¢timents</p>
            </div>

            <div className="file-upload-area">
              <input
                type="file"
                accept=".csv,.xlsx,.xls,.xml,.html,.htm"
                onChange={handleFileUpload}
                style={{ display: 'none' }}
                id="csv-upload"
              />
              <label htmlFor="csv-upload" className="file-upload-label">
                <div className="upload-icon">üìÑ</div>
                <div className="upload-text">
                  <strong>Cliquer pour s√©lectionner</strong> ou glisser votre fichier ici
                  <br />
                  <small>Formats accept√©s: .csv, .xlsx, .xls</small>
                </div>
              </label>
            </div>

            <div className="import-tips">
              <h4>üí° Conseils pour un import r√©ussi:</h4>
              <ul>
                <li>La premi√®re ligne doit contenir les en-t√™tes de colonnes</li>
                <li>Utilisez des noms de colonnes clairs (ex: "Nom", "Adresse", "Ville")</li>
                <li>Les champs requis: Nom √©tablissement, Adresse civique</li>
                <li>Encodage recommand√©: UTF-8</li>
                <li><strong>üíæ Nouveau:</strong> Vous pourrez d√©finir des valeurs par d√©faut pour tous les b√¢timents (ex: m√™me ville pour tous)</li>
              </ul>
            </div>
          </div>
        );

      case 2:
        return (
          <div className="import-step">
            <div className="step-header">
              <h3>üîó √âtape 2: Correspondance des colonnes</h3>
              <p>Associez les colonnes de votre fichier aux champs du syst√®me</p>
            </div>

            <div className="mapping-container">
              <div className="mapping-header">
                <div className="file-info">
                  üìä <strong>{uploadedFile?.name}</strong> - {csvData.length} ligne(s), {csvHeaders.length} colonne(s)
                </div>
                <Button 
                  size="sm" 
                  variant="outline" 
                  onClick={() => setShowFieldEditor(true)}
                >
                  ‚öôÔ∏è Personnaliser les champs
                </Button>
              </div>

              <div className="mapping-info-box">
                <p>üí° <strong>Astuce:</strong> Utilisez la colonne "Valeur par d√©faut" pour appliquer une m√™me valeur √† toutes les lignes import√©es. Par exemple, si tous vos b√¢timents sont dans la m√™me ville, entrez le nom de la ville dans "Valeur par d√©faut" au lieu de l'ajouter dans le CSV.</p>
                <p><small>‚ö†Ô∏è La valeur par d√©faut √©crase toujours les donn√©es du CSV si les deux sont renseign√©s.</small></p>
              </div>

              <div className="mapping-table">
                <div className="mapping-row header">
                  <div className="field-column">Champ syst√®me</div>
                  <div className="arrow-column">‚û°Ô∏è</div>
                  <div className="csv-column">Colonne CSV</div>
                  <div className="default-value-column">üíæ Valeur par d√©faut (saisie de masse)</div>
                  <div className="preview-column">Aper√ßu donn√©es</div>
                </div>

                {availableFields.map(field => (
                  <div key={field.key} className="mapping-row">
                    <div className="field-column">
                      <span className={field.required ? 'required-field' : 'optional-field'}>
                        {field.label}
                        {field.required && <span className="required-star"> *</span>}
                      </span>
                    </div>
                    <div className="arrow-column">‚û°Ô∏è</div>
                    <div className="csv-column">
                      <select
                        value={columnMapping[field.key] || ''}
                        onChange={(e) => handleColumnMapping(e.target.value, field.key)}
                        className="mapping-select"
                        disabled={!!defaultValues[field.key]}
                      >
                        <option value="">-- S√©lectionner une colonne --</option>
                        {csvHeaders.map(header => (
                          <option key={header} value={header}>{header}</option>
                        ))}
                      </select>
                    </div>
                    <div className="default-value-column">
                      <input
                        type="text"
                        value={defaultValues[field.key] || ''}
                        onChange={(e) => handleDefaultValue(field.key, e.target.value)}
                        placeholder="Ex: Montr√©al (appliqu√© √† toutes les lignes)"
                        className="default-value-input"
                      />
                    </div>
                    <div className="preview-column">
                      {defaultValues[field.key] ? (
                        <span className="preview-data default-preview">
                          <strong>{defaultValues[field.key]}</strong> (toutes)
                        </span>
                      ) : columnMapping[field.key] && csvData[0] ? (
                        <span className="preview-data">
                          {csvData[0][columnMapping[field.key]] || '(vide)'}
                        </span>
                      ) : (
                        <span className="no-preview">-</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              <div className="mapping-actions">
                <Button variant="outline" onClick={() => setStep(1)}>
                  ‚Üê Retour
                </Button>
                <Button onClick={generatePreview}>
                  Aper√ßu donn√©es ‚Üí
                </Button>
              </div>
            </div>
          </div>
        );

      case 3:
        return (
          <div className="import-step">
            <div className="step-header">
              <h3>üëÄ √âtape 3: Aper√ßu des donn√©es</h3>
              <p>V√©rifiez que les donn√©es sont correctement mapp√©es avant l'import</p>
            </div>

            <div className="preview-container">
              <div className="preview-info">
                üìã Aper√ßu des <strong>5 premi√®res lignes</strong> sur {csvData.length} total
              </div>

              <div className="preview-table-wrapper">
                <table className="preview-table-enhanced">
                  <thead>
                    <tr>
                      <th className="row-number-header">#</th>
                      {availableFields.map(field => (
                        <th key={field.key} className={field.required ? 'required-header' : ''}>
                          {field.label}
                          {field.required && <span className="required-star"> *</span>}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {previewData.map((row, index) => (
                      <tr key={index}>
                        <td className="row-number">{index + 1}</td>
                        {availableFields.map(field => (
                          <td key={field.key} className="preview-data-cell">
                            {row[field.key] ? (
                              <span className={defaultValues[field.key] ? 'default-value-indicator' : 'csv-value-indicator'}>
                                {row[field.key]}
                              </span>
                            ) : (
                              <span className="empty-cell">(vide)</span>
                            )}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="preview-legend">
                <div className="legend-item">
                  <span className="legend-badge default-badge">Bleu</span>
                  <span>Valeur par d√©faut (appliqu√©e √† toutes les lignes)</span>
                </div>
                <div className="legend-item">
                  <span className="legend-badge csv-badge">Vert</span>
                  <span>Valeur du fichier CSV</span>
                </div>
              </div>

              <div className="preview-actions">
                <Button variant="outline" onClick={() => setStep(2)}>
                  ‚Üê Modifier mapping
                </Button>
                <Button 
                  onClick={handleImport}
                  disabled={importing}
                  className="import-confirm-btn"
                >
                  {importing ? '‚è≥ Import en cours...' : '‚úÖ Confirmer import'}
                </Button>
              </div>
            </div>
          </div>
        );

      case 4:
        return (
          <div className="import-step">
            <div className="step-header">
              <h3>üéâ Import termin√©</h3>
            </div>

            {importResults && (
              <div className="import-results">
                <div className="results-summary">
                  <div className="result-stat success">
                    <div className="stat-number">{importResults.success_count}</div>
                    <div className="stat-label">Import√©s avec succ√®s</div>
                  </div>
                  {importResults.error_count > 0 && (
                    <div className="result-stat error">
                      <div className="stat-number">{importResults.error_count}</div>
                      <div className="stat-label">Erreurs</div>
                    </div>
                  )}
                </div>

                {importResults.errors && importResults.errors.length > 0 && (
                  <div className="import-errors">
                    <h4>‚ö†Ô∏è Lignes avec erreurs:</h4>
                    <ul>
                      {importResults.errors.map((error, index) => (
                        <li key={index}>
                          Ligne {error.row}: {error.message}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                <div className="final-actions">
                  <Button 
                    onClick={onImportComplete}
                    className="finish-btn"
                  >
                    üìã Voir les b√¢timents
                  </Button>
                  <Button 
                    variant="outline"
                    onClick={() => {
                      setStep(1);
                      setUploadedFile(null);
                      setCsvData([]);
                      setColumnMapping({});
                      setImportResults(null);
                    }}
                  >
                    üîÑ Nouvel import
                  </Button>
                </div>
              </div>
            )}
          </div>
        );

      default:
        return <div>√âtape inconnue</div>;
    }
  };

  return (
    <div className="import-csv-container">
      {showFieldEditor && <FieldEditor />}
      
      <div className="import-progress">
        <div className="progress-steps">
          {[1, 2, 3, 4].map(stepNum => (
            <div 
              key={stepNum} 
              className={`progress-step ${step >= stepNum ? 'active' : ''} ${step === stepNum ? 'current' : ''}`}
            >
              <div className="step-circle">{stepNum}</div>
              <div className="step-label">
                {stepNum === 1 && 'Upload'}
                {stepNum === 2 && 'Mapping'}
                {stepNum === 3 && 'Preview'}
                {stepNum === 4 && 'Import'}
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="import-content">
        {renderStep()}
      </div>
    </div>
  );
};

// Gestion des Grilles d'Inspection
const EditerGrille = ({ grille, onClose, onSave }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [formData, setFormData] = useState({
    nom: grille.nom,
    groupe_occupation: grille.groupe_occupation || '',
    sections: grille.sections || [],
    actif: grille.actif !== false,
    version: grille.version || '1.0'
  });
  const [saving, setSaving] = useState(false);

  const addSection = () => {
    setFormData({
      ...formData,
      sections: [...formData.sections, { titre: '', questions: [] }]
    });
  };

  const removeSection = (index) => {
    setFormData({
      ...formData,
      sections: formData.sections.filter((_, i) => i !== index)
    });
  };

  const updateSection = (index, field, value) => {
    const newSections = [...formData.sections];
    newSections[index] = { ...newSections[index], [field]: value };
    setFormData({ ...formData, sections: newSections });
  };

  const addQuestion = (sectionIndex) => {
    const newSections = [...formData.sections];
    newSections[sectionIndex].questions = [...(newSections[sectionIndex].questions || []), ''];
    setFormData({ ...formData, sections: newSections });
  };

  const removeQuestion = (sectionIndex, questionIndex) => {
    const newSections = [...formData.sections];
    newSections[sectionIndex].questions = newSections[sectionIndex].questions.filter((_, i) => i !== questionIndex);
    setFormData({ ...formData, sections: newSections });
  };

  const updateQuestion = (sectionIndex, questionIndex, value) => {
    const newSections = [...formData.sections];
    newSections[sectionIndex].questions[questionIndex] = value;
    setFormData({ ...formData, sections: newSections });
  };

  const handleSave = async () => {
    if (!formData.nom) {
      toast({
        title: "Validation",
        description: "Le nom de la grille est requis",
        variant: "destructive"
      });
      return;
    }

    if (formData.sections.length === 0) {
      toast({
        title: "Validation",
        description: "La grille doit contenir au moins une section",
        variant: "destructive"
      });
      return;
    }

    try {
      setSaving(true);
      await apiPut(tenantSlug, `/prevention/grilles-inspection/${grille.id}`, formData);
      
      toast({
        title: "Succ√®s",
        description: "Grille mise √† jour avec succ√®s"
      });
      
      onSave();
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder la grille",
        variant: "destructive"
      });
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="editer-grille-container">
      <div className="page-header">
        <h2>‚úèÔ∏è Modifier la Grille: {grille.nom}</h2>
        <div className="header-actions">
          <Button variant="outline" onClick={onClose}>
            ‚úï Annuler
          </Button>
          <Button onClick={handleSave} disabled={saving}>
            {saving ? 'Sauvegarde...' : 'üíæ Enregistrer'}
          </Button>
        </div>
      </div>

      <div className="grille-form">
        {/* Informations g√©n√©rales */}
        <div className="form-section">
          <h3>Informations G√©n√©rales</h3>
          <div className="form-grid">
            <div className="form-field">
              <label>Nom de la grille *</label>
              <input
                type="text"
                value={formData.nom}
                onChange={(e) => setFormData({ ...formData, nom: e.target.value })}
                className="form-input"
                placeholder="Ex: Grille R√©sidentielle Personnalis√©e"
              />
            </div>
            <div className="form-field">
              <label>Groupe d'occupation</label>
              <select
                value={formData.groupe_occupation}
                onChange={(e) => setFormData({ ...formData, groupe_occupation: e.target.value })}
                className="form-select"
              >
                <option value="">-- S√©lectionner --</option>
                <option value="A">A - Habitation</option>
                <option value="B">B - Soins et d√©tention</option>
                <option value="C">C - R√©sidentiel</option>
                <option value="D">D - Affaires</option>
                <option value="E">E - Commerce</option>
                <option value="F">F - Industriel</option>
                <option value="I">I - Assembl√©e</option>
              </select>
            </div>
            <div className="form-field">
              <label>Version</label>
              <input
                type="text"
                value={formData.version}
                onChange={(e) => setFormData({ ...formData, version: e.target.value })}
                className="form-input"
                placeholder="1.0"
              />
            </div>
            <div className="form-field checkbox-field">
              <label>
                <input
                  type="checkbox"
                  checked={formData.actif}
                  onChange={(e) => setFormData({ ...formData, actif: e.target.checked })}
                />
                <span>Grille active</span>
              </label>
            </div>
          </div>
        </div>

        {/* Sections */}
        <div className="form-section">
          <div className="section-header">
            <h3>Sections ({formData.sections.length})</h3>
            <Button size="sm" onClick={addSection}>
              ‚ûï Ajouter une section
            </Button>
          </div>

          <div className="sections-list">
            {formData.sections.map((section, sectionIndex) => (
              <div key={sectionIndex} className="section-editor">
                <div className="section-editor-header">
                  <h4>Section {sectionIndex + 1}</h4>
                  <Button 
                    size="sm" 
                    variant="outline"
                    onClick={() => removeSection(sectionIndex)}
                  >
                    üóëÔ∏è Supprimer section
                  </Button>
                </div>

                <div className="section-editor-content">
                  <div className="form-field">
                    <label>Titre de la section *</label>
                    <input
                      type="text"
                      value={section.titre}
                      onChange={(e) => updateSection(sectionIndex, 'titre', e.target.value)}
                      className="form-input"
                      placeholder="Ex: Voies d'√©vacuation"
                    />
                  </div>

                  <div className="questions-editor">
                    <div className="questions-header">
                      <label>Questions ({section.questions?.length || 0})</label>
                      <Button 
                        size="sm" 
                        variant="outline"
                        onClick={() => addQuestion(sectionIndex)}
                      >
                        ‚ûï Ajouter question
                      </Button>
                    </div>

                    <div className="questions-list-editor">
                      {(section.questions || []).map((question, questionIndex) => (
                        <div key={questionIndex} className="question-editor-item">
                          <span className="question-number">{questionIndex + 1}.</span>
                          <input
                            type="text"
                            value={question}
                            onChange={(e) => updateQuestion(sectionIndex, questionIndex, e.target.value)}
                            className="question-input"
                            placeholder="Entrez votre question..."
                          />
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => removeQuestion(sectionIndex, questionIndex)}
                            className="remove-question-btn"
                          >
                            ‚úï
                          </Button>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {formData.sections.length === 0 && (
            <div className="empty-state">
              <p>Aucune section. Cliquez sur "Ajouter une section" pour commencer.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const GrillesInspection = () => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [grilles, setGrilles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [editingGrille, setEditingGrille] = useState(null);
  const [viewingTemplate, setViewingTemplate] = useState(null);
  const [creatingFromTemplate, setCreatingFromTemplate] = useState(null);

  const fetchGrilles = async () => {
    try {
      setLoading(true);
      const data = await apiGet(tenantSlug, '/prevention/grilles-inspection');
      setGrilles(data);
    } catch (error) {
      console.error('Erreur chargement grilles:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les grilles d'inspection",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchGrilles();
  }, [tenantSlug]);

  const handleDeleteGrille = async (grilleId) => {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette grille ?')) return;
    
    try {
      await apiDelete(tenantSlug, `/prevention/grilles-inspection/${grilleId}`);
      toast({
        title: "Succ√®s",
        description: "Grille supprim√©e avec succ√®s"
      });
      fetchGrilles();
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer la grille",
        variant: "destructive"
      });
    }
  };

  // Modal de pr√©visualisation du template
  if (viewingTemplate) {
    return (
      <TemplatePreviewModal 
        template={viewingTemplate}
        onClose={() => setViewingTemplate(null)}
        onUse={(template) => {
          setViewingTemplate(null);
          setCreatingFromTemplate(template);
        }}
      />
    );
  }

  // √âdition d'une grille √† partir d'un template
  if (creatingFromTemplate) {
    return (
      <EditerGrilleFromTemplate 
        template={creatingFromTemplate}
        onClose={() => setCreatingFromTemplate(null)}
        onSave={() => {
          setCreatingFromTemplate(null);
          fetchGrilles();
        }}
      />
    );
  }

  // √âdition d'une grille existante
  if (editingGrille) {
    return <EditerGrille grille={editingGrille} onClose={() => setEditingGrille(null)} onSave={() => { setEditingGrille(null); fetchGrilles(); }} />;
  }

  if (loading) {
    return <div className="loading">Chargement des grilles...</div>;
  }

  return (
    <div className="grilles-inspection-container">
      {/* Grilles disponibles */}
      <div className="default-grilles-section">
        <h3>üìã Grilles d'Inspection Disponibles</h3>
        <p>Grilles d'inspection configur√©es pour votre service selon le Code de s√©curit√© du Qu√©bec</p>
        
        {grilles.length === 0 && (
          <div style={{ 
            padding: '2rem', 
            textAlign: 'center', 
            backgroundColor: '#fef3c7', 
            border: '2px solid #fcd34d',
            borderRadius: '8px',
            margin: '1rem 0'
          }}>
            <p style={{ fontSize: '1.125rem', marginBottom: '1rem' }}>‚ö†Ô∏è Aucune grille d'inspection configur√©e</p>
            <p style={{ color: '#92400e', marginBottom: '1rem' }}>
              Pour utiliser le module de pr√©vention, vous devez d'abord initialiser les grilles d'inspection standards.
            </p>
            <Button 
              onClick={async () => {
                try {
                  setLoading(true);
                  await apiPost(tenantSlug, '/prevention/initialiser', {});
                  toast({
                    title: "Succ√®s",
                    description: "7 grilles d'inspection cr√©√©es avec succ√®s"
                  });
                  fetchGrilles();
                } catch (error) {
                  toast({
                    title: "Erreur",
                    description: error.response?.data?.detail || "Impossible d'initialiser les grilles",
                    variant: "destructive"
                  });
                } finally {
                  setLoading(false);
                }
              }}
            >
              üöÄ Initialiser les 7 grilles standards
            </Button>
          </div>
        )}
        
        <div className="default-grilles-grid">
          {grilles.map(grille => (
            <div key={grille.id} className="template-card">
              <div className="template-header">
                <h4>{grille.groupe_occupation ? `Groupe ${grille.groupe_occupation}` : 'Grille personnalis√©e'}</h4>
                {grille.groupe_occupation && <span className="groupe-badge">{grille.groupe_occupation}</span>}
              </div>
              <div className="template-info">
                <p><strong>{grille.nom}</strong></p>
                <p>{grille.description || 'Grille d\'inspection personnalis√©e'}</p>
                <div className="template-stats">
                  <span className="stat">{grille.sections?.length || 0} sections</span>
                  <span className="stat">{grille.sections?.reduce((acc, s) => acc + (s.questions?.length || 0), 0) || 0} questions</span>
                </div>
                {grille.sous_types && grille.sous_types.length > 0 && (
                  <div style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: '#6b7280' }}>
                    Sous-types: {grille.sous_types.join(', ')}
                  </div>
                )}
              </div>
              <div className="template-actions">
                <Button 
                  size="sm" 
                  onClick={() => setViewingTemplate(grille)}
                >
                  üëÄ Aper√ßu
                </Button>
                <Button 
                  size="sm" 
                  variant="outline"
                  onClick={() => setEditingGrille(grille)}
                >
                  üìù Modifier
                </Button>
                <Button 
                  size="sm" 
                  variant="outline"
                  onClick={async () => {
                    if (!confirm('Dupliquer cette grille pour cr√©er une variante?')) return;
                    const nouveauNom = prompt('Nom de la nouvelle grille:', `${grille.nom} (Copie)`);
                    if (!nouveauNom) return;
                    
                    try {
                      await apiPost(tenantSlug, `/prevention/grilles-inspection/${grille.id}/dupliquer?nouveau_nom=${encodeURIComponent(nouveauNom)}`, {});
                      toast({
                        title: "Succ√®s",
                        description: "Grille dupliqu√©e avec succ√®s"
                      });
                      fetchGrilles();
                    } catch (error) {
                      toast({
                        title: "Erreur",
                        description: "Impossible de dupliquer la grille",
                        variant: "destructive"
                      });
                    }
                  }}
                >
                  üìã Dupliquer
                </Button>
                <Button 
                  size="sm" 
                  variant="destructive"
                  onClick={() => handleDeleteGrille(grille.id)}
                >
                  üóëÔ∏è Supprimer
                </Button>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Note informative */}
      <div style={{
        marginTop: '2rem',
        padding: '1rem',
        backgroundColor: '#f0f9ff',
        border: '1px solid #bae6fd',
        borderRadius: '8px'
      }}>
        <p style={{ fontSize: '0.875rem', color: '#0369a1' }}>
          ‚ÑπÔ∏è <strong>Astuce</strong>: Les grilles peuvent √™tre dupliqu√©es pour cr√©er des variantes adapt√©es √† vos besoins sp√©cifiques.
          Les sous-types permettent d'afficher des questions conditionnelles lors des inspections.
        </p>
      </div>

      {/* Anciennes grilles personnalis√©es supprim√©es - maintenant toutes les grilles sont dans la m√™me liste */}
      <div style={{ display: 'none' }}>
        {/* Section supprim√©e - grilles personnalis√©es fusionn√©es avec grilles principales */}
        <div className="custom-grilles-section">
          <h3>üõ†Ô∏è Grilles Personnalis√©es</h3>
          <div className="empty-state">
            <p>Section fusionn√©e avec grilles principales ci-dessus</p>
          </div>
        </div>
      </div>

      {/* Reste du code inchang√© - ne pas modifier */}
      <div style={{ display: 'none' }}>
        {grilles.length > 0 && (
          <div className="custom-grilles-grid">
            {grilles.map(grille => (
              <div key={grille.id} className="grille-card">
                <div className="grille-header">
                  <h4>{grille.nom}</h4>
                  <span className="groupe-badge">{grille.groupe_occupation}</span>
                </div>
                <div className="grille-info">
                  <p>Version: {grille.version}</p>
                  <p>Sections: {grille.sections?.length || 0}</p>
                  <p>Statut: {grille.actif ? '‚úÖ Actif' : '‚ùå Inactif'}</p>
                </div>
                <div className="grille-actions">
                  <Button size="sm" onClick={() => setEditingGrille(grille)}>Modifier</Button>
                  <Button 
                    size="sm" 
                    variant="outline"
                    onClick={() => handleDeleteGrille(grille.id)}
                  >
                    Supprimer
                  </Button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* L'aper√ßu s'ouvre maintenant dans un modal au clic */}
    </div>
  );

};

// Modal de pr√©visualisation du template
const TemplatePreviewModal = ({ template, onClose, onUse }) => {
  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000,
      padding: '2rem'
    }}>
      <div style={{
        backgroundColor: 'white',
        borderRadius: '8px',
        maxWidth: '900px',
        maxHeight: '80vh',
        width: '100%',
        overflow: 'hidden',
        display: 'flex',
        flexDirection: 'column'
      }}>
        {/* Header */}
        <div style={{
          padding: '1.5rem',
          borderBottom: '1px solid #e5e7eb',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <div>
            <h2 style={{ fontSize: '1.5rem', fontWeight: '600', marginBottom: '0.5rem' }}>
              üìã Grille Template - Groupe {template.groupe}
            </h2>
            <p style={{ color: '#6b7280' }}>{template.nom}</p>
            <p style={{ fontSize: '0.875rem', color: '#9ca3af' }}>{template.description}</p>
          </div>
          <button
            onClick={onClose}
            style={{
              padding: '0.5rem',
              border: 'none',
              background: 'none',
              fontSize: '1.5rem',
              cursor: 'pointer',
              color: '#6b7280'
            }}
          >
            ‚úï
          </button>
        </div>

        {/* Content */}
        <div style={{
          flex: 1,
          overflow: 'auto',
          padding: '1.5rem'
        }}>
          <div style={{ marginBottom: '1rem', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '6px' }}>
            <strong>üìä Statistiques:</strong>
            <div style={{ marginTop: '0.5rem', display: 'flex', gap: '1rem' }}>
              <span>üóÇÔ∏è {template.sections.length} sections</span>
              <span>‚ùì {template.sections.reduce((acc, s) => acc + s.questions.length, 0)} questions</span>
            </div>
          </div>

          {template.sections.map((section, idx) => (
            <div key={idx} style={{
              marginBottom: '1.5rem',
              padding: '1rem',
              border: '1px solid #e5e7eb',
              borderRadius: '6px'
            }}>
              <h4 style={{ fontSize: '1.125rem', fontWeight: '600', marginBottom: '0.5rem' }}>
                {section.titre}
              </h4>
              {section.description && (
                <p style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '1rem', fontStyle: 'italic' }}>
                  {section.description}
                </p>
              )}
              
              <div style={{ paddingLeft: '1rem' }}>
                {section.questions.map((q, qIdx) => (
                  <div key={qIdx} style={{
                    padding: '0.5rem 0',
                    borderBottom: qIdx < section.questions.length - 1 ? '1px solid #f3f4f6' : 'none'
                  }}>
                    <span style={{ fontSize: '0.875rem' }}>
                      {qIdx + 1}. {q.question}
                    </span>
                    <span style={{
                      marginLeft: '0.5rem',
                      fontSize: '0.75rem',
                      color: '#9ca3af',
                      fontStyle: 'italic'
                    }}>
                      ({q.type})
                    </span>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>

        {/* Footer */}
        <div style={{
          padding: '1rem 1.5rem',
          borderTop: '1px solid #e5e7eb',
          display: 'flex',
          justifyContent: 'flex-end',
          gap: '0.5rem'
        }}>
          <Button variant="outline" onClick={onClose}>
            Fermer
          </Button>
          <Button onClick={() => onUse(template)}>
            üìù Utiliser & Personnaliser
          </Button>
        </div>
      </div>
    </div>
  );
};

// √âditeur de grille depuis template (avec questions pr√©-remplies)
const EditerGrilleFromTemplate = ({ template, onClose, onSave }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [formData, setFormData] = useState({
    nom: `${template.nom} (Personnalis√©e)`,
    groupe_occupation: template.groupe,
    sections: JSON.parse(JSON.stringify(template.sections)), // Deep copy
    actif: true,
    version: "1.0"
  });
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    if (!formData.nom) {
      toast({
        title: "Validation",
        description: "Le nom de la grille est requis",
        variant: "destructive"
      });
      return;
    }

    try {
      setSaving(true);
      await apiPost(tenantSlug, '/prevention/grilles-inspection', formData);
      
      toast({
        title: "Succ√®s",
        description: "Grille cr√©√©e avec succ√®s"
      });
      
      onSave();
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder la grille",
        variant: "destructive"
      });
    } finally {
      setSaving(false);
    }
  };

  const addSection = () => {
    setFormData({
      ...formData,
      sections: [...formData.sections, { titre: '', description: '', questions: [] }]
    });
  };

  const removeSection = (index) => {
    const newSections = formData.sections.filter((_, i) => i !== index);
    setFormData({ ...formData, sections: newSections });
  };

  const updateSection = (index, field, value) => {
    const newSections = [...formData.sections];
    newSections[index] = { ...newSections[index], [field]: value };
    setFormData({ ...formData, sections: newSections });
  };

  const addQuestion = (sectionIndex) => {
    const newSections = [...formData.sections];
    newSections[sectionIndex].questions = [
      ...(newSections[sectionIndex].questions || []),
      { question: '', type: 'choix', options: ['Conforme', 'Non-conforme', 'S.O.'] }
    ];
    setFormData({ ...formData, sections: newSections });
  };

  const removeQuestion = (sectionIndex, questionIndex) => {
    const newSections = [...formData.sections];
    newSections[sectionIndex].questions = newSections[sectionIndex].questions.filter((_, i) => i !== questionIndex);
    setFormData({ ...formData, sections: newSections });
  };

  const updateQuestion = (sectionIndex, questionIndex, field, value) => {
    const newSections = [...formData.sections];
    newSections[sectionIndex].questions[questionIndex] = {
      ...newSections[sectionIndex].questions[questionIndex],
      [field]: value
    };
    setFormData({ ...formData, sections: newSections });
  };

  return (
    <div className="editer-grille-container">
      <div className="page-header">
        <h2>‚úèÔ∏è Personnaliser: {template.nom}</h2>
        <div className="header-actions">
          <Button variant="outline" onClick={onClose}>
            ‚úï Annuler
          </Button>
          <Button onClick={handleSave} disabled={saving}>
            {saving ? '‚è≥ Sauvegarde...' : 'üíæ Enregistrer'}
          </Button>
        </div>
      </div>

      <div className="grille-form">
        {/* Informations g√©n√©rales */}
        <div className="form-section">
          <h3>Informations G√©n√©rales</h3>
          <div className="form-grid">
            <div className="form-field">
              <label>Nom de la grille *</label>
              <input
                type="text"
                value={formData.nom}
                onChange={(e) => setFormData({ ...formData, nom: e.target.value })}
                className="form-input"
                placeholder="Ex: Grille R√©sidentielle Personnalis√©e"
              />
            </div>
            <div className="form-field">
              <label>Groupe d'occupation</label>
              <select
                value={formData.groupe_occupation}
                onChange={(e) => setFormData({ ...formData, groupe_occupation: e.target.value })}
                className="form-select"
              >
                <option value="">-- S√©lectionner --</option>
                <option value="A">A - √âtablissements de r√©union</option>
                <option value="B">B - Soins ou d√©tention</option>
                <option value="C">C - R√©sidentiel</option>
                <option value="D">D - Affaires et services personnels</option>
                <option value="E">E - Commercial</option>
                <option value="F">F - Industriel</option>
                <option value="G">G - Agricole</option>
              </select>
            </div>
          </div>

          {/* Info sur les sous-types */}
          {formData.groupe_occupation && (
            <div style={{
              marginTop: '1rem',
              padding: '1rem',
              backgroundColor: '#eff6ff',
              borderLeft: '4px solid #3b82f6',
              borderRadius: '4px'
            }}>
              <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem' }}>
                <span style={{ fontSize: '1.25rem' }}>‚ÑπÔ∏è</span>
                <div>
                  <strong style={{ fontSize: '0.875rem', display: 'block', marginBottom: '0.5rem' }}>
                    Grille Universelle avec Questions Conditionnelles
                  </strong>
                  <p style={{ fontSize: '0.875rem', color: '#1e40af', marginBottom: '0.5rem' }}>
                    Cette grille s'adapte automatiquement selon le <strong>sous-type du b√¢timent</strong> lors de l'inspection.
                    Les questions non pertinentes seront masqu√©es.
                  </p>
                  
                  {formData.groupe_occupation === 'C' && (
                    <div style={{ fontSize: '0.75rem', color: '#1e3a8a', marginTop: '0.5rem' }}>
                      <strong>Sous-types support√©s :</strong> Unifamiliale, Bifamiliale, Multifamiliale (3-8), Multifamiliale (9+), Copropri√©t√©, Maison mobile
                    </div>
                  )}
                  {formData.groupe_occupation === 'E' && (
                    <div style={{ fontSize: '0.75rem', color: '#1e3a8a', marginTop: '0.5rem' }}>
                      <strong>Sous-types support√©s :</strong> Bureau, Magasin, Restaurant, H√¥tel, Centre commercial
                    </div>
                  )}
                  {formData.groupe_occupation === 'F' && (
                    <div style={{ fontSize: '0.75rem', color: '#1e3a8a', marginTop: '0.5rem' }}>
                      <strong>Sous-types support√©s :</strong> Manufacture l√©g√®re, Manufacture lourde, Entrep√¥t, Usine, Atelier
                    </div>
                  )}
                  {formData.groupe_occupation === 'B' && (
                    <div style={{ fontSize: '0.75rem', color: '#1e3a8a', marginTop: '0.5rem' }}>
                      <strong>Sous-types support√©s :</strong> √âcole, H√¥pital, CHSLD, Centre communautaire, √âglise, Biblioth√®que
                    </div>
                  )}
                  {formData.groupe_occupation === 'G' && (
                    <div style={{ fontSize: '0.75rem', color: '#1e3a8a', marginTop: '0.5rem' }}>
                      <strong>Sous-types support√©s :</strong> Ferme, Grange, Serre, √âcurie, Silo
                    </div>
                  )}
                  
                  <div style={{ 
                    marginTop: '0.75rem', 
                    padding: '0.5rem',
                    backgroundColor: 'white',
                    borderRadius: '4px',
                    fontSize: '0.75rem',
                    color: '#059669'
                  }}>
                    ‚úÖ <strong>Comment √ßa marche :</strong><br/>
                    1. Le sous-type est d√©fini sur le <strong>b√¢timent</strong> (dans le modal b√¢timent)<br/>
                    2. Lors de l'inspection, seules les questions pertinentes s'affichent<br/>
                    3. Vous pouvez ajouter des conditions aux questions (ex: "condition: multi_9 || copropriete")
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Option: Grille sp√©cifique √† un sous-type */}
          <details style={{ marginTop: '1rem' }}>
            <summary style={{ 
              cursor: 'pointer', 
              fontSize: '0.875rem',
              color: '#3b82f6',
              padding: '0.5rem',
              backgroundColor: '#f9fafb',
              borderRadius: '4px'
            }}>
              üîß Option Avanc√©e : Cr√©er une grille sp√©cifique √† un sous-type
            </summary>
            <div style={{ 
              marginTop: '0.5rem', 
              padding: '1rem',
              border: '1px solid #e5e7eb',
              borderRadius: '4px',
              backgroundColor: '#fefce8'
            }}>
              <p style={{ fontSize: '0.875rem', marginBottom: '0.5rem' }}>
                ‚ö†Ô∏è Par d√©faut, une grille s'applique √† TOUS les sous-types d'un groupe.
              </p>
              <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.75rem' }}>
                Si vous voulez cr√©er une grille qui ne s'applique qu'√† un sous-type sp√©cifique 
                (ex: uniquement pour Maisons mobiles), ajoutez un suffixe clair au nom.
              </p>
              <div className="form-field">
                <label style={{ fontSize: '0.875rem' }}>Sous-type cible (optionnel)</label>
                <input
                  type="text"
                  value={formData.sous_type_cible || ''}
                  onChange={(e) => setFormData({ ...formData, sous_type_cible: e.target.value })}
                  placeholder="Ex: maison_mobile, hotel, manufacture_legere"
                  style={{
                    width: '100%',
                    padding: '0.5rem',
                    border: '1px solid #e5e7eb',
                    borderRadius: '4px',
                    fontSize: '0.875rem'
                  }}
                />
                <p style={{ fontSize: '0.75rem', color: '#6b7280', marginTop: '0.25rem' }}>
                  Laissez vide pour une grille universelle (recommand√©)
                </p>
              </div>
            </div>
          </details>
        </div>

        {/* Sections et questions */}
        <div className="form-section">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
            <h3>Sections et Questions</h3>
            <Button size="sm" onClick={addSection}>
              ‚ûï Ajouter une section
            </Button>
          </div>

          {formData.sections.map((section, sectionIndex) => (
            <div key={sectionIndex} className="section-editor" style={{
              border: '1px solid #e5e7eb',
              borderRadius: '8px',
              padding: '1rem',
              marginBottom: '1rem',
              backgroundColor: '#f9fafb'
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                <h4>Section {sectionIndex + 1}</h4>
                <Button 
                  size="sm" 
                  variant="outline"
                  onClick={() => removeSection(sectionIndex)}
                >
                  üóëÔ∏è Supprimer section
                </Button>
              </div>

              <div className="form-field">
                <label>Titre de la section *</label>
                <input
                  type="text"
                  value={section.titre}
                  onChange={(e) => updateSection(sectionIndex, 'titre', e.target.value)}
                  className="form-input"
                  placeholder="Ex: Voies d'√©vacuation"
                />
              </div>

              <div className="form-field">
                <label>Description</label>
                <textarea
                  value={section.description || ''}
                  onChange={(e) => updateSection(sectionIndex, 'description', e.target.value)}
                  className="form-textarea"
                  placeholder="Description optionnelle de la section"
                  rows={2}
                />
              </div>

              {/* Questions */}
              <div style={{ marginTop: '1rem' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                  <strong>Questions:</strong>
                  <Button 
                    size="sm" 
                    variant="outline"
                    onClick={() => addQuestion(sectionIndex)}
                  >
                    ‚ûï Ajouter question
                  </Button>
                </div>

                {section.questions && section.questions.map((question, qIndex) => (
                  <div key={qIndex} style={{
                    backgroundColor: 'white',
                    padding: '1rem',
                    borderRadius: '6px',
                    marginBottom: '0.5rem',
                    border: '1px solid #e5e7eb'
                  }}>
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
                      <input
                        type="text"
                        value={question.question}
                        onChange={(e) => updateQuestion(sectionIndex, qIndex, 'question', e.target.value)}
                        placeholder="Texte de la question"
                        style={{
                          flex: 1,
                          padding: '0.5rem',
                          border: '1px solid #e5e7eb',
                          borderRadius: '4px'
                        }}
                      />
                      <select
                        value={question.type}
                        onChange={(e) => updateQuestion(sectionIndex, qIndex, 'type', e.target.value)}
                        style={{
                          padding: '0.5rem',
                          border: '1px solid #e5e7eb',
                          borderRadius: '4px'
                        }}
                      >
                        <option value="choix">Choix multiple</option>
                        <option value="texte">Texte libre</option>
                        <option value="photos">Photos</option>
                      </select>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => removeQuestion(sectionIndex, qIndex)}
                      >
                        üóëÔ∏è
                      </Button>
                    </div>

                    {/* Photos de r√©f√©rence - optionnel pour guider l'inspecteur */}
                    <div style={{ marginTop: '0.5rem' }}>
                      <details style={{ fontSize: '0.875rem' }}>
                        <summary style={{ cursor: 'pointer', color: '#3b82f6' }}>
                          üì∑ Photos de r√©f√©rence (optionnel)
                        </summary>
                        <div style={{ 
                          marginTop: '0.5rem', 
                          padding: '0.75rem', 
                          backgroundColor: '#f9fafb',
                          borderRadius: '4px'
                        }}>
                          <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '0.5rem' }}>
                            Ajoutez des photos/sch√©mas pour aider l'inspecteur (ex: localisation extincteur, sch√©ma technique)
                          </p>
                          <input
                            type="file"
                            accept="image/*"
                            multiple
                            onChange={(e) => {
                              const files = Array.from(e.target.files);
                              // Pour l'instant, on stocke juste les noms
                              // TODO: Upload vers serveur et stocker URLs
                              const photoNames = files.map(f => f.name);
                              updateQuestion(sectionIndex, qIndex, 'photos_reference', [
                                ...(question.photos_reference || []),
                                ...photoNames
                              ]);
                            }}
                            style={{ fontSize: '0.75rem', marginBottom: '0.5rem' }}
                          />
                          
                          {question.photos_reference && question.photos_reference.length > 0 && (
                            <div style={{ marginTop: '0.5rem' }}>
                              <strong style={{ fontSize: '0.75rem' }}>Photos ajout√©es:</strong>
                              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginTop: '0.25rem' }}>
                                {question.photos_reference.map((photo, pIdx) => (
                                  <div key={pIdx} style={{
                                    padding: '0.25rem 0.5rem',
                                    backgroundColor: 'white',
                                    border: '1px solid #e5e7eb',
                                    borderRadius: '4px',
                                    fontSize: '0.75rem',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.25rem'
                                  }}>
                                    üìé {photo}
                                    <button
                                      onClick={() => {
                                        const newPhotos = question.photos_reference.filter((_, i) => i !== pIdx);
                                        updateQuestion(sectionIndex, qIndex, 'photos_reference', newPhotos);
                                      }}
                                      style={{
                                        border: 'none',
                                        background: 'none',
                                        cursor: 'pointer',
                                        color: '#ef4444',
                                        fontSize: '0.875rem'
                                      }}
                                    >
                                      ‚úï
                                    </button>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </details>
                    </div>

                    {/* Champ observations si non-conforme */}
                    <div style={{ marginTop: '0.5rem' }}>
                      <label style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '0.5rem',
                        fontSize: '0.875rem',
                        color: '#6b7280'
                      }}>
                        <input
                          type="checkbox"
                          checked={question.photo_requise_si_non_conforme || false}
                          onChange={(e) => updateQuestion(sectionIndex, qIndex, 'photo_requise_si_non_conforme', e.target.checked)}
                        />
                        üì∏ Photo obligatoire si non-conforme
                      </label>
                    </div>

                    {/* Condition d'affichage */}
                    <details style={{ marginTop: '0.5rem' }}>
                      <summary style={{ 
                        cursor: 'pointer',
                        fontSize: '0.75rem',
                        color: '#9ca3af'
                      }}>
                        üîÄ Question conditionnelle (avanc√©)
                      </summary>
                      <div style={{ 
                        marginTop: '0.5rem',
                        padding: '0.5rem',
                        backgroundColor: '#fef3c7',
                        borderRadius: '4px'
                      }}>
                        <label style={{ fontSize: '0.75rem', display: 'block', marginBottom: '0.25rem' }}>
                          Condition d'affichage
                        </label>
                        <input
                          type="text"
                          value={question.condition || ''}
                          onChange={(e) => updateQuestion(sectionIndex, qIndex, 'condition', e.target.value)}
                          placeholder="Ex: multi_9 || copropriete"
                          style={{
                            width: '100%',
                            padding: '0.25rem',
                            border: '1px solid #e5e7eb',
                            borderRadius: '4px',
                            fontSize: '0.75rem'
                          }}
                        />
                        <p style={{ fontSize: '0.65rem', color: '#92400e', marginTop: '0.25rem' }}>
                          Utilisez les sous-types: unifamiliale, bifamiliale, multi_3_8, multi_9, copropriete, maison_mobile, bureau, magasin, restaurant, hotel, etc.
                          <br/>Op√©rateurs: || (OU), && (ET)
                          <br/>Laissez vide pour afficher toujours
                        </p>
                        {question.condition && (
                          <div style={{ 
                            marginTop: '0.5rem',
                            padding: '0.25rem 0.5rem',
                            backgroundColor: '#dcfce7',
                            borderRadius: '4px',
                            fontSize: '0.65rem',
                            color: '#166534'
                          }}>
                            ‚úì Cette question s'affichera seulement pour: <strong>{question.condition}</strong>
                          </div>
                        )}
                      </div>
                    </details>

                    {question.type === 'photos' && (
                      <p style={{ fontSize: '0.75rem', color: '#6b7280', fontStyle: 'italic', marginTop: '0.5rem' }}>
                        üí° Type "Photos": L'inspecteur pourra prendre plusieurs photos librement
                      </p>
                    )}
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

const CreateGrilleInspection = ({ onSave, onViewTemplates }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [formData, setFormData] = useState({
    nom: '',
    groupe_occupation: '',
    sections: [],
    actif: true,
    version: '1.0'
  });
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    if (!formData.nom || !formData.groupe_occupation) {
      toast({
        title: "Validation",
        description: "Veuillez remplir tous les champs requis",
        variant: "destructive"
      });
      return;
    }

    try {
      setSaving(true);
      await apiPost(tenantSlug, '/prevention/grilles-inspection', formData);
      
      toast({
        title: "Succ√®s",
        description: "Grille cr√©√©e avec succ√®s"
      });
      
      onSave();
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de cr√©er la grille",
        variant: "destructive"
      });
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="create-grille-container">
      <div className="grille-form">
        <div className="form-section">
          <h3>‚ÑπÔ∏è Informations de base</h3>
          <div className="form-fields">
            <div className="form-field">
              <label>Nom de la grille *</label>
              <input
                type="text"
                value={formData.nom}
                onChange={(e) => setFormData({...formData, nom: e.target.value})}
                placeholder="Ex: Inspection Commerciale D√©taill√©e"
              />
            </div>
            <div className="form-field">
              <label>Groupe d'occupation *</label>
              <select
                value={formData.groupe_occupation}
                onChange={(e) => setFormData({...formData, groupe_occupation: e.target.value})}
              >
                <option value="">S√©lectionner un groupe</option>
                <option value="A">Groupe A - R√©sidentiel unifamilial</option>
                <option value="B">Groupe B - Soins et d√©tention</option>
                <option value="C">Groupe C - R√©sidentiel</option>
                <option value="D">Groupe D - Affaires et services personnels</option>
                <option value="E">Groupe E - Commerce</option>
                <option value="F">Groupe F - Industriel</option>
                <option value="G">Groupe G - Garages et stations-service</option>
                <option value="H">Groupe H - Risques √©lev√©s</option>
                <option value="I">Groupe I - Assembl√©e</option>
              </select>
            </div>
          </div>
        </div>

        <div className="form-section">
          <h3>üìù Recommandation</h3>
          <div className="recommendation-note">
            <p>üí° <strong>Pour commencer rapidement :</strong></p>
            <p>Nous recommandons d'utiliser les <strong>grilles templates</strong> pr√©-configur√©es selon le Code de s√©curit√© du Qu√©bec. Vous pourrez ensuite les personnaliser selon vos besoins.</p>
            <Button 
              variant="outline"
              onClick={onViewTemplates}
            >
              üìã Voir les templates disponibles
            </Button>
          </div>
        </div>

        <div className="form-actions">
          <Button variant="outline" onClick={onSave}>
            Annuler
          </Button>
          <Button 
            onClick={handleSave}
            disabled={saving}
          >
            {saving ? 'Cr√©ation...' : 'Cr√©er la grille'}
          </Button>
        </div>
      </div>
    </div>
  );
};

// Templates de grilles d'inspection par d√©faut
const DEFAULT_GRILLES_TEMPLATES = [
  {
    groupe: "C",
    nom: "R√©sidentiel - Habitation",
    description: "Maisons unifamiliales, duplex, immeubles r√©sidentiels",
    sections: [
      {
        titre: "1. Informations G√©n√©rales & Contacts",
        description: "Identification compl√®te de l'√©tablissement et des responsables",
        questions: [
          { question: "Plan de mesures d'urgence en cas d'incendie affich√©?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Plan √† jour et exerc√© dans la derni√®re ann√©e?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Permis d'occupation valide affich√©?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Notes g√©n√©rales", type: "texte" },
          { question: "Photos", type: "photos" }
        ]
      },
      {
        titre: "2. Documentation & Plans",
        description: "V√©rification de la documentation obligatoire",
        questions: [
          { question: "Plans d'√©vacuation affich√©s et visibles?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Registres d'entretien tenus √† jour?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Notes sur la documentation", type: "texte" }
        ]
      },
      {
        titre: "3. Voies d'√âvacuation & Sorties",
        description: "V√©rification des moyens d'√©vacuation et de leur accessibilit√©",
        questions: [
          { question: "Nombre de sorties suffisant et bien r√©parties?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Panneaux 'SORTIE' clairs et √©clair√©s?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Portes de sortie faciles √† ouvrir de l'int√©rieur?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "D√©gagements libres de tout encombrement?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "√âclairage de s√©curit√© fonctionnel?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Photos des voies d'√©vacuation", type: "photos" }
        ]
      },
      {
        titre: "4. Moyens de Protection Incendie",
        description: "V√©rification des √©quipements de protection contre l'incendie",
        questions: [
          { question: "D√©tecteurs de fum√©e pr√©sents et fonctionnels?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Date de fabrication des d√©tecteurs < 10 ans?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "D√©tecteurs CO pr√©sents si applicable?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Extincteurs pr√©sents et accessibles?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Inspection mensuelle extincteurs √† jour?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Photos des √©quipements", type: "photos" }
        ]
      },
      {
        titre: "5. Risques Sp√©cifiques",
        description: "√âvaluation des risques particuliers selon l'occupation",
        questions: [
          { question: "D√©gagement libre devant panneau √©lectrique (1m)?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Aucun fil √©lectrique d√©nud√© visible?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Appareils √† combustible: d√©gagements respect√©s?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Conduits d'√©vacuation en bon √©tat?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Photos des risques identifi√©s", type: "photos" }
        ]
      },
      {
        titre: "6. Accessibilit√© Services d'Incendie",
        description: "V√©rification de l'accessibilit√© pour les v√©hicules d'urgence",
        questions: [
          { question: "Adresse civique visible de la rue?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Voie d'acc√®s d√©gag√©e pour v√©hicules d'urgence?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Poteau d'incendie d√©gag√© et accessible?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      }
    ]
  },
  {
    groupe: "E",
    nom: "Commerce - √âtablissements commerciaux",
    description: "Magasins, centres commerciaux, bureaux commerciaux",
    sections: [
      {
        titre: "1. Informations G√©n√©rales & Contacts",
        description: "Identification compl√®te de l'√©tablissement commercial",
        questions: [
          { question: "Plan de mesures d'urgence affich√© et accessible?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Responsable s√©curit√© incendie identifi√©?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Permis d'occupation commercial valide?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Formation du personnel sur √©vacuation?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "2. Documentation & Plans",
        description: "Documentation sp√©cifique aux √©tablissements commerciaux",
        questions: [
          { question: "Plans d'√©vacuation affich√©s √† chaque √©tage?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Registre des exercices d'√©vacuation?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Certificats des syst√®mes de protection √† jour?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "3. Voies d'√âvacuation & Sorties",
        description: "Moyens d'√©vacuation pour occupation commerciale",
        questions: [
          { question: "Sorties de secours d√©gag√©es et signalis√©es?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Largeur des d√©gagements conforme au nombre d'occupants?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Portes √©quip√©es de dispositifs anti-panique?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "√âclairage d'urgence test√© mensuellement?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Aucun stockage dans les d√©gagements?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "4. Moyens de Protection Incendie",
        description: "Syst√®mes de protection sp√©cifiques aux commerces",
        questions: [
          { question: "Syst√®me d'alarme incendie fonctionnel?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "D√©tecteurs de fum√©e dans toutes les zones?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Extincteurs appropri√©s au type de risque?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me de gicleurs (si requis) op√©rationnel?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Robinets d'incendie arm√©s accessibles?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "5. Risques Sp√©cifiques",
        description: "Risques particuliers aux activit√©s commerciales",
        questions: [
          { question: "Stockage respecte les distances de s√©curit√©?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Piles de marchandises stables et limit√©es en hauteur?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "S√©paration des produits incompatibles?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Zones de livraison d√©gag√©es?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me √©lectrique conforme et entretenu?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "6. Accessibilit√© Services d'Incendie",
        description: "Acc√®s pour intervention en milieu commercial",
        questions: [
          { question: "Signalisation claire pour identification du b√¢timent?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Acc√®s v√©hicules lourds possible et d√©gag√©?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Bo√Æte √† cl√©s (Knox Box) install√©e si requise?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Plan d'intervention disponible sur site?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      }
    ]
  },
  {
    groupe: "F",
    nom: "Industriel - √âtablissements industriels",
    description: "Usines, ateliers, entrep√¥ts industriels",
    sections: [
      {
        titre: "1. Informations G√©n√©rales & Contacts",
        description: "Information sur l'√©tablissement industriel et ses activit√©s",
        questions: [
          { question: "Plan d'intervention d'urgence d√©taill√© disponible?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "√âquipe de s√©curit√© incendie form√©e et d√©sign√©e?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Permis pour mati√®res dangereuses √† jour?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Formation du personnel sur les risques sp√©cifiques?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "2. Documentation & Plans",
        description: "Documentation technique et r√©glementaire",
        questions: [
          { question: "Fiches de donn√©es de s√©curit√© (FDS) disponibles?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Plans des installations avec localisation des risques?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Registres de maintenance des √©quipements?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Permis de travaux √† chaud √† jour?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "3. Voies d'√âvacuation & Sorties",
        description: "Moyens d'√©vacuation pour milieu industriel",
        questions: [
          { question: "Sorties d'urgence adapt√©es aux effectifs?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Chemins d'√©vacuation clairement marqu√©s?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Portes coupe-feu maintenues ferm√©es automatiquement?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "√âclairage de s√©curit√© conforme aux zones √† risques?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Points de rassemblement ext√©rieurs identifi√©s?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "4. Moyens de Protection Incendie",
        description: "Syst√®mes de protection industrielle",
        questions: [
          { question: "Syst√®me d'alarme automatique fonctionnel?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me de d√©tection adapt√© aux risques?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Extincteurs sp√©cialis√©s selon les risques pr√©sents?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me fixe d'extinction (mousse, CO2) op√©rationnel?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "R√©seau de gicleurs industriel fonctionnel?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Colonne s√®che et raccords normalis√©s?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "5. Risques Sp√©cifiques",
        description: "Risques industriels particuliers",
        questions: [
          { question: "Mati√®res dangereuses stock√©es selon les normes?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Aires de stockage avec r√©tention appropri√©e?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "√âquipements √©lectriques adapt√©s aux zones?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me de ventilation et √©vacuation des fum√©es?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Travaux √† chaud avec surveillance appropri√©e?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Nettoyage r√©gulier des zones d'accumulation?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "6. Accessibilit√© Services d'Incendie",
        description: "Acc√®s sp√©cialis√© pour intervention industrielle",
        questions: [
          { question: "Acc√®s pompiers avec v√©hicules sp√©cialis√©s?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Plan d'intervention d√©taill√© remis aux pompiers?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me de communication d'urgence op√©rationnel?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Moyens d'approvisionnement en eau suffisants?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      }
    ]
  },
  {
    groupe: "I",
    nom: "Assembl√©e - Lieux de rassemblement",
    description: "√âcoles, th√©√¢tres, centres communautaires, √©glises",
    sections: [
      {
        titre: "1. Informations G√©n√©rales & Contacts",
        description: "Gestion s√©curit√© pour lieux d'assembl√©e",
        questions: [
          { question: "Plan d'√©vacuation affich√© dans toutes les zones?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Responsable √©vacuation d√©sign√© pour chaque √©v√©nement?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Capacit√© maximale d'occupation respect√©e?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Personnel form√© aux proc√©dures d'urgence?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "2. Documentation & Plans",
        description: "Documentation pour gestion des foules",
        questions: [
          { question: "Plans d'√©vacuation adapt√©s au type d'assembl√©e?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Proc√©dures d'urgence communiqu√©es au public?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Registre des exercices d'√©vacuation?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "3. Voies d'√âvacuation & Sorties",
        description: "√âvacuation s√©curitaire des grandes assembl√©es",
        questions: [
          { question: "Nombre de sorties conforme √† l'occupation?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Largeur des sorties proportionnelle aux occupants?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Portes s'ouvrent dans le sens de l'√©vacuation?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "√âclairage d'urgence sur tous les parcours?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Aisles et d√©gagements libres pendant les √©v√©nements?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "4. Moyens de Protection Incendie",
        description: "Protection adapt√©e aux assembl√©es",
        questions: [
          { question: "Syst√®me d'alarme audible dans tout le b√¢timent?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me de sonorisation pour annonces d'urgence?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "D√©tection automatique dans toutes les zones?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Extincteurs accessibles et visibles?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Syst√®me de gicleurs dans les zones de rassemblement?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "5. Risques Sp√©cifiques",
        description: "Risques li√©s aux activit√©s d'assembl√©e",
        questions: [
          { question: "Si√®ges et rang√©es fix√©es selon les normes?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Sc√®ne et d√©cors avec mat√©riaux ignifuges?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "√âclairage de sc√®ne avec protection thermique?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Cuisine (si pr√©sente) avec syst√®me d'extinction?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Contr√¥le du tabagisme respect√©?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      },
      {
        titre: "6. Accessibilit√© Services d'Incendie",
        description: "Acc√®s pour intervention lors d'assembl√©es",
        questions: [
          { question: "Acc√®s prioritaire maintenu libre en tout temps?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Communication directe avec services d'urgence?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Plan du site remis aux services d'incendie?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] },
          { question: "Stationnement d'urgence r√©serv√© et signalis√©?", type: "choix", options: ["Conforme", "Non-conforme", "S.O."] }
        ]
      }
    ]
  }
];

// MapComponent avec Leaflet + OpenStreetMap (GRATUIT, sans cl√© API)
const MapComponent = ({ batiments, onBatimentClick }) => {
  const [mapReady, setMapReady] = useState(false);
  
  // Importer Leaflet CSS
  React.useEffect(() => {
    // Ajouter le CSS de Leaflet
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
    link.crossOrigin = '';
    document.head.appendChild(link);
    
    setMapReady(true);
    
    return () => {
      document.head.removeChild(link);
    };
  }, []);
  
  if (!mapReady) {
    return (
      <div style={{
        width: '100%',
        height: '100%',
        minHeight: '500px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        background: '#f9fafb',
        borderRadius: '8px',
        border: '1px solid #ddd'
      }}>
        <div style={{ fontSize: '48px', marginBottom: '20px' }}>üó∫Ô∏è</div>
        <div style={{ fontSize: '18px', fontWeight: '600', color: '#3b82f6' }}>
          Chargement de la carte...
        </div>
      </div>
    );
  }
  
  // Calculer le centre bas√© sur les b√¢timents
  let center = [45.4042, -71.8929]; // Shefford par d√©faut
  
  if (batiments && batiments.length > 0) {
    const batimentsAvecCoords = batiments.filter(b => b.latitude && b.longitude);
    if (batimentsAvecCoords.length > 0) {
      const avgLat = batimentsAvecCoords.reduce((sum, b) => sum + b.latitude, 0) / batimentsAvecCoords.length;
      const avgLng = batimentsAvecCoords.reduce((sum, b) => sum + b.longitude, 0) / batimentsAvecCoords.length;
      center = [avgLat, avgLng];
    }
  }
  
  return (
    <LeafletMap 
      batiments={batiments}
      center={center}
      onBatimentClick={onBatimentClick}
    />
  );
};

// Composant Leaflet s√©par√©
const LeafletMap = ({ batiments, center, onBatimentClick }) => {
  const { MapContainer, TileLayer, Marker, Popup, useMap } = require('react-leaflet');
  const L = require('leaflet');
  
  // Fix pour les ic√¥nes Leaflet
  delete L.Icon.Default.prototype._getIconUrl;
  L.Icon.Default.mergeOptions({
    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  });
  
  // Composant pour ajuster la vue aux marqueurs
  const FitBounds = ({ batiments }) => {
    const map = useMap();
    
    React.useEffect(() => {
      if (batiments && batiments.length > 0) {
        const batimentsAvecCoords = batiments.filter(b => b.latitude && b.longitude);
        if (batimentsAvecCoords.length > 0) {
          const bounds = batimentsAvecCoords.map(b => [b.latitude, b.longitude]);
          map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
        }
      }
    }, [batiments, map]);
    
    return null;
  };
  
  return (
    <div style={{ width: '100%', height: '100%', minHeight: '500px', borderRadius: '8px', overflow: 'hidden' }}>
      <MapContainer
        center={center}
        zoom={13}
        style={{ width: '100%', height: '100%', minHeight: '500px' }}
        scrollWheelZoom={true}
      >
        {/* OpenStreetMap tiles */}
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />
        
        {/* Marqueurs pour chaque b√¢timent */}
        {batiments && batiments.filter(b => b.latitude && b.longitude).map(batiment => (
          <Marker 
            key={batiment.id}
            position={[batiment.latitude, batiment.longitude]}
            eventHandlers={{
              click: () => {
                if (onBatimentClick) {
                  onBatimentClick(batiment);
                }
              }
            }}
          >
            <Popup>
              <div style={{ padding: '5px', maxWidth: '250px' }}>
                <h3 style={{ margin: '0 0 10px 0', fontSize: '15px', fontWeight: 'bold' }}>
                  {batiment.nom_etablissement || 'Sans nom'}
                </h3>
                <p style={{ margin: '5px 0', fontSize: '13px' }}>
                  <strong>Adresse:</strong> {batiment.adresse_civique || 'N/A'}
                </p>
                <p style={{ margin: '5px 0', fontSize: '13px' }}>
                  <strong>Ville:</strong> {batiment.ville || 'N/A'}
                </p>
                <p style={{ margin: '5px 0', fontSize: '13px' }}>
                  <strong>Groupe:</strong> {batiment.groupe_occupation || 'N/A'}
                </p>
                {batiment.preventionniste_assigne_id ? (
                  <p style={{ margin: '5px 0', fontSize: '13px', color: 'green' }}>
                    <strong>‚úì Pr√©ventionniste assign√©</strong>
                  </p>
                ) : (
                  <p style={{ margin: '5px 0', fontSize: '13px', color: 'orange' }}>
                    <strong>‚ö† Sans pr√©ventionniste</strong>
                  </p>
                )}
              </div>
            </Popup>
          </Marker>
        ))}
        
        <FitBounds batiments={batiments} />
      </MapContainer>
    </div>
  );
};

// Gestion des Pr√©ventionnistes
const GestionPreventionnistes = () => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [users, setUsers] = useState([]);
  const [batiments, setBatiments] = useState([]);
  const [secteurs, setSecteurs] = useState([]);
  const [preventionnistes, setPreventionnistes] = useState([]);
  const [loading, setLoading] = useState(false);
  const [viewMode, setViewMode] = useState('list'); // 'list' ou 'secteurs'
  const [editMode, setEditMode] = useState(false);
  const [showSecteurModal, setShowSecteurModal] = useState(false);
  const [currentSecteur, setCurrentSecteur] = useState(null);
  const [pendingGeometry, setPendingGeometry] = useState(null);

  const fetchData = async () => {
    try {
      setLoading(true);
      
      // Charger les pr√©ventionnistes avec l'endpoint d√©di√©
      const [preventionnistesData, usersData, batimentsData, secteursData] = await Promise.all([
        apiGet(tenantSlug, '/prevention/preventionnistes'),
        apiGet(tenantSlug, '/users'),
        apiGet(tenantSlug, '/prevention/batiments'),
        apiGet(tenantSlug, '/prevention/secteurs').catch(() => [])
      ]);
      
      setUsers(usersData);
      setBatiments(batimentsData);
      setSecteurs(secteursData || []);
      
      // Enrichir les pr√©ventionnistes avec leurs stats
      const preventionnistesEnrichis = await Promise.all(
        preventionnistesData.map(async (prev) => {
          try {
            const stats = await apiGet(tenantSlug, `/prevention/preventionnistes/${prev.id}/stats`);
            return { ...prev, stats };
          } catch (error) {
            console.error(`Erreur stats pour ${prev.id}:`, error);
            return { ...prev, stats: {} };
          }
        })
      );
      
      setPreventionnistes(preventionnistesEnrichis);
      
    } catch (error) {
      console.error('Erreur chargement donn√©es:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les donn√©es",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [tenantSlug]);

  const handleRemoveAssignment = async (batimentId) => {
    try {
      await apiPut(tenantSlug, `/prevention/batiments/${batimentId}`, {
        preventionniste_assigne_id: null
      });
      
      toast({
        title: "Succ√®s",
        description: "Assignation supprim√©e"
      });
      
      fetchData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer l'assignation",
        variant: "destructive"
      });
    }
  };

  // Gestion des secteurs
  const handleSecteurCreate = (geometry) => {
    setPendingGeometry(geometry);
    setCurrentSecteur(null);
    setShowSecteurModal(true);
  };

  const handleSecteurClick = (secteur) => {
    setCurrentSecteur(secteur);
    setPendingGeometry(null);
    setShowSecteurModal(true);
  };

  const handleSaveSecteur = async (secteurData) => {
    try {
      let secteurId;
      let geometry;
      
      if (currentSecteur) {
        // Mise √† jour - conserver la g√©om√©trie existante
        await apiPut(tenantSlug, `/prevention/secteurs/${currentSecteur.id}`, {
          ...secteurData,
          geometry: currentSecteur.geometry  // Garder la g√©om√©trie existante
        });
        secteurId = currentSecteur.id;
        geometry = currentSecteur.geometry;
        toast({
          title: "Succ√®s",
          description: "Secteur mis √† jour"
        });
      } else {
        // Cr√©ation - utiliser la g√©om√©trie nouvellement dessin√©e
        const response = await apiPost(tenantSlug, '/prevention/secteurs', {
          ...secteurData,
          geometry: pendingGeometry
        });
        console.log('üîç R√©ponse API cr√©ation secteur:', response);
        secteurId = response?.id || response?._id;
        geometry = pendingGeometry;
        toast({
          title: "Succ√®s",
          description: "Secteur cr√©√©"
        });
      }
      
      // Le champ du formulaire s'appelle preventionniste_assigne_id
      const preventionnisteId = secteurData.preventionniste_assigne_id || secteurData.preventionniste_id;
      console.log('üéØ Assignation - secteurId:', secteurId, 'preventionnisteId:', preventionnisteId, 'geometry:', geometry);
      
      // Utiliser l'endpoint backend d√©di√© pour assigner le pr√©ventionniste au secteur
      // Cet endpoint s'occupe aussi d'assigner automatiquement tous les b√¢timents du secteur
      if (preventionnisteId) {
        try {
          const response = await apiPut(tenantSlug, `/prevention/secteurs/${secteurId}/assigner`, {
            preventionniste_id: preventionnisteId,
            assigner_batiments: true
          });
          
          toast({
            title: "Assignation r√©ussie",
            description: `Secteur et ${response.nb_batiments_assignes || 0} b√¢timent(s) assign√©s au pr√©ventionniste`
          });
        } catch (error) {
          console.error('Erreur assignation secteur:', error);
          toast({
            title: "Avertissement",
            description: "Secteur sauvegard√© mais erreur lors de l'assignation",
            variant: "warning"
          });
        }
      }
      
      // Fermer le modal et rafra√Æchir les donn√©es
      setShowSecteurModal(false);
      setCurrentSecteur(null);
      setPendingGeometry(null);
      
      // Rafra√Æchir toutes les donn√©es apr√®s l'assignation
      await fetchData();
    } catch (error) {
      console.error('Erreur sauvegarde secteur:', error);
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder le secteur",
        variant: "destructive"
      });
    }
  };
  
  // Fonction pour assigner les b√¢timents dans un secteur au pr√©ventionniste
  const assignBatimentsToSecteur = async (secteurId, preventionnisteId, geometry) => {
    try {
      console.log('üîç D√©but assignation - secteurId:', secteurId, 'preventionnisteId:', preventionnisteId);
      console.log('üîç Geometry:', geometry);
      console.log('üîç Total b√¢timents:', batiments.length);
      
      // V√©rifier quels b√¢timents sont dans le secteur (calcul c√¥t√© client)
      const batimentsInSecteur = batiments.filter(batiment => {
        if (!batiment.latitude || !batiment.longitude) {
          console.log('‚ùå B√¢timent sans coordonn√©es:', batiment.nom_etablissement);
          return false;
        }
        
        // V√©rifier si le point est dans le polygone
        const point = [batiment.longitude, batiment.latitude];
        const isInside = isPointInPolygon(point, geometry.coordinates[0]);
        console.log(`${isInside ? '‚úÖ' : '‚ùå'} ${batiment.nom_etablissement}: [${point[0]}, ${point[1]}]`);
        return isInside;
      });
      
      console.log(`üéØ ${batimentsInSecteur.length} b√¢timents trouv√©s dans le secteur:`, batimentsInSecteur.map(b => b.nom_etablissement));
      
      // Assigner chaque b√¢timent au pr√©ventionniste
      let assignedCount = 0;
      for (const batiment of batimentsInSecteur) {
        try {
          await apiPut(tenantSlug, `/prevention/batiments/${batiment.id}`, {
            ...batiment,
            secteur_id: secteurId,
            preventionniste_assigne_id: preventionnisteId  // Utiliser le bon nom de champ
          });
          assignedCount++;
          console.log(`‚úÖ B√¢timent assign√©: ${batiment.nom_etablissement}`);
        } catch (err) {
          console.error(`‚ùå Erreur assignation ${batiment.nom_etablissement}:`, err);
        }
      }
      
      if (assignedCount > 0) {
        toast({
          title: "Assignation r√©ussie",
          description: `${assignedCount} b√¢timent(s) assign√©(s) au pr√©ventionniste`
        });
      } else {
        toast({
          title: "Information",
          description: "Aucun b√¢timent trouv√© dans ce secteur"
        });
      }
    } catch (error) {
      console.error('Erreur assignation b√¢timents:', error);
      toast({
        title: "Erreur",
        description: "Erreur lors de l'assignation des b√¢timents",
        variant: "destructive"
      });
    }
  };
  
  // Fonction pour v√©rifier si un point est dans un polygone (algorithme ray-casting)
  const isPointInPolygon = (point, polygon) => {
    const x = point[0], y = point[1];
    let inside = false;
    
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i][0], yi = polygon[i][1];
      const xj = polygon[j][0], yj = polygon[j][1];
      
      const intersect = ((yi > y) !== (yj > y))
        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      
      if (intersect) inside = !inside;
    }
    
    return inside;
  };

  const handleDeleteSecteur = async (secteurId) => {
    if (!window.confirm('√ätes-vous s√ªr de vouloir supprimer ce secteur ?')) {
      return;
    }
    
    try {
      await apiDelete(tenantSlug, `/prevention/secteurs/${secteurId}`);
      toast({
        title: "Succ√®s",
        description: "Secteur supprim√©"
      });
      setShowSecteurModal(false);
      setCurrentSecteur(null);
      fetchData();
    } catch (error) {
      toast({
        title: "Erreur",
        description: "Impossible de supprimer le secteur",
        variant: "destructive"
      });
    }
  };

  if (loading) {
    return <div className="loading">Chargement...</div>;
  }

  return (
    <div className="gestion-preventionnistes">
      {/* Vue d'ensemble */}
      <div className="overview-cards">
        <div className="overview-card">
          <div className="card-icon">üë®‚Äçüöí</div>
          <div className="card-content">
            <div className="card-number">{preventionnistes.length}</div>
            <div className="card-label">Pr√©ventionnistes actifs</div>
          </div>
        </div>
        <div className="overview-card">
          <div className="card-icon">üè¢</div>
          <div className="card-content">
            <div className="card-number">{batiments.filter(b => b.preventionniste_assigne_id).length}</div>
            <div className="card-label">B√¢timents assign√©s</div>
          </div>
        </div>
        <div className="overview-card">
          <div className="card-icon">‚ö†Ô∏è</div>
          <div className="card-content">
            <div className="card-number">{batiments.filter(b => !b.preventionniste_assigne_id).length}</div>
            <div className="card-label">Sans pr√©ventionniste</div>
          </div>
        </div>
      </div>

      {/* Toggle Vue Liste / Secteurs */}
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        gap: '10px', 
        margin: '20px 0',
        padding: '10px',
        backgroundColor: '#f5f5f5',
        borderRadius: '8px'
      }}>
        <button
          onClick={() => setViewMode('list')}
          style={{
            padding: '10px 20px',
            backgroundColor: viewMode === 'list' ? '#2563eb' : '#fff',
            color: viewMode === 'list' ? '#fff' : '#333',
            border: '1px solid #ddd',
            borderRadius: '6px',
            cursor: 'pointer',
            fontWeight: viewMode === 'list' ? 'bold' : 'normal',
            transition: 'all 0.3s'
          }}
        >
          üìã Vue Liste
        </button>
        <button
          onClick={() => {
            setViewMode('secteurs');
            setEditMode(false);
          }}
          style={{
            padding: '10px 20px',
            backgroundColor: viewMode === 'secteurs' ? '#2563eb' : '#fff',
            color: viewMode === 'secteurs' ? '#fff' : '#333',
            border: '1px solid #ddd',
            borderRadius: '6px',
            cursor: 'pointer',
            fontWeight: viewMode === 'secteurs' ? 'bold' : 'normal',
            transition: 'all 0.3s'
          }}
        >
          üó∫Ô∏è Secteurs ({secteurs.length})
        </button>
      </div>

      {/* Vue Carte */}
      {/* Vue Secteurs */}
      {viewMode === 'secteurs' && (
        <div className="secteurs-section" style={{ marginBottom: '20px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
            <h3 style={{ margin: 0 }}>üó∫Ô∏è Gestion des Secteurs G√©ographiques</h3>
            <button
              onClick={() => setEditMode(!editMode)}
              style={{
                padding: '8px 16px',
                backgroundColor: editMode ? '#dc2626' : '#10b981',
                color: '#fff',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer',
                fontWeight: 'bold',
                fontSize: '14px'
              }}
            >
              {editMode ? '‚ùå Quitter le mode √©dition' : '‚úèÔ∏è Activer le mode √©dition'}
            </button>
          </div>
          
          {editMode && (
            <div style={{
              padding: '12px',
              backgroundColor: '#eff6ff',
              border: '1px solid #3b82f6',
              borderRadius: '6px',
              marginBottom: '15px'
            }}>
              <p style={{ margin: '0 0 8px 0', fontWeight: 'bold', color: '#1e40af' }}>
                üìù Mode √©dition activ√©
              </p>
              <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '14px', color: '#1e40af' }}>
                <li>Cliquez sur l'ic√¥ne polygone en haut √† droite pour dessiner un secteur</li>
                <li>Cliquez sur l'ic√¥ne crayon pour modifier un secteur existant</li>
                <li>Cliquez sur l'ic√¥ne corbeille pour supprimer un secteur</li>
              </ul>
            </div>
          )}
          
          <SecteursMap
            batiments={batiments}
            secteurs={secteurs.map(s => ({
              ...s,
              preventionniste_assigne_nom: users.find(u => u.id === s.preventionniste_assigne_id)
                ? `${users.find(u => u.id === s.preventionniste_assigne_id).prenom} ${users.find(u => u.id === s.preventionniste_assigne_id).nom}`
                : null
            }))}
            center={[45.4042, -71.8929]}
            onBatimentClick={(batiment) => {
              console.log('B√¢timent cliqu√©:', batiment);
            }}
            onSecteurCreate={handleSecteurCreate}
            onSecteurClick={handleSecteurClick}
            editMode={editMode}
          />
          
          <p style={{ 
            marginTop: '10px', 
            fontSize: '14px', 
            color: '#666',
            textAlign: 'center'
          }}>
            {editMode ? 'Utilisez les outils en haut √† droite pour cr√©er, modifier ou supprimer des secteurs' : 'Cliquez sur un secteur pour voir ses d√©tails'}
          </p>
          
          {/* Liste des secteurs */}
          <div style={{ marginTop: '30px' }}>
            <h4 style={{ marginBottom: '15px' }}>üìã Secteurs configur√©s ({secteurs.length})</h4>
            {secteurs.length === 0 ? (
              <div style={{
                padding: '20px',
                textAlign: 'center',
                backgroundColor: '#f9fafb',
                borderRadius: '8px',
                color: '#666'
              }}>
                <p>Aucun secteur cr√©√©</p>
                <p style={{ fontSize: '14px', marginTop: '8px' }}>
                  Activez le mode √©dition et dessinez votre premier secteur sur la carte
                </p>
              </div>
            ) : (
              <div style={{ display: 'grid', gap: '15px', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))' }}>
                {secteurs.map(secteur => {
                  const preventionniste = users.find(u => u.id === secteur.preventionniste_assigne_id);
                  return (
                    <div
                      key={secteur.id}
                      onClick={() => handleSecteurClick(secteur)}
                      style={{
                        padding: '15px',
                        borderLeft: `4px solid ${secteur.couleur || '#3b82f6'}`,
                        backgroundColor: '#fff',
                        borderRadius: '6px',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.15)';
                        e.currentTarget.style.transform = 'translateY(-2px)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                        e.currentTarget.style.transform = 'translateY(0)';
                      }}
                    >
                      <h5 style={{ margin: '0 0 8px 0', fontSize: '16px', fontWeight: 'bold' }}>
                        {secteur.nom}
                      </h5>
                      {secteur.description && (
                        <p style={{ margin: '0 0 8px 0', fontSize: '14px', color: '#666' }}>
                          {secteur.description}
                        </p>
                      )}
                      <div style={{ fontSize: '14px', marginTop: '8px' }}>
                        {preventionniste ? (
                          <span style={{ 
                            display: 'inline-block',
                            padding: '4px 8px',
                            backgroundColor: '#d1fae5',
                            color: '#065f46',
                            borderRadius: '4px',
                            fontSize: '13px'
                          }}>
                            üë®‚Äçüöí {preventionniste.prenom} {preventionniste.nom}
                          </span>
                        ) : (
                          <span style={{ 
                            display: 'inline-block',
                            padding: '4px 8px',
                            backgroundColor: '#fef3c7',
                            color: '#92400e',
                            borderRadius: '4px',
                            fontSize: '13px'
                          }}>
                            ‚ö† Sans pr√©ventionniste
                          </span>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      )}


      {/* Vue Liste */}
      {viewMode === 'list' && (
        <>
          {/* Liste des pr√©ventionnistes */}
          <div className="preventionnistes-section">
        <h3>üë®‚Äçüöí Pr√©ventionnistes Actifs</h3>
        
        {preventionnistes.length === 0 ? (
          <div className="empty-state">
            <p>Aucun pr√©ventionniste assign√©</p>
            <p><small>Assignez des b√¢timents aux employ√©s pour cr√©er des pr√©ventionnistes</small></p>
          </div>
        ) : (
          <div className="preventionnistes-grid">
            {preventionnistes.map(preventionniste => {
              const batimentsAssignes = batiments.filter(b => b.preventionniste_assigne_id === preventionniste.id);
              const stats = preventionniste.stats || {};
              const secteursAssignes = secteurs.filter(s => s.preventionniste_assigne_id === preventionniste.id);
              
              return (
                <div key={preventionniste.id} className="preventionniste-card" style={{
                  border: '1px solid #e5e7eb',
                  borderRadius: '12px',
                  padding: '1.5rem',
                  backgroundColor: 'white',
                  boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                }}>
                  <div className="preventionniste-header" style={{ marginBottom: '1rem' }}>
                    <div className="preventionniste-info" style={{ marginBottom: '1rem' }}>
                      <h4 style={{ 
                        fontSize: '1.25rem', 
                        fontWeight: 'bold', 
                        color: '#1e293b',
                        marginBottom: '0.5rem'
                      }}>
                        üë®‚Äçüöí {preventionniste.prenom} {preventionniste.nom}
                      </h4>
                      <p style={{ color: '#64748b', fontSize: '0.9rem', margin: '0.25rem 0' }}>
                        üìß {preventionniste.email}
                      </p>
                      <span className="grade-badge" style={{
                        display: 'inline-block',
                        padding: '0.25rem 0.75rem',
                        backgroundColor: '#3b82f6',
                        color: 'white',
                        borderRadius: '999px',
                        fontSize: '0.85rem',
                        fontWeight: '500',
                        marginTop: '0.5rem'
                      }}>
                        {preventionniste.grade}
                      </span>
                    </div>
                    
                    <div className="preventionniste-stats" style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(3, 1fr)',
                      gap: '0.75rem',
                      padding: '0.75rem',
                      backgroundColor: '#f8fafc',
                      borderRadius: '8px',
                      marginBottom: '1rem'
                    }}>
                      <div className="stat-item" style={{ 
                        textAlign: 'center',
                        padding: '0.5rem',
                        minWidth: 0
                      }}>
                        <div className="stat-number" style={{
                          fontSize: '1.25rem',
                          fontWeight: 'bold',
                          color: '#3b82f6',
                          marginBottom: '0.25rem'
                        }}>
                          {stats.batiments_assignes || batimentsAssignes.length}
                        </div>
                        <div className="stat-label" style={{
                          fontSize: '0.7rem',
                          color: '#64748b',
                          textTransform: 'uppercase',
                          fontWeight: '500'
                        }}>
                          B√¢timents
                        </div>
                      </div>
                      <div className="stat-item" style={{ 
                        textAlign: 'center',
                        padding: '0.5rem',
                        minWidth: 0
                      }}>
                        <div className="stat-number" style={{
                          fontSize: '1.25rem',
                          fontWeight: 'bold',
                          color: '#10b981',
                          marginBottom: '0.25rem'
                        }}>
                          {stats.secteurs_assignes || secteursAssignes.length}
                        </div>
                        <div className="stat-label" style={{
                          fontSize: '0.7rem',
                          color: '#64748b',
                          textTransform: 'uppercase',
                          fontWeight: '500'
                        }}>
                          Secteurs
                        </div>
                      </div>
                      <div className="stat-item" style={{ 
                        textAlign: 'center',
                        padding: '0.5rem',
                        minWidth: 0
                      }}>
                        <div className="stat-number" style={{
                          fontSize: '1.25rem',
                          fontWeight: 'bold',
                          color: '#f59e0b',
                          marginBottom: '0.25rem'
                        }}>
                          {stats.inspections_effectuees || 0}
                        </div>
                        <div className="stat-label" style={{
                          fontSize: '0.7rem',
                          color: '#64748b',
                          textTransform: 'uppercase',
                          fontWeight: '500'
                        }}>
                          Inspections
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="batiments-assignes">
                    <h5 style={{ 
                      fontSize: '1rem', 
                      fontWeight: '600',
                      color: '#1e293b',
                      marginBottom: '0.75rem',
                      borderBottom: '2px solid #e5e7eb',
                      paddingBottom: '0.5rem'
                    }}>
                      üè¢ B√¢timents assign√©s
                    </h5>
                    {batimentsAssignes.length === 0 ? (
                      <p className="no-batiments" style={{
                        textAlign: 'center',
                        color: '#9ca3af',
                        padding: '1rem',
                        fontStyle: 'italic'
                      }}>
                        Aucun b√¢timent assign√©
                      </p>
                    ) : (
                      <div className="batiments-list">
                        {batimentsAssignes.slice(0, 5).map(batiment => (
                          <div key={batiment.id} className="batiment-item" style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '0.75rem',
                            backgroundColor: '#f9fafb',
                            borderRadius: '6px',
                            marginBottom: '0.5rem',
                            border: '1px solid #e5e7eb',
                            gap: '0.75rem'
                          }}>
                            <div style={{ flex: 1, minWidth: 0 }}>
                              <div style={{
                                fontWeight: '500',
                                color: '#1e293b',
                                marginBottom: '0.25rem'
                              }}>
                                {batiment.nom_etablissement}
                              </div>
                              <div style={{
                                fontSize: '0.8rem',
                                color: '#64748b'
                              }}>
                                üìç {batiment.adresse_civique || 'Adresse non sp√©cifi√©e'}
                              </div>
                            </div>
                            <button 
                              onClick={() => handleRemoveAssignment(batiment.id)}
                              className="remove-btn"
                              title="Supprimer l'assignation"
                              style={{
                                background: 'none',
                                border: 'none',
                                fontSize: '1.1rem',
                                cursor: 'pointer',
                                opacity: 0.6,
                                transition: 'opacity 0.2s',
                                flexShrink: 0,
                                padding: '0.25rem',
                                lineHeight: 1
                              }}
                              onMouseEnter={(e) => e.currentTarget.style.opacity = 1}
                              onMouseLeave={(e) => e.currentTarget.style.opacity = 0.6}
                            >
                              ‚ùå
                            </button>
                          </div>
                        ))}
                        {batimentsAssignes.length > 5 && (
                          <p className="more-batiments" style={{
                            textAlign: 'center',
                            color: '#6b7280',
                            fontSize: '0.9rem',
                            marginTop: '0.75rem',
                            fontStyle: 'italic'
                          }}>
                            ... et {batimentsAssignes.length - 5} autre(s)
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                  
                  {secteursAssignes.length > 0 && (
                    <div className="secteurs-assignes" style={{ marginTop: '1rem' }}>
                      <h5 style={{ 
                        fontSize: '1rem', 
                        fontWeight: '600',
                        color: '#1e293b',
                        marginBottom: '0.75rem',
                        borderBottom: '2px solid #e5e7eb',
                        paddingBottom: '0.5rem'
                      }}>
                        üó∫Ô∏è Secteurs assign√©s
                      </h5>
                      <div className="secteurs-list">
                        {secteursAssignes.map(secteur => (
                          <div key={secteur.id} style={{
                            padding: '0.5rem 0.75rem',
                            backgroundColor: '#ecfdf5',
                            borderRadius: '6px',
                            marginBottom: '0.5rem',
                            border: '1px solid #a7f3d0',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem'
                          }}>
                            <span style={{ color: '#059669', fontWeight: '500' }}>
                              {secteur.nom}
                            </span>
                            {secteur.description && (
                              <span style={{ fontSize: '0.8rem', color: '#6b7280' }}>
                                - {secteur.description}
                              </span>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>

          {/* B√¢timents sans pr√©ventionniste */}
          <div className="batiments-section">
            <h3>‚ö†Ô∏è B√¢timents Sans Pr√©ventionniste</h3>
            
            {batiments.filter(b => !b.preventionniste_assigne_id).length === 0 ? (
              <div className="success-state">
                <p>‚úÖ Tous les b√¢timents ont un pr√©ventionniste assign√©</p>
              </div>
            ) : (
              <div className="batiments-sans-preventionniste">
                {batiments
                  .filter(b => !b.preventionniste_assigne_id)
                  .slice(0, 10)
                  .map(batiment => (
                  <div key={batiment.id} className="batiment-sans-preventionniste">
                    <div className="batiment-details">
                      <h4>{batiment.nom_etablissement}</h4>
                      <p>{batiment.adresse_civique}, {batiment.ville}</p>
                      <span className="groupe-badge">{batiment.groupe_occupation}</span>
                    </div>
                    <div className="assign-actions">
                      <p><small>Besoin d'un pr√©ventionniste</small></p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </>
      )}

      {/* Modal de configuration de secteur */}
      {showSecteurModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 99999
        }}>
          <div style={{
            backgroundColor: '#fff',
            borderRadius: '12px',
            padding: '30px',
            maxWidth: '500px',
            width: '90%',
            maxHeight: '90vh',
            overflow: 'auto',
            boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
          }}>
            <h3 style={{ marginTop: 0, marginBottom: '20px', fontSize: '20px', fontWeight: 'bold' }}>
              {currentSecteur ? '‚úèÔ∏è Modifier le secteur' : 'üìç Nouveau secteur'}
            </h3>
            
            <SecteurForm
              secteur={currentSecteur}
              users={users.filter(u => u.role !== 'employe')}
              onSave={handleSaveSecteur}
              onDelete={currentSecteur ? () => handleDeleteSecteur(currentSecteur.id) : null}
              onCancel={() => {
                setShowSecteurModal(false);
                setCurrentSecteur(null);
                setPendingGeometry(null);
              }}
            />
          </div>
        </div>
      )}
    </div>
  );
};

// Formulaire de secteur
const SecteurForm = ({ secteur, users, onSave, onDelete, onCancel }) => {
  const [formData, setFormData] = useState({
    nom: secteur?.nom || '',
    description: secteur?.description || '',
    couleur: secteur?.couleur || '#3b82f6',
    preventionniste_assigne_id: secteur?.preventionniste_assigne_id || '',
    actif: secteur?.actif !== false
  });

  const couleursPredefinies = [
    { nom: 'Bleu', valeur: '#3b82f6' },
    { nom: 'Vert', valeur: '#10b981' },
    { nom: 'Rouge', valeur: '#ef4444' },
    { nom: 'Orange', valeur: '#f97316' },
    { nom: 'Violet', valeur: '#8b5cf6' },
    { nom: 'Rose', valeur: '#ec4899' },
    { nom: 'Jaune', valeur: '#eab308' },
    { nom: 'Cyan', valeur: '#06b6d4' }
  ];

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    if (!formData.nom.trim()) {
      alert('Veuillez entrer un nom pour le secteur');
      return;
    }
    
    onSave(formData);
  };

  return (
    <form onSubmit={handleSubmit}>
      <div style={{ marginBottom: '20px' }}>
        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500', fontSize: '14px' }}>
          Nom du secteur *
        </label>
        <input
          type="text"
          name="nom"
          value={formData.nom}
          onChange={handleChange}
          placeholder="Ex: Secteur Nord, Zone industrielle..."
          required
          style={{
            width: '100%',
            padding: '10px',
            borderRadius: '6px',
            border: '1px solid #d1d5db',
            fontSize: '14px'
          }}
        />
      </div>

      <div style={{ marginBottom: '20px' }}>
        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500', fontSize: '14px' }}>
          Description
        </label>
        <textarea
          name="description"
          value={formData.description}
          onChange={handleChange}
          placeholder="Description du secteur..."
          rows="3"
          style={{
            width: '100%',
            padding: '10px',
            borderRadius: '6px',
            border: '1px solid #d1d5db',
            fontSize: '14px',
            resize: 'vertical'
          }}
        />
      </div>

      <div style={{ marginBottom: '20px' }}>
        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500', fontSize: '14px' }}>
          Couleur
        </label>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px' }}>
          {couleursPredefinies.map(c => (
            <button
              key={c.valeur}
              type="button"
              onClick={() => setFormData(prev => ({ ...prev, couleur: c.valeur }))}
              style={{
                padding: '10px',
                borderRadius: '6px',
                border: formData.couleur === c.valeur ? '3px solid #000' : '2px solid #d1d5db',
                backgroundColor: c.valeur,
                cursor: 'pointer',
                color: '#fff',
                fontSize: '12px',
                fontWeight: 'bold',
                textAlign: 'center',
                transition: 'all 0.2s'
              }}
            >
              {c.nom}
            </button>
          ))}
        </div>
      </div>

      <div style={{ marginBottom: '20px' }}>
        <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500', fontSize: '14px' }}>
          Pr√©ventionniste assign√©
        </label>
        <select
          name="preventionniste_assigne_id"
          value={formData.preventionniste_assigne_id}
          onChange={handleChange}
          style={{
            width: '100%',
            padding: '10px',
            borderRadius: '6px',
            border: '1px solid #d1d5db',
            fontSize: '14px',
            backgroundColor: '#fff'
          }}
        >
          <option value="">-- S√©lectionner un pr√©ventionniste --</option>
          {users.map(user => (
            <option key={user.id} value={user.id}>
              {user.prenom} {user.nom} ({user.grade})
            </option>
          ))}
        </select>
      </div>

      <div style={{ marginBottom: '20px' }}>
        <label style={{ display: 'flex', alignItems: 'center', fontSize: '14px', cursor: 'pointer' }}>
          <input
            type="checkbox"
            name="actif"
            checked={formData.actif}
            onChange={handleChange}
            style={{ marginRight: '8px', cursor: 'pointer' }}
          />
          Secteur actif
        </label>
      </div>

      <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end', marginTop: '30px' }}>
        {onDelete && (
          <button
            type="button"
            onClick={onDelete}
            style={{
              padding: '10px 20px',
              backgroundColor: '#dc2626',
              color: '#fff',
              border: 'none',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '500',
              marginRight: 'auto'
            }}
          >
            üóëÔ∏è Supprimer
          </button>
        )}
        <button
          type="button"
          onClick={onCancel}
          style={{
            padding: '10px 20px',
            backgroundColor: '#6b7280',
            color: '#fff',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500'
          }}
        >
          Annuler
        </button>
        <button
          type="submit"
          style={{
            padding: '10px 20px',
            backgroundColor: '#2563eb',
            color: '#fff',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500'
          }}
        >
          {secteur ? 'Mettre √† jour' : 'Cr√©er'}
        </button>
      </div>
    </form>
  );
};

const AssignerPreventionniste = ({ onAssign }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [users, setUsers] = useState([]);
  const [batiments, setBatiments] = useState([]);
  const [selectedUser, setSelectedUser] = useState('');
  const [selectedBatiments, setSelectedBatiments] = useState([]);
  const [loading, setLoading] = useState(false);
  const [assigning, setAssigning] = useState(false);

  const fetchData = async () => {
    try {
      setLoading(true);
      const [usersData, batimentsData] = await Promise.all([
        apiGet(tenantSlug, '/users'),
        apiGet(tenantSlug, '/prevention/batiments')
      ]);
      
      setUsers(usersData.filter(u => u.role === 'admin' || u.role === 'superviseur'));
      setBatiments(batimentsData);
    } catch (error) {
      console.error('Erreur chargement donn√©es:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les donn√©es",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [tenantSlug]);

  const handleBatimentToggle = (batimentId) => {
    setSelectedBatiments(prev => 
      prev.includes(batimentId) 
        ? prev.filter(id => id !== batimentId)
        : [...prev, batimentId]
    );
  };

  const handleAssign = async () => {
    if (!selectedUser || selectedBatiments.length === 0) {
      toast({
        title: "Validation",
        description: "Veuillez s√©lectionner un pr√©ventionniste et au moins un b√¢timent",
        variant: "destructive"
      });
      return;
    }

    try {
      setAssigning(true);
      
      // Assigner le pr√©ventionniste √† tous les b√¢timents s√©lectionn√©s
      await Promise.all(
        selectedBatiments.map(batimentId =>
          apiPut(tenantSlug, `/prevention/batiments/${batimentId}`, {
            preventionniste_assigne_id: selectedUser
          })
        )
      );

      toast({
        title: "Succ√®s",
        description: `${selectedBatiments.length} b√¢timent(s) assign√©(s) avec succ√®s`
      });

      onAssign();
    } catch (error) {
      console.error('Erreur assignation:', error);
      toast({
        title: "Erreur",
        description: "Une erreur s'est produite lors de l'assignation",
        variant: "destructive"
      });
    } finally {
      setAssigning(false);
    }
  };

  if (loading) {
    return <div className="loading">Chargement...</div>;
  }

  const selectedUserInfo = users.find(u => u.id === selectedUser);

  return (
    <div className="assigner-preventionniste">
      <div className="assignment-steps">
        {/* √âtape 1: S√©lectionner pr√©ventionniste */}
        <div className="step-section">
          <h3>üë§ √âtape 1: S√©lectionner le pr√©ventionniste</h3>
          <div className="users-grid">
            {users.map(user => (
              <label key={user.id} className="user-option">
                <input
                  type="radio"
                  name="preventionniste"
                  value={user.id}
                  checked={selectedUser === user.id}
                  onChange={(e) => setSelectedUser(e.target.value)}
                />
                <div className="user-card">
                  <div className="user-info">
                    <h4>{user.prenom} {user.nom}</h4>
                    <p>{user.email}</p>
                    <div className="user-badges">
                      <span className={`role-badge ${user.role}`}>{user.role}</span>
                      {user.grade && <span className="grade-badge">{user.grade}</span>}
                    </div>
                  </div>
                  <div className="user-stats">
                    <span className="current-assignments">
                      {batiments.filter(b => b.preventionniste_assigne_id === user.id).length} b√¢timents actuels
                    </span>
                  </div>
                </div>
              </label>
            ))}
          </div>
        </div>

        {/* √âtape 2: S√©lectionner b√¢timents */}
        {selectedUser && (
          <div className="step-section">
            <h3>üè¢ √âtape 2: S√©lectionner les b√¢timents ({selectedBatiments.length} s√©lectionn√©s)</h3>
            <div className="batiments-selection">
              {batiments
                .filter(b => !b.preventionniste_assigne_id || b.preventionniste_assigne_id === selectedUser)
                .map(batiment => (
                <label key={batiment.id} className="batiment-option">
                  <input
                    type="checkbox"
                    checked={selectedBatiments.includes(batiment.id)}
                    onChange={() => handleBatimentToggle(batiment.id)}
                  />
                  <div className="batiment-card">
                    <div className="batiment-info">
                      <h4>{batiment.nom_etablissement}</h4>
                      <p>{batiment.adresse_civique}, {batiment.ville}</p>
                      <div className="batiment-meta">
                        <span className="groupe-badge">{batiment.groupe_occupation}</span>
                        {batiment.preventionniste_assigne_id === selectedUser && (
                          <span className="assigned-badge">D√©j√† assign√©</span>
                        )}
                      </div>
                    </div>
                  </div>
                </label>
              ))}
            </div>
          </div>
        )}

        {/* R√©sum√© et confirmation */}
        {selectedUser && selectedBatiments.length > 0 && (
          <div className="step-section confirmation">
            <h3>‚úÖ Confirmation de l'assignation</h3>
            <div className="assignment-summary">
              <div className="summary-item">
                <strong>Pr√©ventionniste:</strong> {selectedUserInfo?.prenom} {selectedUserInfo?.nom}
              </div>
              <div className="summary-item">
                <strong>B√¢timents √† assigner:</strong> {selectedBatiments.length}
              </div>
            </div>

            <div className="confirmation-actions">
              <Button 
                variant="outline"
                onClick={() => {
                  setSelectedUser('');
                  setSelectedBatiments([]);
                }}
              >
                üîÑ Recommencer
              </Button>
              <Button 
                onClick={handleAssign}
                disabled={assigning}
                className="confirm-btn"
              >
                {assigning ? '‚è≥ Assignation...' : '‚úÖ Confirmer l\'assignation'}
              </Button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// ==================== COMPOSANTS INSPECTIONS ====================

// Composant d'upload de photos
const PhotoUploader = ({ photos, setPhotos, maxPhotos = 10 }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [uploading, setUploading] = useState(false);

  const handleFileChange = async (e) => {
    const files = Array.from(e.target.files);
    
    if (photos.length + files.length > maxPhotos) {
      toast({
        title: "Limite atteinte",
        description: `Maximum ${maxPhotos} photos`,
        variant: "destructive"
      });
      return;
    }

    setUploading(true);
    try {
      for (const file of files) {
        // Convertir en base64
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result;
          
          try {
            const response = await apiPost(tenantSlug, '/prevention/upload-photo', {
              photo_base64: base64,
              filename: file.name
            });
            
            setPhotos(prev => [...prev, response.url]);
            
            toast({
              title: "Photo ajout√©e",
              description: file.name
            });
          } catch (error) {
            console.error('Erreur upload:', error);
            toast({
              title: "Erreur",
              description: `Impossible d'uploader ${file.name}`,
              variant: "destructive"
            });
          }
        };
        reader.readAsDataURL(file);
      }
    } finally {
      setUploading(false);
    }
  };

  const removePhoto = (index) => {
    setPhotos(prev => prev.filter((_, i) => i !== index));
  };

  return (
    <div className="photo-uploader">
      <div className="upload-header">
        <label>üì∏ Photos ({photos.length}/{maxPhotos})</label>
        <input
          type="file"
          accept="image/*"
          multiple
          onChange={handleFileChange}
          disabled={uploading || photos.length >= maxPhotos}
          className="file-input"
          id="photo-upload"
          style={{ display: 'none' }}
        />
        <Button
          size="sm"
          variant="outline"
          onClick={() => document.getElementById('photo-upload').click()}
          disabled={uploading || photos.length >= maxPhotos}
        >
          {uploading ? '‚è≥ Upload...' : 'üì∑ Ajouter photos'}
        </Button>
      </div>

      {photos.length > 0 && (
        <div className="photos-grid">
          {photos.map((photoUrl, index) => (
            <div key={index} className="photo-item">
              <img 
                src={photoUrl.includes('data:') ? photoUrl : `${process.env.REACT_APP_BACKEND_URL}${photoUrl}`} 
                alt={`Photo ${index + 1}`}
                className="photo-thumbnail"
              />
              <button
                onClick={() => removePhoto(index)}
                className="remove-photo-btn"
                title="Supprimer"
              >
                ‚úï
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

const ListeInspections = ({ setCurrentView }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [inspections, setInspections] = useState([]);
  const [batiments, setBatiments] = useState([]);
  const [users, setUsers] = useState([]);
  const [grades, setGrades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all'); // all, conforme, non_conforme

  const fetchData = async () => {
    try {
      setLoading(true);
      const [inspectionsData, batimentsData, usersData] = await Promise.all([
        apiGet(tenantSlug, '/prevention/inspections'),
        apiGet(tenantSlug, '/prevention/batiments'),
        apiGet(tenantSlug, '/users')
      ]);
      
      setInspections(inspectionsData);
      setBatiments(batimentsData);
      setUsers(usersData);
    } catch (error) {
      console.error('Erreur chargement donn√©es:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les inspections",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [tenantSlug]);

  const getBatimentName = (batimentId) => {
    const batiment = batiments.find(b => b.id === batimentId);
    return batiment?.nom_etablissement || 'Inconnu';
  };

  const getPreventionnisteName = (userId) => {
    const preventionniste = users.find(u => u.id === userId);
    return preventionniste ? `${preventionniste.prenom} ${preventionniste.nom}` : 'Inconnu';
  };

  const handleDeleteInspection = async (inspectionId) => {
    if (!window.confirm('√ätes-vous s√ªr de vouloir supprimer cette inspection ?')) {
      return;
    }

    try {
      await apiDelete(tenantSlug, `/prevention/inspections/${inspectionId}`);
      toast({
        title: "Succ√®s",
        description: "Inspection supprim√©e avec succ√®s",
        variant: "default"
      });
      // Recharger la liste
      fetchData();
    } catch (error) {
      console.error('Erreur suppression inspection:', error);
      toast({
        title: "Erreur",
        description: "Impossible de supprimer l'inspection",
        variant: "destructive"
      });
    }
  };

  const filteredInspections = inspections.filter(insp => {
    if (filter === 'all') return true;
    if (filter === 'conforme') return insp.statut_global === 'conforme';
    if (filter === 'non_conforme') return insp.statut_global !== 'conforme';
    return true;
  });

  const handleDownloadPDF = async (inspectionId) => {
    try {
      const response = await fetch(`${process.env.REACT_APP_BACKEND_URL}/api/${tenantSlug}/prevention/inspections/${inspectionId}/rapport-pdf`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem(`${tenantSlug}_token`)}`
        }
      });
      
      if (!response.ok) throw new Error('Erreur t√©l√©chargement');
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `rapport_inspection_${inspectionId}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      toast({
        title: "Succ√®s",
        description: "Rapport t√©l√©charg√©"
      });
    } catch (error) {
      console.error('Erreur t√©l√©chargement PDF:', error);
      toast({
        title: "Erreur",
        description: "Impossible de t√©l√©charger le rapport",
        variant: "destructive"
      });
    }
  };

  if (loading) {
    return <div className="loading-spinner">Chargement des inspections...</div>;
  }

  return (
    <div className="inspections-container">
      <div className="page-header">
        <h2>üìã Liste des Inspections</h2>
        <Button onClick={() => setCurrentView('nouvelle-inspection')}>
          ‚ûï Nouvelle Inspection
        </Button>
      </div>

      <div className="inspections-filters">
        <Button
          variant={filter === 'all' ? 'default' : 'outline'}
          onClick={() => setFilter('all')}
        >
          Toutes ({inspections.length})
        </Button>
        <Button
          variant={filter === 'conforme' ? 'default' : 'outline'}
          onClick={() => setFilter('conforme')}
        >
          ‚úÖ Conformes ({inspections.filter(i => i.statut_global === 'conforme').length})
        </Button>
        <Button
          variant={filter === 'non_conforme' ? 'default' : 'outline'}
          onClick={() => setFilter('non_conforme')}
        >
          ‚ö†Ô∏è Non-conformes ({inspections.filter(i => i.statut_global !== 'conforme').length})
        </Button>
      </div>

      {filteredInspections.length === 0 ? (
        <div className="empty-state">
          <p>Aucune inspection trouv√©e</p>
          <Button onClick={() => setCurrentView('nouvelle-inspection')}>
            Cr√©er la premi√®re inspection
          </Button>
        </div>
      ) : (
        <div className="inspections-list">
          {filteredInspections.map(inspection => (
            <div key={inspection.id} className="inspection-card">
              <div className="inspection-header">
                <div>
                  <h4>{getBatimentName(inspection.batiment_id)}</h4>
                  <p className="inspection-date">{inspection.date_inspection}</p>
                </div>
                <span className={`statut-badge ${inspection.statut_global}`}>
                  {inspection.statut_global === 'conforme' ? '‚úÖ Conforme' : '‚ö†Ô∏è Non-conforme'}
                </span>
              </div>
              
              <div className="inspection-details">
                <div className="detail-item">
                  <span className="label">Pr√©ventionniste:</span>
                  <span>{getPreventionnisteName(inspection.preventionniste_id)}</span>
                </div>
                <div className="detail-item">
                  <span className="label">Type:</span>
                  <span>{inspection.type_inspection}</span>
                </div>
                <div className="detail-item">
                  <span className="label">Score:</span>
                  <span className="score">{inspection.score_conformite}%</span>
                </div>
              </div>
              
              <div className="inspection-actions">
                <Button 
                  size="sm" 
                  variant="outline"
                  onClick={() => handleDownloadPDF(inspection.id)}
                >
                  üìÑ Rapport PDF
                </Button>
                <Button 
                  size="sm"
                  onClick={() => {
                    localStorage.setItem('detail_inspection_id', inspection.id);
                    setCurrentView('detail-inspection');
                  }}
                >
                  üëÅÔ∏è Voir d√©tails
                </Button>
                {(user.role === 'admin' || user.role === 'superviseur') && (
                  <Button 
                    size="sm"
                    variant="destructive"
                    onClick={() => handleDeleteInspection(inspection.id)}
                  >
                    üóëÔ∏è Supprimer
                  </Button>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

const NouvelleInspection = ({ setCurrentView, batiments, selectedBatiment, onBatimentSelected }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [loading, setLoading] = useState(false);
  const [grilles, setGrilles] = useState([]);
  const [formData, setFormData] = useState({
    batiment_id: selectedBatiment?.id || '',
    grille_inspection_id: '',
    date_inspection: new Date().toISOString().split('T')[0],
    type_inspection: 'reguliere'
  });

  // Mettre √† jour le b√¢timent si selectedBatiment change
  useEffect(() => {
    if (selectedBatiment?.id) {
      setFormData(prev => ({ ...prev, batiment_id: selectedBatiment.id }));
    }
  }, [selectedBatiment]);

  useEffect(() => {
    const fetchGrilles = async () => {
      try {
        const data = await apiGet(tenantSlug, '/prevention/grilles-inspection');
        setGrilles(data);
      } catch (error) {
        console.error('Erreur chargement grilles:', error);
      }
    };
    fetchGrilles();
  }, [tenantSlug]);

  const handleSubmit = async () => {
    if (!formData.batiment_id || !formData.grille_inspection_id) {
      toast({
        title: "Validation",
        description: "Veuillez s√©lectionner un b√¢timent et une grille",
        variant: "destructive"
      });
      return;
    }

    try {
      setLoading(true);
      const inspection = await apiPost(tenantSlug, '/prevention/inspections', {
        ...formData,
        preventionniste_id: user.id,
        heure_debut: new Date().toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }),
        resultats: {},
        statut_global: 'en_cours',
        score_conformite: 0
      });

      toast({
        title: "Succ√®s",
        description: "Inspection cr√©√©e"
      });

      // Rediriger vers la r√©alisation de l'inspection
      localStorage.setItem('current_inspection_id', inspection.id);
      setCurrentView('realiser-inspection');
    } catch (error) {
      console.error('Erreur cr√©ation inspection:', error);
      toast({
        title: "Erreur",
        description: "Impossible de cr√©er l'inspection",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="nouvelle-inspection-container">
      <div className="page-header">
        <h2>üîç Nouvelle Inspection</h2>
        <Button variant="outline" onClick={() => setCurrentView('inspections')}>
          ‚Üê Retour
        </Button>
      </div>

      <div className="inspection-form">
        <div className="form-section">
          <label>B√¢timent √† inspecter *</label>
          <select
            value={formData.batiment_id}
            onChange={(e) => setFormData({ ...formData, batiment_id: e.target.value })}
            className="form-select"
          >
            <option value="">-- S√©lectionner un b√¢timent --</option>
            {batiments.map(b => (
              <option key={b.id} value={b.id}>
                {b.nom_etablissement} - {b.adresse_civique}
              </option>
            ))}
          </select>
        </div>

        <div className="form-section">
          <label>Grille d'inspection *</label>
          <select
            value={formData.grille_inspection_id}
            onChange={(e) => setFormData({ ...formData, grille_inspection_id: e.target.value })}
            className="form-select"
          >
            <option value="">-- S√©lectionner une grille --</option>
            {grilles.map(g => (
              <option key={g.id} value={g.id}>
                {g.nom} {g.groupe_occupation ? `(Groupe ${g.groupe_occupation})` : ''}
              </option>
            ))}
          </select>
        </div>

        <div className="form-section">
          <label>Date d'inspection *</label>
          <input
            type="date"
            value={formData.date_inspection}
            onChange={(e) => setFormData({ ...formData, date_inspection: e.target.value })}
            className="form-input"
          />
        </div>

        <div className="form-section">
          <label>Type d'inspection</label>
          <select
            value={formData.type_inspection}
            onChange={(e) => setFormData({ ...formData, type_inspection: e.target.value })}
            className="form-select"
          >
            <option value="reguliere">R√©guli√®re</option>
            <option value="suivi">Suivi</option>
            <option value="urgence">Urgence</option>
            <option value="plainte">Suite √† plainte</option>
          </select>
        </div>

        <div className="form-actions">
          <Button variant="outline" onClick={() => setCurrentView('inspections')}>
            Annuler
          </Button>
          <Button onClick={handleSubmit} disabled={loading}>
            {loading ? 'Cr√©ation...' : 'D√©marrer l\'inspection'}
          </Button>
        </div>
      </div>
    </div>
  );
};

const RealiserInspection = ({ setCurrentView }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [loading, setLoading] = useState(true);
  const [inspection, setInspection] = useState(null);
  const [grille, setGrille] = useState(null);
  const [batiment, setBatiment] = useState(null);
  const [resultats, setResultats] = useState({});
  const [nonConformites, setNonConformites] = useState([]);
  const [photos, setPhotos] = useState([]);
  const [notes, setNotes] = useState('');
  const [recommandations, setRecommandations] = useState('');

  useEffect(() => {
    const loadInspection = async () => {
      try {
        const inspectionId = localStorage.getItem('current_inspection_id');
        if (!inspectionId) {
          setCurrentView('inspections');
          return;
        }

        const inspData = await apiGet(tenantSlug, `/prevention/inspections/${inspectionId}`);
        setInspection(inspData);
        setResultats(inspData.resultats || {});

        const [grilleData, batimentData] = await Promise.all([
          apiGet(tenantSlug, `/prevention/grilles-inspection/${inspData.grille_inspection_id}`),
          apiGet(tenantSlug, `/prevention/batiments/${inspData.batiment_id}`)
        ]);

        setGrille(grilleData);
        setBatiment(batimentData);
      } catch (error) {
        console.error('Erreur chargement inspection:', error);
        toast({
          title: "Erreur",
          description: "Impossible de charger l'inspection",
          variant: "destructive"
        });
        // Rediriger vers la liste des inspections en cas d'erreur
        setCurrentView('inspections');
      } finally {
        setLoading(false);
      }
    };

    loadInspection();
  }, [tenantSlug]);

  const handleReponse = (sectionIndex, questionIndex, valeur) => {
    setResultats(prev => ({
      ...prev,
      [`section_${sectionIndex}_question_${questionIndex}`]: valeur
    }));
  };

  const handleSaveInspection = async (statut = 'brouillon') => {
    try {
      // Calculer le score de conformit√©
      const totalQuestions = grille.sections.reduce((acc, section) => acc + section.questions.length, 0);
      const reponsesConformes = Object.values(resultats).filter(r => r === 'conforme' || r === 'oui').length;
      const score = totalQuestions > 0 ? Math.round((reponsesConformes / totalQuestions) * 100) : 0;

      const statutGlobal = score >= 80 ? 'conforme' : score >= 50 ? 'partiellement_conforme' : 'non_conforme';

      await apiPut(tenantSlug, `/prevention/inspections/${inspection.id}`, {
        ...inspection,
        resultats,
        score_conformite: score,
        statut_global: statutGlobal,
        photos: photos,
        notes_inspection: notes,
        recommandations: recommandations,
        heure_fin: new Date().toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' })
      });

      // Cr√©er les non-conformit√©s si n√©cessaire
      for (const nc of nonConformites) {
        await apiPost(tenantSlug, '/prevention/non-conformites', {
          ...nc,
          inspection_id: inspection.id,
          batiment_id: inspection.batiment_id
        });
      }

      toast({
        title: "Succ√®s",
        description: statut === 'brouillon' ? "Inspection sauvegard√©e" : "Inspection termin√©e"
      });

      localStorage.removeItem('current_inspection_id');
      setCurrentView('inspections');
    } catch (error) {
      console.error('Erreur sauvegarde inspection:', error);
      toast({
        title: "Erreur",
        description: "Impossible de sauvegarder l'inspection",
        variant: "destructive"
      });
    }
  };

  const ajouterNonConformite = (sectionIndex, questionIndex, question) => {
    setNonConformites(prev => [...prev, {
      titre: question,
      section_grille: `Section ${sectionIndex + 1}`,
      description: '',
      gravite: 'moyen',
      statut: 'ouverte'
    }]);
  };

  if (loading) {
    return <div className="loading-spinner">Chargement de l'inspection...</div>;
  }

  if (!inspection || !grille || !batiment) {
    return <div>Erreur: Donn√©es manquantes</div>;
  }

  return (
    <div className="realiser-inspection-container">
      <div className="page-header">
        <div>
          <h2>üîç Inspection en cours</h2>
          <p className="inspection-subtitle">{batiment.nom_etablissement} - {batiment.adresse_civique}</p>
        </div>
        <div className="header-actions">
          <Button variant="outline" onClick={() => handleSaveInspection('brouillon')}>
            üíæ Sauvegarder brouillon
          </Button>
          <Button onClick={() => handleSaveInspection('termine')}>
            ‚úÖ Terminer l'inspection
          </Button>
        </div>
      </div>

      <div className="grille-inspection-content">
        {grille.sections.map((section, sectionIdx) => (
          <div key={sectionIdx} className="grille-section">
            <h3>{section.titre}</h3>
            
            <div className="questions-list">
              {section.questions.map((question, questionIdx) => (
                <div key={questionIdx} className="question-item">
                  <label className="question-text">{question}</label>
                  
                  <div className="question-reponses">
                    <label className="radio-label">
                      <input
                        type="radio"
                        name={`section_${sectionIdx}_question_${questionIdx}`}
                        value="conforme"
                        checked={resultats[`section_${sectionIdx}_question_${questionIdx}`] === 'conforme'}
                        onChange={(e) => handleReponse(sectionIdx, questionIdx, e.target.value)}
                      />
                      <span>‚úÖ Conforme</span>
                    </label>
                    
                    <label className="radio-label">
                      <input
                        type="radio"
                        name={`section_${sectionIdx}_question_${questionIdx}`}
                        value="non_conforme"
                        checked={resultats[`section_${sectionIdx}_question_${questionIdx}`] === 'non_conforme'}
                        onChange={(e) => handleReponse(sectionIdx, questionIdx, e.target.value)}
                      />
                      <span>‚ö†Ô∏è Non-conforme</span>
                    </label>
                    
                    <label className="radio-label">
                      <input
                        type="radio"
                        name={`section_${sectionIdx}_question_${questionIdx}`}
                        value="na"
                        checked={resultats[`section_${sectionIdx}_question_${questionIdx}`] === 'na'}
                        onChange={(e) => handleReponse(sectionIdx, questionIdx, e.target.value)}
                      />
                      <span>‚äò N/A</span>
                    </label>
                  </div>

                  {resultats[`section_${sectionIdx}_question_${questionIdx}`] === 'non_conforme' && (
                    <Button 
                      size="sm" 
                      variant="outline" 
                      onClick={() => ajouterNonConformite(sectionIdx, questionIdx, question)}
                      className="add-nc-btn"
                    >
                      ‚ûï Ajouter non-conformit√©
                    </Button>
                  )}
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>

      {nonConformites.length > 0 && (
        <div className="non-conformites-preview">
          <h3>‚ö†Ô∏è Non-conformit√©s identifi√©es ({nonConformites.length})</h3>
          <div className="nc-list-preview">
            {nonConformites.map((nc, idx) => (
              <div key={idx} className="nc-preview-item">
                <span className="nc-number">#{idx + 1}</span>
                <span>{nc.titre}</span>
                <span className={`gravite-badge ${nc.gravite}`}>{nc.gravite}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      <div className="inspection-documentation">
        <div className="doc-section">
          <h3>üì∏ Photos de l'inspection</h3>
          <PhotoUploader photos={photos} setPhotos={setPhotos} maxPhotos={20} />
        </div>

        <div className="doc-section">
          <h3>üìù Notes d'inspection</h3>
          <textarea
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            placeholder="Notes, observations, commentaires..."
            className="notes-textarea"
            rows={4}
          />
        </div>

        <div className="doc-section">
          <h3>üí° Recommandations</h3>
          <textarea
            value={recommandations}
            onChange={(e) => setRecommandations(e.target.value)}
            placeholder="Recommandations pour am√©liorer la conformit√©..."
            className="notes-textarea"
            rows={4}
          />
        </div>
      </div>
    </div>
  );
};

const DetailInspection = ({ inspectionId, setCurrentView }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [loading, setLoading] = useState(true);
  const [inspection, setInspection] = useState(null);
  const [batiment, setBatiment] = useState(null);
  const [grille, setGrille] = useState(null);
  const [preventionniste, setPreventionniste] = useState(null);
  const [nonConformites, setNonConformites] = useState([]);

  useEffect(() => {
    const loadDetails = async () => {
      try {
        const inspData = await apiGet(tenantSlug, `/prevention/inspections/${inspectionId}`);
        setInspection(inspData);

        const [batData, grilleData, prevData, ncData] = await Promise.all([
          apiGet(tenantSlug, `/prevention/batiments/${inspData.batiment_id}`),
          apiGet(tenantSlug, `/prevention/grilles-inspection/${inspData.grille_inspection_id}`),
          apiGet(tenantSlug, `/users`).then(users => users.find(u => u.id === inspData.preventionniste_id)),
          apiGet(tenantSlug, `/prevention/non-conformites?inspection_id=${inspectionId}`)
        ]);

        setBatiment(batData);
        setGrille(grilleData);
        setPreventionniste(prevData);
        setNonConformites(ncData);
      } catch (error) {
        console.error('Erreur chargement d√©tails:', error);
        toast({
          title: "Erreur",
          description: "Impossible de charger les d√©tails",
          variant: "destructive"
        });
      } finally {
        setLoading(false);
      }
    };

    loadDetails();
  }, [inspectionId, tenantSlug]);

  if (loading) {
    return <div className="loading-spinner">Chargement...</div>;
  }

  if (!inspection || !batiment) {
    return <div>Erreur: Donn√©es manquantes</div>;
  }

  return (
    <div className="detail-inspection-container">
      <div className="page-header">
        <h2>üîç D√©tails de l'Inspection</h2>
        <div className="header-actions">
          <Button variant="outline" onClick={() => setCurrentView('inspections')}>
            ‚Üê Retour √† la liste
          </Button>
          <Button onClick={() => {
            window.open(`${process.env.REACT_APP_BACKEND_URL}/api/${tenantSlug}/prevention/inspections/${inspectionId}/rapport-pdf`, '_blank');
          }}>
            üìÑ T√©l√©charger PDF
          </Button>
        </div>
      </div>

      <div className="detail-content">
        {/* R√©sum√© */}
        <div className="detail-card">
          <h3>üìä R√©sum√©</h3>
          <div className="summary-grid">
            <div className="summary-item">
              <span className="label">Statut:</span>
              <span className={`statut-badge ${inspection.statut_global}`}>
                {inspection.statut_global === 'conforme' ? '‚úÖ Conforme' : '‚ö†Ô∏è Non-conforme'}
              </span>
            </div>
            <div className="summary-item">
              <span className="label">Score:</span>
              <span className="score-badge">{inspection.score_conformite}%</span>
            </div>
            <div className="summary-item">
              <span className="label">Date:</span>
              <span>{inspection.date_inspection}</span>
            </div>
            <div className="summary-item">
              <span className="label">Type:</span>
              <span>{inspection.type_inspection}</span>
            </div>
          </div>
        </div>

        {/* B√¢timent */}
        <div className="detail-card">
          <h3>üè¢ B√¢timent Inspect√©</h3>
          <div className="info-grid">
            <div className="info-item">
              <span className="label">Nom:</span>
              <span>{batiment.nom_etablissement}</span>
            </div>
            <div className="info-item">
              <span className="label">Adresse:</span>
              <span>{batiment.adresse_civique}, {batiment.ville}</span>
            </div>
            <div className="info-item">
              <span className="label">Groupe occupation:</span>
              <span>{batiment.groupe_occupation}</span>
            </div>
          </div>
        </div>

        {/* Pr√©ventionniste */}
        {preventionniste && (
          <div className="detail-card">
            <h3>üë®‚Äçüöí Pr√©ventionniste</h3>
            <p><strong>{preventionniste.prenom} {preventionniste.nom}</strong></p>
            <p>{preventionniste.email}</p>
          </div>
        )}

        {/* Grille utilis√©e */}
        {grille && (
          <div className="detail-card">
            <h3>üìã Grille d'Inspection</h3>
            <p><strong>{grille.nom}</strong></p>
            {grille.groupe_occupation && <p>Groupe {grille.groupe_occupation}</p>}
          </div>
        )}

        {/* Non-conformit√©s */}
        {nonConformites.length > 0 && (
          <div className="detail-card">
            <h3>‚ö†Ô∏è Non-Conformit√©s ({nonConformites.length})</h3>
            <div className="nc-detail-list">
              {nonConformites.map((nc, idx) => (
                <div key={nc.id} className="nc-detail-item">
                  <div className="nc-detail-header">
                    <span className="nc-number">#{idx + 1}</span>
                    <h4>{nc.titre}</h4>
                    <span className={`gravite-badge ${nc.gravite}`}>{nc.gravite}</span>
                    <span className={`statut-badge ${nc.statut}`}>{nc.statut}</span>
                  </div>
                  {nc.description && <p className="nc-description">{nc.description}</p>}
                  {nc.delai_correction && (
                    <p className="nc-delai">
                      <strong>D√©lai:</strong> {nc.delai_correction}
                    </p>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Photos */}
        {inspection.photos && inspection.photos.length > 0 && (
          <div className="detail-card">
            <h3>üì∏ Photos ({inspection.photos.length})</h3>
            <div className="photos-grid">
              {inspection.photos.map((photoUrl, idx) => (
                <div key={idx} className="photo-item-view">
                  <img 
                    src={photoUrl.includes('data:') ? photoUrl : `${process.env.REACT_APP_BACKEND_URL}${photoUrl}`}
                    alt={`Photo ${idx + 1}`}
                    className="photo-detail"
                    onClick={() => window.open(photoUrl, '_blank')}
                  />
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Notes */}
        {inspection.notes_inspection && (
          <div className="detail-card">
            <h3>üìù Notes d'Inspection</h3>
            <p className="note-text">{inspection.notes_inspection}</p>
          </div>
        )}

        {/* Recommandations */}
        {inspection.recommandations && (
          <div className="detail-card">
            <h3>üí° Recommandations</h3>
            <p className="note-text">{inspection.recommandations}</p>
          </div>
        )}
      </div>
    </div>
  );
};

const GestionNonConformites = ({ setCurrentView }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [nonConformites, setNonConformites] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all');

  useEffect(() => {
    const fetchNonConformites = async () => {
      try {
        const data = await apiGet(tenantSlug, '/prevention/non-conformites');
        setNonConformites(data);
      } catch (error) {
        console.error('Erreur chargement non-conformit√©s:', error);
        toast({
          title: "Erreur",
          description: "Impossible de charger les non-conformit√©s",
          variant: "destructive"
        });
      } finally {
        setLoading(false);
      }
    };

    fetchNonConformites();
  }, [tenantSlug]);

  const handleUpdateStatut = async (ncId, newStatut) => {
    try {
      await apiPatch(tenantSlug, `/prevention/non-conformites/${ncId}/statut`, {
        statut: newStatut
      });

      setNonConformites(prev => 
        prev.map(nc => nc.id === ncId ? { ...nc, statut: newStatut } : nc)
      );

      toast({
        title: "Succ√®s",
        description: "Statut mis √† jour"
      });
    } catch (error) {
      console.error('Erreur mise √† jour statut:', error);
      toast({
        title: "Erreur",
        description: "Impossible de mettre √† jour le statut",
        variant: "destructive"
      });
    }
  };

  const filteredNC = nonConformites.filter(nc => {
    if (filter === 'all') return true;
    if (filter === 'ouverte') return nc.statut === 'ouverte' || nc.statut === 'en_cours';
    if (filter === 'corrigee') return nc.statut === 'corrigee' || nc.statut === 'fermee';
    return true;
  });

  if (loading) {
    return <div className="loading-spinner">Chargement...</div>;
  }

  return (
    <div className="non-conformites-container">
      <div className="page-header">
        <h2>‚ö†Ô∏è Gestion des Non-Conformit√©s</h2>
      </div>

      <div className="nc-filters">
        <Button
          variant={filter === 'all' ? 'default' : 'outline'}
          onClick={() => setFilter('all')}
        >
          Toutes ({nonConformites.length})
        </Button>
        <Button
          variant={filter === 'ouverte' ? 'default' : 'outline'}
          onClick={() => setFilter('ouverte')}
        >
          üî¥ Ouvertes ({nonConformites.filter(nc => nc.statut === 'ouverte' || nc.statut === 'en_cours').length})
        </Button>
        <Button
          variant={filter === 'corrigee' ? 'default' : 'outline'}
          onClick={() => setFilter('corrigee')}
        >
          ‚úÖ Corrig√©es ({nonConformites.filter(nc => nc.statut === 'corrigee' || nc.statut === 'fermee').length})
        </Button>
      </div>

      {filteredNC.length === 0 ? (
        <div className="empty-state">
          <p>Aucune non-conformit√© trouv√©e</p>
        </div>
      ) : (
        <div className="nc-list">
          {filteredNC.map(nc => (
            <div key={nc.id} className="nc-card">
              <div className="nc-header">
                <h4>{nc.titre}</h4>
                <span className={`statut-badge ${nc.statut}`}>{nc.statut}</span>
              </div>
              
              <div className="nc-details">
                <p><strong>Description:</strong> {nc.description || 'N/A'}</p>
                <p><strong>Gravit√©:</strong> <span className={`gravite-badge ${nc.gravite}`}>{nc.gravite}</span></p>
                {nc.delai_correction && (
                  <p><strong>D√©lai correction:</strong> {nc.delai_correction}</p>
                )}
              </div>

              <div className="nc-actions">
                <select
                  value={nc.statut}
                  onChange={(e) => handleUpdateStatut(nc.id, e.target.value)}
                  className="statut-select"
                >
                  <option value="ouverte">Ouverte</option>
                  <option value="en_cours">En cours</option>
                  <option value="corrigee">Corrig√©e</option>
                  <option value="fermee">Ferm√©e</option>
                </select>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

const CalendrierInspections = ({ setCurrentView, batiments, filteredBatimentId, setFilteredBatimentId }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [inspections, setInspections] = useState([]);
  const [loading, setLoading] = useState(true);
  const [currentMonth, setCurrentMonth] = useState(new Date());

  useEffect(() => {
    const fetchInspections = async () => {
      try {
        const data = await apiGet(tenantSlug, '/prevention/inspections');
        setInspections(data);
      } catch (error) {
        console.error('Erreur chargement inspections:', error);
        toast({
          title: "Erreur",
          description: "Impossible de charger les inspections",
          variant: "destructive"
        });
      } finally {
        setLoading(false);
      }
    };

    fetchInspections();
  }, [tenantSlug]);

  // Filtrer les inspections par b√¢timent si sp√©cifi√©
  const filteredInspections = filteredBatimentId 
    ? inspections.filter(insp => insp.batiment_id === filteredBatimentId)
    : inspections;

  const filteredBatiment = filteredBatimentId ? batiments.find(b => b.id === filteredBatimentId) : null;

  const getDaysInMonth = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    return { daysInMonth, startingDayOfWeek, year, month };
  };

  const getInspectionsForDay = (day) => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    return filteredInspections.filter(insp => insp.date_inspection === dateStr);
  };

  const getBatimentName = (batimentId) => {
    const batiment = batiments.find(b => b.id === batimentId);
    return batiment?.nom_etablissement || 'Inconnu';
  };

  const getSuggestedInspections = () => {
    // B√¢timents sans inspection dans les 3 derniers mois
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    
    return batiments.filter(batiment => {
      const batimentInspections = filteredInspections.filter(insp => insp.batiment_id === batiment.id);
      if (batimentInspections.length === 0) return true;
      
      const lastInspection = batimentInspections.sort((a, b) => 
        new Date(b.date_inspection) - new Date(a.date_inspection)
      )[0];
      
      return new Date(lastInspection.date_inspection) < threeMonthsAgo;
    });
  };

  const { daysInMonth, startingDayOfWeek, year, month } = getDaysInMonth(currentMonth);
  const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
  const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

  const previousMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
  };

  const nextMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
  };

  const today = new Date();
  const isToday = (day) => {
    return today.getDate() === day && 
           today.getMonth() === month && 
           today.getFullYear() === year;
  };

  if (loading) {
    return <div className="loading-spinner">Chargement du calendrier...</div>;
  }

  return (
    <div className="calendrier-container">
      <div className="page-header">
        <h2>üìÖ Calendrier des Inspections</h2>
        <Button onClick={() => setCurrentView('nouvelle-inspection')}>
          ‚ûï Planifier une inspection
        </Button>
      </div>

      {filteredBatiment && (
        <div style={{ 
          backgroundColor: '#eff6ff', 
          border: '2px solid #3b82f6',
          borderRadius: '0.5rem',
          padding: '1rem',
          marginBottom: '1.5rem',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <div>
            <strong>üè¢ Filtr√© par b√¢timent:</strong> {filteredBatiment.nom_etablissement || filteredBatiment.adresse_civique}
          </div>
          <Button size="sm" onClick={() => setFilteredBatimentId(null)} variant="outline">
            ‚ùå Retirer filtre
          </Button>
        </div>
      )}

      {/* Navigation du calendrier */}
      <div className="calendar-nav">
        <Button variant="outline" onClick={previousMonth}>
          ‚Üê Mois pr√©c√©dent
        </Button>
        <h3>{monthNames[month]} {year}</h3>
        <Button variant="outline" onClick={nextMonth}>
          Mois suivant ‚Üí
        </Button>
      </div>

      {/* Grille du calendrier */}
      <div className="calendar-grid">
        {/* En-t√™tes des jours */}
        {dayNames.map(day => (
          <div key={day} className="calendar-day-header">
            {day}
          </div>
        ))}
        
        {/* Jours vides au d√©but */}
        {Array.from({ length: startingDayOfWeek }).map((_, index) => (
          <div key={`empty-${index}`} className="calendar-day empty"></div>
        ))}
        
        {/* Jours du mois */}
        {Array.from({ length: daysInMonth }).map((_, index) => {
          const day = index + 1;
          const dayInspections = getInspectionsForDay(day);
          
          return (
            <div 
              key={day} 
              className={`calendar-day ${isToday(day) ? 'today' : ''} ${dayInspections.length > 0 ? 'has-inspections' : ''}`}
            >
              <div className="day-number">{day}</div>
              {dayInspections.length > 0 && (
                <div className="day-inspections">
                  {dayInspections.slice(0, 2).map(insp => (
                    <div 
                      key={insp.id} 
                      className={`inspection-badge ${insp.statut_global}`}
                      title={getBatimentName(insp.batiment_id)}
                    >
                      {getBatimentName(insp.batiment_id).substring(0, 15)}...
                    </div>
                  ))}
                  {dayInspections.length > 2 && (
                    <div className="more-inspections">
                      +{dayInspections.length - 2} autre(s)
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Inspections √† venir sugg√©r√©es */}
      <div className="suggested-inspections">
        <h3>üîî Inspections Sugg√©r√©es</h3>
        <p className="subtitle">B√¢timents sans inspection depuis plus de 3 mois</p>
        
        {getSuggestedInspections().length === 0 ? (
          <div className="empty-state">
            ‚úÖ Tous les b√¢timents sont √† jour dans leurs inspections
          </div>
        ) : (
          <div className="suggested-list">
            {getSuggestedInspections().slice(0, 10).map(batiment => (
              <div key={batiment.id} className="suggested-item">
                <div className="suggested-info">
                  <h4>{batiment.nom_etablissement}</h4>
                  <p>{batiment.adresse_civique}</p>
                  {batiment.groupe_occupation && (
                    <span className="groupe-badge">Groupe {batiment.groupe_occupation}</span>
                  )}
                </div>
                <Button 
                  size="sm"
                  onClick={() => {
                    // Pre-remplir le formulaire avec ce b√¢timent
                    setCurrentView('nouvelle-inspection');
                  }}
                >
                  Planifier
                </Button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* L√©gende */}
      <div className="calendar-legend">
        <h4>L√©gende</h4>
        <div className="legend-items">
          <div className="legend-item">
            <div className="legend-color today-marker"></div>
            <span>Aujourd'hui</span>
          </div>
          <div className="legend-item">
            <div className="legend-color conforme"></div>
            <span>Inspection conforme</span>
          </div>
          <div className="legend-item">
            <div className="legend-color non_conforme"></div>
            <span>Inspection non-conforme</span>
          </div>
        </div>
      </div>
    </div>
  );
};

const ModuleRapports = ({ setCurrentView }) => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [tendances, setTendances] = useState(null);
  const [loading, setLoading] = useState(true);
  const [exporting, setExporting] = useState(false);

  useEffect(() => {
    const fetchTendances = async () => {
      try {
        const data = await apiGet(tenantSlug, '/prevention/rapports/tendances');
        setTendances(data.tendances);
      } catch (error) {
        console.error('Erreur chargement tendances:', error);
        toast({
          title: "Erreur",
          description: "Impossible de charger les tendances",
          variant: "destructive"
        });
      } finally {
        setLoading(false);
      }
    };

    fetchTendances();
  }, [tenantSlug]);

  const handleExport = async (type) => {
    try {
      setExporting(true);
      
      const response = await fetch(
        `${process.env.REACT_APP_BACKEND_URL}/api/${tenantSlug}/prevention/export-excel?type_export=${type}`,
        {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem(`${tenantSlug}_token`)}`
          }
        }
      );
      
      if (!response.ok) throw new Error('Erreur export');
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `export_${type}_${new Date().toISOString().split('T')[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      toast({
        title: "Succ√®s",
        description: "Export Excel t√©l√©charg√© avec succ√®s"
      });
    } catch (error) {
      console.error('Erreur export:', error);
      toast({
        title: "Erreur",
        description: "Impossible d'exporter les donn√©es",
        variant: "destructive"
      });
    } finally {
      setExporting(false);
    }
  };

  if (loading) {
    return <div className="loading-spinner">Chargement des rapports...</div>;
  }

  return (
    <div className="rapports-container">
      <div className="page-header">
        <h2>üìä Rapports et Analyses</h2>
      </div>

      {/* Exports Excel */}
      <div className="rapport-section">
        <h3>üì• Exports Excel</h3>
        <p className="section-description">T√©l√©chargez vos donn√©es en format Excel pour analyses approfondies</p>
        
        <div className="export-cards">
          <div className="export-card">
            <div className="export-icon">üìã</div>
            <h4>Inspections</h4>
            <p>Toutes les inspections avec dates, statuts, scores et non-conformit√©s</p>
            <Button 
              onClick={() => handleExport('inspections')}
              disabled={exporting}
            >
              {exporting ? 'Export...' : 'T√©l√©charger Excel'}
            </Button>
          </div>

          <div className="export-card">
            <div className="export-icon">üè¢</div>
            <h4>B√¢timents</h4>
            <p>Liste compl√®te des b√¢timents avec informations et historiques d'inspections</p>
            <Button 
              onClick={() => handleExport('batiments')}
              disabled={exporting}
            >
              {exporting ? 'Export...' : 'T√©l√©charger Excel'}
            </Button>
          </div>

          <div className="export-card">
            <div className="export-icon">‚ö†Ô∏è</div>
            <h4>Non-Conformit√©s</h4>
            <p>Toutes les non-conformit√©s d√©tect√©es avec statuts et d√©lais de correction</p>
            <Button 
              onClick={() => handleExport('non_conformites')}
              disabled={exporting}
            >
              {exporting ? 'Export...' : 'T√©l√©charger Excel'}
            </Button>
          </div>
        </div>
      </div>

      {/* Graphiques de tendances */}
      {tendances && (
        <div className="rapport-section">
          <h3>üìà Tendances sur 6 mois</h3>
          <p className="section-description">√âvolution des inspections et de la conformit√©</p>
          
          <div className="tendances-grid">
            {/* Graphique inspections */}
            <div className="tendance-card">
              <h4>Nombre d'Inspections</h4>
              <div className="chart-bars">
                {tendances.map((month, idx) => (
                  <div key={idx} className="chart-bar-wrapper">
                    <div className="chart-bar-label">{month.mois.split(' ')[0]}</div>
                    <div className="chart-bar-container">
                      <div 
                        className="chart-bar"
                        style={{ 
                          height: `${Math.max((month.inspections_total / Math.max(...tendances.map(m => m.inspections_total))) * 100, 5)}%` 
                        }}
                        title={`${month.inspections_total} inspections`}
                      >
                        <span className="bar-value">{month.inspections_total}</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Graphique taux conformit√© */}
            <div className="tendance-card">
              <h4>Taux de Conformit√© (%)</h4>
              <div className="chart-bars">
                {tendances.map((month, idx) => (
                  <div key={idx} className="chart-bar-wrapper">
                    <div className="chart-bar-label">{month.mois.split(' ')[0]}</div>
                    <div className="chart-bar-container">
                      <div 
                        className="chart-bar conformite-bar"
                        style={{ height: `${month.taux_conformite}%` }}
                        title={`${month.taux_conformite}% conforme`}
                      >
                        <span className="bar-value">{month.taux_conformite}%</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Graphique NC */}
            <div className="tendance-card">
              <h4>Nouvelles Non-Conformit√©s</h4>
              <div className="chart-bars">
                {tendances.map((month, idx) => (
                  <div key={idx} className="chart-bar-wrapper">
                    <div className="chart-bar-label">{month.mois.split(' ')[0]}</div>
                    <div className="chart-bar-container">
                      <div 
                        className="chart-bar nc-bar"
                        style={{ 
                          height: `${Math.max((month.non_conformites_nouvelles / Math.max(...tendances.map(m => m.non_conformites_nouvelles || 1))) * 100, 5)}%` 
                        }}
                        title={`${month.non_conformites_nouvelles} NC`}
                      >
                        <span className="bar-value">{month.non_conformites_nouvelles}</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Tableau r√©capitulatif */}
      {tendances && (
        <div className="rapport-section">
          <h3>üìä Tableau R√©capitulatif</h3>
          <div className="recap-table-wrapper">
            <table className="recap-table">
              <thead>
                <tr>
                  <th>P√©riode</th>
                  <th>Inspections</th>
                  <th>Conformes</th>
                  <th>Taux Conformit√©</th>
                  <th>Nouvelles NC</th>
                </tr>
              </thead>
              <tbody>
                {tendances.map((month, idx) => (
                  <tr key={idx}>
                    <td>{month.mois}</td>
                    <td>{month.inspections_total}</td>
                    <td>{month.inspections_conformes}</td>
                    <td>
                      <span className={`taux-badge ${month.taux_conformite >= 80 ? 'good' : month.taux_conformite >= 50 ? 'medium' : 'bad'}`}>
                        {month.taux_conformite}%
                      </span>
                    </td>
                    <td>{month.non_conformites_nouvelles}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );
};

// Module Pr√©vention - Gestion des inspections et b√¢timents


// Modal pour ajout/modification de point d'eau
const PointEauModal = ({ point, onClose, onSave }) => {
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    type: point?.type || 'borne_fontaine',
    numero_identification: point?.numero_identification || '',
    latitude: point?.latitude || '',
    longitude: point?.longitude || '',
    adresse: point?.adresse || '',
    ville: point?.ville || '',
    notes: point?.notes || '',
    // Champs sp√©cifiques
    debit_gpm: point?.debit_gpm || '',
    marque: point?.marque || '',
    modele: point?.modele || '',
    etat: point?.etat || 'fonctionnel',
    etat_raccords: point?.etat_raccords || 'bon',
    accessibilite: point?.accessibilite || 'facile',
    capacite_litres: point?.capacite_litres || '',
    profondeur_metres: point?.profondeur_metres || '',
    etat_eau: point?.etat_eau || 'propre',
    type_source: point?.type_source || 'etang',
    frequence_inspection_mois: point?.frequence_inspection_mois || (point?.type === 'borne_seche' ? 6 : 12)
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      if (point?.id) {
        await apiPut(tenantSlug, `/points-eau/${point.id}`, formData);
        toast({
          title: "Succ√®s",
          description: "Point d'eau modifi√© avec succ√®s"
        });
      } else {
        await apiPost(tenantSlug, '/points-eau', formData);
        toast({
          title: "Succ√®s",
          description: "Point d'eau cr√©√© avec succ√®s"
        });
      }
      onSave();
    } catch (error) {
      console.error('Erreur:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Une erreur est survenue",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000,
      padding: '1rem'
    }} onClick={onClose}>
      <div style={{
        background: 'white',
        borderRadius: '12px',
        maxWidth: '800px',
        width: '100%',
        maxHeight: '90vh',
        overflow: 'auto',
        padding: '2rem'
      }} onClick={(e) => e.stopPropagation()}>
        <h2 style={{ fontSize: '1.5rem', fontWeight: '700', marginBottom: '1.5rem' }}>
          {point ? 'Modifier' : 'Ajouter'} un point d'eau
        </h2>

        <form onSubmit={handleSubmit}>
          {/* Type */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
              Type de point d'eau *
            </label>
            <select
              value={formData.type}
              onChange={(e) => setFormData({...formData, type: e.target.value})}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                fontSize: '0.95rem'
              }}
              required
            >
              <option value="borne_fontaine">‚õ≤ Borne-fontaine</option>
              <option value="borne_seche">üî• Borne s√®che</option>
              <option value="point_eau_statique">üíß Point d'eau statique</option>
            </select>
          </div>

          {/* Informations de base */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
            <div>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                N¬∞ Identification *
              </label>
              <input
                type="text"
                value={formData.numero_identification}
                onChange={(e) => setFormData({...formData, numero_identification: e.target.value})}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  borderRadius: '8px',
                  border: '1px solid #d1d5db',
                  fontSize: '0.95rem'
                }}
                required
                placeholder="Ex: BF-001"
              />
            </div>
            <div>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                Ville
              </label>
              <input
                type="text"
                value={formData.ville}
                onChange={(e) => setFormData({...formData, ville: e.target.value})}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  borderRadius: '8px',
                  border: '1px solid #d1d5db',
                  fontSize: '0.95rem'
                }}
                placeholder="Ex: Montr√©al"
              />
            </div>
          </div>

          {/* Adresse */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
              Adresse
            </label>
            <input
              type="text"
              value={formData.adresse}
              onChange={(e) => setFormData({...formData, adresse: e.target.value})}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                fontSize: '0.95rem'
              }}
              placeholder="Ex: 123 Rue Principale"
            />
          </div>

          {/* Coordonn√©es GPS */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
            <div>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                Latitude *
              </label>
              <input
                type="number"
                step="any"
                value={formData.latitude}
                onChange={(e) => setFormData({...formData, latitude: parseFloat(e.target.value)})}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  borderRadius: '8px',
                  border: '1px solid #d1d5db',
                  fontSize: '0.95rem'
                }}
                required
                placeholder="Ex: 45.5017"
              />
            </div>
            <div>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                Longitude *
              </label>
              <input
                type="number"
                step="any"
                value={formData.longitude}
                onChange={(e) => setFormData({...formData, longitude: parseFloat(e.target.value)})}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  borderRadius: '8px',
                  border: '1px solid #d1d5db',
                  fontSize: '0.95rem'
                }}
                required
                placeholder="Ex: -73.5673"
              />
            </div>
          </div>

          {/* Champs sp√©cifiques selon le type */}
          {(formData.type === 'borne_fontaine' || formData.type === 'borne_seche') && (
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                  D√©bit (GPM)
                </label>
                <input
                  type="number"
                  step="any"
                  value={formData.debit_gpm}
                  onChange={(e) => setFormData({...formData, debit_gpm: parseFloat(e.target.value)})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #d1d5db',
                    fontSize: '0.95rem'
                  }}
                  placeholder="Ex: 1000"
                />
              </div>
              {formData.type === 'borne_fontaine' && (
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                    √âtat
                  </label>
                  <select
                    value={formData.etat}
                    onChange={(e) => setFormData({...formData, etat: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      borderRadius: '8px',
                      border: '1px solid #d1d5db',
                      fontSize: '0.95rem'
                    }}
                  >
                    <option value="fonctionnel">Fonctionnel</option>
                    <option value="defectueux">D√©fectueux</option>
                    <option value="inaccessible">Inaccessible</option>
                  </select>
                </div>
              )}
            </div>
          )}

          {formData.type === 'borne_seche' && (
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                  √âtat des raccords
                </label>
                <select
                  value={formData.etat_raccords}
                  onChange={(e) => setFormData({...formData, etat_raccords: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #d1d5db',
                    fontSize: '0.95rem'
                  }}
                >
                  <option value="bon">Bon</option>
                  <option value="moyen">Moyen</option>
                  <option value="mauvais">Mauvais</option>
                </select>
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                  Accessibilit√©
                </label>
                <select
                  value={formData.accessibilite}
                  onChange={(e) => setFormData({...formData, accessibilite: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #d1d5db',
                    fontSize: '0.95rem'
                  }}
                >
                  <option value="facile">Facile</option>
                  <option value="difficile">Difficile</option>
                  <option value="inaccessible">Inaccessible</option>
                </select>
              </div>
            </div>
          )}

          {formData.type === 'point_eau_statique' && (
            <>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                    Type de source
                  </label>
                  <select
                    value={formData.type_source}
                    onChange={(e) => setFormData({...formData, type_source: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      borderRadius: '8px',
                      border: '1px solid #d1d5db',
                      fontSize: '0.95rem'
                    }}
                  >
                    <option value="etang">√âtang</option>
                    <option value="bassin">Bassin</option>
                    <option value="riviere">Rivi√®re</option>
                    <option value="lac">Lac</option>
                    <option value="autre">Autre</option>
                  </select>
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                    Accessibilit√©
                  </label>
                  <select
                    value={formData.accessibilite}
                    onChange={(e) => setFormData({...formData, accessibilite: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      borderRadius: '8px',
                      border: '1px solid #d1d5db',
                      fontSize: '0.95rem'
                    }}
                  >
                    <option value="vehicule">V√©hicule</option>
                    <option value="pied">√Ä pied</option>
                    <option value="difficile">Difficile</option>
                  </select>
                </div>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                    Capacit√© (litres)
                  </label>
                  <input
                    type="number"
                    step="any"
                    value={formData.capacite_litres}
                    onChange={(e) => setFormData({...formData, capacite_litres: parseFloat(e.target.value)})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      borderRadius: '8px',
                      border: '1px solid #d1d5db',
                      fontSize: '0.95rem'
                    }}
                    placeholder="Ex: 50000"
                  />
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                    Profondeur (m√®tres)
                  </label>
                  <input
                    type="number"
                    step="any"
                    value={formData.profondeur_metres}
                    onChange={(e) => setFormData({...formData, profondeur_metres: parseFloat(e.target.value)})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      borderRadius: '8px',
                      border: '1px solid #d1d5db',
                      fontSize: '0.95rem'
                    }}
                    placeholder="Ex: 3.5"
                  />
                </div>
              </div>
            </>
          )}

          {/* Notes */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
              Notes
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData({...formData, notes: e.target.value})}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                fontSize: '0.95rem',
                minHeight: '100px',
                resize: 'vertical'
              }}
              placeholder="Notes additionnelles..."
            />
          </div>

          {/* Boutons */}
          <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
            <button
              type="button"
              onClick={onClose}
              style={{
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                background: 'white',
                cursor: 'pointer',
                fontSize: '0.95rem'
              }}
            >
              Annuler
            </button>
            <button
              type="submit"
              disabled={loading}
              style={{
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                border: 'none',
                background: '#3b82f6',
                color: 'white',
                cursor: loading ? 'not-allowed' : 'pointer',
                fontSize: '0.95rem',
                fontWeight: '600'
              }}
            >
              {loading ? 'Enregistrement...' : 'Enregistrer'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Modal pour cr√©er une inspection
const InspectionModal = ({ point, onClose, onSave }) => {
  const { user, tenantSlug } = useTenant();
  const { toast } = useToast();
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    point_eau_id: point?.id || '',
    inspecteur_id: user?.id || '',
    date_inspection: new Date().toISOString().split('T')[0],
    etat_general: 'conforme',
    debit_mesure_gpm: '',
    observations: '',
    defauts_constates: [],
    actions_requises: '',
    // Champs sp√©cifiques bornes s√®ches
    etat_raccords: 'bon',
    test_pression_ok: true,
    // Champs sp√©cifiques points statiques
    niveau_eau: 'moyen',
    accessibilite_verifiee: 'vehicule'
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      await apiPost(tenantSlug, '/approvisionnement-eau/inspections', formData);
      toast({
        title: "Succ√®s",
        description: "Inspection cr√©√©e avec succ√®s"
      });
      onSave();
    } catch (error) {
      console.error('Erreur:', error);
      toast({
        title: "Erreur",
        description: error.response?.data?.detail || "Une erreur est survenue",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000,
      padding: '1rem'
    }} onClick={onClose}>
      <div style={{
        background: 'white',
        borderRadius: '12px',
        maxWidth: '700px',
        width: '100%',
        maxHeight: '90vh',
        overflow: 'auto',
        padding: '2rem'
      }} onClick={(e) => e.stopPropagation()}>
        <h2 style={{ fontSize: '1.5rem', fontWeight: '700', marginBottom: '1rem' }}>
          Nouvelle inspection - {point?.numero_identification}
        </h2>
        <p style={{ color: '#6b7280', marginBottom: '1.5rem', fontSize: '0.95rem' }}>
          Type: {point?.type === 'borne_fontaine' ? '‚õ≤ Borne-fontaine' : 
                point?.type === 'borne_seche' ? 'üî• Borne s√®che' : 
                'üíß Point d\'eau statique'}
        </p>

        <form onSubmit={handleSubmit}>
          {/* Date inspection */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
              Date d'inspection *
            </label>
            <input
              type="date"
              value={formData.date_inspection}
              onChange={(e) => setFormData({...formData, date_inspection: e.target.value})}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                fontSize: '0.95rem'
              }}
              required
            />
          </div>

          {/* √âtat g√©n√©ral */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
              √âtat g√©n√©ral *
            </label>
            <select
              value={formData.etat_general}
              onChange={(e) => setFormData({...formData, etat_general: e.target.value})}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                fontSize: '0.95rem'
              }}
              required
            >
              <option value="conforme">‚úì Conforme</option>
              <option value="non_conforme">‚ö† Non conforme</option>
              <option value="defectueux">‚úó D√©fectueux</option>
            </select>
          </div>

          {/* D√©bit mesur√© */}
          {(point?.type === 'borne_fontaine' || point?.type === 'borne_seche') && (
            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                D√©bit mesur√© (GPM)
              </label>
              <input
                type="number"
                step="any"
                value={formData.debit_mesure_gpm}
                onChange={(e) => setFormData({...formData, debit_mesure_gpm: parseFloat(e.target.value)})}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  borderRadius: '8px',
                  border: '1px solid #d1d5db',
                  fontSize: '0.95rem'
                }}
                placeholder="Ex: 1000"
              />
            </div>
          )}

          {/* Champs sp√©cifiques bornes s√®ches */}
          {point?.type === 'borne_seche' && (
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                  √âtat des raccords
                </label>
                <select
                  value={formData.etat_raccords}
                  onChange={(e) => setFormData({...formData, etat_raccords: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #d1d5db',
                    fontSize: '0.95rem'
                  }}
                >
                  <option value="bon">Bon</option>
                  <option value="moyen">Moyen</option>
                  <option value="mauvais">Mauvais</option>
                </select>
              </div>
              <div>
                <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer', marginTop: '1.5rem' }}>
                  <input
                    type="checkbox"
                    checked={formData.test_pression_ok}
                    onChange={(e) => setFormData({...formData, test_pression_ok: e.target.checked})}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontSize: '0.95rem', fontWeight: '600' }}>Test de pression OK</span>
                </label>
              </div>
            </div>
          )}

          {/* Champs sp√©cifiques points statiques */}
          {point?.type === 'point_eau_statique' && (
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                  Niveau d'eau
                </label>
                <select
                  value={formData.niveau_eau}
                  onChange={(e) => setFormData({...formData, niveau_eau: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #d1d5db',
                    fontSize: '0.95rem'
                  }}
                >
                  <option value="bas">Bas</option>
                  <option value="moyen">Moyen</option>
                  <option value="haut">Haut</option>
                </select>
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
                  Accessibilit√© v√©rifi√©e
                </label>
                <select
                  value={formData.accessibilite_verifiee}
                  onChange={(e) => setFormData({...formData, accessibilite_verifiee: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #d1d5db',
                    fontSize: '0.95rem'
                  }}
                >
                  <option value="vehicule">V√©hicule</option>
                  <option value="pied">√Ä pied</option>
                  <option value="difficile">Difficile</option>
                </select>
              </div>
            </div>
          )}

          {/* Observations */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
              Observations
            </label>
            <textarea
              value={formData.observations}
              onChange={(e) => setFormData({...formData, observations: e.target.value})}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                fontSize: '0.95rem',
                minHeight: '100px',
                resize: 'vertical'
              }}
              placeholder="Observations g√©n√©rales..."
            />
          </div>

          {/* Actions requises */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', fontSize: '0.95rem' }}>
              Actions requises
            </label>
            <textarea
              value={formData.actions_requises}
              onChange={(e) => setFormData({...formData, actions_requises: e.target.value})}
              style={{
                width: '100%',
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                fontSize: '0.95rem',
                minHeight: '80px',
                resize: 'vertical'
              }}
              placeholder="Actions √† entreprendre..."
            />
          </div>

          {/* Boutons */}
          <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
            <button
              type="button"
              onClick={onClose}
              style={{
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                border: '1px solid #d1d5db',
                background: 'white',
                cursor: 'pointer',
                fontSize: '0.95rem'
              }}
            >
              Annuler
            </button>
            <button
              type="submit"
              disabled={loading}
              style={{
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                border: 'none',
                background: '#10b981',
                color: 'white',
                cursor: loading ? 'not-allowed' : 'pointer',
                fontSize: '0.95rem',
                fontWeight: '600'
              }}
            >
              {loading ? 'Enregistrement...' : 'Enregistrer l\'inspection'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};


// ==================== MODULE APPROVISIONNEMENT EN EAU ====================
const ApprovisionnementEau = () => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  
  const [currentView, setCurrentView] = useState('carte');
  const [pointsEau, setPointsEau] = useState([]);
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(false);
  const [selectedPoint, setSelectedPoint] = useState(null);
  const [showPointModal, setShowPointModal] = useState(false);
  const [showInspectionModal, setShowInspectionModal] = useState(false);
  const [typeFilter, setTypeFilter] = useState('all');
  const [statutFilter, setStatutFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [map, setMap] = useState(null);
  const [mapCenter, setMapCenter] = useState([45.5017, -73.5673]); // Montr√©al par d√©faut
  const [mapZoom, setMapZoom] = useState(12);
  const [mapLayer, setMapLayer] = useState('plan'); // 'plan' ou 'satellite'

  // Charger les points d'eau
  const fetchPointsEau = async () => {
    try {
      setLoading(true);
      let url = '/points-eau';
      const params = new URLSearchParams();
      
      if (typeFilter !== 'all') params.append('type', typeFilter);
      if (statutFilter !== 'all') params.append('etat', statutFilter);
      
      if (params.toString()) url += '?' + params.toString();
      
      const data = await apiGet(tenantSlug, url);
      setPointsEau(data);
      
      // Centrer la carte sur le premier point si disponible
      if (data.length > 0 && data[0].latitude && data[0].longitude) {
        setMapCenter([data[0].latitude, data[0].longitude]);
      }
    } catch (error) {
      console.error('Erreur chargement points d\'eau:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les points d'eau",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  // Charger les statistiques
  const fetchStats = async () => {
    try {
      const data = await apiGet(tenantSlug, '/points-eau-statistiques');
      setStats(data);
    } catch (error) {
      console.error('Erreur chargement statistiques:', error);
    }
  };

  useEffect(() => {
    fetchPointsEau();
    fetchStats();
  }, [tenantSlug, typeFilter, statutFilter]);

  // Filtrer les points selon la recherche
  const filteredPoints = pointsEau.filter(point => {
    if (!searchTerm) return true;
    const term = searchTerm.toLowerCase();
    return (
      point.numero_identification?.toLowerCase().includes(term) ||
      point.adresse?.toLowerCase().includes(term) ||
      point.ville?.toLowerCase().includes(term)
    );
  });

  // D√©terminer la couleur du marqueur selon le statut
  const getMarkerColor = (statutCouleur) => {
    switch (statutCouleur) {
      case 'vert': return '#10b981';
      case 'orange': return '#f59e0b';
      case 'rouge': return '#ef4444';
      default: return '#9ca3af';
    }
  };

  // D√©terminer l'ic√¥ne selon le type
  const getTypeIcon = (type) => {
    switch (type) {
      case 'borne_fontaine': return '‚õ≤';
      case 'borne_seche': return 'üî•';
      case 'point_eau_statique': return 'üíß';
      default: return 'üìç';
    }
  };

  // Obtenir l'ic√¥ne Leaflet personnalis√©e avec badge color√©
  const getLeafletIcon = (type, statutCouleur) => {
    const iconUrls = {
      borne_fontaine: 'https://customer-assets.emergentagent.com/job_1c79b284-3589-40f0-b5e3-5fa8640320ff/artifacts/opwhu1ma_Borne%20fontaine.png',
      borne_seche: 'https://customer-assets.emergentagent.com/job_1c79b284-3589-40f0-b5e3-5fa8640320ff/artifacts/wkhxcmid_Borne%20seche.png',
      point_eau_statique: 'https://customer-assets.emergentagent.com/job_1c79b284-3589-40f0-b5e3-5fa8640320ff/artifacts/1nhnxx97_eau.png'
    };

    const badgeColor = statutCouleur === 'vert' ? '#10b981' : statutCouleur === 'jaune' ? '#f59e0b' : statutCouleur === 'rouge' ? '#ef4444' : '#6b7280';

    return L.divIcon({
      html: `
        <div style="position: relative; width: 40px; height: 40px;">
          <img src="${iconUrls[type] || iconUrls.point_eau_statique}" style="width: 40px; height: 40px;" />
          <div style="
            position: absolute;
            bottom: 0px;
            right: 0px;
            width: 14px;
            height: 14px;
            background: ${badgeColor};
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          "></div>
        </div>
      `,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });
  };

  // Ouvrir le modal d'ajout/modification
  const openPointModal = (point = null) => {
    setSelectedPoint(point);
    setShowPointModal(true);
  };

  // Ouvrir le modal d'inspection
  const openInspectionModal = (point) => {
    setSelectedPoint(point);
    setShowInspectionModal(true);
  };

  // Supprimer un point
  const deletePoint = async (pointId) => {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce point d\'eau ?')) return;
    
    try {
      await apiDelete(tenantSlug, `/points-eau/${pointId}`);
      toast({
        title: "Succ√®s",
        description: "Point d'eau supprim√© avec succ√®s"
      });
      fetchPointsEau();
      fetchStats();
    } catch (error) {
      console.error('Erreur suppression:', error);
      toast({
        title: "Erreur",
        description: "Impossible de supprimer le point d'eau",
        variant: "destructive"
      });
    }
  };

  // Composant pour g√©rer le clic sur la carte
  const MapClickHandler = () => {
    const map = useMapEvents({
      click: (e) => {
        // Seulement pour admin/superviseur
        if (user?.role === 'admin' || user?.role === 'superviseur') {
          openPointModal({
            latitude: e.latlng.lat,
            longitude: e.latlng.lng,
            type: 'borne_fontaine',
            ville: 'Shefford'
          });
        }
      }
    });
    return null;
  };

  // Rendu de la carte
  const renderCarte = () => (
    <div style={{ height: 'calc(100vh - 300px)', minHeight: '500px', borderRadius: '8px', overflow: 'hidden', border: '1px solid #e5e7eb', position: 'relative' }}>
      {/* Toggle Plan/Satellite */}
      <div style={{
        position: 'absolute',
        top: '10px',
        right: '10px',
        zIndex: 1000,
        background: 'white',
        borderRadius: '8px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
        display: 'flex'
      }}>
        <button
          onClick={() => setMapLayer('plan')}
          style={{
            padding: '8px 16px',
            border: 'none',
            background: mapLayer === 'plan' ? '#3b82f6' : 'white',
            color: mapLayer === 'plan' ? 'white' : '#6b7280',
            cursor: 'pointer',
            fontWeight: '600',
            fontSize: '0.875rem',
            borderRadius: '8px 0 0 8px',
            borderRight: '1px solid #e5e7eb'
          }}
        >
          üó∫Ô∏è Plan
        </button>
        <button
          onClick={() => setMapLayer('satellite')}
          style={{
            padding: '8px 16px',
            border: 'none',
            background: mapLayer === 'satellite' ? '#3b82f6' : 'white',
            color: mapLayer === 'satellite' ? 'white' : '#6b7280',
            cursor: 'pointer',
            fontWeight: '600',
            fontSize: '0.875rem',
            borderRadius: '0 8px 8px 0'
          }}
        >
          üõ∞Ô∏è Satellite
        </button>
      </div>
      <MapContainer 
        center={mapCenter} 
        zoom={mapZoom} 
        style={{ height: '100%', width: '100%' }}
        whenCreated={setMap}
      >
        {mapLayer === 'plan' ? (
          <TileLayer
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />
        ) : (
          <TileLayer
            attribution='&copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            url="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
          />
        )}
        <MapClickHandler />
        {filteredPoints.map(point => (
          point.latitude && point.longitude && (
            <Marker
              key={point.id}
              position={[point.latitude, point.longitude]}
              icon={getLeafletIcon(point.type, point.statut_couleur)}
            >
              <Popup>
                <div style={{ minWidth: '250px' }}>
                  <h3 style={{ fontWeight: '600', marginBottom: '0.5rem', fontSize: '1rem' }}>
                    {getTypeIcon(point.type)} {point.numero_identification}
                  </h3>
                  <div style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '0.75rem' }}>
                    <p><strong>Type:</strong> {
                      point.type === 'borne_fontaine' ? 'Borne-fontaine' :
                      point.type === 'borne_seche' ? 'Borne s√®che' :
                      'Point d\'eau statique'
                    }</p>
                    {point.adresse && <p><strong>Adresse:</strong> {point.adresse}</p>}
                    {point.ville && <p><strong>Ville:</strong> {point.ville}</p>}
                    {point.debit_gpm && <p><strong>D√©bit:</strong> {point.debit_gpm} GPM</p>}
                    <p><strong>√âtat:</strong> <span style={{
                      padding: '2px 8px',
                      borderRadius: '12px',
                      fontSize: '0.75rem',
                      fontWeight: '500',
                      background: getMarkerColor(point.statut_couleur) + '20',
                      color: getMarkerColor(point.statut_couleur)
                    }}>
                      {point.etat || 'Non d√©fini'}
                    </span></p>
                  </div>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', marginTop: '0.75rem' }}>
                    <a
                      href={`https://www.google.com/maps/dir/?api=1&destination=${point.latitude},${point.longitude}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{
                        padding: '0.5rem',
                        background: '#059669',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontSize: '0.875rem',
                        textAlign: 'center',
                        textDecoration: 'none',
                        fontWeight: '500'
                      }}
                    >
                      üó∫Ô∏è Navigation (Google Maps)
                    </a>
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                      <button
                        onClick={() => {
                          openPointModal(point);
                        }}
                        style={{
                          flex: 1,
                          padding: '0.5rem',
                          background: '#3b82f6',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.875rem'
                        }}
                      >
                        Modifier
                      </button>
                      {point.type === 'borne_seche' && (
                        <button
                          onClick={() => openInspectionModal(point)}
                          style={{
                            flex: 1,
                            padding: '0.5rem',
                            background: '#dc2626',
                            color: 'white',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            fontSize: '0.875rem'
                          }}
                        >
                          Inspecter
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              </Popup>
            </Marker>
          )
        ))}
      </MapContainer>
    </div>
  );

  // Rendu de la vue liste
  const renderListe = () => (
    <div style={{ background: 'white', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
        <thead>
          <tr style={{ background: '#f9fafb', borderBottom: '2px solid #e5e7eb' }}>
            <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem' }}>Type</th>
            <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem' }}>N¬∞ Identification</th>
            <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem' }}>Adresse</th>
            <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem' }}>D√©bit</th>
            <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem' }}>√âtat</th>
            <th style={{ padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem' }}>Derni√®re Inspection</th>
            <th style={{ padding: '1rem', textAlign: 'center', fontWeight: '600', fontSize: '0.875rem' }}>Actions</th>
          </tr>
        </thead>
        <tbody>
          {filteredPoints.length === 0 ? (
            <tr>
              <td colSpan="7" style={{ padding: '3rem', textAlign: 'center', color: '#9ca3af' }}>
                Aucun point d'eau trouv√©
              </td>
            </tr>
          ) : (
            filteredPoints.map(point => (
              <tr key={point.id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                <td style={{ padding: '1rem', fontSize: '1.5rem' }}>
                  {getTypeIcon(point.type)}
                </td>
                <td style={{ padding: '1rem', fontSize: '0.875rem', fontWeight: '500' }}>
                  {point.numero_identification}
                </td>
                <td style={{ padding: '1rem', fontSize: '0.875rem', color: '#6b7280' }}>
                  {point.adresse || '-'}<br/>
                  <span style={{ fontSize: '0.75rem' }}>{point.ville || ''}</span>
                </td>
                <td style={{ padding: '1rem', fontSize: '0.875rem' }}>
                  {point.debit_gpm ? `${point.debit_gpm} GPM` : '-'}
                </td>
                <td style={{ padding: '1rem' }}>
                  <span style={{
                    padding: '4px 12px',
                    borderRadius: '12px',
                    fontSize: '0.75rem',
                    fontWeight: '500',
                    background: getMarkerColor(point.statut_couleur) + '20',
                    color: getMarkerColor(point.statut_couleur)
                  }}>
                    {point.statut_couleur === 'vert' && '‚úì Conforme'}
                    {point.statut_couleur === 'orange' && '‚ö† √Ä venir'}
                    {point.statut_couleur === 'rouge' && '‚úó En d√©faut'}
                    {point.statut_couleur === 'gris' && '‚óØ Non inspect√©'}
                  </span>
                </td>
                <td style={{ padding: '1rem', fontSize: '0.875rem', color: '#6b7280' }}>
                  {point.date_derniere_inspection ? 
                    new Date(point.date_derniere_inspection).toLocaleDateString('fr-FR') : 
                    'Jamais'}
                </td>
                <td style={{ padding: '1rem' }}>
                  <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'center' }}>
                    <button
                      onClick={() => openPointModal(point)}
                      style={{
                        padding: '0.5rem',
                        background: '#3b82f6',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontSize: '0.875rem'
                      }}
                      title="Modifier"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      onClick={() => openInspectionModal(point)}
                      style={{
                        padding: '0.5rem',
                        background: '#10b981',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontSize: '0.875rem'
                      }}
                      title="Inspecter"
                    >
                      üìã
                    </button>
                    {(user?.role === 'admin' || user?.role === 'superviseur') && (
                      <button
                        onClick={() => deletePoint(point.id)}
                        style={{
                          padding: '0.5rem',
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.875rem'
                        }}
                        title="Supprimer"
                      >
                        üóëÔ∏è
                      </button>
                    )}
                  </div>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );

  return (
    <div style={{ padding: '1.5rem', maxWidth: '1400px', margin: '0 auto' }}>
      {/* En-t√™te */}
      <div style={{ marginBottom: '2rem' }}>
        <h1 style={{ fontSize: '2rem', fontWeight: '700', marginBottom: '0.5rem', color: '#1f2937' }}>
          üíß Approvisionnement en Eau
        </h1>
        <p style={{ color: '#6b7280', fontSize: '0.95rem' }}>
          Gestion des points d'eau et inspections
        </p>
      </div>

      {/* Statistiques */}
      {stats && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '2rem' }}>
          <div style={{ background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #e5e7eb' }}>
            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>‚õ≤</div>
            <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#1f2937', marginBottom: '0.25rem' }}>
              {stats.par_type?.bornes_fontaines || 0}
            </div>
            <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Bornes-fontaines</div>
          </div>
          <div style={{ background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #e5e7eb' }}>
            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üî•</div>
            <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#1f2937', marginBottom: '0.25rem' }}>
              {stats.par_type?.bornes_seches || 0}
            </div>
            <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Bornes s√®ches</div>
          </div>
          <div style={{ background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #e5e7eb' }}>
            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üíß</div>
            <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#1f2937', marginBottom: '0.25rem' }}>
              {stats.par_type?.points_statiques || 0}
            </div>
            <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Points statiques</div>
          </div>
          <div style={{ background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #e5e7eb' }}>
            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>‚úì</div>
            <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#10b981', marginBottom: '0.25rem' }}>
              {stats.par_etat?.fonctionnels || 0}
            </div>
            <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Fonctionnels</div>
          </div>
          <div style={{ background: 'white', padding: '1.5rem', borderRadius: '12px', border: '1px solid #e5e7eb' }}>
            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üìã</div>
            <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#3b82f6', marginBottom: '0.25rem' }}>
              {stats.inspections_30_jours || 0}
            </div>
            <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Inspections (30j)</div>
          </div>
        </div>
      )}

      {/* Barre d'outils */}
      <div style={{ 
        background: 'white', 
        padding: '1rem', 
        borderRadius: '12px', 
        marginBottom: '1.5rem',
        border: '1px solid #e5e7eb',
        display: 'flex',
        flexWrap: 'wrap',
        gap: '1rem',
        alignItems: 'center'
      }}>
        {/* Bouton Ajouter */}
        {(user?.role === 'admin' || user?.role === 'superviseur') && (
          <button
            onClick={() => openPointModal(null)}
            style={{
              background: '#3b82f6',
              color: 'white',
              padding: '0.75rem 1.5rem',
              borderRadius: '8px',
              border: 'none',
              cursor: 'pointer',
              fontWeight: '600',
              fontSize: '0.95rem',
              display: 'flex',
              alignItems: 'center',
              gap: '0.5rem'
            }}
          >
            ‚ûï Ajouter un point d'eau
          </button>
        )}

        {/* Filtre Type */}
        <select
          value={typeFilter}
          onChange={(e) => setTypeFilter(e.target.value)}
          style={{
            padding: '0.75rem',
            borderRadius: '8px',
            border: '1px solid #d1d5db',
            fontSize: '0.95rem',
            minWidth: '180px'
          }}
        >
          <option value="all">Tous les types</option>
          <option value="borne_fontaine">Bornes-fontaines</option>
          <option value="borne_seche">Bornes s√®ches</option>
          <option value="point_eau_statique">Points statiques</option>
        </select>

        {/* Filtre Statut */}
        <select
          value={statutFilter}
          onChange={(e) => setStatutFilter(e.target.value)}
          style={{
            padding: '0.75rem',
            borderRadius: '8px',
            border: '1px solid #d1d5db',
            fontSize: '0.95rem',
            minWidth: '180px'
          }}
        >
          <option value="all">Tous les √©tats</option>
          <option value="fonctionnel">Fonctionnel</option>
          <option value="defectueux">D√©fectueux</option>
          <option value="inaccessible">Inaccessible</option>
        </select>

        {/* Recherche */}
        <input
          type="text"
          placeholder="Rechercher (n¬∞, adresse, ville)..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          style={{
            flex: 1,
            minWidth: '250px',
            padding: '0.75rem',
            borderRadius: '8px',
            border: '1px solid #d1d5db',
            fontSize: '0.95rem'
          }}
        />

        {/* Spacer pour pousser le toggle √† droite */}
        <div style={{ flex: 1, minWidth: '50px' }}></div>

        {/* Toggle Vue */}
        <div style={{ display: 'flex', gap: '0.5rem' }}>
          <button
            onClick={() => setCurrentView('carte')}
            style={{
              padding: '0.75rem 1rem',
              borderRadius: '8px',
              border: currentView === 'carte' ? '2px solid #3b82f6' : '1px solid #d1d5db',
              background: currentView === 'carte' ? '#eff6ff' : 'white',
              color: currentView === 'carte' ? '#3b82f6' : '#6b7280',
              cursor: 'pointer',
              fontWeight: '600',
              fontSize: '0.95rem',
              whiteSpace: 'nowrap'
            }}
          >
            üó∫Ô∏è Carte
          </button>
          <button
            onClick={() => setCurrentView('liste')}
            style={{
              padding: '0.75rem 1rem',
              borderRadius: '8px',
              border: currentView === 'liste' ? '2px solid #3b82f6' : '1px solid #d1d5db',
              background: currentView === 'liste' ? '#eff6ff' : 'white',
              color: currentView === 'liste' ? '#3b82f6' : '#6b7280',
              cursor: 'pointer',
              fontWeight: '600',
              fontSize: '0.95rem',
              whiteSpace: 'nowrap'
            }}
          >
            üìã Liste
          </button>
        </div>
      </div>

      {/* Contenu principal */}
      {loading ? (
        <div style={{ textAlign: 'center', padding: '3rem', color: '#6b7280' }}>
          Chargement...
        </div>
      ) : (
        <>
          {currentView === 'carte' ? renderCarte() : renderListe()}
        </>
      )}

      {/* Modals (√† impl√©menter avec les formulaires complets) */}
      {showPointModal && (
        <PointEauModal
          point={selectedPoint}
          onClose={() => {
            setShowPointModal(false);
            setSelectedPoint(null);
          }}
          onSave={() => {
            fetchPointsEau();
            fetchStats();
            setShowPointModal(false);
            setSelectedPoint(null);
          }}
        />
      )}

      {showInspectionModal && (
        <InspectionModal
          point={selectedPoint}
          onClose={() => {
            setShowInspectionModal(false);
            setSelectedPoint(null);
          }}
          onSave={() => {
            fetchPointsEau();
            fetchStats();
            setShowInspectionModal(false);
            setSelectedPoint(null);
          }}
        />
      )}
    </div>
  );
};


const Prevention = () => {
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();
  const { toast } = useToast();
  const [currentView, setCurrentView] = useState('dashboard');
  const [batiments, setBatiments] = useState([]);
  const [stats, setStats] = useState(null);
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(false);
  const [selectedBatiment, setSelectedBatiment] = useState(null);
  const [filteredBatimentId, setFilteredBatimentId] = useState(null); // Pour filtrer inspections/plans par b√¢timent
  const [showBatimentModal, setShowBatimentModal] = useState(false);
  const [selectedPlanId, setSelectedPlanId] = useState(null); // Pour afficher le viewer de plan
  const [grilles, setGrilles] = useState([]);
  const [selectedInspection, setSelectedInspection] = useState(null);
  const [viewMode, setViewMode] = useState('liste'); // 'liste' ou 'carte'
  const [googleMap, setGoogleMap] = useState(null);
  const [isMapLoaded, setIsMapLoaded] = useState(false);
  const [showImportCSV, setShowImportCSV] = useState(false);
  const [exporting, setExporting] = useState(false);

  // Fonction pour ouvrir le modal d'un b√¢timent
  const openBatimentModal = (batiment) => {
    setSelectedBatiment(batiment);
    setShowBatimentModal(true);
  };

  const fetchBatiments = async () => {
    try {
      setLoading(true);
      const data = await apiGet(tenantSlug, '/prevention/batiments');
      setBatiments(data);
    } catch (error) {
      console.error('Erreur chargement b√¢timents:', error);
      toast({
        title: "Erreur",
        description: "Impossible de charger les b√¢timents",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  const fetchStats = async () => {
    try {
      const data = await apiGet(tenantSlug, '/prevention/statistiques');
      setStats(data);
    } catch (error) {
      console.error('Erreur chargement statistiques:', error);
    }
  };

  const fetchNotifications = async () => {
    try {
      const data = await apiGet(tenantSlug, '/prevention/notifications');
      setNotifications(data.notifications || []);
    } catch (error) {
      console.error('Erreur chargement notifications:', error);
    }
  };

  useEffect(() => {
    fetchBatiments();
    fetchStats();
    fetchNotifications();
    fetchGrilles();
  }, [tenantSlug]);

  const fetchGrilles = async () => {
    try {
      const data = await apiGet(tenantSlug, '/prevention/grilles-inspection');
      setGrilles(data);
    } catch (error) {
      console.error('Erreur chargement grilles:', error);
    }
  };

  // D√©terminer la grille par d√©faut selon le type de b√¢timent
  const getDefaultGrille = (batiment) => {
    if (!grilles || grilles.length === 0) return null;
    
    // Si une seule grille, la retourner
    if (grilles.length === 1) return grilles[0];
    
    // Mapping type de b√¢timent ‚Üí grille
    const grilleMapping = {
      'C': 'residentiel',
      'A-1': 'residentiel',
      'A-2': 'soins',
      'B': 'soins',
      'D': 'commercial',
      'E': 'commercial',
      'F-1': 'industriel_elev√©',
      'F-2': 'industriel_moyen',
      'F-3': 'industriel_faible',
      'I': 'assembl√©e'
    };
    
    const key = batiment.sous_groupe || batiment.groupe_occupation;
    const grilleType = grilleMapping[key];
    
    // Chercher une grille correspondante
    const grille = grilles.find(g => 
      g.nom.toLowerCase().includes(grilleType) ||
      g.type_batiment === grilleType
    );
    
    // Si pas trouv√©, retourner la premi√®re grille g√©n√©rique
    return grille || grilles.find(g => g.nom.toLowerCase().includes('g√©n√©rique')) || grilles[0];
  };

  // Ouvrir le nouveau composant InspectionTerrain pour r√©aliser l'inspection
  const handleInspectBatiment = async (batiment) => {
    try {
      setLoading(true);
      
      // D√©terminer la grille par d√©faut
      const grille = getDefaultGrille(batiment);
      
      if (!grille) {
        toast({
          title: "Erreur",
          description: "Aucune grille d'inspection disponible. Cr√©ez-en une dans les param√®tres.",
          variant: "destructive"
        });
        return;
      }

      // Stocker les donn√©es dans localStorage pour InspectionTerrain
      localStorage.setItem('inspection_terrain_data', JSON.stringify({
        grille: grille,
        batiment: batiment,
        inspecteur_id: user.id,
        date_inspection: new Date().toISOString().split('T')[0]
      }));

      // Naviguer vers la vue inspection-terrain
      setCurrentView('inspection-terrain');

      toast({
        title: "Inspection d√©marr√©e",
        description: `Inspection pour ${batiment.nom_etablissement || batiment.adresse_civique}`
      });

    } catch (error) {
      console.error('Erreur d√©marrage inspection:', error);
      toast({
        title: "Erreur",
        description: "Impossible de d√©marrer l'inspection",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  const renderContent = () => {
    switch(currentView) {
      case 'dashboard':
        return (
          <div className="prevention-dashboard">
            {/* Notifications en haut */}
            {notifications.length > 0 && (
              <div className="notifications-section">
                <h3>üîî Notifications ({notifications.length})</h3>
                <div className="notifications-list">
                  {notifications.slice(0, 5).map(notif => (
                    <div key={notif.id} className={`notification-item priority-${notif.priority}`}>
                      <div className="notif-icon">
                        {notif.priority === 'urgent' && 'üö®'}
                        {notif.priority === 'high' && '‚ö†Ô∏è'}
                        {notif.priority === 'medium' && 'üìå'}
                      </div>
                      <div className="notif-content">
                        <h4>{notif.titre}</h4>
                        <p>{notif.description}</p>
                        {notif.jours_retard && (
                          <span className="notif-badge retard">{notif.jours_retard} jours de retard</span>
                        )}
                        {notif.jours_restants !== undefined && (
                          <span className="notif-badge warning">{notif.jours_restants} jours restants</span>
                        )}
                      </div>
                    </div>
                  ))}
                  {notifications.length > 5 && (
                    <div className="more-notifications">
                      +{notifications.length - 5} notification(s) suppl√©mentaire(s)
                    </div>
                  )}
                </div>
              </div>
            )}

            <div className="dashboard-stats">
              <div className="stat-card">
                <div className="stat-icon">üè¢</div>
                <div className="stat-content">
                  <div className="stat-number">{stats?.batiments?.total || batiments.length}</div>
                  <div className="stat-label">B√¢timents</div>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">üìã</div>
                <div className="stat-content">
                  <div className="stat-number">{stats?.inspections?.total || 0}</div>
                  <div className="stat-label">Inspections totales</div>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">‚ö†Ô∏è</div>
                <div className="stat-content">
                  <div className="stat-number">{stats?.non_conformites?.ouvertes || 0}</div>
                  <div className="stat-label">Non-conformit√©s ouvertes</div>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">üìà</div>
                <div className="stat-content">
                  <div className="stat-number">{stats?.inspections?.taux_conformite || 100}%</div>
                  <div className="stat-label">Taux conformit√©</div>
                </div>
              </div>
            </div>
          </div>
        );
      
      case 'batiments':
        return (
          <div className="prevention-batiments">
            <div className="page-header">
              <h2>üè¢ Gestion des B√¢timents</h2>
              <div className="batiments-header-controls">
                <div className="view-mode-toggle">
                  <button
                    onClick={() => setViewMode('carte')}
                    style={{
                      padding: '0.5rem 1rem',
                      border: 'none',
                      background: viewMode === 'carte' ? '#fff' : 'transparent',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontWeight: viewMode === 'carte' ? '600' : 'normal',
                      boxShadow: viewMode === 'carte' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                      transition: 'all 0.2s'
                    }}
                    title="Vue carte"
                  >
                    üó∫Ô∏è
                  </button>
                  <button
                    onClick={() => setViewMode('liste')}
                    style={{
                      padding: '0.5rem 1rem',
                      border: 'none',
                      background: viewMode === 'liste' ? '#fff' : 'transparent',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontWeight: viewMode === 'liste' ? '600' : 'normal',
                      boxShadow: viewMode === 'liste' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                      transition: 'all 0.2s'
                    }}
                    title="Vue liste"
                  >
                    üìã
                  </button>
                </div>
                <Button 
                  variant="outline" 
                  onClick={async () => {
                    try {
                      setExporting(true);
                      const token = localStorage.getItem(`${tenantSlug}_token`);
                      const response = await fetch(
                        `${process.env.REACT_APP_BACKEND_URL}/api/${tenantSlug}/prevention/export-excel?type_export=batiments`,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                      );
                      if (!response.ok) throw new Error('Erreur export');
                      const blob = await response.blob();
                      const url = window.URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = `batiments_${new Date().toISOString().split('T')[0]}.xlsx`;
                      document.body.appendChild(a);
                      a.click();
                      window.URL.revokeObjectURL(url);
                      document.body.removeChild(a);
                      toast({ title: "Export r√©ussi", description: "Le fichier Excel a √©t√© t√©l√©charg√©" });
                    } catch (error) {
                      console.error('Erreur export:', error);
                      toast({ title: "Erreur", description: "Impossible d'exporter les donn√©es", variant: "destructive" });
                    } finally {
                      setExporting(false);
                    }
                  }}
                  disabled={exporting}
                >
                  {exporting ? '‚è≥ Export...' : 'üì• Exporter Excel'}
                </Button>
                <Button onClick={() => setCurrentView('nouveau-batiment')}>
                  ‚ûï Nouveau B√¢timent
                </Button>
              </div>
            </div>
            
            {(() => {
              // Filtrer les b√¢timents selon le r√¥le de l'utilisateur
              const isPreventionnisteOrAdmin = user?.est_preventionniste || user?.role === 'admin' || user?.role === 'superviseur';
              const filteredBatiments = isPreventionnisteOrAdmin 
                ? batiments 
                : batiments.filter(b => b.niveau_risque === 'Faible');
              
              if (loading) {
                return <div className="loading">Chargement des b√¢timents...</div>;
              }
              
              if (batiments.length === 0) {
                return (
                  <div className="empty-state">
                    <p>Aucun b√¢timent enregistr√©</p>
                    {isPreventionnisteOrAdmin && (
                      <Button onClick={() => setCurrentView('nouveau-batiment')}>
                        Ajouter le premier b√¢timent
                      </Button>
                    )}
                  </div>
                );
              }
              
              if (filteredBatiments.length === 0 && !isPreventionnisteOrAdmin) {
                return (
                  <div className="empty-state">
                    <p>Aucun b√¢timent √† risque faible √† inspecter</p>
                  </div>
                );
              }
              
              return viewMode === 'liste' ? (
                <div className="batiments-table" style={{background: '#fff', borderRadius: '8px', overflow: 'hidden', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
                  <table style={{width: '100%', borderCollapse: 'collapse'}}>
                    <thead>
                      <tr style={{background: '#f9fafb', borderBottom: '2px solid #e5e7eb'}}>
                        <th style={{padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem'}}>üì´ Adresse</th>
                        <th style={{padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem'}}>üè¢ Type</th>
                        <th style={{padding: '1rem', textAlign: 'left', fontWeight: '600', fontSize: '0.875rem'}}>üìÖ Derni√®re inspection</th>
                        <th style={{padding: '1rem', textAlign: 'center', fontWeight: '600', fontSize: '0.875rem'}}>‚ö° Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredBatiments.map(batiment => (
                      <tr key={batiment.id} style={{borderBottom: '1px solid #e5e7eb', transition: 'background 0.2s'}} onMouseEnter={(e) => e.currentTarget.style.background = '#f9fafb'} onMouseLeave={(e) => e.currentTarget.style.background = '#fff'}>
                        <td style={{padding: '1rem'}}>
                          <div>
                            <div style={{fontWeight: '600', marginBottom: '0.25rem'}}>{batiment.nom_etablissement || batiment.adresse_civique}</div>
                            <div style={{fontSize: '0.813rem', color: '#6b7280'}}>{batiment.ville}</div>
                          </div>
                        </td>
                        <td style={{padding: '1rem'}}>
                          <span style={{
                            padding: '0.25rem 0.75rem',
                            background: '#dbeafe',
                            color: '#1e40af',
                            borderRadius: '12px',
                            fontSize: '0.813rem',
                            fontWeight: '500'
                          }}>
                            {batiment.groupe_occupation}
                          </span>
                        </td>
                        <td style={{padding: '1rem', fontSize: '0.875rem', color: '#6b7280'}}>
                          {batiment.derniere_inspection ? new Date(batiment.derniere_inspection).toLocaleDateString('fr-FR') : 'Aucune'}
                        </td>
                        <td style={{padding: '1rem'}}>
                          <div style={{display: 'flex', gap: '0.5rem', justifyContent: 'center'}}>
                            <Button 
                              size="sm" 
                              variant="outline"
                              onClick={() => {
                                setSelectedBatiment(batiment);
                                setShowBatimentModal(true);
                              }}
                            >
                              üëÅÔ∏è Voir
                            </Button>
                            <Button 
                              size="sm"
                              onClick={() => {
                                setSelectedBatiment(batiment);
                                setCurrentView('nouvelle-inspection');
                              }}
                            >
                              üìã Inspecter
                            </Button>
                          </div>
                        </td>
                      </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="batiments-list">
                    <div className="batiments-grid">
                      {filteredBatiments.map(batiment => (
                      <div key={batiment.id} className="batiment-card">
                        <div className="batiment-header">
                          <h4>{batiment.nom_etablissement || batiment.adresse_civique}</h4>
                          <span className="groupe-badge">{batiment.groupe_occupation}</span>
                        </div>
                        <div className="batiment-info">
                          <p>{batiment.adresse_civique}</p>
                          <p>{batiment.ville}</p>
                        </div>
                        <div className="batiment-actions">
                          <Button 
                            size="sm" 
                            variant="outline"
                            onClick={() => {
                              setSelectedBatiment(batiment);
                              setShowBatimentModal(true);
                            }}
                          >
                            Voir
                          </Button>
                          <Button 
                            size="sm"
                            onClick={() => {
                              setSelectedBatiment(batiment);
                              setCurrentView('nouvelle-inspection');
                            }}
                          >
                            Inspecter
                          </Button>
                        </div>
                      </div>
                      ))}
                    </div>
                </div>
              );
            })()}
          </div>
        );
      
      case 'preventionnistes':
        return <GestionPreventionnistes />;
      
      case 'assigner-preventionniste':
        return (
          <div className="prevention-assigner">
            <div className="page-header">
              <h2>üë§ Assigner un Pr√©ventionniste</h2>
              <Button 
                variant="outline" 
                onClick={() => setCurrentView('preventionnistes')}
              >
                ‚Üê Retour
              </Button>
            </div>
            
            <AssignerPreventionniste onAssign={() => {
              setCurrentView('preventionnistes');
            }} />
          </div>
        );

      case 'grilles':
        return (
          <div className="prevention-grilles">
            <div className="page-header">
              <h2>üìã Grilles d'Inspection</h2>
              <Button onClick={() => setCurrentView('nouvelle-grille')}>
                ‚ûï Nouvelle Grille
              </Button>
            </div>
            
            <GrillesInspection />
          </div>
        );
      
      case 'nouvelle-grille':
        return (
          <div className="prevention-nouvelle-grille">
            <div className="page-header">
              <h2>üìù Cr√©er une Grille d'Inspection</h2>
              <Button 
                variant="outline" 
                onClick={() => setCurrentView('grilles')}
              >
                ‚Üê Retour aux grilles
              </Button>
            </div>
            
            <CreateGrilleInspection 
              onSave={() => setCurrentView('grilles')} 
              onViewTemplates={() => setCurrentView('grilles')}
            />
          </div>
        );

      case 'import':
        return (
          <div className="prevention-import">
            <div className="page-header">
              <h2>üè¢ Importer des b√¢timents</h2>
              <Button 
                variant="outline" 
                onClick={() => setCurrentView('dashboard')}
              >
                ‚Üê Retour
              </Button>
            </div>
            
            <ImportBatiments onImportComplete={() => {
              setCurrentView('batiments');
              fetchBatiments();
            }} />
          </div>
        );
      
      case 'inspections':
        return <ListeInspections setCurrentView={setCurrentView} />;
      
      case 'detail-inspection':
        return <DetailInspection inspectionId={localStorage.getItem('detail_inspection_id')} setCurrentView={setCurrentView} />;
      
      case 'nouvelle-inspection':
        return (
          <NouvelleInspection 
            setCurrentView={setCurrentView}
            batiments={batiments}
            selectedBatiment={selectedBatiment}
            onBatimentSelected={setSelectedBatiment}
          />
        );
      
      case 'realiser-inspection':
        return (
          <RealiserInspection 
            setCurrentView={setCurrentView}
          />
        );

      case 'inspection-terrain':
        // Nouveau composant d'inspection terrain (mobile-friendly)
        const inspectionData = JSON.parse(localStorage.getItem('inspection_terrain_data') || '{}');
        return (
          <InspectionTerrain
            tenantSlug={tenantSlug}
            grille={inspectionData.grille}
            batiment={inspectionData.batiment}
            onComplete={() => {
              localStorage.removeItem('inspection_terrain_data');
              setCurrentView('calendrier');
              toast({
                title: "Inspection termin√©e",
                description: "Les donn√©es ont √©t√© enregistr√©es"
              });
            }}
            onCancel={() => {
              localStorage.removeItem('inspection_terrain_data');
              setCurrentView('calendrier');
            }}
          />
        );
      
      case 'calendrier':
        return <PlanificationView 
          tenantSlug={tenantSlug}
          setCurrentView={setCurrentView}
          batiments={batiments}
          filteredBatimentId={filteredBatimentId}
          setFilteredBatimentId={setFilteredBatimentId}
          openBatimentModal={openBatimentModal}
          parametres={tenant?.config?.prevention_settings}
          user={user}
        />;
      
      case 'non-conformites':
        return <NonConformites tenantSlug={tenantSlug} toast={toast} openBatimentModal={openBatimentModal} />;
      
      case 'plans-intervention':
        console.log('üéØ Prevention - Rendu PlansIntervention avec tenantSlug:', tenantSlug);
        return <PlansIntervention tenantSlug={tenantSlug} filteredBatimentId={filteredBatimentId} setFilteredBatimentId={setFilteredBatimentId} />;
      
      case 'rapports':
        return <ModuleRapports setCurrentView={setCurrentView} />;
      
      case 'nouveau-batiment':
        // Ouvrir le modal de cr√©ation de b√¢timent et retourner la vue batiments
        if (!showBatimentModal) {
          setShowBatimentModal(true);
          setSelectedBatiment(null); // null pour cr√©er un nouveau
        }
        // Retourner la vue batiments (avec le modal ouvert)
        return (
          <div className="prevention-content">
            <div className="page-header">
              <div>
                <h2>üè¢ Gestion des b√¢timents</h2>
                <p>Cadastre des b√¢timents √† risque</p>
              </div>
            </div>
            <div className="batiments-grid">
              {batiments.map(batiment => (
                <div key={batiment.id} className="batiment-card" onClick={() => {
                  setSelectedBatiment(batiment);
                  setShowBatimentModal(true);
                }}>
                  <h3>{batiment.nom_etablissement || batiment.adresse_civique}</h3>
                  <p>{batiment.adresse_civique}, {batiment.ville}</p>
                </div>
              ))}
            </div>
          </div>
        );
      
      case 'parametres':
        return (
          <ParametresPrevention 
            tenantSlug={tenantSlug} 
            currentUser={user}
            onRefreshBatiments={fetchBatiments}
            ImportBatimentsComponent={ImportBatiments}
          />
        );
      
      default:
        return <div>Vue en d√©veloppement...</div>;
    }
  };

  return (
    <div className="prevention-container">
      <div className="prevention-header">
        <div className="header-content">
          <h1>üî• Module Pr√©vention</h1>
          <p>Gestion des inspections et de la s√©curit√© incendie</p>
        </div>
        
        <div className="prevention-nav">
          <Button 
            variant={currentView === 'dashboard' ? 'default' : 'outline'}
            onClick={() => setCurrentView('dashboard')}
          >
            üìä Tableau de bord
          </Button>
          <Button 
            variant={currentView === 'batiments' ? 'default' : 'outline'}
            onClick={() => setCurrentView('batiments')}
          >
            üè¢ B√¢timents
          </Button>
          <Button 
            variant={currentView === 'preventionnistes' ? 'default' : 'outline'}
            onClick={() => setCurrentView('preventionnistes')}
          >
            üë®‚Äçüöí Pr√©ventionnistes
          </Button>
          <Button 
            variant={currentView === 'calendrier' ? 'default' : 'outline'}
            onClick={() => setCurrentView('calendrier')}
          >
            üìÖ Planification
          </Button>
          <Button 
            variant={currentView === 'non-conformites' ? 'default' : 'outline'}
            onClick={() => setCurrentView('non-conformites')}
          >
            ‚ö†Ô∏è Non-conformit√©s
          </Button>
          <Button 
            variant={currentView === 'grilles' ? 'default' : 'outline'}
            onClick={() => setCurrentView('grilles')}
          >
            üìã Grilles d'Inspection
          </Button>
          <Button 
            variant={currentView === 'rapports' ? 'default' : 'outline'}
            onClick={() => setCurrentView('rapports')}
          >
            üìà Rapports
          </Button>
          <Button 
            variant={currentView === 'plans-intervention' ? 'default' : 'outline'}
            onClick={() => setCurrentView('plans-intervention')}
          >
            üó∫Ô∏è Plans d'Intervention
          </Button>
          <Button 
            variant={currentView === 'parametres' ? 'default' : 'outline'}
            onClick={() => setCurrentView('parametres')}
          >
            ‚öôÔ∏è Param√®tres
          </Button>
        </div>
      </div>
      
      <div className="prevention-content">
        {renderContent()}
      </div>

      {/* Modal d√©tails b√¢timent moderne */}
      {showBatimentModal && (
        <Suspense fallback={<div>Chargement...</div>}>
          <BatimentDetailModal
            batiment={selectedBatiment}
            onClose={() => {
              setShowBatimentModal(false);
              setSelectedBatiment(null);
              if (currentView === 'nouveau-batiment') {
                setCurrentView('batiments');
              }
            }}
            onCreate={async (newBatimentData) => {
              try {
                await apiPost(tenantSlug, `/prevention/batiments`, newBatimentData);
                await fetchBatiments();
                setShowBatimentModal(false);
                setSelectedBatiment(null);
                setCurrentView('batiments');
                toast({
                  title: "Succ√®s",
                  description: "B√¢timent cr√©√© avec succ√®s"
                });
              } catch (error) {
                toast({
                  title: "Erreur",
                  description: "Impossible de cr√©er le b√¢timent",
                  variant: "destructive"
                });
              }
            }}
            onUpdate={async (updatedData) => {
              try {
                await apiPut(tenantSlug, `/prevention/batiments/${selectedBatiment.id}`, updatedData);
                await fetchBatiments();
                setSelectedBatiment(updatedData);
                toast({
                  title: "Succ√®s",
                  description: "B√¢timent mis √† jour avec succ√®s"
                });
              } catch (error) {
                toast({
                  title: "Erreur",
                  description: "Impossible de mettre √† jour le b√¢timent",
                  variant: "destructive"
                });
              }
            }}
            onInspect={() => {
              setShowBatimentModal(false);
              handleInspectBatiment(selectedBatiment);
            }}
            onCreatePlan={async () => {
              try {
                // Chercher un plan d'intervention valid√© pour ce b√¢timent
                const plans = await apiGet(tenantSlug, `/prevention/plans-intervention?batiment_id=${selectedBatiment.id}`);
                
                // Filtrer les plans valid√©s
                const planValide = plans.find(p => p.statut === 'valide');
                
                if (planValide) {
                  // Ouvrir le plan valid√© en visualisation
                  setShowBatimentModal(false);
                  setSelectedPlanId(planValide.id);
                  
                  toast({
                    title: "Plan d'intervention trouv√©",
                    description: `Plan ${planValide.numero_plan || planValide.id} - Statut: Valid√©`
                  });
                } else {
                  // Aucun plan valid√© trouv√©
                  toast({
                    title: "Aucun plan d'intervention",
                    description: "Aucun plan valid√© pour ce b√¢timent",
                    variant: "destructive"
                  });
                }
              } catch (error) {
                console.error('Erreur r√©cup√©ration plan:', error);
                toast({
                  title: "Erreur",
                  description: "Impossible de r√©cup√©rer les plans d'intervention",
                  variant: "destructive"
                });
              }
            }}
            onViewHistory={() => {
              setShowBatimentModal(false);
              setFilteredBatimentId(selectedBatiment.id); // Filtrer par ce b√¢timent
              setCurrentView('calendrier'); // Vue calendrier dans planification
              
              toast({
                title: "Historique",
                description: `Affichage des inspections pour ${selectedBatiment.nom_etablissement || selectedBatiment.adresse_civique}`
              });
            }}
            onGenerateReport={async () => {
              try {
                toast({
                  title: "G√©n√©ration en cours",
                  description: "T√©l√©chargement du rapport PDF..."
                });
                
                const response = await fetch(
                  buildApiUrl(tenantSlug, `/prevention/batiments/${selectedBatiment.id}/rapport-pdf`),
                  {
                    headers: {
                      'Authorization': `Bearer ${getTenantToken()}`
                    }
                  }
                );
                
                if (!response.ok) throw new Error('Erreur g√©n√©ration rapport');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rapport_${selectedBatiment.nom_etablissement || 'batiment'}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                toast({
                  title: "Rapport g√©n√©r√©",
                  description: "Le PDF a √©t√© t√©l√©charg√© avec succ√®s",
                  variant: "success"
                });
              } catch (error) {
                console.error('Erreur g√©n√©ration rapport:', error);
                toast({
                  title: "Erreur",
                  description: "Impossible de g√©n√©rer le rapport",
                  variant: "destructive"
                });
              }
            }}
            onDelete={async () => {
              if (!window.confirm(`Supprimer le b√¢timent ${selectedBatiment.nom_etablissement || selectedBatiment.adresse_civique}?`)) {
                return;
              }
              try {
                await apiDelete(tenantSlug, `/prevention/batiments/${selectedBatiment.id}`);
                await fetchBatiments();
                setShowBatimentModal(false);
                setSelectedBatiment(null);
                toast({
                  title: "Succ√®s",
                  description: "B√¢timent supprim√©"
                });
              } catch (error) {
                toast({
                  title: "Erreur",
                  description: "Impossible de supprimer le b√¢timent",
                  variant: "destructive"
                });
              }
            }}
            canEdit={['admin', 'superviseur', 'preventionniste'].includes(user?.role)}
            tenantSlug={tenantSlug}
          />
        </Suspense>
      )}

      {/* Viewer pour plan d'intervention */}
      {selectedPlanId && (
        <Suspense fallback={<div>Chargement...</div>}>
          <PlanInterventionViewer
            planId={selectedPlanId}
            tenantSlug={tenantSlug}
            onClose={() => setSelectedPlanId(null)}
          />
        </Suspense>
      )}
    </div>
  );
};

// Main Application Layout
const AppLayout = () => {
  // Persister la page active dans localStorage pour conserver apr√®s refresh
  const [currentPage, setCurrentPage] = useState(() => {
    const savedPage = localStorage.getItem('currentPage');
    return savedPage || 'dashboard';
  });
  const [managingUserDisponibilites, setManagingUserDisponibilites] = useState(null);
  const [personnalisation, setPersonnalisation] = useState({
    logo_url: '',
    nom_service: '',
    afficher_profiremanager: true
  });
  const { user, tenant } = useAuth();
  const { tenantSlug } = useTenant();

  // Sauvegarder la page active dans localStorage √† chaque changement
  useEffect(() => {
    if (currentPage) {
      localStorage.setItem('currentPage', currentPage);
    }
  }, [currentPage]);

  // Charger la personnalisation
  useEffect(() => {
    const loadPersonnalisation = async () => {
      try {
        const response = await axios.get(`${API}/${tenantSlug}/personnalisation`, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem(getStorageKey('token', tenantSlug))}`
          }
        });
        setPersonnalisation(response.data);
      } catch (error) {
        console.error('Erreur chargement personnalisation:', error);
      }
    };

    if (tenantSlug && user) {
      loadPersonnalisation();
    }
  }, [tenantSlug, user]);

  // D√©tecter si l'utilisateur vient d'un QR code et rediriger vers le bon module
  useEffect(() => {
    const qrActionData = localStorage.getItem('qr_action');
    console.log('üîç AppLayout - V√©rification qr_action:', qrActionData);
    
    if (qrActionData) {
      try {
        const qrAction = JSON.parse(qrActionData);
        console.log('‚úÖ AppLayout - QR Action trouv√©e:', qrAction);
        
        if (qrAction.action === 'ronde_securite') {
          console.log('üöÄ AppLayout - Changement de page vers actifs');
          setCurrentPage('actifs');
        }
        // Ne pas supprimer ici, laisser GestionActifs le faire apr√®s avoir ouvert le modal
      } catch (err) {
        console.error('‚ùå AppLayout - Erreur parsing qr_action:', err);
        localStorage.removeItem('qr_action');
      }
    }
  }, [user]);

  // D√©tecter si l'utilisateur vient d'un lien email et rediriger vers la bonne page
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const pageParam = urlParams.get('page');
    const vehiculeIdParam = urlParams.get('vehicule_id');
    
    console.log('üîç AppLayout - V√©rification param√®tres URL:', { page: pageParam, vehicule_id: vehiculeIdParam });
    
    if (pageParam && user) {
      console.log('‚úÖ AppLayout - Navigation vers:', pageParam);
      setCurrentPage(pageParam);
      
      // Nettoyer l'URL pour √©viter les rechargements avec les param√®tres
      const newUrl = window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }
  }, [user]);

  // Enregistrer le Service Worker PWA et le manifest dynamique
  useEffect(() => {
    if ('serviceWorker' in navigator && tenantSlug) {
      // Enregistrer le Service Worker
      navigator.serviceWorker.register('/service-worker.js')
        .then((registration) => {
          console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
        })
        .catch((error) => {
          console.log('‚ùå Erreur Service Worker:', error);
        });

      // Mettre √† jour le manifest dynamique
      const manifestLink = document.querySelector('link[rel="manifest"]');
      if (manifestLink) {
        manifestLink.href = `${process.env.REACT_APP_BACKEND_URL}/api/${tenantSlug}/manifest.json`;
      } else {
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = `${process.env.REACT_APP_BACKEND_URL}/api/${tenantSlug}/manifest.json`;
        document.head.appendChild(link);
      }
    }
  }, [tenantSlug]);

  const renderCurrentPage = () => {
    switch (currentPage) {
      case 'dashboard':
        return <Dashboard />;
      case 'personnel':
        return <Personnel 
          setCurrentPage={setCurrentPage}
          setManagingUserDisponibilites={setManagingUserDisponibilites}
        />;
      case 'actifs':
        return (
          <Suspense fallback={<LoadingComponent />}>
            <GestionActifs user={user} ModuleEPI={ModuleEPI} />
          </Suspense>
        );
      case 'planning':
        return <Planning />;
      case 'remplacements':
        return <Remplacements />;
      case 'disponibilites':
        return <MesDisponibilites 
          user={user}
          managingUser={managingUserDisponibilites}
          setCurrentPage={setCurrentPage}
          setManagingUserDisponibilites={setManagingUserDisponibilites}
        />;
      case 'formations':
        return <Formations />;
      case 'prevention':
        return <Prevention />;
      case 'rapports':
        return <Rapports />;
      case 'parametres':
        return (
          <Suspense fallback={<LoadingComponent />}>
            <Parametres user={user} tenantSlug={tenantSlug} />
          </Suspense>
        );
      case 'maintenance':
        return (
          <div className="maintenance-page" style={{padding: '2rem'}}>
            <Card>
              <CardHeader>
                <CardTitle className="text-2xl">üîß Maintenance - Outils Syst√®me</CardTitle>
                <p className="text-sm text-gray-600 mt-2">
                  Outils r√©serv√©s aux super-administrateurs pour maintenir l'int√©grit√© des donn√©es
                </p>
              </CardHeader>
              <CardContent>
                <div className="maintenance-tools" style={{display: 'flex', flexDirection: 'column', gap: '1.5rem'}}>
                  
                  {/* Outil 1: Nettoyage des assignations invalides */}
                  <div className="tool-card" style={{
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    padding: '1.5rem',
                    backgroundColor: '#fef3c7'
                  }}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '600', marginBottom: '0.5rem'}}>
                      üóëÔ∏è Nettoyage des Assignations Invalides
                    </h3>
                    <p style={{color: '#6b7280', marginBottom: '1rem'}}>
                      Supprime automatiquement les assignations qui ne respectent pas les jours d'application de leur type de garde.
                    </p>
                    <ul style={{color: '#6b7280', marginBottom: '1rem', paddingLeft: '1.5rem'}}>
                      <li>Exemple: "Garde WE" assign√©e un mardi</li>
                      <li>Utile apr√®s importation de donn√©es ou bug syst√®me</li>
                      <li>Analyse d'abord, puis demande confirmation</li>
                    </ul>
                    <Button 
                      onClick={handleNettoyerAssignationsInvalides}
                      style={{background: '#F59E0B'}}
                    >
                      üóëÔ∏è Analyser et Nettoyer
                    </Button>
                  </div>
                  
                  {/* Espace pour futurs outils */}
                  <div className="tool-card" style={{
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    padding: '1.5rem',
                    backgroundColor: '#f3f4f6',
                    opacity: 0.6
                  }}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '600', marginBottom: '0.5rem'}}>
                      üìä Autres Outils (√Ä venir)
                    </h3>
                    <p style={{color: '#6b7280'}}>
                      D'autres outils de maintenance seront ajout√©s ici au besoin.
                    </p>
                  </div>
                  
                </div>
              </CardContent>
            </Card>
          </div>
        );
      case 'mesepi':
        return (
          <Suspense fallback={<LoadingComponent />}>
            <MesEPI user={user} />
          </Suspense>
        );
      case 'monprofil':
        return <MonProfil />;
      default:
        return <Dashboard />;
    }
  };

  return (
    <div className="app-layout">
      <Sidebar 
        currentPage={currentPage} 
        setCurrentPage={setCurrentPage} 
        tenant={tenant}
        personnalisation={personnalisation}
      />
      <main className="main-content">
        <div className="main-header" style={{
          padding: '1rem 2rem',
          backgroundColor: 'white',
          borderBottom: '1px solid #e5e7eb',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
            {personnalisation.logo_url && (
              <img 
                src={personnalisation.logo_url} 
                alt="Logo du service" 
                style={{ height: '50px', maxWidth: '200px', objectFit: 'contain' }}
              />
            )}
            <div>
              <h1 style={{ fontSize: '1.5rem', fontWeight: '600', margin: 0 }}>
                {personnalisation.nom_service || tenant?.nom || 'ProFireManager'}
              </h1>
            </div>
          </div>
        </div>
        {renderCurrentPage()}
      </main>
    </div>
  );
};

// Main App Component
const App = () => {
  const { user, tenant, loading, logout } = useAuth();
  const { isSuperAdmin, tenantSlug } = useTenant();

  if (loading) {
    return (
      <div className="loading-screen">
        <div className="loading-spinner">Chargement...</div>
      </div>
    );
  }

  // Si l'utilisateur est un Super-Admin, afficher le dashboard super-admin
  if (user && isSuperAdmin) {
    return (
      <div className="App">
        <Suspense fallback={<LoadingComponent />}>
          <SuperAdminDashboard onLogout={logout} />
        </Suspense>
        <Toaster />
      </div>
    );
  }

  // Sinon, afficher l'interface normale
  return (
    <div className="App">
      {user && <OfflineManager tenant={tenant} />}
      {/* PWAInstallPrompt d√©sactiv√© - app native disponible */}
      {user ? <AppLayout /> : <Login />}
      <Toaster />
    </div>
  );
};

// Root App with Providers
const AppWithProviders = () => {
  return (
    <BrowserRouter>
      <Routes>
        {/* Routes sp√©cifiques QR - DOIT √™tre avant les routes avec param√®tres */}
        <Route path="/qr/:tenantSlug/vehicule/:vehiculeId" element={
          <VehiculeQRAction />
        } />
        {/* Route sp√©ciale pour installation PWA sur iOS */}
        <Route path="/pwa/:tenantSlug" element={<PWARedirect />} />
        <Route path="/:tenant/reset-password" element={
          <AuthProvider>
            <ResetPassword />
            <Toaster />
          </AuthProvider>
        } />
        <Route path="*" element={
          <AuthProvider>
            <App />
          </AuthProvider>
        } />
      </Routes>
    </BrowserRouter>
  );
};

export default AppWithProviders;