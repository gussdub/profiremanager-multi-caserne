# üì± Guide de Publication de l'Application Mobile ProFireManager

Ce guide vous explique comment compiler, tester et publier ProFireManager en tant qu'application mobile native sur iOS et Android.

## üéØ Pr√©requis

### Pour iOS (App Store)
- **Mac** avec macOS 12+ (obligatoire pour compiler les apps iOS)
- **Xcode** 14+ install√© depuis l'App Store
- **Compte Apple Developer** ($99 USD/an)
  - Inscription sur https://developer.apple.com/programs/
- **Certificat de distribution iOS**
- **Provisioning Profile**

### Pour Android (Google Play)
- **Ordinateur** Windows, Mac ou Linux
- **Android Studio** install√©
- **Java JDK** 11 ou sup√©rieur
- **Compte Google Play Console** ($25 USD, paiement unique)
  - Inscription sur https://play.google.com/console/signup

## üì¶ Installation de Capacitor (D√©j√† fait)

Capacitor est d√©j√† configur√© dans le projet. Voici ce qui a √©t√© fait :

```json
// package.json contient d√©j√†:
"@capacitor/core": "^5.0.0",
"@capacitor/ios": "^5.0.0",
"@capacitor/android": "^5.0.0",
"@capacitor/push-notifications": "^5.0.0"
```

Configuration Firebase d√©j√† en place:
- ‚úÖ `android/app/google-services.json` (Android)
- ‚úÖ `ios/App/GoogleService-Info.plist` (iOS)
- ‚úÖ `capacitor.config.json` configur√©

## üöÄ √âtape 1: Build du Frontend

Avant de compiler l'app mobile, vous devez builder le frontend React:

```bash
cd /app/frontend
yarn build
```

Cela g√©n√®re les fichiers optimis√©s dans le dossier `build/`.

## üì± √âtape 2: Synchroniser avec Capacitor

Apr√®s chaque modification du code web, synchronisez avec Capacitor:

```bash
npx cap sync
```

Cette commande:
- Copie le build web vers iOS et Android
- Met √† jour les plugins natifs
- Synchronise les configurations

## üçé √âtape 3A: Publication iOS (App Store)

### 3A.1: Ouvrir le Projet Xcode

```bash
npx cap open ios
```

Cela ouvre Xcode avec le projet iOS.

### 3A.2: Configuration dans Xcode

1. **Bundle Identifier**: S√©lectionner le projet ‚Üí Signing & Capabilities
   - Changer le Bundle ID: `com.profiremanager.app` (ou votre propre domaine)
   
2. **Team & Signing**:
   - S√©lectionner votre √©quipe Apple Developer
   - Activer "Automatically manage signing"
   
3. **Version & Build Number**:
   - Version: `2.0.0` (ou votre version)
   - Build: `1` (incr√©menter √† chaque soumission)

4. **Permissions (Info.plist)**:
   V√©rifier que ces permissions sont pr√©sentes (d√©j√† configur√©es):
   ```xml
   <key>NSCameraUsageDescription</key>
   <string>Permet de prendre des photos pour les inspections EPI</string>
   
   <key>NSPhotoLibraryUsageDescription</key>
   <string>Permet d'acc√©der aux photos</string>
   
   <key>NSUserNotificationsUsageDescription</key>
   <string>Permet de recevoir des notifications de remplacements</string>
   ```

### 3A.3: Build & Archive

1. Dans Xcode: **Product ‚Üí Archive**
2. Une fois l'archive cr√©√©e, cliquer sur **Distribute App**
3. Choisir **App Store Connect**
4. Suivre les √©tapes de validation et soumission

### 3A.4: App Store Connect

1. Aller sur https://appstoreconnect.apple.com/
2. Cr√©er une nouvelle app:
   - Nom: **ProFireManager**
   - Bundle ID: celui configur√© dans Xcode
   - SKU: `profiremanager-2025`
3. Remplir les m√©tadonn√©es:
   - Description
   - Screenshots (obligatoire: 6.5" iPhone, 12.9" iPad)
   - Ic√¥ne de l'app (1024x1024px)
   - Cat√©gorie: Productivit√©
4. Apr√®s l'upload depuis Xcode, s√©lectionner le build
5. Soumettre pour r√©vision

**‚è±Ô∏è Temps de r√©vision Apple**: 24-48 heures en moyenne

## ü§ñ √âtape 3B: Publication Android (Google Play)

### 3B.1: Ouvrir le Projet Android Studio

```bash
npx cap open android
```

### 3B.2: Configuration Gradle

√âditer `android/app/build.gradle`:

```gradle
android {
    namespace "com.profiremanager.app"
    compileSdk 33
    
    defaultConfig {
        applicationId "com.profiremanager.app"
        minSdk 22
        targetSdk 33
        versionCode 1
        versionName "2.0.0"
    }
    
    signingConfigs {
        release {
            // Configuration de signature (voir √©tape suivante)
        }
    }
}
```

### 3B.3: G√©n√©rer une Cl√© de Signature

```bash
keytool -genkey -v -keystore profiremanager-release.keystore \
  -alias profiremanager -keyalg RSA -keysize 2048 -validity 10000
```

**‚ö†Ô∏è IMPORTANT**: Sauvegarder cette cl√© et le mot de passe de mani√®re s√©curis√©e!

Cr√©er `android/key.properties`:

```properties
storePassword=VOTRE_MOT_DE_PASSE
keyPassword=VOTRE_MOT_DE_PASSE
keyAlias=profiremanager
storeFile=../profiremanager-release.keystore
```

Ajouter √† `android/app/build.gradle`:

```gradle
def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file('key.properties')
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    ...
    signingConfigs {
        release {
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
            storeFile file(keystoreProperties['storeFile'])
            storePassword keystoreProperties['storePassword']
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
```

### 3B.4: Build de Production (AAB)

```bash
cd android
./gradlew bundleRelease
```

Le fichier AAB sera g√©n√©r√© dans:
`android/app/build/outputs/bundle/release/app-release.aab`

### 3B.5: Google Play Console

1. Aller sur https://play.google.com/console/
2. Cr√©er une nouvelle application
3. Remplir les informations:
   - Nom: **ProFireManager**
   - Description courte et compl√®te
   - Screenshots (obligatoire: t√©l√©phone, tablette 7" et 10")
   - Ic√¥ne (512x512px)
   - Feature Graphic (1024x500px)
   - Cat√©gorie: Productivit√©
   - Classification du contenu

4. **Production ‚Üí Cr√©er une nouvelle version**:
   - Uploader l'AAB
   - Notes de version
   - Soumettre pour r√©vision

**‚è±Ô∏è Temps de r√©vision Google**: Quelques heures √† quelques jours

## üîî Configuration Firebase Cloud Messaging

Les fichiers sont d√©j√† en place, mais voici comment les obtenir si besoin:

### Pour Android (`google-services.json`)

1. Aller sur https://console.firebase.google.com/
2. S√©lectionner votre projet
3. Ajouter une app Android
   - Package name: `com.profiremanager.app`
4. T√©l√©charger `google-services.json`
5. Placer dans `android/app/`

### Pour iOS (`GoogleService-Info.plist`)

1. Dans la Firebase Console
2. Ajouter une app iOS
   - Bundle ID: `com.profiremanager.app`
3. T√©l√©charger `GoogleService-Info.plist`
4. Placer dans `ios/App/App/`

### Cl√© Serveur FCM (Backend)

1. Firebase Console ‚Üí Param√®tres du projet ‚Üí Cloud Messaging
2. Onglet "Cloud Messaging API (Legacy)" ‚Üí Server Key
3. Copier la cl√© et l'ajouter dans `/app/backend/.env`:
   ```
   FCM_SERVER_KEY=VOTRE_CLE_SERVEUR_FCM
   ```

## üß™ Test Local (Avant Publication)

### Test iOS (Simulateur)

```bash
npx cap run ios
```

### Test Android (√âmulateur ou Appareil)

```bash
npx cap run android
```

### Test des Notifications Push

1. Connectez-vous sur un appareil physique
2. Cr√©ez une demande de remplacement
3. V√©rifiez que la notification arrive sur les appareils des superviseurs

**‚ö†Ô∏è Note**: Les notifications push ne fonctionnent PAS sur les simulateurs/√©mulateurs, uniquement sur appareils physiques.

## üìù Checklist Avant Publication

### ‚úÖ iOS
- [ ] Bundle ID configur√©
- [ ] Certificats et profiles de distribution configur√©s
- [ ] Version et build number √† jour
- [ ] Screenshots pris (iPhone 6.5", iPad 12.9")
- [ ] Ic√¥ne 1024x1024px cr√©√©e
- [ ] GoogleService-Info.plist pr√©sent
- [ ] App test√©e sur appareil physique
- [ ] Permissions d√©clar√©es dans Info.plist
- [ ] App Store Connect: m√©tadonn√©es remplies

### ‚úÖ Android
- [ ] applicationId configur√©
- [ ] Cl√© de signature g√©n√©r√©e et sauvegard√©e
- [ ] versionCode et versionName √† jour
- [ ] Screenshots pris (t√©l√©phone, tablette 7", 10")
- [ ] Ic√¥ne 512x512px cr√©√©e
- [ ] Feature Graphic 1024x500px cr√©√©e
- [ ] google-services.json pr√©sent
- [ ] App test√©e sur appareil physique
- [ ] Permissions d√©clar√©es dans AndroidManifest.xml
- [ ] Google Play Console: m√©tadonn√©es remplies

## üîÑ Mises √† Jour Futures

Pour publier une mise √† jour:

1. **Modifier le code web** (React)
2. **Build**: `yarn build`
3. **Sync**: `npx cap sync`
4. **Incr√©menter la version**:
   - iOS: Build number dans Xcode
   - Android: `versionCode` dans `build.gradle`
5. **Rebuild et soumettre** selon les √©tapes ci-dessus

## üÜò R√©solution de Probl√®mes

### "Build failed" sur iOS
- V√©rifier que Xcode est √† jour
- Nettoyer le build: Product ‚Üí Clean Build Folder
- V√©rifier les certificats dans Signing & Capabilities

### "Build failed" sur Android
- V√©rifier Java JDK version: `java -version`
- Nettoyer: `cd android && ./gradlew clean`
- V√©rifier que `google-services.json` est pr√©sent

### Notifications ne fonctionnent pas
- V√©rifier Firebase credentials backend
- V√©rifier device tokens dans la DB: `db.device_tokens.find()`
- Tester uniquement sur appareil physique
- V√©rifier les permissions dans l'app

## üìö Ressources Utiles

- **Capacitor Docs**: https://capacitorjs.com/docs
- **Firebase Push Notifications**: https://firebase.google.com/docs/cloud-messaging
- **Apple Developer**: https://developer.apple.com/
- **Google Play Console**: https://play.google.com/console/
- **App Store Connect**: https://appstoreconnect.apple.com/

## ‚úÖ Status Actuel de l'Impl√©mentation

**‚úÖ Compl√©t√©:**
- Configuration Capacitor
- Fichiers Firebase (google-services.json, GoogleService-Info.plist)
- Service de notifications push frontend (`pushNotifications.js`)
- Endpoints backend pour device tokens
- Initialisation auto des notifications au login
- Notifications push pour "Demande de remplacement"

**üì± Pr√™t pour:**
- Compilation iOS
- Compilation Android
- Tests sur appareils physiques
- Publication sur les stores

---

**üéâ L'application est maintenant pr√™te pour la publication mobile!**

Pour toute question ou assistance, consultez la documentation Capacitor ou contactez le support technique.
