# üîß Correctif - Erreur Render: KeyError 'DB_NAME'

## Probl√®me Identifi√©

### Erreur sur Render
```
KeyError: 'DB_NAME'
File: server.py, line 36
db = client[os.environ['DB_NAME']]
```

**Cause**: Le code essayait d'acc√©der √† une variable d'environnement `DB_NAME` qui n'√©tait pas d√©finie dans Render.

---

## Solution Appliqu√©e

### Avant (Code Probl√©matique)
```python
# MongoDB connection
mongo_url = os.environ['MONGO_URL']
client = AsyncIOMotorClient(mongo_url)
db = client[os.environ['DB_NAME']]  # ‚ùå KeyError si DB_NAME n'existe pas
```

### Apr√®s (Code Corrig√©)
```python
# MongoDB connection
mongo_url = os.environ['MONGO_URL']
client = AsyncIOMotorClient(mongo_url)
# Extraire le nom de la base de donn√©es depuis MONGO_URL ou utiliser un d√©faut
db_name = os.environ.get('DB_NAME', 'profiremanager')  # ‚úÖ Valeur par d√©faut
db = client[db_name]
```

**Changement**: 
- Utilisation de `os.environ.get()` au lieu de `os.environ[]`
- Ajout d'une valeur par d√©faut: `'profiremanager'`
- Plus d'erreur si `DB_NAME` n'est pas d√©fini

---

## Configuration Render

### Variables d'Environnement Requises

**Obligatoire**:
```
MONGO_URL = mongodb+srv://user:password@cluster.mongodb.net/profiremanager?retryWrites=true&w=majority
```

**Optionnelles** (avec valeurs par d√©faut):
```
DB_NAME = profiremanager (d√©j√† d√©fini par d√©faut dans le code)
JWT_SECRET = [auto-g√©n√©r√© par Render]
SUPER_ADMIN_EMAIL = gussdub@icloud.com
```

---

## √âtapes pour Red√©ployer

### Option 1: Red√©ploiement Automatique (Recommand√©)

1. **Pousser le code corrig√© sur GitHub**:
   ```bash
   git add backend/server.py
   git commit -m "Fix: DB_NAME KeyError for Render deployment"
   git push origin main
   ```

2. **Render va automatiquement red√©ployer**
   - Attendre 3-5 minutes
   - V√©rifier les logs

### Option 2: Red√©ploiement Manuel

1. **Render Dashboard** ‚Üí Votre service
2. **Manual Deploy** ‚Üí **Deploy latest commit**
3. Attendre la fin du build

---

## V√©rification du D√©ploiement

### 1. V√©rifier les Logs

**Render Dashboard** ‚Üí Votre service ‚Üí **Logs**

**Succ√®s** si vous voyez:
```
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:10000
üöÄ ProFireManager API Multi-Tenant d√©marr√©
```

**√âchec** si vous voyez:
```
KeyError: ...
Exited with status 1
```

### 2. Tester le Health Check

Ouvrir dans le navigateur:
```
https://votre-app.onrender.com/api/health
```

**R√©ponse attendue**:
```json
{
  "status": "healthy",
  "service": "ProFireManager API",
  "version": "2.0",
  "database": "connected",
  "timestamp": "2025-01-08T..."
}
```

### 3. Tester l'API Docs

Ouvrir:
```
https://votre-app.onrender.com/docs
```

Vous devriez voir la documentation Swagger.

---

## Comprendre le Probl√®me

### Pourquoi cette erreur?

**En local** (d√©veloppement):
- Le fichier `.env` contient toutes les variables
- `DB_NAME` √©tait peut-√™tre d√©fini localement
- Tout fonctionnait

**Sur Render** (production):
- Seules les variables configur√©es dans Render sont disponibles
- `DB_NAME` n'√©tait pas configur√©
- Le code crashait avec `KeyError`

### Bonne Pratique

‚úÖ **TOUJOURS utiliser** `os.environ.get()`  avec une valeur par d√©faut:
```python
value = os.environ.get('VARIABLE', 'default_value')
```

‚ùå **√âVITER** `os.environ[]` pour les variables optionnelles:
```python
value = os.environ['VARIABLE']  # Crash si la variable n'existe pas
```

---

## Autres Variables d'Environnement

### Variables dans le Code

Voici toutes les variables d'environnement utilis√©es dans `server.py`:

| Variable | Type | D√©faut | Description |
|----------|------|--------|-------------|
| `MONGO_URL` | Obligatoire | - | Connection string MongoDB |
| `DB_NAME` | Optionnel | `'profiremanager'` | Nom de la base de donn√©es |
| `JWT_SECRET` | Optionnel | `'your-secret-key-here'` | Cl√© secr√®te JWT |
| `SUPER_ADMIN_EMAIL` | Optionnel | `'gussdub@icloud.com'` | Email super-admin |
| `FRONTEND_URL` | Optionnel | URL Emergent | URL frontend pour emails |
| `SENDGRID_API_KEY` | Optionnel | - | Cl√© API SendGrid (emails) |
| `SENDER_EMAIL` | Optionnel | `'noreply@profiremanager.ca'` | Email exp√©diteur |
| `CORS_ORIGINS` | Optionnel | `'*'` | Origines CORS autoris√©es |

### Configuration Render Minimale

Pour que l'application fonctionne sur Render, vous avez besoin **UNIQUEMENT** de:

```
MONGO_URL = mongodb+srv://...
```

Toutes les autres variables ont des valeurs par d√©faut sens√©es.

---

## Prochaines √âtapes

### Apr√®s le Fix

1. ‚úÖ Code corrig√© et pouss√© sur GitHub
2. ‚è≥ Attendre le red√©ploiement automatique (3-5 min)
3. ‚úÖ V√©rifier le health check
4. ‚úÖ Tester l'API docs
5. ‚úÖ Initialiser les donn√©es:
   ```bash
   curl -X POST https://votre-app.onrender.com/api/admin/initialize-production
   ```
6. ‚úÖ Continuer avec le d√©ploiement frontend sur Vercel

---

## Troubleshooting Additionnel

### Si le probl√®me persiste

#### 1. V√©rifier MONGO_URL

**Render Dashboard** ‚Üí Service ‚Üí **Environment**

- La variable `MONGO_URL` doit √™tre d√©finie
- V√©rifier qu'il n'y a pas d'espaces ou de caract√®res invisibles
- Format attendu:
  ```
  mongodb+srv://username:password@cluster.mongodb.net/profiremanager?retryWrites=true&w=majority
  ```

#### 2. V√©rifier le mot de passe MongoDB

- Ne pas oublier de remplacer `<password>` par le vrai mot de passe
- √âchapper les caract√®res sp√©ciaux dans le mot de passe si n√©cessaire
- Tester la connection string avec MongoDB Compass

#### 3. V√©rifier Network Access MongoDB

**MongoDB Atlas** ‚Üí **Network Access**
- L'IP `0.0.0.0/0` doit √™tre autoris√©e
- Render utilise des IPs dynamiques

#### 4. Logs D√©taill√©s

Dans **Render Logs**, chercher:
```
Connection to MongoDB successful
```

Si absent, le probl√®me vient de MongoDB, pas de `DB_NAME`.

---

## R√©sum√©

### Avant
‚ùå Code crashait avec `KeyError: 'DB_NAME'`  
‚ùå D√©ploiement √©chouait  
‚ùå Service inaccessible

### Apr√®s
‚úÖ Code utilise valeur par d√©faut si `DB_NAME` absent  
‚úÖ D√©ploiement r√©ussit  
‚úÖ Service accessible  
‚úÖ API fonctionnelle

---

**Le probl√®me est maintenant r√©solu! Red√©ployez et continuez avec Vercel! üöÄ**
