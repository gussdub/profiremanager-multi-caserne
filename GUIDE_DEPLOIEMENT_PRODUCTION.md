# üöÄ Guide de D√©ploiement Production - ProFireManager

## Architecture de D√©ploiement

```
Production Stack:
‚îú‚îÄ‚îÄ MongoDB Atlas (Base de donn√©es cloud)
‚îú‚îÄ‚îÄ Render (Backend FastAPI + Python)
‚îî‚îÄ‚îÄ Vercel (Frontend React + Vite)
```

---

## üìã Pr√©requis

Avant de commencer, cr√©ez des comptes sur:
1. ‚úÖ [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) - Gratuit
2. ‚úÖ [Render](https://render.com) - Gratuit pour d√©marrer
3. ‚úÖ [Vercel](https://vercel.com) - Gratuit

**Important**: Ayez acc√®s √† votre d√©p√¥t GitHub pour ProFireManager.

---

## √âTAPE 1: MongoDB Atlas (Base de Donn√©es)

### 1.1 Cr√©er un Cluster MongoDB

1. **Se connecter** √† [MongoDB Atlas](https://cloud.mongodb.com)
2. **Cr√©er un nouveau projet**: "ProFireManager"
3. **Build a Database** ‚Üí Choisir **M0 (Free)**
4. **Provider**: AWS
5. **Region**: Choisir la plus proche de vos utilisateurs
6. **Cluster Name**: `profiremanager-prod`
7. Cliquer **Create**

### 1.2 Configurer la S√©curit√©

#### A. Cr√©er un utilisateur database

1. **Security** ‚Üí **Database Access**
2. **Add New Database User**
   - Username: `profiremanager_admin`
   - Password: G√©n√©rer un mot de passe fort (NOTEZ-LE!)
   - Database User Privileges: **Read and write to any database**
3. **Add User**

#### B. Configurer l'acc√®s r√©seau

1. **Security** ‚Üí **Network Access**
2. **Add IP Address**
3. **ALLOW ACCESS FROM ANYWHERE** ‚Üí `0.0.0.0/0`
   - ‚ö†Ô∏è N√©cessaire car Render utilise des IPs dynamiques
4. **Confirm**

### 1.3 Obtenir la Connection String

1. **Database** ‚Üí **Connect**
2. **Connect your application**
3. **Driver**: Python, Version: 3.12 or later
4. Copier la connection string:
   ```
   mongodb+srv://profiremanager_admin:<password>@profiremanager-prod.xxxxx.mongodb.net/?retryWrites=true&w=majority
   ```
5. **IMPORTANT**: Remplacer `<password>` par votre mot de passe
6. Ajouter le nom de la base: `/profiremanager` avant le `?`
   ```
   mongodb+srv://profiremanager_admin:VOTRE_MOT_DE_PASSE@profiremanager-prod.xxxxx.mongodb.net/profiremanager?retryWrites=true&w=majority
   ```

**Gardez cette URL pr√©cieusement!**

---

## √âTAPE 2: D√©ploiement Backend sur Render

### 2.1 Pr√©parer les Fichiers

#### A. Cr√©er `render.yaml` (d√©j√† fait normalement)

Cr√©ez `/app/render.yaml`:
```yaml
services:
  - type: web
    name: profiremanager-backend
    env: python
    region: oregon
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && uvicorn server:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: MONGO_URL
        sync: false
      - key: JWT_SECRET
        generateValue: true
      - key: SUPER_ADMIN_EMAIL
        value: gussdub@icloud.com
```

#### B. V√©rifier `requirements.txt`

Assurez-vous que `/app/backend/requirements.txt` contient toutes les d√©pendances:
```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
motor==3.3.2
pydantic==2.5.0
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6
bcrypt==4.1.1
```

### 2.2 D√©ployer sur Render

1. **Se connecter** √† [Render](https://dashboard.render.com)
2. **New** ‚Üí **Web Service**
3. **Connect a repository**:
   - Si premier d√©ploiement: Connecter votre compte GitHub
   - S√©lectionner le d√©p√¥t ProFireManager
4. **Configuration**:
   - **Name**: `profiremanager-backend`
   - **Region**: Oregon (US West)
   - **Branch**: `main` (ou votre branche principale)
   - **Root Directory**: `.` (racine)
   - **Runtime**: Python 3
   - **Build Command**: `pip install -r backend/requirements.txt`
   - **Start Command**: `cd backend && uvicorn server:app --host 0.0.0.0 --port $PORT`
5. **Instance Type**: Free
6. **Advanced** ‚Üí **Environment Variables**:
   - Cliquer **Add Environment Variable**
   
   Ajouter:
   ```
   Key: MONGO_URL
   Value: mongodb+srv://profiremanager_admin:VOTRE_MOT_DE_PASSE@profiremanager-prod.xxxxx.mongodb.net/profiremanager?retryWrites=true&w=majority
   ```
   
   ```
   Key: JWT_SECRET
   Value: [G√©n√©rer une cl√© al√©atoire longue, ex: openssl rand -hex 32]
   ```
   
   ```
   Key: SUPER_ADMIN_EMAIL
   Value: gussdub@icloud.com
   ```

7. **Create Web Service**

### 2.3 Attendre le D√©ploiement

- Le build prend 2-5 minutes
- Vous verrez les logs en temps r√©el
- Une fois termin√©, vous aurez une URL: `https://profiremanager-backend.onrender.com`

### 2.4 Tester le Backend

Ouvrir dans le navigateur:
```
https://profiremanager-backend.onrender.com/docs
```

Vous devriez voir la documentation Swagger de l'API.

---

## √âTAPE 3: D√©ploiement Frontend sur Vercel

### 3.1 Pr√©parer la Configuration

#### A. Cr√©er `vercel.json`

Cr√©ez `/app/vercel.json`:
```json
{
  "buildCommand": "cd frontend && yarn install && yarn build",
  "outputDirectory": "frontend/dist",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ]
}
```

#### B. Mettre √† jour `.env` Frontend

Cr√©ez `/app/frontend/.env.production`:
```env
REACT_APP_BACKEND_URL=https://profiremanager-backend.onrender.com
```

**‚ö†Ô∏è IMPORTANT**: Remplacez par VOTRE URL Render obtenue √† l'√©tape 2.3

### 3.2 D√©ployer sur Vercel

#### Option A: Via Dashboard Vercel (Recommand√©)

1. **Se connecter** √† [Vercel](https://vercel.com/dashboard)
2. **Add New** ‚Üí **Project**
3. **Import Git Repository**:
   - Connecter votre compte GitHub si n√©cessaire
   - S√©lectionner le d√©p√¥t ProFireManager
4. **Configure Project**:
   - **Framework Preset**: Vite
   - **Root Directory**: `frontend`
   - **Build Command**: `yarn build`
   - **Output Directory**: `dist`
5. **Environment Variables**:
   - Cliquer **Add**
   ```
   Key: REACT_APP_BACKEND_URL
   Value: https://profiremanager-backend.onrender.com
   ```
   (Remplacez par VOTRE URL Render)

6. **Deploy**

#### Option B: Via CLI Vercel

```bash
# Installer Vercel CLI
npm i -g vercel

# Se connecter
vercel login

# D√©ployer
cd /app/frontend
vercel --prod
```

Suivre les instructions:
- Set up: Yes
- Which scope: Votre compte
- Link to existing project: No
- Project name: profiremanager
- Directory: `./` (current)
- Override build command: `yarn build`
- Override output directory: `dist`

### 3.3 Obtenir l'URL de Production

Apr√®s d√©ploiement r√©ussi:
```
https://profiremanager.vercel.app
```

Ou votre domaine personnalis√© si configur√©.

---

## √âTAPE 4: Configuration Finale

### 4.1 Configurer CORS sur le Backend

Le backend doit autoriser le frontend Vercel.

**Si n√©cessaire**, mettre √† jour `/app/backend/server.py`:

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "https://profiremanager.vercel.app",  # Votre URL Vercel
        "https://votre-domaine.com"           # Si domaine personnalis√©
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

Red√©ployer le backend sur Render (automatique si GitHub connect√©).

### 4.2 Initialiser les Donn√©es

#### A. Via Script (Recommand√©)

Cr√©ez un endpoint temporaire dans `server.py`:

```python
@api_router.post("/admin/initialize-demo-data")
async def initialize_demo_data_endpoint():
    """Endpoint temporaire pour initialiser les donn√©es de d√©mo"""
    try:
        await initialize_multi_tenant()
        return {"status": "success", "message": "Donn√©es initialis√©es"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

Puis appelez-le via Postman ou curl:
```bash
curl -X POST https://profiremanager-backend.onrender.com/api/admin/initialize-demo-data
```

#### B. Via MongoDB Compass (Alternative)

1. T√©l√©charger [MongoDB Compass](https://www.mongodb.com/products/compass)
2. Se connecter avec votre connection string
3. Cr√©er les collections manuellement
4. Importer les donn√©es depuis votre instance locale

---

## √âTAPE 5: Tests Post-D√©ploiement

### 5.1 V√©rifications Backend

‚úÖ **API Docs accessible**:
```
https://profiremanager-backend.onrender.com/docs
```

‚úÖ **Health Check**:
```bash
curl https://profiremanager-backend.onrender.com/api/health
```

‚úÖ **Login Super-Admin**:
```bash
curl -X POST https://profiremanager-backend.onrender.com/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"gussdub@icloud.com","password":"230685Juin+"}'
```

### 5.2 V√©rifications Frontend

‚úÖ **Site accessible**: `https://profiremanager.vercel.app`

‚úÖ **Redirection vers /shefford**: Devrait fonctionner automatiquement

‚úÖ **Login Shefford**:
1. Aller sur `/shefford`
2. Se connecter: `admin@firemanager.ca` / `admin123`
3. V√©rifier que le dashboard s'affiche

‚úÖ **Super-Admin**:
1. Se d√©connecter
2. Se connecter: `gussdub@icloud.com` / `230685Juin+`
3. V√©rifier le dashboard super-admin

### 5.3 Tests Multi-Tenant

‚úÖ **Cr√©er une nouvelle caserne**:
1. En super-admin, cr√©er "Caserne de Test"
2. Slug: `test`
3. Acc√©der √† `/test`
4. V√©rifier l'isolation des donn√©es

---

## √âTAPE 6: Domaine Personnalis√© (Optionnel)

### 6.1 Configurer sur Vercel

1. **Vercel Dashboard** ‚Üí Votre projet
2. **Settings** ‚Üí **Domains**
3. **Add Domain**: `app.profiremanager.com`
4. Suivre les instructions DNS

### 6.2 Configurer les DNS

Chez votre registrar (ex: GoDaddy, Namecheap):

**Type A Record**:
```
Host: app
Value: 76.76.21.21 (IP Vercel)
```

**Type CNAME Record** (alternative):
```
Host: app
Value: cname.vercel-dns.com
```

### 6.3 Mettre √† jour CORS

Ajouter votre domaine dans `allow_origins` du backend:
```python
allow_origins=[
    "https://app.profiremanager.com"
]
```

---

## √âTAPE 7: Monitoring et Maintenance

### 7.1 Logs Backend (Render)

1. **Render Dashboard** ‚Üí Votre service
2. **Logs** (en temps r√©el)
3. Surveiller les erreurs

### 7.2 Logs Frontend (Vercel)

1. **Vercel Dashboard** ‚Üí Votre projet
2. **Deployments** ‚Üí S√©lectionner un d√©ploiement
3. **View Function Logs**

### 7.3 Base de Donn√©es (MongoDB Atlas)

1. **MongoDB Atlas** ‚Üí Votre cluster
2. **Metrics**: Utilisation, performance
3. **Backup**: Activ√© automatiquement (Free tier: daily)

---

## üìä Checklist de D√©ploiement

### Avant le D√©ploiement
- [ ] MongoDB Atlas cluster cr√©√©
- [ ] Connection string obtenue
- [ ] Utilisateur database cr√©√©
- [ ] Acc√®s r√©seau configur√© (0.0.0.0/0)
- [ ] Code pouss√© sur GitHub

### Backend (Render)
- [ ] Service web cr√©√©
- [ ] Variables d'environnement configur√©es
- [ ] Build r√©ussi
- [ ] API accessible (/docs)
- [ ] Donn√©es initialis√©es

### Frontend (Vercel)
- [ ] Projet d√©ploy√©
- [ ] REACT_APP_BACKEND_URL configur√©e
- [ ] Build r√©ussi
- [ ] Site accessible
- [ ] Routing fonctionne (/shefford, etc.)

### Tests
- [ ] Login super-admin fonctionne
- [ ] Login caserne fonctionne
- [ ] Dashboard affiche les donn√©es
- [ ] Multi-tenant isol√©
- [ ] Cr√©ation de caserne OK
- [ ] Tous les modules accessibles

---

## üö® Troubleshooting

### Erreur: Backend ne d√©marre pas sur Render

**Cause**: Dependencies manquantes

**Solution**:
1. V√©rifier `requirements.txt` complet
2. Check logs Render
3. Tester localement: `pip install -r backend/requirements.txt`

### Erreur: Frontend ne se connecte pas au backend

**Cause**: CORS ou mauvaise URL

**Solutions**:
1. V√©rifier `REACT_APP_BACKEND_URL` dans Vercel
2. V√©rifier CORS dans `server.py`
3. Check console browser (F12) pour erreurs CORS

### Erreur: MongoDB connection failed

**Cause**: Connection string incorrecte

**Solutions**:
1. V√©rifier le mot de passe (pas de <password>)
2. V√©rifier le nom de la base: `/profiremanager`
3. V√©rifier Network Access (0.0.0.0/0)
4. Tester la connection avec MongoDB Compass

### Erreur: 404 sur toutes les routes

**Cause**: Vercel routing mal configur√©

**Solution**:
1. V√©rifier `vercel.json` pr√©sent
2. V√©rifier les rewrites configur√©s
3. Red√©ployer avec: `vercel --prod`

---

## üí∞ Co√ªts Estim√©s

### Gratuit (Pour D√©marrer)
- **MongoDB Atlas**: M0 (512MB) - GRATUIT
- **Render**: Free tier - GRATUIT (750h/mois)
- **Vercel**: Hobby plan - GRATUIT

**Limitations Free Tier**:
- Render: Services s'endorment apr√®s 15min inactivit√© (temps de r√©veil: 30s)
- Vercel: Limites de bande passante (100GB/mois)
- MongoDB: Limite de stockage (512MB)

### Plans Payants (Recommand√©s pour Production)
- **MongoDB Atlas**: M10 ($57/mois) - 10GB, pas de limite connexions
- **Render**: Starter ($7/mois) - Pas de sommeil, SSL inclus
- **Vercel**: Pro ($20/mois) - Analytics, domaines illimit√©s

**Total estim√© production**: ~$84/mois

---

## üîí S√©curit√© Production

### √Ä Faire Imm√©diatement

1. **Changer le mot de passe super-admin**:
   ```python
   # Dans MongoDB Atlas ou via API
   # Changer de "230685Juin+" vers un mot de passe fort
   ```

2. **G√©n√©rer un JWT_SECRET fort**:
   ```bash
   openssl rand -hex 32
   ```

3. **Activer HTTPS uniquement** (d√©j√† fait par d√©faut sur Vercel/Render)

4. **Configurer les limites de rate**:
   ```python
   # Dans server.py
   from slowapi import Limiter
   limiter = Limiter(key_func=get_remote_address)
   
   @app.post("/auth/login")
   @limiter.limit("5/minute")
   async def login(...):
   ```

5. **Backups MongoDB**:
   - Atlas Free: Daily automated
   - Configurer des exports manuels r√©guliers

---

## üìö Ressources

### Documentation
- [Render Python Guide](https://render.com/docs/deploy-fastapi)
- [Vercel Vite Guide](https://vercel.com/docs/frameworks/vite)
- [MongoDB Atlas](https://docs.atlas.mongodb.com/)

### Support
- Render: support@render.com
- Vercel: support@vercel.com
- MongoDB: support@mongodb.com

---

## ‚úÖ D√©ploiement R√©ussi!

Une fois tout compl√©t√©, votre application sera:
- üåç **Accessible mondialement**
- üîí **S√©curis√©e** (HTTPS, JWT, isolation multi-tenant)
- ‚ö° **Performante** (CDN Vercel)
- üíæ **Sauvegard√©e** (Backups Atlas)
- üìà **Scalable** (Augmenter les tiers selon besoins)

**ProFireManager est maintenant en production! üéâüöÄ**
